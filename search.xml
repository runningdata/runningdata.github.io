<?xml version="1.0" encoding="utf-8"?>
<search> 
  
    
    <entry>
      <title><![CDATA[django针对model进行decorator实现AOP]]></title>
      <url>/2018/01/19/django%E9%92%88%E5%AF%B9model%E8%BF%9B%E8%A1%8Cdecorator%E5%AE%9E%E7%8E%B0AOP/</url>
      <content type="html"><![CDATA[<h4 id="1-期望"><a href="#1-期望" class="headerlink" title="1. 期望"></a>1. 期望</h4><p>通过decorator实现对django中所有Model操作的AOP，可以用来记录所以model操作的log，也可用来进行调用追踪。</p>
<h4 id="2-思路"><a href="#2-思路" class="headerlink" title="2. 思路"></a>2. 思路</h4><p>想到django是可以直接配置logger为<code>django.db.backends</code>来打印具体SQL的，所以我们就可以以这里为突破口，进行实际SQL的AOP的trace。经过源码追踪，发现关键类<code>django.db.backends.mysql.base.CursorWrapper</code>，主要包含两个方法<code>execute</code>和<code>executemany</code>，但是这个东西只有在settings.DEBUG为True的时候才生效。</p>
<p>找下django有没有提供一些进行这个部分custom的方法，么有搜到，但是搜到了一个更大更全的custom选项，就是直接把整个backend engine都进行定制。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">DATABASES = &#123;</div><div class="line">    <span class="string">'default'</span>: &#123;</div><div class="line">        <span class="string">'ENGINE'</span>: <span class="string">'metamap.will_backends'</span>,</div><div class="line">        <span class="string">'NAME'</span>: result[<span class="string">'MAIN_DB_NAME'</span>],</div><div class="line">        <span class="string">'PASSWORD'</span>: result[<span class="string">'MAIN_DB_PWD'</span>],</div><div class="line">        <span class="string">'USER'</span>: result[<span class="string">'MAIN_DB_USER'</span>],</div><div class="line">        <span class="string">'HOST'</span>: result[<span class="string">'MAIN_DB_HOST'</span>],</div><div class="line">        <span class="string">'PORT'</span>: result[<span class="string">'MAIN_DB_PORT'</span>],</div><div class="line">        <span class="string">'TEST'</span>: &#123;</div><div class="line">            <span class="string">'NAME'</span>: <span class="string">'metamap1'</span>,</div><div class="line">        &#125;,</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>虽然官网没有提及自定义database backend的，但是搜到了一些相关的文章，有兴趣的同学可以看一下。通过上面的配置也可以很容易看出<code>ENGINE</code>是可以使用自定义的东西的。因为我们这里只是要针对Wrapper弄个AOP，所以直接找到django的mysql base，整体复制下来，加上我们的tracer装饰器就可以了。</p>
<h4 id="3-实施"><a href="#3-实施" class="headerlink" title="3. 实施"></a>3. 实施</h4><p>复制django原生mysql引擎代码到自己的项目中，目录结构如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">app_dir</div><div class="line">├── admin.py</div><div class="line">......</div><div class="line">.....</div><div class="line">└── will_backends   # mysql引擎目录</div><div class="line">    ├── base.py     # 目标所在文件</div><div class="line">    ├── client.py</div><div class="line">    ├── compiler.py</div><div class="line">    ├── creation.py</div><div class="line">    ├── features.py</div><div class="line">    ├── __init__.py</div><div class="line">    ├── introspection.py</div><div class="line">    ├── operations.py</div><div class="line">    ├── schema.py</div><div class="line">    └── validation.py</div></pre></td></tr></table></figure></p>
<p>我们的tracer装饰器代码在上一篇文章《django中使用threadlocal存放tracer》已经提到了。自定义的mysql的<code>CursorWrapper</code>代码如下：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">from</span> will_common.decorators <span class="keyword">import</span> jaeger_tracer</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CursorWrapper</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, cursor)</span>:</span></div><div class="line">        self.cursor = cursor</div><div class="line"></div><div class="line"><span class="meta">    @jaeger_tracer('mysql')</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">execute</span><span class="params">(self, query, args=None)</span>:</span></div><div class="line">        ....</div><div class="line"></div><div class="line"><span class="meta">    @jaeger_tracer('mysql')</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">executemany</span><span class="params">(self, query, args)</span>:</span></div><div class="line">        .....</div></pre></td></tr></table></figure></p>
<p>很简单，加上我们的装饰器。看下效果</p>
<p><img src="/imgs/trace/django_jaeger_mysql_tracer.png" alt="产出的jaeger trace效果图"></p>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li><a href="https://docs.python.org/2/library/inspect.html#inspect.getsourcefile" target="_blank" rel="external">python反射相关</a></li>
<li><a href="https://gist.github.com/ur001/3e86d43f1e80f17fbfd9" target="_blank" rel="external">监听django model的操作</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/linux/l-cpdecor.html" target="_blank" rel="external">基于decorator的元编程</a></li>
<li><a href="https://docs.djangoproject.com/en/2.0/topics/logging/" target="_blank" rel="external">django日志</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> django </tag>
            
            <tag> 架构，jaeger </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[django中使用threadlocal存放tracer]]></title>
      <url>/2018/01/19/django%E4%B8%AD%E4%BD%BF%E7%94%A8threadlocal%E5%AD%98%E6%94%BEtracer/</url>
      <content type="html"><![CDATA[<p>基于上篇《服务trace的一些理解》，想办法把django的view里的tracer和model.pre_save的tracer通过threadlocal统一起来。</p>
<p>结合gunicorn考虑一下，其实如果能保证gunicorn的每个worker都是单线程的话，就不存在这种问题，只要弄一个静态的tracer就可以了。</p>
<h4 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h4><ul>
<li>middleware从threadlocal引入tracer，打在request层面，这里会有第一个span</li>
<li>redis/db的关键API通过<code>jaeger_tracer</code>装饰器方式获得threadlocal里的tracer，新增一个child span</li>
</ul>
<h4 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h4><p>middleware沿用<code>django_opentracing</code>的使用方式，修改生成tracer的方式为每个thread一个tracer，因为worker可能是多线程的，也方便后面处理逻辑获取当前线程中既有的tracer：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span>:</div><div class="line">    <span class="comment"># Django &gt;= 1.10</span></div><div class="line">    <span class="keyword">from</span> django.utils.deprecation <span class="keyword">import</span> MiddlewareMixin</div><div class="line"><span class="keyword">except</span> ImportError:</div><div class="line">    <span class="comment"># Not required for Django &lt;= 1.9, see:</span></div><div class="line">    <span class="comment"># https://docs.djangoproject.com/en/1.10/topics/http/middleware/#upgrading-pre-django-1-10-style-middleware</span></div><div class="line">    MiddlewareMixin = object</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WillOpenTracingMiddleware</span><span class="params">(MiddlewareMixin)</span>:</span></div><div class="line">    <span class="string">'''</span></div><div class="line">    __init__()只会被调用一次，没有参数，只有server对第一个request生成response的时候被调用一次</div><div class="line">    '''</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, get_response=None)</span>:</span></div><div class="line">        <span class="string">'''</span></div><div class="line">        TODO: ANSWER Qs</div><div class="line">        - Is it better to place all tracing info in the settings file, or to require a tracing.py file with configurations?</div><div class="line">        - Also, better to have try/catch with empty tracer or just fail fast if there's no tracer specified</div><div class="line">        '''</div><div class="line">        self.get_response = get_response</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_view</span><span class="params">(self, request, view_func, view_args, view_kwargs)</span>:</span></div><div class="line">        <span class="comment"># 如果配置中并不是trace所有request，这个middleware就不会有任何作为，实际trace应该交由decorator来做</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> threadlocals.get_current_tracer()._trace_all:</div><div class="line">            <span class="keyword">return</span> <span class="keyword">None</span></div><div class="line"></div><div class="line">        <span class="keyword">if</span> hasattr(settings, <span class="string">'OPENTRACING_TRACED_ATTRIBUTES'</span>):</div><div class="line">            traced_attributes = getattr(settings, <span class="string">'OPENTRACING_TRACED_ATTRIBUTES'</span>)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            traced_attributes = []</div><div class="line">        threadlocals.set_thread_variable(<span class="string">'request'</span>, request)</div><div class="line">        threadlocals.get_current_tracer()._apply_tracing(request, view_func, traced_attributes)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">process_response</span><span class="params">(self, request, response)</span>:</span></div><div class="line">        threadlocals.get_current_tracer()._finish_tracing(request)</div><div class="line">        <span class="keyword">return</span> response</div></pre></td></tr></table></figure></p>
<p><code>django_opentracing</code>中的<code>DjangoTracer</code>剖析一下:<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DjangoTracer</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">'''</span></div><div class="line">    是对一种tracer的wrapper</div><div class="line">    '''</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, tracer=None)</span>:</span></div><div class="line">        self._tracer_implementation = <span class="keyword">None</span></div><div class="line">        <span class="keyword">if</span> tracer:</div><div class="line">            self._tracer_implementation = tracer</div><div class="line">        self._current_spans = &#123;&#125;</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> hasattr(settings, <span class="string">'OPENTRACING_TRACE_ALL'</span>):</div><div class="line">            self._trace_all = <span class="keyword">False</span></div><div class="line">        <span class="keyword">elif</span> <span class="keyword">not</span> getattr(settings, <span class="string">'OPENTRACING_TRACE_ALL'</span>):</div><div class="line">            self._trace_all = <span class="keyword">False</span></div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self._trace_all = <span class="keyword">True</span></div><div class="line"></div><div class="line"><span class="meta">    @property</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_tracer</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">if</span> self._tracer_implementation:</div><div class="line">            <span class="keyword">return</span> self._tracer_implementation</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            <span class="keyword">return</span> opentracing.tracer</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_span</span><span class="params">(self, request)</span>:</span></div><div class="line">        <span class="string">'''</span></div><div class="line">        @param request</div><div class="line">        返回trace给定request的span</div><div class="line">        '''</div><div class="line">        <span class="keyword">return</span> self._current_spans.get(request, <span class="keyword">None</span>)</div><div class="line">        </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">trace</span><span class="params">(self, *attributes)</span>:</span></div><div class="line">        <span class="string">'''</span></div><div class="line">        这是上面提到的Function decorator</div><div class="line">        注意:必须在 @app.route decorator后面</div><div class="line">        @param attributes any number of flask.Request attributes</div><div class="line">        (strings) to be set as tags on the created span</div><div class="line">        '''</div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">decorator</span><span class="params">(view_func)</span>:</span></div><div class="line">            <span class="comment"># <span class="doctag">TODO:</span> do we want to provide option of overriding trace_all_requests so that they</span></div><div class="line">            <span class="comment"># can trace certain attributes of the request for just this request (this would require</span></div><div class="line">            <span class="comment"># to reinstate the name-mangling with a trace identifier, and another settings key)</span></div><div class="line">            <span class="comment"># 如果是_trace_all，就直接返回，原因参考上面的middleware的逻辑</span></div><div class="line">            <span class="keyword">if</span> self._trace_all:</div><div class="line">                <span class="keyword">return</span> view_func</div><div class="line">            <span class="comment"># otherwise, execute decorator</span></div><div class="line">            <span class="function"><span class="keyword">def</span> <span class="title">wrapper</span><span class="params">(request)</span>:</span></div><div class="line">                span = self._apply_tracing(request, view_func, list(attributes))</div><div class="line">                r = view_func(request)</div><div class="line">                self._finish_tracing(request)</div><div class="line">                <span class="keyword">return</span> r</div><div class="line">            <span class="keyword">return</span> wrapper</div><div class="line">        <span class="keyword">return</span> decorator</div><div class="line">    </div><div class="line">    <span class="comment"># 实际trace逻辑</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_apply_tracing</span><span class="params">(self, request, view_func, attributes)</span>:</span></div><div class="line">        <span class="string">'''</span></div><div class="line">        避免middleware和decorator之间出现重写。返回request的新的span和view_func的正确的operation名字</div><div class="line">        '''</div><div class="line">        <span class="comment"># strip headers for trace info</span></div><div class="line">        headers = &#123;&#125;</div><div class="line">        <span class="keyword">for</span> k,v <span class="keyword">in</span> request.META.iteritems():</div><div class="line">            k = k.lower().replace(<span class="string">'_'</span>,<span class="string">'-'</span>)</div><div class="line">            <span class="keyword">if</span> k.startswith(<span class="string">'http-'</span>):</div><div class="line">                k = k[<span class="number">5</span>:]</div><div class="line">            headers[k] = v</div><div class="line"></div><div class="line">        <span class="comment"># start new span from trace info</span></div><div class="line">        span = <span class="keyword">None</span></div><div class="line">        operation_name = view_func.__name__</div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            span_ctx = self._tracer.extract(opentracing.Format.HTTP_HEADERS, headers)</div><div class="line">            span = self._tracer.start_span(operation_name=operation_name, child_of=span_ctx)</div><div class="line">        <span class="keyword">except</span> (opentracing.InvalidCarrierException, opentracing.SpanContextCorruptedException) <span class="keyword">as</span> e:</div><div class="line">            span = self._tracer.start_span(operation_name=operation_name)</div><div class="line">        <span class="keyword">if</span> span <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">            span = self._tracer.start_span(operation_name=operation_name)</div><div class="line"></div><div class="line">        <span class="comment"># add span to current spans</span></div><div class="line">        <span class="comment"># 把request与span的对应关系存进这个DjangoTracer的一个字典里</span></div><div class="line">        <span class="comment"># 按执行过程推理，如果有request并发的话，保证span不会错乱，跟threadlocal的作用差不多，但是需要额外的request参数才行</span></div><div class="line">        self._current_spans[request] = span</div><div class="line"></div><div class="line">        <span class="comment"># log any traced attributes</span></div><div class="line">        <span class="keyword">for</span> attr <span class="keyword">in</span> attributes:</div><div class="line">            <span class="keyword">if</span> hasattr(request, attr):</div><div class="line">                payload = str(getattr(request, attr))</div><div class="line">                <span class="keyword">if</span> payload:</div><div class="line">                    span.set_tag(attr, payload)</div><div class="line"></div><div class="line">        <span class="keyword">return</span> span</div><div class="line"></div><div class="line">    <span class="comment"># 将所有span结束</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_finish_tracing</span><span class="params">(self, request)</span>:</span></div><div class="line">        span = self._current_spans.pop(request, <span class="keyword">None</span>)</div><div class="line">        <span class="keyword">if</span> span <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">None</span>:</div><div class="line">            span.finish()</div></pre></td></tr></table></figure></p>
<p>我们的思路是使用threadlocal实现，原因上面也提到了，threadlocal不用给方法传递类似request这种额外的参数。对于后端redis/mysql等会很方便。</p>
<p>下面是一个简单的使用<code>DjangoTracer</code>的threadlocal实现简版：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*-</span></div><div class="line"><span class="string">"""</span></div><div class="line">__init__ module for the threadlocals package</div><div class="line">"""</div><div class="line"><span class="keyword">import</span> opentracing</div><div class="line"><span class="keyword">from</span> django_opentracing <span class="keyword">import</span> DjangoTracer</div><div class="line"><span class="keyword">from</span> jaeger_client <span class="keyword">import</span> Config</div><div class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> local</div><div class="line"></div><div class="line">__docformat__ = <span class="string">"restructuredtext"</span></div><div class="line"></div><div class="line">_threadlocals = local()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">set_thread_variable</span><span class="params">(key, val)</span>:</span></div><div class="line">    setattr(_threadlocals, key, val)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_thread_variable</span><span class="params">(key, default=None)</span>:</span></div><div class="line">    <span class="keyword">return</span> getattr(_threadlocals, key, default)</div><div class="line"></div><div class="line"><span class="comment"># 通过threadlocal获取当前线程的tracer</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_current_tracer</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> hasattr(_threadlocals, <span class="string">'tracer'</span>):</div><div class="line">        config = Config(</div><div class="line">            config=&#123;</div><div class="line">                <span class="string">'sampler'</span>: &#123;</div><div class="line">                    <span class="string">'type'</span>: <span class="string">'const'</span>,</div><div class="line">                    <span class="string">'param'</span>: <span class="number">1</span></div><div class="line">                &#125;,</div><div class="line">                <span class="string">'local_agent'</span>: &#123;</div><div class="line">                    <span class="string">'reporting_host'</span>: <span class="string">'10.103.27.152'</span></div><div class="line">                &#125;</div><div class="line">            &#125;,</div><div class="line">            service_name=<span class="string">'will-django'</span></div><div class="line">        )</div><div class="line">        set_request_variable(<span class="string">'tracer'</span>, DjangoTracer(config.initialize_tracer()))</div><div class="line">    <span class="keyword">return</span> get_thread_variable(<span class="string">'tracer'</span>)</div></pre></td></tr></table></figure></p>
<p>自定义<code>jaeger_tracer</code>装饰器：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">jaeger_tracer</span><span class="params">(service=<span class="string">'will'</span>)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_my_decorator</span><span class="params">(func)</span>:</span></div><div class="line">        <span class="function"><span class="keyword">def</span> <span class="title">_decorator</span><span class="params">(*args, **kwargs)</span>:</span></div><div class="line">            <span class="keyword">with</span> get_current_tracer()._tracer.start_span(os.path.basename(inspect.getsourcefile(func))[:<span class="number">-2</span>] + func.func_name,</div><div class="line">                                                         child_of=get_current_tracer().get_span(</div><div class="line">                                                                 get_current_request())) <span class="keyword">as</span> ttspan:</div><div class="line">                <span class="comment"># ttspan.set_tag(ext_tags.SPAN_KIND, ext_tags.SPAN_KIND_RPC_CLIENT)</span></div><div class="line">                <span class="comment"># ttspan.set_tag(ext_tags.PEER_SERVICE, service)</span></div><div class="line">                <span class="keyword">for</span> k, v <span class="keyword">in</span> kwargs.items():</div><div class="line">                    ttspan.set_tag(k, v)</div><div class="line">                ttspan.set_tag(<span class="string">'args'</span>, args[<span class="number">1</span>:])</div><div class="line">                ttspan.log_event(<span class="string">'this is done by will'</span>)</div><div class="line">                <span class="keyword">return</span> func(*args, **kwargs)</div><div class="line">        <span class="keyword">return</span> _decorator</div><div class="line">    <span class="keyword">return</span> _my_decorator</div></pre></td></tr></table></figure></p>
<p>使用例子：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@jaeger_tracer('redis')</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_keys</span><span class="params">()</span>:</span></div><div class="line">    r = redis.StrictRedis(connection_pool=pool)</div><div class="line">    <span class="keyword">return</span> [key <span class="keyword">for</span> key <span class="keyword">in</span> r.keys() <span class="keyword">if</span> <span class="string">'_'</span> <span class="keyword">not</span> <span class="keyword">in</span> key <span class="keyword">and</span> <span class="string">'unack'</span> <span class="keyword">not</span> <span class="keyword">in</span> key]</div></pre></td></tr></table></figure></p>
<p><img src="/imgs/trace/django_jaeger_redis_tracer.png" alt="产出的jaeger trace效果图"></p>
<h4 id="不足"><a href="#不足" class="headerlink" title="不足"></a>不足</h4><ul>
<li>只支持两层span，request一层，然后redis一层。如果还有多层，需要在current_span那里下点儿功夫了</li>
<li>djangoTracer的字典是可有可无的，因为不再是针对request的，而是针对thread的</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="https://github.com/shtalinberg/django-actions-logger/blob/master/actionslog/middleware.py" target="_blank" rel="external">https://github.com/shtalinberg/django-actions-logger/blob/master/actionslog/middleware.py</a></li>
<li><a href="https://github.com/benoitc/gunicorn/issues/1045" target="_blank" rel="external">https://github.com/benoitc/gunicorn/issues/1045</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> django </tag>
            
            <tag> jaeger </tag>
            
            <tag> 架构 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hue兼容slider部署的presto]]></title>
      <url>/2017/12/26/hue%E5%85%BC%E5%AE%B9slider%E9%83%A8%E7%BD%B2%E7%9A%84presto/</url>
      <content type="html"><![CDATA[<p>通常对于应用部署，尤其是presto这种占用资源比较大，而且可能需要动态扩缩容的场景，我们会考虑使用资源管理框架来进行控制。首先想到的就是yarn和mesos。</p>
<p>我们可以通过slider将presot部署到yarn上，或者使用docker部署persto到mesos上实现资源管控。对于前者slider的服务发现与注册功能稍有欠缺，而后者的话，通过marathon-lb很容易实现服务发现功能，只需要把coordinator注册过去就可了。我们目前暂时使用第一种方案。</p>
<p>前面我们开发了自己的presto connector，但是我们还要面临一个跟jdbc相关的presto的问题，就是当我们使用slider部署presto到yarn的时候，presto的coordinator是变化的。为解决这个问题，我们需要修改一下presto建立数据库连接的位置的代码，使用动态获取yarn应用的方式进行url更新。</p>
<p>两种方案</p>
<h4 id="从yarn爬取"><a href="#从yarn爬取" class="headerlink" title="从yarn爬取"></a>从yarn爬取</h4><p>原来的presto connector是从jdbc复制过来，需要的option参数如下：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[[[presto]]]</div><div class="line">      name=Presto</div><div class="line">      interface=presto</div><div class="line">      options=<span class="string">'&#123;"password": "***empty***", "url": "jdbc:presto://datanode13.will.com:8099/hive/", "driver": "com.facebook.presto.jdbc.PrestoDriver"&#125;'</span></div></pre></td></tr></table></figure></p>
<p>我们修改为如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[[[presto]]]</div><div class="line">      name=Presto</div><div class="line">      interface=presto</div><div class="line">      options=&apos;&#123;&quot;password&quot;: &quot;***empty***&quot;, &quot;url&quot;: &quot;jdbc:presto://&#123;coordinator_host&#125;:8099/hive/&quot;, &quot;driver&quot;: &quot;com.facebook.presto.jdbc.PrestoDriver&quot;, &quot;app_name&quot;: &quot;presto_will_online&quot;, &quot;resource_manager&quot;: &quot;http://datanode02.will.com:8088&quot;&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>然后presto.py原代码：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">PrestoApi</span><span class="params">(Api)</span>:</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, user, interpreter=None)</span>:</span></div><div class="line">    <span class="keyword">global</span> API_CACHE</div><div class="line">    Api.__init__(self, user, interpreter=interpreter)</div><div class="line"></div><div class="line">    self.db = <span class="keyword">None</span></div><div class="line">    self.options = interpreter[<span class="string">'options'</span>]</div><div class="line"></div><div class="line">    <span class="comment"># 爬取yarn上的presto地址，清洗url参数</span></div><div class="line"></div><div class="line">    <span class="keyword">if</span> self.cache_key <span class="keyword">in</span> API_CACHE:</div><div class="line">      self.db = API_CACHE[self.cache_key]</div><div class="line">    <span class="keyword">elif</span> <span class="string">'password'</span> <span class="keyword">in</span> self.options:</div><div class="line">      username = self.options.get(<span class="string">'user'</span>) <span class="keyword">or</span> user.username</div><div class="line">      self.db = API_CACHE[self.cache_key] = Jdbc(self.options[<span class="string">'driver'</span>], self.options[<span class="string">'url'</span>], username, self.options[<span class="string">'password'</span>])</div></pre></td></tr></table></figure></p>
<p>参考： </p>
<ul>
<li><a href="https://hadoop.apache.org/docs/r2.7.3/hadoop-yarn/hadoop-yarn-site/ResourceManagerRest.html#Cluster_Application_Statistics_API" target="_blank" rel="external">https://hadoop.apache.org/docs/r2.7.3/hadoop-yarn/hadoop-yarn-site/ResourceManagerRest.html#Cluster_Application_Statistics_API</a></li>
</ul>
<h4 id="presto-coordinator启动后自动注册当前主机"><a href="#presto-coordinator启动后自动注册当前主机" class="headerlink" title="presto coordinator启动后自动注册当前主机"></a>presto coordinator启动后自动注册当前主机</h4><p>找到presto-yarn项目解压后的脚本<code>package/scripts/presto_coordinator.py</code>内容<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> presto_server <span class="keyword">import</span> PrestoServer</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">    PrestoServer(<span class="string">'COORDINATOR'</span>).execute()</div><div class="line">    </div><div class="line">    <span class="comment"># 添加向指定位置注册当前主机名的代码, 可以注册到redis、mysql、hdfs、zk等</span></div></pre></td></tr></table></figure></p>
<p>最终选用的方案是方案一，考虑是已经对hue有了一些二次开发了。就直接把修改放在hue上吧，后续我们还是有可能把presto迁移到docker上的。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[presto与impala的初步比较]]></title>
      <url>/2017/12/26/presto%E4%B8%8Eimpala%E7%9A%84%E5%88%9D%E6%AD%A5%E6%AF%94%E8%BE%83/</url>
      <content type="html"><![CDATA[<table>
<thead>
<tr>
<th>特性</th>
<th>presto</th>
<th>impala</th>
</tr>
</thead>
<tbody>
<tr>
<td>sql兼容</td>
<td>兼容mysql标准函数与类型，分析师只需掌握mysql语法函数即可</td>
<td>高度兼容hive</td>
</tr>
<tr>
<td>部署难度</td>
<td>较低</td>
<td>高</td>
</tr>
<tr>
<td>规模</td>
<td>动态调整</td>
<td>每个DataNode上都要一个impala实例</td>
</tr>
<tr>
<td>容错</td>
<td>多个worker挂掉不影响</td>
<td>多个impalad实例挂掉会有较大影响</td>
</tr>
<tr>
<td>性能</td>
<td>高，秒级</td>
<td>很高，秒级</td>
</tr>
<tr>
<td>语言</td>
<td>java</td>
<td>c++</td>
</tr>
<tr>
<td>容量</td>
<td>易于扩缩容，不影响既有应用</td>
<td>完全取决于datanode</td>
</tr>
<tr>
<td>问题解决</td>
<td>基于java,，自主patch或者熟悉原理的成本低</td>
<td>基于c++，自主patch或者熟悉原理的成本较高</td>
</tr>
<tr>
<td>社区</td>
<td>国内各种技术会议议题点击率较高【美团、头条、滴滴、链家等等】</td>
<td>国内使用的目前耳闻几乎没有</td>
</tr>
<tr>
<td>hive兼容性</td>
<td>对于基于异构存储的hive表不能兼容</td>
<td>自己维护额外的元数据表，所有的hive表变更都需要额外的命令操作，极不方便</td>
</tr>
<tr>
<td>数据源兼容性</td>
<td>高，自定义connector</td>
<td>低，只兼容HDFS之上</td>
</tr>
</tbody>
</table>
<p>我们的现状</p>
<ul>
<li>人力资源少，可投入专项维护的人员几乎没有</li>
<li>需求方接受查询在分钟级别的体验，期望更快的体验</li>
<li>需尽快响应使用中出现的问题</li>
</ul>
<p>基于以上，两者的性能差距对我们的影响较小，执行时间差别感知较小。而其他维护性的工作【扩缩容、问题排查等】对于当前数据组的有限精力来说更为看重。所以选型<strong>暂定为persto</strong>。</p>
<p>其实最主要的就是： <strong>出问题的话，是几度懵逼！！</strong></p>
<p>参考 :</p>
<ul>
<li><a href="https://www.quora.com/How-does-Cloudera-Impala-compare-to-Facebooks-Presto" target="_blank" rel="external">https://www.quora.com/How-does-Cloudera-Impala-compare-to-Facebooks-Presto</a></li>
<li><a href="http://blog.cloudera.com/blog/2014/09/new-benchmarks-for-sql-on-hadoop-impala-1-4-widens-the-performance-gap/" target="_blank" rel="external">http://blog.cloudera.com/blog/2014/09/new-benchmarks-for-sql-on-hadoop-impala-1-4-widens-the-performance-gap/</a> 【这个是impala的爸爸CDH的文章，准确性有待探测】</li>
<li><a href="https://groups.google.com/forum/#!topic/presto-users/NA42x4B0H-o" target="_blank" rel="external">https://groups.google.com/forum/#!topic/presto-users/NA42x4B0H-o</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[GIAC-全球互联网架构大会]]></title>
      <url>/2017/12/26/GIAC-%E5%85%A8%E7%90%83%E4%BA%92%E8%81%94%E7%BD%91%E6%9E%B6%E6%9E%84%E5%A4%A7%E4%BC%9A/</url>
      <content type="html"><![CDATA[<h4 id="摩拜"><a href="#摩拜" class="headerlink" title="摩拜"></a>摩拜</h4><p>新上的火爆活动，需要后端扩容 —— 使用swarm支持动态扩缩容</p>
<p>国际化带来的问题：欧盟数据保护规范：GDPR</p>
<p>使用腾讯云在全球主要位置部署了多数据中心。</p>
<p>多集群、同城多活，也是通过腾讯云给的解决方案搞定</p>
<p>多集群、异地多活。可以缓存的全部引入CDN</p>
<p>dbproxy. mysql分表分库-&gt;TiDB</p>
<p>DRC 数据复制中心</p>
<p>Mysql -&gt; kafka -&gt; xxx</p>
<p>随着开发人员增多，代码合并后的质量很成问题。 -&gt; 拆分spring cloud微服务 + netflix</p>
<p>nginx + lua [路由控制、负载均衡、服务发现] -&gt; spring zuul [目前的问题：同步IO，占用CPU内存较高]</p>
<p>spring config 、 consul + vault进行加密控制，后面接git、svn、文件</p>
<p>feign client + consul</p>
<p>内部通信使用grpc</p>
<p>容器问题【端口协调、依赖ansible、】</p>
<p>docker swarm的overlay网络开销比较大，使用了腾讯的swarm服务，基于docker swarm有了一些改进。</p>
<p>mongo是有可能有安全漏洞的，摩拜只是使用mongo来存储地理位置信息，因为对安全不太相关，最多就车的信息被泄露出去。同时也有网络隔离等安全措施</p>
<p>所有的服务都应该是无状态的，可以飘移到任何地方，这在最开始的时候就已经有了这个考虑。</p>
<p>服务化扩展使用docker swarm实现，持久化数据的扩展使用TiDB、codis等易于扩展的数据库【分表分库对于一些很复杂的连接sql，外键关联等业务不能支持很好】。</p>
<p>不可能所有服务都满足CAP，所以先需要对事务进行服务定级。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[slider服务发现]]></title>
      <url>/2017/12/22/slider%E6%9C%8D%E5%8A%A1%E5%8F%91%E7%8E%B0/</url>
      <content type="html"><![CDATA[<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><ul>
<li>client可能是运行在cluster之外的</li>
<li>部署在yarn里的各个component的位置都是会变的</li>
<li>服务端口可以是固定的、或者可预测的</li>
</ul>
<p>比如开始在client端指定了service的位置，但是如果service遇到失败自己重启了，这个位置可能就在yarn集群中变了。client自然就访问不到了。这种事情的发生几率跟集群稳定性有很大关系。</p>
<p>其他限制</p>
<ul>
<li>降低已经存在app的变化次数，最好是一次都不要变。。这显然不现实</li>
<li>防止恶意注册service endpoint</li>
<li>app和client都可以任意扩缩容</li>
</ul>
<h4 id="可能的解决方案"><a href="#可能的解决方案" class="headerlink" title="可能的解决方案"></a>可能的解决方案</h4><h6 id="zookeeper"><a href="#zookeeper" class="headerlink" title="zookeeper"></a>zookeeper</h6><p>client用zk来发现service，hbase就是这样的</p>
<h6 id="DNS"><a href="#DNS" class="headerlink" title="DNS"></a>DNS</h6><h6 id="变化的IP地址"><a href="#变化的IP地址" class="headerlink" title="变化的IP地址"></a>变化的IP地址</h6><h6 id="LDAP"><a href="#LDAP" class="headerlink" title="LDAP"></a>LDAP</h6><h6 id="等等"><a href="#等等" class="headerlink" title="等等"></a>等等</h6><p>我的场景就是使用slider在yarn上部署了presto，presto的coordinator的位置是会变化的，但是端口是固定的。在不修改hue的配置的前提下，怎样才能跟随presto变化呢？</p>
<p>个人认为官网给的点子都把问题复杂化了。</p>
<p>前面提到其实我们已经在hue的源码里自己创建presto的jdbc类，那么我们在建立session的时候，那个url通过爬取yarn上运行的我们指定presto app名字的位置的接口不就可以获取到当前在yarn里运行着的presto的coordinator了。聪明如我，嘎嘎。而且，hue本来就是要配置resourcemanager的地址，来抓取hive任务的执行进度的。</p>
<p>伪代码如下<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">creat_sesssion</span><span class="params">()</span>:</span></div><div class="line">    url = request_yarn(options[<span class="string">'presto_app_name'</span>])</div><div class="line">    session = JDBC(self.user, self.pwd, url..)</div></pre></td></tr></table></figure></p>
<p>参考： <a href="https://slider.incubator.apache.org/design/registry/index.html" target="_blank" rel="external">https://slider.incubator.apache.org/design/registry/index.html</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[pika笔记]]></title>
      <url>/2017/12/22/pika%E7%AC%94%E8%AE%B0/</url>
      <content type="html"><![CDATA[<p>redis的角色从缓存，现在慢慢转向内存数据库了。</p>
<p>但是因为自身的内存限制上有限制，所以诞生了pika。借助了redis的很多机制和rocksdb的存储，基于rocksdb的接口实现pika的功能。</p>
<h4 id="pika-1-0"><a href="#pika-1-0" class="headerlink" title="pika 1.0"></a>pika 1.0</h4><p>ttl功能通过在插入数据时，修改rocksdb时带上ttl时间戳字段。修改rocksdb的get接口，进行时间戳判断。</p>
<p>使用version实现了大量数据的的秒删，先把这个hash当前version递加，其实原理跟hbase是一样的原理，后面再在compact的过程中进行真正物理的删除。</p>
<p>问题：</p>
<ul>
<li>同步的数据缓冲区容易写满，扫瞄binlog的进程比较快，传输比较慢</li>
<li>存活检测与数据同步相互影响，存活检测迟迟得不到响应</li>
<li>全同步bgsave，主库dump，然后发给从库。很慢，而且数据量有很大</li>
</ul>
<h4 id="pika-2-0"><a href="#pika-2-0" class="headerlink" title="pika 2.0"></a>pika 2.0</h4><h6 id="解决1-0的问题"><a href="#解决1-0的问题" class="headerlink" title="解决1.0的问题"></a>解决1.0的问题</h6><ul>
<li>线程合并与拆分，进行重构优化</li>
<li>存活检测与数据同步隔离</li>
<li>快照式备份，百G秒级相应。使用rocksdb的checkpoint执行，阻塞一下，确保数据一致，创建文件硬链</li>
</ul>
<h6 id="解耦rocksdb"><a href="#解耦rocksdb" class="headerlink" title="解耦rocksdb"></a>解耦rocksdb</h6><p>rocksdb更新速度非常快，使用新版特性的时候，要修改很多代码。</p>
<p>在rocksdb之上实现一个adaptor，也就是nemo-rocksdb。</p>
<p>回收metakey，metakey其实是hash表的唯一key。主要是比如hash1被删除了，但是还没有compact的时候，然后又马上重建了hash1，那么这个metakey的version就又成了0了。期望version是绝对的增长，后来把新建version改成当前时间戳了，删的时候就直接删，再新建的时候再弄这个当前时间戳。</p>
<h4 id="pika-2-3-0"><a href="#pika-2-3-0" class="headerlink" title="pika 2.3.0"></a>pika 2.3.0</h4><ul>
<li>pika双主，高可用。但是还需要切流量。当原主恢复后，可以先全同步数据，再增量同步，因为可能挂掉的时间比较长，binlog会很多。 还有：不支持双主写同一个key的value，可能会出现问题。推荐写只走一个实例，另一个作为standby。</li>
<li>跨机房同步。pika_hub以slave的身份加入多个机房集群，相互同步。注意pika_hub也要多实例高可用，借用外部的高可用一致性raft组件存储元数据、竞锁选主。如果有多个对于同一个key的操作，就以时间戳的形式兼容。pika_hub之间不同步log，只发送raft记录断点，主节点定时记录checkpoint到raft集群。</li>
<li>支持订阅。</li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[slider配置相关]]></title>
      <url>/2017/12/22/slider%E9%85%8D%E7%BD%AE%E7%9B%B8%E5%85%B3/</url>
      <content type="html"><![CDATA[<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><h6 id="component的失败处理"><a href="#component的失败处理" class="headerlink" title="component的失败处理"></a>component的失败处理</h6><p>文档中并没有明确说这回事儿，需要自己去理解，理解了好半天。就是需要下面两个参数配置起来才行的。先配置一个window，指定一个时段长度，然后在单个时段长度内达到阈值上限才会认为app失败，否则就会一直重启。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
<th>默认</th>
</tr>
</thead>
<tbody>
<tr>
<td>yarn.container.failure.threshold</td>
<td>窗口内失败次数的阈值</td>
<td>默认貌似是5次</td>
</tr>
<tr>
<td>yarn.container.failure.window.day、yarn.container.failure.window.hours、yarn.container.failure.window.minutes</td>
<td>窗口时间段</td>
<td>默认是<code>yarn.container.failure.window.hours=6</code></td>
</tr>
</tbody>
</table>
<h6 id="放置策略"><a href="#放置策略" class="headerlink" title="放置策略"></a>放置策略</h6><p>其实就是把app分配到哪些node上的策略。有三个值</p>
<ul>
<li><ol>
<li>默认的：就是重启的时候满集群找合适的节点，除了不可用的node都有可能被选中，如果没有满足的，就触发escalation</li>
</ol>
</li>
<li><ol>
<li>strict： 每个node都要有一个component，不管有没有失败历史。这就不会发生escalation了。</li>
</ol>
</li>
<li><ol>
<li>anywhere： 不顾历史，到处请求</li>
</ol>
</li>
<li><ol>
<li>anti affinity required(无穷远)：目前不支持。</li>
</ol>
</li>
</ul>
<p>例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&quot;HBASE_REST&quot;: &#123;</div><div class="line">  &quot;yarn.role.priority&quot;: &quot;3&quot;,</div><div class="line">  &quot;yarn.component.instances&quot;: &quot;1&quot;,</div><div class="line">  &quot;yarn.component.placement.policy&quot;: &quot;1&quot;,</div><div class="line">  &quot;yarn.memory&quot;: &quot;556&quot;</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<p>这里指定了为1，那么每次启动的时候都会找到上次运行的同一个节点。</p>
<p>yarn.node.failure.threshold | 在某个node上执行component失败的阈值，到达这个阈值后，就不会接受component了。</p>
<p>一个hbase的实例配置：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  "schema": "http://example.org/specification/v2.0.0",</div><div class="line">  "metadata": &#123;</div><div class="line">  &#125;,</div><div class="line">  "global": &#123;</div><div class="line">    "yarn.log.include.patterns": "hbase.*",</div><div class="line">    "yarn.log.exclude.patterns": "hbase.*out",</div><div class="line">    // 30分钟一个window</div><div class="line">    "yarn.container.failure.window.hours": "0",</div><div class="line">    "yarn.container.failure.window.minutes": "30",</div><div class="line">    // 选择带有development label的yarnnode分配component</div><div class="line">    "yarn.label.expression":"development"</div><div class="line">  &#125;,</div><div class="line">  "components": &#123;</div><div class="line">    "slider-appmaster": &#123;</div><div class="line">      "yarn.memory": "1024",</div><div class="line">      "yarn.vcores": "1"</div><div class="line">      // 可以随意分配到default label的node</div><div class="line">      "yarn.label.expression":""</div><div class="line">    &#125;,</div><div class="line">    "HBASE_MASTER": &#123;</div><div class="line">      // 数字越低，优先级越高，通常用来控制启动次序</div><div class="line">      "yarn.role.priority": "1",</div><div class="line">      "yarn.component.instances": "1",</div><div class="line">      "yarn.placement.escalate.seconds": "10",</div><div class="line">      "yarn.vcores": "1",</div><div class="line">      "yarn.memory": "1500"</div><div class="line">    &#125;,</div><div class="line">    "HBASE_REGIONSERVER": &#123;</div><div class="line">      "yarn.role.priority": "2",</div><div class="line">      "yarn.component.instances": "1",</div><div class="line">      "yarn.vcores": "1",</div><div class="line">      "yarn.memory": "1500",</div><div class="line">      // 30分钟内失败15次的话，就标记这个component部署失败</div><div class="line">      "yarn.container.failure.threshold": "15",</div><div class="line">      "yarn.placement.escalate.seconds": "60"</div><div class="line">    &#125;,</div><div class="line">    "HBASE_REST": &#123;</div><div class="line">      "yarn.role.priority": "3",</div><div class="line">      "yarn.component.instances": "1",</div><div class="line">      "yarn.component.placement.policy": "1",</div><div class="line">      // 30分钟内失败3次的话，就标记这个component部署失败</div><div class="line">      "yarn.container.failure.threshold": "3",</div><div class="line">      "yarn.vcores": "1",</div><div class="line">      "yarn.memory": "556"</div><div class="line">    &#125;,</div><div class="line">    "HBASE_THRIFT": &#123;</div><div class="line">      "yarn.role.priority": "4",</div><div class="line">      "yarn.component.instances": "0",</div><div class="line">      "yarn.component.placement.policy": "1",</div><div class="line">      "yarn.vcores": "1",</div><div class="line">      "yarn.memory": "556",</div><div class="line">      //  选择带有stable label的yarnnode分配component</div><div class="line">      "yarn.label.expression":"stable"</div><div class="line">    &#125;,</div><div class="line">    "HBASE_THRIFT2": &#123;</div><div class="line">      "yarn.role.priority": "5",</div><div class="line">      "yarn.component.instances": "1",</div><div class="line">      "yarn.component.placement.policy": "1",</div><div class="line">      "yarn.vcores": "1",</div><div class="line">      "yarn.memory": "556"，</div><div class="line">      //  选择带有stable label的yarnnode分配component</div><div class="line">      "yarn.label.expression":"stable"</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[整合presto与hue]]></title>
      <url>/2017/12/19/%E6%95%B4%E5%90%88presto%E4%B8%8Ehue/</url>
      <content type="html"><![CDATA[<p>传说是因为hue里没有直接对于presto的支持，所以大家都通过RDBMS间接的在hue上执行presto的查询。</p>
<h4 id="可行方案"><a href="#可行方案" class="headerlink" title="可行方案"></a>可行方案</h4><p>一共找到两种方案：</p>
<ul>
<li>借助postgresql创建中间的字典表，然后转化SQL进行执行。具体<a href="https://medium.com/@ilkkaturunen/integrating-presto-with-hue-61702b244839" target="_blank" rel="external">参考</a></li>
<li>presto jdbc</li>
</ul>
<p>第一种方案部署相对复杂很多，选用了第二种方案。不过过程中发现了一些不错的项目，回头来看其实都是presto官网推荐的，可以看一下<a href="https://prestodb.io/resources.html" target="_blank" rel="external">这些resource</a></p>
<h4 id="实际方案"><a href="#实际方案" class="headerlink" title="实际方案"></a>实际方案</h4><p>最后确认的方案，是使用官方提供的<a href="https://prestodb.io/docs/0.184/installation/jdbc.html" target="_blank" rel="external">jdbc连接方式</a>。这种相对简单，架构也更清晰一些。</p>
<p>主要包含以下几个步骤</p>
<h5 id="1-下载对应presto版本的jdbc包"><a href="#1-下载对应presto版本的jdbc包" class="headerlink" title="1. 下载对应presto版本的jdbc包"></a>1. 下载对应presto版本的jdbc包</h5><h5 id="2-修改本地java环境变量CLASSPATH"><a href="#2-修改本地java环境变量CLASSPATH" class="headerlink" title="2. 修改本地java环境变量CLASSPATH"></a>2. 修改本地java环境变量CLASSPATH</h5><p>否则会报classNotFound<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">export CLASSPATH=$CLASSPATH:/server/todo/presto-jdbc-0.184.jar</div></pre></td></tr></table></figure></p>
<p>其实个人感觉不太方便，所以在hue的启动脚本<code>build/env/bin/hue</code>里添加了一下环境变量的设置，算是高内聚一下hue相关<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    <span class="comment"># 添加环境变量设置</span></div><div class="line">    os.putenv(<span class="string">'CLASSPATH'</span>, <span class="string">'/server/todo/presto-jdbc-0.184.jar:'</span> + os.getenv(<span class="string">'CLASSPATH'</span>, <span class="string">''</span>))</div><div class="line">    <span class="keyword">print</span> os.getenv(<span class="string">'CLASSPATH'</span>)</div><div class="line"></div><div class="line">    sys.argv[<span class="number">0</span>] = re.sub(<span class="string">r'(-script\.pyw?|\.exe)?$'</span>, <span class="string">''</span>, sys.argv[<span class="number">0</span>])</div><div class="line">    sys.exit(</div><div class="line">        load_entry_point(<span class="string">'desktop'</span>, <span class="string">'console_scripts'</span>, <span class="string">'hue'</span>)()</div><div class="line">    )</div></pre></td></tr></table></figure></p>
<h5 id="3-在hue-ini里配置interpreter"><a href="#3-在hue-ini里配置interpreter" class="headerlink" title="3.在hue.ini里配置interpreter"></a>3.在hue.ini里配置interpreter</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[[interpreters]]</div><div class="line">  # Define the name and how to connect and execute the language.</div><div class="line">  [[[presto]]]</div><div class="line">    name=Presto JDBC</div><div class="line">    interface=jdbc</div><div class="line">    options=&apos;&#123;&quot;user&quot;: &quot;root&quot;, &quot;password&quot;: &quot;***empty***&quot;, &quot;url&quot;: &quot;jdbc:presto://datanode36.will.com:8099/hive/&quot;, &quot;driver&quot;: &quot;com.facebook.presto.jdbc.PrestoDriver&quot;&#125;&apos;</div></pre></td></tr></table></figure>
<p>这里有一个比较坑的地方，就是我们一般不会在presto server的接口做https，甚至不需要用户名密码验证。最开始的时候我配置成了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">options=&apos;&#123;&quot;user&quot;: &quot;root&quot;, &quot;password&quot;: &quot;&quot;, &quot;url&quot;: &quot;jdbc:presto://datanode36.will.com:8099/hive/&quot;, &quot;driver&quot;: &quot;com.facebook.presto.jdbc.PrestoDriver&quot;&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">options=&apos;&#123; &quot;url&quot;: &quot;jdbc:presto://datanode36.will.com:8099/hive/&quot;, &quot;driver&quot;: &quot;com.facebook.presto.jdbc.PrestoDriver&quot;&#125;&apos;</div></pre></td></tr></table></figure></p>
<p>就都会报不一样的错误, 看了一下presto jdbc的<a href="https://github.com/prestodb/presto/blob/master/presto-jdbc/src/main/java/com/facebook/presto/jdbc/PrestoDriverUri.java" target="_blank" rel="external">相关源码</a>：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"> <span class="comment">// <span class="doctag">TODO:</span> fix Tempto to allow empty passwords</span></div><div class="line">String password = PASSWORD.getValue(properties).orElse(<span class="string">""</span>);</div><div class="line"><span class="comment">// 如果密码不为空，就走这里</span></div><div class="line"><span class="keyword">if</span> (!password.isEmpty() &amp;&amp; !password.equals(<span class="string">"***empty***"</span>)) &#123;</div><div class="line">    <span class="keyword">if</span> (!useSecureConnection) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SQLException(<span class="string">"Authentication using username/password requires SSL to be enabled"</span>);</div><div class="line">    &#125;</div><div class="line">    builder.addInterceptor(basicAuth(getUser(), password));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (useSecureConnection) &#123;</div><div class="line">    setupSsl(</div><div class="line">            builder,</div><div class="line">            SSL_KEY_STORE_PATH.getValue(properties),</div><div class="line">            SSL_KEY_STORE_PASSWORD.getValue(properties),</div><div class="line">            SSL_TRUST_STORE_PATH.getValue(properties),</div><div class="line">            SSL_TRUST_STORE_PASSWORD.getValue(properties));</div><div class="line">&#125;</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>如果密码不为空的话，java.sql.DriverManager会报错，没有提供密码…</p>
<p>还有就是url里一定要执行catalog，不然报错<code>Catalog must be specified when session catalog</code></p>
<h5 id="4-改jdbc-py源码"><a href="#4-改jdbc-py源码" class="headerlink" title="4. 改jdbc.py源码"></a>4. 改jdbc.py源码</h5><p>最后一个是相对最麻烦的，就是hue的通用的获取数据库元数据的方式，对于presto来说并不适用，需要自己修改hue的<a href="https://github.com/cloudera/hue/blob/release-4.1.0/desktop/libs/notebook/src/notebook/connectors/jdbc.py" target="_blank" rel="external">python代码</a>。</p>
<p>可以看到下面这个类里的各种获取元数据的sql，其实都是不适用于我们的presto 0.184的，所以需要针对性的修改。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Assist</span><span class="params">()</span>:</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, db)</span>:</span></div><div class="line">    self.db = db</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get_databases</span><span class="params">(self)</span>:</span></div><div class="line">    <span class="comment">#dbs, description = query_and_fetch(self.db, 'SELECT DatabaseName FROM DBC.Databases')</span></div><div class="line">    dbs, description = query_and_fetch(self.db, <span class="string">'show schemas'</span>)</div><div class="line">    <span class="keyword">return</span> [db[<span class="number">0</span>] <span class="keyword">and</span> db[<span class="number">0</span>].strip() <span class="keyword">for</span> db <span class="keyword">in</span> dbs]</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get_tables</span><span class="params">(self, database, table_names=[])</span>:</span></div><div class="line">    <span class="comment">#tables, description = query_and_fetch(self.db, "SELECT * FROM dbc.tables WHERE tablekind = 'T' and databasename='%s'" % database)</span></div><div class="line">    tables, description = query_and_fetch(self.db, <span class="string">"show tables from %s"</span> % database)</div><div class="line">    <span class="keyword">return</span> [&#123;<span class="string">"comment"</span>: <span class="string">"will ff"</span>, <span class="string">"type"</span>: <span class="string">"Table"</span>, <span class="string">"name"</span>: table[<span class="number">0</span>] <span class="keyword">and</span> table[<span class="number">0</span>].strip()&#125; <span class="keyword">for</span> table <span class="keyword">in</span> tables]</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get_columns</span><span class="params">(self, database, table)</span>:</span></div><div class="line">    <span class="comment">#columns, description = query_and_fetch(self.db, "SELECT ColumnName, ColumnType, CommentString FROM DBC.Columns WHERE DatabaseName='%s' AND TableName='%s'" % (database, table))</span></div><div class="line">    columns, description = query_and_fetch(self.db, <span class="string">"desc %s.%s"</span> % (database, table))</div><div class="line">    <span class="keyword">return</span> [[col[<span class="number">0</span>] <span class="keyword">and</span> col[<span class="number">0</span>].strip(), self._type_converter(col[<span class="number">1</span>]), <span class="string">''</span>, <span class="string">''</span>, col[<span class="number">3</span>], <span class="string">''</span>] <span class="keyword">for</span> col <span class="keyword">in</span> columns]</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get_sample_data</span><span class="params">(self, database, table, column=None)</span>:</span></div><div class="line">    column = column <span class="keyword">or</span> <span class="string">'*'</span></div><div class="line">    <span class="keyword">return</span> query_and_fetch(self.db, <span class="string">'SELECT %s FROM %s.%s'</span> % (column, database, table))</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">_type_converter</span><span class="params">(self, name)</span>:</span></div><div class="line">    <span class="keyword">return</span> &#123;</div><div class="line">        <span class="string">"I"</span>: <span class="string">"INT_TYPE"</span>,</div><div class="line">        <span class="string">"I2"</span>: <span class="string">"SMALLINT_TYPE"</span>,</div><div class="line">        <span class="string">"CF"</span>: <span class="string">"STRING_TYPE"</span>,</div><div class="line">        <span class="string">"CV"</span>: <span class="string">"CHAR_TYPE"</span>,</div><div class="line">        <span class="string">"DA"</span>: <span class="string">"DATE_TYPE"</span>,</div><div class="line">      &#125;.get(name, <span class="string">'STRING_TYPE'</span>)</div></pre></td></tr></table></figure>
<p>当然直接修改这个通用接口类对于架构来说肯定是不好的，甚至是破坏性的。我测试了一下，这个类只对hue不能支持的(也就是mysql、oracle、postgresql、hive等)之外的自定义的jdbc起作用，所以并不会影响到其他数据库和引擎的使用，我们应该也没有需要其他自定义数据源了。所以，暂时这样，后面要TODO优化。</p>
<p>另外，我发现还有一个问题。presto的执行user是固定的，并不像hiveserver那样，执行时使用真正的用户名去hive提交。这样就不能保证ACL的很多特性了。这方面其实可以找到hue相关部分的源码（应该也在jdbc.py）里进行改进。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JdbcApi</span><span class="params">(Api)</span>:</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, user, interpreter=None)</span>:</span></div><div class="line">    <span class="keyword">global</span> API_CACHE</div><div class="line">    Api.__init__(self, user, interpreter=interpreter)</div><div class="line"></div><div class="line">    self.db = <span class="keyword">None</span></div><div class="line">    self.options = interpreter[<span class="string">'options'</span>]</div><div class="line"></div><div class="line">    <span class="keyword">if</span> self.cache_key <span class="keyword">in</span> API_CACHE:</div><div class="line">      self.db = API_CACHE[self.cache_key]</div><div class="line">    <span class="keyword">elif</span> <span class="string">'password'</span> <span class="keyword">in</span> self.options:</div><div class="line">      <span class="comment"># 主要在于这个地方，看代码可以发现，实际建立JDBC连接的时候</span></div><div class="line">      <span class="comment"># 会先去获取option里的user配置项，如果没有这个配置项的话，</span></div><div class="line">      <span class="comment"># 就会使用当前的用户名去创建JDBC连接了。这样也就实现了hiveserver的</span></div><div class="line">      <span class="comment"># doAs类似的功能，即以真实执行用户的身份执行最终查询</span></div><div class="line">      username = self.options.get(<span class="string">'user'</span>) <span class="keyword">or</span> user.username</div><div class="line">      <span class="comment">#username = self.user</span></div><div class="line">      print(<span class="string">'-------------------got  username --------------------------------- %s'</span> % username)</div><div class="line">      self.db = API_CACHE[self.cache_key] = Jdbc(self.options[<span class="string">'driver'</span>], self.options[<span class="string">'url'</span>], username, self.options[<span class="string">'password'</span>])</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">create_session</span><span class="params">(self, lang=None, properties=None)</span>:</span></div><div class="line">    ...</div><div class="line">    <span class="keyword">if</span> self.db <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">      <span class="keyword">if</span> <span class="string">'password'</span> <span class="keyword">in</span> properties:</div><div class="line">        user = properties.get(<span class="string">'user'</span>) <span class="keyword">or</span> self.options.get(<span class="string">'user'</span>)</div><div class="line">        props[<span class="string">'properties'</span>] = &#123;<span class="string">'user'</span>: user&#125;</div><div class="line">        self.db = API_CACHE[self.cache_key] = Jdbc(self.options[<span class="string">'driver'</span>], self.options[<span class="string">'url'</span>], user, properties.pop(<span class="string">'password'</span>))</div><div class="line">    ...</div><div class="line">    <span class="keyword">return</span> props</div></pre></td></tr></table></figure></p>
<p>从上面的代码分析可得，我们只要在option里不配置user信息，就可以了。。。（结果让我相对崩溃…..）</p>
<h4 id="升级"><a href="#升级" class="headerlink" title="升级"></a>升级</h4><p>从3.10到4.1，压根儿不知道应该怎样升级数据库里的数据。搜了很多文档都没有找到，最后到github上找到cdh/hue的源码，看到有个commit的comment是关于upgrade的，点进去发现了一篇文档：<a href="https://github.com/cloudera/hue/tree/master/dist。里面提到以下三个步骤" target="_blank" rel="external">https://github.com/cloudera/hue/tree/master/dist。里面提到以下三个步骤</a>:</p>
<ul>
<li>备份原有数据库</li>
<li>./build/env/bin/hue syncdb</li>
<li>./build/env/bin/hue migrate</li>
</ul>
<p>其实在第二个步骤的时候，就会进行数据库比对。而第三个数据库则会把所有4.1多余3.10的migrations进行执行。因为hue是基于django的，所以利用了django的migrate的特性。</p>
<p>不知道为什么一直没有搜到这个hue的文档，可能还是关键字有问题吧。</p>
<h4 id="进一步思考"><a href="#进一步思考" class="headerlink" title="进一步思考"></a>进一步思考</h4><p>其实现在presto是可用了，但是依照规范的话，我们是可以自己依照hive、mysql的数据查询类实现presto查询类的。而且难度也基本是很低的，hue这么长时间都没有presto的兼容，不知道是不是官网别有用心[impala]。</p>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><ul>
<li><a href="https://github.com/skame/docker-prestogres" target="_blank" rel="external">https://github.com/skame/docker-prestogres</a></li>
<li><a href="https://github.com/treasure-data/prestogres" target="_blank" rel="external">https://github.com/treasure-data/prestogres</a></li>
<li><a href="https://medium.com/@ilkkaturunen/integrating-presto-with-hue-61702b244839" target="_blank" rel="external">https://medium.com/@ilkkaturunen/integrating-presto-with-hue-61702b244839</a></li>
<li><a href="https://prestodb.io/docs/0.184/installation/jdbc.html" target="_blank" rel="external">https://prestodb.io/docs/0.184/installation/jdbc.html</a></li>
<li><a href="https://groups.google.com/forum/#!topic/presto-users/24MMrfLKdu0" target="_blank" rel="external">https://groups.google.com/forum/#!topic/presto-users/24MMrfLKdu0</a></li>
<li><a href="https://github.com/cloudera/hue/blob/release-4.1.0/desktop/libs/notebook/src/notebook/connectors/jdbc.py" target="_blank" rel="external">https://github.com/cloudera/hue/blob/release-4.1.0/desktop/libs/notebook/src/notebook/connectors/jdbc.py</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[presto手札]]></title>
      <url>/2017/12/19/presto%E6%89%8B%E6%9C%AD/</url>
      <content type="html"><![CDATA[<h4 id="outputFormat-should-not-be-accessed-from-a-null-StorageFormat"><a href="#outputFormat-should-not-be-accessed-from-a-null-StorageFormat" class="headerlink" title="outputFormat should not be accessed from a null StorageFormat"></a>outputFormat should not be accessed from a null StorageFormat</h4><p>对于hive的一些外部表，presto不能支持，比如基于hbase、或者ES的hive外部表。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">presto:default&gt; select table_schema, table_name, column_name, is_nullable, data_type from information_schema.columns;</div><div class="line"></div><div class="line">Query 20171219_073016_00015_4zvkw, FAILED, 2 nodes</div><div class="line">Splits: 17 total, 0 done (0.00%)</div><div class="line">0:00 [0 rows, 0B] [0 rows/s, 0B/s]</div><div class="line"></div><div class="line">Query 20171219_073016_00015_4zvkw failed: outputFormat should not be accessed from a null StorageFormat</div></pre></td></tr></table></figure>
<p>所以略过这种特殊表的才能成功：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> table_schema, table_name, column_name, is_nullable, data_type <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name <span class="keyword">not</span> <span class="keyword">in</span> (<span class="string">'hive_table_based_on_hbase'</span>);</div></pre></td></tr></table></figure></p>
<p>参考： <a href="https://github.com/prestodb/presto/issues/7721" target="_blank" rel="external">https://github.com/prestodb/presto/issues/7721</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[slider-部署presto实战]]></title>
      <url>/2017/12/15/slider-%E9%83%A8%E7%BD%B2presto%E5%AE%9E%E6%88%98/</url>
      <content type="html"><![CDATA[<p>首先，使用ambari么有成功，不是特别清楚问题出在哪里，主要是因为对slider还不太熟悉。索性自己手动搞一下slider部署presto，就能相对清楚些，学的也稍微透彻些。</p>
<h4 id="版本构建"><a href="#版本构建" class="headerlink" title="版本构建"></a>版本构建</h4><ul>
<li>slider-0.90.0-incubating(从github上下载了打包，只所以没用现成的，是因为自己打了一个小patch)。注释掉不关注的子项目，比如<code>slider-funtest</code>，注释掉。</li>
</ul>
<p>找一个跟自己hadoop版本相对应的分支进行打包，我的是2.7，所以就找的0.90.0的tag分支。(有很多人会通过指定hadoop.version的属性来指定依赖的hadoop版本，窃以为有些冒险，因为有可能有依赖，自己的版本高还好些)</p>
<ul>
<li>presto-yarn-1.2.1(这个没有现成的包，只能github上弄下来，自己打包)。这个要加上presto server的版本号，自己想用哪个版本就加哪个就成了。</li>
<li>presto 0.184要求JDK 8U92+, 我安装了8U152<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mvn clean package -Dpresto.version=0.184</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="slider相关配置"><a href="#slider相关配置" class="headerlink" title="slider相关配置"></a>slider相关配置</h4><h5 id="slider-site-xml"><a href="#slider-site-xml" class="headerlink" title="slider-site.xml"></a>slider-site.xml</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>hadoop.registry.zk.quorum<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">value</span>&gt;</span>datanode01.will.com:2181<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure>
<h5 id="slider-env-sh"><a href="#slider-env-sh" class="headerlink" title="slider-env.sh"></a>slider-env.sh</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">export JAVA_HOME=/server/java/jdk1.8.0_152/</div><div class="line">export HADOOP_CONF_DIR=/usr/hdp/current/hadoop-client/conf/</div></pre></td></tr></table></figure>
<h4 id="app相关配置"><a href="#app相关配置" class="headerlink" title="app相关配置"></a>app相关配置</h4><p>把上面构建好的slider和presto-yarn的tar包copy到指定机器上解压。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cp appConfig-default.json appConfig.json</div><div class="line">cp resources-default.json resources.json</div></pre></td></tr></table></figure>
<h5 id="配置appConfig-json"><a href="#配置appConfig-json" class="headerlink" title="配置appConfig.json"></a>配置appConfig.json</h5><p>这个文件是slider针对不同app的个性配置的文件：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"schema"</span> : <span class="string">"http://example.org/specification/v2.0.0"</span>,</div><div class="line">  <span class="attr">"metadata"</span> : &#123; &#125;,</div><div class="line">  <span class="attr">"global"</span> : &#123;</div><div class="line">    <span class="attr">"site.global.catalog"</span> : <span class="string">"&#123;'hive': ['hive.config.resources=/usr/hdp/2.4.2.0-258/hadoop/etc/hadoop/core-site.xml,/usr/hdp/2.4.2.0-258/hadoop/etc/hadoop/hdfs-site.xml', 'connector.name=hive-hadoop2', 'hive.metastore.uri=thrift://datanode03.will.com:9083'],'tpch': ['connector.name=tpch']&#125;"</span>,</div><div class="line">    <span class="attr">"java_home"</span> : <span class="string">"/server/java/jdk1.8.0_152/"</span>,</div><div class="line">    <span class="attr">"zookeeper.quorum"</span> : <span class="string">"datanode01.will.com:2181"</span>,</div><div class="line">    <span class="attr">"env.MALLOC_ARENA_MAX"</span> : <span class="string">"4"</span>,</div><div class="line">    <span class="attr">"site.global.config_dir"</span> : <span class="string">"/server/presto/etc"</span>,</div><div class="line">    <span class="attr">"application.def"</span> : <span class="string">".slider/package/presto/presto-yarn-package-1.2.1-0.184.zip"</span>,</div><div class="line">    <span class="attr">"zookeeper.hosts"</span> : <span class="string">"datanode01.will.com"</span>,</div><div class="line">    <span class="attr">"site.global.app_name"</span> : <span class="string">"presto-server-0.184"</span>,</div><div class="line">    <span class="attr">"site.global.coordinator_host"</span> : <span class="string">"$&#123;COORDINATOR_HOST&#125;"</span>,</div><div class="line">    <span class="attr">"zookeeper.path"</span> : <span class="string">"/services/slider/users/yarn/presto-will"</span>,</div><div class="line">    <span class="attr">"site.global.app_user"</span> : <span class="string">"yarn"</span>,</div><div class="line">    <span class="attr">"site.global.app_pkg_plugin"</span> : <span class="string">"$&#123;AGENT_WORK_ROOT&#125;/app/definition/package/plugins/"</span>,</div><div class="line">    <span class="attr">"site.global.user_group"</span> : <span class="string">"hadoop"</span>,</div><div class="line">    <span class="attr">"site.global.data_dir"</span> : <span class="string">"/server/presto/data"</span>,</div><div class="line">    <span class="attr">"site.global.presto_query_max_memory"</span> : <span class="string">"8GB"</span>,</div><div class="line">    <span class="attr">"site.global.jvm_args"</span> : <span class="string">"['-server', '-Xmx1024M', '-XX:+UseG1GC', '-XX:G1HeapRegionSize=32M', '-XX:+UseGCOverheadLimit', '-XX:+ExplicitGCInvokesConcurrent', '-XX:+HeapDumpOnOutOfMemoryError', '-XX:OnOutOfMemoryError=kill -9 %p']"</span>,</div><div class="line">    <span class="attr">"site.global.presto_query_max_memory_per_node"</span> : <span class="string">"512MB"</span>,</div><div class="line">    <span class="attr">"site.fs.defaultFS"</span> : <span class="string">"hdfs://dd"</span>,</div><div class="line">    <span class="attr">"site.global.presto_server_port"</span> : <span class="string">"8099"</span>,</div><div class="line">    <span class="attr">"site.global.singlenode"</span> : <span class="string">"true"</span>,</div><div class="line">    <span class="attr">"site.fs.default.name"</span> : <span class="string">"hdfs://dd"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"credentials"</span> : &#123; &#125;,</div><div class="line">  <span class="attr">"components"</span> : &#123;</div><div class="line">    <span class="attr">"slider-appmaster"</span> : &#123;</div><div class="line">      <span class="attr">"jvm.heapsize"</span> : <span class="string">"128M"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="配置resources-json"><a href="#配置resources-json" class="headerlink" title="配置resources.json"></a>配置resources.json</h5><p>这个文件主要是针对yarn资源申请的。<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"schema"</span>: <span class="string">"http://example.org/specification/v2.0.0"</span>,</div><div class="line">  <span class="attr">"metadata"</span>: &#123;</div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"global"</span>: &#123;</div><div class="line">    <span class="attr">"yarn.vcores"</span>: <span class="string">"1"</span></div><div class="line">  &#125;,</div><div class="line">  <span class="attr">"components"</span>: &#123;</div><div class="line">    <span class="attr">"slider-appmaster"</span>: &#123;</div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"COORDINATOR"</span>: &#123;</div><div class="line">      <span class="attr">"yarn.role.priority"</span>: <span class="string">"1"</span>,</div><div class="line">      <span class="attr">"yarn.component.instances"</span>: <span class="string">"1"</span>,</div><div class="line">      <span class="attr">"yarn.component.placement.policy"</span>: <span class="string">"1"</span>,</div><div class="line">      <span class="attr">"yarn.memory"</span>: <span class="string">"1500"</span></div><div class="line">    &#125;,</div><div class="line">    <span class="attr">"WORKER"</span>: &#123;</div><div class="line">      <span class="attr">"yarn.role.priority"</span>: <span class="string">"2"</span>,</div><div class="line">      <span class="attr">"yarn.component.instances"</span>: <span class="string">"3"</span>,</div><div class="line">      <span class="attr">"yarn.component.placement.policy"</span>: <span class="string">"1"</span>,</div><div class="line">      <span class="attr">"yarn.memory"</span>: <span class="string">"1500"</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>默认的resource申请中其实是可以为WORKER或者COORDINATOR指定yarn label的节点的，因为我们的集群暂时没有启用这个，测试阶段先不用这特性了。</p>
<p>参考：<a href="https://prestodb.io/presto-yarn/installation-yarn-configuration-options.html" target="_blank" rel="external">https://prestodb.io/presto-yarn/installation-yarn-configuration-options.html</a></p>
<h4 id="文件夹准备"><a href="#文件夹准备" class="headerlink" title="文件夹准备"></a>文件夹准备</h4><ol>
<li><p>HDFS中要为运行slider应用，也就是presto的用户创建家目录：/user/yarn，而且拥有此目录所有权限。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hdfs dfs -mkdr /user/yarn &amp;&amp; hdfs dfs -chwon -R yarn /user/yarn</div></pre></td></tr></table></figure>
</li>
<li><p>所有可能运行presto节点的机器都要有appConfig.json中配置的presto数据目录，而且拥有此目录所有权限。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkdir -p /server/presto/data &amp;&amp; chown -R yarn /server/presto/data</div></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="创建package"><a href="#创建package" class="headerlink" title="创建package"></a>创建package</h4><p>到slider目录下，使用yarn用户创建presto的package<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./bin/slider package --install --name presto --package ../presto-yarn-package-1.2.1-0.184.zip</div></pre></td></tr></table></figure></p>
<p>到HDFS中看一下文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@schedule metamap_django]#hdfs dfs -ls /user/yarn/.slider/package/presto</div><div class="line">Found 1 items</div><div class="line">-rw-r--r--   3 yarn hdfs  449926122 2017-12-14 11:04 /user/yarn/.slider/package/presto/presto-yarn-package-1.2.1-0.184.zip</div></pre></td></tr></table></figure></p>
<h4 id="创建app集群"><a href="#创建app集群" class="headerlink" title="创建app集群"></a>创建app集群</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./bin/slider create presto-will --template appConfig.json --resources resources.json</div></pre></td></tr></table></figure>
<p>这个命令会创建presto-will的集群，并启动之。</p>
<p>可以看到HDFS目录里多了一些内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@schedule metamap_django]#hdfs dfs -ls /user/yarn/.slider/cluster/presto-will</div><div class="line">Found 9 items</div><div class="line">-rw-r--r--   3 root hdfs       1740 2017-12-15 15:16 /user/yarn/.slider/cluster/presto-will/app_config.json</div><div class="line">drwxrwxrwx   - yarn hdfs          0 2017-12-15 15:16 /user/yarn/.slider/cluster/presto-will/confdir</div><div class="line">drwxr-x---   - yarn hdfs          0 2017-12-15 15:16 /user/yarn/.slider/cluster/presto-will/database</div><div class="line">drwxr-x---   - yarn hdfs          0 2017-12-15 14:43 /user/yarn/.slider/cluster/presto-will/generated</div><div class="line">drwxr-x---   - yarn hdfs          0 2017-12-15 15:17 /user/yarn/.slider/cluster/presto-will/history</div><div class="line">-rw-r--r--   3 yarn hdfs       1436 2017-12-15 14:43 /user/yarn/.slider/cluster/presto-will/internal.json</div><div class="line">-rw-r--r--   3 yarn hdfs        651 2017-12-15 14:43 /user/yarn/.slider/cluster/presto-will/resources.json</div><div class="line">drwxr-x---   - yarn hdfs          0 2017-12-15 14:43 /user/yarn/.slider/cluster/presto-will/snapshot</div><div class="line">drwxr-xr-x   - yarn hdfs          0 2017-12-15 15:16 /user/yarn/.slider/cluster/presto-will/tmp</div></pre></td></tr></table></figure></p>
<p>然后到yarn上观察就可以了，名字为<code>presto-will</code>的application，点击开，观察所有的component的<code>Desired</code>和<code>Actual</code>一致了，就代表启动完成了。下面还会有各个组件所在的nodemanager及其container的细腻些，可以由此定位到log位置与coodinator的web界面位置等。</p>
<h4 id="Hive配置与验证"><a href="#Hive配置与验证" class="headerlink" title="Hive配置与验证"></a>Hive配置与验证</h4><p>配置主要包括两方面：</p>
<h5 id="connector的配置"><a href="#connector的配置" class="headerlink" title="connector的配置"></a>connector的配置</h5><p>主要是指定hive的thrift位置，以查询hive元数据。具体参考上面的配置文件。</p>
<h5 id="hive的HDFS的配置"><a href="#hive的HDFS的配置" class="headerlink" title="hive的HDFS的配置"></a>hive的HDFS的配置</h5><p>这个主要是为了解决presto使用hive connector的时候对于HDFS HA的识别，需要在hive connector的配置文件中添加<code>hive.config.resources=/etc/hadoop/conf/core-site.xml,/etc/hadoop/conf/hdfs-site.xml</code>属性。对于yarn-presto，就加在appConfig.json中的hive connector(<code>site.global.catalog</code>)中了。</p>
<h5 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h5><p>主要就是验证一下Hive Connector的正确性吧。下载一个presto的客户端<a href="https://repo1.maven.org/maven2/com/facebook/presto/presto-cli/0.184/presto-cli-0.184-executable.jar" target="_blank" rel="external">presto-cli-0.184-executable.jar</a>，重命名为presto，然后给个可执行权限。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[root@datanode21 presto]# ./presto --server datanode29.will.com:8099 --catalog hive --schema default</div><div class="line">presto:default&gt; show tables;</div><div class="line">Query 20171215_071741_00000_pxck3 failed: Presto server is still initializing</div><div class="line"></div><div class="line">presto:default&gt; show tables;</div><div class="line">                                         Table                                         </div><div class="line">---------------------------------------------------------------------------------------</div><div class="line"> ast_loan_asset                                                                        </div><div class="line"> batting                                                                               </div><div class="line"> batting2                                                                              </div><div class="line"> customers                                                                             </div><div class="line"> h5_test                                                                               </div><div class="line"> kylin_intermediate_app_active_cube_4aef52f1_11ae_4dce_b548_f5d3a249331c   </div><div class="line"> ...</div><div class="line"> ...</div><div class="line"> presto:default&gt; select * from web_logs limit 100;</div><div class="line">      _version_      |    app     | bytes |     city      |   client_ip   | code | country_code | country_code3 | country_name  | device_family | extension |</div><div class="line">---------------------+------------+-------+---------------+---------------+------+--------------+---------------+---------------+---------------+-----------+</div><div class="line"> 1480895575619534853 | sqoop      |   460 | Hyderabad     | 49.206.186.56 | NULL | IN           | IND           | India         | Other         |           |</div><div class="line"> 1480895575619534854 | jobbrowser |   269 | Bangkok       | 61.90.20.30   | NULL | TH           | THA           | Thailand      | Other         |           |</div><div class="line"> .....</div><div class="line"> .....</div></pre></td></tr></table></figure>
<p>也可以在coordinator的web界面看到相关的查询信息。</p>
<p>参考：<a href="https://prestodb.io/docs/current/installation/cli.html" target="_blank" rel="external">https://prestodb.io/docs/current/installation/cli.html</a></p>
<h5 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h5><ul>
<li><a href="https://prestodb.io/presto-yarn/installation-yarn-configuration-options.html" target="_blank" rel="external">https://prestodb.io/presto-yarn/installation-yarn-configuration-options.html</a></li>
<li><a href="https://prestodb.io/docs/current/installation/cli.html" target="_blank" rel="external">https://prestodb.io/docs/current/installation/cli.html</a></li>
</ul>
<h4 id="TODO"><a href="#TODO" class="headerlink" title="TODO"></a>TODO</h4><ul>
<li><a href="https://prestodb.io/docs/current/installation/benchmark-driver.html" target="_blank" rel="external">benchmark dirver</a>测试一下性能</li>
<li>开启node label，让presto集群跑在计算能力比较强的node上</li>
<li>探测合理的配置信息(主要是内存方面)</li>
</ul>
<h4 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h4><h5 id="slider不能识别HA的HDFS"><a href="#slider不能识别HA的HDFS" class="headerlink" title="slider不能识别HA的HDFS"></a>slider不能识别HA的HDFS</h5><p>在<code>slider-site.xml</code>中不配置的dfs.defaultFS的时候slider会自己去判断HDFS全路径，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Path <span class="title">getHomeDirectory</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> fileSystem.getHomeDirectory();</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>然后生成的启动SliderAppMaster的launcher脚本中就会成为：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$JAVA_HOME/bin/java </div><div class="line"> -Djava.net.preferIPv4Stack=true </div><div class="line"> -Djava.awt.headless=true -Xmx128M -ea -esa </div><div class="line"> -Dlog4j.configuration=log4j-server.properties </div><div class="line"> -DLOG_DIR=/yk_data/hadoop/yarn/local/application_1511064572746_35970/container_e51_1511064572746_35970_01_000001 org.apache.slider.server.appmaster.SliderAppMaster create presto-will -cluster-uri hdfs://namenode01.will.com:8020/user/yarn/.slider/cluster/presto-will --rm datanode02.will.com:8030 </div><div class="line"> -D hadoop.registry.zk.root=/registry </div><div class="line"> -D hadoop.registry.zk.quorum=datanode01.will.com:2181 1&gt;/yk_data/hadoop/yarn/local/application_1511064572746_35970/container_e51_1511064572746_35970_01_000001/slider-out.txt 2&gt;/yk_data/hadoop/yarn/local/application_1511064572746_35970/container_e51_1511064572746_35970_01_000001/slider-err.txt</div></pre></td></tr></table></figure></p>
<p>然后SliderAppMaster验证HDFS文件的时候就会报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Wrong FS: hdfs://namenode01.will.com:8020/user/yarn, expected: hfds://dd/</div></pre></td></tr></table></figure></p>
<p>我们的集群配置了HA，集群namespace是dd。</p>
<p>考虑了一下，源头在于slider获取路径不准确，就直接修改了源码，也就是上面提到的patch：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Path <span class="title">getHomeDirectory</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Path(<span class="string">"hdfs://dd/user/"</span>+System.getProperty(<span class="string">"user.name"</span>));</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其实可以把dd弄成一个slider-client.xml的配置项，暂时图测试方便。</p>
<p>重新build，覆盖既有slider就可以了。</p>
<h5 id="找不到满足条件的node"><a href="#找不到满足条件的node" class="headerlink" title="找不到满足条件的node"></a>找不到满足条件的node</h5><p>主要是最开始的时候resources.json中带有coordinator和worker的yarn.label.expression选项，而我们的yarn集群没有开启node label功能，当然node就都不满足条件了。</p>
<p>去掉这个配置，或者开启node label功能，并指定一些计算型节点的node为特定label就可以了。</p>
<h5 id="hive配置appConfig-json不生效"><a href="#hive配置appConfig-json不生效" class="headerlink" title="hive配置appConfig.json不生效"></a>hive配置appConfig.json不生效</h5><p>就是在create prest-will cluster的时候不能生效，每次集群正常启动之后，使用<code>./bin/slider status presto-will</code>都发现相关配置<code>site.global.catalog</code>没有更新，但是其他的配置项又是跟本地的appConfig.json是一致的。</p>
<p>解决方案：通过直接<code>hdfs dfs -get /user/yarn/.slider/cluster/presto-will/app_config.json .</code>，编辑之后再上传，最后重启slider的presto-will app搞定。</p>
<p>具体为什么有待研究。</p>
<h5 id="hive找不到connector-Factory"><a href="#hive找不到connector-Factory" class="headerlink" title="hive找不到connector Factory"></a>hive找不到connector Factory</h5><p>开始以为<code>connector.name</code>是可以自己命名的，自己改成<code>hive-will</code>了。官方给的例子是<code>hive-hadoop2</code>，presto-yarn中给的是<code>hive-cdh5</code>,应该也有hdp版本的。虽然我使用的是ambari的hive，属于hdp的，但应该无大碍暂时使用官网的（没有搜到hdp版本的connecor.name对应名字）。</p>
<h4 id="同node多presto-worker实例"><a href="#同node多presto-worker实例" class="headerlink" title="同node多presto worker实例"></a>同node多presto worker实例</h4><p>发现yarn上会出现一个问题，就是当flex的worker数比较多的时候，会出现同一个node上出现多个worker的情况，这时候就会出现失败。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">http:// http://datanode02.will.com:8088/proxy/application_1511064572746_40916/</div><div class="line">classpath:org.apache.slider.client.rest http://datanode02.will.com:8088/proxy/application_1511064572746_40916/</div><div class="line">classpath:org.apache.slider.management http://datanode02.will.com:8088/proxy/application_1511064572746_40916/ws/v1/slider/mgmt</div><div class="line">classpath:org.apache.slider.publisher http://datanode02.will.com:8088/proxy/application_1511064572746_40916/ws/v1/slider/publisher</div><div class="line">classpath:org.apache.slider.registry http://datanode02.will.com:8088/proxy/application_1511064572746_40916/ws/v1/slider/registry</div><div class="line">classpath:org.apache.slider.publisher.configurations http://datanode02.will.com:8088/proxy/application_1511064572746_40916/ws/v1/slider/publisher/slider</div><div class="line">classpath:org.apache.slider.publisher.exports http://datanode02.will.com:8088/proxy/application_1511064572746_40916/ws/v1/slider/publisher/exports</div><div class="line">COORDINATOR Host(s)/Container(s): [datanode16.will.com/container_e51_1511064572746_40916_01_000009]</div><div class="line">slider-appmaster Host(s)/Container(s): [datanode23.will.com/container_e51_1511064572746_40916_01_000001]</div><div class="line">WORKER Host(s)/Container(s): [datanode21.will.com/container_e51_1511064572746_40916_01_000008, datanode13.will.com/container_e51_1511064572746_40916_01_000007, datanode32.will.com/container_e51_1511064572746_40916_01_000010, datanode11.will.com/container_e51_1511064572746_40916_01_000002, datanode29.will.com/container_e51_1511064572746_40916_01_000004, datanode11.will.com/container_e51_1511064572746_40916_01_000003, datanode12.will.com/container_e51_1511064572746_40916_01_000006, datanode20.will.com/container_e51_1511064572746_40916_01_000005]</div></pre></td></tr></table></figure></p>
<p>这里就是datanode11出现重复了，一会儿就变成了别的，因为重试的原因。直到不再重复位置，如果yarn资源池有些问题，比如只有2个node有足够的资源，但是我们需要8个worker，这2个node的总资源又大于8个worker申请的资源，就可能出现这种情况。</p>
<p>首先想到的是slider应该支持有单个node上只能部署app的一种component的一个实例。</p>
<h5 id="failed-Failed-to-list-directory-hdfs-xxxx-premium-record-log-day-20171212"><a href="#failed-Failed-to-list-directory-hdfs-xxxx-premium-record-log-day-20171212" class="headerlink" title="failed: Failed to list directory: hdfs://xxxx/premium_record/log_day=20171212"></a>failed: Failed to list directory: hdfs://xxxx/premium_record/log_day=20171212</h5><p>hive里可以查询，但是presto查询单表报错。一般是因为presto server不能找到这个目录，或者没有读取这个目录的权限导致。到HDFS上确认了目录确实存在，因为hive里确实能查的到，所以应该是第二个问题。</p>
<p>从上面步骤中也可以知道我们是使用yarn用户启动的presto集群，找到这个目录，使用HDFS dfs命令，让yarn用户能够访问这个目录就可以了。</p>
<h5 id="query-max-memory-per-node-set-to-but-only-of-useable-heap-available"><a href="#query-max-memory-per-node-set-to-but-only-of-useable-heap-available" class="headerlink" title="query.max-memory-per-node set to but only of useable heap available"></a>query.max-memory-per-node set to but only of useable heap available</h5><p>一般是jvm的内存参数太小，而worker的max-memory-per-node又比较大的原因。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[presto之hive-connector]]></title>
      <url>/2017/12/15/presto%E4%B9%8Bhive-connector/</url>
      <content type="html"><![CDATA[<h4 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h4><p>hive是由三个部分组成的</p>
<ul>
<li>特定格式的HDFS文件</li>
<li>metadata数据库，通常是mysql</li>
<li>HQL及其执行引擎</li>
</ul>
<p>presto会用到前面两者。</p>
<h4 id="支持的文件类型"><a href="#支持的文件类型" class="headerlink" title="支持的文件类型"></a>支持的文件类型</h4><p>ORC、Parquet、Avro、RCFile、SequenceFile、JSON、Text</p>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>创建<code>etc/catalog/hive.properties</code>文件，挂载<code>hive-hadoop2</code> connector作为<code>hive</code> catalog，替换掉你的hive metastore的thrift host和port：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">connector.name=hive-hadoop2</div><div class="line">hive.metastore.uri=thrift://example.net:9083</div></pre></td></tr></table></figure>
<h4 id="多个hive集群"><a href="#多个hive集群" class="headerlink" title="多个hive集群"></a>多个hive集群</h4><p>随便你使用多少catalog，添加其他的hive 集群就是了，新增properties文件到<code>etc/catalog</code>就可以了。</p>
<h4 id="HDFS配置"><a href="#HDFS配置" class="headerlink" title="HDFS配置"></a>HDFS配置</h4><p>对于基本设置，presto自动配置了HDFS client，不需要额外的配置文件。但是对于hdfs联邦和NN HA的情况，需要额外指定一下参数才能正常访问HDFS cluster。这个要添加<code>hive.config.resources</code>引用到你的hdfs配置文件中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hive.config.resources=/etc/hadoop/conf/core-site.xml,/etc/hadoop/conf/hdfs-site.xml</div></pre></td></tr></table></figure></p>
<p>官方建议尽量少添加配置项，多余的配置项可能更容易引起问题。</p>
<p>还有就是这些配置文件必须在每个presto节点上都是有效存在的。</p>
<h4 id="HDFS用户"><a href="#HDFS用户" class="headerlink" title="HDFS用户"></a>HDFS用户</h4><p>在没有整合Kerberos的HDFS中，presto会使用presto进程的运行用户访问HDFS。我们可以通过配置presto的JVM参数指定访问HDFS的用户。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">-DHADOOP_USER_NAME=hdfs_user</div></pre></td></tr></table></figure></p>
<h4 id="访问带有kerberos认证的HDFS"><a href="#访问带有kerberos认证的HDFS" class="headerlink" title="访问带有kerberos认证的HDFS"></a>访问带有kerberos认证的HDFS</h4><p>kerberos认证对于HDFS和hive metastore是都支持的。但是，通过ticket cache进行认证的还没有支持。</p>
<h4 id="hive配置项"><a href="#hive配置项" class="headerlink" title="hive配置项"></a>hive配置项</h4><table>
<thead>
<tr>
<th>Property</th>
<th>Name</th>
<th>Description    Default</th>
</tr>
</thead>
<tbody>
<tr>
<td>hive.metastore.uri</td>
<td>Hive metastore 的thrift URI. 如果多个的话，默认使用第一个，后面的作为备用，逗号隔开。Example: thrift://192.0.2.3:9083 or thrift://192.0.2.3:9083,thrift://192.0.2.4:9083</td>
<td></td>
</tr>
<tr>
<td>hive.config.resources</td>
<td>逗号分隔的HDFS配置文件, 每个presto server所在的节点都要有效存在.  Example: /etc/hdfs-site.xml</td>
<td></td>
</tr>
<tr>
<td>hive.storage-format</td>
<td>创建新表的默认文件格式</td>
<td>RCBINARY</td>
</tr>
<tr>
<td>hive.compression-codec</td>
<td>写文件的压缩格式</td>
<td>GZIP</td>
</tr>
<tr>
<td>hive.force-local-scheduling</td>
<td>Force splits to be scheduled on the same node as the Hadoop DataNode process serving the split data. This is useful for installations where Presto is collocated with every DataNode.</td>
<td>false</td>
</tr>
<tr>
<td>hive.respect-table-format</td>
<td>Should new partitions be written using the existing table format or the default Presto format?</td>
<td>true</td>
</tr>
<tr>
<td>hive.immutable-partitions</td>
<td>新数据能不能insert到已经存在的partitions?</td>
<td>false</td>
</tr>
<tr>
<td>hive.max-partitions-per-writers</td>
<td>每个writer的最大partition数.</td>
<td>100</td>
</tr>
<tr>
<td>hive.max-partitions-per-scan</td>
<td>单个table scan可扫描的最大partition数</td>
<td>100,000</td>
</tr>
<tr>
<td>hive.metastore.authentication.type</td>
<td>Hive metastore认证类型,可是是 NONE 或者 KERBEROS.</td>
<td>NONE</td>
</tr>
<tr>
<td>hive.metastore.service.principal</td>
<td>The Kerberos principal of the Hive metastore service.</td>
<td></td>
</tr>
<tr>
<td>hive.metastore.client.principal</td>
<td>The Kerberos principal that Presto will use when connecting to the Hive metastore service.</td>
<td></td>
</tr>
<tr>
<td>hive.metastore.client.keytab</td>
<td>Hive metastore client keytab 位置.</td>
<td></td>
</tr>
<tr>
<td>hive.hdfs.authentication.type</td>
<td>HDFS 认证类型，可以是 NONE 或者 KERBEROS.</td>
<td>NONE</td>
</tr>
<tr>
<td>hive.hdfs.impersonation.enabled</td>
<td>启用 HDFS终端user可以假装.</td>
<td>false</td>
</tr>
<tr>
<td>hive.hdfs.presto.principal</td>
<td>The Kerberos principal that Presto will use when connecting to HDFS.</td>
<td></td>
</tr>
<tr>
<td>hive.hdfs.presto.keytab</td>
<td>HDFS client keytab 位置.</td>
<td></td>
</tr>
<tr>
<td>hive.security</td>
<td>参考Hive Security Configuration.</td>
<td></td>
</tr>
<tr>
<td>security.config-file</td>
<td>Path of config file to use when hive.security=file. See File Based Authorization for details.</td>
<td></td>
</tr>
<tr>
<td>hive.non-managed-table-writes-enabled</td>
<td>Enable writes to non-managed (external) Hive tables.</td>
<td>false</td>
</tr>
</tbody>
</table>
<h4 id="schema演化"><a href="#schema演化" class="headerlink" title="schema演化"></a>schema演化</h4><p>hive允许同一个table的不同partition的数据有不同的schema。有的时候字段类型也有变化，Hive connector 也支持。</p>
<ul>
<li>tinyint, smallint, integer，bigint与varchar 之间的相互转化</li>
<li>real转为double</li>
<li>int类型的扩展转换，比如tinyint、smallint。</li>
</ul>
<p>和hive一样，转化失败就会返回null，比如把’foo’转为int</p>
<h4 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h4><p>hive connector支持查询与操作hive表和库。然而一些特殊的操作还是需要通过hive执行。</p>
<p>下面创建一个指定位置的hive库：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">SCHEMA</span> hive.web</div><div class="line"><span class="keyword">WITH</span> (location = <span class="string">'s3://my-bucket/'</span>)</div></pre></td></tr></table></figure></p>
<p>创建一个ORC格式存储的page_views 表，使用date和conuntry进行分区，根据user进行分桶，共计50个桶(注意分区字段必须是最后的字段)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> hive.web.page_views (</div><div class="line">  view_time <span class="keyword">timestamp</span>,</div><div class="line">  user_id <span class="built_in">bigint</span>,</div><div class="line">  page_url <span class="built_in">varchar</span>,</div><div class="line">  ds <span class="built_in">date</span>,</div><div class="line">  country <span class="built_in">varchar</span></div><div class="line">)</div><div class="line"><span class="keyword">WITH</span> (</div><div class="line">  <span class="keyword">format</span> = <span class="string">'ORC'</span>,</div><div class="line">  partitioned_by = <span class="built_in">ARRAY</span>[<span class="string">'ds'</span>, <span class="string">'country'</span>],</div><div class="line">  bucketed_by = <span class="built_in">ARRAY</span>[<span class="string">'user_id'</span>],</div><div class="line">  bucket_count = <span class="number">50</span></div><div class="line">)</div></pre></td></tr></table></figure>
<p>删除分区<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">DELETE</span> <span class="keyword">FROM</span> hive.web.page_views</div><div class="line"><span class="keyword">WHERE</span> ds = <span class="built_in">DATE</span> <span class="string">'2016-08-09'</span></div><div class="line">  <span class="keyword">AND</span> country = <span class="string">'US'</span></div></pre></td></tr></table></figure></p>
<p>查询：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">FROM</span> hive.web.page_views</div></pre></td></tr></table></figure></p>
<p>创建外部表：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> hive.web.request_logs (</div><div class="line">  request_time <span class="keyword">timestamp</span>,</div><div class="line">  <span class="keyword">url</span> <span class="built_in">varchar</span>,</div><div class="line">  ip <span class="built_in">varchar</span>,</div><div class="line">  user_agent <span class="built_in">varchar</span></div><div class="line">)</div><div class="line"><span class="keyword">WITH</span> (</div><div class="line">  <span class="keyword">format</span> = <span class="string">'TEXTFILE'</span>,</div><div class="line">  external_location = <span class="string">'s3://my-bucket/data/logs/'</span></div><div class="line">)</div></pre></td></tr></table></figure></p>
<p>删除外部表，只会删除metadata，不会删除真实数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">DROP TABLE hive.web.request_logs</div></pre></td></tr></table></figure>
<h4 id="不足"><a href="#不足" class="headerlink" title="不足"></a>不足</h4><p>delete只支持where语句能满足整个分区的情况，也就是说只能一个分区为单位进行delete。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[yarn的节点label]]></title>
      <url>/2017/12/15/yarn%E7%9A%84%E8%8A%82%E7%82%B9label/</url>
      <content type="html"><![CDATA[<h4 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h4><p>nodel label是用来把一些共同特征的节点进行归组的手段，然后任务可以指定label要求，运行到指定label的节点上。</p>
<p>现在只支持node partition：</p>
<p>一个node只有一个node partition，所以一个集群被分为多个子集，这些子集互不相交。默认情况下，node是属于DEFAULT partition的。用户可以配置每个partition对于queue中可用多少资源。具体需要看下一节。</p>
<p>有两种不同的node partition：</p>
<ul>
<li>exclusive： container会分配在node label完全匹配的node上。(例如指定了partition=”x”，那么就被分配到partition=“x”的node上，默认的就分配到默认的node上)</li>
<li>non-exclusive: 如果一个partition是non-exclusive的，它就可以把空闲资源分配给请求DEFAULT partition的。</li>
</ul>
<p>用户可以为每个queue指定可以访问的多个node label，app只能使用这个queue能使用的node label的node。</p>
<h4 id="Features"><a href="#Features" class="headerlink" title="Features"></a>Features</h4><ul>
<li>Partition cluster - 每个node都可以有一个label，这样cluster就会被划分为包含多个不相交的子集partition.</li>
<li>ACL of node-labels on queues - 用户可以指定每个queue可以访问的label的node。</li>
<li>指定一个queue可以访问某个label的比例 - 例如queue A可以使用label=hbase的30%的node resource。</li>
<li>在resource request中指定nodel label的要求, 那么就只会分配这个label属性的节点资源。如果什么都没有指定的话，就默认为DEFAULT partition。</li>
<li>运维相关<ul>
<li>nodel label和node label的映射关系可以通过RM restart进行恢复</li>
<li>更新node label - admin可在RM运行态更新node和queue的label</li>
</ul>
</li>
</ul>
<h4 id="Configuration"><a href="#Configuration" class="headerlink" title="Configuration"></a>Configuration</h4><h5 id="设置ResourceManager启用Node-Labels"><a href="#设置ResourceManager启用Node-Labels" class="headerlink" title="设置ResourceManager启用Node Labels:"></a>设置ResourceManager启用Node Labels:</h5><p>yarn-site.xml</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>yarn.node-labels.fs-store.root-dir</td>
<td>hdfs://namenode:port/path/to/store/node-labels/</td>
</tr>
<tr>
<td>yarn.node-labels.enabled</td>
<td>true</td>
</tr>
</tbody>
</table>
<p>注意:</p>
<p>确保<code>yarn.node-labels.fs-store.root-dir</code>已经存在，而且RM有权限访问(一般是yarn用户访问)</p>
<p>如果用户想把node label存储在RM的本地文件系统，就是用<code>file:///home/yarn/node-label</code></p>
<h6 id="添加-修改-node-labels-list和node-to-labels-mapping-to-YARN"><a href="#添加-修改-node-labels-list和node-to-labels-mapping-to-YARN" class="headerlink" title="添加/修改 node labels list和node-to-labels mapping to YARN"></a>添加/修改 node labels list和node-to-labels mapping to YARN</h6><p>这是两个连续的步骤。</p>
<ul>
<li><p>添加Node labels池到cluster中，后面给node添加的label只能是这里面的label，并不是给集群所有节点默认label，这个要注意一下:</p>
<ul>
<li>执行<code>yarn rmadmin -addToClusterNodeLabels &quot;label_1(exclusive=true/false),label_2(exclusive=true/false)</code> 添加 node label.</li>
<li>如果用户没有指定 “(exclusive=…)”, execlusive默认为true.</li>
<li>运行<code>yarn cluster --list-node-labels</code>，检查新加的node label是否已生效</li>
</ul>
</li>
<li><p>给node添加label</p>
<ul>
<li>执行<code>yarn rmadmin -replaceLabelsOnNode “node1[:port]=label1 node2=label2”</code>. 给node1添加label1,给node2添加label2. 如果用户没有指定port, 就给这个node上运行的所有的NodeManagers都添加.</li>
</ul>
</li>
</ul>
<h5 id="给node-labels配置Schedulers"><a href="#给node-labels配置Schedulers" class="headerlink" title="给node labels配置Schedulers"></a>给node labels配置Schedulers</h5><h6 id="Capacity-Scheduler-配置"><a href="#Capacity-Scheduler-配置" class="headerlink" title="Capacity Scheduler 配置"></a>Capacity Scheduler 配置</h6><table>
<thead>
<tr>
<th>Property</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>yarn.scheduler.capacity.<queue-path>.capacity</queue-path></td>
<td>Set the percentage of the queue can access to nodes belong to DEFAULT partition. The sum of DEFAULT capacities for direct children under each parent, must be equal to 100.</td>
</tr>
<tr>
<td>yarn.scheduler.capacity.<queue-path>.accessible-node-labels</queue-path></td>
<td>Admin need specify labels can be accessible by each queue, split by comma, like “hbase,storm” means queue can access label hbase and storm. All queues can access to nodes without label, user don’t have to specify that. If user don’t specify this field, it will inherit from its parent. If user want to explicitly specify a queue can only access nodes without labels, just put a space as the value.</td>
</tr>
<tr>
<td>yarn.scheduler.capacity.<queue-path>.accessible-node-labels.<label>.capacity</label></queue-path></td>
<td>Set the percentage of the queue can access to nodes belong to <label> partition . The sum of <label> capacities for direct children under each parent, must be equal to 100. By default, it’s 0.</label></label></td>
</tr>
<tr>
<td>yarn.scheduler.capacity.<queue-path>.accessible-node-labels.<label>.maximum-capacity</label></queue-path></td>
<td>Similar to yarn.scheduler.capacity.<queue-path>.maximum-capacity, it is for maximum-capacity for labels of each queue. By default, it’s 100.</queue-path></td>
</tr>
<tr>
<td>yarn.scheduler.capacity.<queue-path>.default-node-label-expression</queue-path></td>
<td>Value like “hbase”, which means: if applications submitted to the queue without specifying node label in their resource requests, it will use “hbase” as default-node-label-expression. By default, this is empty, so application will get containers from nodes without label.</td>
</tr>
</tbody>
</table>
<p>node label配置示例:</p>
<p>假设我们的queue是这样的</p>
<pre><code>           root
       /     |    \
engineer    sales  marketing
</code></pre><p>We have 5 nodes (hostname=h1..h5) in the cluster, each of them has 24G memory, 24 vcores. 1 among the 5 nodes has GPU (assume it’s h5). So admin added GPU label to h5.</p>
<p>我们集群中有5个node，每个node有24G内存，24个vcore。其中一个node h5有GPU，那么admin想给很h5添加一个GPU的label。</p>
<p>用户就可以这样配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">yarn.scheduler.capacity.root.queues=engineering,marketing,sales</div><div class="line">yarn.scheduler.capacity.root.engineering.capacity=33</div><div class="line">yarn.scheduler.capacity.root.marketing.capacity=34</div><div class="line">yarn.scheduler.capacity.root.sales.capacity=33</div><div class="line"></div><div class="line">yarn.scheduler.capacity.root.engineering.accessible-node-labels=GPU</div><div class="line">yarn.scheduler.capacity.root.marketing.accessible-node-labels=GPU</div><div class="line"></div><div class="line">yarn.scheduler.capacity.root.engineering.accessible-node-labels.GPU.capacity=50</div><div class="line">yarn.scheduler.capacity.root.marketing.accessible-node-labels.GPU.capacity=50</div><div class="line"></div><div class="line">yarn.scheduler.capacity.root.engineering.default-node-label-expression=GPU</div></pre></td></tr></table></figure></p>
<p>我们设置了<code>root.engineering/marketing/sales.capacity=33</code>, 这样每个队列都保证有33%的资源,也就是 24 <em> 4 </em> (1/3) = (32G mem, 32 v-cores).</p>
<p>只有engineering/marketing queue 有权限使用GPU partition (因为 root.<queue-name>.accessible-node-labels).</queue-name></p>
<p>engineering/marketing queue 都可以使用partition=GPU的 1/2资源，也就是h5的1/2的资源，也就是24 * 0.5 = (12G mem, 12 v-cores).</p>
<p>注意:</p>
<p>配置完后，要执行<code>yarn rmadmin -refreshQueues</code>来使配置生效, 然后去RM的web UI检查一下。</p>
<h4 id="为APP指定node-label"><a href="#为APP指定node-label" class="headerlink" title="为APP指定node label"></a>为APP指定node label</h4><p>可以通过java API指定node label的要求。</p>
<ul>
<li>ApplicationSubmissionContext.setNodeLabelExpression(..) 设置node label表达式</li>
<li>ResourceRequest.setNodeLabelExpression(..) 设置单独resource request的node label表达式, 这个可以overwrite ApplicationSubmissionContext的表达式设置</li>
<li>在ApplicationSubmissionContext中的setAMContainerResourceRequest.setNodeLabelExpressio用来定位app master container要求的node label</li>
</ul>
<h4 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h4><h5 id="通过UI监控"><a href="#通过UI监控" class="headerlink" title="通过UI监控"></a>通过UI监控</h5><p>web UI提供的指标:</p>
<p>Nodes page: <a href="http://RM-Address:port/cluster/nodes" target="_blank" rel="external">http://RM-Address:port/cluster/nodes</a><br>Node labels page: <a href="http://RM-Address:port/cluster/nodelabels,可以获取到类型" target="_blank" rel="external">http://RM-Address:port/cluster/nodelabels,可以获取到类型</a> (exclusive/non-exclusive), active node managers的数量, 每个partition的总资源<br>Scheduler page: <a href="http://RM-Address:port/cluster/scheduler" target="_blank" rel="external">http://RM-Address:port/cluster/scheduler</a>, 每个queue关于label的配置</p>
<h5 id="通过命令行监控"><a href="#通过命令行监控" class="headerlink" title="通过命令行监控"></a>通过命令行监控</h5><ul>
<li>yarn cluster –list-node-labels</li>
<li>yarn node -status <nodeid> </nodeid></li>
</ul>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p>YARN Capacity Scheduler, if you need more understanding about how to configure Capacity Scheduler<br>Write YARN application using node labels, you can see following two links as examples: YARN distributed shell, Hadoop MapReduce</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hive-on-spark配置]]></title>
      <url>/2017/12/12/hive-on-spark%E9%85%8D%E7%BD%AE/</url>
      <content type="html"><![CDATA[<h4 id="安装spark"><a href="#安装spark" class="headerlink" title="安装spark"></a>安装spark</h4><p>hive on spark默认也是支持spark on yarn的模式的。</p>
<h4 id="配置YARN"><a href="#配置YARN" class="headerlink" title="配置YARN"></a>配置YARN</h4><p>不能使用capacity scheduler，必须使用fair scheduler【….看到这里就想放弃了】</p>
<p>yarn.resourcemanager.scheduler.class=org.apache.hadoop.yarn.server.resourcemanager.scheduler.fair.FairScheduler</p>
<h4 id="配置Hive"><a href="#配置Hive" class="headerlink" title="配置Hive"></a>配置Hive</h4><h5 id="添加spark依赖："><a href="#添加spark依赖：" class="headerlink" title="添加spark依赖："></a>添加spark依赖：</h5><ul>
<li>hive2.2.0之前，把spark-assembly jar链接到HIVE_HOME/lib中</li>
<li>2.2.0之后，hive on spark需要运行在spark 2.0.0以上的版本，没有assembly jar包 <ul>
<li>要运行YARN模式的话，添加下面的包到HIVE_HOME/lib<ul>
<li>scala-library</li>
<li>spark-core</li>
<li>spark-network-common</li>
</ul>
</li>
<li>运行local模式的话，添加下面包的链接到hive_home/lib中<ul>
<li>chill-java  chill  jackson-module-paranamer  jackson-module-scala  jersey-container-servlet-core</li>
<li>jersey-server  json4s-ast  kryo-shaded  minlog  scala-xml  spark-launcher</li>
<li>spark-network-shuffle  spark-unsafe  xbean-asm5-shaded</li>
</ul>
</li>
</ul>
</li>
</ul>
<h5 id="配置hive的执行引擎"><a href="#配置hive的执行引擎" class="headerlink" title="配置hive的执行引擎"></a>配置hive的执行引擎</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">set hive.execution.engine=spark;</div></pre></td></tr></table></figure>
<h5 id="配置spark相关的参数"><a href="#配置spark相关的参数" class="headerlink" title="配置spark相关的参数"></a>配置spark相关的参数</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">set spark.master=&lt;Spark Master URL&gt;</div><div class="line">set spark.eventLog.enabled=true;</div><div class="line">set spark.eventLog.dir=&lt;Spark event log folder (must exist)&gt;</div><div class="line">set spark.executor.memory=512m;             </div><div class="line">set spark.serializer=org.apache.spark.serializer.KryoSerializer;</div></pre></td></tr></table></figure>
<p>hive 2.2.0以前，要把spark-assembly jar到HDS中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;property&gt;</div><div class="line">  &lt;name&gt;spark.yarn.jar&lt;/name&gt;</div><div class="line">  &lt;value&gt;hdfs://xxxx:8020/spark-assembly.jar&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div></pre></td></tr></table></figure></p>
<p>2.2.0以上版本后, 把$SPARK_HOME/jars中的所有jar都上传到hdfs指定文件夹中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&lt;property&gt;</div><div class="line">  &lt;name&gt;spark.yarn.jars&lt;/name&gt;</div><div class="line">  &lt;value&gt;hdfs://xxxx:8020/spark-jars/*&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div></pre></td></tr></table></figure></p>
<h4 id="配置spark"><a href="#配置spark" class="headerlink" title="配置spark"></a>配置spark</h4><table>
<thead>
<tr>
<th>属性</th>
<th>推荐设置</th>
</tr>
</thead>
<tbody>
<tr>
<td>spark.executor.cores</td>
<td>Between 5-7, See tuning details section</td>
</tr>
<tr>
<td>spark.executor.memory</td>
<td>yarn.nodemanager.resource.memory-mb * (spark.executor.cores / yarn.nodemanager.resource.cpu-vcores) </td>
</tr>
<tr>
<td>spark.yarn.executor.memoryOverhead</td>
<td>15-20% of spark.executor.memory</td>
</tr>
<tr>
<td>spark.executor.instances</td>
<td>Depends on spark.executor.memory + spark.yarn.executor.memoryOverhead, see tuning details section.</td>
</tr>
</tbody>
</table>
<h4 id="推荐配置"><a href="#推荐配置" class="headerlink" title="推荐配置"></a>推荐配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">mapreduce.input.fileinputformat.split.maxsize=750000000</div><div class="line">hive.vectorized.execution.enabled=true</div><div class="line"></div><div class="line">hive.cbo.enable=true</div><div class="line">hive.optimize.reducededuplication.min.reducer=4</div><div class="line">hive.optimize.reducededuplication=true</div><div class="line">hive.orc.splits.include.file.footer=false</div><div class="line">hive.merge.mapfiles=true</div><div class="line">hive.merge.sparkfiles=false</div><div class="line">hive.merge.smallfiles.avgsize=16000000</div><div class="line">hive.merge.size.per.task=256000000</div><div class="line">hive.merge.orcfile.stripe.level=true</div><div class="line">hive.auto.convert.join=true</div><div class="line">hive.auto.convert.join.noconditionaltask=true</div><div class="line">hive.auto.convert.join.noconditionaltask.size=894435328</div><div class="line">hive.optimize.bucketmapjoin.sortedmerge=false</div><div class="line">hive.map.aggr.hash.percentmemory=0.5</div><div class="line">hive.map.aggr=true</div><div class="line">hive.optimize.sort.dynamic.partition=false</div><div class="line">hive.stats.autogather=true</div><div class="line">hive.stats.fetch.column.stats=true</div><div class="line">hive.vectorized.execution.reduce.enabled=false</div><div class="line">hive.vectorized.groupby.checkinterval=4096</div><div class="line">hive.vectorized.groupby.flush.percent=0.1</div><div class="line">hive.compute.query.using.stats=true</div><div class="line">hive.limit.pushdown.memory.usage=0.4</div><div class="line">hive.optimize.index.filter=true</div><div class="line">hive.exec.reducers.bytes.per.reducer=67108864</div><div class="line">hive.smbjoin.cache.rows=10000</div><div class="line">hive.exec.orc.default.stripe.size=67108864</div><div class="line">hive.fetch.task.conversion=more</div><div class="line">hive.fetch.task.conversion.threshold=1073741824</div><div class="line">hive.fetch.task.aggr=false</div><div class="line">mapreduce.input.fileinputformat.list-status.num-threads=5</div><div class="line">spark.kryo.referenceTracking=false</div><div class="line">spark.kryo.classesToRegister=org.apache.hadoop.hive.ql.io.HiveKey,org.apache.hadoop.io.BytesWritable,org.apache.hadoop.hive.ql.exec.vector.VectorizedRowBatch</div></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[docker容器的时间同步]]></title>
      <url>/2017/12/12/docker%E5%AE%B9%E5%99%A8%E7%9A%84%E6%97%B6%E9%97%B4%E5%90%8C%E6%AD%A5/</url>
      <content type="html"><![CDATA[<p>最近在测试环境上上了一个新的组件，发现docker容器内的时间是有问题的，就是总比真正的时间慢4分钟左右。然后就exec进去安装了ntpdate工具进行时间同步工作。</p>
<p>然后收到了如下信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">root@1462539f1dc2:/# ntpdate -u cn.pool.ntp.org</div><div class="line">12 Dec 15:57:35 ntpdate[502]: step-systime: Operation not permitted</div></pre></td></tr></table></figure></p>
<p>看到是这个操作被禁止了，而且在docker里是用root执行的，竟然被禁止了。所以考虑到应该是docker对于苏初级的保护。返回宿主机，查看时间…果然与docker容器内一致，然后到宿主机安装ntpdate，进行时间同步之后，docker内时间自然就正常了。</p>
<p>回想一下docker原理：Docker本质上是宿主机（Linux）上的进程，通过namespace实现资源隔离，通过cgroups实现资源限制，通过写时复用机制(copy-on-write)实现高效的文件操作。归根到底还是调用的宿主机的东西，并不像虚拟机自己有一套完整的机制。</p>
<p><a href="https://kasheemlew.github.io/2017/05/18/docker-linux/" target="_blank" rel="external">https://kasheemlew.github.io/2017/05/18/docker-linux/</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[tez-UI配置]]></title>
      <url>/2017/12/11/tez-UI%E9%85%8D%E7%BD%AE/</url>
      <content type="html"><![CDATA[<h4 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h4><p>将tez根目录下的war包copy到tomcat的webapps目录中（0.8.5版本有两个ui包,但是没有感觉到有什么区别）<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cp ~/apache-tez-0.8.5-bin/tez-ui-0.8.5.war /server/tomcat9/webapps</div></pre></td></tr></table></figure></p>
<p>重启tomcat，war包会自动发布。修改配置文件里的timeline-service和resourcemanager的位置信息后，重启tomcat。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">timeline: &quot;http://datanode04.will.com:8188&quot;,</div><div class="line">rm: &quot;http://datanode02.will.com:8088&quot;,</div></pre></td></tr></table></figure></p>
<h4 id="配置tez-site-xml"><a href="#配置tez-site-xml" class="headerlink" title="配置tez-site.xml"></a>配置tez-site.xml</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&lt;property&gt;</div><div class="line">  &lt;name&gt;tez.tez-ui.history-url.base&lt;/name&gt;</div><div class="line">  &lt;value&gt;http://schedule.will.com:8181/tez-ui-0.8.5&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line"></div><div class="line">&lt;property&gt;  </div><div class="line">    &lt;name&gt;tez.history.logging.service.class&lt;/name&gt;  </div><div class="line">    &lt;value&gt;org.apache.tez.dag.history.logging.ats.ATSHistoryLoggingService&lt;/value&gt;  </div><div class="line">&lt;/property&gt;</div></pre></td></tr></table></figure>
<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>设置yarn-site.xml中timeline-service的cros属性为true。之后重启timeline-service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yarn.timeline-service.http-cross-origin.enabled = true</div></pre></td></tr></table></figure>
<p>其实tez ui就是把所有tez类型的app历史拉出来，按照tez的特性进行定制化的完美展示。</p>
<p>参考：</p>
<ul>
<li><a href="https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=61331897" target="_blank" rel="external">https://cwiki.apache.org/confluence/pages/viewpage.action?pageId=61331897</a></li>
<li><a href="https://hadoop.apache.org/docs/current/hadoop-yarn/hadoop-yarn-site/TimelineServer.html" target="_blank" rel="external">https://hadoop.apache.org/docs/current/hadoop-yarn/hadoop-yarn-site/TimelineServer.html</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hive2-on-tez问题]]></title>
      <url>/2017/12/11/hive2-on-tez%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<p>hive cli端<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">hive&gt; set hive.execution.engine;</div><div class="line">hive.execution.engine=tez</div><div class="line">hive&gt; select count(1) as num, year(create_time) as time from money_record group by year(create_time);</div><div class="line">Query ID = root_20171211171347_57cea87e-f54a-457d-93cf-b312063a822e</div><div class="line">Total jobs = 1</div><div class="line">Launching Job 1 out of 1</div><div class="line">FAILED: Execution Error, return code 1 from org.apache.hadoop.hive.ql.exec.tez.TezTask</div></pre></td></tr></table></figure></p>
<p>yarn app的log信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">............</div><div class="line">............</div><div class="line"># container文件内容</div><div class="line"></div><div class="line">7749233 1292 -r-xr-xr-x   1 yarn     hadoop    1319613 Mar  8  2017 ./tezlib/apache-tez-0.8.5-bin/tez-dag-0.8.5.jar</div><div class="line">37749246    8 -r-xr-xr-x   1 yarn     hadoop       7734 Mar  8  2017 ./tezlib/apache-tez-0.8.5-bin/tez-yarn-timeline-history-with-acls-0.8.5.jar</div><div class="line">37749242  144 -r-xr-xr-x   1 yarn     hadoop     146572 Mar  8  2017 ./tezlib/apache-tez-0.8.5-bin/tez-tests-0.8.5.jar</div><div class="line">37749230    4 drwxr-xr-x   2 yarn     hadoop       4096 Dec 11 17:13 ./tezlib/apache-tez-0.8.5-bin/share</div><div class="line">37749247 41916 -r-xr-xr-x   1 yarn     hadoop   42921455 Mar  8  2017 ./tezlib/apache-tez-0.8.5-bin/share/tez.tar.gz</div><div class="line"></div><div class="line">......</div><div class="line"># 启动脚本</div><div class="line">LogType:launch_container.sh</div><div class="line">Log Upload Time:Mon Dec 11 17:13:49 +0800 2017</div><div class="line">LogLength:5084</div><div class="line">Log Contents:</div><div class="line">#!/bin/bash</div><div class="line">....</div><div class="line">....</div><div class="line"></div><div class="line"># 指定类路径</div><div class="line">export CLASSPATH=&quot;/usr/hdp/2.4.2.0-258/hadoop/lib/hadoop-lzo-0.6.0.2.4.2.0-258.jar:/etc/hadoop/conf/secure:$PWD:$PWD/*:$PWD/tezlib/*:$PWD/tezlib/lib/*:$HADOOP_CONF_DIR:&quot;</div><div class="line">........</div><div class="line"></div><div class="line">LogType:stderr</div><div class="line">Log Upload Time:Mon Dec 11 17:13:50 +0800 2017</div><div class="line">LogLength:77</div><div class="line">Log Contents:</div><div class="line">Error: Could not find or load main class org.apache.tez.dag.app.DAGAppMaster</div><div class="line">End of LogType:stderr</div></pre></td></tr></table></figure></p>
<p>可以看到报错信息是找不到tez的主类，这个一般就是类路径的问题了。</p>
<p>找一个hive 1.2.1的tez的正常的程序，看一下container文件内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">....</div><div class="line">12322304  164 -r-xr-xr-x   1 yarn     hadoop     164267 Apr 25  2016 ./tezlib/tez-runtime-internals-0.7.0.2.4.2.0-258.jar</div><div class="line">12322432   64 -r-xr-xr-x   1 yarn     hadoop      62943 Apr 25  2016 ./tezlib/tez-history-parser-0.7.0.2.4.2.0-258.jar</div><div class="line">12322283   68 -r-xr-xr-x   1 yarn     hadoop      67195 Apr 25  2016 ./tezlib/tez-common-0.7.0.2.4.2.0-258.jar</div><div class="line">12322430   28 -r-xr-xr-x   1 yarn     hadoop      25622 Apr 25  2016 ./tezlib/tez-yarn-timeline-history-0.7.0.2.4.2.0-258.jar</div><div class="line">12322306  532 -r-xr-xr-x   1 yarn     hadoop     542434 Apr 25  2016 ./tezlib/tez-runtime-library-0.7.0.2.4.2.0-258.jar</div><div class="line">....</div><div class="line"></div><div class="line">LogType:launch_container.sh</div><div class="line">Log Upload Time:Mon Dec 11 15:47:42 +0800 2017</div><div class="line">LogLength:5740</div><div class="line">Log Contents:</div><div class="line">#!/bin/bash</div><div class="line"></div><div class="line">....</div><div class="line">export CLASSPATH=&quot;/usr/hdp/2.4.2.0-258/hadoop/lib/hadoop-lzo-0.6.0.2.4.2.0-258.jar:/etc/hadoop/conf/secure:$PWD:$PWD/*:$PWD/tezlib/*:$PWD/tezlib/lib/*:$HADOOP_CONF_DIR:&quot;</div><div class="line"></div><div class="line">....</div></pre></td></tr></table></figure></p>
<p>可以看到都是用的默认的<code>$PWD:$PWD/*:$PWD/tezlib/*:$PWD/tezlib/lib/*</code>, 上面的执行错误的container里的tez文件多一个文件夹路径。</p>
<p>对于<code>tez.lib.uris</code>的注释里也说到：会解压开，然后直接作为classpath。</p>
<p>tez对于classpath<a href="https://tez.apache.org/releases/0.8.5/tez-api-javadocs/configs/TezConfiguration.html" target="_blank" rel="external">配置参考</a>.</p>
<p>我们目前的配置是<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>tez.lib.uris<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>/hdp/apps/$&#123;hdp.version&#125;/tez/apache-tez-0.8.5-bin.tar.gz<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>可以看出是这个包的问题，那么就有两个方式解决了。</p>
<ul>
<li>把apache-tez-0.8.5-bin.tar.gz自己处理一下，把多余的文件夹去掉，重新上传</li>
<li>添加个classpath的前缀，也就是把文件夹名称加上。<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>tez.lib.uris.classpath<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>....<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>看一下tez的目录，发现share目录下有个tez.tar.gz, 这个文件就是专门做这个事情的。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hive命令行使用tez问题]]></title>
      <url>/2017/12/11/hive%E5%91%BD%E4%BB%A4%E8%A1%8C%E4%BD%BF%E7%94%A8tez%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<h4 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h4><ul>
<li>使用ambari2.2.2.0搭建的集群环境</li>
<li>使用了自定义的hive UDF包</li>
</ul>
<h4 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h4><p>通过hue在hiveserver2上使用tez进行查询，正常运行。</p>
<p>使用hive cli进行tez查询的时候，报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">2017-12-11 15:06:30,745 INFO  [main]: ql.Context (Context.java:getMRScratchDir(330)) - New scratch dir is hdfs://dd/tmp/hive/root/c6354673-afc9-4515-8c44-ff7c7f75edcb/hive_2017-12-11_15-06-30_517_4074051706046309823-1</div><div class="line">2017-12-11 15:06:30,750 INFO  [main]: exec.Task (TezTask.java:updateSession(270)) - Tez session hasn&apos;t been created yet. Opening session</div><div class="line">2017-12-11 15:06:30,750 INFO  [main]: tez.TezSessionState (TezSessionState.java:open(130)) - Opening the session with id 97240ae8-cce2-4000-83d6-f6729146ebab for thread main log trace id -  query id - root_20171211150630_4fbc2d95-5613-438c-9499-126da1ce1f49</div><div class="line">2017-12-11 15:06:30,750 INFO  [main]: tez.TezSessionState (TezSessionState.java:open(146)) - User of session id 97240ae8-cce2-4000-83d6-f6729146ebab is root</div><div class="line">2017-12-11 15:06:30,763 INFO  [main]: tez.DagUtils (DagUtils.java:createLocalResource(720)) - Resource modification time: 1512974530270</div><div class="line">2017-12-11 15:06:30,766 INFO  [main]: tez.DagUtils (DagUtils.java:createLocalResource(720)) - Resource modification time: 1512974530408</div><div class="line">2017-12-11 15:06:30,770 INFO  [main]: tez.DagUtils (DagUtils.java:createLocalResource(720)) - Resource modification time: 1512974530453</div><div class="line">2017-12-11 15:06:30,773 INFO  [main]: tez.DagUtils (DagUtils.java:createLocalResource(720)) - Resource modification time: 1512974530487</div><div class="line">2017-12-11 15:06:30,775 INFO  [main]: tez.DagUtils (DagUtils.java:createLocalResource(720)) - Resource modification time: 1512974530408</div><div class="line">2017-12-11 15:06:30,777 INFO  [main]: tez.DagUtils (DagUtils.java:localizeResource(954)) - Localizing resource because it does not exist: file:/server/app/hive/will_hive_udf.jar to dest: hdfs://dd/tmp/hive/root/_tez_session_dir/97240ae8-cce2-4000-83d6-f6729146ebab/will_hive_udf.jar</div><div class="line">2017-12-11 15:06:30,780 INFO  [main]: tez.DagUtils (DagUtils.java:localizeResource(958)) - Looks like another thread is writing the same file will wait.</div><div class="line">2017-12-11 15:06:30,780 INFO  [main]: tez.DagUtils (DagUtils.java:localizeResource(965)) - Number of wait attempts: 5. Wait interval: 5000</div><div class="line">2017-12-11 15:06:55,790 ERROR [main]: tez.DagUtils (DagUtils.java:localizeResource(981)) - Could not find the jar that was being uploaded</div><div class="line">2017-12-11 15:06:55,790 ERROR [main]: exec.Task (TezTask.java:execute(212)) - Failed to execute tez graph.</div><div class="line">java.io.IOException: Previous writer likely failed to write hdfs://dd/tmp/hive/root/_tez_session_dir/97240ae8-cce2-4000-83d6-f6729146ebab/will_hive_udf.jar. Failing because I am unlikely to write too.</div><div class="line">        at org.apache.hadoop.hive.ql.exec.tez.DagUtils.localizeResource(DagUtils.java:982)</div><div class="line">        at org.apache.hadoop.hive.ql.exec.tez.DagUtils.addTempResources(DagUtils.java:862)</div></pre></td></tr></table></figure></p>
<h4 id="问题定位"><a href="#问题定位" class="headerlink" title="问题定位"></a>问题定位</h4><p>上传udf到hdfs中tez session目录的时候，出现错误。</p>
<h4 id="排查过程"><a href="#排查过程" class="headerlink" title="排查过程"></a>排查过程</h4><p>一遍遍地检查HDFS上的目录，发现尽管报错，也已经有了这个UDF jar文件了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@servicenode02 livy]# hdfs dfs -ls /tmp/hive/root/_tez_session_dir/97240ae8-cce2-4000-83d6-f6729146ebab</div><div class="line">Found 4 items</div><div class="line">-rw-r--r--   3 root hdfs     258861 2017-12-11 15:09 /tmp/hive/root/_tez_session_dir/97240ae8-cce2-4000-83d6-f6729146ebab/hive-hcatalog-core.jar</div><div class="line">-rw-r--r--   3 root hdfs       3809 2017-12-11 15:09 /tmp/hive/root/_tez_session_dir/97240ae8-cce2-4000-83d6-f6729146ebab/tinyv_hive_udf.jar</div><div class="line">-rw-r--r--   3 root hdfs      83977 2017-12-11 15:09 /tmp/hive/root/_tez_session_dir/97240ae8-cce2-4000-83d6-f6729146ebab/tinyv_json_serde_1.3.8.jar</div><div class="line">-rw-r--r--   3 root hdfs      24630 2017-12-11 15:09 /tmp/hive/root/_tez_session_dir/97240ae8-cce2-4000-83d6-f6729146ebab/will_hive_udf.jar</div></pre></td></tr></table></figure></p>
<p>来来回回看了八百遍，到源码里也看了一下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">// 尝试将本地文件copy到远程的目录中</span></div><div class="line">    destFS.copyFromLocalFile(<span class="keyword">false</span>, <span class="keyword">false</span>, src, dest);</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">  <span class="comment">// 如果copy失败，一般就是文件已经存在了，或者有其他人在进行同样的操作</span></div><div class="line">  LOG.info(<span class="string">"Looks like another thread is writing the same file will wait."</span>);</div><div class="line">  <span class="keyword">int</span> waitAttempts =</div><div class="line">      conf.getInt(HiveConf.ConfVars.HIVE_LOCALIZE_RESOURCE_NUM_WAIT_ATTEMPTS.varname,</div><div class="line">          HiveConf.ConfVars.HIVE_LOCALIZE_RESOURCE_NUM_WAIT_ATTEMPTS.defaultIntVal);</div><div class="line">  <span class="keyword">long</span> sleepInterval = HiveConf.getTimeVar(</div><div class="line">      conf, HiveConf.ConfVars.HIVE_LOCALIZE_RESOURCE_WAIT_INTERVAL,</div><div class="line">      TimeUnit.MILLISECONDS);</div><div class="line">  LOG.info(<span class="string">"Number of wait attempts: "</span> + waitAttempts + <span class="string">". Wait interval: "</span></div><div class="line">      + sleepInterval);</div><div class="line">      </div><div class="line">  <span class="comment">// 隔一段时间检查一下，这个文件是不是已经有了</span></div><div class="line">  <span class="keyword">boolean</span> found = <span class="keyword">false</span>;</div><div class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; waitAttempts; i++) &#123;</div><div class="line">    <span class="keyword">if</span> (!checkPreExisting(src, dest, conf)) &#123;</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        Thread.sleep(sleepInterval);</div><div class="line">      &#125; <span class="keyword">catch</span> (InterruptedException interruptedException) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(interruptedException);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      found = <span class="keyword">true</span>;</div><div class="line">      <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">// 如果一直都么有，就报上面的错误了</span></div><div class="line">  <span class="keyword">if</span> (!found) &#123;</div><div class="line">    LOG.error(<span class="string">"Could not find the jar that was being uploaded"</span>);</div><div class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Previous writer likely failed to write "</span> + dest +</div><div class="line">        <span class="string">". Failing because I am unlikely to write too."</span>);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>对于<code>checkPreExisting</code>方法，也要看一下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 检查目标目录下是不是已经有了同名文件，</span></div><div class="line"><span class="comment">// 如果文件已经有了，那么要检查文件是否一致，这里简单用len验证</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">checkPreExisting</span><span class="params">(Path src, Path dest, Configuration conf)</span></span></div><div class="line">    <span class="keyword">throws</span> IOException &#123;</div><div class="line">    FileSystem destFS = dest.getFileSystem(conf);</div><div class="line">    FileSystem sourceFS = src.getFileSystem(conf);</div><div class="line">    FileStatus destStatus = FileUtils.getFileStatusOrNull(destFS, dest);</div><div class="line">    <span class="keyword">if</span> (destStatus != <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="comment">// 我挂到了这一步，就是udf的版本不一致</span></div><div class="line">      <span class="keyword">return</span> (sourceFS.getFileStatus(src).getLen() == destStatus.getLen());</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>好了。那么看一下我的问题。为了使用udf，我们的数据研发在hive cli的初始化文件<code>bin/.hiverc</code>中添加了下面的命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">add jar /server/app/hive/will_hive_udf.jar;</div><div class="line">add jar /usr/hdp/current/hive-client/auxlib/tinyv_hive_udf.jar;</div><div class="line">create temporary function  strstart as &apos;com.will.common.hive.StrStart&apos;;  </div><div class="line">create temporary function  strDateFormat as &apos;com.will.common.hive.StrDateFormat&apos;;</div><div class="line">create temporary function  strContain as &apos;com.will.common.hive.StrContain&apos;; </div><div class="line">create temporary function  parse_uri as &apos;com.will.common.hive.ParseUri&apos;;</div><div class="line">create temporary function  strEnd as &apos;com.will.common.hive.StrEnd&apos;;</div><div class="line">create temporary function  split_by_index as &apos;com.will.common.hive.SplitByIndex&apos;;</div><div class="line">create temporary function birthday as &apos;com.will.common.hive.BirthdayByIdcard&apos;;</div><div class="line">create temporary function gender as &apos;com.will.common.hive.GenderByIdcard&apos;;  </div><div class="line">create temporary function usernamesen as &apos;com.will.common.hive.UserNameSen&apos;;</div><div class="line">create temporary function strTrim as &apos;com.will.common.hive.StrTrim&apos;;</div><div class="line">create temporary function channel as &apos;com.will.common.hive.Channel&apos;;</div><div class="line">create temporary function iptonum as &apos;com.will.common.hive.IpToNumber&apos;;</div><div class="line">create temporary function geturl as &apos;com.will.common.hive.ParseUrls&apos;;</div><div class="line">create temporary function money_record_type as &apos;com.will.common.hive.MoneyRecordType&apos;;</div><div class="line">create temporary function xv_encode as &apos;com.will.tinyv.Encode&apos;;</div><div class="line">create temporary function xv_decode as &apos;com.will.tinyv.Decode&apos;;</div><div class="line">set hive.mapred.mode=nostrict;</div></pre></td></tr></table></figure></p>
<p>重新启动hive cli，报错的日志，发现上传了来自两个不同地方的will_hive_udf.jar文件：一个来自<code>hive/auxlib</code>目录，另一个来自<code>/server/app</code>…..而<strong>只有第一次报错的时候才能看到第一个udf的上传过程，因为同一个session中，已经上传过的，验证没问题就跳过了。。。。只打印了一个时间戳，也没有指明是哪个文件</strong>…..导致定位问题的时候，有些恍惚，还以为是tez与UDF功能之间的问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">2017-12-11 15:09:30,604 INFO  [main]: ql.Context (Context.java:getMRScratchDir(330)) - New scratch dir is hdfs://dd/tmp/hive/root/c6354673-afc9-4515-8c44-ff7</div><div class="line">c7f75edcb/hive_2017-12-11_15-09-30_406_4902171368286077085-1</div><div class="line">2017-12-11 15:09:30,608 INFO  [main]: exec.Task (TezTask.java:updateSession(270)) - Tez session hasn&apos;t been created yet. Opening session</div><div class="line">2017-12-11 15:09:30,608 INFO  [main]: tez.TezSessionState (TezSessionState.java:open(130)) - Opening the session with id 97240ae8-cce2-4000-83d6-f6729146ebab</div><div class="line"> for thread main log trace id -  query id - root_20171211150930_d928c00e-62da-4c0e-95c2-23a28594a7c0</div><div class="line">2017-12-11 15:09:30,608 INFO  [main]: tez.TezSessionState (TezSessionState.java:open(146)) - User of session id 97240ae8-cce2-4000-83d6-f6729146ebab is root</div><div class="line">2017-12-11 15:09:30,613 INFO  [main]: tez.DagUtils (DagUtils.java:localizeResource(954)) - Localizing resource because it does not exist: file:/usr/hdp/curre</div><div class="line">nt/hive-webhcat/share/hcatalog/hive-hcatalog-core.jar to dest: hdfs://dd/tmp/hive/root/_tez_session_dir/97240ae8-cce2-4000-83d6-f6729146ebab/hive-hcatalog-co</div><div class="line">re.jar</div><div class="line">2017-12-11 15:09:30,655 INFO  [main]: tez.DagUtils (DagUtils.java:createLocalResource(720)) - Resource modification time: 1512976170667</div><div class="line">2017-12-11 15:09:30,656 INFO  [main]: tez.DagUtils (DagUtils.java:localizeResource(954)) - Localizing resource because it does not exist: file:/usr/hdp/2.4.2</div><div class="line">.0-258/hive/auxlib/tinyv_hive_udf.jar to dest: hdfs://dd/tmp/hive/root/_tez_session_dir/97240ae8-cce2-4000-83d6-f6729146ebab/tinyv_hive_udf.jar</div><div class="line">2017-12-11 15:09:30,683 INFO  [main]: tez.DagUtils (DagUtils.java:createLocalResource(720)) - Resource modification time: 1512976170691</div><div class="line">2017-12-11 15:09:30,684 INFO  [main]: tez.DagUtils (DagUtils.java:localizeResource(954)) - Localizing resource because it does not exist: file:/usr/hdp/2.4.2</div><div class="line">.0-258/hive/auxlib/tinyv_json_serde_1.3.8.jar to dest: hdfs://dd/tmp/hive/root/_tez_session_dir/97240ae8-cce2-4000-83d6-f6729146ebab/tinyv_json_serde_1.3.8.j</div><div class="line">ar</div><div class="line">2017-12-11 15:09:30,707 INFO  [main]: tez.DagUtils (DagUtils.java:createLocalResource(720)) - Resource modification time: 1512976170720</div><div class="line">2017-12-11 15:09:30,709 INFO  [main]: tez.DagUtils (DagUtils.java:localizeResource(954)) - Localizing resource because it does not exist: file:/usr/hdp/2.4.2.0-258/hive/auxlib/will_hive_udf.jar to dest: hdfs://dd/tmp/hive/root/_tez_session_dir/97240ae8-cce2-4000-83d6-f6729146ebab/will_hive_udf.jar</div><div class="line">2017-12-11 15:09:30,729 INFO  [main]: tez.DagUtils (DagUtils.java:createLocalResource(720)) - Resource modification time: 1512976170742</div><div class="line">2017-12-11 15:09:30,732 INFO  [main]: tez.DagUtils (DagUtils.java:createLocalResource(720)) - Resource modification time: 1512976170691</div><div class="line">2017-12-11 15:09:30,733 INFO  [main]: tez.DagUtils (DagUtils.java:localizeResource(954)) - Localizing resource because it does not exist: file:/server/app/hive/will_hive_udf.jar to dest: hdfs://dd/tmp/hive/root/_tez_session_dir/97240ae8-cce2-4000-83d6-f6729146ebab/will_hive_udf.jar</div><div class="line">2017-12-11 15:09:30,735 INFO  [main]: tez.DagUtils (DagUtils.java:localizeResource(958)) - Looks like another thread is writing the same file will wait.</div><div class="line">2017-12-11 15:09:30,736 INFO  [main]: tez.DagUtils (DagUtils.java:localizeResource(965)) - Number of wait attempts: 5. Wait interval: 5000</div><div class="line">2017-12-11 15:09:55,745 ERROR [main]: tez.DagUtils (DagUtils.java:localizeResource(981)) - Could not find the jar that was being uploaded</div><div class="line">2017-12-11 15:09:55,745 ERROR [main]: exec.Task (TezTask.java:execute(212)) - Failed to execute tez graph.</div><div class="line">java.io.IOException: Previous writer likely failed to write hdfs://dd/tmp/hive/root/_tez_session_dir/97240ae8-cce2-4000-83d6-f6729146ebab/will_hive_udf.jar. Failing because I am unlikely to write too.</div><div class="line">        at org.apache.hadoop.hive.ql.exec.tez.DagUtils.localizeResource(DagUtils.java:982)</div><div class="line">        at org.apache.hadoop.hive.ql.exec.tez.DagUtils.addTempResources(DagUtils.java:862)</div><div class="line">        at org.apache.hadoop.hive.ql.exec.tez.DagUtils.localizeTempFilesFromConf(DagUtils.java:805)</div><div class="line">        at org.apache.hadoop.hive.ql.exec.tez.TezSessionState.refreshLocalResourcesFromConf(TezSessionState.java:233)</div><div class="line">        at org.apache.hadoop.hive.ql.exec.tez.TezSessionState.open(TezSessionState.java:158)</div><div class="line">        at org.apache.hadoop.hive.ql.exec.tez.TezTask.updateSession(TezTask.java:271)</div><div class="line">        at org.apache.hadoop.hive.ql.exec.tez.TezTask.execute(TezTask.java:151)</div><div class="line">        at org.apache.hadoop.hive.ql.exec.Task.executeTask(Task.java:160)</div><div class="line">        at org.apache.hadoop.hive.ql.exec.TaskRunner.runSequential(TaskRunner.java:89)</div></pre></td></tr></table></figure></p>
<h4 id="总结原因"><a href="#总结原因" class="headerlink" title="总结原因"></a>总结原因</h4><ul>
<li>udf版本不一致，导致后面jar包上传失败</li>
</ul>
<h4 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h4><p>把.hiverc中的命令暂时去掉，重试tez引擎。就能成功调用了。</p>
<h4 id="其他思考"><a href="#其他思考" class="headerlink" title="其他思考"></a>其他思考</h4><p>为什么已经设定了<code>hive.aux.jars.path</code>了，还要在.hiverc额外处理呢。</p>
<p>先在hivecli中确认一下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@schedule ~]#hive -e &quot;set hive.aux.jars.path&quot;</div><div class="line">WARNING: Use &quot;yarn jar&quot; to launch YARN applications.</div><div class="line"></div><div class="line">Logging initialized using configuration in file:/etc/hive/2.4.2.0-258/0/hive-log4j.properties</div><div class="line">Putting the global hiverc in $HIVE_HOME/bin/.hiverc is deprecated. Please use $HIVE_CONF_DIR/.hiverc instead.</div><div class="line">hive.aux.jars.path=file:///usr/hdp/current/hive-webhcat/share/hcatalog/hive-hcatalog-core.jar,file:///usr/hdp/2.4.2.0-258/hive/auxlib/tinyv_hive_udf.jar,file:///usr/hdp/2.4.2.0-258/hive/auxlib/tinyv_json_serde_1.3.8.jar,file:///usr/hdp/2.4.2.0-258/hive/auxlib/will_hive_udf.jar</div></pre></td></tr></table></figure></p>
<p>但是测试了一下，没有.hiverc里的初始化，就不能执行udf函数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hive&gt; select iptonum(&apos;10.2.19.32&apos;);</div><div class="line">FAILED: SemanticException [Error 10011]: Line 1:7 Invalid function &apos;iptonum&apos;</div></pre></td></tr></table></figure></p>
<p>可是hue里，也就是hiveserver2里却可以执行udf函数。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[canal同步的TimeStamp问题]]></title>
      <url>/2017/12/11/canal%E5%90%8C%E6%AD%A5%E7%9A%84TimeStamp%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<p>部门接了新的实时方面的需求，选定使用canal进行mysql binlog方面的处理。</p>
<p>上线一段时间后都比较稳定，但是有一天，实时数据开发的同事找到我说有个别字段是有问题的。大概表结构如下：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`bb`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</div><div class="line">  <span class="string">`lastUpdateTime`</span> <span class="keyword">timestamp</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span>,</div><div class="line">  <span class="string">`firstTimeBindTime`</span> datetime <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=MyISAM AUTO_INCREMENT=<span class="number">1526640</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8</div></pre></td></tr></table></figure></p>
<p>有问题的字段为<code>lastUpdateTime</code>，主库为<code>2017-12-11 11:22:40</code>的时候，canal client中消费到的却是<code>2017-12-10 22:22:40</code>，而且所有这个字段都是相差同样的13个小时。但是有一个地方比较值得注意，就是<code>firstTimeBindTime</code>的值都是正常的。</p>
<h4 id="排查流程"><a href="#排查流程" class="headerlink" title="排查流程"></a>排查流程</h4><ul>
<li><p>查看canal server的系统时区，进行修正确认</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime </div><div class="line">date # 发现时间已经正确了</div></pre></td></tr></table></figure>
</li>
<li><p>重启canal server</p>
</li>
</ul>
<p>发现还是有问题，去mysql主机上翻看binlog，找到对应的记录。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mysqlbinlog -vv /server/mysql_data/mysql-bin.000141</div></pre></td></tr></table></figure></p>
<p>发现这个字段对应的时间戳是正确的<code>1512962560</code>。那么问题看来还是在canal server这块了。</p>
<h4 id="源码走读"><a href="#源码走读" class="headerlink" title="源码走读"></a>源码走读</h4><p>顺便看下源码吧。对于binlog进行解析的主类：<code>MysqlEventParser.start()</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">...</div><div class="line"><span class="comment">// event处理与解析</span></div><div class="line">CanalEntry.Entry entry = parseAndProfilingIfNecessary(event);</div><div class="line">...</div></pre></td></tr></table></figure>
<p>进入<code>parseAndProfilingIfNecessary</code>方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="comment">// 使用parser解析</span></div><div class="line">CanalEntry.Entry event = binlogParser.parse(bod);</div><div class="line">...</div></pre></td></tr></table></figure>
<p>找到对应的parser类为LogEventConvert，可以看到<code>LogEventConvert</code>是继承了<code>BinlogParser</code>的。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> BinlogParser <span class="title">buildParser</span><span class="params">()</span> </span>&#123;</div><div class="line">    LogEventConvert convert = <span class="keyword">new</span> LogEventConvert();</div><div class="line">    ......</div><div class="line">    <span class="keyword">return</span> convert;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再去<code>LogEventConvert</code>的parse方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line"><span class="comment">// 对于修改数据的event的处理</span></div><div class="line"><span class="keyword">case</span> LogEvent.WRITE_ROWS_EVENT:</div><div class="line">    <span class="keyword">return</span> parseRowsEvent((WriteRowsLogEvent) logEvent);</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>继续找<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">while</span> (buffer.nextOneRow(columns)) &#123;</div><div class="line">    <span class="comment">// 处理row记录</span></div><div class="line">    RowData.Builder rowDataBuilder = RowData.newBuilder();</div><div class="line">    <span class="keyword">if</span> (EventType.INSERT == eventType) &#123;</div><div class="line">        <span class="comment">// insert的记录放在before字段中</span></div><div class="line">        tableError |= parseOneRow(rowDataBuilder, event, buffer, columns, <span class="keyword">true</span>, tableMeta);</div><div class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (EventType.DELETE == eventType) &#123;</div><div class="line">        <span class="comment">// delete的记录放在before字段中</span></div><div class="line">        tableError |= parseOneRow(rowDataBuilder, event, buffer, columns, <span class="keyword">false</span>, tableMeta);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="comment">// update需要处理before/after</span></div><div class="line">        tableError |= parseOneRow(rowDataBuilder, event, buffer, columns, <span class="keyword">false</span>, tableMeta);</div><div class="line">        <span class="keyword">if</span> (!buffer.nextOneRow(changeColumns)) &#123;</div><div class="line">            rowChangeBuider.addRowDatas(rowDataBuilder.build());</div><div class="line">            <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        tableError |= parseOneRow(rowDataBuilder, event, buffer, changeColumns, <span class="keyword">true</span>, tableMeta);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    rowChangeBuider.addRowDatas(rowDataBuilder.build());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>对于行数据的每个字段的处理，是先获取到value，然后再针对地做一些额外处理。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">....</div><div class="line"><span class="keyword">final</span> Serializable value = buffer.getValue();</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>通过<code>RowsLogBuffer</code>进行value的获取，我们找到给value赋值的地方<code>fetchValue</code><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">final</span> Serializable <span class="title">fetchValue</span><span class="params">(<span class="keyword">int</span> type, <span class="keyword">final</span> <span class="keyword">int</span> meta, <span class="keyword">boolean</span> isBinary)</span> </span>&#123;</div><div class="line">    .....</div><div class="line">    <span class="keyword">switch</span> (type) &#123;</div><div class="line">	 <span class="keyword">case</span> LogEvent.MYSQL_TYPE_TIMESTAMP: &#123;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> i32 = buffer.getUint32();</div><div class="line">        <span class="keyword">if</span> (i32 == <span class="number">0</span>) &#123;</div><div class="line">            value = <span class="string">"0000-00-00 00:00:00"</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            String v = <span class="keyword">new</span> Timestamp(i32 * <span class="number">1000</span>).toString();</div><div class="line">            value = v.substring(<span class="number">0</span>, v.length() - <span class="number">2</span>);</div><div class="line">        &#125;</div><div class="line">        javaType = Types.TIMESTAMP;</div><div class="line">        length = <span class="number">4</span>;</div><div class="line">        <span class="keyword">break</span>;</div><div class="line">    &#125;</div><div class="line">    .....</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>把这部分弄出去，使用上面binlog文件中的timestamp单独测试.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">import</span> java.sql.Timestamp;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Created by root on 17-12-11.</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Will</span> </span>&#123;</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] p )</span></span>&#123;</div><div class="line">        String value = <span class="string">""</span>;</div><div class="line">        <span class="keyword">final</span> <span class="keyword">long</span> i32 = <span class="number">1512962560l</span>;</div><div class="line">        System.out.println(TimeZone.getDefault());</div><div class="line">        System.out.println(i32);</div><div class="line">        <span class="keyword">if</span> (i32 == <span class="number">0</span>) &#123;</div><div class="line">            value = <span class="string">"0000-00-00 00:00:00"</span>;</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            String v = <span class="keyword">new</span> Timestamp(i32 * <span class="number">1000</span>).toString();</div><div class="line">            value = v.substring(<span class="number">0</span>, v.length() - <span class="number">2</span>);</div><div class="line">        &#125;</div><div class="line">        System.out.println(value);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>在测试机是正常的, 但是在线上环境是不正常的，最后在java里输出了一下<code>Timezone.getDefault()</code>，发现线上是”America/New_York”，正好就是差13个小时的。可是在系统里运行date命令，返回的是上海时区。上网搜了一下，有人建议使用下面命令确定时区<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@etl01 ~]# ls -l /etc/localtime</div><div class="line">lrwxrwxrwx. 1 root root 38 Oct 21 00:25 /etc/localtime -&gt; ../usr/share/zoneinfo/America/New_York</div></pre></td></tr></table></figure></p>
<p>这里看到虽然我前面使用cp已经覆盖了/etc/localtime文件，而且并没有报错。但是查看的时候，还是显示为到纽约的链接。</p>
<p>删掉这个文件，重新cp。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@etl01 ~]# rm -vf /etc/localtime</div><div class="line">removed \u2018/etc/localtime\u2019</div><div class="line">[root@etl01 ~]# cp /usr/share/zoneinfo/Asia/Shanghai /etc/localtime </div><div class="line">[root@etl01 ~]# ls -l /etc/localtime</div><div class="line">-rw-r--r--. 1 root root 405 Dec 11 13:14 /etc/localtime</div><div class="line">[root@etl01 ~]# java Will</div><div class="line">sun.util.calendar.ZoneInfo[id=&quot;America/New_York&quot;,offset=-18000000,dstSavings=3600000,useDaylight=true,transitions=235,lastRule=java.util.SimpleTimeZone[id=America/New_York,offset=-18000000,dstSavings=3600000,useDaylight=true,startYear=0,startMode=3,startMonth=2,startDay=8,startDayOfWeek=1,startTime=7200000,startTimeMode=0,endMode=3,endMonth=10,endDay=1,endDayOfWeek=1,endTime=7200000,endTimeMode=0]]</div><div class="line">America/New_York</div></pre></td></tr></table></figure></p>
<p>还是不对，无奈，再次删掉。按照系统的样子，创建软链，成功。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@etl01 ~]# rm /etc/localtime </div><div class="line">rm: remove regular file \u2018/etc/localtime\u2019? y</div><div class="line">[root@etl01 ~]# ln -s /usr/share/zoneinfo/Asia/Shanghai /etc/localtime</div><div class="line">[root@etl01 ~]# ls -l /etc/localtime</div><div class="line">lrwxrwxrwx. 1 root root 33 Dec 11 13:15 /etc/localtime -&gt; /usr/share/zoneinfo/Asia/Shanghai</div><div class="line">[root@etl01 ~]# java Will</div><div class="line">sun.util.calendar.ZoneInfo[id=&quot;Asia/Shanghai&quot;,offset=28800000,dstSavings=0,useDaylight=false,transitions=19,lastRule=null]</div><div class="line">Asia/Shanghai</div></pre></td></tr></table></figure></p>
<p>CentOS Linux release 7.0.1406 (Core)系统……….比较无语</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hive-llap启动]]></title>
      <url>/2017/12/07/hive-llap%E5%90%AF%E5%8A%A8/</url>
      <content type="html"><![CDATA[<h4 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h4><ul>
<li>tez</li>
<li>slider</li>
</ul>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><h5 id="conf-hive-env-sh"><a href="#conf-hive-env-sh" class="headerlink" title="conf/hive-env.sh"></a>conf/hive-env.sh</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># 到tez的配置目录里找tez-site.xml</div><div class="line">export TEZ_HOME=/usr/hdp/current/tez-client</div><div class="line">export TEZ_CONF_DIR=$TEZ_HOME/conf</div><div class="line"></div><div class="line">HADOOP_HOME=/usr/hdp/current/hadoop-client/</div></pre></td></tr></table></figure>
<h5 id="hive-site-xml"><a href="#hive-site-xml" class="headerlink" title="hive-site.xml"></a>hive-site.xml</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.execution.mode<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">value</span>&gt;</span>llap<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">description</span>&gt;</span></div><div class="line">     Expects one of [container, llap].</div><div class="line">     Chooses whether query fragments will run in container or in llap</div><div class="line">   <span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure>
<h5 id="tez-site-xml"><a href="#tez-site-xml" class="headerlink" title="tez-site.xml"></a>tez-site.xml</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">name</span>&gt;</span>tez.lib.uris<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">value</span>&gt;</span>/hdp/apps/$&#123;hdp.version&#125;/tez/apache-tez-0.8.5-bin.tar.gz<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="slider查看"><a href="#slider查看" class="headerlink" title="slider查看"></a>slider查看</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@servicenode04 apache-hive-2.3.2-bin]# slider list</div><div class="line">2017-12-07 18:10:01,421 [main] INFO  impl.TimelineClientImpl - Timeline service address: http://datanode04.will.com:8188/ws/v1/timeline/</div><div class="line">2017-12-07 18:10:02,387 [main] WARN  shortcircuit.DomainSocketFactory - The short-circuit local reads feature cannot be used because libhadoop cannot be loaded.</div><div class="line">2017-12-07 18:10:02,403 [main] INFO  client.RMProxy - Connecting to ResourceManager at datanode02.will.com/10.2.19.83:8050</div><div class="line">llap_service                       RUNNING  application_1511064572746_27005             http://datanode02.will.com:8088/proxy/application_1511064572746_27005/</div></pre></td></tr></table></figure>
<h4 id="报错"><a href="#报错" class="headerlink" title="报错"></a>报错</h4><h5 id="container大小"><a href="#container大小" class="headerlink" title="container大小"></a>container大小</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@servicenode04 apache-hive-2.3.2-bin]# ./bin/hive --service llap --instances 5 </div><div class="line">llap</div><div class="line">INFO cli.LlapServiceDriver: LLAP service driver invoked with arguments=-directory</div><div class="line">INFO conf.HiveConf: Found configuration file file:/server/apache-hive-2.3.2-bin/conf/hive-site.xml</div><div class="line">Failed: Container size (-1B) should be greater than minimum allocation(2.00GB)</div><div class="line">java.lang.IllegalArgumentException: Container size (-1B) should be greater than minimum allocation(2.00GB)</div><div class="line">	at com.google.common.base.Preconditions.checkArgument(Preconditions.java:92)</div><div class="line">	at org.apache.hadoop.hive.llap.cli.LlapServiceDriver.run(LlapServiceDriver.java:313)</div><div class="line">	at org.apache.hadoop.hive.llap.cli.LlapServiceDriver.main(LlapServiceDriver.java:116)</div><div class="line">INFO cli.LlapServiceDriver: LLAP service driver finished</div></pre></td></tr></table></figure>
<p>提示是container大小还没有最小的大。加个参数就行了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./bin/hive --service llap --size 2147483648 --instances 3</div></pre></td></tr></table></figure></p>
<h5 id="配置漏项"><a href="#配置漏项" class="headerlink" title="配置漏项"></a>配置漏项</h5><p>生成slider项目目录之后，启动llap失败。到yarn的日志里翻看，发现异常：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yarn logs --applicationId application_1511064572746_25101 |less</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">017-12-06T11:56:39,771 WARN  [main ()] org.apache.hadoop.hive.llap.daemon.impl.LlapDaemon: Failed to start LLAP Daemon with exception</div><div class="line">java.lang.NullPointerException</div><div class="line">        at org.apache.hadoop.hive.llap.daemon.impl.LlapDaemon.&lt;init&gt;(LlapDaemon.java:139) ~[hive-llap-server-2.3.2.jar:2.3.2]</div><div class="line">        at org.apache.hadoop.hive.llap.daemon.impl.LlapDaemon.main(LlapDaemon.java:521) [hive-llap-server-2.3.2.jar:2.3.2]</div><div class="line">End of LogType:llap-daemon-root-datanode02.will.com.log</div></pre></td></tr></table></figure>
<p>找到对应版本的源码里，发现是少了配置项<code>String hosts = HiveConf.getTrimmedVar(daemonConf, ConfVars.LLAP_DAEMON_SERVICE_HOSTS);</code>,也就是<code>hive.llap.daemon.service.hosts</code>，应该配置为@llap_service.</p>
<h5 id="tez版本问题"><a href="#tez版本问题" class="headerlink" title="tez版本问题"></a>tez版本问题</h5><p>重新生产slider项目，再次，运行，还是异常退出了，继续看yarn的log。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">ue</div><div class="line">2017-12-07T17:12:20,582 WARN  [main ()] org.apache.hadoop.hive.llap.daemon.impl.LlapDaemon: Failed to start LLAP Daemon with exception</div><div class="line">java.lang.NoClassDefFoundError: org/apache/tez/hadoop/shim/HadoopShimsLoader</div><div class="line">        at org.apache.hadoop.hive.llap.daemon.impl.ContainerRunnerImpl.&lt;init&gt;(ContainerRunnerImpl.java:157) ~[hive-llap-server-2.3.2.jar:2.3.2]</div><div class="line">        at org.apache.hadoop.hive.llap.daemon.impl.LlapDaemon.&lt;init&gt;(LlapDaemon.java:283) ~[hive-llap-server-2.3.2.jar:2.3.2]</div><div class="line">        at org.apache.hadoop.hive.llap.daemon.impl.LlapDaemon.main(LlapDaemon.java:521) [hive-llap-server-2.3.2.jar:2.3.2]</div><div class="line">Caused by: java.lang.ClassNotFoundException: org.apache.tez.hadoop.shim.HadoopShimsLoader</div><div class="line">        at java.net.URLClassLoader.findClass(URLClassLoader.java:381) ~[?:1.8.0_60]</div><div class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:424) ~[?:1.8.0_60]</div><div class="line">        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:331) ~[?:1.8.0_60]</div><div class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:357) ~[?:1.8.0_60]</div><div class="line">        ... 3 more</div><div class="line">End of LogType:llap-daemon-root-datanode05.will.com.log</div></pre></td></tr></table></figure></p>
<p>查了一下，这个类是tez的。我当前使用的是0.7版本的，到github上试了一下，这个版本还没有这个类。那就自己下载个有这个类的tez，上传到hdfs，重新修改tez-site.xml，指定下位置。</p>
<h5 id="log4j版本问题？"><a href="#log4j版本问题？" class="headerlink" title="log4j版本问题？"></a>log4j版本问题？</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">Exception in thread &quot;main&quot; java.lang.NoClassDefFoundError: org/apache/commons/logging/LogFactory</div><div class="line">        at org.apache.hadoop.service.AbstractService.&lt;clinit&gt;(AbstractService.java:43)</div><div class="line">Caused by: java.lang.ClassNotFoundException: org.apache.commons.logging.LogFactory</div><div class="line">        at java.net.URLClassLoader.findClass(URLClassLoader.java:381)</div><div class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:424)</div><div class="line">        at sun.misc.Launcher$AppClassLoader.loadClass(Launcher.java:331)</div><div class="line">        at java.lang.ClassLoader.loadClass(ClassLoader.java:357)</div><div class="line">        ... 1 more</div><div class="line">End of LogType:llap-daemon-root-datanode11.will.com.out</div></pre></td></tr></table></figure>
<p>这次是hadoop的AbstractService初始化的时候，找不到commons-logging的类了…好累</p>
<p>看这行日志上面输出了类路径之类的东西：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">+ exec /server/java/jdk1.8.0_60/bin/java -Dproc_llapdaemon -Xms4096m -Xmx4096m -XX:+UseG1GC -XX:+ResizeTLAB -XX:+UseNUMA -XX:-ResizePLAB -server -Djava.net.p</div><div class="line">referIPv4Stack=true -XX:NewRatio=8 -XX:+UseNUMA -XX:+PrintGCDetails -verbose:gc -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=4 -XX:GCLogFileSize=100M -XX</div><div class="line">:+PrintGCDateStamps -Xloggc:/server/hadoop/yarn/log/application_1511064572746_27003/container_e51_1511064572746_27003_01_000006//gc.log -Djava.io.tmpdir=/ser</div><div class="line">ver/hadoop/yarn/local/usercache/root/appcache/application_1511064572746_27003/container_e51_1511064572746_27003_01_000006/tmp/ -Dlog4j.configurationFile=llap</div><div class="line">-daemon-log4j2.properties -Dllap.daemon.log.dir=/server/hadoop/yarn/log/application_1511064572746_27003/container_e51_1511064572746_27003_01_000006/ -Dllap.d</div><div class="line">aemon.log.file=llap-daemon-root-datanode02.will.com.log -Dllap.daemon.root.logger=query-routing -Dllap.daemon.log.level=INFO -classpath &apos;/server/hadoop/yar</div><div class="line">n/local/usercache/root/appcache/application_1511064572746_27003/container_e51_1511064572746_27003_01_000006/app/install//conf/:/server/hadoop/yarn/local/user</div><div class="line">cache/root/appcache/application_1511064572746_27003/container_e51_1511064572746_27003_01_000006/app/install//lib/*:/server/hadoop/yarn/local/usercache/root/a</div><div class="line">ppcache/application_1511064572746_27003/container_e51_1511064572746_27003_01_000006/app/install//lib/tez/*:/server/hadoop/yarn/local/usercache/root/appcache/</div><div class="line">application_1511064572746_27003/container_e51_1511064572746_27003_01_000006/app/install//lib/udfs/*:.:&apos;</div></pre></td></tr></table></figure></p>
<p>明显发现这个classpath是不包含hadoop相关的类的。一番查找，找到hive根目录下的<code>scripts/llap/bin/runLlapDaemon.sh</code>文件，添加一下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CLASSPATH=$&#123;LLAP_DAEMON_CONF_DIR&#125;:$&#123;LLAP_DAEMON_HOME&#125;/lib/*:$&#123;LLAP_DAEMON_HOME&#125;/lib/tez/*:$&#123;LLAP_DAEMON_HOME&#125;/lib/udfs/*:.`hadoop classpath`</div></pre></td></tr></table></figure></p>
<p>再重新生成slider项目。</p>
<p>参考：</p>
<p><a href="http://housong.github.io/2017/hive-llap/" target="_blank" rel="external">http://housong.github.io/2017/hive-llap/</a></p>
<p><a href="http://blog.csdn.net/qingzhenli/article/details/72723018" target="_blank" rel="external">http://blog.csdn.net/qingzhenli/article/details/72723018</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[开源年会]]></title>
      <url>/2017/12/06/%E5%BC%80%E6%BA%90%E5%B9%B4%E4%BC%9A/</url>
      <content type="html"><![CDATA[<h4 id="霍泰稳-本土社区运营的思考"><a href="#霍泰稳-本土社区运营的思考" class="headerlink" title="霍泰稳  本土社区运营的思考"></a>霍泰稳  本土社区运营的思考</h4><h5 id="运营"><a href="#运营" class="headerlink" title="运营"></a>运营</h5><ul>
<li>社区开始需要灵魂人物，后面不应该需要，而应该是品牌效应<br>  开始的时候，要频繁出去跑，与各种专家交往，成为交际花。当品牌已经有了的时候，就要重点突出品牌，而不是个人了。</li>
<li>架构<br>  一线人员参与内容，因为内容专业性很强。使用架构组织内容的生产，总编辑 -&gt; 6个专题首席编辑(java, ruby，每个专题有一个首席编辑，负责组建对应主题的编辑运营团队) -&gt; 若干社区编辑。</li>
<li><p>付费</p>
<ul>
<li>不要被人当成公益组织，不带道德光环。费用是按照翻译字数/写作字数，或者专家约稿收取。多多少少有些补贴。</li>
<li><p>大会门票理所当然也不会是免费的。</p>
<p>这样才能让人们知道自己的支持是有价值、有价格的。</p>
</li>
</ul>
</li>
<li>开源和免费完全没关系</li>
</ul>
<h5 id="工具"><a href="#工具" class="headerlink" title="工具"></a>工具</h5><ul>
<li>raven。自动展示infoQ的英文站文章，然后社区编辑过来领取任务，进行翻译。有些众包平台的意思，以前都是专人整理Excel，每天发送一次，统计一次。</li>
<li>wiki。</li>
<li>stuQ. 流程</li>
</ul>
<h5 id="经验"><a href="#经验" class="headerlink" title="经验"></a>经验</h5><ul>
<li>运营公司的心态去做社区，与时俱进调整价值观</li>
<li>青出于蓝，找到可以帮助自己的黑马</li>
<li>坚持创新</li>
</ul>
<h4 id="kylin-成长之路"><a href="#kylin-成长之路" class="headerlink" title="kylin 成长之路"></a>kylin 成长之路</h4><p>teradata太昂贵，数据都放在HDFS，原来需要将HDFS的数据先load到teardata才能查询。调研之后，就决定自己做。luke负责这个东西，找到蒋旭(了解SQL分析与支持，了解Hadoop)。13年开始做，14年10月1日，ebay内部上了生产环境，同时放到github上进行开源，很快收获了很多的好的评价。</p>
<p>14年11月成为apache孵化器项目，接受了很多mentor的指导，代码迁移到apache代码库，成员加入apache，各种license的处理与剥离。解决大量用户的各种问题，快速升级。获得了国外知名技术社区的关注，并给以奖项。</p>
<p>kylin与apache建立私人关系，开始在国内美团、京东、bat等开始铺展，进一步推动孵化器向顶级项目转化。apache社区的人有人说：中国人喜欢用QQ群等工具尽享项目讨论，而不符合apache社区的邮件讨论的风格。</p>
<p>也有人投反对票，前端有google的不明确license前端字体。随后，kylin快速处理，发布新的release，以供审核。</p>
<p>后来成立了kylingence，专门搞kylin。开源版知识产权属于apache社区。</p>
<p>kylin2.0主要变化是支持雪花模型，支持spark进行构建工作，2.1支持查询下压(下压给hive或者spark sql进行查询)。</p>
<p>核心代码人员有5个，活跃的commiter不到10个，contributter有70个左右。</p>
<ul>
<li>对用户友好，好用。kylin最开始就很完善，包括前端、后端、性能</li>
<li>构建生态。合适地利用其他技术，不要重复造轮子</li>
<li>轻量级构建。对管理员友好，易于扩展、容灾等</li>
<li>倾听社区用户。解决用户痛点，才能得民心</li>
</ul>
<p>贡献到kylin</p>
<ul>
<li>加入社区讨论，知道大家在做什么，难点在哪儿</li>
<li>贡献patch，或者github提PR，量大了就直接提为committer</li>
</ul>
<h4 id="carbonData"><a href="#carbonData" class="headerlink" title="carbonData"></a>carbonData</h4><p>保证代码质量：充分的review，大牛多不能保证质量</p>
<p>把apache 文档研究了一个月，把项目关键路径规划了一下</p>
<p>去美国找了基金会的导师，这个比较重要</p>
<p>有人会说你的代码跟我们的代码相似，就懵了….就跟他说受了你的鼓舞~~~~然后成了导师</p>
<p>apache way</p>
<p>只要有人用起来，就会被鞭子抽着跑</p>
<h4 id="apache-weex"><a href="#apache-weex" class="headerlink" title="apache weex"></a>apache weex</h4><p>使用HTML + css描述app结构、样式，逻辑写在script中。可以远程加载成为native 界面。</p>
<p><a href="http://weex.apache.org/cn/" target="_blank" rel="external">http://weex.apache.org/cn/</a></p>
<ul>
<li>内部事业部推销</li>
<li>外部邀请使用者参与进来</li>
<li>跟内部apache项目团队取经</li>
</ul>
<p>开源的目的：</p>
<ul>
<li>加大曝光率，增强内部竞争优势：阿里内部有很多类似weex的东西</li>
<li>国际化</li>
<li>去掉商业背景，业界共享</li>
</ul>
<p>问题：</p>
<p>目前committer只有7个，而且都是阿里的。近一年内，只release了一次。</p>
<p>原因：</p>
<p>团队业务属性比较重，这种开发方式与apache这种社区的方式有些区别，JIRA上基本都是内部业务的，并没有跟apache社区的结合同步起来。文档更新不及时、版本划分不明晰等。</p>
<ul>
<li>单元测试质量与覆盖率</li>
</ul>
<h4 id="RocketMQ"><a href="#RocketMQ" class="headerlink" title="RocketMQ"></a>RocketMQ</h4><p>所有成功的开源项目，背后都是一个商业化公司在运营。</p>
<p>社区：reader、user，还有writer，负责宣传工具的好处。</p>
<p>有很多同质的项目，比如kafka。</p>
<p>社区要大、要建生态、定规范(方便同质产品的互操作)、商业化解决方案。</p>
<p>捐献项目(宽进严出)</p>
<ul>
<li>找导师，3位以上，其中一个是主席(activeMQ的相关人)，找对了champion，就成功了一半</li>
<li>找mentor</li>
<li>找proposer，项目的介绍，项目的承诺：不能孤立，人员多元化</li>
</ul>
<p>apache协议</p>
<ul>
<li>可以用或者改我的软件，告诉我改了哪儿？ 在license中说明</li>
<li>扩展协议要与apache协议兼容</li>
<li>用我的软件，出问题我不负责</li>
</ul>
<p>apache way（价值主张）</p>
<ul>
<li>社区大于产品</li>
<li>writer，就是社区运营</li>
<li>社区中每个人都是个体，不受任何人雇佣，没有任何上下级关系</li>
<li>社区的表彰是基于对社区的共享，持续关注并提交PR，就会被邀请成为commiter，然后负责更多的事情，一直到成为PMC</li>
</ul>
<p>流程</p>
<ul>
<li>apache license的扫描等</li>
<li>单元测试必须在3分钟之内做完。</li>
<li>集成测试，maven</li>
</ul>
<p>PR的模板</p>
<ul>
<li>简单告诉改动了什么</li>
<li>怎样验证此次改动</li>
</ul>
<h4 id="阿里类docker工具-pouch"><a href="#阿里类docker工具-pouch" class="headerlink" title="阿里类docker工具: pouch"></a>阿里类docker工具: pouch</h4><h5 id="隔离性"><a href="#隔离性" class="headerlink" title="隔离性"></a>隔离性</h5><p>docker容器内free -g，其实是宿主机的内存，但是java应用的内存分配是根据这个自动分配的，所以会有些问题。</p>
<p>基于磁盘和网络的隔离与限制</p>
<h5 id="仓库的p2p分发"><a href="#仓库的p2p分发" class="headerlink" title="仓库的p2p分发"></a>仓库的p2p分发</h5><p>降低各种客户端同时对registry进行pull或push等。P2P就是类迅雷的东西了，每个客户端也是一个服务端</p>
<p>##### </p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[slider对于app的要求]]></title>
      <url>/2017/12/05/slider%E5%AF%B9%E4%BA%8Eapp%E7%9A%84%E8%A6%81%E6%B1%82/</url>
      <content type="html"><![CDATA[<p>slider把app安装并运行在yarn上，但是app并不一定要是针对yarn定制的。</p>
<p>app应该是被slider发布，也就是yarn负责安装，slider负责配置，最后yarn负责执行。yarn会在销毁container的时候kill掉执行的进程，所以被部署的app应该知道这个，并能够在没有人工参与的前提下自动启动一个新的container运行自己的component。</p>
<p>app的component还应该能够自己动态发现其他的component，在启动和执行的时候都要能发现，因为后面server或者进程失败的话，也会导致component位置变化。</p>
<h4 id="must"><a href="#must" class="headerlink" title="must"></a>must</h4><ul>
<li>使用tar进行安装运行，而且运行用户不能是root</li>
<li>自包含或者所有的依赖都已经预装了</li>
<li>支持节点的动态发现，比如通过ZK</li>
<li>节点能够动态rebind自己，就是说如果即便节点被删除，app仍能继续运行</li>
<li>把kill作为通用机制处理</li>
<li>支持多个实例运行在同个集群中，不同app实例可以共享同一个server</li>
<li>当多个role实例被分配到同一个物理节点的时候，要能够正确操作。</li>
<li>安全可靠。yarn不会再sandbox中运行代码的</li>
<li>如果与HDFS交互，注意兼容性</li>
<li>持久化数据到HDFS，配置好文件位置。slider中每个app实例都需要有一个目录。</li>
<li>配置目录要可配置，最好不要是绝对路径</li>
<li>log输出不要是一个固定的位置</li>
<li>不明确让它停止，就一直跑下去。slider吧app的终止作为失败处理，会自动重启container。</li>
</ul>
<h4 id="must-not"><a href="#must-not" class="headerlink" title="must not"></a>must not</h4><ul>
<li>人工的启动和关闭</li>
</ul>
<h4 id="should"><a href="#should" class="headerlink" title="should"></a>should</h4><ul>
<li>发布一个RPC或者HTTP端口，可以通过zk或者admin API。slider会提供一个发布机制</li>
<li>可通过标准的hadoop机制进行配置：text、xml文件。不然，就需要自定义的解析器</li>
<li>支持明确的参数来指定配置目录</li>
<li>允许通过-D类似方式指定运行参数</li>
<li>不要运行复杂脚本</li>
<li>提供给slider获取集群节点和状态的方式，这样slider才能探测失败的worker节点并处理</li>
<li>启动的时候能够感知位置。</li>
<li>支持简单的探活，可以是http get</li>
<li>退出的时候返回一个可读的内容，方便针对性处理</li>
<li>支持集群大小调整</li>
<li>支持ambari类似的平台管理</li>
</ul>
<h4 id="may"><a href="#may" class="headerlink" title="may"></a>may</h4><ul>
<li>动态分配RPC或者web端口</li>
<li>包含一个单独的进程，运行在指定位置，这个进程一挂，就引起app终止。这样的进程也能运行在slider am的container中。如果一个活着的cluster不能处理这个进程的restart或者migration，这个slider app就不能处理slider am的restart</li>
<li>汇报load/cost</li>
</ul>
<h4 id="may-not"><a href="#may-not" class="headerlink" title="may not"></a>may not</h4><ul>
<li>yarn可写</li>
<li>纯java</li>
<li>支持动态配置</li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[slider上手]]></title>
      <url>/2017/12/05/slider%E4%B8%8A%E6%89%8B/</url>
      <content type="html"><![CDATA[<h4 id="前提"><a href="#前提" class="headerlink" title="前提"></a>前提</h4><ul>
<li>hadoop2.6+</li>
<li>HDFS,YARN,ZKK</li>
<li>JDK1.7</li>
<li>python 2.6</li>
<li>openssl</li>
</ul>
<h4 id="配置集群"><a href="#配置集群" class="headerlink" title="配置集群"></a>配置集群</h4><p>配置hadoop集群。</p>
<p>注意：debug设置为非0的能进行debug。如果使用一个vm或者一个sandbox，那么可以修改yarn配置，允许多个container在同一个host上。在yarn-site.xml中修改下面的配置</p>
<p>例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&lt;property&gt;</div><div class="line">  &lt;name&gt;yarn.scheduler.minimum-allocation-mb&lt;/name&gt;</div><div class="line">  &lt;value&gt;256&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line">&lt;property&gt;</div><div class="line">  &lt;name&gt;yarn.nodemanager.delete.debug-delay-sec&lt;/name&gt;</div><div class="line">  &lt;value&gt;3600&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div></pre></td></tr></table></figure></p>
<h4 id="下载slider"><a href="#下载slider" class="headerlink" title="下载slider"></a>下载slider</h4><h4 id="配置slider"><a href="#配置slider" class="headerlink" title="配置slider"></a>配置slider</h4><p>进入目录<code>slider-0.80.0-incubating/conf</code>后，编辑<code>slider-env.sh</code>文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">export JAVA_HOME=/usr/jdk64/jdk1.7.0_67</div><div class="line">export HADOOP_CONF_DIR=/etc/hadoop/conf</div></pre></td></tr></table></figure></p>
<p>如果运行在一个没有安装hadoop的节点上，只需要把相关配置放到相应目录就可以了。也可以通过<code>slider-clietn.xml</code>配置hadoop配置路径：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;property&gt;</div><div class="line">  &lt;name&gt;HADOOP_CONF_DIR&lt;/name&gt;</div><div class="line">  &lt;value&gt;/etc/hadoop/conf&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;property&gt;</div><div class="line">  &lt;name&gt;HADOOP_CONF_DIR&lt;/name&gt;</div><div class="line">  &lt;value&gt;$&#123;SLIDER_CONF_DIR&#125;/../hadoop-conf&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div></pre></td></tr></table></figure></p>
<p>对于一个没有nn HA和 RM HA的集群，修改slider-client.xml配置如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;property&gt;</div><div class="line">    &lt;name&gt;hadoop.registry.zk.quorum&lt;/name&gt;</div><div class="line">    &lt;value&gt;yourZooKeeperHost:port&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;yarn.resourcemanager.address&lt;/name&gt;</div><div class="line">    &lt;value&gt;yourResourceManagerHost:8050&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;yarn.resourcemanager.scheduler.address&lt;/name&gt;</div><div class="line">    &lt;value&gt;yourResourceManagerHost:8030&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div><div class="line">  &lt;property&gt;</div><div class="line">    &lt;name&gt;fs.defaultFS&lt;/name&gt;</div><div class="line">    &lt;value&gt;hdfs://yourNameNodeHost:8020&lt;/value&gt;</div><div class="line">  &lt;/property&gt;</div></pre></td></tr></table></figure></p>
<p>执行命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$&#123;slider-install-dir&#125;/slider-0.80.0-incubating/bin/slider version</div><div class="line"></div><div class="line">python %slider-install-dir%/slider-0.80.0-incubating/bin/slider.py version</div></pre></td></tr></table></figure></p>
<p>保证没有错误输出，那么slider就已经正确安装了。</p>
<h4 id="发布slider-resource"><a href="#发布slider-resource" class="headerlink" title="发布slider resource"></a>发布slider resource</h4><p>确保所有的文件目录都可以被app实例的创建者使用，我们这里使用yarn作为app创建者。</p>
<h5 id="确保HDFS-home存在"><a href="#确保HDFS-home存在" class="headerlink" title="确保HDFS home存在"></a>确保HDFS home存在</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">su hdfs</div><div class="line"></div><div class="line">hdfs dfs -mkdir /user/yarn</div><div class="line"></div><div class="line">hdfs dfs -chown yarn:hdfs /user/yarn</div></pre></td></tr></table></figure>
<h5 id="创建app包"><a href="#创建app包" class="headerlink" title="创建app包"></a>创建app包</h5><p>有几个简单的例子：</p>
<ul>
<li>app-packages/memcached-win</li>
<li>app-packages/hbase</li>
<li>app-packages/accumulo</li>
<li>app-packages/storm</li>
</ul>
<p>根据各个里面的README，创建一个或多个slider app。</p>
<h5 id="安装，配置，启动，验证"><a href="#安装，配置，启动，验证" class="headerlink" title="安装，配置，启动，验证"></a>安装，配置，启动，验证</h5><ul>
<li>安装<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">slider install-package --name *package name* --package *sample-application-package*</div></pre></td></tr></table></figure>
</li>
</ul>
<p>安装包会被发布到HDFS的<user home="" dir="">/.slider/package/<name provided="" in="" the="" command="">。</name></user></p>
<ul>
<li>创建。分两部分，一个是resource specification，另一个是app configuration<ul>
<li>resource specification。slider需要知道要部署多少component，需要多少CPU，内存。这些信息放在resources.json中。</li>
<li>application configuration。应用的配置信息，例如jvm堆大小等</li>
</ul>
</li>
<li><p>启动。通过cli启动的话</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd $&#123;slider-install-dir&#125;/slider-0.80.0-incubating/bin</div><div class="line">./slider create cl1 --template appConfig.json --resources resources.json</div></pre></td></tr></table></figure>
</li>
<li><p>验证。到yarn里，打开appmaster，看到slider app master</p>
</li>
</ul>
<h5 id="获取client配置"><a href="#获取client配置" class="headerlink" title="获取client配置"></a>获取client配置</h5><p>一个app发布几个用户的细节信息，用来管理app实例。</p>
<p>可以使用registry命令获取这些数据。</p>
<ul>
<li>发布的数据。在app master的/ws/v1/slider/publisher可以看到，通过slider-client status app1</li>
<li>client配置。/ws/v1/slider/publisher/slider/<config name=""></config></li>
<li>log位置。ws/v1/slider/publisher/slider/logfolders</li>
<li>一些监控UI, jmx终端等。/ws/v1/slider/publisher/slider/quicklinks</li>
</ul>
<h4 id="app生命周期管理"><a href="#app生命周期管理" class="headerlink" title="app生命周期管理"></a>app生命周期管理</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">./slider start/stop cl1</div><div class="line">./slider destroy</div><div class="line">./slider flex cl1 --component worker 5</div></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[slider架构概览]]></title>
      <url>/2017/12/05/slider%E6%9E%B6%E6%9E%84%E6%A6%82%E8%A7%88/</url>
      <content type="html"><![CDATA[<h4 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h4><p>slider是一个YARN application，用来部署非YARN的app到YARN集群中。</p>
<p>slider包含一个YARN application master，Slider AM，然后client application需要通过RPC或者HTTP与YARN和Slider AM进行通信。client application提供了命令行与low-level API，以供测试。</p>
<p>被部署的app应该是可以运行在YARN管理的server池中的程序，还要能动态定位到它自己的peer。slider并不负责配置这些peer server，只负责一些app指定的实例的配置初始化工作。</p>
<p>每个app实例都是一个或多个component，每个component可以有不同的程序或命令，不同的配置项或参数。</p>
<p>AM负责启动哪些具体的role，为每个component请求一个YARN container。然后监控app实例的状态，当一个远程执行的进程完成之后，YARN会通知到AM。然后AM就去部署这个component的下一个实例去了。</p>
<h4 id="slider打包"><a href="#slider打包" class="headerlink" title="slider打包"></a>slider打包</h4><p>slider一个重要的目标就是支持已经存在的APP部署到yarn上去</p>
<h4 id="AM架构"><a href="#AM架构" class="headerlink" title="AM架构"></a>AM架构</h4><p>AM包含：</p>
<ul>
<li>AM engine，负责处理所有的外部服务的整合，尤其是YARN和其他的slider client</li>
<li>provider，指定部署app的class</li>
<li>app的状态</li>
</ul>
<p>app状态是app实例的模型，包含：</p>
<ul>
<li>app实例一些期望的状态，比如每种component的实例数量，他们的YARN container内存等</li>
<li>当前实例在yarn集群中每种component的数据，包括每个node上的可用资源</li>
<li>role history。记录每个node都被部署过哪种component，后面可以还这样部署。这是为了在需要读写本地磁盘的时候不出问题。</li>
<li>追踪消息队列：请求、发布、启动节点</li>
</ul>
<p>app engine整合了所有外部的东西：YARN RM， 指定node的NM，接受来自RM的service，request，释放container的event，在分配的container上启动app。</p>
<p>集群中发生任何变化，都会发送通知，然后app engine把通知传递给App的Status类，Status类更新它的状态，返回一系列集群操作(请求不同类型的container， 可能会指定节点，或者请求释放container)，供提交。</p>
<p>有了这些之后，再加上分配消息，app engine就可以把app State分配给指定的组件了，然后出发provider构建app的启动context。</p>
<p>provider有带有用于启动provider支持的程序的文件关联、环境变量、命令，用以发布container。</p>
<p>core provider在目标container上部署一个minimal 的agent，然后这个agent会计入agent provider的REST API， 执行它的命令。</p>
<p>这个agnet要执行的命令主要是从HDFS下载归档文件，解压开，运行python脚本来执行真正的配置，最后就是目标的执行了。这里面会用到很多模板。</p>
<p>总结一下：slider不是一个典型的YARN analysis app，YARN analysis app是指在短期、中期生命的container中分配和调度工作，带有一个query或者analysis session的一个生命周期，slider的生命周期是长达几天或者几个月的。slider要是app集群保持某个状态，app也应该能在node失败后进行恢复，还有就是定位到自己的peer node，再有就是与HDFS文件系统的数据进行交互。</p>
<p>Samza是第一个被设计运行在yarn上的app，它作为一个平台或者long-live 服务存在。这些app对yarn的需求是不一样的，他们的application master的设计主要集中在维护分布式app在一个稳定的状态，而不是提交什么作业。</p>
<p>MVC的切分实现了mode与aid mock测试的隔离性，增强了slider能够在YARN上部署更大规模的信息。</p>
<h4 id="失败模型"><a href="#失败模型" class="headerlink" title="失败模型"></a>失败模型</h4><p>app master被设计为一个<a href="https://www.usenix.org/legacy/events/hotos03/tech/full_papers/candea/candea.pdf" target="_blank" rel="external"> crash-only application</a>, client是随时可以直接请求YARN来终止app实例的。</p>
<p>有一个RPC方法可以停掉app实例。这个是挺好的，会记录一条message在日志里，以后可能还会给provider警告一下这个app实例要被关掉了。这也有一定潜在的危险，以你为provider实现里可能开始期望这个方法被可靠调用。slider的设计是失败不会告警，而是基于配置进行重新构建，可以被人工停止。</p>
<h4 id="RPC-接口"><a href="#RPC-接口" class="headerlink" title="RPC 接口"></a>RPC 接口</h4><p>RPC接口允许client查询当前app的状态，也能通过json请求进行更新。</p>
<p>主要操作有：</p>
<ul>
<li>getJSONClusterStatus(): 获取app实例的json状态输出</li>
<li>flexCluster(): 更新调整不同component的数量</li>
<li>stopCluster </li>
</ul>
<p>还有一些其他更low-level的操作供我们进行诊断、测试，但是比较有限。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[在yarn上安装presto]]></title>
      <url>/2017/12/04/%E5%9C%A8yarn%E4%B8%8A%E5%AE%89%E8%A3%85presto/</url>
      <content type="html"><![CDATA[<h4 id="前置条件"><a href="#前置条件" class="headerlink" title="前置条件"></a>前置条件</h4><ul>
<li>hdp 2.2+ 或者CDH5.4+</li>
<li>slider 0.80.0+</li>
<li>jdk 1.8</li>
<li>zookeeper</li>
<li>openssl &gt;= 1.0.1e-16</li>
<li>ambari 2.1</li>
</ul>
<h4 id="presto安装目录结构"><a href="#presto安装目录结构" class="headerlink" title="presto安装目录结构"></a>presto安装目录结构</h4><p>使用ambari slider view安装基于yarn的presto集群的时候，安装目录与标准的是不一样的。</p>
<p>如果使用slider脚本或者ambari slider view来部署presto到yarn上的话，presto是会使用presto server的tar包的形式进行安装的(不是通过rpm)。当yarn app启动后，可发现presto server安装在yarn上的nodemanager的<code>yarn.nodemanager.local-dirs</code>。例如，配置<code>yarn.nodemanager.local-dirs</code>为<code>/mnt/hadoop/nm-local-dirs</code>，且<code>app_user</code>配置为<code>yarn</code>，那么就安装在<code>/mnt/hadoop-hdfs/nm-local-dir/usercache/yarn/appcache/application_&lt;id&gt;/container_&lt;id&gt;/app/install/presto-server-&lt;version&gt;</code>。container_id之前的部分在slider中叫做AGENT_WORK_ROOT，也就是说<code>AGENT_WORK_ROOT/app/install/presto-server-&lt;version&gt;</code>。</p>
<p>通常，使用tar安装的presto，catalog、plugin、lib目录等都在presto-server主目录下。catalog目录在<code>AGENT_WORK_ROOT/app/install/presto-server-&lt;version&gt;/etc/catalog</code>, plugin和lib目录在<code>AGENT_WORK_ROOT/app/install/presto-server-&lt;version&gt;/plugin</code>和<code>AGENT_WORK_ROOT/app/install/presto-server-&lt;version&gt;/lib</code>.启动脚本在<code>AGENT_WORK_ROOT/app/install/presto-server-&lt;version&gt;/bin</code>.</p>
<p>presto日志是基于数据目录的配置的。</p>
<p>参考：<a href="https://prestodb.io/presto-yarn/installation-yarn-directory-structure.html" target="_blank" rel="external">https://prestodb.io/presto-yarn/installation-yarn-directory-structure.html</a></p>
<h4 id="presto配置"><a href="#presto配置" class="headerlink" title="presto配置"></a>presto配置</h4><p>安装过程中，ambari slider view允许你进行配置。</p>
<p>如果使用mabri进行安装，可以通过UI配置，如果是手动安装的话，就自己编辑配置文件。</p>
<p>主要配置文件为appConfig.json和resources-[singlenode|multinode].json，需要在运行presto之前配置好。在下面提出的位置有样例配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">presto-yarn-package/src/main/resources</div></pre></td></tr></table></figure></p>
<p><code>presto-yarn-package/src/main/resources/appConfig.json</code>和<code>presto-yarn-package/src/main/resources/resources-multinode.json</code>是对应的默认配置。</p>
<h5 id="appConfig-json"><a href="#appConfig-json" class="headerlink" title="appConfig.json"></a>appConfig.json</h5><ul>
<li>site.global.app_user。 默认是yarn，启动presto的用户。确认app_user要有一个HDFS home目录。如果要访问hive的话，也要确认这个app_user有相应的权限</li>
<li>site.global.user_group。默认是hadoop</li>
<li><p>site.global.data_dir。默认是<code>/var/lib/presto/data</code>，presto的数据目录，应该在启动之前就存在，并且是属于app_user，否则slider就会因权限问题不能启动了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mkdir -p /var/lib/presto/data</div><div class="line">chown -R yarn:hadoop /var/lib/presto/data</div></pre></td></tr></table></figure>
</li>
<li><p>site.global.config_dir,默认是/var/lib/presto/etc。presto配置文件所在的目录，包含node.properties, jvm.config, config.properties以及connector配置文件等。这些文件会从模板<code>presto-yarn-package/package/templates/*.j2</code>和相关appConfig.json的参数生成。</p>
</li>
<li>site.global.singlenode。默认true，当前node既做为coordinator也作为worker。</li>
<li>site.global.presto_query_max_memory。在config.properties文件中是query.max_memroy，默认50G.</li>
<li>site.global.presto_query_max_memory_per_node，默认1G</li>
<li>site.global.presto_server_port，默认8080</li>
<li>site.global.catalog.默认是tpch connector。这个是用来配置presto的connector的。应该对应于非基于yarn的presto集群的connector.properites。格式一般为：<code>{‘connector1’ : [‘key1=value1’, ‘key2=value2’..], ‘connector2’ : [‘key1=value1’, ‘key2=value2’..]..}.</code>。这个会创建connector1.properties, connector2.properties两个配置文件，带有不同的entry。看一个hive.properties的例子<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&quot;site.global.catalog&quot;: &quot;&#123;&apos;hive&apos;: [&apos;connector.name=hive-cdh5&apos;, &apos;hive.metastore.uri=thrift://$&#123;NN_HOST&#125;:9083&apos;], &apos;tpch&apos;: [&apos;connector.name=tpch&apos;]&#125;&quot;</div></pre></td></tr></table></figure>
</li>
</ul>
<p>这里的NN_HOST运行时会被替换成NN的地址，如果hive metastore跟NN没在一起，需要自己修改一下。</p>
<ul>
<li><p>site.global.jvm_args。这个是生成presto的jvm.properties文件的，默认是heapsize是1G.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&quot;site.global.jvm_args&quot;: &quot;[&apos;-server&apos;, &apos;-Xmx1024M&apos;, &apos;-XX:+UseG1GC&apos;, &apos;-XX:G1HeapRegionSize=32M&apos;, &apos;-XX:+UseGCOverheadLimit&apos;, &apos;-XX:+ExplicitGCInvokesConcurrent&apos;, &apos;-XX:+HeapDumpOnOutOfMemoryError&apos;, &apos;-XX:OnOutOfMemoryError=kill -9 %p&apos;]&quot;,</div></pre></td></tr></table></figure>
</li>
<li><p>site.global.log_properties. 配置presto的日志级别默认是<code>[‘com.facebook.presto=INFO’]</code>。应该是一行一个表达式。例子</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&quot;site.global.log_properties&quot;: &quot;[&apos;com.facebook.presto.hive=WARN&apos;, &apos;com.facebook.presto.server=INFO&apos;]&quot;</div></pre></td></tr></table></figure>
</li>
<li><p>site.global.additional_node_properties和site.global.additional_config_properties。</p>
</li>
<li><p>site.global.plugin</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&quot;site.global.plugin&quot;: &quot;&#123;&apos;ml&apos;: [&apos;presto-ml-$&#123;presto.version&#125;.jar&apos;]&#125;&quot;,</div></pre></td></tr></table></figure>
</li>
<li><p>site.global.app_name</p>
</li>
<li>application.def. 对于slider用户，安装presto的命令运行的时候，日志会打印出这个参数。如果不是自定义的presto包，不必理会这个参数。</li>
<li>java_home ， 默认是/usr/lib/jvm/java</li>
<li>appConfig.json里的类似${COORDINATOR_HOST}, ${AGENT_WORK_ROOT}的变量是在运行时确认的。</li>
</ul>
<h5 id="resources-json"><a href="#resources-json" class="headerlink" title="resources.json"></a>resources.json</h5><p>这个配置可以对应于全局，也可以针对每个组件</p>
<ul>
<li>yarn.vcores: 默认是全局的，-1</li>
<li>yarn.component.instances，默认coordinator是-1，worker是3.多节点模式下的例子配置中<code>presto-yarn-package/src/main/resources/resources-multinode.json</code>是1个coordinator，3个worker。他们的分布有着较严格的策略，每个node上只会运行一个实例。当节点数不够申请的worker时，这个app就会失败。如果都用作presot节点的话，那么worker的数量应该是集群中的nodemanager数量 -1 ，留一个作为coordinator。</li>
<li>yarn.memory。默认1500M，是site.global.jvm_args的-Xmx参数，被presto的jvm所使用的。slider推荐要比这个大一些。yarn.memory应该比任何jvm申请的堆都要大一丢丢，推荐最少大50%。</li>
<li>yarn.label.expression. coordinator或者worker。</li>
</ul>
<p>参考：<a href="https://prestodb.io/presto-yarn/installation-yarn-configuration-options.html" target="_blank" rel="external">https://prestodb.io/presto-yarn/installation-yarn-configuration-options.html</a></p>
<h4 id="使用ambari-slider-view-安装基于yarn的presto集群"><a href="#使用ambari-slider-view-安装基于yarn的presto集群" class="headerlink" title="使用ambari slider view 安装基于yarn的presto集群"></a>使用ambari slider view 安装基于yarn的presto集群</h4><ol>
<li>安装ambari server</li>
<li>下载slider包</li>
<li>把presto包copy到ambari server的<code>/var/lib/ambari-server/resources/apps/</code>路径下</li>
<li>重启ambari-server</li>
<li>登陆ambari</li>
<li>安装基础组件：HDFS, YARN, Zk， Slider等</li>
<li>保证slider-env.sh里已经指定了JAVA_HOME和HADOOP_CONF_DIR。</li>
<li>对于zk，如果不是安装在/usr/lib/zookeeper:<ul>
<li>在slider配置里添加zk.home配置变量</li>
<li>如果不是2181端口，添加slider.zookeeper.quorum配置</li>
</ul>
</li>
<li>启动服务，到ambari创建slider view，然后创建app</li>
<li>提供presto服务的相关配置细节，UI会提供一些默认参数。</li>
<li>app名字应该是小写的：presto1</li>
<li>配置</li>
<li>准备slider的HDFS目录，这个根据global.app_user来的。</li>
<li>修改global.presto_server_port为8080之外的其他端口，以免跟ambari srever冲突</li>
<li>预创建所有节点上的数据目录<code>var/lib/presto</code>，可以自己修改</li>
<li>其他自定义配置</li>
<li>完成。这个动作相当于在bin/slider脚本执行package –install和create，然后就可以看到presto已经在yarn上运行起来了。<ul>
<li>从slider view监控运行状态</li>
<li>Quick Links，观察yarn UI</li>
</ul>
</li>
<li>如果job失败，可以到对应节点上找日志看</li>
<li>可以在View界面管理app的生命周期(start, stop, fliex, destory)。</li>
</ol>
<h4 id="手动使用slider安装presto集群"><a href="#手动使用slider安装presto集群" class="headerlink" title="手动使用slider安装presto集群"></a>手动使用slider安装presto集群</h4>]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[tez笔记]]></title>
      <url>/2017/11/27/tez%E7%AC%94%E8%AE%B0/</url>
      <content type="html"><![CDATA[<ol>
<li>部署hadoop2.7以上版本</li>
<li>构建tez<code>mvn clean package -DskipTests=true -Dmaven.javadoc.skip=true</code><ul>
<li>JDK8, MAVEN 3</li>
<li>protocol buffer 2.5.0</li>
<li>如果使用单元测试，把skipTests去掉就行</li>
<li>如果使用eclipse，可以使用import maven project引入。</li>
</ul>
</li>
<li>把对应的tez包copy到HDFS，配置tez-site.xml</li>
</ol>
<ul>
<li>tez包包含tez和hadoop的类库，tez-dist/tez-x.y.z-SNAPSHOT.tar.gz</li>
<li><p>假设tez放在了HDFS的/apps下，命令如下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hadoop fs -mkdir /apps/tez-x.y.z-SNAPSHOT</div><div class="line">hadoop fs -copyFromLocal tez-dist/target/tez-x.y.z-SNAPSHOT.tar.gz /apps/tez-x.y.z-SNAPSHOT</div></pre></td></tr></table></figure>
</li>
<li><p>tez-site.xml配置</p>
<ul>
<li>设置<code>tez.lib.uris</code>指定HDFS上的tar.gz的位置。假设是上面的话，就设置成<code>${fs.defaultFS}/apps/tez-x.y.z-SNAPSHOT/tez-x.y.z-SNAPSHOT.tar.gz</code></li>
<li>确认<code>tez.cluster.hadoop-libs</code>没有在tez-site.xml中设置，这个值应该是false</li>
</ul>
</li>
<li>注意tar包版本应该与用来提交tez job的客户端版本一致。</li>
</ul>
<ol>
<li>可选的：如果在tez上运行已经存在的MR任务，修改mapred-site.xml，修改mapreduce.framework.name, 从yarn修改为yarn-tez.</li>
<li>配置client节点，把tez类库加入到hadoop类库中。</li>
</ol>
<ul>
<li>抽取tez最小的tar包到本地目录</li>
<li>设置TEZ_CONF_DIR为tez-site.xml的位置</li>
<li><p>添加$TEZ_CONF_DIR，${TEZ_JARS}/<em>和${TEZ_JARS}/lib/</em>到app的classpath。例如通过标准hadoop工具链设置的话：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">export HADOOP_CLASSPATH=$&#123;TEZ_CONF_DIR&#125;:$&#123;TEZ_JARS&#125;/*:$&#123;TEZ_JARS&#125;/lib/*</div></pre></td></tr></table></figure>
</li>
<li><p>注意 <code>*</code>是必须的</p>
</li>
</ul>
<ol>
<li>下面是一个提交MR任务的例子：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$HADOOP_PREFIX/bin/hadoop jar tez-examples.jar orderedwordcount &lt;input&gt; &lt;output&gt;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>这个会使用tez dag ApplicationMaster来运行wordcount job。这个wordcount相比简单的，多了个按照词频顺序输出。</p>
<p>Tez DAG可以分别运行在不同的app上，使用同一个TEZ session就可以了。tez-tests中有一个odrderedwordcount是支持session的使用的，同时处理多个input-output pairs。可以在不同的input/output上连续运行多个DAG。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$HADOOP_PREFIX/bin/hadoop jar tez-tests.jar testorderedwordcount &lt;input1&gt; &lt;output1&gt; &lt;input2&gt; &lt;output2&gt; &lt;input3&gt; &lt;output3&gt; ...</div></pre></td></tr></table></figure>
<p>上面的例子就会为每个input-output pair运行多个DAG了。</p>
<p>要使用tez session的话，设置 -DUSE_TEZ_SESSION=true<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$HADOOP_PREFIX/bin/hadoop jar tez-tests.jar testorderedwordcount -DUSE_TEZ_SESSION=true &lt;input1&gt; &lt;output1&gt; &lt;input2&gt; &lt;output2&gt;</div></pre></td></tr></table></figure></p>
<ol>
<li>像平时一样提交一个MR任务<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$HADOOP_PREFIX/bin/hadoop jar hadoop-mapreduce-client-jobclient-3.0.0-SNAPSHOT-tests.jar sleep -mt 1 -rt 1 -m 1 -r 1</div></pre></td></tr></table></figure>
</li>
</ol>
<p>这会使用TEZ DAG ApplicationMaster来运行MR job。可以通过查看YARN UI上的AM的log来验证一下。记住，mapred-site.xml里的mapreduce.framework.name需要设置成yarn-tez。</p>
<h4 id="指定tez-lib-uris的几种方式"><a href="#指定tez-lib-uris的几种方式" class="headerlink" title="指定tez.lib.uris的几种方式"></a>指定tez.lib.uris的几种方式</h4><p>tez.lib.uris属性支持逗号分隔的多个值，可以是单个文件，一个目录，压缩包(tar,zip等)。</p>
<p>对于文件和目录，tez会把第一层的文件放到tez运行时的工作目录中，然后放入classpath。对于压缩文件，会被解压到工作目录中。</p>
<h4 id="hadoop依赖安装"><a href="#hadoop依赖安装" class="headerlink" title="hadoop依赖安装"></a>hadoop依赖安装</h4><p>上面的使用tez的方式，也就是预装在hadoop类库中是我们推荐的方式。带有所有依赖的完整的tar包是一个更好的方式，可以保证已经存在的job在集群回滚或者升级的时候继续正常运行。</p>
<p>尽管<code>tez.lib.uris</code>配置项有很广泛的使用模型，但是还有两个主要的可选模式:</p>
<ul>
<li>A： 在hadoop类库可用的集群上使用tez tar包</li>
<li><p>B： 与hadoop tar包一起使用tez tar包</p>
<p>这两个模式需要一个没有hadoop依赖而编译地的tez，可以是tez-dist/target/tez-x.y.z-minimal.tar.gz。</p>
<h4 id="对于模式A：通过yarn-application-classpath使用集群已有的hadoop类库"><a href="#对于模式A：通过yarn-application-classpath使用集群已有的hadoop类库" class="headerlink" title="对于模式A：通过yarn.application.classpath使用集群已有的hadoop类库"></a>对于模式A：通过yarn.application.classpath使用集群已有的hadoop类库</h4><p>对于使用rolling  upgrade的集群不推荐这种方式。另外，用户需要负责保证tez版本与正在运行集群的hadoop的兼容性。对于上面的第三个步骤，也需要修改。后续的步骤应该使用tez-dist/target/tez-x.y.z-minimal.tar.gz而不是tez-dist/target/tez-x.y.z.tar.gz。</p>
<ul>
<li><p>如果tez jar已经放在了HDFS的/apps里，那么minimal的tez就可以运行了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"> &quot;hadoop fs -mkdir /apps/tez-x.y.z&quot;</div><div class="line">&quot;hadoop fs -copyFromLocal tez-dist/target/tez-x.y.z-minimal.tar.gz /apps/tez-x.y.z&quot;</div></pre></td></tr></table></figure>
</li>
<li><p>tez-site.xml配置</p>
<ul>
<li>设置tez.lib.uris为hdfs包含tez jar的位置。</li>
<li>设置tez.use.cluster.hadoop-libs为true</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="对于模式B：带有hadoo-tar包的tez-tar包"><a href="#对于模式B：带有hadoo-tar包的tez-tar包" class="headerlink" title="对于模式B：带有hadoo tar包的tez  tar包"></a>对于模式B：带有hadoo tar包的tez  tar包</h4><p>这个模式是支持rolling upgrade的。但是用户需要确认自己选择的tez和hadoop版本兼容。也需要修改第三步：</p>
<ul>
<li><p>假设tez的压缩包在HDFS的/apps下</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hadoop fs -mkdir /apps/tez-x.y.z </div><div class="line">hadoop fs -copyFromLocal tez-dist/target/tez-x.y.z-minimal.tar.gz /apps/tez-x.y.z</div></pre></td></tr></table></figure>
</li>
<li><p>或者，可以把minimal目录直接放到HDFS，然后再把每个jar包放进去。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hadoop fs -copyFromLocal tez-dist/target/tez-x.y.z-minimal/* /apps/tez-x.y.z</div></pre></td></tr></table></figure>
</li>
<li><p>构建完hadoop之后，hadoop tar包在hadoop/hadoop-dist/target/hadoop-x.y.z-SNAPSHOT.tar.gz</p>
</li>
<li><p>假设hadoop jar包放在了HDFS上的/apps里</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hadoop fs -mkdir /apps/hadoop-x.y.z</div><div class="line">hadoop fs -copyFromLocal hadoop-dist/target/hadoop-x.y.z-SNAPSHOT.tar.gz /apps/hadoop-x.y.z</div></pre></td></tr></table></figure>
</li>
<li><p>tez-site.xml的配置</p>
<ul>
<li>tez.lib.uris只想tez/hadoop需要的jar或者归档文件所在位置</li>
<li>例子：当时用tez和hadoop归档文件时，设置tez.lib.uris为<code>${fs.defaultFS}/apps/tez-x.y.z/tez-x.y.z-minimal.tar.gz#tez,${fs.defaultFS}/apps/hadoop-x.y.z/hadoop-x.y.z-SNAPSHOT.tar.gz#hadoop-mapreduce</code></li>
<li>例子：当时用带有hadoop归档文件的tezjar的时候，设置tez.lib.uris为<code>${fs.defaultFS}/apps/tez-x.y.z,${fs.defaultFS}/apps/tez-x.y.z/lib,${fs.defaultFS}/apps/hadoop-x.y.z/hadoop-x.y.z-SNAPSHOT.tar.gz#hadoop-mapreduce</code></li>
<li>在tez.lib.uris中，跟在<code>#</code>后面的文档会自动创建对应的fragment 链接。如果没有给出fragment，那么链接就被设置为归档的名字。fragment不应该是目录或者jar</li>
<li>如果在tez.lib.uris中指定了任何归档，就也要设置tez.lib.uris.classpath，定义好这些归档文件的classpath，因为归档文件结构是未知的。</li>
<li><p>例子：当使用tez和hadoop归档时，设置tez.lib.uris.classpath：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./tez/*:./tez/lib/*:./hadoop-mapreduce/hadoop-x.y.z-SNAPSHOT/share/hadoop/common/*:./hadoop-mapreduce/hadoop-x.y.z-SNAPSHOT/share/hadoop/common/lib/*:./hadoop-mapreduce/hadoop-x.y.z-SNAPSHOT/share/hadoop/hdfs/*:./hadoop-mapreduce/hadoop-x.y.z-SNAPSHOT/share/hadoop/hdfs/lib/*:./hadoop-mapreduce/hadoop-x.y.z-SNAPSHOT/share/hadoop/yarn/*:./hadoop-mapreduce/hadoop-x.y.z-SNAPSHOT/share/hadoop/yarn/lib/*:./hadoop-mapreduce/hadoop-x.y.z-SNAPSHOT/share/hadoop/mapreduce/*:./hadoop-mapreduce/hadoop-x.y.z-SNAPSHOT/share/hadoop/mapreduce/lib/*</div></pre></td></tr></table></figure>
</li>
<li><p>例子：当使用tez jar和hadoop归档文件时，设置tez.lib.uris.classpath为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./hadoop-mapreduce/hadoop-x.y.z-SNAPSHOT/share/hadoop/common/*:./hadoop-mapreduce/hadoop-x.y.z-SNAPSHOT/share/hadoop/common/lib/*:./hadoop-mapreduce/hadoop-x.y.z-SNAPSHOT/share/hadoop/hdfs/*:./hadoop-mapreduce/hadoop-x.y.z-SNAPSHOT/share/hadoop/hdfs/lib/*:./hadoop-mapreduce/hadoop-x.y.z-SNAPSHOT/share/hadoop/yarn/*:./hadoop-mapreduce/hadoop-x.y.z-SNAPSHOT/share/hadoop/yarn/lib/*:./hadoop-mapreduce/hadoop-x.y.z-SNAPSHOT/share/hadoop/mapreduce/*:./hadoop-mapreduce/hadoop-x.y.z-SNAPSHOT/share/hadoop/mapreduce/lib/*</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hive2-LLAP]]></title>
      <url>/2017/11/27/hive2-LLAP/</url>
      <content type="html"><![CDATA[<p>Live Long And Process。</p>
<h4 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h4><p>最近几年，有了tez和CBO等机制，hive的运行速度与特性已经有了很大提升。这次2.0又把hive带入了一个新的level</p>
<ul>
<li>异步spindle-aware的IO</li>
<li>预抽取column chunk，缓存column chunk</li>
<li>多线程JIT友好的operator pipeline</li>
</ul>
<p>上面的特性就是LLAP提供的了，LLAP提供了一个混合引擎模型。它包含了一个长期存在的daemon，替代直接与HDFS的Datanode交互。还有一个与DAG紧密结合的framework。对于缓存、字段pre-fetching、query的执行与ACL都被移动到了daemon中。small/short的query大部分都会被送到这个daemon直接处理，其他稍微重一些的操作都会被YARN的container运行。</p>
<p>跟DataNode类似，LLAP deamon也可以被其他的app使用，尤其是基于文件处理的关系型数据view。这个daemon也提供了可选的API(例如InputFormat)，供其它数据处理框架作为一个构建的block。</p>
<p>最后，细粒度的字段级别的acl在这个model中也得到了完美的呈现。</p>
<p>下图显示了LLAP的一个执行样例。Tez AM负责整体的编排工作。query的初始化stage被push给了LLAP。reduce stage，大的shuffle操作是在几个container中执行的。多个查询和app可以并发访问LLAP。</p>
<p><img src="https://cwiki.apache.org/confluence/download/attachments/62689557/LLAP_diagram.png?version=1&amp;modificationDate=1474327021000&amp;api=v2" alt=""></p>
<h4 id="持久化daemon"><a href="#持久化daemon" class="headerlink" title="持久化daemon"></a>持久化daemon</h4><p>为了进一步优化缓存和JIT，还有能够更好的估算startup耗时等，集群中的worker节点上都会有一个daemon。这个daemon处理IO,缓存，query分片的执行。</p>
<ul>
<li>所有的node都是无状态的。任何发送给LLAP节点的request都包含数据的位置和元信息。可以是本地的位置，也可以是远程的，数据本地化是调用者需要考虑的事情(YARN)</li>
<li>recovery/resilency。失败和恢复都很简单，因为任何数据家电都可以用来处理输入数据的任何分片。Tez AM只需要简单的重新运行失败的分片即可。</li>
<li>节点间沟通。LLAP节点之间可以共享数据(例如抽取partition数据，广播数据分片等)。实现方式与Tez中一样的。</li>
</ul>
<h5 id="执行引擎"><a href="#执行引擎" class="headerlink" title="执行引擎"></a>执行引擎</h5><p>LLAP和已经存在的，基于过程的hive引擎是可以兼容的，保留了hive的可扩展性和广泛性。它并没有取代已经存在的执行模型，而是对其进行增强。</p>
<ul>
<li>daemon是可选的。在没有这些daemon的时候，hive仍然是可运行的。</li>
<li>外部编排和执行引擎。LLAP并不是一个像Tez或者MR的执行引擎。所有的执行都是被已经存在的hive执行引擎（比如tez）在LLAP节点上进行调度与监控的，跟普通的container一样。显然，LLAP级别的支持是基于每个执行引擎(目前是tez)的。MR的支持并没有计划，但是其他的引擎有可能会在后面也加入进来。其他的框架，例如pig，也可以选择使用LLAP daemon。</li>
<li>部分执行。LLAP daemon的执行结果可以说某个hive query的结果的一部分，也可以传递给外部的hive task，这个取决于具体的query</li>
<li>资源管理。YARN仍然负责资源的管理与分发。yarn container delegation被用来允许分配资源给LLAP。为了避免jvm内存设置的初始化，缓存的数据是放在off-heap的，大的buffer也是(比如groupby，join等操作)。通过这种方案，daemon可以只是用很小的内存，其他资源(CPU,内存等)会根据负载进行分发。</li>
</ul>
<h4 id="query-fragment执行"><a href="#query-fragment执行" class="headerlink" title="query fragment执行"></a>query fragment执行</h4><p>LLAP节点会执行一些query分片，比如filter，projection，数据转化，部分聚合，排序，分桶，hash join/semi-join等。在LLAP中只接受hive代码和udf。没有任何代码是可以在运行时生成和执行的。这是出于稳定性和安全性的考虑。</p>
<ul>
<li>并发执行。一个LLAP节点允许不同query和session 的多个查询分片的并发执行。</li>
<li>interface。用户可以通过client API直接访问LLAP节点。他们可以指定关系转化，然后通过面向record的stream进行数据读取。</li>
</ul>
<h4 id="IO"><a href="#IO" class="headerlink" title="IO"></a>IO</h4><p>daemon摆脱了压缩格式处理的IO，这些工作交给其他独立的线程。数据在就绪的时候会被传递给execution，就是说前一批数据正在被处理的同时，就可以准备下一批了。数据是以简单的RLE编码的列式格式传递给execution的，主要是为了后面方便进行vectorized processiong【向量化处理？】。这也是缓存的格式，可以减小IO，缓存，execution之间的copy流量。</p>
<ul>
<li>多种文件格式。IO和缓存依赖于已经存在的文件格式(越高效越好)。因此，和vectorization工作类似，不同的文件格式都会通过插件形式被支持(目前是ORC)。另外，一个通用的，不那么搞笑的插件也可以加进来支持任意的hive输入格式。这些插件必须负责持有元信息，并且把原始数据转化到column chunk。</li>
<li>预测和bloom filter。SARGs和bloom filter是会被push down到存储层的。</li>
</ul>
<h4 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h4><p>daemon会缓存输入文件和数据的元数据。即便数据还没有缓存，元数据和索引信息也是可以先缓存起来的。元数据是以java object的形式存在进程的，缓存的数据是根据<a href="https://cwiki.apache.org/confluence/display/Hive/LLAP#LLAP-I/O" target="_blank" rel="external">IO部分</a>的指定形式，保存在off-heap的。</p>
<ul>
<li>驱逐策略【eviction policy】。取出策略是为了调优负载，应对频繁的表扫面的。初始阶段，是使用了LRFU的简单策略。这个策略是可插拔的。</li>
<li>缓存粒度。column-chunk是缓存数据的基本单位。这是在低开销的处理与高效存储之间的一个权衡。chunk的粒度取决于文件格式和执行引擎了。(Vectorized Row Batch Size, ORC stripe等)</li>
</ul>
<p>bloomfilter会自动创建，以提供动态运行时过滤。</p>
<h4 id="workload管理"><a href="#workload管理" class="headerlink" title="workload管理"></a>workload管理</h4><p>YARN用来获取不同workload的资源。某个workload一旦获取到yarn分配的资源之后，这个执行引擎就可以选择把资源代理给LLAP，或者在单独的进程里启动hive executor。通过YARN的资源管理保证了节点不会过载运行，不管是因为LLAP或者其他container。daemon本身也是在YARN的控制之下的。</p>
<h4 id="ACID支持"><a href="#ACID支持" class="headerlink" title="ACID支持"></a>ACID支持</h4><p>LLAP是事务感知的。在数据放入缓存之前，将delta文件合并，可以生成一个table的特定的state。如果有多版本，可以在请求中指定使用哪个版本。这样的好处是可以异步merge，而且只用cache一次数据，从而避免了operator pipeline的攻击。</p>
<h4 id="安全"><a href="#安全" class="headerlink" title="安全"></a>安全</h4><p>LLAP server是一个很自然的就可以进行acl的地方，比per-file的控制粒度还要细。因为LLAP的daemon知道当前要处理的column和record，所有针对这俩东西的策略都可以在这里实施。这并不会替代已有的安全机制，但是会有所增强，也可以提供给其他框架使用。</p>
<h4 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h4><p>LLAP监控的配置是存储在resources.json， appConfig.json， metainfo.xml，都会存在于slider的templates.py中。</p>
<p>LLAP monitor daemon也运行在YARN container中，跟LLAP Daemon一样，而且默认监听同样的端口。</p>
<p>LLAP Metric Collection Server从所有的LLAP Daemon周期性地收集JMX metric</p>
<p>LLAP daemon列表是在启动集群的zookeeper中抽取的。</p>
<h4 id="web-service"><a href="#web-service" class="headerlink" title="web service"></a>web service</h4><ul>
<li>json jmx数据 - /jmx</li>
<li>jvm stack trace - /stacks</li>
<li>LLAP daemon的xml配置 - /conf</li>
<li>LLAP status - /status</li>
<li>LLAP Peers - /peers</li>
</ul>
<h4 id="在slider上部署"><a href="#在slider上部署" class="headerlink" title="在slider上部署"></a>在slider上部署</h4><p>LLAP可以通过slider进行部署，绕过了节点安装与相关复杂处理</p>
<h4 id="LLAP-status"><a href="#LLAP-status" class="headerlink" title="LLAP status"></a>LLAP status</h4><p><a href="https://issues.apache.org/jira/browse/AMBARI-16149" target="_blank" rel="external">ambari相关</a>介绍了LLAP ap的状态，在hiveserver2中可用了。</p>
<p>例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">/current/hive-server2-hive2/bin/hive --service llapstatus --name &#123;llap_app_name&#125; [-f] [-w] [-i] [-t]</div><div class="line">-f,--findAppTimeout &lt;findAppTimeout&gt;                 Amount of time(s) that the tool will sleep to wait for the YARN application to start. negative values=wait</div><div class="line">                                                     forever, 0=Do not wait. default=20s</div><div class="line">-H,--help                                            Print help information</div><div class="line">   --hiveconf &lt;property=value&gt;                       Use value for given property. Overridden by explicit parameters</div><div class="line">-i,--refreshInterval &lt;refreshInterval&gt;               Amount of time in seconds to wait until subsequent status checks in watch mode. Valid only for watch mode.</div><div class="line">                                                     (Default 1s)</div><div class="line">-n,--name &lt;name&gt;                                     LLAP cluster name</div><div class="line">-o,--outputFile &lt;outputFile&gt;                         File to which output should be written (Default stdout)</div><div class="line">-r,--runningNodesThreshold &lt;runningNodesThreshold&gt;   When watch mode is enabled (-w), wait until the specified threshold of nodes are running (Default 1.0</div><div class="line">                                                     which means 100% nodes are running)</div><div class="line">-t,--watchTimeout &lt;watchTimeout&gt;                     Exit watch mode if the desired state is not attained until the specified timeout. (Default 300s)</div><div class="line">-w,--watch                                           Watch mode waits until all LLAP daemons are running or subset of the nodes are running (threshold can be</div><div class="line">                                                     specified via -r option) (Default wait until all nodes are running)</div></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hive2---轻松更新hive表2]]></title>
      <url>/2017/11/22/hive2---%E8%BD%BB%E6%9D%BE%E6%9B%B4%E6%96%B0hive%E8%A1%A82/</url>
      <content type="html"><![CDATA[<p>前面讲了使用MERGE,UPDATE,DELETE更新hive数据。现在我们进一步谈一下hive管理slowly-changing dimensions(SCDs，就是缓慢更新的维度表)的策略。在数据仓库中，SCDs更新数据是无规律的。对应于不同的业务需求，有不同的策略。假如你要一个用户维度表的所有历史，以跟踪某个用户随时间的变化情况。还有些情况，我们只关心最新的维度状态 。</p>
<p>下面是三种SCD更新策略：</p>
<ul>
<li>使用新数据覆盖旧数据。很简单，如果只是要同步最新状态的话，就用这个，但是会丢失历史维度值。</li>
<li>添加带有version的新数据行。可以追踪到所有历史。但是随着时间的退役，可能会特别大，还有就是查询的时候需要只看最新版本的维度值。</li>
<li>添加新数据行，管理有限版本的历史。有一些历史数据，然是控制在一定范围内。</li>
<li></li>
</ul>
<p>这个blog是讲一下怎样使用hive的MERGE来管理SCD。所有的例子都可以在<a href="https://github.com/cartershanklin/hive-scd-examples" target="_blank" rel="external">这里</a>找到。管理SCD是很麻烦的事情，所以最好能够用一些工作，比如<a href="https://www.amazon.com/Data-Warehouse-Toolkit-Complete-Dimensional/dp/0471200247" target="_blank" rel="external">数仓工具</a></p>
<h4 id="SCD管理策略一览"><a href="#SCD管理策略一览" class="headerlink" title="SCD管理策略一览"></a>SCD管理策略一览</h4><p><img src="https://2xbbhjxc6wk3v21p62t8n4d4-wpengine.netdna-ssl.com/wp-content/uploads/2017/08/1Slowly-changing-dimensions-1024x695.png" alt=""></p>
<h4 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h4><p>所有的是例子都是从一个外部表，copy到hive的managed table，这个managed table就是merge target。第二个外部表，代表第二次从某个系统全量dump出来的数据。这两个外部表是一样的csv文件，包含字段:ID,Name, Email,State。初始化的数据有1000条，第二次数据有1100条，其中包含100个新纪录和93个需要更新项。</p>
<h4 id="第一种策略"><a href="#第一种策略" class="headerlink" title="第一种策略"></a>第一种策略</h4><p>有就直接替换，没有就添加。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">merge into</div><div class="line"> contacts_target</div><div class="line">using</div><div class="line"> contacts_update_stage as stage</div><div class="line">on</div><div class="line"> stage.id = contacts_target.id</div><div class="line">when matched then</div><div class="line"> update set name = stage.name, email = stage.email, state = stage.state</div><div class="line">when not matched then</div><div class="line"> insert values (stage.id, stage.name, stage.email, stage.state);</div></pre></td></tr></table></figure>
<p>值得注意的是，上面的操作也是单独一个，是原子且独立的，如果出现错误会正确rollback。在SQL-on-Hasdoop方式里提供这些特性是很困难的，但是hive的MERGE操作就实现了。</p>
<h4 id="第二种策略"><a href="#第二种策略" class="headerlink" title="第二种策略"></a>第二种策略</h4><p>保留所有的历史版本，提供单独的版本相关字段:ValidFrom, ValidTo。</p>
<p><img src="https://2xbbhjxc6wk3v21p62t8n4d4-wpengine.netdna-ssl.com/wp-content/uploads/2017/08/2Hive-Type-2_1-1024x319.png" alt=""></p>
<p>我们可以使用这个策略来满足并发用户对于正在更新的数据的数据读取。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">merge into contacts_target</div><div class="line">using (</div><div class="line"> — The base staging data.</div><div class="line"> select</div><div class="line">contacts_update_stage.id as join_key,</div><div class="line">contacts_update_stage.* from contacts_update_stage</div><div class="line"> union all</div><div class="line">— Generate an extra row for changed records.</div><div class="line"> — The null join_key forces records down the insert path.</div><div class="line"> select</div><div class="line">   null, contacts_update_stage.*</div><div class="line"> from</div><div class="line">   contacts_update_stage join contacts_target</div><div class="line">   on contacts_update_stage.id = contacts_target.id</div><div class="line"> where</div><div class="line">   ( contacts_update_stage.email &lt;&gt; contacts_target.email</div><div class="line">     or contacts_update_stage.state &lt;&gt; contacts_target.state )</div><div class="line">   and contacts_target.valid_to is null</div><div class="line">) sub</div><div class="line">on sub.join_key = contacts_target.id</div><div class="line">when matched</div><div class="line"> and sub.email &lt;&gt; contacts_target.email or sub.state &lt;&gt; contacts_target.state</div><div class="line"> then update set valid_to = current_date()</div><div class="line">when not matched</div><div class="line"> then insert</div><div class="line"> values (sub.id, sub.name, sub.email, sub.state, current_date(), null);</div></pre></td></tr></table></figure>
<p>需要注意的是，using语句中对于每个更新的row会输出2个record。这些record会有一个null join key(就会成为一个insert了), 还会有一个valid jonk key(这是一个update)。如果都过去i安眠文章的话，其实有类似于在分区之间移动数据，只不过是使用update而不是delete。</p>
<p>看下93条记录的情况。<br><img src="https://2xbbhjxc6wk3v21p62t8n4d4-wpengine.netdna-ssl.com/wp-content/uploads/2017/08/2Hive-Type-2_2-1024x304.png" alt=""></p>
<h4 id="第三种类型"><a href="#第三种类型" class="headerlink" title="第三种类型"></a>第三种类型</h4><p>第二种类型其实挺强大的了，不过比较复杂，而且维度表会无限增长下去。第三种策略中维度表基本跟数据源大小差不多，但是只提供部分历史。</p>
<p>下面我们就只保存上一个版本的纬度值</p>
<p><img src="https://2xbbhjxc6wk3v21p62t8n4d4-wpengine.netdna-ssl.com/wp-content/uploads/2017/08/3Hive-Type-3_1.png" alt=""></p>
<p>当update的时候，我们任务就是把当前的版本放到last的值里。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">merge</span> <span class="keyword">into</span></div><div class="line"> contacts_target</div><div class="line"><span class="keyword">using</span></div><div class="line"> contacts_update_stage <span class="keyword">as</span> stage</div><div class="line"><span class="keyword">on</span> stage.id = contacts_target.id</div><div class="line"><span class="keyword">when</span> <span class="keyword">matched</span> <span class="keyword">and</span></div><div class="line"> contacts_target.email &lt;&gt; stage.email</div><div class="line"> <span class="keyword">or</span> contacts_target.state &lt;&gt; stage.state — <span class="keyword">change</span> detection</div><div class="line"> <span class="keyword">then</span> <span class="keyword">update</span> <span class="keyword">set</span></div><div class="line"> last_email = contacts_target.email, email = stage.email, — email history</div><div class="line"> last_state = contacts_target.state, state = stage.state  — state history</div><div class="line"><span class="keyword">when</span> <span class="keyword">not</span> <span class="keyword">matched</span> <span class="keyword">then</span> <span class="keyword">insert</span></div><div class="line"> <span class="keyword">values</span> (stage.id, stage.name, stage.email, stage.email,</div><div class="line"> stage.state, stage.state);</div></pre></td></tr></table></figure>
<p>我们看到相比第二种策略，这种就简单多了。</p>
<p><img src="https://2xbbhjxc6wk3v21p62t8n4d4-wpengine.netdna-ssl.com/wp-content/uploads/2017/08/3Hive-Type-3_2.png" alt=""></p>
<h4 id="一个更简单的变化追踪方法"><a href="#一个更简单的变化追踪方法" class="headerlink" title="一个更简单的变化追踪方法"></a>一个更简单的变化追踪方法</h4><p>如果有很多字段需要比较，那么对于变化的探测逻辑会比较笨重。幸运的是，hive引入了一个hash UDF让这个变得简单，可以接收任意数量的参数，然会一个checksum。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">merge into</div><div class="line"> contacts_target</div><div class="line">using</div><div class="line"> contacts_update_stage as stage</div><div class="line">on stage.id = contacts_target.id</div><div class="line">when matched and</div><div class="line"> hash(contacts_target.email, contacts_target.state) &lt;&gt;</div><div class="line">   hash(stage.email, stage.state)</div><div class="line"> then update set</div><div class="line"> last_email = contacts_target.email, email = stage.email, — email history</div><div class="line"> last_state = contacts_target.state, state = stage.state  — state history</div><div class="line">when not matched then insert</div><div class="line"> values (stage.id, stage.name, stage.email, stage.email,</div><div class="line"> stage.state, stage.state);</div></pre></td></tr></table></figure>
<p>好处就是，不管有多少个字段要比较，我们对于代码的修改可以几乎没有。</p>
<h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><p>SCD管理是数据仓库机器重要的概念，是一个有很多策略和方法实现的子模块。有了ACID MERGE，hive让我们在hadoop上管理SCD变的简单。</p>
<p>参考：<a href="https://zh.hortonworks.com/blog/update-hive-tables-easy-way-2/" target="_blank" rel="external">https://zh.hortonworks.com/blog/update-hive-tables-easy-way-2/</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hive2---轻松更新hive表1]]></title>
      <url>/2017/11/22/hive2---%E8%BD%BB%E6%9D%BE%E6%9B%B4%E6%96%B0hive%E8%A1%A81/</url>
      <content type="html"><![CDATA[<p>首先是merge、insert、update、delete。</p>
<p>以前，让hive里的数据持续更新是需要很复杂的成本的，很难去维护与执行。HDP2.6借助hive里的merge语法彻底地简化了数据维护成本，完成了INSERT, UPDATE, DELETE能力。</p>
<p>这个blog会说明怎样解释以下三种问题：</p>
<ul>
<li>hive update，从RDBMS同步数据到hive</li>
<li>更新hive里数据的分区</li>
<li>选择性地mask或者purge数据</li>
</ul>
<h4 id="基础操作：SQL-MERGE-UPDATE-AND-DELETE"><a href="#基础操作：SQL-MERGE-UPDATE-AND-DELETE" class="headerlink" title="基础操作：SQL MERGE, UPDATE AND DELETE"></a>基础操作：SQL MERGE, UPDATE AND DELETE</h4><p>MERGE是SQL 2008标准里的，是一个强大的SQL语句，它可以在同一个statement中inert，update，delete数据。MERGE让两个系统一致性工作变得简单。咱们看一下MERGE的语法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">MERGE INTO &lt;target table&gt;</div><div class="line"> USING &lt;table reference&gt;</div><div class="line">ON &lt;search condition&gt;</div><div class="line"> &lt;merge when clause&gt;...</div><div class="line">WHEN MATCHED [ AND &lt;search condition&gt; ]</div><div class="line">THEN &lt;merge update or delete specification&gt;</div><div class="line">WHEN NOT MATCHED [ AND &lt;search condition&gt; ]</div><div class="line">THEN &lt;merge insert specification&gt;</div></pre></td></tr></table></figure></p>
<p>WHEN MATCHED/WHEN NOT MATCHED语句可以无限量的。</p>
<p>我们也会使用到比较熟悉的UPDATE，语法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">UPDATE &lt;target table&gt;</div><div class="line">SET &lt;set clause list&gt;</div><div class="line">[ WHERE &lt;search condition&gt; ]</div></pre></td></tr></table></figure></p>
<p>当没必要把insert 和update的数据在一个sql statement里进行合并的时候，就可以使用update了。</p>
<h4 id="保持数据fresh"><a href="#保持数据fresh" class="headerlink" title="保持数据fresh"></a>保持数据fresh</h4><p>在HDP2.6中，需要先做两个工作：</p>
<ul>
<li>开启Hive transaction。</li>
<li>我们table必须是一个transactional table。就是说这个table必须是clustered的，必须是ORCFile存储格式，而且有一个table属性：transactional=true。下面是一个例子：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">create table customer_partitioned</div><div class="line"> (id int, name string, email string, state string)</div><div class="line"> partitioned by (signup date)</div><div class="line"> clustered by (id) into 2 buckets stored as orc</div><div class="line"> tblproperties(&quot;transactional&quot;=&quot;true&quot;);</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="例1：HIVE-UPSERT"><a href="#例1：HIVE-UPSERT" class="headerlink" title="例1：HIVE UPSERT"></a>例1：HIVE UPSERT</h4><p>假设我们有一个源数据库，想要load进hadoop来运行ing大批量的分析。这个RDBMS中的数据不断的被添加和修改，而且并没有log告诉你哪些数据有变化【就是说没有binlog】。最简单的处理就是每24小时完整的copy一下这个RDBMS的数据镜像。</p>
<p><img src="https://2xbbhjxc6wk3v21p62t8n4d4-wpengine.netdna-ssl.com/wp-content/uploads/2017/08/RDBMS-Source.png" alt=""></p>
<p>下面我们创建table：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">create table customer_partitioned</div><div class="line">(id int, name string, email string, state string)</div><div class="line"> partitioned by (signup date)</div><div class="line"> clustered by (id) into 2 buckets stored as orc</div><div class="line"> tblproperties(&quot;transactional&quot;=&quot;true&quot;);</div></pre></td></tr></table></figure></p>
<p>假设我们的数据在Time = 1的时候是这样的：<br><img src="https://2xbbhjxc6wk3v21p62t8n4d4-wpengine.netdna-ssl.com/wp-content/uploads/2017/08/Time-equals-1.png" alt=""></p>
<p>在Time = 2的时候是这样的<br><img src="https://2xbbhjxc6wk3v21p62t8n4d4-wpengine.netdna-ssl.com/wp-content/uploads/2017/08/Time-equals-2.png" alt=""></p>
<p>Upsert操作是吧update和insert放在一个操作里，这样我们就不用关心这些数据是不是原来就已经存在于目标table中。MERGE就是用来做这个事情的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">merge into customer_partitioned</div><div class="line"> using all_updates on customer_partitioned.id = all_updates.id</div><div class="line"> when matched then update set</div><div class="line">   email=all_updates.email,</div><div class="line">   state=all_updates.state</div><div class="line"> when not matched then insert</div><div class="line">   values(all_updates.id, all_updates.name, all_updates.email,</div><div class="line">   all_updates.state, all_updates.signup);</div></pre></td></tr></table></figure></p>
<p>注意我们的两个when条件语句是用来管理update或者insert的。在merge过后，这个managed table就与Time=2的staged Table完全一样了，而且所有数据也都在其对应的分区中。</p>
<h4 id="例2：更新hive-partition"><a href="#例2：更新hive-partition" class="headerlink" title="例2：更新hive partition"></a>例2：更新hive partition</h4><p>hive中很多会用日期作为partition策略。这样可以简化数据加载，提升性能。只是有时我们偶尔会出现数据进入错误的分区的情形。例如，假设用户数据是由一个第三方提供的，里面包含一个用户的singup日期。如果这个第三方数据提供者提供的数据开始有问题，后面又修正了，那么前面的在错误分区里的数据就应该被清除了。</p>
<p><img src="https://2xbbhjxc6wk3v21p62t8n4d4-wpengine.netdna-ssl.com/wp-content/uploads/2017/08/update-hive-partitions.png" alt="初始数据"></p>
<p><img src="https://2xbbhjxc6wk3v21p62t8n4d4-wpengine.netdna-ssl.com/wp-content/uploads/2017/08/second-load.png" alt="修复后的数据"></p>
<p>注意到ID为2的数据第一次跟第二次的signup日期是不一样的，这就需要更新2017-01-08分区，从里面把它删除，然后把它加入到2017-01-10里面去。</p>
<p>在MERGE出现之前，基本不可能管理这些分区裱花的。Hive的MERGE statement不是原生支持更新partition key，但是有一个小的技巧。 We introduce a delete marker which we set any time the partition keys and UNION this with a second query that produces an extra row on-the-fly for each of these non-matching records.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">merge into customer_partitioned</div><div class="line"> using (</div><div class="line">-- Updates with matching partitions or net new records.</div><div class="line">-- 更新符合分区的或者</div><div class="line">select</div><div class="line">  case</div><div class="line">       when all_updates.signup &lt;&gt; customer_partitioned.signup then 1</div><div class="line">       else 0</div><div class="line">     end as delete_flag,</div><div class="line">     all_updates.id as match_key,</div><div class="line">     all_updates.* from</div><div class="line">    all_updates left join customer_partitioned</div><div class="line">   on all_updates.id = customer_partitioned.id</div><div class="line">      union all</div><div class="line"></div><div class="line"> -- Produce new records when partitions don’t match.</div><div class="line"> -- 分区不匹配的时候，生成新的record</div><div class="line">     select 0, null, all_updates.*</div><div class="line">     from all_updates, customer_partitioned where</div><div class="line">     all_updates.id = customer_partitioned.id</div><div class="line">     and all_updates.signup &lt;&gt; customer_partitioned.signup</div><div class="line"> ) sub</div><div class="line">on customer_partitioned.id = sub.match_key</div><div class="line"> when matched and delete_flag=1 then delete</div><div class="line"> when matched and delete_flag=0 then</div><div class="line">   update set email=sub.email, state=sub.state</div><div class="line"> when not matched then</div><div class="line">   insert values(sub.id, sub.name, sub.email, sub.state, sub.signup);</div></pre></td></tr></table></figure></p>
<p>在MERGE处理过这个managed table之后，它就跟源数据表完全一致了。虽然过程中有分区的修改，但是这是一个操作，是原子、且独立的操作。</p>
<h4 id="例3：mask或者purge-hive的数据"><a href="#例3：mask或者purge-hive的数据" class="headerlink" title="例3：mask或者purge hive的数据"></a>例3：mask或者purge hive的数据</h4><p>假设有一天你们公司的安全部门过来，让我们把某个用户的所有数据进行mask或者purge操作。那么我们就需要花费很长的时间对很多收到影响的分区进行数据重写。</p>
<p>假设有一个contact table<br><img src="https://2xbbhjxc6wk3v21p62t8n4d4-wpengine.netdna-ssl.com/wp-content/uploads/2017/08/contracts-table.png" alt=""></p>
<p>我们对应的hive表是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">create table contacts</div><div class="line"> (id int, name string, customer string, phone string)</div><div class="line"> clustered by (id) into 2 buckets stored as orc </div><div class="line">tblproperties(&quot;transactional&quot;=&quot;true&quot;);</div></pre></td></tr></table></figure></p>
<p>安全部门提出以下要求：</p>
<h5 id="把MaxLeads的所有的电话号码mask掉"><a href="#把MaxLeads的所有的电话号码mask掉" class="headerlink" title="把MaxLeads的所有的电话号码mask掉"></a>把MaxLeads的所有的电话号码mask掉</h5><p>我们可以使用hive内置的mask方法<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">update contacts set phone = mask(phone) where customer = &apos;MaxLeads&apos;;</div></pre></td></tr></table></figure></p>
<h5 id="把所有LeadMax的记录都purge掉"><a href="#把所有LeadMax的记录都purge掉" class="headerlink" title="把所有LeadMax的记录都purge掉"></a>把所有LeadMax的记录都purge掉</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">delete from contacts where customer = &apos;LeadMax&apos;;</div></pre></td></tr></table></figure>
<h5 id="把给定id列表的所有记录都删掉"><a href="#把给定id列表的所有记录都删掉" class="headerlink" title="把给定id列表的所有记录都删掉"></a>把给定id列表的所有记录都删掉</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">delete from contacts where id in ( select id from purge_list );</div></pre></td></tr></table></figure>
<h4 id="结论"><a href="#结论" class="headerlink" title="结论"></a>结论</h4><p>hive的MERGE和ACID事务让hive里的数据管理工作变得简单、强大、而且兼容于现有的EDW平台。</p>
<p>参考：<a href="https://zh.hortonworks.com/blog/update-hive-tables-easy-way/" target="_blank" rel="external">https://zh.hortonworks.com/blog/update-hive-tables-easy-way/</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[实时系统的特性]]></title>
      <url>/2017/11/22/%E5%AE%9E%E6%97%B6%E7%B3%BB%E7%BB%9F%E7%9A%84%E7%89%B9%E6%80%A7/</url>
      <content type="html"><![CDATA[<h4 id="关键特性"><a href="#关键特性" class="headerlink" title="关键特性"></a>关键特性</h4><p>首先，各个微服务之间应该是解耦的，最好通过stream进行结构。</p>
<ul>
<li>持久化，把数据流暂存起来，供消费。具体持久化的时间，可以根据自己的业务处理</li>
<li>高性能，最快的处理每个环节，最大化单个处理单元的吞吐量</li>
<li>易扩展性，主要是易于应对数据量的海量增加</li>
</ul>
<p>参考：<a href="https://www.youtube.com/watch?v=4lUxf5pzAHs" target="_blank" rel="external">https://www.youtube.com/watch?v=4lUxf5pzAHs</a></p>
<h4 id="Move-from-State-to-Flow"><a href="#Move-from-State-to-Flow" class="headerlink" title="Move from State to Flow"></a>Move from State to Flow</h4><p>把微服务中的state转移到flow中去。</p>
<p>如果多个微服务都更新自己的state到同一个本地存储【比如mysql】，那么这个mysql就会变成一个比较危险的地方。如果我们单个微服务要修改mysql的配置，其他几个服务也要受到影响。</p>
<p>但是我们期望，每个微服务自己有修改的时候，相互之间没有影响，每个微服务的变化都是独立的。假设有A,B,C三个微服务，如果给C单独的mysql，那么c对于A,B就是完全独立的。然后针对A,B,C的更新操作全部看作business event放入一个queue，然后再由consumer从queue里消费event，针对不同的event进行处理。</p>
<p>参考：<a href="https://www.youtube.com/watch?v=_xqK0Es9zP4" target="_blank" rel="external">https://www.youtube.com/watch?v=_xqK0Es9zP4</a></p>
<h4 id="财政部门的flow数据架构"><a href="#财政部门的flow数据架构" class="headerlink" title="财政部门的flow数据架构"></a>财政部门的flow数据架构</h4><table>
<thead>
<tr>
<th>state</th>
<th>flow</th>
</tr>
</thead>
<tbody>
<tr>
<td>共享的DB</td>
<td>不共享任何，只共享flow</td>
</tr>
<tr>
<td>复杂的语义，需要小心的使用事务</td>
<td>好的沟通规范</td>
</tr>
<tr>
<td>人们较熟悉</td>
<td>生活中的真实流程</td>
</tr>
<tr>
<td>控制流 + state更新</td>
<td>控制流 + offset/message</td>
</tr>
</tbody>
</table>
<p>bank1和bank2都监听同一个message queue，处理过后持久化到自己的私有db。</p>
<p>参考：<a href="https://www.youtube.com/watch?v=vG2qxjkqOgA" target="_blank" rel="external">https://www.youtube.com/watch?v=vG2qxjkqOgA</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Flink特性]]></title>
      <url>/2017/11/22/Flink%E7%89%B9%E6%80%A7/</url>
      <content type="html"><![CDATA[<p>stateful operator可以追溯到前面的状态，例如count操作</p>
<p>stateful</p>
<ul>
<li>聚合操作</li>
<li>complex event processing</li>
<li>ML pattern</li>
</ul>
<p>stateless</p>
<ul>
<li>数据抽取</li>
<li>数据清洗</li>
<li>stateless的转化</li>
</ul>
<h4 id="queryable-state"><a href="#queryable-state" class="headerlink" title="queryable state"></a>queryable state</h4><p>如果设定了一个小时的窗口，在到达一小时之前这个数据一般是不可查询的。但是有了 queryable 是state，我们可以在未到时间窗口的时候，就进行查询计算。</p>
<h4 id="不想中断数据处理，但又想"><a href="#不想中断数据处理，但又想" class="headerlink" title="不想中断数据处理，但又想"></a>不想中断数据处理，但又想</h4><ul>
<li>修改worker的数量</li>
<li>迁移到另一个集群</li>
<li>修复代码bug</li>
<li>升级flink</li>
<li>测试不同的算法</li>
<li>……</li>
</ul>
<p>以上这些对于stateless任务其实是很简单的，直接操作就可以。停掉，重启。对于statefule的任务，就比较棘手。对于添加worker的需求，state需要reload或者redistribute。</p>
<p>Flink方案：savepoint。</p>
<ul>
<li>创建savepoint</li>
<li>修改</li>
<li>从savepoint重启</li>
</ul>
<p>对于session window的state也是很棘手的，Flink1.1会支持这个场景。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[flink的容错机制]]></title>
      <url>/2017/11/21/flink%E7%9A%84%E5%AE%B9%E9%94%99%E6%9C%BA%E5%88%B6/</url>
      <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>Flink容错机制保证了，即便出现失败，程序的state也最终reflect每条记录exactly once，也可以降级到at least once。</p>
<p>这个容错机制持续的描绘出分布式数据流的snapshot。对于少有state的流式应用来说，这些snapshot是非常轻量的，可以在不影响到性能的前提下快速完成。流式应用的state会被存储在配置好的地方(比如master节点、hdfs等)。</p>
<p>如果程序失败了(机器原因、网络原因、软件问题等)，Flink会踢掉分布式数据流。然后系统会重启所有的operator，然后把他们重置到最近的成功的checkpoint。输入流也被重置到这个state snapshot的点。作为重新启动的并行dataflow的一部分，已经处理过的所有的记录都保证不属于前一个checkpoint state里的一部分。</p>
<p>注意：默认checkpoint是未启用的。</p>
<p>注意：要完全保证这个机制，需要数据流的source(一般是消息队列或者broker)能够支持重置位移。例如kafka就可以重置位移。</p>
<p>注意：以你为Flink的checkpoints是通过分布式snapshot实现的，我们可以交换使用snapshot和checkpoint这两个词语。</p>
<h2 id="checkpoint"><a href="#checkpoint" class="headerlink" title="checkpoint"></a>checkpoint</h2><p>Flinke容错机制的核心就是为分布式的数据流和操作状态进行snapshot。这些snapshot作为一致性的checkpoint供错误恢复使用。Flink执行snapshot的机制在<a href="http://arxiv.org/abs/1506.08603" target="_blank" rel="external"> “Lightweight Asynchronous Snapshots for Distributed Dataflows”.</a>有介绍。是由<a href="http://research.microsoft.com/en-us/um/people/lamport/pubs/chandy.pdf" target="_blank" rel="external">Chandy-Lamport algorithm</a>实现的，这是一种分布式snapshot方法，而且兼容Flink的执行模型。</p>
<h4 id="Barrier栅栏"><a href="#Barrier栅栏" class="headerlink" title="Barrier栅栏"></a>Barrier栅栏</h4><p>Flink分布式snapshot的核心元素是stream barrier。这些栅栏被注入到data stream和flow当中作为data stream的一部分存在。barrier永远不会超过记录，flow是严格线性的。barrier负责把data stream中的数据进行切分，切分为两部分，一部分到当前的snapshot中，然后另外一部分是下一个snapshot里的。Each barrier carries the ID of the snapshot whose records it pushed in front of it. barrier并不会中断数据流处理，十分轻量。不同snampshot的多个barrier可能同时存在于stream中，这就是说可能会多个snapshot并发执行。</p>
<p><img src="https://ci.apache.org/projects/flink/flink-docs-release-1.3/fig/stream_barriers.svg" alt=""></p>
<p>Stream barrier在stream source被注入到并发的data flow中。snapshot n的barrier的点Sn被注入的位置是source stream知道覆盖到数据的snapshot【The point where the barriers for snapshot n are injected (let’s call it Sn) is the position in the source stream up to which the snapshot covers the data】。例如在kafka中，这个位置就是当前分区上一次访问的记录的offset。这个位置Sn就被汇报给checkpoint coordinator(Flink里就是JobManager)。</p>
<p>然后barrier继续向下执行。当一个中间oerator抽取到snapshot n的barrier时，它发射一个snapshot n的barrier给它所有的outgoing stream。一旦一个sink operator(DAG的最后)收到barrier n的时候，它就向checkpoint coordinator确认ack snapshot n。所有的sink都ack了这个snapshot的时候，它就被认为已经成功了。</p>
<p>snapshot n完成之后，job再也不会请求Sn之前的数据记录了，因为这些数据记录已经通过了整个数据流处理拓扑。</p>
<p><img src="https://ci.apache.org/projects/flink/flink-docs-release-1.3/fig/stream_aligning.svg" alt=""></p>
<p>接收多个input stream的operator必须排列多个input stream的snapshot barriers。上图内容</p>
<ul>
<li>operator接到单个input stream的snapshot barrier n的时候，不能立即处理这个stream的数据，需要等着其他input stream的barrier n也到达的时候才行。否则，它会把snapshot n的数据记录和snapshot n+1的数据记录弄混了。</li>
<li>已经汇报barrier n的input stream暂时被搁置。收到的数据记录暂时不处理，而是放进一个input buffer</li>
<li>最后一个stream也收到barrier n的时候，这个operator就发射所有pending的outing 记录，然后自己也发射snapshot n的barrier。</li>
<li>最后，它恢复处理所有input stream的数据记录，处理在此之前的input buffer里的数据记录，然后处理stream的记录。</li>
</ul>
<h4 id="state"><a href="#state" class="headerlink" title="state"></a>state</h4><p>如果operator包含任意形式的state，这个state就必须成为snapshot的一部分。operator statue可能是下面的几种：</p>
<ul>
<li>user-defined state。通过转化方法(例如map、filter)直接创建与修改的state。</li>
<li>system state。例如operator计算的一部分，数据缓存等。典型的例子是window buffer，在window buffer中通常收集聚合数据记录，直到window的计算或者被清空。</li>
</ul>
<p>operator在收到了它所有input stream的barrier n，并且没有发送barrier n给它的所有output stream之前，snapshot它的state。在这个时间点，barrier之前的所有的数据记录导致的state更新已经完成，并且没有根据已经执行的的barrier之后的数据记录进行任何更新。因为snapshot 的state可能会很大，它可以被存储在一个可配置的<a href="https://ci.apache.org/projects/flink/flink-docs-release-1.3/ops/state_backends.html" target="_blank" rel="external">后端</a>。默认情况下，是放在JobManager的内存里，对于生产环境，最好放在可靠的存储介质上，例如HDFS。在state被存储之后，operator ack这个checkpoint，发送这个snapshot barrier到output stream中。</p>
<p>现在snapshot包含了：</p>
<ul>
<li>对于每个并行的stream data source，snapshot开始的时候stream中的位置信息或者offset</li>
<li>对于每个operator，一个指向snapshot state仓库的pointer</li>
</ul>
<p><img src="https://ci.apache.org/projects/flink/flink-docs-release-1.3/fig/checkpointing.svg" alt="checkpoint流程图"></p>
<h2 id="Exactly-Once还是At-least-once"><a href="#Exactly-Once还是At-least-once" class="headerlink" title="Exactly Once还是At least once"></a>Exactly Once还是At least once</h2><p>对于streaming program来说alignment操作可能会造成一些延迟。通差，这部分延迟是早毫秒级的，但是我们见过一些非常突出的延迟。对于那些坚持要求低延迟的应用，Flink有一个开关可以关闭checkpoint过程中的alignment操作。checkpoint snapshot仍然很快。</p>
<p>当alignment被跳过后，即便一些checkpoint barrier n已经到了，operator也要继续处理所有的输入。这样的话，在snapshot n完结之前，operator也会处理属于 snapshot n+1的数据。再回复的时候，这些记录就会被重复处理，因为他们都被记录在了snapshot n的state snapshot里，所以也会作为checkpoint n之后的数据被replay。</p>
<p>注意：alignment只会发生在具有多个前辈(join)，或者多个sender(在一个stream被repartition/shuffle)的operator。因此，对于只包含并行处理操作(map, flatmap, filter等)的dataflow来说，at least once模式下其实也是exactly once的。</p>
<h2 id="异步state-snapshot"><a href="#异步state-snapshot" class="headerlink" title="异步state snapshot"></a>异步state snapshot</h2><p>注意上面描述的机制意味着operator在奥村他们的snapshot state到state backend的时候，需要停止处理输入的记录。这个同步的state snapshot操作会造成一个小的时间延迟。</p>
<p>如果让这个存储操作异步执行的话，就能让operator继续执行下面的步骤了。要这样的话，operator必循能够生成一个state对象，这个state 对象能够被存储，而且后面operator state的更新不会影响到它。例如，copy-on-write数据结构，rocksdb里有这种操作。</p>
<p>接收到所有input stream的checkpoint barrier后，operator开始异步snapshot，copy他的state。它会马上发送barrier到它的output，然后继续下面的数据流处理。一旦后台的copy进程完成后，它就会向checkpoint coordinator(JobManager) ack这个checkpoint。 这个checkpoint现在只在所有的sink都收到barrier后，所有的statefule operator都ack他们完成了backup后(这个可能比barrier到达sink还要慢)才算完成。</p>
<h2 id="recovery"><a href="#recovery" class="headerlink" title="recovery"></a>recovery</h2><p>在这个机制下的recovery很直接：一旦发生失败，Flink选择最新的完成的checkpoint k。然后这个system重新部署整个的分布式数据流，然后给每个operator这个snapshot k对应的state，因为这也是checkpoint k的一部分。而且需要从数据源的Sk的位置开始读取数据流。如果是kafka的话，就是从offset为Sk的地方开始抽取数据。</p>
<p>如果state是增量snapshot的，那么operator要使用最新full snapshot的state，然后把后续的更新操作应用到这个state上。</p>
<p><a href="https://ci.apache.org/projects/flink/flink-docs-release-1.3/dev/restart_strategies.html" target="_blank" rel="external">更多</a></p>
<h2 id="operator-snapshot的实现"><a href="#operator-snapshot的实现" class="headerlink" title="operator snapshot的实现"></a>operator snapshot的实现</h2><p>当operator执行snapshot的时候，有两个部分：同步的和异步的。</p>
<p>operator和state backend是以java FutureTask的形式提供他们的snapshot的。这个task包含了同步部分已完成的state，但是异步部分可能还在pending状态。异步部分后面会被这个checkpoint的一个后台线程执行。</p>
<p>使用纯同步方式的operator checkpint会返回一个已经完成了的FutrueTask。如果异步操作需要被执行，就执行FutrueTask的run方法。</p>
<p>这些task是可以被cancel的，这样stream和其他的资源消费句柄就可以被release了。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[flink的window]]></title>
      <url>/2017/11/21/flink%E7%9A%84window/</url>
      <content type="html"><![CDATA[<p>滑动窗口,sliding windows，比如我们每30s统计一下上一分钟的和。<br><img src="https://flink.apache.org/img/blog/window-intro/window-sliding-window.png" alt=""></p>
<p>当只有一个窗口处理器的时候，我们就只能串行处理一个数据流。每个流里的书都要去向某个指定的window。在Flink中对于Windows on a full stream are【一个完整的流的窗口】 称为 AllWindows。对很多app来说，数据流都要分发进入多个逻辑流，然后会有window operator处理每个逻辑流。假设我们从多个交通传感器获取交通工具的流量，每个交通传感器都监控不同地址的流量。我们可以把这些信息流通过交通传感器的id进行分组，然后分别并发的计算每个交通传感器所在位置的流量信息。在Flink中，我们把这种partitioned window叫做simple window，因为这是对分布式数据流很常见的处理方式。下图展示了一个通过(sernsorID, count)的流进行数据收集的滚动窗口<br><img src="https://flink.apache.org/img/blog/window-intro/windows-keyed.png" alt=""></p>
<p>通常，一个window在无穷的数据流中定义了一组有穷数据。这组数据可以是基于时间、计数、时间与技术结合、自定义的一些逻辑去分window。Flink的DataStream API提供了简洁的操作供常用的窗口操作，也留了接口让用户提供自定义的分窗口的逻辑。下面我们详细看一下基于时间与计数的窗口机制。</p>
<h2 id="基于时间的窗口"><a href="#基于时间的窗口" class="headerlink" title="基于时间的窗口"></a>基于时间的窗口</h2><p>下面是一个每分钟滚动一次的窗口，对所有的数据执行某个函数操作。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">// (sensorId, carCnt)形式的数据流</div><div class="line">val vehicleCnts: DataStream[(Int, Int)] = ...</div><div class="line"></div><div class="line">// 0，1是在数据中的位置</div><div class="line">val tumblingCnts: DataStream[(Int, Int)] = vehicleCnts</div><div class="line">  // 通过sensorId分区</div><div class="line">  .keyBy(0) </div><div class="line">  // 1分钟的窗口时间</div><div class="line">  .timeWindow(Time.minutes(1))</div><div class="line">  // 计算carCnt的和</div><div class="line">  .sum(1) </div><div class="line"></div><div class="line">val slidingCnts: DataStream[(Int, Int)] = vehicleCnts</div><div class="line">  .keyBy(0) </div><div class="line">  // 每30秒触发一次1分钟的数据窗口的执行</div><div class="line">  .timeWindow(Time.minutes(1), Time.seconds(30))</div><div class="line">  .sum(1)</div></pre></td></tr></table></figure></p>
<p>还有一个时间的概念我们要说明</p>
<ul>
<li>processing time。窗口是根据当前主机的1分钟去构建与计算窗口内数据的。</li>
<li>event time。event产生时的时间。相比processing time更好一些</li>
<li>Ingestion time。是processing  time和event time的杂交品种。一旦数据到达，就把当前机器的时间戳赋给这个数据记录，然后基于这个时间戳，使用event time去持续处理。</li>
</ul>
<h2 id="基于计数的窗口"><a href="#基于计数的窗口" class="headerlink" title="基于计数的窗口"></a>基于计数的窗口</h2><p>一个100个event作为窗口的程序。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">// (sensorId, carCnt)形式的数据流</div><div class="line">val vehicleCnts: DataStream[(Int, Int)] = ...</div><div class="line"></div><div class="line">val tumblingCnts: DataStream[(Int, Int)] = vehicleCnts</div><div class="line">  // 用sensorId分区</div><div class="line">  .keyBy(0)</div><div class="line">  // 100个数据为一个窗口</div><div class="line">  .countWindow(100)</div><div class="line">  .sum(1)</div><div class="line"></div><div class="line">val slidingCnts: DataStream[(Int, Int)] = vehicleCnts</div><div class="line">  .keyBy(0)</div><div class="line">  // 100个数据作为一个窗口，每10个触发一次窗口处理</div><div class="line">  .countWindow(100, 10)</div><div class="line">  .sum(1)</div></pre></td></tr></table></figure></p>
<h2 id="深入了解"><a href="#深入了解" class="headerlink" title="深入了解"></a>深入了解</h2><p>Flink内置的基于时间、计数的窗口已经覆盖了大多数的应用，但是对于一些需要自定义窗口划分逻辑的，需要使用DataStream API暴露的接口，这些接口给了窗口构建与计算的很有条理的控制方式。</p>
<p>下图是Flink窗口机制的详细图<br><img src="https://flink.apache.org/img/blog/window-intro/window-mechanics.png" alt=""></p>
<p>到达window operator的数据会先发给<code>WindowAssigner</code>. <code>WindowAssigner</code>把数据分配给一个或者多个window，也有可能要创建新的window。一个<code>Window</code>是一个一组数据、元数据(对于<code>TimeWindow</code>来说是起止时间)的唯一标识符。注意数据是可以被加入到多个window的，也就是说可能会同时存在多个window。</p>
<p>每个window拥有一个<code>Trigger</code>，它来决定当前window什么时候计算或者清空。这个trigger在每条数据到来的时候都会检验，如果前面注册的timer超时就会触发操作：执行计算、清空窗口、先计算再清空。<strong>如果只是触发计算，那么所有的数据就还留在window里</strong>，下次触发的时候还可以计算。<strong>一个window在被清空之前一直都可以被计算，这也代表着内存占用</strong>。</p>
<p>计算函数接收window的所有数据，输出一个或多个结果。DataStream API接受不同类型的计算函数，包括一些预定义的sum、min、max，ReduceFunction、FlodFunciton、WindowFunction等。最常见的是<code>WindowFunction</code>，它接收window对象的元数据，一组window对象，window key(如果是分区的window)作为参数。</p>
<p>这些组件构成了Flink的窗口机制。我们现在一步步看一下怎样实现自定义窗口逻辑。我们以DataStream[IN]类型的stream开始，用一个key选择器函数来抽取key，获得一个Keydtream[IN, KEY].<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">val input: DataStream[IN] = ...</div><div class="line"></div><div class="line">val keyed: KeyedStream[IN, KEY] = input</div><div class="line">  .keyBy(myKeySel: (IN) =&gt; KEY)</div><div class="line"></div><div class="line"></div><div class="line">// 通过WindowAssigner创建一个分窗口的stream。WindowAssigner 有默认的Trigger实现</div><div class="line">var windowed: WindowedStream[IN, KEY, WINDOW] = keyed</div><div class="line">  .window(myAssigner: WindowAssigner[IN, WINDOW])</div><div class="line">  </div><div class="line">// 不适用WindowAssigner默认的trigger</div><div class="line">windowed = windowed</div><div class="line">  .trigger(myTrigger: Trigger[IN, WINDOW])</div><div class="line"></div><div class="line">// 指定可选的evictor</div><div class="line">windowed = windowed</div><div class="line">  .evictor(myEvictor: Evictor[IN, WINDOW])</div><div class="line"></div><div class="line">// 最后，把window function传递给windowed stream</div><div class="line">val output: DataStream[OUT] = windowed</div><div class="line">  .apply(myWinFunc: WindowFunction[IN, OUT, KEY, WINDOW])</div></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[centos上搭建ftp服务器]]></title>
      <url>/2017/11/20/centos%E4%B8%8A%E6%90%AD%E5%BB%BAftp%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
      <content type="html"><![CDATA[<p>首先安装服务：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y vsftpd</div></pre></td></tr></table></figure></p>
<p>创建只读的dataman用户：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">useradd -s /sbin/nologin dataman</div><div class="line">passwd dataman</div></pre></td></tr></table></figure></p>
<p>编辑配置文件<code>/etc/vsftpd/vsftpd.conf</code>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"># 修改默认端口</div><div class="line">listen_port=6888</div><div class="line"></div><div class="line"># 禁止匿名登陆</div><div class="line">anonymous_enable=NO</div><div class="line"></div><div class="line"># 指定用户单独的配置信息所在目录</div><div class="line">user_config_dir=/var/ftp</div><div class="line"></div><div class="line"># 不许用户登陆后切换目录</div><div class="line">chroot_local_user=YES</div></pre></td></tr></table></figure></p>
<p>然后到<code>/var/ftp</code>下新建dataman用户的ftp配置文件，这里只需要指定他的root目录就好了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">local_root=/server/files</div></pre></td></tr></table></figure></p>
<p>参考</p>
<ul>
<li><a href="https://jasonhzy.github.io/2016/03/11/linux-ftp/" target="_blank" rel="external">https://jasonhzy.github.io/2016/03/11/linux-ftp/</a></li>
<li><a href="http://cn.linux.vbird.org/linux_server/0410vsftpd.php" target="_blank" rel="external">http://cn.linux.vbird.org/linux_server/0410vsftpd.php</a></li>
</ul>
<p>坑</p>
<p>我们的网络原因导致，测试环境要连接线上的ftp服务器的话，需要通过一层运维提供的HAProxy代理。</p>
<p>这就引出了ftp服务器主动传输与被动传输的概念区别。</p>
<p>FTP协议有两种工作方式：PORT方式和PASV方式，中文意思为主动式和被动式。</p>
<p>PORT（主动）方式的连接过程是：客 户端向服务器的FTP端口（默认是21）发送连接请求，服务器接受连接，建立一条命令链路。当需要传送数据时，客户端在命令链路上用PORT命令告诉服务 器：“我打开了XXXX端口，你过来连接我”。于是服务器从20端口向客户端的XXXX端口发送连接请求，建立一条数据链路来传送数据。</p>
<p>PASV（被动）方式的连接过程是：客 户端向服务器的FTP端口（默认是21）发送连接请求，服务器接受连接，建立一条命令链路。当需要传送数据时，服务器在命令链路上用PASV命令告诉客户 端：“我打开了XXXX端口，你过来连接我”。于是客户端向服务器的XXXX端口发送连接请求，建立一条数据链路来传送数据。</p>
<h2 id="概括："><a href="#概括：" class="headerlink" title="概括： "></a>概括： </h2><p>主动模式：服务器向客户端敲门，然后客户端开门<br>被动模式：客户端向服务器敲门，然后服务器开门</p>
<p>所以，如果你是如果通过代理上网的话，就不能用主动模式，因为服务器敲的是上网代理服务器的门，而不是敲客户端的门<br>而且有时候，客户端也不是轻易就开门的，因为有防火墙阻挡，除非客户端开放大于1024的高端端口</p>
<p>vsftpd服务器端修改配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># passive</div><div class="line">tcp_wrappers=YES</div><div class="line">pasv_promiscuous=NO</div><div class="line"># 这个比较关键，10.103.70.27是我们的haproxy所在的IP</div><div class="line">pasv_address=10.103.70.27</div><div class="line">port_enable=YES</div><div class="line">port_promiscuous=NO</div><div class="line">pasv_enable=YES</div><div class="line">pasv_min_port=10000</div><div class="line">pasv_max_port=10010</div></pre></td></tr></table></figure></p>
<p>同时，HAProxy也需要配置到这些端口范围<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">listen ftp</div><div class="line">    bind *:6888,*:10000-10010</div><div class="line">    mode tcp</div><div class="line">    server ftpserver 10.2.19.62 check inter 3000 port 6888</div></pre></td></tr></table></figure></p>
<ul>
<li><a href="http://blog.sina.com.cn/s/blog_7f1d56650102v57p.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_7f1d56650102v57p.html</a></li>
<li><a href="http://www.cnblogs.com/exclm/archive/2009/05/08/1452893.html" target="_blank" rel="external">http://www.cnblogs.com/exclm/archive/2009/05/08/1452893.html</a></li>
<li><a href="http://blog.sina.com.cn/s/blog_5cdb72780100jwjt.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_5cdb72780100jwjt.html</a></li>
<li><a href="https://serverfault.com/questions/441721/ftp-through-haproxy" target="_blank" rel="external">https://serverfault.com/questions/441721/ftp-through-haproxy</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ETL日常调度任务类型的思考]]></title>
      <url>/2017/11/16/ETL%E6%97%A5%E5%B8%B8%E8%B0%83%E5%BA%A6%E4%BB%BB%E5%8A%A1%E7%B1%BB%E5%9E%8B%E7%9A%84%E6%80%9D%E8%80%83/</url>
      <content type="html"><![CDATA[<p>对于有些需要等待上游非同质类型、而且是外部任务的任务方案：</p>
<h2 id="信号灯"><a href="#信号灯" class="headerlink" title="信号灯"></a>信号灯</h2><p>即所有的每个任务在完成之后，都设置一个信号灯，然后后面的任务需要此信号灯满足某个信号的时候才能触发执行。</p>
<p>信号灯的查看方式可以有多种：</p>
<ul>
<li>数据库访问，上游直接修改数据库，下游直接轮询数据库</li>
<li>rest接口访问，上有直接通过中心接口修改数据库，下游轮询一个中心接口</li>
<li>发布订阅模式，中间件设置eventbus</li>
</ul>
<p>执行：sql查询、接口与状态确认</p>
<h2 id="提供shell"><a href="#提供shell" class="headerlink" title="提供shell"></a>提供shell</h2><p>具体咋依赖，全都自己去写，这里啥也不限制，而且啥也不伺候</p>
<p>安全系数低</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[druid设计]]></title>
      <url>/2017/11/15/druid%E8%AE%BE%E8%AE%A1/</url>
      <content type="html"><![CDATA[<h2 id="segment"><a href="#segment" class="headerlink" title="segment"></a>segment</h2><p>Druid的索引是存在segment文件中的，segment文件是按照时间分区的。一个segment文件对应一个时间间隔，时间间隔根据配置项<code>granularitySpec</code>里的<code>segmentGranularity</code>进行配置。推荐segment文件大小设置在300~700M之间。如果你的segment文件太大，那么请考虑修改时间间隔，或者为数据做分区，修改<code>partitioningSpec</code>的<code>targetPartitionSize</code>参数(可以试试五百万行)。</p>
<h4 id="文件数据结构"><a href="#文件数据结构" class="headerlink" title="文件数据结构"></a>文件数据结构</h4><p>segment是列式存储的：每一列都在不同的数据结构中。每个列都分开存储，druid就可以只访问查询应用到的列的数据。有三个基本的列类型：timestamp、维度、metric。</p>
<p><img src="http://druid.io/docs/img/druid-column-types.png" alt="实例"></p>
<p>timestamp和metric列比较简单：都是int或者float数组，使用LZ4算法压缩。一个query只要知道他需要查询那些行，就解压相关列的这部分文件，抽取对应的行，然后执行聚合计算操作即可。</p>
<p>dimension列有些不同，它要支持filter和groupby操作，所以需要下面三个数据结构</p>
<ul>
<li>一个字典，把值映射成int类型的id</li>
<li>使用上面字典编码的列值的list</li>
<li>列中每个不同的列指，都要弄一个bitmap对应所有的行，说明哪些行带有这个列指</li>
</ul>
<p>把原本的值映射成int的id是为了节省空间。上面第三个里的bitmap也就是倒排索引(inverted indexes)可以提供快速的过滤工作。最后，上面第二个结构里的值，是用来处理group by和topN拆线呢的。也就是说，基于filter的单独聚合指标不要要接触到第二个数据结构中的维度值。</p>
<p>基于上图中的数据，看一下例子，下面是针对列<code>Page</code>的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">1: 映射编码的字典</div><div class="line">  &#123;</div><div class="line">    &quot;Justin Bieber&quot;: 0,</div><div class="line">    &quot;Ke$ha&quot;:         1</div><div class="line">  &#125;</div><div class="line"></div><div class="line">2: 按照1中映射后，这一列的字段值</div><div class="line">  [0,</div><div class="line">   0,</div><div class="line">   1,</div><div class="line">   1]</div><div class="line"></div><div class="line">3: 每一个或者说每一种列值都有自己的Bitmaps</div><div class="line">  value=&quot;Justin Bieber&quot;: [1,1,0,0]</div><div class="line">  value=&quot;Ke$ha&quot;:         [0,0,1,1]</div></pre></td></tr></table></figure></p>
<p>注意bitmap数据结构与前面个不同，前两个是随数据量线性增长的，而bitmap是数据量 * 每列各种值的个数。</p>
<h4 id="多值的列"><a href="#多值的列" class="headerlink" title="多值的列"></a>多值的列</h4><p>假设<code>Page</code>的第二行数据为<code>Ke$ha,Justin Bieber</code>，那么数据结构变化为下面：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">1: Dictionary that encodes column values</div><div class="line">  &#123;</div><div class="line">    &quot;Justin Bieber&quot;: 0,</div><div class="line">    &quot;Ke$ha&quot;:         1</div><div class="line">  &#125;</div><div class="line"></div><div class="line">2: Column data</div><div class="line">  [0,</div><div class="line">   [0,1],  &lt;--Row value of multi-value column can have array of values</div><div class="line">   1,</div><div class="line">   1]</div><div class="line"></div><div class="line">3: Bitmaps - one for each unique value</div><div class="line">  value=&quot;Justin Bieber&quot;: [1,1,0,0]</div><div class="line">  value=&quot;Ke$ha&quot;:         [0,1,1,1]</div><div class="line">                            ^</div><div class="line">                            |</div><div class="line">                            |</div><div class="line">    Multi-value column has multiple non-zero entries</div></pre></td></tr></table></figure></p>
<h4 id="命名约定"><a href="#命名约定" class="headerlink" title="命名约定"></a>命名约定</h4><p>segment文件的标识符一般是由数据源、开始时间、结束时间、版本构成的。如果数据在某个时间范围外还sharded了，那么也会带有一个分区数字。</p>
<p>例子：datasource_intervalStart_intervalEnd_version_partitionNum</p>
<h4 id="segment组件"><a href="#segment组件" class="headerlink" title="segment组件"></a>segment组件</h4><p>一个segment由几个文件组成</p>
<ul>
<li>version.bin。  4个字节，代表segment的version。</li>
<li>meta.smoosh。带有其他smoosh文件内容元数据(文件名、offset)的文件。</li>
<li>xxxx.smoosh。多个这种文件，都是二进制数据。</li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hive2版本亮点]]></title>
      <url>/2017/11/15/hive2%E7%89%88%E6%9C%AC%E4%BA%AE%E7%82%B9/</url>
      <content type="html"><![CDATA[<ul>
<li>LLAP。</li>
</ul>
<p>Live Long and Process智能将数据缓存到多台机器的内存中，并允许所有客户端共享这些缓存的数据，同时保留了弹性伸缩能力。开启LLAP后，性能相比1版本提升25倍。</p>
<p>LLAP提供了一个高级的执行模式，他启用一个长时间存活的守护程序去和HDFS DataNode直接交互，也是一个紧密集成的DAG框架。这个守护程序中加入了缓存、预抓取、查询过程和访问控制等功能。短小的查询由守护程序执行，大的重的操作由YARN执行。</p>
<ul>
<li>支持使用HPL/SQL的存储过程</li>
</ul>
<p>支持使用变量、表达式、控制流声明、迭代来实现业务逻辑，支持使用异常处理程序和条件处理器来实现高级错误处理。</p>
<p>使用sql on hadoop更加动态：支持使用高级表达式、各种内置函数，基于用户配置、先前查询的结果、来自文件或者非hadoop数据源的数据、即时动态的生成SQL条件。</p>
<p>利用已有的存储过程SQL，提供函数和声明。</p>
<p>方便集成和支持多种类型数据仓库，可以实现单个脚本处理hadoop、RDBMS、Nossql等多个系统的数据。</p>
<ul>
<li>更智能的成本优化其CBO</li>
<li>提供全面的监控和诊断工具。hive server2的UI界面、LLAP 的UI、Tez的UI等。</li>
</ul>
<p>升级只需要升级hive的元数据库信息即可，2版本提供了升级脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hive-metastore/bin/schematool -upgradeSchema -dbType</div></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[TPC-DS基准测试]]></title>
      <url>/2017/11/15/TPC-DS%E5%9F%BA%E5%87%86%E6%B5%8B%E8%AF%95/</url>
      <content type="html"><![CDATA[<ul>
<li>测试数据加载<ul>
<li>系统准备</li>
<li>数据文件生成</li>
<li>测试数据库创建</li>
<li>基础表创建</li>
<li>数据加载</li>
<li>约束验证</li>
<li>辅助数据结构创建</li>
<li>表和辅助数据统计分析等</li>
</ul>
</li>
<li>查询顺序执行。power测试是单个查询的处理能力。</li>
<li>查询并行执行。throughput是并发查询的处理能力，分为数据查询与数据维护两个子步骤。</li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[scalatra入门]]></title>
      <url>/2017/11/09/sbt%E7%AE%80%E8%AE%B0/</url>
      <content type="html"><![CDATA[<h4 id="生成scalatra项目"><a href="#生成scalatra项目" class="headerlink" title="生成scalatra项目"></a>生成scalatra项目</h4><p>下载项目，并配置相关信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"># 从github上下载项目</div><div class="line">root@will-vm:/usr/local/will/learning# sbt new scalatra/scalatra.g8</div><div class="line">[info] Set current project to learning (in build file:/usr/local/will/learning/)</div><div class="line"># 用来发布项目的，一般就是反序域名[联想一下java包]</div><div class="line">organization [com.example]: com.will</div><div class="line"># scalatra app名字</div><div class="line">name [My Scalatra Web App]: willup</div><div class="line"># 项目版本，自己随便定义，比如0.0.1</div><div class="line">version [0.1.0-SNAPSHOT]: </div><div class="line"># 我们的servlet类的名字</div><div class="line">servlet_name [MyScalatraServlet]: Will</div><div class="line"># 所有的scala文件都属于一个pacakge</div><div class="line">package [com.example.app]: com.will.app</div><div class="line"># 使用的scala版本</div><div class="line">scala_version [2.12.3]: 2.12.1</div><div class="line"># 使用的sbt版本</div><div class="line">sbt_version [1.0.2]: 1.0.3</div><div class="line"># 使用的scalatra版本</div><div class="line">scalatra_version [2.5.4]: </div><div class="line"># 初始项目生成在willup目录了，有些像django</div><div class="line">Template applied in ./willup</div><div class="line">root@will-vm:/usr/local/will/learning# ll</div><div class="line">总用量 16</div><div class="line">drwxr-xr-x 4 root root 4096 11月  9 17:12 ./</div><div class="line">drwxr-xr-x 8 root root 4096 11月  9 16:06 ../</div><div class="line">drwxr-xr-x 3 root root 4096 11月  9 17:11 target/</div><div class="line">drwxr-xr-x 4 root root 4096 11月  9 17:12 willup/</div></pre></td></tr></table></figure></p>
<h4 id="构建"><a href="#构建" class="headerlink" title="构建"></a>构建</h4><p>进入willup, 执行<code>sbt</code>命令，sbt就会自动帮我们自动下载Scalatra的开发环境了，这需要些时间。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">root@will-vm:/usr/local/will/learning/willup# sbt</div><div class="line">[info] Loading settings from plugins.sbt ...</div><div class="line">[info] Loading project definition from /usr/local/will/learning/willup/project</div><div class="line">[info] Updating &#123;file:/usr/local/will/learning/willup/project/&#125;willup-build...</div><div class="line">[info] downloading https://repo1.maven.org/maven2/com/amazonaws/jmespath-java/1.11.105/jmespath-java-1.11.105.jar ...</div><div class="line">[info] downloading https://repo.scala-sbt.org/scalasbt/sbt-plugin-releases/com.typesafe.sbt/sbt-twirl/scala_2.12/sbt_1.0/1.3.12/jars/sbt-twirl.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] com.amazonaws#jmespath-java;1.11.105!jmespath-java.jar (824ms)</div><div class="line">[info] downloading https://repo1.maven.org/maven2/org/apache/httpcomponents/httpclient/4.5.2/httpclient-4.5.2.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] com.typesafe.sbt#sbt-twirl;1.3.12!sbt-twirl.jar (3335ms)</div><div class="line">[info] downloading https://repo1.maven.org/maven2/org/scalatra/sbt/sbt-scalatra_2.12_1.0/1.0.1/sbt-scalatra-1.0.1.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] org.apache.httpcomponents#httpclient;4.5.2!httpclient.jar (3126ms)</div><div class="line">[info] downloading https://repo1.maven.org/maven2/software/amazon/ion/ion-java/1.0.2/ion-java-1.0.2.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] org.scalatra.sbt#sbt-scalatra;1.0.1!sbt-scalatra.jar (1806ms)</div><div class="line">[info] downloading https://repo1.maven.org/maven2/com/typesafe/play/twirl-compiler_2.12/1.3.12/twirl-compiler_2.12-1.3.12.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] com.typesafe.play#twirl-compiler_2.12;1.3.12!twirl-compiler_2.12.jar (883ms)</div><div class="line">[info] downloading https://repo1.maven.org/maven2/com/typesafe/play/twirl-api_2.12/1.3.12/twirl-api_2.12-1.3.12.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] software.amazon.ion#ion-java;1.0.2!ion-java.jar(bundle) (1941ms)</div><div class="line">[info] downloading https://repo1.maven.org/maven2/com/fasterxml/jackson/core/jackson-databind/2.6.6/jackson-databind-2.6.6.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] com.typesafe.play#twirl-api_2.12;1.3.12!twirl-api_2.12.jar (791ms)</div><div class="line">[info] downloading https://repo1.maven.org/maven2/com/typesafe/play/twirl-parser_2.12/1.3.12/twirl-parser_2.12-1.3.12.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] com.typesafe.play#twirl-parser_2.12;1.3.12!twirl-parser_2.12.jar (866ms)</div><div class="line">[info] downloading https://repo.scala-sbt.org/scalasbt/sbt-plugin-releases/com.earldouglas/xsbt-web-plugin/scala_2.12/sbt_1.0/4.0.1/jars/xsbt-web-plugin.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] com.fasterxml.jackson.core#jackson-databind;2.6.6!jackson-databind.jar(bundle) (2843ms)</div><div class="line">[info] downloading https://repo1.maven.org/maven2/com/fasterxml/jackson/dataformat/jackson-dataformat-cbor/2.6.6/jackson-dataformat-cbor-2.6.6.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] com.fasterxml.jackson.dataformat#jackson-dataformat-cbor;2.6.6!jackson-dataformat-cbor.jar(bundle) (789ms)</div><div class="line">[info] downloading https://repo1.maven.org/maven2/joda-time/joda-time/2.8.1/joda-time-2.8.1.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] com.earldouglas#xsbt-web-plugin;4.0.1!xsbt-web-plugin.jar (2691ms)</div><div class="line">[info] downloading https://repo1.maven.org/maven2/com/amazonaws/aws-java-sdk-elasticbeanstalk/1.11.105/aws-java-sdk-elasticbeanstalk-1.11.105.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] joda-time#joda-time;2.8.1!joda-time.jar (1708ms)</div><div class="line">[info] downloading https://repo1.maven.org/maven2/org/apache/httpcomponents/httpcore/4.4.4/httpcore-4.4.4.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] com.amazonaws#aws-java-sdk-elasticbeanstalk;1.11.105!aws-java-sdk-elasticbeanstalk.jar (1578ms)</div><div class="line">[info] downloading https://repo1.maven.org/maven2/com/amazonaws/aws-java-sdk-s3/1.11.105/aws-java-sdk-s3-1.11.105.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] org.apache.httpcomponents#httpcore;4.4.4!httpcore.jar (1054ms)</div><div class="line">[info] downloading https://repo1.maven.org/maven2/com/fasterxml/jackson/core/jackson-annotations/2.6.0/jackson-annotations-2.6.0.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] com.fasterxml.jackson.core#jackson-annotations;2.6.0!jackson-annotations.jar(bundle) (831ms)</div><div class="line">[info] downloading https://repo1.maven.org/maven2/com/fasterxml/jackson/core/jackson-core/2.6.6/jackson-core-2.6.6.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] com.amazonaws#aws-java-sdk-s3;1.11.105!aws-java-sdk-s3.jar (1627ms)</div><div class="line">[info] downloading https://repo1.maven.org/maven2/com/amazonaws/aws-java-sdk-core/1.11.105/aws-java-sdk-core-1.11.105.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] com.fasterxml.jackson.core#jackson-core;2.6.6!jackson-core.jar(bundle) (1238ms)</div><div class="line">[info] downloading https://repo1.maven.org/maven2/com/amazonaws/aws-java-sdk-kms/1.11.105/aws-java-sdk-kms-1.11.105.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] com.amazonaws#aws-java-sdk-core;1.11.105!aws-java-sdk-core.jar (1825ms)</div><div class="line">[info] 	[SUCCESSFUL ] com.amazonaws#aws-java-sdk-kms;1.11.105!aws-java-sdk-kms.jar (1140ms)</div><div class="line">[info] Done updating.</div><div class="line">[info] Loading settings from build.sbt ...</div><div class="line">[info] Set current project to willup (in build file:/usr/local/will/learning/willup/)</div><div class="line">[info] sbt server started at 127.0.0.1:4841</div></pre></td></tr></table></figure>
<h4 id="Hello-world"><a href="#Hello-world" class="headerlink" title="Hello world"></a>Hello world</h4><p>到此为止Scalatra已经安装完了，咱们着手弄个小app吧。</p>
]]></content>
      
        
        <tags>
            
            <tag> scala </tag>
            
            <tag> scalatra </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[scala集合视图]]></title>
      <url>/2017/11/09/scala%E9%9B%86%E5%90%88%E8%A7%86%E5%9B%BE/</url>
      <content type="html"><![CDATA[<p>场景：</p>
<ul>
<li>性能</li>
<li>像处理数据库视图一样处理集合</li>
</ul>
<p>视图就是推迟执行，该用多大内存还使用多大内存，该遍历多少元素还是遍历多少元素。说白了scala视图就跟数据库视图一样，不使用视图就跟数据库建立临时表一样。使用视图，当原始集合改变的时候，不需要重新跑transformers方法，使用视图则每次使用视图的时候都会跑一次transformers方法内容。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ubuntu磁盘相关]]></title>
      <url>/2017/11/08/ubuntu%E7%A3%81%E7%9B%98%E7%9B%B8%E5%85%B3/</url>
      <content type="html"><![CDATA[<p>主要是自己工作用的ubuntu虚拟机因为最开始分配的磁盘不够，需要从外面额外扩展一下磁盘。</p>
<p>过程中，小小记录一下一些点，下次处理快一些。</p>
<h4 id="图形化磁盘分析工具"><a href="#图形化磁盘分析工具" class="headerlink" title="图形化磁盘分析工具"></a>图形化磁盘分析工具</h4><p>baobab，这个工具是ubuntu16里已经默认有了的。其实就类似du –max-depth=1 -h /，然后不用自己一层层去找所有目录的大小。它是一下子帮我们分析出所有的目录空间，当然时间就会长一些。相比命令行，优点当然就是查看与比较起来更加方便，快速定位到大磁盘，审慎地处理一些没用的数据。</p>
<p><img src="https://dn-linuxcn.qbox.me/data/attachment/album/201404/24/151605g7xh8uhk7a8b5suu.png" alt=""></p>
<p>当然，因为要统计所有目录空间大小，再呈现出来，所以速度会慢一些。</p>
<h4 id="图形化磁盘分区工具"><a href="#图形化磁盘分区工具" class="headerlink" title="图形化磁盘分区工具"></a>图形化磁盘分区工具</h4><p>通过vmware给虚拟机扩展磁盘到80以后，执行fdisk -l，发现并没有出现新的40G空间。</p>
<p>gparted, 这个需要额外通过apt进行安装。可以方便地完成磁盘格式化等操作，自己敲命令进行分区与格式化，会稍微有些不自信。</p>
<p><img src="http://1833.img.pp.sohu.com.cn/images/blog/2008/9/18/16/2/11d1b7819a1g213.jpg" alt=""></p>
<p>方案确认之后，点击上面的对勾，开始执行所有的变更操作。之后<code>fdisk -l</code>就可以看到新的空间了。</p>
<h4 id="挂载磁盘"><a href="#挂载磁盘" class="headerlink" title="挂载磁盘"></a>挂载磁盘</h4><p>一次性挂载，就使用mount命令就可以了。</p>
<p>永久的话，就需要编辑/etc/fstab了。但是在此之前，我们要通过<code>blkid</code>命令先获取到要挂载磁盘的UUID,，然后再添加下面内容。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">UUID=e23a1c1e-8d91-4df8-8fba-f0656a1080ab	/will_data	ext4	defaults,errors=remount-ro	0	1</div></pre></td></tr></table></figure>
<p>参考：</p>
<ul>
<li><a href="https://gist.github.com/gaoyifan/019ad7766f030ab5be50" target="_blank" rel="external">https://gist.github.com/gaoyifan/019ad7766f030ab5be50</a></li>
<li><a href="http://www.jianshu.com/p/ec5579ef15a6" target="_blank" rel="external">http://www.jianshu.com/p/ec5579ef15a6</a></li>
</ul>
<h4 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h4><p>妈蛋，后来发现是自己的Trash一直没有清空过….有5G的数据。清空后空间够了…..</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hue中添加spark-shell的支持]]></title>
      <url>/2017/11/07/hue%E4%B8%AD%E6%B7%BB%E5%8A%A0spark-shell%E7%9A%84%E6%94%AF%E6%8C%81/</url>
      <content type="html"><![CDATA[<p>计划： livy + hue + spark</p>
<p>通过ambari已经部署完成了livy，并且通过了curl的spark测试。</p>
<p>参考： <a href="http://gethue.com/how-to-use-the-livy-spark-rest-job-server-for-interactive-spark-2-2/" target="_blank" rel="external">http://gethue.com/how-to-use-the-livy-spark-rest-job-server-for-interactive-spark-2-2/</a></p>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"># 修改spark配置</div><div class="line"></div><div class="line">[spark]</div><div class="line">  # Host address of the Livy Server.</div><div class="line">  livy_server_host=servicenode02.will.com</div><div class="line"></div><div class="line">  # Port of the Livy Server.</div><div class="line">  livy_server_port=8998</div><div class="line"></div><div class="line">  # Configure livy to start in local &apos;process&apos; mode, or &apos;yarn&apos; workers.</div><div class="line">  ivy_server_session_kind=yarn</div><div class="line"></div><div class="line">  # If livy should use proxy users when submitting a job.</div><div class="line">  ## livy_impersonation_enabled=true</div><div class="line"></div><div class="line">  # Host of the Sql Server</div><div class="line">  ## sql_server_host=localhost</div><div class="line"></div><div class="line">  # Port of the Sql Server</div><div class="line">  ## sql_server_port=10000</div><div class="line"></div><div class="line"></div><div class="line">[[[spark]]]</div><div class="line">  name=Scala</div><div class="line">  interface=livy</div><div class="line"></div><div class="line">[[[pyspark]]]</div><div class="line">  name=PySpark</div><div class="line">  interface=livy</div></pre></td></tr></table></figure>
<p>但是部署在hue中的时候，总是出现session问题, 在hue的example中下载了spark的测试notebook，执行pyspark的1+1+1时候出现提示</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[07/Nov/2017 01:06:17 -0800] decorators   ERROR    error running &lt;function execute at 0x7f0ca465ae60&gt;</div><div class="line">Traceback (most recent call last):</div><div class="line">  File &quot;/server/hue/desktop/libs/notebook/src/notebook/decorators.py&quot;, line 81, in decorator</div><div class="line">    return func(*args, **kwargs)</div><div class="line">  File &quot;/server/hue/desktop/libs/notebook/src/notebook/api.py&quot;, line 109, in execute</div><div class="line">    response[&apos;handle&apos;] = get_api(request, snippet).execute(notebook, snippet)</div><div class="line">  File &quot;/server/hue/desktop/libs/notebook/src/notebook/connectors/spark_shell.py&quot;, line 194, in execute</div><div class="line">    raise e</div><div class="line">RestException: &quot;Session &apos;-1&apos; not found.&quot; (error 404)</div></pre></td></tr></table></figure>
<p>然后可以在livy server的rest api中看到session<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;from&quot;: 0,</div><div class="line">    &quot;total&quot;: 1,</div><div class="line">    &quot;sessions&quot;: [</div><div class="line">        &#123;</div><div class="line">            &quot;state&quot;: &quot;idle&quot;,</div><div class="line">            &quot;proxyUser&quot;: null,</div><div class="line">            &quot;id&quot;: 0,</div><div class="line">            &quot;kind&quot;: &quot;pyspark&quot;,</div><div class="line">            &quot;log&quot;: [</div><div class="line">                &quot;17/11/07 16:01:15 INFO SparkContext: Added file file:/usr/hdp/current/spark-client/python/lib/py4j-0.9-src.zip at file:/usr/hdp/current/spark-client/python/lib/py4j-0.9-src.zip with timestamp 1510041675612&quot;,</div><div class="line">                &quot;17/11/07 16:01:15 INFO Executor: Starting executor ID driver on host localhost&quot;,</div><div class="line">                &quot;17/11/07 16:01:15 INFO Utils: Successfully started service &apos;org.apache.spark.network.netty.NettyBlockTransferService&apos; on port 42523.&quot;,</div><div class="line">                &quot;17/11/07 16:01:15 INFO NettyBlockTransferService: Server created on 42523&quot;,</div><div class="line">                &quot;17/11/07 16:01:15 INFO BlockManagerMaster: Trying to register BlockManager&quot;,</div><div class="line">                &quot;17/11/07 16:01:15 INFO BlockManagerMasterEndpoint: Registering block manager localhost:42523 with 511.1 MB RAM, BlockManagerId(driver, localhost, 42523)&quot;,</div><div class="line">                &quot;17/11/07 16:01:15 INFO BlockManagerMaster: Registered BlockManager&quot;,</div><div class="line">                &quot;17/11/07 16:01:16 WARN DomainSocketFactory: The short-circuit local reads feature cannot be used because libhadoop cannot be loaded.&quot;,</div><div class="line">                &quot;17/11/07 16:01:16 INFO EventLoggingListener: Logging events to hdfs:///spark-history/local-1510041675669&quot;,</div><div class="line">                &quot;17/11/07 16:01:18 INFO ScalatraBootstrap: Calling http://servicenode02.will.com:8998/sessions/0/callback...&quot;</div><div class="line">            ]</div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>点击recreate scala 的session后，发现scala代码是可以执行的。那么，我猜测，有可能pyspark也是一样的道理。</p>
<p>scala代码如下：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> data = <span class="type">Array</span>(<span class="number">0</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">45</span>,<span class="number">2</span>);</div><div class="line"><span class="keyword">val</span> disData = sc.parallelize(data);</div><div class="line">disData.map(s=&gt;s+<span class="number">1</span>).collect();</div></pre></td></tr></table></figure></p>
<p>而且观察到此时livy的sessions接口里的session也有了变化<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;from&quot;: 0,</div><div class="line">    &quot;total&quot;: 1,</div><div class="line">    &quot;sessions&quot;: [</div><div class="line">        &#123;</div><div class="line">            &quot;state&quot;: &quot;idle&quot;,</div><div class="line">            &quot;proxyUser&quot;: null,</div><div class="line">            &quot;id&quot;: 1,</div><div class="line">            &quot;kind&quot;: &quot;spark&quot;,</div><div class="line">            &quot;log&quot;: [</div><div class="line">                &quot;17/11/07 17:43:10 INFO TaskSetManager: Finished task 0.0 in stage 0.0 (TID 0) in 2909 ms on localhost (5/8)&quot;,</div><div class="line">                ............</div><div class="line">                &quot;17/11/07 17:43:21 INFO BlockManagerInfo: Removed broadcast_0_piece0 on localhost:36806 in memory (size: 1257.0 B, free: 511.1 MB)&quot;</div><div class="line">            ]</div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>到notebook的上面，点击pspark的recreate的地方，观察session变化：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    &quot;from&quot;: 0,</div><div class="line">    &quot;total&quot;: 2,</div><div class="line">    &quot;sessions&quot;: [</div><div class="line">        &#123;</div><div class="line">            &quot;state&quot;: &quot;idle&quot;,</div><div class="line">            &quot;proxyUser&quot;: null,</div><div class="line">            &quot;id&quot;: 2,</div><div class="line">            &quot;kind&quot;: &quot;pyspark&quot;,</div><div class="line">            &quot;log&quot;: [</div><div class="line">                &quot;17/11/07 17:45:18 INFO SparkContext: Added file file:/usr/hdp/current/spark-client/python/lib/py4j-0.9-src.zip at file:/usr/hdp/current/spark-client/python/lib/py4j-0.9-src.zip with timestamp 1510047918034&quot;,</div><div class="line">                .......</div><div class="line">                &quot;17/11/07 17:45:24 INFO ScalatraBootstrap: Calling http://servicenode02.will.com:8998/sessions/2/callback...&quot;</div><div class="line">            ]</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">            &quot;state&quot;: &quot;idle&quot;,</div><div class="line">            &quot;proxyUser&quot;: null,</div><div class="line">            &quot;id&quot;: 1,</div><div class="line">            &quot;kind&quot;: &quot;spark&quot;,</div><div class="line">            &quot;log&quot;: [</div><div class="line">                &quot;17/11/07 17:43:10 INFO TaskSetManager: Finished task 0.0 in stage 0.0 (TID 0) in 2909 ms on localhost (5/8)&quot;,</div><div class="line">                ......</div><div class="line">                &quot;17/11/07 17:43:21 INFO BlockManagerInfo: Removed broadcast_0_piece0 on localhost:36806 in memory (size: 1257.0 B, free: 511.1 MB)&quot;</div><div class="line">            ]</div><div class="line">        &#125;</div><div class="line">    ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>多了一个。好，那么再次去执行我们的代码。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">file = sc.textFile(<span class="string">"/apps/hive/warehouse/sample_08/sample_08"</span>)</div><div class="line"></div><div class="line">file = file.flatMap(<span class="keyword">lambda</span> line: line.split(<span class="string">"\t"</span>)).map(<span class="keyword">lambda</span> word: (word, <span class="number">1</span>)).reduceByKey(<span class="keyword">lambda</span> a, b: a + b)</div><div class="line"></div><div class="line"><span class="keyword">for</span> row <span class="keyword">in</span> file.collect()[:<span class="number">5</span>]:</div><div class="line">  <span class="keyword">print</span> row</div></pre></td></tr></table></figure>
<p>然后就可以了。哈哈</p>
<p>查看一下livy server的log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">17/11/07 17:44:50 INFO SparkProcessBuilder: Running sh -c /usr/hdp/current/spark-client/bin/spark-submit</div><div class="line">--name Livy </div><div class="line">--jars /usr/hdp/current/livy-server/repl-jars/mime-util-2.1.3.jar,/usr/hdp/current/livy-server/repl-jars/jetty-io-9.2.10.v20150310.jar,/usr/hdp/current/livy-server/repl-jars/jetty-security-9.2.10.v20150310.jar,/usr/hdp/current/livy-server/repl-jars/jetty-util-9.2.10.v20150310.jar,/usr/hdp/current/livy-server/repl-jars/livy-api-0.2.0.2.4.2.0-258.jar,/usr/hdp/current/livy-server/repl-jars/livy-core-0.2.0.2.4.2.0-258.jar,/usr/hdp/current/livy-server/repl-jars/rl_2.10-0.4.10.jar,/usr/hdp/current/livy-server/repl-jars/async-http-client-1.9.33.jar,/usr/hdp/current/livy-server/repl-jars/jetty-server-9.2.10.v20150310.jar,/usr/hdp/current/livy-server/repl-jars/commons-codec-1.9.jar,/usr/hdp/current/livy-server/repl-jars/joda-convert-1.6.jar,/usr/hdp/current/livy-server/repl-jars/scalatra-json_2.10-2.3.0.jar,/usr/hdp/current/livy-server/repl-jars/kryo-2.22.jar,/usr/hdp/current/livy-server/repl-jars/joda-time-2.3.jar,/usr/hdp/current/livy-server/repl-jars/grizzled-slf4j_2.10-1.0.2.jar,/usr/hdp/current/livy-server/repl-jars/scalatra-common_2.10-2.3.0.jar,/usr/hdp/current/livy-server/repl-jars/livy-client-common-0.2.0.2.4.2.0-258.jar,/usr/hdp/current/livy-server/repl-jars/livy-repl-0.2.0.2.4.2.0-258.jar,/usr/hdp/current/livy-server/repl-jars/jetty-http-9.2.10.v20150310.jar,/usr/hdp/current/livy-server/repl-jars/jetty-servlet-9.2.10.v20150310.jar,/usr/hdp/current/livy-server/repl-jars/scalatra_2.10-2.3.0.jar,/usr/hdp/current/livy-server/repl-jars/juniversalchardet-1.0.3.jar,/usr/hdp/current/livy-server/repl-jars/javax.servlet-api-3.1.0.jar,/usr/hdp/current/livy-server/repl-jars/netty-3.10.5.Final.jar </div><div class="line">--files /usr/hdp/current/spark-client/python/lib/pyspark.zip,/usr/hdp/current/spark-client/python/lib/py4j-0.9-src.zip </div><div class="line">--class com.cloudera.livy.repl.Main --conf spark.executor.memory=1G --conf spark.driver.memory=1G </div><div class="line">--conf spark.submit.pyFiles=/usr/hdp/current/spark-client/python/lib/pyspark.zip,/usr/hdp/current/spark-client/python/lib/py4j-0.9-src.zip </div><div class="line">--conf spark.driver.cores=1 </div><div class="line">--conf spark.livy.callbackUrl=http://servicenode02.will.com:8998/sessions/2/callback </div><div class="line">--conf spark.livy.port=0 </div><div class="line">--conf spark.yarn.isPython=true </div><div class="line">--conf spark.executor.cores=1 </div><div class="line">--queue default </div><div class="line">spark-internal pyspark</div><div class="line">17/11/07 17:44:50 INFO SessionManager: Registering new session 2</div></pre></td></tr></table></figure></p>
<p>竟然没有提交到yarn上执行！！上面的参数我们明明配置了yarn啊。再查一下livy server的<a href="https://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.6.2/bk_command-line-installation/content/configure_livy2.html" target="_blank" rel="external">相关配置信息</a>。</p>
<p>到ambari添加配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">livy.spark.master=yarn-cluster</div></pre></td></tr></table></figure></p>
<p>重启。并没有生效。</p>
<p>看下配置，竟然是这样的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">livy.environment production</div><div class="line">livy.impersonation.enabled false</div><div class="line">livy.server.port 8998</div><div class="line">livy.server.session.timeout 3600000</div><div class="line">livy.spark.master yarn-cluster</div></pre></td></tr></table></figure></p>
<p>中间的等号都没有了。</p>
<p>手动修改，暂时不用ambari了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">livy.environment =production</div><div class="line">livy.impersonation.enabled= false</div><div class="line">livy.server.port= 8998</div><div class="line">livy.server.session.timeout =3600000</div><div class="line">livy.spark.master= yarn-cluster</div></pre></td></tr></table></figure></p>
<p>而且通过<code>ps -ef | grep livy</code>发现，ambari 2.2.2.0的livy对于stop并不完整，会有泄露问题存在。虽然livy server关掉了，但是它打开的spark进程却仍然存在。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[iptables端口转发]]></title>
      <url>/2017/11/06/iptables%E7%AB%AF%E5%8F%A3%E8%BD%AC%E5%8F%91/</url>
      <content type="html"><![CDATA[<p>先放一张iptables的处理流程图</p>
<p><img src="http://xstarcd.github.io/wiki/img/iptables_netfilter_chains.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># 在PREROUTING中添加转发规则:把从eth0网卡进来的1234端口的访问，定向到10.103.27.171:2224。</div><div class="line">iptables -t nat -A PREROUTING -p tcp -i eth0 --dport 1234 -j DNAT --to 10.103.27.171:2224</div><div class="line"></div><div class="line"></div><div class="line"># j后面是操作，masquerade的意思是伪装</div><div class="line">iptables -t nat -A POSTROUTING -j MASQUERADE</div><div class="line"></div><div class="line"># 保存并重启</div><div class="line">service iptables save</div><div class="line">service iptables restart</div></pre></td></tr></table></figure>
<p>查看iptables的nat表相关配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">[root@node83 nginxserver_new]# iptables -t nat -L -vn</div><div class="line">Chain PREROUTING (policy ACCEPT 12 packets, 650 bytes)</div><div class="line"> pkts bytes target     prot opt in     out     source               destination         </div><div class="line">    0     0 DNAT       tcp  --  *      *       0.0.0.0/0            60.1.1.1            tcp dpt:80 to:10.103.70.27:2224 </div><div class="line">   16  2578 DNAT       tcp  --  *      *       0.0.0.0/0            10.103.27.171       tcp dpt:80 to:10.103.70.27:2224 </div><div class="line">   10   520 DNAT       tcp  --  *      *       0.0.0.0/0            10.103.27.171       tcp dpt:1234 to:10.103.70.27:2224 </div><div class="line">    0     0 DNAT       tcp  --  eth0   *       0.0.0.0/0            0.0.0.0/0           tcp dpt:1234 to:10.103.27.171:2224 </div><div class="line"></div><div class="line">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt in     out     source               destination         </div><div class="line">   69  5738 MASQUERADE  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT 43 packets, 2640 bytes)</div><div class="line"> pkts bytes target     prot opt in     out     source               destination</div><div class="line"></div><div class="line"># 删除nat表第4个规则</div><div class="line">[root@node83 nginxserver_new]# iptables -t nat -D PREROUTING 4</div><div class="line"># 再看一下规则</div><div class="line">[root@node83 nginxserver_new]# iptables -t nat -L -vn</div><div class="line">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt in     out     source               destination         </div><div class="line">    0     0 DNAT       tcp  --  *      *       0.0.0.0/0            60.1.1.1            tcp dpt:80 to:10.103.70.27:2224 </div><div class="line">  130  8506 DNAT       tcp  --  *      *       0.0.0.0/0            10.103.27.171       tcp dpt:80 to:10.103.70.27:2224 </div><div class="line">   10   520 DNAT       tcp  --  *      *       0.0.0.0/0            10.103.27.171       tcp dpt:1234 to:10.103.70.27:2224 </div><div class="line"></div><div class="line">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt in     out     source               destination         </div><div class="line">  394 24326 MASQUERADE  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT 2 packets, 120 bytes)</div><div class="line"> pkts bytes target     prot opt in     out     source               destination         </div><div class="line"># 清空NAT表中PREROUTTING的规则</div><div class="line">[root@node83 nginxserver_new]# iptables -t nat -F PREROUTING </div><div class="line"># 再看一下规则</div><div class="line">[root@node83 nginxserver_new]# iptables -t nat -L -vn</div><div class="line">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt in     out     source               destination         </div><div class="line"></div><div class="line">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt in     out     source               destination         </div><div class="line">  420 25806 MASQUERADE  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT 2 packets, 120 bytes)</div><div class="line"> pkts bytes target     prot opt in     out     source               destination</div></pre></td></tr></table></figure></p>
<p>参考：</p>
<ul>
<li><a href="http://xstarcd.github.io/wiki/Linux/iptables_forward_internetshare.html" target="_blank" rel="external">http://xstarcd.github.io/wiki/Linux/iptables_forward_internetshare.html</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[kudu简介]]></title>
      <url>/2017/11/02/kudu%E7%AE%80%E4%BB%8B/</url>
      <content type="html"><![CDATA[<p>为apache hadoop平台开发的列式存储管理器。kudo拥有hadoop生态的很多特性：廉价硬件、水平扩展、高可用。</p>
<h5 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h5><ul>
<li>HDFS可以快速追加和查询，尤其是顺序扫描，如果能和parquet结合就可以有更好的表现。</li>
<li>hbase擅长处理易变的数据，快速查询和写单条数据。</li>
</ul>
<p>kudu介于两者之间。</p>
<p>kudu结合了parquet和hbase的特性，创建了一个本地列式存储的系统。</p>
<p>kudu特性:</p>
<ul>
<li>动态管理分区，动态创建明天的分区，删除100天前的分区</li>
<li>删除指定range的数据</li>
<li>支持kerberos认证，内部的task也使用kerberos给的token进行内部验证</li>
<li>server之间、server和client之间TLS加密处理，不影响框架处理速度。如果都在本机，就不用走这个</li>
<li>三种访问角色：client、admin、service[给daemon使用的]。也有白名单之类</li>
<li>ksck工具链接到master查看整体状态</li>
<li>rack aware</li>
</ul>
<ul>
<li>严格结构化数据，不支持blob</li>
<li>多语言API</li>
<li>与spark和impala整合好的API</li>
<li>所有table都被分区，每个分区叫做tablet，每个tablet有多个备份，使用raft达成最终一致，<strong>都存在本地磁盘</strong>，并不基于HDFS。HDFS的机制不能支持分布式存储，不能快速处理failover，还有内存部分快速访问的设计，这里有些像kafka的思想。</li>
<li>metadata，把所有的metadata放在内存中，以便快速访问或处理</li>
<li>spark、impala、MR、flume、drill整合</li>
</ul>
<h2 id="给spark带来啥"><a href="#给spark带来啥" class="headerlink" title="给spark带来啥"></a>给spark带来啥</h2><ul>
<li>像parquet的性能，而且insert和update都无延迟</li>
<li>pushdown predicate filter，更快更高效的扫描</li>
<li>相比parquet还有主键索引</li>
<li>在master中metadata的查找，精准找到目标partition</li>
</ul>
<h5 id="针对spark的优化"><a href="#针对spark的优化" class="headerlink" title="针对spark的优化"></a>针对spark的优化</h5><ul>
<li>只读取有关的字段</li>
<li>自动将where转化为kudu predicate</li>
<li>kudu predicate自动转化为主键扫描等</li>
</ul>
<h5 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h5><p>可以在spark中注册临时表，然后针对临时表执行kudu查询的操作。</p>
<h5 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h5><p>如果查询的数据在内存，那么kudu比parquet快，否则差不多会比parquet慢一倍。单条数据处理，虽然比较快了，但还是会比phenix慢很多。</p>
<h5 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h5><ul>
<li>顺序或随机的读写</li>
<li><p>最小化数据延迟</p>
</li>
<li><p>时间序列数据</p>
</li>
<li>实时报表/实时数据仓库(ODS)</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=NEg1nn9UyBY" target="_blank" rel="external">https://www.youtube.com/watch?v=NEg1nn9UyBY</a></li>
<li><a href="https://www.youtube.com/watch?v=CLP6jHs2z14" target="_blank" rel="external">https://www.youtube.com/watch?v=CLP6jHs2z14</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ambari源码解析-告警问题]]></title>
      <url>/2017/11/02/ambari%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E5%91%8A%E8%AD%A6%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<p>按照官网部署了一个简单的notice target脚本，就是把所有的脚本参数都输出到一个临时文件，然后发现虽然ambari server的web页面中有一大堆alert，但是实际触发alert_notice的很少，而且与web页面中看到的alert定义的check interval严重不符。到ambari-server的log里也没有找到heartbeat的连续信息之类。。。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo $* &gt;&gt; /tmp/ambari_alerts</div></pre></td></tr></table></figure></p>
<p>回顾一下上面的代码: 只有接收到AlertStateChangeEvent才会触发持久化到alert_notice表，也就是说只针对alert有状态变更才发送notice。尼玛，那如果报了一次之后，后面一直没有收到新的相关notice的话，就默认它是原状？？？ 细想好像这样也对，可以省掉最新。可是并不符合我们最初设想的持续告警。</p>
<p>另外还有一个问题，就是脚本参数里并不包含对应的host信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">datanode_heap_usage DataNode Heap Usage HDFS WARNING Used Heap:[81%, 1633.3276 MB], Max Heap: 2028.0 MB</div><div class="line">datanode_heap_usage DataNode Heap Usage HDFS OK Used Heap:[78%, 1587.691 MB], Max Heap: 2028.0 MB</div><div class="line">datanode_heap_usage DataNode Heap Usage HDFS WARNING Used Heap:[80%, 1623.7538 MB], Max Heap: 2028.0 MB</div><div class="line">datanode_heap_usage DataNode Heap Usage HDFS OK Used Heap:[78%, 1584.6304 MB], Max Heap: 2028.0 MB</div><div class="line">datanode_heap_usage DataNode Heap Usage HDFS OK Used Heap:[78%, 1577.2762 MB], Max Heap: 2028.0 MB</div><div class="line">datanode_heap_usage DataNode Heap Usage HDFS WARNING Used Heap:[81%, 1650.835 MB], Max Heap: 2028.0 MB</div></pre></td></tr></table></figure></p>
<p>看来需要一系列的代码改造才能完全满足我们的需求，就是每次收到heartbeat中的alert信息之后，根据优先级进行过滤，这个优先级最好是读取配置文件的。然后把所有的alert都持久化到alert_notice表中。如果要兼容官网原生的话，就在AlertReceivedListener的onAlertEvent的修改中加入一个option，比如1代表使用官网的notice，2代表使用自定义的notice，这个option可以是全局的，也可以是附属在alert_definition里的【后者需要修改alert_definition, 动作偏大，而且一般环境中只有一种告警方式就够了】。</p>
<p>写点儿伪代码，体会一下，先修改AlertReceivedListener.onAlertEvent。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">....</div><div class="line"><span class="keyword">for</span> (Map.Entry&lt;Alert, AlertCurrentEntity&gt; entry : toCreateHistoryAndMerge.entrySet()) &#123;</div><div class="line">  Alert alert = entry.getKey();</div><div class="line">  AlertCurrentEntity entity = entry.getValue();</div><div class="line">  Long clusterId = getClusterIdByName(alert.getCluster());</div><div class="line"></div><div class="line">  <span class="keyword">boolean</span> fire = <span class="keyword">false</span>;</div><div class="line">  <span class="keyword">if</span>(m_configuration.getCustom_alert() &amp;&amp; alert.getState() == AlertState.CRITICAL) &#123;</div><div class="line">    fire = <span class="keyword">true</span>;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">if</span> (clusterId == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="comment">//super rare case, cluster was removed after isValid() check</span></div><div class="line">      LOG.error(<span class="string">"Unable to process alert &#123;&#125; for an invalid cluster named &#123;&#125;"</span>,</div><div class="line">              alert.getName(), alert.getCluster());</div><div class="line">      <span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line">    fire = <span class="keyword">true</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (fire) &#123;</div><div class="line">    AlertStateChangeEvent alertChangedEvent = <span class="keyword">new</span> AlertStateChangeEvent(clusterId, alert, entity,</div><div class="line">            oldStates.get(alert));</div><div class="line"></div><div class="line">    m_alertEventPublisher.publish(alertChangedEvent);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>其实按照编程命名规范，如果是所有的alert都要按照级别过滤后发送的话，最好自定义一种类型的event，然后再添加一个对应的eventListener。</p>
<p>鉴于上面提到的没有host信息，也要host加到dispatcher的参数中。我们整一下AlertScriptDispatcher, 发现他的接口参数AlertNotification中是包含hostname的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">ProcessBuilder getProcessBuilder(String script, AlertNotification notification) &#123;</div><div class="line">    final String shellCommand;</div><div class="line">    final String shellCommandOption;</div><div class="line">    if (SystemUtils.IS_OS_WINDOWS) &#123;</div><div class="line">      shellCommand = &quot;cmd&quot;;</div><div class="line">      shellCommandOption = &quot;/c&quot;;</div><div class="line">    &#125; else &#123;</div><div class="line">      shellCommand = &quot;sh&quot;;</div><div class="line">      shellCommandOption = &quot;-c&quot;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    AlertInfo alertInfo = notification.getAlertInfo();</div><div class="line">    AlertDefinitionEntity definition = alertInfo.getAlertDefinition();</div><div class="line">    String definitionName = definition.getDefinitionName();</div><div class="line">    AlertState alertState = alertInfo.getAlertState();</div><div class="line">    String serviceName = alertInfo.getServiceName();</div><div class="line">    // 这里</div><div class="line">    String hostname = alertInfo.getHostName();</div><div class="line"></div><div class="line">    // these could have spaces in them, so quote them so they don&apos;t mess up the</div><div class="line">    // command line</div><div class="line">    String alertLabel = &quot;\&quot;&quot; + SHELL_ESCAPE.escape(definition.getLabel()) + &quot;\&quot;&quot;;</div><div class="line">    String alertText = &quot;\&quot;&quot; + SHELL_ESCAPE.escape(alertInfo.getAlertText()) + &quot;\&quot;&quot;;</div><div class="line"></div><div class="line">    // 构建的参数里也加上</div><div class="line">    Object[] params = new Object[] &#123; script, definitionName, alertLabel, serviceName, hostname,</div><div class="line">        alertState.name(), alertText &#125;;</div><div class="line"></div><div class="line">    String foo = StringUtils.join(params, &quot; &quot;);</div><div class="line"></div><div class="line">    // sh -c &apos;/foo/sys_logger.py ambari_server_agent_heartbeat &quot;Agent Heartbeat&quot;</div><div class="line">    // AMBARI CRITICAL &quot;Something went wrong with the host&quot;&apos;</div><div class="line">    return new ProcessBuilder(shellCommand, shellCommandOption, foo);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>至此，改造完成。构建完成后，发布到ambari-server的对应位置，重启就可以了。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ambari源码解析-告警流程]]></title>
      <url>/2017/10/31/ambari%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E5%91%8A%E8%AD%A6%E6%B5%81%E7%A8%8B/</url>
      <content type="html"><![CDATA[<p>从ambari的包找起，找到一个alert的package，下面有一个类StaleAlertRunnable，看一下注释：。那么谁调用它呢？AmbariServerAlertService，与它在同一个目录的还有一个名字很显眼的类AlertNoticeDispatchService。</p>
<p>它是用来扫描表<code>alert_notice</code>中状态为pending的记录，并调用各种dispatcher执行告警分发的。那么谁把notice放进这个表里的呢？没有追踪到。</p>
<p>不过我们发现它继承自guava的<code>AbstractScheduledService</code>类，那么就搜一下这个类的使用，发现在ControllerModule里出现，而ControllerModule是出现在AmbariServer.main之中的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Injector injector = Guice.createInjector(<span class="keyword">new</span> ControllerModule());</div></pre></td></tr></table></figure>
<p>使用工具guice执行了ControllerModule中的依赖注入工作。我们知道Guice.createInjector接收<code>AbstractModule</code>接口的类，一般我们需要实现<code>AbstractModule</code>接口的<code>configure</code>方法。然后在<code>configure</code>方法中将依赖的接口与其具体实现进行绑定，也就是执行<code>bind(xxx.class).to(xxx.class)</code>等工作。下面我们就看一下ControllerModule()做了哪些依赖注入声明的工作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line">protected void configure() &#123;</div><div class="line">    // 各种工厂接口与其实现类的绑定</div><div class="line">    installFactories();</div><div class="line"></div><div class="line"></div><div class="line">    // 绑定session相关manager到具体实例</div><div class="line">    final SessionIdManager sessionIdManager = new HashSessionIdManager();</div><div class="line">    final SessionManager sessionManager = new HashSessionManager();</div><div class="line">    sessionManager.getSessionCookieConfig().setPath(&quot;/&quot;);</div><div class="line">    sessionManager.setSessionIdManager(sessionIdManager);</div><div class="line">    bind(SessionManager.class).toInstance(sessionManager);</div><div class="line">    bind(SessionIdManager.class).toInstance(sessionIdManager);</div><div class="line"></div><div class="line">    // kerberos相关</div><div class="line">    bind(KerberosOperationHandlerFactory.class);</div><div class="line">    bind(KerberosDescriptorFactory.class);</div><div class="line">    bind(KerberosServiceDescriptorFactory.class);</div><div class="line">    bind(KerberosHelper.class).to(KerberosHelperImpl.class);</div><div class="line"></div><div class="line">    bind(CredentialStoreService.class).to(CredentialStoreServiceImpl.class);</div><div class="line"></div><div class="line">    bind(Configuration.class).toInstance(configuration);</div><div class="line">    bind(OsFamily.class).toInstance(os_family);</div><div class="line">    bind(HostsMap.class).toInstance(hostsMap);</div><div class="line">    bind(PasswordEncoder.class).toInstance(new StandardPasswordEncoder());</div><div class="line">    bind(DelegatingFilterProxy.class).toInstance(new DelegatingFilterProxy() &#123;</div><div class="line">      &#123;</div><div class="line">        setTargetBeanName(&quot;springSecurityFilterChain&quot;);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    bind(Gson.class).annotatedWith(Names.named(&quot;prettyGson&quot;)).toInstance(prettyGson);</div><div class="line">    </div><div class="line">    // jpa持久化相关</div><div class="line">    install(buildJpaPersistModule());</div><div class="line"></div><div class="line">    bind(Gson.class).in(Scopes.SINGLETON);</div><div class="line">    bind(SecureRandom.class).in(Scopes.SINGLETON);</div><div class="line"></div><div class="line">    bind(Clusters.class).to(ClustersImpl.class);</div><div class="line">    bind(AmbariCustomCommandExecutionHelper.class);</div><div class="line">    bind(ActionDBAccessor.class).to(ActionDBAccessorImpl.class);</div><div class="line">    bindConstant().annotatedWith(Names.named(&quot;schedulerSleeptime&quot;)).to(</div><div class="line">      configuration.getExecutionSchedulerWait());</div><div class="line"></div><div class="line">    // This time is added to summary timeout time of all tasks in stage</div><div class="line">    // So it&apos;s an &quot;additional time&quot;, given to stage to finish execution before</div><div class="line">    // it is considered as timed out</div><div class="line">    bindConstant().annotatedWith(Names.named(&quot;actionTimeout&quot;)).to(600000L);</div><div class="line"></div><div class="line">    bindConstant().annotatedWith(Names.named(&quot;dbInitNeeded&quot;)).to(dbInitNeeded);</div><div class="line">    bindConstant().annotatedWith(Names.named(&quot;statusCheckInterval&quot;)).to(5000L);</div><div class="line"></div><div class="line">    //ExecutionCommands cache size</div><div class="line"></div><div class="line">    bindConstant().annotatedWith(Names.named(&quot;executionCommandCacheSize&quot;)).</div><div class="line">        to(configuration.getExecutionCommandsCacheSize());</div><div class="line"></div><div class="line"></div><div class="line">    // Host role commands status summary max cache enable/disable</div><div class="line">    bindConstant().annotatedWith(Names.named(HostRoleCommandDAO.HRC_STATUS_SUMMARY_CACHE_ENABLED)).</div><div class="line">      to(configuration.getHostRoleCommandStatusSummaryCacheEnabled());</div><div class="line"></div><div class="line">    // Host role commands status summary max cache size</div><div class="line">    bindConstant().annotatedWith(Names.named(HostRoleCommandDAO.HRC_STATUS_SUMMARY_CACHE_SIZE)).</div><div class="line">      to(configuration.getHostRoleCommandStatusSummaryCacheSize());</div><div class="line">    // Host role command status summary cache expiry duration in minutes</div><div class="line">    bindConstant().annotatedWith(Names.named(HostRoleCommandDAO.HRC_STATUS_SUMMARY_CACHE_EXPIRY_DURATION_MINUTES)).</div><div class="line">      to(configuration.getHostRoleCommandStatusSummaryCacheExpiryDuration());</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    bind(AmbariManagementController.class).to(</div><div class="line">      AmbariManagementControllerImpl.class);</div><div class="line">    bind(AbstractRootServiceResponseFactory.class).to(RootServiceResponseFactory.class);</div><div class="line">    bind(ExecutionScheduler.class).to(ExecutionSchedulerImpl.class);</div><div class="line">    bind(DBAccessor.class).to(DBAccessorImpl.class);</div><div class="line">    bind(ViewInstanceHandlerList.class).to(AmbariHandlerList.class);</div><div class="line">    bind(TimelineMetricCacheProvider.class);</div><div class="line">    bind(TimelineMetricCacheEntryFactory.class);</div><div class="line">    bind(SecurityConfigurationFactory.class).in(Scopes.SINGLETON);</div><div class="line"></div><div class="line">    bind(PersistedState.class).to(PersistedStateImpl.class);</div><div class="line"></div><div class="line">    requestStaticInjection(ExecutionCommandWrapper.class);</div><div class="line">    requestStaticInjection(DatabaseChecker.class);</div><div class="line">    requestStaticInjection(KerberosChecker.class);</div><div class="line">    </div><div class="line">    // 这里是ControllerModule自定义的一个方法，根据注解执行绑定工作</div><div class="line">    bindByAnnotation(null);</div><div class="line">    </div><div class="line">    // 这里是我们关心的dispatcher相关绑定</div><div class="line">    bindNotificationDispatchers();</div><div class="line">    registerUpgradeChecks();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>我们发现serviceManager就在这个类中出现。它的说明是为需要注入的带有某种注解的接口提供初始化工作。典型应用一：是用来处理一些没有入口的单例，换种表达方式，就是那些没有被任何接口依赖注入，但是仍然被整体的guice框架需要的类。典型应用二：某些类需要注入静态static成员的时候。传入的参数beanDefinitions为空的时候，会默认扫描带有注解<code>EagerSingleton</code>,<code>StaticallyInject</code>,<code>AmbariService</code>的类。这三个注解都是ambari自定义的。我们看到上面调用这个方法的时候传入参数是null。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> Set&lt;BeanDefinition&gt; <span class="title">bindByAnnotation</span><span class="params">(Set&lt;BeanDefinition&gt; beanDefinitions)</span> </span>&#123;</div><div class="line">    List&lt;Class&lt;? extends Annotation&gt;&gt; classes = Arrays.asList(</div><div class="line">        EagerSingleton.class, StaticallyInject.class, AmbariService.class);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == beanDefinitions || beanDefinitions.size() == <span class="number">0</span>) &#123;</div><div class="line">      ClassPathScanningCandidateComponentProvider scanner =</div><div class="line">          <span class="keyword">new</span> ClassPathScanningCandidateComponentProvider(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">      <span class="comment">// match only singletons that are eager listeners</span></div><div class="line">      <span class="comment">// 为scanner加入目标注解过滤器</span></div><div class="line">      <span class="keyword">for</span> (Class&lt;? extends Annotation&gt; cls : classes) &#123;</div><div class="line">        scanner.addIncludeFilter(<span class="keyword">new</span> AnnotationTypeFilter(cls));</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// 找出所有的带有注解的类</span></div><div class="line">      beanDefinitions = scanner.findCandidateComponents(AMBARI_PACKAGE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == beanDefinitions || beanDefinitions.size() == <span class="number">0</span>) &#123;</div><div class="line">      LOG.warn(<span class="string">"No instances of &#123;&#125; found to register"</span>, classes);</div><div class="line">      <span class="keyword">return</span> beanDefinitions;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Set&lt;com.google.common.util.concurrent.Service&gt; services =</div><div class="line">        <span class="keyword">new</span> HashSet&lt;com.google.common.util.concurrent.Service&gt;();</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (BeanDefinition beanDefinition : beanDefinitions) &#123;</div><div class="line">      String className = beanDefinition.getBeanClassName();</div><div class="line">      Class&lt;?&gt; clazz = ClassUtils.resolveClassName(className,</div><div class="line">          ClassUtils.getDefaultClassLoader());</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> != clazz.getAnnotation(EagerSingleton.class)) &#123;</div><div class="line">        bind(clazz).asEagerSingleton();</div><div class="line">        LOG.debug(<span class="string">"Binding singleton &#123;&#125; eagerly"</span>, clazz);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> != clazz.getAnnotation(StaticallyInject.class)) &#123;</div><div class="line">        requestStaticInjection(clazz);</div><div class="line">        LOG.debug(<span class="string">"Statically injecting &#123;&#125; "</span>, clazz);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// Ambari services are registered with Guava</span></div><div class="line">      <span class="comment">// 使用Guava的AmbariService注解类</span></div><div class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> != clazz.getAnnotation(AmbariService.class)) &#123;</div><div class="line">        <span class="comment">// 看看是不是一个Guava service</span></div><div class="line">        <span class="keyword">if</span> (!AbstractScheduledService.class.isAssignableFrom(clazz)) &#123;</div><div class="line">          String message = MessageFormat.format(</div><div class="line">              <span class="string">"Unable to register service &#123;0&#125; because it is not an AbstractScheduledService"</span>,</div><div class="line">              clazz);</div><div class="line"></div><div class="line">          LOG.warn(message);</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(message);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 实例化，并作为单例注入到guice中，然后再添加到services中</span></div><div class="line">        AbstractScheduledService service = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          service = (AbstractScheduledService) clazz.newInstance();</div><div class="line">          bind((Class&lt;AbstractScheduledService&gt;) clazz).toInstance(service);</div><div class="line">          services.add(service);</div><div class="line">          LOG.debug(<span class="string">"Registering service &#123;&#125; "</span>, clazz);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</div><div class="line">          LOG.error(<span class="string">"Unable to register &#123;&#125; as a service"</span>, clazz, exception);</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(exception);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 使用上面扫描完获取到的所有services，实例化serviceManager，并单例化注入guice</span></div><div class="line">    ServiceManager manager = <span class="keyword">new</span> ServiceManager(services);</div><div class="line">    bind(ServiceManager.class).toInstance(manager);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> beanDefinitions;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>ServiceManager作为AmbariServer的依赖项被注入，然后在run方法中被调用其startAsync方法，我们看到其实是遍历调用了services中的service的startAsync方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public ServiceManager startAsync() &#123;</div><div class="line">  for (Service service : services) &#123;</div><div class="line">    State state = service.state();</div><div class="line">    checkState(state == NEW, &quot;Service %s is %s, cannot start it.&quot;, service, state);</div><div class="line">  &#125;</div><div class="line">  for (Service service : services) &#123;</div><div class="line">    try &#123;</div><div class="line">      service.startAsync();</div><div class="line">    &#125; catch (IllegalStateException e) &#123;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  return this;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>参考：<a href="https://github.com/google/guice/wiki/GettingStarted" target="_blank" rel="external">https://github.com/google/guice/wiki/GettingStarted</a></p>
<p>看了这么多，但是实际alert来源呢？一般都是agent在本地执行检查，符合告警规则的才发送给server端。那么是怎样发送到server的呢？首先想到的是rest api里的AlertNoticeService，可是这个类只有get方法，没有POST接口。那么下一个嫌疑就是HeartBeat信息了。看下HeartBeat的定义<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">private long responseId = -1;</div><div class="line">private long timestamp;</div><div class="line">private String hostname;</div><div class="line">List&lt;CommandReport&gt; reports = new ArrayList&lt;CommandReport&gt;();</div><div class="line">List&lt;ComponentStatus&gt; componentStatus = new ArrayList&lt;ComponentStatus&gt;();</div><div class="line">private List&lt;DiskInfo&gt; mounts = new ArrayList&lt;DiskInfo&gt;();</div><div class="line">HostStatus nodeStatus;</div><div class="line">private AgentEnv agentEnv = null;</div><div class="line">private List&lt;Alert&gt; alerts = null;</div><div class="line">private RecoveryReport recoveryReport;</div></pre></td></tr></table></figure></p>
<p>果然，那么我们就也能找到HeartBeat相关的resource了：AgentResource。HeartBeatHandler处理过程中会把heartbeat放进HeartbeatProcessor的队列里，做异步处理，告警部分的持久化就在这个异步处理的代码里了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Path</span>(<span class="string">"heartbeat/&#123;hostName&#125;"</span>)</div><div class="line">  <span class="meta">@POST</span></div><div class="line">  <span class="meta">@Consumes</span>(MediaType.APPLICATION_JSON)</div><div class="line">  <span class="meta">@Produces</span>(&#123;MediaType.APPLICATION_JSON&#125;)</div><div class="line">  <span class="function"><span class="keyword">public</span> HeartBeatResponse <span class="title">heartbeat</span><span class="params">(HeartBeat message)</span></span></div><div class="line">      <span class="keyword">throws</span> WebApplicationException &#123;</div><div class="line">    <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</div><div class="line">      LOG.debug(<span class="string">"Received Heartbeat message "</span> + message);</div><div class="line">    &#125;</div><div class="line">    HeartBeatResponse heartBeatResponse;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">// hh是一个单例的HeartBeatHandler</span></div><div class="line">      heartBeatResponse = hh.handleHeartBeat(message);</div><div class="line">      <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</div><div class="line">        LOG.debug(<span class="string">"Sending heartbeat response with response id "</span> + heartBeatResponse.getResponseId());</div><div class="line">        LOG.debug(<span class="string">"Response details "</span> + heartBeatResponse);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      LOG.warn(<span class="string">"Error in HeartBeat"</span>, e);</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> WebApplicationException(<span class="number">500</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> heartBeatResponse;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>中间经过guava的eventbus的多次事件中转后，在AlertStateChangedListener中被完全持久化进入数据库中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">public void onAlertEvent(AlertStateChangeEvent event) &#123;</div><div class="line">    ...</div><div class="line">    ...</div><div class="line">    for (AlertGroupEntity group : groups) &#123;</div><div class="line">      Set&lt;AlertTargetEntity&gt; targets = group.getAlertTargets();</div><div class="line">      if (null == targets || targets.size() == 0) &#123;</div><div class="line">        continue;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      for (AlertTargetEntity target : targets) &#123;</div><div class="line">        if (!isAlertTargetInterested(target, history)) &#123;</div><div class="line">          continue;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        AlertNoticeEntity notice = new AlertNoticeEntity();</div><div class="line">        notice.setUuid(UUID.randomUUID().toString());</div><div class="line">        notice.setAlertTarget(target);</div><div class="line">        notice.setAlertHistory(event.getNewHistoricalEntry());</div><div class="line">        notice.setNotifyState(NotificationState.PENDING);</div><div class="line">        notices.add(notice);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    m_alertsDispatchDao.createNotices(notices);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>启动HeartBeatHandler的地方出现在AmbariServer.run的代码中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">....</div><div class="line">AgentResource.statHeartBeatHandler();</div><div class="line">....</div></pre></td></tr></table></figure></p>
<p>至于agent那边具体实现，我们暂时不太关心，因为暂时不需要自定义alert。</p>
<p>综上，对于告警渠道的添加，我们需要自己实现guava的<code>AbstractScheduledService</code>抽象类接口，依照既有的SNNP或者EMAIL等写Dispatcher，然后把它们放置到<code>ServiceManager.AMBARI_PACKAGE</code>的位置。然后，最好是通过ambari提供的REST API添加alert_target，因为要处理跟alert_group相关的事情，自己直接操作数据库比较复杂一些，基本上要复制一遍代码里的所有操作。</p>
<p>大功告成！</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ambari源码解析-资源状态监听]]></title>
      <url>/2017/10/31/ambari%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E8%B5%84%E6%BA%90%E7%8A%B6%E6%80%81%E7%9B%91%E5%90%AC/</url>
      <content type="html"><![CDATA[<p>AmbariServie.run()入口处找到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">LOG.info(&quot;********* Reconciling Alert Definitions **********&quot;);</div><div class="line">ambariMetaInfo.reconcileAlertDefinitions(clusters);</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>调用了AmbariMetaInfo.reconcileAlertDefinitions(Clusters clusters)方法，这个方法主要负责比较stack中定义的alert和数据库中的alert有没有什么变化。它会首先确认一下alert定义所在的service是不是已经被安装了，没有安装的就没有必要关心了。</p>
<p>这个方法还会监测agent定义的alert，这些应该在agent host上运行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reconcileAlertDefinitions</span><span class="params">(Clusters clusters)</span></span></div><div class="line">      <span class="keyword">throws</span> AmbariException &#123;</div><div class="line"></div><div class="line">    Map&lt;String, Cluster&gt; clusterMap = clusters.getClusters();</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == clusterMap || clusterMap.size() == <span class="number">0</span>) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 遍历cluster</span></div><div class="line">    <span class="keyword">for</span> (Cluster cluster : clusterMap.values()) &#123;</div><div class="line">      <span class="keyword">long</span> clusterId = cluster.getClusterId();</div><div class="line">      StackId stackId = cluster.getDesiredStackVersion();</div><div class="line">      StackInfo stackInfo = getStack(stackId.getStackName(),</div><div class="line">          stackId.getStackVersion());</div><div class="line"></div><div class="line">      <span class="comment">// 创建service/conponent和名字的映射，方便查找</span></div><div class="line">      Collection&lt;ServiceInfo&gt; stackServices = stackInfo.getServices();</div><div class="line">      Map&lt;String, ServiceInfo&gt; stackServiceMap = <span class="keyword">new</span> HashMap&lt;String, ServiceInfo&gt;();</div><div class="line">      Map&lt;String, ComponentInfo&gt; stackComponentMap = <span class="keyword">new</span> HashMap&lt;String, ComponentInfo&gt;();</div><div class="line">      <span class="keyword">for</span> (ServiceInfo stackService : stackServices) &#123;</div><div class="line">        stackServiceMap.put(stackService.getName(), stackService);</div><div class="line"></div><div class="line">        List&lt;ComponentInfo&gt; components = stackService.getComponents();</div><div class="line">        <span class="keyword">for</span> (ComponentInfo component : components) &#123;</div><div class="line">          stackComponentMap.put(component.getName(), component);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      Map&lt;String, Service&gt; clusterServiceMap = cluster.getServices();</div><div class="line">      Set&lt;String&gt; clusterServiceNames = clusterServiceMap.keySet();</div><div class="line"></div><div class="line">      <span class="comment">// 对于当前cluster上已经安装的所有service，获取其metainfo和alert定义， 添加到stackDefinitions</span></div><div class="line">      List&lt;AlertDefinition&gt; stackDefinitions = <span class="keyword">new</span> ArrayList&lt;AlertDefinition&gt;(<span class="number">50</span>);</div><div class="line">      <span class="keyword">for</span> (String clusterServiceName : clusterServiceNames) &#123;</div><div class="line">        ServiceInfo stackService = stackServiceMap.get(clusterServiceName);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == stackService) &#123;</div><div class="line">          <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Set&lt;AlertDefinition&gt; serviceDefinitions = getAlertDefinitions(stackService);</div><div class="line">        stackDefinitions.addAll(serviceDefinitions);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 抽取数据库中所有的alert定义，把list转化为以alert定义名字为key的map</span></div><div class="line">      List&lt;AlertDefinitionEntity&gt; persist = <span class="keyword">new</span> ArrayList&lt;AlertDefinitionEntity&gt;();</div><div class="line">      List&lt;AlertDefinitionEntity&gt; entities = alertDefinitionDao.findAll(clusterId);</div><div class="line"></div><div class="line">      Map&lt;String, AlertDefinitionEntity&gt; mappedEntities = <span class="keyword">new</span> HashMap&lt;String, AlertDefinitionEntity&gt;(<span class="number">100</span>);</div><div class="line">      <span class="keyword">for</span> (AlertDefinitionEntity entity : entities) &#123;</div><div class="line">        mappedEntities.put(entity.getDefinitionName(), entity);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 对每个stack definition，查看是否存在，如果存在，就详细比较一下变化</span></div><div class="line">      <span class="keyword">for</span>( AlertDefinition stackDefinition : stackDefinitions )&#123;</div><div class="line">        AlertDefinitionEntity entity = mappedEntities.get(stackDefinition.getName());</div><div class="line"></div><div class="line">        <span class="comment">// 如果是null，就代表是新的</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == entity) &#123;</div><div class="line">          entity = alertDefinitionFactory.coerce(clusterId, stackDefinition);</div><div class="line">          persist.add(entity);</div><div class="line">          <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 修改过的stack中的定义不会被覆盖，需要使用REST API来修改</span></div><div class="line">        AlertDefinition databaseDefinition = alertDefinitionFactory.coerce(entity);</div><div class="line">        </div><div class="line">        <span class="comment">// 如果stackfinition与数据库中不相等....暂时没有处理任何东西，只是打了个log</span></div><div class="line">        <span class="keyword">if</span> (!stackDefinition.deeplyEquals(databaseDefinition)) &#123;</div><div class="line">          <span class="comment">// this is the code that would normally merge the stack definition</span></div><div class="line">          <span class="comment">// into the database; this is not the behavior we want today</span></div><div class="line"></div><div class="line">          <span class="comment">// entity = alertDefinitionFactory.merge(stackDefinition, entity);</span></div><div class="line">          <span class="comment">// persist.add(entity);</span></div><div class="line"></div><div class="line">          LOG.debug(</div><div class="line">              <span class="string">"The alert named &#123;&#125; has been modified from the stack definition and will not be merged"</span>,</div><div class="line">              stackDefinition.getName());</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 把ambari agent主机上的alert定义添加到持久化列表里</span></div><div class="line">      List&lt;AlertDefinition&gt; agentDefinitions = ambariServiceAlertDefinitions.getAgentDefinitions();</div><div class="line">      <span class="keyword">for</span> (AlertDefinition agentDefinition : agentDefinitions) &#123;</div><div class="line">        AlertDefinitionEntity entity = mappedEntities.get(agentDefinition.getName());</div><div class="line"></div><div class="line">        <span class="comment">// no entity means this is new; create a new entity</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == entity) &#123;</div><div class="line">          entity = alertDefinitionFactory.coerce(clusterId, agentDefinition);</div><div class="line">          persist.add(entity);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 把ambari server 的alert定义添加到持久化列表里</span></div><div class="line">      List&lt;AlertDefinition&gt; serverDefinitions = ambariServiceAlertDefinitions.getServerDefinitions();</div><div class="line">      <span class="keyword">for</span> (AlertDefinition serverDefinition : serverDefinitions) &#123;</div><div class="line">        AlertDefinitionEntity entity = mappedEntities.get(serverDefinition.getName());</div><div class="line"></div><div class="line">        <span class="comment">// no entity means this is new; create a new entity</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == entity) &#123;</div><div class="line">          entity = alertDefinitionFactory.coerce(clusterId, serverDefinition);</div><div class="line">          persist.add(entity);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 持久化新的，或者需要更新的alert定义</span></div><div class="line">      <span class="keyword">for</span> (AlertDefinitionEntity entity : persist) &#123;</div><div class="line">        <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</div><div class="line">          LOG.info(<span class="string">"Merging Alert Definition &#123;&#125; into the database"</span>,</div><div class="line">              entity.getDefinitionName());</div><div class="line">        &#125;</div><div class="line">        alertDefinitionDao.createOrUpdate(entity);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// all definition resolved; publish their registration</span></div><div class="line">      <span class="comment">// 所有的定义都处理完成后，发布它们的注册event也就是AlertDefinitionRegistrationEvent到eventPublisher</span></div><div class="line">      <span class="keyword">for</span> (AlertDefinitionEntity def : alertDefinitionDao.findAll(cluster.getClusterId())) &#123;</div><div class="line">        AlertDefinition realDef = alertDefinitionFactory.coerce(def);</div><div class="line"></div><div class="line">        AlertDefinitionRegistrationEvent event = <span class="keyword">new</span> AlertDefinitionRegistrationEvent(</div><div class="line">            cluster.getClusterId(), realDef);</div><div class="line"></div><div class="line">        eventPublisher.publish(event);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// for every definition, determine if the service and the component are</span></div><div class="line">      <span class="comment">// still valid; if they are not, disable them - this covers the case</span></div><div class="line">      <span class="comment">// with STORM/REST_API where that component was removed from the</span></div><div class="line">      <span class="comment">// stack but still exists in the database - we disable the alert to</span></div><div class="line">      <span class="comment">// preserve historical references</span></div><div class="line">      List&lt;AlertDefinitionEntity&gt; definitions = alertDefinitionDao.findAllEnabled(clusterId);</div><div class="line">      List&lt;AlertDefinitionEntity&gt; definitionsToDisable = <span class="keyword">new</span> ArrayList&lt;AlertDefinitionEntity&gt;();</div><div class="line"></div><div class="line">      <span class="keyword">for</span> (AlertDefinitionEntity definition : definitions) &#123;</div><div class="line">        String serviceName = definition.getServiceName();</div><div class="line">        String componentName = definition.getComponentName();</div><div class="line"></div><div class="line">        <span class="comment">// the AMBARI service is special, skip it here</span></div><div class="line">        <span class="keyword">if</span> (Services.AMBARI.name().equals(serviceName)) &#123;</div><div class="line">          <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!stackServiceMap.containsKey(serviceName)) &#123;</div><div class="line">          LOG.info(</div><div class="line">              <span class="string">"The &#123;&#125; service has been marked as deleted for stack &#123;&#125;, disabling alert &#123;&#125;"</span>,</div><div class="line">              serviceName, stackId, definition.getDefinitionName());</div><div class="line"></div><div class="line">          definitionsToDisable.add(definition);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">null</span> != componentName</div><div class="line">            &amp;&amp; !stackComponentMap.containsKey(componentName)) &#123;</div><div class="line">          LOG.info(</div><div class="line">              <span class="string">"The &#123;&#125; component &#123;&#125; has been marked as deleted for stack &#123;&#125;, disabling alert &#123;&#125;"</span>,</div><div class="line">              serviceName, componentName, stackId,</div><div class="line">              definition.getDefinitionName());</div><div class="line"></div><div class="line">          definitionsToDisable.add(definition);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// disable definitions and fire the event</span></div><div class="line">      <span class="comment">// 将alert定义diable掉，并发送这个event到eventPublisher</span></div><div class="line">      <span class="keyword">for</span> (AlertDefinitionEntity definition : definitionsToDisable) &#123;</div><div class="line">        definition.setEnabled(<span class="keyword">false</span>);</div><div class="line">        alertDefinitionDao.merge(definition);</div><div class="line"></div><div class="line">        AlertDefinitionDisabledEvent event = <span class="keyword">new</span> AlertDefinitionDisabledEvent(</div><div class="line">            clusterId, definition.getDefinitionId());</div><div class="line"></div><div class="line">        eventPublisher.publish(event);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>好了，上面看到所有的alert定义都处理完后，会发送一个AlertDefinitionRegistrationEvent事件到AmbariEventPublisher。那么我们看下有谁监听了AmbariEventPublisher的AlertDefinitionRegistrationEvent事件就可以了吧。然后就定位到了AlertLifecycleListener。</p>
<p>尼玛，这好像不是具体执行alert的地方。。。。而是管理ambari中各种资源的变化情况的地方。具体可以看下AmbariEvent的实现类列表~~~基本都是维护ambari中各种概念的状态变化的。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ambari源码解析-REST解析]]></title>
      <url>/2017/10/31/ambari%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-REST%E8%A7%A3%E6%9E%90/</url>
      <content type="html"><![CDATA[<p>先看下入口的地方, ambariServer.run()：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">ServletHolder sh = <span class="keyword">new</span> ServletHolder(ServletContainer.class);</div><div class="line">sh.setInitParameter(<span class="string">"com.sun.jersey.config.property.resourceConfigClass"</span>,</div><div class="line">  <span class="string">"com.sun.jersey.api.core.PackagesResourceConfig"</span>);</div><div class="line"></div><div class="line">sh.setInitParameter(<span class="string">"com.sun.jersey.config.property.packages"</span>,</div><div class="line"><span class="string">"org.apache.ambari.server.api.rest;"</span> +</div><div class="line">  <span class="string">"org.apache.ambari.server.api.services;"</span> +</div><div class="line">  <span class="string">"org.apache.ambari.eventdb.webservice;"</span> +</div><div class="line">  <span class="string">"org.apache.ambari.server.api"</span>);</div><div class="line"></div><div class="line">sh.setInitParameter(<span class="string">"com.sun.jersey.api.json.POJOMappingFeature"</span>, <span class="string">"true"</span>);</div><div class="line">root.addServlet(sh, <span class="string">"/api/v1/*"</span>);</div><div class="line">sh.setInitOrder(<span class="number">2</span>);</div></pre></td></tr></table></figure></p>
<p>就是<code>ServletHolder.setInitParameter</code>里<code>com.sun.jersey.config.property.packages</code>对应所有的包路径下的类都被jettyserver看作rest资源，然后所有的带有jersey的REST注解的方法，就都是对应一个path的了。</p>
<p>然后看下ambari自己定制的东西，拿我关注的alert_targets接口来看,对应类为AlertTargetService，看POST方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@POST</span></div><div class="line"><span class="meta">@Produces</span>(<span class="string">"text/plain"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">createTarget</span><span class="params">(String body, @Context HttpHeaders headers,</span></span></div><div class="line">    @Context UriInfo ui) &#123;</div><div class="line">  <span class="keyword">return</span> handleRequest(headers, body, ui, Request.Type.POST,</div><div class="line">      createAlertTargetResource(<span class="keyword">null</span>));</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> ResourceInstance <span class="title">createAlertTargetResource</span><span class="params">(Long targetId)</span> </span>&#123;</div><div class="line">  Map&lt;Resource.Type, String&gt; mapIds = <span class="keyword">new</span> HashMap&lt;Resource.Type, String&gt;();</div><div class="line"></div><div class="line">  mapIds.put(Resource.Type.AlertTarget,</div><div class="line">      <span class="keyword">null</span> == targetId ? <span class="keyword">null</span> : targetId.toString());</div><div class="line"></div><div class="line">  <span class="keyword">return</span> createResource(Resource.Type.AlertTarget, mapIds);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ambari中所有的Service都继承自BaseService，上面的<code>createAlertTargetResource</code>调用的<code>createResource</code>以及<code>handleRequest</code>都是继承自BaseService的。</p>
<p>BaseService的<code>createResource</code>方法实现，下面的type应该是Resource.Type.AlertTarget，是一个枚举值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public ResourceInstance createResource(Resource.Type type, Map&lt;Resource.Type, String&gt; mapIds) &#123;</div><div class="line"></div><div class="line">   /**</div><div class="line">    * 找到type对应的ResourceDefinition， 这里返回的是AlertTargetResourceDefinition</div><div class="line">    */</div><div class="line">   ResourceDefinition resourceDefinition = getResourceDefinition(type, mapIds);</div><div class="line">   </div><div class="line">   // 使用AlertTargetResourceDefinition构建QueryImpl并返回，mapIds为null</div><div class="line">   return new QueryImpl(mapIds, resourceDefinition, ClusterControllerHelper.getClusterController());</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>再看下BaseService的<code>handleRequest</code>方法, 通过这个方法可以让所有的请求处理都通过一个公用逻辑。它会创建一个request实例，然后触发它的process方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> Response <span class="title">handleRequest</span><span class="params">(HttpHeaders headers, String body,</span></span></div><div class="line">                                   UriInfo uriInfo, Request.Type requestType,</div><div class="line">                                   MediaType mediaType, ResourceInstance resource) &#123;</div><div class="line">    <span class="comment">// 结果</span></div><div class="line">    Result result = <span class="keyword">new</span> ResultImpl(<span class="keyword">new</span> ResultStatus(ResultStatus.STATUS.OK));</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="comment">// 解析请求内容，使用JsonRequestBodyParser执行解析，其实就是解析成一系列kv</span></div><div class="line">      Set&lt;RequestBody&gt; requestBodySet = getBodyParser().parse(body);</div><div class="line"></div><div class="line">      Iterator&lt;RequestBody&gt; iterator = requestBodySet.iterator();</div><div class="line">      <span class="keyword">while</span> (iterator.hasNext() &amp;&amp; result.getStatus().getStatus().equals(ResultStatus.STATUS.OK)) &#123;</div><div class="line">        RequestBody requestBody = iterator.next();</div><div class="line">        </div><div class="line">        <span class="comment">// 使用RequestFactory创建request，我们会调用createPostRequest方法</span></div><div class="line">        Request request = getRequestFactory().createRequest(</div><div class="line">            headers, requestBody, uriInfo, requestType, resource);</div><div class="line">        <span class="comment">// 执行request</span></div><div class="line">        result  = request.process();</div><div class="line">      &#125;</div><div class="line">    &#125; </div><div class="line"></div><div class="line">   ....</div><div class="line">   ....</div><div class="line">   </div><div class="line">    <span class="keyword">return</span> builder.build();</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>创建request的代码部分：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Request <span class="title">createPostRequest</span><span class="params">(HttpHeaders headers, RequestBody body, UriInfo uriInfo, ResourceInstance resource)</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> batchCreate = !applyDirectives(Request.Type.POST, body, uriInfo, resource);;</div><div class="line">    </div><div class="line">    <span class="comment">// 如果是批处理，就返回QueryPostRequest, 否则返回PostRequest，我们这里返回的是PostRequest</span></div><div class="line">    <span class="comment">// PostRequest会与一个CreateHandler一一对应，作为它的handler存在</span></div><div class="line">    <span class="keyword">return</span> (batchCreate) ?</div><div class="line">        <span class="keyword">new</span> QueryPostRequest(headers, body, uriInfo, resource) :</div><div class="line">        <span class="keyword">new</span> PostRequest(headers, body, uriInfo, resource);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>request的process部分，那么就看PostRequest的实现，发现它继承了BaseRequest，实际调用的是BaseRequest的process方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Result result;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">  parseRenderer();</div><div class="line">  parseQueryPredicate();</div><div class="line">  result = getRequestHandler().handleRequest(<span class="keyword">this</span>);</div><div class="line">&#125; <span class="keyword">catch</span> (InvalidQueryException e) &#123;</div><div class="line">  result =  <span class="keyword">new</span> ResultImpl(<span class="keyword">new</span> ResultStatus(ResultStatus.STATUS.BAD_REQUEST,</div><div class="line">      <span class="string">"Unable to compile query predicate: "</span> + e.getMessage()));</div><div class="line">&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">  result =  <span class="keyword">new</span> ResultImpl(<span class="keyword">new</span> ResultStatus(ResultStatus.STATUS.BAD_REQUEST,</div><div class="line">      <span class="string">"Invalid Request: "</span> + e.getMessage()));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (! result.getStatus().isErrorState()) &#123;</div><div class="line">  getResultPostProcessor().process(result);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>BaseManagementHandler中又调用了persist方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">handleRequest</span><span class="params">(Request request)</span> </span>&#123;</div><div class="line">  Query query = request.getResource().getQuery();</div><div class="line">  Predicate queryPredicate = request.getQueryPredicate();</div><div class="line"></div><div class="line">  query.setRenderer(request.getRenderer());</div><div class="line">  <span class="keyword">if</span> (queryPredicate != <span class="keyword">null</span>) &#123;</div><div class="line">    query.setUserPredicate(queryPredicate);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> persist(request.getResource(), request.getBody());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>persist(ResourceInstance resource, RequestBody body)</code>方法在CreateHandler中有实现, 代码中的PersistenceManager只有一个实现PersistenceManagerImpl。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">RequestStatus status = getPersistenceManager().create(resource, body);</div><div class="line">result = createResult(status);</div></pre></td></tr></table></figure></p>
<p>PersistenceManagerImpl的<code>create(ResourceInstance resource, RequestBody requestBody)</code>相关部分。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">// 获取resource对应的主键、外键</div><div class="line">Map&lt;Resource.Type, String&gt; mapResourceIds = resource.getKeyValueMap();</div><div class="line">Resource.Type type = resource.getResourceDefinition().getType();</div><div class="line">Schema schema = m_controller.getSchema(type);</div><div class="line"></div><div class="line">// 获取body中解析的各种键值</div><div class="line">Set&lt;NamedPropertySet&gt; setProperties = requestBody.getNamedPropertySets();</div><div class="line">if (setProperties.isEmpty()) &#123;</div><div class="line">requestBody.addPropertySet(new NamedPropertySet(&quot;&quot;, new HashMap&lt;String, Object&gt;()));</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 遍历body中的键值</div><div class="line">for (NamedPropertySet propertySet : setProperties) &#123;</div><div class="line">for (Map.Entry&lt;Resource.Type, String&gt; entry : mapResourceIds.entrySet()) &#123;</div><div class="line">  Map&lt;String, Object&gt; mapProperties = propertySet.getProperties();</div><div class="line">  // schema中组合了ResourceProvider，这里就是AlertTargetResourceProvider，getKeyPropertyId方法是调用AlertTargetResourceProvider获取可以唯一确认一条记录的唯一键</div><div class="line">  // AlertTarget中定义的唯一键是&quot;AlertTarget/id&quot;和&quot;AlertTarget/name&quot;</div><div class="line">  String property = schema.getKeyPropertyId(entry.getKey());</div><div class="line">  // 如果不包含唯一键，就添加进入mapProperties</div><div class="line">  if (!mapProperties.containsKey(property)) &#123;</div><div class="line">    mapProperties.put(property, entry.getValue());</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">// 创建resource</div><div class="line">return m_controller.createResources(type, createControllerRequest(requestBody));</div></pre></td></tr></table></figure></p>
<p>最后一步就是调用了<code>ClusterControllerImpl</code>的<code>createResources(Type type, Request request)</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> RequestStatus <span class="title">createResources</span><span class="params">(Type type, Request request)</span></span>&#123;</div><div class="line">    <span class="comment">// 获取对应的ResrouceProvider，如果找不到就用DefaultProviderModule通过type去createResourceProvider对应的ResrouceProvider，我们这里对应的是上面提到的AlertTargetResourceProvider</span></div><div class="line">    ResourceProvider provider = ensureResourceProvider(type);</div><div class="line">    <span class="keyword">if</span> (provider != <span class="keyword">null</span>) &#123;</div><div class="line">    </div><div class="line">      checkProperties(type, request, <span class="keyword">null</span>);</div><div class="line">    </div><div class="line">      <span class="keyword">return</span> provider.createResources(request);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后一步AlertTargetResourceProvider, 然后会调用到AlertDispatchDAO的<code>create(AlertTargetEntity alertTarget)</code>方法，就入库了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">public RequestStatus createResources(final Request request)</div><div class="line">    throws SystemException,</div><div class="line">    UnsupportedPropertyException, ResourceAlreadyExistsException,</div><div class="line">    NoSuchParentResourceException &#123;</div><div class="line"></div><div class="line">  createResources(new Command&lt;Void&gt;() &#123;</div><div class="line">    @Override</div><div class="line">    public Void invoke() throws AmbariException &#123;</div><div class="line">      createAlertTargets(request.getProperties(), request.getRequestInfoProperties());</div><div class="line">      return null;</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  notifyCreate(Resource.Type.AlertTarget, request);</div><div class="line">  return getRequestStatus(null);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>细看一下，是个事务接口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public void create(AlertTargetEntity alertTarget) &#123;</div><div class="line">  // 持久化target到数据库</div><div class="line">  entityManagerProvider.get().persist(alertTarget);</div><div class="line">  </div><div class="line">  // 如果这个target是global的，就遍历所有的group，与这个target关联起来</div><div class="line">  // 就是更新数据库中的关联关系</div><div class="line">  if (alertTarget.isGlobal()) &#123;</div><div class="line">    List&lt;AlertGroupEntity&gt; groups = findAllGroups();</div><div class="line">    for (AlertGroupEntity group : groups) &#123;</div><div class="line">      group.addAlertTarget(alertTarget);</div><div class="line">      merge(group);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="感想"><a href="#感想" class="headerlink" title="感想"></a>感想</h2><p>没有看到什么特别的好处，整个处理过程特别绕…如果只是为了统一处理请求的话，使用spring的filter之类的不能搞定么？为什么要弄一个handleRequest的抽象方法呢？</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ambari源码解析-自定义告警]]></title>
      <url>/2017/10/31/ambari%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%91%8A%E8%AD%A6/</url>
      <content type="html"><![CDATA[<p>ambari原生支持两种告警手段：邮件告警、SNMP告警。</p>
<p>个人主要是研发，对SNMP一直不太了解，试着搜了一些资料，稍显麻烦，而且目前我们的数据集群运维工作中并没有使用到SNMP相关的工具，所以暂时并不认为必要。</p>
<p>我们期望的告警方式是短信告警，具有最高的时效性，已经具有了短信告警接口。所以下一步就是在ambari这边找到调用此接口，并传送有效告警信息的方式。</p>
<p>翻阅文档，发现amabri也是支持<a href="https://cwiki.apache.org/confluence/display/AMBARI/Creating+a+Script-based+Alert+Dispatcher" target="_blank" rel="external">脚本告警</a>的。单独看文档稍微有些懵逼，还是看下对应源码吧。</p>
<p>关键字dispatcher，找到对应的类AlertScriptDispatcher。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">  * 在amabri.properties中配置执行告警的脚本的配置项</div><div class="line">  */</div><div class="line"> public static final String SCRIPT_CONFIG_DEFAULT_KEY = &quot;notification.dispatch.alert.script&quot;;</div><div class="line"></div><div class="line"> /**</div><div class="line">  * 在amabri.properties中配置以毫秒为单位的执行告警超时的脚本的配置项，默认是5000，也就是5s</div><div class="line">  */</div><div class="line"> public static final String SCRIPT_CONFIG_TIMEOUT_KEY = &quot;notification.dispatch.alert.script.timeout&quot;;</div><div class="line"></div><div class="line"> /**</div><div class="line">  * 用来定义指定执行告警脚本的配置项的关键字，如果没有配置的话，就默认是SCRIPT_CONFIG_DEFAULT_KEY[也就是notification.dispatch.alert.script]</div><div class="line">  */</div><div class="line"> public static final String DISPATCH_PROPERTY_SCRIPT_CONFIG_KEY = &quot;ambari.dispatch-property.script&quot;;</div></pre></td></tr></table></figure>
<p>调用逻辑<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(Notification notification)</span> </span>&#123;</div><div class="line">    String scriptKey = getScriptConfigurationKey(notification);</div><div class="line">    String script = m_configuration.getProperty(scriptKey);</div><div class="line">    .....</div><div class="line">    .....</div><div class="line"></div><div class="line">    <span class="comment">// execute the script asynchronously</span></div><div class="line">    <span class="keyword">long</span> timeout = getScriptConfigurationTimeout();</div><div class="line">    TimeUnit timeUnit = TimeUnit.MILLISECONDS;</div><div class="line">    AlertNotification alertNotification = (AlertNotification) notification;</div><div class="line">    ProcessBuilder processBuilder = getProcessBuilder(script, alertNotification);</div><div class="line"></div><div class="line">    AlertScriptRunnable runnable = <span class="keyword">new</span> AlertScriptRunnable(alertNotification, script,</div><div class="line">        processBuilder,</div><div class="line">        timeout, timeUnit);</div><div class="line"></div><div class="line">    m_executor.execute(runnable);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>脚步组装<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function">ProcessBuilder <span class="title">getProcessBuilder</span><span class="params">(String script, AlertNotification notification)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> String shellCommand;</div><div class="line">    <span class="keyword">final</span> String shellCommandOption;</div><div class="line">    <span class="keyword">if</span> (SystemUtils.IS_OS_WINDOWS) &#123;</div><div class="line">      shellCommand = <span class="string">"cmd"</span>;</div><div class="line">      shellCommandOption = <span class="string">"/c"</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      shellCommand = <span class="string">"sh"</span>;</div><div class="line">      shellCommandOption = <span class="string">"-c"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    AlertInfo alertInfo = notification.getAlertInfo();</div><div class="line">    AlertDefinitionEntity definition = alertInfo.getAlertDefinition();</div><div class="line">    String definitionName = definition.getDefinitionName();</div><div class="line">    AlertState alertState = alertInfo.getAlertState();</div><div class="line">    String serviceName = alertInfo.getServiceName();</div><div class="line"></div><div class="line">    ....</div><div class="line">    ....</div><div class="line">    </div><div class="line">    Object[] params = <span class="keyword">new</span> Object[] &#123; script, definitionName, alertLabel, serviceName,</div><div class="line">        alertState.name(), alertText &#125;;</div><div class="line"></div><div class="line">    String foo = StringUtils.join(params, <span class="string">" "</span>);</div><div class="line">    </div><div class="line">    <span class="comment">// 示例</span></div><div class="line">    <span class="comment">// sh -c '/foo/sys_logger.py ambari_server_agent_heartbeat "Agent Heartbeat"</span></div><div class="line">    <span class="comment">// AMBARI CRITICAL "Something went wrong with the host"'</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ProcessBuilder(shellCommand, shellCommandOption, foo);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>对应了文档中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"># :param definitionName: alert的唯一名字</div><div class="line"># :param definitionLabel: 可读性强的alert标签</div><div class="line"># :param serviceName: 告警对应的service名称</div><div class="line"># :param alertState: 告警状态 (OK, WARNING, etc)</div><div class="line"># :param alertText: 告警内容</div><div class="line"> </div><div class="line">def main():</div><div class="line">    definitionName = sys.argv[1]</div><div class="line">    definitionLabel = sys.argv[2]</div><div class="line">    serviceName = sys.argv[3]</div><div class="line">    alertState = sys.argv[4]</div><div class="line">    alertText = sys.argv[5]</div></pre></td></tr></table></figure></p>
<p>负责告警触发的类是AlertNoticeDispatchService。它会扫描数据表<code>alert_notice</code>中的pending状态的告警实例，通过告警分发系统处理这些告警实例。然后分发系统会回调<code>AlertNoticeDispatchCallback</code>处理告警实例的状态更新。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[mysql从库crash]]></title>
      <url>/2017/10/27/mysql%E4%BB%8E%E5%BA%93crash/</url>
      <content type="html"><![CDATA[<p> mysql主从架构，从库crash掉。恢复以后，出现主从同步错误问题。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"> 2017-10-27 16:23:38 2098 [ERROR] /server/mysql/bin/mysqld: Table &apos;./mysql/proc&apos; is marked as crashed and should be repaired</div><div class="line">2017-10-27 16:23:38 2098 [Warning] Checking table:   &apos;./mysql/proc&apos;</div><div class="line">2017-10-27 16:23:47 2098 [Warning] Access denied for user &apos;root&apos;@&apos;localhost&apos; (using password: NO)</div><div class="line">2017-10-27 16:30:03 2098 [Warning] Access denied for user &apos;root&apos;@&apos;localhost&apos; (using password: NO)</div><div class="line">2017-10-27 16:31:06 2098 [Warning] Slave SQL: If a crash happens this configuration does not guarantee that the relay log info will b</div><div class="line">e consistent, Error_code: 0</div><div class="line">2017-10-27 16:31:06 2098 [Note] Slave SQL thread initialized, starting replication in log &apos;mysql-bin.004001&apos; at position 1000175864, </div><div class="line">relay log &apos;./prd-mysql03-relay-bin.000994&apos; position: 4145</div><div class="line">2017-10-27 16:31:06 2098 [ERROR] Slave SQL: Could not execute Write_rows event on table YKX_DW.JLC_APP_MARKPOINT_REALTIME; Duplicate </div><div class="line">entry &apos;212630&apos; for key &apos;PRIMARY&apos;, Error_code: 1062; handler error HA_ERR_FOUND_DUPP_KEY; the event&apos;s master log mysql-bin.004001, end</div><div class="line">_log_pos 1000176163, Error_code: 1062</div><div class="line">2017-10-27 16:31:06 2098 [Warning] Slave: Duplicate entry &apos;212630&apos; for key &apos;PRIMARY&apos; Error_code: 1062</div><div class="line">2017-10-27 16:31:06 2098 [ERROR] Error running query, slave SQL thread aborted. Fix the problem, and restart the slave SQL thread wit</div><div class="line">h &quot;SLAVE START&quot;. We stopped at log &apos;mysql-bin.004001&apos; position 1000175864</div></pre></td></tr></table></figure>
<p>之后<code>show slave status</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Slave_IO_Running: Yes  </div><div class="line">Slave_SQL_Running: No</div></pre></td></tr></table></figure></p>
<p>先stop slave，然后执行了一下提示的语句，就是把重复的主键记录删除，<br>再SET GLOBAL SQL_SLAVE_SKIP_COUNTER=1; START SLAVE;</p>
<p>参考：<a href="http://www.linuxidc.com/Linux/2017-02/141056.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2017-02/141056.htm</a></p>
<p><a href="http://blog.csdn.net/donghaixiaolongwang/article/details/74923971" target="_blank" rel="external">http://blog.csdn.net/donghaixiaolongwang/article/details/74923971</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[对于spark-streaming通过runningdata运行的简单规划]]></title>
      <url>/2017/10/26/%E5%AF%B9%E4%BA%8Espark-streaming%E9%80%9A%E8%BF%87runningdata%E8%BF%90%E8%A1%8C%E7%9A%84%E7%AE%80%E5%8D%95%E8%A7%84%E5%88%92/</url>
      <content type="html"><![CDATA[<h4 id="提交流程"><a href="#提交流程" class="headerlink" title="提交流程"></a>提交流程</h4><ol>
<li>添加spark jar</li>
<li>添加参数</li>
<li>配置调度</li>
</ol>
<h4 id="后台流程"><a href="#后台流程" class="headerlink" title="后台流程"></a>后台流程</h4><ol>
<li>扫描updatetime，检测新更新的spark streaming程序</li>
<li>检查jar包修改，将修改后的jar包重新上传到HDFS/mesos集群公共访问部分</li>
<li>创建/修改marathon app配置</li>
<li>重启/启动marathon app</li>
</ol>
<h4 id="日志检查"><a href="#日志检查" class="headerlink" title="日志检查"></a>日志检查</h4><p>这方面其实marathon已经做得很好了。可以直接拼接marathon的日志API搞定。</p>
<p>marathon api<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://10.2.19.125:5051/files/download?path=/server/mesos/agent/slaves/5fc969e7-c2da-4435-a0cb-278240c52f25-S2/frameworks/d2f4a97d-de35-4d1b-bf6d-07b8f2ad7666-0000/executors/willsparkstreamingtest01.cfcd8dde-ba34-11e7-9beb-3e15ac098cb2/runs/1128e325-ad92-4266-8348-04f43cfaa4c4/stderr</div></pre></td></tr></table></figure></p>
<p>mesos api<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://10.2.19.124:5050/#/agents/5fc969e7-c2da-4435-a0cb-278240c52f25-S2/browse?path=/server/mesos/agent/slaves/5fc969e7-c2da-4435-a0cb-278240c52f25-S2/frameworks/d2f4a97d-de35-4d1b-bf6d-07b8f2ad7666-0000/executors/willsparkstreamingtest01.cfcd8dde-ba34-11e7-9beb-3e15ac098cb2/runs/latest</div></pre></td></tr></table></figure></p>
<p>mesos 增量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://10.2.19.125:5051/files/read?path=/server/mesos/agent/slaves/5fc969e7-c2da-4435-a0cb-278240c52f25-S2/frameworks/d2f4a97d-de35-4d1b-bf6d-07b8f2ad7666-0000/executors/willsparkstreamingtest01.cfcd8dde-ba34-11e7-9beb-3e15ac098cb2/runs/latest/stdout&amp;offset=115771&amp;length=50000&amp;jsonp=jQuery17109253805122640539_1509014182353&amp;_=1509014197811</div></pre></td></tr></table></figure>
<p>mesos 下载<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://10.2.19.125:5051/files/download?path=/server/mesos/agent/slaves/5fc969e7-c2da-4435-a0cb-278240c52f25-S2/frameworks/d2f4a97d-de35-4d1b-bf6d-07b8f2ad7666-0000/executors/willsparkstreamingtest01.cfcd8dde-ba34-11e7-9beb-3e15ac098cb2/runs/latest/stdout</div></pre></td></tr></table></figure></p>
<p>因为有增量，所以我们会优先考虑过滤改造mesos的API。</p>
<p>对于上面所有的路径信息，<br>主要就是framework的id，mesos salve的id，task的id。</p>
<p>slaveid, taskid可以通过marathon的task接口获取到。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl http://10.2.19.124:8080/v2/apps/willsparkstreamingtest01</div></pre></td></tr></table></figure></p>
<p>framework的ID可以去<a href="http://mesos.apache.org/documentation/latest/endpoints/master/frameworks/" target="_blank" rel="external">mesos的api</a>里找到。其实后面这个就包含了上面的所有信息了。</p>
<p>另外，考虑到可能出现程序错误，导致app在marathon上不停部署，那么此时我们是需要获取前面失败的log的。失败log其实也是一次部署的log，所以路径上没有什么区别，但是可能taskid会有所变化，仔细观察上面的数据里其实是有lastTaskFailure的信息的，可以找到上个失败task的id，进而找到失败的log。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ambari添加异构OS]]></title>
      <url>/2017/10/26/ambari%E6%B7%BB%E5%8A%A0%E5%BC%82%E6%9E%84OS/</url>
      <content type="html"><![CDATA[<p>首先声明，HDFS集群中肯定是最好不要有异构机器存在的，会造成很多兼容性问题。</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><table>
<thead>
<tr>
<th>系统</th>
<th>作用</th>
<th>数量</th>
</tr>
</thead>
<tbody>
<tr>
<td>centos6</td>
<td>yarn/HDFS等服务的选定集群，主要用来运行日常任务</td>
<td>50</td>
</tr>
<tr>
<td>centos7</td>
<td>marathon/docker所在的小集群，预想用来调度任务</td>
<td>5</td>
</tr>
</tbody>
</table>
<p>其实我们已经基于centos6.8 final有了一个比较稳定的集群，上面通过ambari安装并稳健运行着HDFS、MR、Yarn、Spark、HBase等大数据服务。但是我们想要将spark streaming、hive等ETL工作的客户端放置在mesos上运行，因为当这些工作比较多的时候，也同样需要资源管理工作。鉴于mesos的资源管理相对yarn来说更加可定制化、而且已经有很多开源且稳定的framework可用，我们就选用mesos来做这个客户端集群的工作。对于long time的spark streaming，我们期望使用marathon来管理。一段时间的hive ETL任务，可以使用docker或者chronos来执行。</p>
<p>鉴于以上计划，我们需要在mesos的agent机器上安装spark、hive等客户端配置文件。考虑到易操作性和软件的版本统一兼容问题，决定继续使用ambari在mesos agent上安装这些软件的client端，然后就可以直接调用了。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>在添加新host的过程中，ambari会比较智能的告诉我们，新的OS与既有的集群OS可能存在不兼容的问题，并阻止我们进一步执行。</p>
<h2 id="处理"><a href="#处理" class="headerlink" title="处理"></a>处理</h2><p>考虑到我们只是使用客户端，而且我们的程序客户端是基于java的，具有可移植性。所以我就去找到ambari-server在新增机器的时候，对于OS的检测脚本，暂时注释掉，添加完新的host之后，再放开。</p>
<p>2.2.2.0的脚本位置:<code>/usr/lib/python2.6/site-packages/ambari_server/bootstrap.py</code>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">def run(self):</div><div class="line">    &quot;&quot;&quot; Copy files and run commands on remote host &quot;&quot;&quot;</div><div class="line">    self.status[&quot;start_time&quot;] = time.time()</div><div class="line">    # Population of action queue</div><div class="line">    action_queue = [self.createTargetDir,</div><div class="line">                    self.copyCommonFunctions,</div><div class="line">                    self.copyOsCheckScript,</div><div class="line">                    self.runOsCheckScript,</div><div class="line">                    self.checkSudoPackage</div><div class="line">    ]</div><div class="line">    if self.hasPassword():</div><div class="line">      action_queue.extend([self.copyPasswordFile,</div><div class="line">                           self.changePasswordFileModeOnHost])</div><div class="line">    action_queue.extend([</div><div class="line">      self.copyNeededFiles,</div><div class="line">      self.runSetupAgent,</div><div class="line">    ])</div><div class="line">    ....</div></pre></td></tr></table></figure></p>
<p>把action_queue里的OSCheck相关的暂时注释掉就可以了。然后去添加host的界面上点击retry failed。只要注册成功就可以了。</p>
<p>install过程跳过去了，但是注册的时候出现了问题。</p>
<p>报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">INFO 2017-10-26 16:14:42,747 NetUtil.py:60 - Connecting to https://namenode01.will.com:8440/ca</div><div class="line">ERROR 2017-10-26 16:14:42,848 NetUtil.py:84 - [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:579)</div><div class="line">ERROR 2017-10-26 16:14:42,848 NetUtil.py:85 - SSLError: Failed to connect. Please check openssl library versions. </div><div class="line">Refer to: https://bugzilla.redhat.com/show_bug.cgi?id=1022468 for more details.</div><div class="line">WARNING 2017-10-26 16:14:42,850 NetUtil.py:112 - Server at https://namenode01.will.com:8440 is not reachable, sleeping for 10 seconds...</div><div class="line">&apos;, None)</div></pre></td></tr></table></figure></p>
<p>在新的host上找到ambari-agent相关代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">def checkURL(self, url):</div><div class="line">  &quot;&quot;&quot;Try to connect to a given url. Result is True if url returns HTTP code 200, in any other case</div><div class="line">  (like unreachable server or wrong HTTP code) result will be False.</div><div class="line"></div><div class="line">     Additionally returns body of request, if available</div><div class="line">  &quot;&quot;&quot;</div><div class="line">  logger.info(&quot;Connecting to &quot; + url)</div><div class="line">  responseBody = &quot;&quot;</div><div class="line"></div><div class="line">  try:</div><div class="line">    parsedurl = urlparse(url)</div><div class="line"></div><div class="line">    if sys.version_info &gt;= (2,7,9):</div><div class="line">        import ssl</div><div class="line">        ca_connection = httplib.HTTPSConnection(parsedurl[1], context=ssl._create_unverified_context())</div><div class="line">    else:</div><div class="line">        ca_connection = httplib.HTTPSConnection(parsedurl[1])</div><div class="line">    ...</div><div class="line">  except SSLError as slerror:</div><div class="line">    logger.error(str(slerror))</div><div class="line">    logger.error(ERROR_SSL_WRONG_VERSION)</div><div class="line">    return False, responseBody</div><div class="line"></div><div class="line">  except Exception, e:</div><div class="line">    logger.warning(&quot;Failed to connect to &quot; + str(url) + &quot; due to &quot; + str(e) + &quot;  &quot;)</div><div class="line">    return False, responseBody</div></pre></td></tr></table></figure></p>
<p>从报错来看，是出现了SSLError，好像是SSL的兼容问题。对比看一下ssl的版本：</p>
<ul>
<li>centos7 openssl-1.0.2k-8.el7.x86_64</li>
<li>centos6 openssl-1.0.1e-57.el6.x86_64</li>
</ul>
<p>考虑到既有集群的稳定性，失败告终。配置同步问题转由rsync、nfs之类的方案解决吧。</p>
<p>参考：</p>
<ul>
<li><a href="https://community.hortonworks.com/questions/4324/hdp-support-for-mix-of-os-releases-within-a-cluste.html" target="_blank" rel="external">https://community.hortonworks.com/questions/4324/hdp-support-for-mix-of-os-releases-within-a-cluste.html</a></li>
<li><a href="https://community.hortonworks.com/questions/18479/how-to-register-host-with-different-os-to-ambari.html" target="_blank" rel="external">https://community.hortonworks.com/questions/18479/how-to-register-host-with-different-os-to-ambari.html</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[主从备份问题]]></title>
      <url>/2017/10/25/%E4%B8%BB%E4%BB%8E%E5%A4%87%E4%BB%BD%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<p>昨天同事聊起mysql的主从备份问题。我们都知道mysql的主从同步是通过binlog实现的，抛开已经成行的主从不说，如果要新增从库的话，那么具体是精准的copy数据库镜像，然后记录binlog位置的呢？如果说copy镜像的话，那么一定要停库或者锁表了，如果是copy主库的话，那势必会影响线上业务了。</p>
<p>参考了一些资料，自己脑袋也跟着转了一下，总结出以下几种情况。</p>
<ol>
<li>当前已经有了健壮的主从结构/或者是健壮的双热备，只需要新增一个从库。</li>
</ol>
<ul>
<li>将从库暂时停掉</li>
<li>进行这个mysql的所有数据的拷贝</li>
<li>在目标新从库修改server-id</li>
<li>启动新老从库</li>
<li>验证确认</li>
</ul>
<ol>
<li>当前只有主库，前面并没有配置从库，但是已经有了binlog。</li>
</ol>
<ul>
<li>最稳妥的：停掉，copy，配置，重启。</li>
<li>使用mysqldump，这种最不推荐，因为会锁表，那么对于线上应用来说一样是会收到影响。反正都会影响线上，还不如停掉更为稳妥</li>
<li>使用xtrabackup进行备份，不锁表，不影响线上业务。具体参考<a href="http://sofar.blog.51cto.com/353572/1313649" target="_blank" rel="external">xtrabackup原理及实施</a>。大概流程如下图：<br><img src="C:\Users\will\Pictures\xtrabakcup.png" alt=""><br>具体来说，首先在logfile中找到并记录最后一个checkpoint（“last checkpoint LSN”），然后开始从LSN的位置开始拷贝InnoDB的logfile到xtrabackup_logfile；然后开始拷贝全部的数据文件.ibd；在拷贝全部数据文件结束之后，才停止拷贝logfile。<br>因为<strong>logfile里面记录全部的数据修改情况</strong>，所以即使在备份过程中数据文件被修改过了，恢复时仍然能够通过解析xtrabackup_logfile保持数据的一致。</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="http://sofar.blog.51cto.com/353572/1313649" target="_blank" rel="external">http://sofar.blog.51cto.com/353572/1313649</a></li>
<li><a href="http://database.51cto.com/art/201507/483499.htm" target="_blank" rel="external">http://database.51cto.com/art/201507/483499.htm</a></li>
<li><a href="http://lizhenliang.blog.51cto.com/7876557/1612800" target="_blank" rel="external">http://lizhenliang.blog.51cto.com/7876557/1612800</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[一次查询hang事件]]></title>
      <url>/2017/10/16/%E4%B8%80%E6%AC%A1%E6%9F%A5%E8%AF%A2hang%E4%BA%8B%E4%BB%B6/</url>
      <content type="html"><![CDATA[<h2 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h2><p>同事在navicat上为table A修改了了一个字段长度，然后navicati卡死了。重启后这个表就不能查询了。</p>
<h2 id="排查"><a href="#排查" class="headerlink" title="排查"></a>排查</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">show processlist</div></pre></td></tr></table></figure>
<p>查看慢查询发现有status为Waiting for table metadata lock的查询出现。</p>
<p>查看运行中的事务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select * from information_schema.innodb_trx</div></pre></td></tr></table></figure></p>
<p>根据trx_started找到运行时间最长的kill掉慢查询对应的trx_mysql_thread_id，之后就恢复了。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Chronos]]></title>
      <url>/2017/10/10/Chronos/</url>
      <content type="html"><![CDATA[<p>Chronos 内部很简单：</p>
<ul>
<li>从zk的state store中读取所有job的state</li>
<li>job都在scheduler里注册过了，会别加载进job graph，以追踪依赖关系</li>
<li>根据host时间，job被分成不同的list中，有些现在就要跑，有些不用</li>
<li>需要跑的job会被放进队列，只要有充足的资源就马上运行</li>
<li>等再有job需要run的时候，就重复1</li>
</ul>
<p>一个job只有在它的所有parent都运行完成过才能运行。它跑完之后，这个轮次就结束了。</p>
<p>这段代码在mainLoop()方法中。<a href="https://github.com/mesos/chronos/blob/be96c4540b331b08d9742442e82c4516b4eaee85/src/main/scala/org/apache/mesos/chronos/scheduler/jobs/JobScheduler.scala#L469-L498" target="_blank" rel="external">https://github.com/mesos/chronos/blob/be96c4540b331b08d9742442e82c4516b4eaee85/src/main/scala/org/apache/mesos/chronos/scheduler/jobs/JobScheduler.scala#L469-L498</a></p>
<p>其他特性</p>
<ul>
<li>向cassandra写入job metrics，用来分析、估计等</li>
<li>发送不同的通知：email、slack等</li>
<li>导出metric到graphite或其他地方</li>
</ul>
<p>不能做的</p>
<ul>
<li>解决所有分布式问题</li>
<li>保证精准调度</li>
<li>保证时间同步</li>
<li>保证job真正运行了</li>
</ul>
<h2 id="实例架构"><a href="#实例架构" class="headerlink" title="实例架构"></a>实例架构</h2><p><img src="https://mesos.github.io/chronos/img/emr_use_case.png" alt=""></p>
<h2 id="UI"><a href="#UI" class="headerlink" title="UI"></a>UI</h2><ul>
<li>增删改job</li>
<li>运行job</li>
<li>展示job依赖关系</li>
<li>已经执行完的job的统计量</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><p>要是已经安装了DC/OS的话<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dcos package install chronos</div></pre></td></tr></table></figure></p>
<p>另外也可以使用docker启动，要保证两个端口资源：HTTP API， libprocess。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run --net=host -e PORT0=8080 -e PORT1=8081 mesosphere/chronos:v3.0.0 --zk_hosts 192.168.65.90:2181 --master zk://192.168.65.90:2181/mesos</div></pre></td></tr></table></figure>
<p>源码构建<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">export MESOS_NATIVE_LIBRARY=/usr/local/lib/libmesos.so</div><div class="line">git clone https://github.com/mesos/chronos.git</div><div class="line">cd chronos</div><div class="line">mvn package</div><div class="line">java -cp target/chronos*.jar org.apache.mesos.chronos.scheduler.Main --master zk://localhost:2181/mesos --zk_hosts localhost:2181</div></pre></td></tr></table></figure></p>
<p>运行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">java -jar chronos.jar --master zk://127.0.0.1:2181/mesos --zk_hosts 127.0.0.1:2181</div></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[mesos框架概览：-mesos-master,-mesosframework,-kibana,-minimesos]]></title>
      <url>/2017/10/10/mesos%E6%A1%86%E6%9E%B6%E6%A6%82%E8%A7%88%EF%BC%9A-mesos-master,-mesosframework,-kibana,-minimesos/</url>
      <content type="html"><![CDATA[<h2 id="提纲"><a href="#提纲" class="headerlink" title="提纲"></a>提纲</h2><ul>
<li>使用<a href="http://www.github.com/ContainerSolutions/Mesos-Starter" target="_blank" rel="external">mesos-starter</a>做的自定义framework</li>
<li>使用<a href="http://www.github.com/ContainerSolutions/MesosFramework" target="_blank" rel="external">mesos framework</a>做的一个通用framework</li>
<li>一个为<a href="https://github.com/mesos/kibana" target="_blank" rel="external">kibana</a>定制的mesos framework</li>
<li>使用<a href="http://minimesos.org/" target="_blank" rel="external">minimesos</a>进行测试</li>
<li></li>
</ul>
<h2 id="mesos-starter"><a href="#mesos-starter" class="headerlink" title="mesos-starter"></a>mesos-starter</h2><p>这是一个spring工具，[简单参考(<a href="http://container-solutions.com/mesos-starter/)。下面是一些特性" target="_blank" rel="external">http://container-solutions.com/mesos-starter/)。下面是一些特性</a></p>
<ul>
<li>暴露一个bean来控制实例数量(提供水平扩展能力)</li>
<li>管理端口。用户可以请求静态的、或者mesos制定的端口，并且把它们用作环境变量</li>
<li>配置docker网络类型</li>
<li>mesos鉴权</li>
<li>用户可以指定任务的sandbox里下载二进制包以及其他附件资源的的URI</li>
</ul>
<p>这些新特性可以支撑framework更高的灵活性。例如，我们若是在minimesos中使用docker containerizer，就必须使用dcoker bridge模式来保护host上的端口不会冲突(所有的agent都使用同一个docker daemon)。但是在实际情况中，我们需要docker 运行在host模式，这样它们就可以直接使用主机ip了。</p>
<h2 id="mesosFramework"><a href="#mesosFramework" class="headerlink" title="mesosFramework"></a>mesosFramework</h2><p>MesosFramework是一个分布式的基于spring的二进制包，或者基于mesos-starter的docker容器。用户可以使用一个简单的配置文件快速创建一个可以运行在mesos上的framework，只需要告诉MesosFramework它应该运行什么任务就可以了。MesosFramework很通用，用户可以完全控制deployment。</p>
<p>我们讨论过<a href="http://container-solutions.com/reasons-use-apache-mesos-frameworks/" target="_blank" rel="external">为什么会想自己写一个mesos framwork</a>，希望你考虑使用Mesos-starter.许多简单的app都可以通过一个类似marathon的orchestration tool来启动。但是有些用例是介于这两个极端之间的，例如</p>
<ul>
<li>既想利用mesos-starter一些好的特性，又不想编写任何代码(authorisation， 一个orchestraion strategy等)</li>
<li>要打包一个特定的framework配置，这样用户就不用关心配置了（还是没有代码）</li>
<li>为某framework快速部署一个POC</li>
</ul>
<p>对我们来说，有很多frameworkd都落入了这个灰色地带。主要的好处就是减少了代码编写，也就减少了维护成本。</p>
<p>MesosFramework还添加了一些Mesos-Starter之外的特性。比如：查看task状态的REST接口、水平扩容等。</p>
<h2 id="Kibana-framework"><a href="#Kibana-framework" class="headerlink" title="Kibana framework"></a>Kibana framework</h2><p>新的<a href="https://github.com/mesos/kibana" target="_blank" rel="external">Kibana framework</a>就是基于MesosFramework和Mesos-starter构建的。它继承了这两个项目的所有特性。也就是说对于这两个项目的更新与特性发布会自动包含进像kibana这种下游项目中。这就是天堂，不用管理代码就能获得最新的特性。</p>
<p>但是最大的特点其实是：没有代码！！同样的重构也会应用到Logstash framework中。很多mesos framework都有对于代码的过度引用。每个framework都使用同样的方式添加mesos authorisation特性。全球的工程师都在同样的代码。我们都知道：代码越多，bug越多。</p>
<p>移除kibana的一些特定代码之后，我们同时搞定了潜在的bug，添加了新的特性，还降低了维护成本。</p>
<h2 id="minimesos"><a href="#minimesos" class="headerlink" title="minimesos"></a>minimesos</h2><p>以前，我们使用一个真正的mesos cluster给我们的demo使用。现在只需要使用minimesos就可以了。例如，有一天我想要测试<a href="https://github.com/mesos/elasticsearch" target="_blank" rel="external">Elasticsearch framework</a>是不是能够在mesos0.27版本正常工作(它本身是针对0.25版本编译的)。以前我需要写一个0.27版本集群的脚本，现在我只需要修改nimimesos配置文件中的一行就可以了。</p>
<p>参考：<a href="http://container-solutions.com/mesos-framework-overview/" target="_blank" rel="external">http://container-solutions.com/mesos-framework-overview/</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[presto架构]]></title>
      <url>/2017/10/09/presto%E6%9E%B6%E6%9E%84/</url>
      <content type="html"><![CDATA[<h2 id="server-类型"><a href="#server-类型" class="headerlink" title="server 类型"></a>server 类型</h2><h4 id="Coordinator"><a href="#Coordinator" class="headerlink" title="Coordinator"></a>Coordinator</h4><h4 id="Worker"><a href="#Worker" class="headerlink" title="Worker"></a>Worker</h4><h2 id="数据源"><a href="#数据源" class="headerlink" title="数据源"></a>数据源</h2><h4 id="Connector"><a href="#Connector" class="headerlink" title="Connector"></a>Connector</h4><p>用来适配presto到类似hive的RDBMS。可以把connector当成database的driver。是Presto的SPI的一个实现，允许presto使用标准API与资源进行交互。</p>
<p>Presto包含几个内置的connectors：JMX, HIVE, System connector用来提供访问内部系统表的访问方式， TPCH connector用来提供TPC-H benchmark数据。还有一些第三方的connector。</p>
<p>每个catalog是与一个指定的connector进行协作的。如果你看过catalog的配置文件，你会发现每个都必须包含一个connector.name属性，catalog manager用这个来为指定catalog创建对应的connector。可以多个catalog共用同一个connector来连接两个相同数据库的不同实例。例如，假设我们有两个hive集群，我们就配置两个catalog实例，都用hive connector，这样甚至能在同一个SQL查询中查询到两个hive集群中的数据。</p>
<h4 id="catalog"><a href="#catalog" class="headerlink" title="catalog"></a>catalog</h4><p>一个catalog包含多个数据库schema和通过一个connector关联的数据源。在运行sql语句的时候，可以在一个或多个catalog中进行数据查询。</p>
<p>在presto中，数据表的全名是catalog的根部。例如hive.test.data.test就是hive catalog中的test_data数据库中的test表。</p>
<p>catalog是通过presto配置目录中的properties文件定义的。</p>
<h4 id="schema"><a href="#schema" class="headerlink" title="schema"></a>schema</h4><p>schema是用来组织table的。catalog和schema用来定义一组可供查询的数据表。在prestor查询hive或者mysql等关系型数据库的时候，schema就对应于数据库名。其他类型的connector也可以根据具体场景进行对应</p>
<h4 id="Table"><a href="#Table" class="headerlink" title="Table"></a>Table</h4><p>未排序的数据行的组合，每个列都有自己的类型。与关系型数据库定义一样。</p>
<h2 id="查询模型"><a href="#查询模型" class="headerlink" title="查询模型"></a>查询模型</h2><h4 id="Statement"><a href="#Statement" class="headerlink" title="Statement"></a>Statement</h4><p>Presto执行ANSI兼容的SQL语句。当一个statement被执行的时候，presto创建一个query和一个query plan，然后这个plan被分布到presto worker中执行。</p>
<h4 id="Query"><a href="#Query" class="headerlink" title="Query"></a>Query</h4><p>Presto解析statement的时候，把statement转化成一个query，创建一个分布式的query plan，然后形成一系列相互关联的stage，运行到不同的presto worker上。当我们抽取一个查询的信息的时候，我们会获取到对应于这个satement的每个组件的状态快照。</p>
<p>statement和query的区别很简单，statement可以看作传递给presto的SQL语句，一个query则对应于执行这个statement的配置与实例化的组件。一个query包含了stage、task、split、connector、数据源以及其他组件。</p>
<h4 id="Stage"><a href="#Stage" class="headerlink" title="Stage"></a>Stage</h4><p>presto执行query时，会把query plan打成一系列有层级的stage。例如，如果presto需要聚合hive里的一亿行数据，他需要创建一个root stage来对其他stage的output执行聚合操作，这些其他stage负责query plan中的不同部分。</p>
<p>这些stage可以使用tree来表示。每个query都有一个root stage来执行其他stage的聚合操作。coordinator 是coordinator用来模型化分布式query plan的，但是stage本身并不运行在presto worker上。</p>
<h4 id="Task"><a href="#Task" class="headerlink" title="Task"></a>Task</h4><p>前面提到，stage只是模型化分布式查询计划的一个特定部分，而不在presto worker上执行。一个stage其实又被一系列task实现，分布式运行在presto worker上。</p>
<p>presto task是有多个input和output的，可以与一系列driver并行执行。</p>
<h4 id="Split"><a href="#Split" class="headerlink" title="Split"></a>Split</h4><p>stage是通过connector从数据源以split为单位抽取数据的，然后中间的stage或高层stage又从其他stage中抽取数据。</p>
<p>prestor执行query时，coordinator会从一个connector查到指定table的所有的split。coordinator追踪哪些机器在运行哪些task，哪些split在被哪些task处理。</p>
<h4 id="Driver"><a href="#Driver" class="headerlink" title="Driver"></a>Driver</h4><p>task包含一个或多个并行的driver，一个driver只有一个input和output。dirver整合operator来生成output，这个output会被task聚合，再传递给其他stage的一个task。一个driver是一个operator实例的序列，可以把他看成内存中的一系列operator集合。它是presto并发执行的最低层单元了。</p>
<h4 id="Operator"><a href="#Operator" class="headerlink" title="Operator"></a>Operator</h4><p>operator消费、转换、生产数据。例如，一个table scan从connector中抽取数据，然后生产可以被其他operator消费的数据。一个filter operator消费数据，生产已经过滤掉的一个数据子集。</p>
<h4 id="Exchange"><a href="#Exchange" class="headerlink" title="Exchange"></a>Exchange</h4><p>Exchange负责在Presto节点间传递同一个query的不同stage的数据。task把数据生成进一个output buffer，并使用exchange client消费其他task生成的数据。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[impala架构]]></title>
      <url>/2017/10/09/impala%E6%9E%B6%E6%9E%84/</url>
      <content type="html"><![CDATA[<h2 id="impala-Daemon"><a href="#impala-Daemon" class="headerlink" title="impala Daemon"></a>impala Daemon</h2><p>核心的impala组件是impala daemon，它需要在每个datanode上部署一个，进程名是impalad。它负责读写数据文件、接收来自impala-shell命令行、hue、JDBC或者ODBC的查询；并行执行查询、为集群分配分布式任务、再把中间查询结果发送回coordinator node。</p>
<p>可以通过任何一个datanode上的impala daemon提交查询，然后这个node上的impala daemon就作为这个查询的coordinator node。其他node把部分结果回传给coordinator node，coordinator node负责把这些结果进行组织，并产生最终结果。当通过impala-shell命令运行查询的时候，我们可能需要一直连接着同一个impala daemon。对于集群生产环境，我们需要考虑负载均衡，将查询放到不同的node上去提交。</p>
<p>impala daemon需要与statestore持续联系，以确认哪些node是健康的，可以接受任务。</p>
<p>impala daemon还要接收catalogd的广播信息，获取集群中哪些impala node新建、修改、drop一些类型的对象、或insert或者load data语句的执行。这个动作最小化了REFRESH和INVALIDATE METADATA语句的执行次数，这两个动作在1.2之前必须要协调所有node的元数据。</p>
<p>在2.9或更高版本中，我们可以控制哪些node可以用作query coordinator，那些是query executor，以此提升扩展性。</p>
<h2 id="impala-statestore"><a href="#impala-statestore" class="headerlink" title="impala statestore"></a>impala statestore</h2><p>statestore负责检查所有 datanode上的impala daemon的健康状态，同时也通知每个impala daemon它的新发现。他是一个独立的进程，statestored，需要集群中的某个机器上有一个就可以。如果一个impala daemon掉线的话，statestore会通知所有其他的impala daemon，这要后面的查询任务就不会分配到这个掉线的node上。</p>
<p>因为statestore的职责是处理问题情况，所以它并不是impala 集群执行正常任务的核心所在。如果statestore挂掉，impala daemon会像往常一样继续运行、分配任务、执行任务。只是集群会在某些impala daemon挂掉的时候变得不那么强壮。当statestore恢复之后，它会重建与impala daemon的联系。</p>
<p>多数既有的HA和LB方案都可以用于impala daemon。而statestored和catalogd进程就不需要，因为它们挂掉并不会造成数据丢失。如果这些进程变为不可用的话，可以直接停掉impala服务，删掉基友的impala statestore和impala catalog server，然后把它们分配到其他的node上，重启impala service就可以了。</p>
<h2 id="impala-catalog服务"><a href="#impala-catalog服务" class="headerlink" title="impala catalog服务"></a>impala catalog服务</h2><p>catalog服务负责将impala SQL语句导致的源数据变化传递给集群中的所有的Datanode节点，进程为catalogd，整个集群只需要一个。因为查询请求会通过statestore daemon，最好将statestored和catalogd两个服务运行在同一个host上。</p>
<p>catalog服务避免了由元数据变化引起的REFRESH和INVALIDATE METADATA操作。当我们通过hive创建表、加载数据的时候，我们必须要执行REFRESH和INVALIDATE METADATA操作才能执行数据查询。</p>
<p>这个特性有关于impala的以下几个方面：</p>
<ul>
<li>见安装impala、升级impala</li>
<li>通过impala执行CREATE TABLE, INSERT或者其他修改表、修改数据的操作并不需要REFRESH和INVALIDATE METADATA操作。但是如果是通过hive或者手动加载HDFS文件方式的话，就需要。</li>
</ul>
<p>默认地，加载元数据和加载缓存是异步的，所以impala可以立刻接收请求。可以通过参数配置load_catalog_in_background=false.。</p>
<h2 id="impala对于hadoop生态的兼容与适配"><a href="#impala对于hadoop生态的兼容与适配" class="headerlink" title="impala对于hadoop生态的兼容与适配"></a>impala对于hadoop生态的兼容与适配</h2><h4 id="hive"><a href="#hive" class="headerlink" title="hive"></a>hive</h4><p>impala维护了table定义，也就是metastore，其实就是hive 的metastore的数据库。impala还要追踪对应的数据文件：HDFS中数据的block的具体位置。</p>
<p>对于数据量特别大、分区数特别多的表来说，单抽取元数据就可能花掉数分钟的时间。因此，每个impala  node都会把这些信息缓存起来以供后面重用。</p>
<p>如果某个表的定义改变或者数据被更新，那么其他所有的impala daemon都要在对这个表执行查询之前同步最新的metadata，替换掉老的那份缓存。1.2版本之后，这个过程是自动的通过catalogd进程完成。</p>
<p>对于未通过impala操作的修改，则需要执行REFRESH（已经存在的表加入新的数据文件或更新）或者INVALIDATE METADATA(创建新标、删除表、执行了HDFS rebalance、 删除了数据文件等)。INVALIDATE METATDATA会重新抽取所有的表的metadata。所有如果要是知道哪个表有变化的话，可以使用REFRESH table_name来执行只拉取这个表的相关元数据。</p>
<h4 id="HDFS"><a href="#HDFS" class="headerlink" title="HDFS"></a>HDFS</h4><p>impala使用HDFS作为主要的存储介质，利用HDFS的冗余来保证数据不丢失。impala表数据物理上就是HDFS的数据文件，可以是HDFS支持的任何格式或压缩格式。当数据文件是放在一个目录作为一个表存在是，impala会把这个目录下所有的文件都作为表的内容进行读取。通过impala新增的数据文件，则会由impala进行命名。</p>
<h4 id="HBase"><a href="#HBase" class="headerlink" title="HBase"></a>HBase</h4><p>HDFS的替代方案。需要在impala中额外定义对应表。</p>
<h2 id="并发控制"><a href="#并发控制" class="headerlink" title="并发控制"></a>并发控制</h2><p>通过准入控制来闲置资源的方式之一是限制一个最大并发查询数量。在我们没有内存使用情况的足够信息的时候这是一个比较初步的方式。这个参数可以分别给每个动态资源池进行设置。</p>
<p>这个配置也可以结合下面章节中内存控制的配置一起使用。不管是达到了内存最大使用量，或者超过了最大并发查询数，后续的查询都会被放到队列里，等待资源。</p>
<h2 id="内存控制"><a href="#内存控制" class="headerlink" title="内存控制"></a>内存控制</h2><p>每个动态资源池都可以配置一个最大内存使用量。最好是在已经明确知道工作量与使用大小的时候使用这个配置。</p>
<p>每个host上都要指定一个默认的最大内存Default Query<br>Memory Limit，相当于在这个资源池中为每个query指定一个MEM_LIMIT参数。</p>
<p>另外，也可以根据每个node的最大内存计算出一个集群级别的最大内存限制，来控制最多并行查询数。</p>
<p>例如下面场景：</p>
<ul>
<li>五个datanode上运行了impalad</li>
<li>设置一个动态资源池的最大内存为100G</li>
<li>host级别的最大内存Default Query<br>Memory Limit设置为10G，那么每个查询最多使用 5 * 10 = 50G</li>
<li>在这个动态资源池中可以并行运行的查询数为2，100 / 50 = 2.</li>
<li>如果查询并没有用满host或者集群级别的内存上限额度，并不会有什么惩罚措施。这些上限值只是用来估算资源池里可以并行多少查询。</li>
</ul>
<p>注意： 如果你为某个impala动态资源池指定了集群级别的最大内存，就必须指定host级别的最大内存Default Query<br>Memory Limit。</p>
<h2 id="与其他资源管理工具的关系"><a href="#与其他资源管理工具的关系" class="headerlink" title="与其他资源管理工具的关系"></a>与其他资源管理工具的关系</h2><p>admission control是轻量级、去中心化的。他设置的是一个soft limit，并不是像yarn把资源进行all-or-nothing方式处理。</p>
<p>因为admission control并不与其他hadoop组件(MR)交互，我们可以使用yarn的部分静态资源池，与其他hadoop应用共享yarn。要使用impala多租户的时候推荐使用此种配置。admission control控制查询并发和内存上限，yarn来管理其它的组件。这种情况中，impala的资源并不是由yarn管理的。</p>
<p>impala的admission control可以使用yarn的user与pool的认证关系。</p>
<p>虽然impala admission control使用了fair-scheduelr.xml配置文件，但是这个文件并不关心YARN实际使用哪个scheduler，也就是说它仍可以使用capacity scheduler。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hadoop-vs-mpp]]></title>
      <url>/2017/10/09/hadoop-vs-mpp/</url>
      <content type="html"><![CDATA[<h2 id="什么是MPP"><a href="#什么是MPP" class="headerlink" title="什么是MPP"></a>什么是MPP</h2><p>MPP全名是massively parallel processing，是网格计算的一种实现，网格中的所有节点都参与计算过程。MPP DBMS是基于MPP的DBMS。每个查询都需要先切分计算任务，这会比传统的SMP RDBMS更快一些。另外，MPP还具有扩展性，我们可以方便的向网格中添加节点来扩展计算与存储能力。为了处理大量数据，需要对数据进行在节点之间进行shard，这样每个节点都只处理自己本地的数据。这进一步提升了数据处理速度，因为使用共享存储的话会出现一个很大的问题—— 更复杂，更昂贵，不易扩展，更高的网络IO，更小的并行度。这就是大多数MPP DBMS方案share-nothing不共享任何东西，运行在DAS（direct-attached storage）或者小组server共享机架存储的原因。Teradata、Greenplum、Vertica、Netezza等都是使用的这种方式。这些工具都有一个复杂且成熟，专为MPP方案订制的SQL optimizer。而且他们都是可扩展的，围绕这些方案有很多的工具包来支持用户的需求：地理位置分析、全文检索等。他们都是闭源的复杂的企业级解决方案(Greenplum在2015年开源)。</p>
<p><img src="https://0x0fff.com/wp-content/uploads/2015/07/MPP_arch.gif" alt=""></p>
<h2 id="hadoop"><a href="#hadoop" class="headerlink" title="hadoop"></a>hadoop</h2><p>那么hadoop呢？不是一个单一的技术，而是一个生态。基友好处也有坏处，最大的优点就是延展性好 - 催生了一些列的新组件（spark），而且这些组件的核心都与hadoop息息相关，这就给集群的扩展性很多可能性。一个缺点是弄一个整套的生态是比较费事儿的，现在没人手工弄，都是借助工具了。</p>
<p>hadoop的存储技术是一个完全不同的方式。并不是根据key去把数据进行shard，而是把数据弄成指定大小的block块进行切分，以block为单位存储在不同节点上。这些数据块一般是比较大且只读的，整个文件系统也是只读的。简单来说，对于加载100行数据表，MPP引擎会基于某个key把数据进行shard，对于较大的集群来说这种方式可能会出现每个node上只有一条记录的现象。而如果使用HDFS的话，这个小的表会被写在一个数据块中，对于datanode的文件系统来说只是一个普通的 文件而已。</p>
<p>资源管理呢？不同于MPP方案，hadoop的资源管理器具有更细粒度。MR任务不需要所有的计算任务都并行执行，如果集群资源满载的时候，我们甚至可以把某个任务的数据和所有计算任务都丢到一个节点上执行。还有一系列的其他延展性，支持长时间运行的container等..但是事实上，它比MPP的资源管理器会慢一些，而且对于并发管理表现也稍逊一筹。</p>
<h2 id="可选"><a href="#可选" class="headerlink" title="可选"></a>可选</h2><p>对于Hadoop的SQL接口工具，有很多工具可以选择：基于MR/Tez/Spark的hive、sparksql、impala、HAQW或者IBM BigSQL、或者完全不同的Splice Machine。因为有太多工具可选，也很容易迷失。</p>
<h4 id="hive"><a href="#hive" class="headerlink" title="hive"></a>hive</h4><p>把sql转化为MR/Tez/Spark任务，在集群上执行。所有的这些任务类型其实都是基于MR思想，可以很好的利用集群，也方便与其他的hadoop技术栈进行整合。缺点也很明显 —— 执行查询的延迟较大，对于表之间的join操作性能堪忧，没有查询优化器引擎只按照你说的方式进行执行。下图覆盖了废弃的MR1的设计图：<br><img src="https://0x0fff.com/wp-content/uploads/2015/07/HiveArchitecture.jpg" alt=""></p>
<h4 id="MPP"><a href="#MPP" class="headerlink" title="MPP"></a>MPP</h4><p>类似impala和HAWQ的解决方案则与hive相对，使用了基于HDFS的MPP执行引擎。他们对于查询有更小的延迟、更少的处理时间，但是牺牲了一些扩展性和稳定性。</p>
<p><img src="https://0x0fff.com/wp-content/uploads/2015/07/impala.png" alt=""></p>
<h4 id="SparkSQL"><a href="#SparkSQL" class="headerlink" title="SparkSQL"></a>SparkSQL</h4><p>sparkSQL是一个介于MR和MPP-over-hadoop之间的解决方案。与MR类似，它把job切分为一组task进行分别调度，这样来保证比较好的稳定性。又类似于MPP，试图把各个执行的stage之间流式串联起来来提高处理速度。他还使用类似于MPP的固定的executor来降低查询延迟。它继承了优点，同样缺点也跟了过来 —— 不及MPP快，不及MR稳定。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><table>
<thead>
<tr>
<th>指标</th>
<th>MPP</th>
<th>Hadoop</th>
</tr>
</thead>
<tbody>
<tr>
<td>平台开放性</td>
<td>闭塞且专利。对于一些技术甚至连文档都是闭源的</td>
<td>完全开源</td>
</tr>
<tr>
<td>硬件选择</td>
<td>很多都是必须依托服务方的，很少能部署在自己的集群上。所有的解决方案都需要企业级的硬件，比如快速硬盘，大ECC RAM的服务器，无线带宽等</td>
<td>任何硬件都可用。最推荐的就是使用廉价的带有DAS的硬件【就是磁盘单挂】</td>
</tr>
<tr>
<td>节点水平扩展</td>
<td>平均几十台，最多100-200台</td>
<td>平均100台，最多几千台</td>
</tr>
<tr>
<td>用户数据扩展性</td>
<td>几十TB，最多PB级别</td>
<td>几百TB, 最多几十PB</td>
</tr>
<tr>
<td>查询延迟</td>
<td>10-20 milliseconds</td>
<td>10-20 seconds</td>
</tr>
<tr>
<td>平均查询时间</td>
<td>5-7 seconds</td>
<td>10-15 minutes</td>
</tr>
<tr>
<td>最大查询时间</td>
<td>1-2 hours</td>
<td>1-2 weeks</td>
</tr>
<tr>
<td>查询优化</td>
<td>复杂的企业级查询优化引擎使用全局最优的方式</td>
<td>没有optimizer，或者有限制，有时甚至都不支持cost-based</td>
</tr>
<tr>
<td>查询debug与profile</td>
<td>有查询计划与查询静态量，提供错误信息</td>
<td>OON问题和java堆溢出分析，GC停止信息，分离的任务日志</td>
</tr>
<tr>
<td>技术代价</td>
<td>每个节点几千或者几万美元</td>
<td>每个节点最多几千美元</td>
</tr>
<tr>
<td>终端用户的访问</td>
<td>SQL接口和一些简单的数据库函数</td>
<td>SQL并不完全兼容。用户需要关注执行逻辑，数据的分布。函数一般需要用java进行编写，放到集群中</td>
</tr>
<tr>
<td>目标用户</td>
<td>商业分析师</td>
<td>java dev和经验丰富的DBA</td>
</tr>
<tr>
<td>单job冗余度</td>
<td>低，MPP节点失败，则job失败</td>
<td>高，job失败后有重试</td>
</tr>
<tr>
<td>目标系统</td>
<td>一般的DWH和分析系统</td>
<td>为特定目标构建的数据处理引擎</td>
</tr>
<tr>
<td>vendor lock-in</td>
<td>typical case</td>
<td>Rare case usually caused by technology misuse</td>
</tr>
<tr>
<td>推荐的最小的数据大小</td>
<td>任何</td>
<td>GB</td>
</tr>
<tr>
<td>最大并发</td>
<td>几十到几百个query</td>
<td>10-20个job</td>
</tr>
<tr>
<td>技术延展性</td>
<td>只能使用厂家提供的工具</td>
<td>可以随意组合开源工具</td>
</tr>
<tr>
<td>需要的DBA技术级别</td>
<td>一般水平</td>
<td>精通java和RDBMS背景</td>
</tr>
<tr>
<td>方案实现服务性</td>
<td>中</td>
<td>高</td>
</tr>
</tbody>
</table>
<p>有了以上信息，我们知道为什么hadoop不能完全取代传统企业级数据仓库，但是他是可以用作处理海量数据的一种分布式引擎。facebook有一个300PB的hadoop集群，它还额外用了50TB的Vertica集群。Linkedin有一个巨大的hadoop集群，也同样有一个Aster数据中心（Teradata提供的MPP工具）。</p>
<p>参考：<br><a href="https://0x0fff.com/hadoop-vs-mpp/" target="_blank" rel="external">https://0x0fff.com/hadoop-vs-mpp/</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[centos7-微服务相关环境部署]]></title>
      <url>/2017/09/30/centos7-%E5%BE%AE%E6%9C%8D%E5%8A%A1%E7%9B%B8%E5%85%B3%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2/</url>
      <content type="html"><![CDATA[<h4 id="系统环境"><a href="#系统环境" class="headerlink" title="系统环境"></a>系统环境</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">hostnamectl set-hostname xx.will.com --static</div><div class="line"></div><div class="line">yum install -y wget git vim ntpdate</div><div class="line"></div><div class="line">timedatectl set-timezone Asia/Shanghai</div><div class="line"></div><div class="line">/usr/sbin/ntpdate us.pool.ntp.org</div></pre></td></tr></table></figure>
<h4 id="docker安装"><a href="#docker安装" class="headerlink" title="docker安装"></a>docker安装</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">tee /etc/yum.repos.d/docker.repo &lt;&lt;-&apos;EOF&apos;</div><div class="line">[dockerrepo]</div><div class="line">name=Docker Repository</div><div class="line">baseurl=https://yum.dockerproject.org/repo/main/centos/7/</div><div class="line">enabled=1</div><div class="line">gpgcheck=1</div><div class="line">gpgkey=https://yum.dockerproject.org/gpg</div><div class="line">EOF</div><div class="line"></div><div class="line">yum install docker-engine -y</div><div class="line"></div><div class="line"># 获取最新版本的docker</div><div class="line"># curl -fsSL https://get.docker.com/ | sh</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">systemctl enable docker.service</div><div class="line">systemctl restart docker</div><div class="line"></div><div class="line"></div><div class="line">docker version</div></pre></td></tr></table></figure>
<p>ubuntu<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"># step 1: 安装必要的一些系统工具</div><div class="line">sudo apt-get update</div><div class="line">sudo apt-get -y install apt-transport-https ca-certificates curl software-properties-common</div><div class="line"># step 2: 安装GPG证书</div><div class="line">curl -fsSL http://mirrors.aliyun.com/docker-ce/linux/ubuntu/gpg | sudo apt-key add -</div><div class="line"># Step 3: 写入软件源信息</div><div class="line">sudo add-apt-repository &quot;deb [arch=amd64] http://mirrors.aliyun.com/docker-ce/linux/ubuntu $(lsb_release -cs) stable&quot;</div><div class="line"># Step 4: 更新并安装 Docker-CE</div><div class="line">sudo apt-get -y update</div><div class="line">sudo apt-get -y install docker-ce</div><div class="line"></div><div class="line"># 安装指定版本的Docker-CE:</div><div class="line"># Step 1: 查找Docker-CE的版本:</div><div class="line"># apt-cache madison docker-ce</div><div class="line">#   docker-ce | 17.03.1~ce-0~ubuntu-xenial | http://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</div><div class="line">#   docker-ce | 17.03.0~ce-0~ubuntu-xenial | http://mirrors.aliyun.com/docker-ce/linux/ubuntu xenial/stable amd64 Packages</div><div class="line"># Step 2: 安装指定版本的Docker-CE: (VERSION 例如上面的 17.03.1~ce-0~ubuntu-xenial)</div><div class="line"># sudo apt-get -y install docker-ce=[VERSION]</div></pre></td></tr></table></figure></p>
<p>centos7<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"># step 1: 安装必要的一些系统工具</div><div class="line">sudo yum install -y yum-utils device-mapper-persistent-data lvm2</div><div class="line"># Step 2: 添加软件源信息</div><div class="line">sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</div><div class="line"># Step 3: 更新并安装 Docker-CE</div><div class="line">sudo yum makecache fast</div><div class="line">sudo yum -y install docker-ce</div><div class="line"># Step 4: 开启Docker服务</div><div class="line">sudo service docker start</div><div class="line"></div><div class="line"># 注意：</div><div class="line"># 官方软件源默认启用了最新的软件，您可以通过编辑软件源的方式获取各个版本的软件包。例如官方并没有将测试版本的软件源置为可用，你可以通过以下方式开启。同理可以开启各种测试版本等。</div><div class="line"># vim /etc/yum.repos.d/docker-ee.repo</div><div class="line">#   将 [docker-ce-test] 下方的 enabled=0 修改为 enabled=1</div><div class="line">#</div><div class="line"># 安装指定版本的Docker-CE:</div><div class="line"># Step 1: 查找Docker-CE的版本:</div><div class="line"># yum list docker-ce.x86_64 --showduplicates | sort -r</div><div class="line">#   Loading mirror speeds from cached hostfile</div><div class="line">#   Loaded plugins: branch, fastestmirror, langpacks</div><div class="line">#   docker-ce.x86_64            17.03.1.ce-1.el7.centos            docker-ce-stable</div><div class="line">#   docker-ce.x86_64            17.03.1.ce-1.el7.centos            @docker-ce-stable</div><div class="line">#   docker-ce.x86_64            17.03.0.ce-1.el7.centos            docker-ce-stable</div><div class="line">#   Available Packages</div><div class="line"># Step2 : 安装指定版本的Docker-CE: (VERSION 例如上面的 17.03.0.ce.1-1.el7.centos)</div><div class="line"># sudo yum -y install docker-ce-[VERSION]</div></pre></td></tr></table></figure></p>
<p><a href="https://yq.aliyun.com/articles/110806" target="_blank" rel="external">https://yq.aliyun.com/articles/110806</a></p>
<p>配置文件 /etc/docker/daemon.json<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;graph&quot;: &quot;/server/dspace&quot;,</div><div class="line">  &quot;insecure-registries&quot;: [&quot;10.1.5.129&quot;],</div><div class="line">  &quot;registry-mirrors&quot;: [&quot;https://docker.mirrors.ustc.edu.cn&quot;,&quot;http://3a35aff6.m.daocloud.io&quot;,&quot;http://ethanzhu.m.tenxcloud.net&quot;],</div><div class="line">  &quot;hosts&quot;: [&quot;tcp://0.0.0.0:4243&quot;,&quot;unix:///var/run/docker.sock&quot;]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;registry-mirrors&quot;: [&quot;https://docker.mirrors.ustc.edu.cn&quot;,&quot;http://3a35aff6.m.daocloud.io&quot;,&quot;http://ethanzhu.m.tenxcloud.net&quot;],</div><div class="line">  &quot;metrics-addr&quot; : &quot;10.2.19.112:9323&quot;,</div><div class="line">  &quot;experimental&quot; : true,</div><div class="line">  &quot;dns&quot;: [&quot;10.2.19.112&quot;],</div><div class="line">  &quot;dns-search&quot;: [&quot;will.com&quot;]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="mesos-marathon"><a href="#mesos-marathon" class="headerlink" title="mesos + marathon"></a>mesos + marathon</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">rpm -Uvh http://repos.mesosphere.io/el/7/noarch/RPMS/mesosphere-el-repo-7-1.noarch.rpm</div><div class="line">yum -y install mesos marathon mesosphere-zookeeper</div></pre></td></tr></table></figure>
<p>master环境脚本</p>
<p>mesos_master_start.sh<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">export</span> MESOS_cluster=will</div><div class="line"><span class="comment">#export MESOS_zk=zk://10.1.5.65:2181/wesos</span></div><div class="line"><span class="built_in">export</span> MESOS_zk=zk://datanode01.will.com:2181,datanode02.will.com:2181,datanode04.will.com:2181,servicenode05.will.com:2181,servicenode06.will.com:2181/wesos</div><div class="line"><span class="built_in">export</span> MESOS_work_dir=/var/lib/mesos/master</div><div class="line"><span class="built_in">export</span> MESOS_quorum=1</div><div class="line"><span class="built_in">export</span> MESOS_log_dir=/server/mesos_log</div><div class="line"><span class="built_in">export</span> MESOS_zk_session_timeout=20secs</div><div class="line"><span class="built_in">export</span> MESOS_logging_level=WARNING</div><div class="line"><span class="comment">#export MESOS_log_dir=/var/log/mesos_master</span></div><div class="line"><span class="built_in">export</span> MESOS_hostname=10.2.19.124</div></pre></td></tr></table></figure></p>
<p>启动脚本：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">. /server/mesos_master_start.sh &amp;&amp; nohup /usr/sbin/mesos-master &amp;&gt; mesos_master.out&amp;</div></pre></td></tr></table></figure></p>
<p>mesos_agent_env.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">export MESOS_executor_registration_timeout=5mins</div><div class="line">export MESOS_containerizers=docker,mesos</div><div class="line">export MESOS_isolation=cgroups/cpu,cgroups/mem</div><div class="line">export MESOS_work_dir=/server/mesos/agent</div><div class="line">export MESOS_master=zk://datanode01.will.com:2181,datanode02.will.com:2181,datanode04.will.com:2181/wesos_online</div><div class="line">export MESOS_resources=&apos;ports:[10000-60000]&apos;</div></pre></td></tr></table></figure></p>
<p>启动脚本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">. /server/mesos_agent_env.sh &amp;&amp; nohup mesos-agent &amp;&gt; mesos_agent.out&amp;</div></pre></td></tr></table></figure></p>
<p>marathon<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">nohup marathon  --master zk://datanode01.will.com:2181,datanode02.will.com:2181,datanode04.will.com:2181/wesos_online  --zk zk://datanode01.will.com:2181,datanode02.will.com:2181,datanode04.will.com:2181/mt_online  --zk_timeout 15000 &amp;&gt; marathon.out&amp;</div></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[基础设施代码化]]></title>
      <url>/2017/09/29/%E5%9F%BA%E7%A1%80%E8%AE%BE%E6%96%BD%E4%BB%A3%E7%A0%81%E5%8C%96/</url>
      <content type="html"><![CDATA[<h2 id="实践"><a href="#实践" class="headerlink" title="实践"></a>实践</h2><h4 id="使用定义文件。"><a href="#使用定义文件。" class="headerlink" title="使用定义文件。"></a>使用定义文件。</h4><p>所有的配置都放在可执行的脚本里，shell, anisible playbook, chef recipe, puppet manifest等。不用出现任何人为参与，就可以实施实时调整。</p>
<h4 id="自描述系统和进程"><a href="#自描述系统和进程" class="headerlink" title="自描述系统和进程"></a>自描述系统和进程</h4><p>相对于人们按照文档描述进行执行，代码更能精确地执行。甚至可以通过根据代码自动生成文档。</p>
<h4 id="所有东西都版本化"><a href="#所有东西都版本化" class="headerlink" title="所有东西都版本化"></a>所有东西都版本化</h4><p>使用版本控制工具将所有的变化都储存起来，方便重现问题与排错。</p>
<h4 id="持续的测试系统"><a href="#持续的测试系统" class="headerlink" title="持续的测试系统"></a>持续的测试系统</h4><p>测试让我们能快速找到基础设置配置中存在的问题。可以设置一个发布流程，在continuousDelivery【持续交付】时进行测试。</p>
<h4 id="敏感于小的变化"><a href="#敏感于小的变化" class="headerlink" title="敏感于小的变化"></a>敏感于小的变化</h4><p>变化越大，潜在问题可能性越大。</p>
<h4 id="持续保持服务可用"><a href="#持续保持服务可用" class="headerlink" title="持续保持服务可用"></a>持续保持服务可用</h4><p>对于更新部署，服务不能宕机。使用蓝绿部署和parallelchange来解决这个问题</p>
<h2 id="好处"><a href="#好处" class="headerlink" title="好处"></a>好处</h2><p>以上这些约束能过够让我们快速启动新的server，并且在更新配置等情况下安全的处理在线的server。创建新的server对我们来说只是运行一下脚本而已。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[自制python的安装包]]></title>
      <url>/2017/09/28/%E8%87%AA%E5%88%B6python%E7%9A%84%E5%AE%89%E8%A3%85%E5%8C%85/</url>
      <content type="html"><![CDATA[<h2 id="起步"><a href="#起步" class="headerlink" title="起步"></a>起步</h2><h4 id="名字"><a href="#名字" class="headerlink" title="名字"></a>名字</h4><ul>
<li>小写</li>
<li>pypi中没有重复的</li>
</ul>
<h4 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">funniest/</div><div class="line">    funniest/</div><div class="line">        __init__.py</div><div class="line">    setup.py</div></pre></td></tr></table></figure>
<p>在<strong>init</strong>.py中添加<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">joke</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> (<span class="string">u'Wenn ist das Nunst\u00fcck git und Slotermeyer? Ja! ... '</span></div><div class="line">            <span class="string">u'Beiherhund das Oder die Flipperwaldt gersput.'</span>)</div></pre></td></tr></table></figure></p>
<p>setup.py里应该包含一个方法setuptools.setup():<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">from setuptools import setup</div><div class="line"></div><div class="line">setup(name=&apos;funniest&apos;,</div><div class="line">      version=&apos;0.1&apos;,</div><div class="line">      description=&apos;The funniest joke in the world&apos;,</div><div class="line">      url=&apos;http://github.com/storborg/funniest&apos;,</div><div class="line">      author=&apos;Flying Circus&apos;,</div><div class="line">      author_email=&apos;flyingcircus@example.com&apos;,</div><div class="line">      license=&apos;MIT&apos;,</div><div class="line">      packages=[&apos;funniest&apos;],</div><div class="line">      zip_safe=False)</div></pre></td></tr></table></figure></p>
<p>然后就可以本地安装一下了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install .</div></pre></td></tr></table></figure></p>
<p>用下面命令的话，可以让这个module的使用者实时更新变化<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">root@will-vm:~/gitLearning/funiest# pip install -e .</div><div class="line">Obtaining file:///root/gitLearning/funiest</div><div class="line">Installing collected packages: funiest</div><div class="line">  Running setup.py develop for funiest</div><div class="line">Successfully installed funiest</div></pre></td></tr></table></figure></p>
<p>引用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt;&gt;&gt; import funiest</div><div class="line">&gt;&gt;&gt; print funiest.joke()</div><div class="line">Wenn ist das Nunstück git und Slotermeyer? Ja! ... Beiherhund das Oder die Flipperwaldt gersput.</div></pre></td></tr></table></figure></p>
<h4 id="发布到pypi"><a href="#发布到pypi" class="headerlink" title="发布到pypi"></a>发布到pypi</h4><p>setup.py同样也是我们在PYPI上注册包名，并上传源码的入口。</p>
<h5 id="打包："><a href="#打包：" class="headerlink" title="打包："></a>打包：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">root@will-vm:~/gitLearning/funiest# python setup.py sdist</div><div class="line">running sdist</div><div class="line">running egg_info</div><div class="line">writing funiest.egg-info/PKG-INFO</div><div class="line">writing top-level names to funiest.egg-info/top_level.txt</div><div class="line">writing dependency_links to funiest.egg-info/dependency_links.txt</div><div class="line">reading manifest file &apos;funiest.egg-info/SOURCES.txt&apos;</div><div class="line">writing manifest file &apos;funiest.egg-info/SOURCES.txt&apos;</div><div class="line">warning: sdist: standard file not found: should have one of README, README.rst, README.txt</div><div class="line"></div><div class="line">running check</div><div class="line">creating funiest-0.1</div><div class="line">creating funiest-0.1/funiest</div><div class="line">creating funiest-0.1/funiest.egg-info</div><div class="line">making hard links in funiest-0.1...</div><div class="line">hard linking setup.py -&gt; funiest-0.1</div><div class="line">hard linking funiest/__init__.py -&gt; funiest-0.1/funiest</div><div class="line">hard linking funiest.egg-info/PKG-INFO -&gt; funiest-0.1/funiest.egg-info</div><div class="line">hard linking funiest.egg-info/SOURCES.txt -&gt; funiest-0.1/funiest.egg-info</div><div class="line">hard linking funiest.egg-info/dependency_links.txt -&gt; funiest-0.1/funiest.egg-info</div><div class="line">hard linking funiest.egg-info/not-zip-safe -&gt; funiest-0.1/funiest.egg-info</div><div class="line">hard linking funiest.egg-info/top_level.txt -&gt; funiest-0.1/funiest.egg-info</div><div class="line">Writing funiest-0.1/setup.cfg</div><div class="line">creating dist</div><div class="line">Creating tar archive</div><div class="line">removing &apos;funiest-0.1&apos; (and everything under it)</div><div class="line">root@will-vm:~/gitLearning/funiest# ll dist/</div><div class="line">总用量 12</div><div class="line">drwxr-xr-x 2 root root 4096 9月  28 14:35 ./</div><div class="line">drwxr-xr-x 5 root root 4096 9月  28 14:35 ../</div><div class="line">-rw-r--r-- 1 root root  912 9月  28 14:35 funiest-0.1.tar.gz</div></pre></td></tr></table></figure>
<p>这个包并没有经过build，在使用pip安装的时候需要再执行个build的步骤，尽管是纯python的也要有这个步骤。</p>
<h5 id="wheels"><a href="#wheels" class="headerlink" title="wheels"></a>wheels</h5><p>wheel是一个已经build过的包，安装的时候不用走build步骤了，相对终端用户安装过程会快一些。</p>
<ul>
<li>如果我们的项目是纯python(不包含编译的扩展)，本身就支持python2和python3，那么就叫做universal wheel</li>
<li>如果是纯python，但是不是原生支持python2和3，就叫做pure python wheel</li>
<li>如果包含便宜扩展，就叫 platform wheel</li>
</ul>
<p>在把我们的project构建wheel之前，先安装wheel<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install wheel</div></pre></td></tr></table></figure></p>
<h6 id="universal-wheel"><a href="#universal-wheel" class="headerlink" title="universal wheel"></a>universal wheel</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python setup.py bdist_wheel --universal</div></pre></td></tr></table></figure>
<p>可以在setup.cfg中指定参数<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[bdist_wheel]</div><div class="line">universal=1</div></pre></td></tr></table></figure></p>
<p>只有在你的project对于python2和python3都支持，而且不包含c扩展的时候才能用universal。</p>
<h6 id="pure-python-wheel"><a href="#pure-python-wheel" class="headerlink" title="pure python wheel"></a>pure python wheel</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python setup.py bdist_wheel</div></pre></td></tr></table></figure>
<p>bdist_wheel会检测是不是纯python，会生成一个与当前python版本兼容的结果。要是想支持多个版本，就需要在2、3的版本python环境下分别构建。</p>
<h6 id="platform-wheel"><a href="#platform-wheel" class="headerlink" title="platform wheel"></a>platform wheel</h6><p>用来指定运行平台：linux, windows等，通常都带着C扩展<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">python setup.py bdist_wheel</div></pre></td></tr></table></figure></p>
<h5 id="上传到PYPI"><a href="#上传到PYPI" class="headerlink" title="上传到PYPI"></a>上传到PYPI</h5><p>因为我还没有过pypi的用户，所以要根据提示先注册账户。</p>
<p>可以把注册信息加入~/.pypirc中：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[pypi]</div><div class="line">username = &lt;username&gt;</div><div class="line">password = &lt;password&gt;</div></pre></td></tr></table></figure></p>
<p>上传：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install twine</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">root@will-vm:~/gitLearning/funiest# twine upload dist/*</div><div class="line">Uploading distributions to https://upload.pypi.org/legacy/</div><div class="line">Enter your username: willcup</div><div class="line">Enter your password: </div><div class="line">Uploading funiest-0.1-py2.py3-none-any.whl</div><div class="line">Uploading funiest-0.1.tar.gz</div></pre></td></tr></table></figure>
<p>然后就可以看到了 <a href="https://pypi.python.org/pypi/funiest/0.1" target="_blank" rel="external">https://pypi.python.org/pypi/funiest/0.1</a></p>
<p>至此，已经可以到别的机器上下载并使用了</p>
<p>参考：</p>
<ul>
<li><p><a href="https://packaging.python.org/tutorials/distributing-packages/#setup-py" target="_blank" rel="external">https://packaging.python.org/tutorials/distributing-packages/#setup-py</a></p>
</li>
<li><p><a href="https://github.com/pypa/sampleproject/blob/master/setup.py" target="_blank" rel="external">https://github.com/pypa/sampleproject/blob/master/setup.py</a></p>
</li>
<li><p><a href="https://python-packaging.readthedocs.io/en/latest/" target="_blank" rel="external">https://python-packaging.readthedocs.io/en/latest/</a></p>
</li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[prometheus：理解告警的几个延迟点]]></title>
      <url>/2017/09/22/prometheus%EF%BC%9A%E7%90%86%E8%A7%A3%E5%91%8A%E8%AD%A6%E7%9A%84%E5%87%A0%E4%B8%AA%E5%BB%B6%E8%BF%9F%E7%82%B9/</url>
      <content type="html"><![CDATA[<h2 id="抓取、计算、与告警"><a href="#抓取、计算、与告警" class="headerlink" title="抓取、计算、与告警"></a>抓取、计算、与告警</h2><p>prometheus会在指定配置周期内进行metric的抓取，这个周期参数是<code>scrape_interval</code>，默认是1分钟。可以全局定义一个，然后每个job再自定义覆盖。每次爬取到数据之后，prometheus会计算告警规则里的表达式，并根据结果修改告警状态。</p>
<p>一个告警会有以下状态：</p>
<ul>
<li>inactive</li>
<li>pending. 已经检验失败，但是还没有到告警规则中for指定的持续时间。</li>
<li>firing. 已经检验失败，而且已经超过了告警规则中for指定的持续时间。</li>
</ul>
<p>告警状态之间的变化只会发生在计算阶段，主要是取决于表达式和FOR语法定义内容</p>
<p>for是一个可选的定义。</p>
<ul>
<li>没有定义for的告警会立即触发</li>
<li>定义了for的会先到pending，时间超过后再转化到firing。所以会有至少两个计算阶段。</li>
</ul>
<h2 id="告警周期"><a href="#告警周期" class="headerlink" title="告警周期"></a>告警周期</h2><p>来个例子</p>
<p>告警规则：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ALERT NODE_LOAD_1M</div><div class="line">  IF node_load1 &gt; 20</div><div class="line">  FOR 1m</div></pre></td></tr></table></figure></p>
<p>相关配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">global:</div><div class="line">  scrape_interval: 20s</div><div class="line">  evaluation_interval: 1m</div></pre></td></tr></table></figure></p>
<p><strong>问题来了</strong>：发送这个告警到底会花费多少时间？</p>
<p><strong>答案</strong>：介于1m和20s+1m+1m之间。</p>
<p>下图是事件发生的时序图：<br><img src="https://pracucci.com/assets/2016-11-16-prometheus-alert-lifecycle-612f4a8f0171d3e56c2cc2ed4bcfb90232bfbdd2d1273d11d97f52a0e3cd121d.png" alt=""></p>
<h2 id="alertmanager"><a href="#alertmanager" class="headerlink" title="alertmanager"></a>alertmanager</h2><p>alertManager是整个流程的最后一个环节，它会接收inactive和firing的信号。它可以将相似的告警进行分组，以一个通告发出去。这种小组发送的支持可以避免大量重复信息频繁发送的问题。但是小组发送的缺点也比较明显，就是可能会有更大的延迟。</p>
<p>下面是相关设置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">group_by: [ &apos;a-label&apos;, &apos;another-label&apos; ]</div><div class="line">group_wait: 30s</div><div class="line">group_interval: 5m</div></pre></td></tr></table></figure></p>
<p>在新的告警已经被fire后，它会等待group_wait时间到了才会发送。</p>
<p>但是如果第一批还没发送完的时候，第二批又来了咋整？第二批就不看group_wait了，而是看group_interval。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[JMX-与docker的问题]]></title>
      <url>/2017/09/22/JMX-%E4%B8%8Edocker%E7%9A%84%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<p>docker容器依赖于外部某些服务，运行一段时间后网络不通</p>
<p>我的所有的采样jmx数据的容器全都是这样，开始的时候好好的，一段时间后就连不上目标主机了。然后重启又恢复正常</p>
<p>下面是使用prometheus/jmx_exporter自己制作docker镜像后产生的问题。<br>报错异常如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">SEVERE: JMX scrape failed: java.io.IOException: Failed to retrieve RMIServer stub: javax.naming.ServiceUnavailableException [Root exception is java.rmi.ConnectException: Connection refused to host: 10.2.19.64; nested exception is: </div><div class="line">	java.net.ConnectException: Connection refused (Connection refused)]</div><div class="line">	at javax.management.remote.rmi.RMIConnector.connect(RMIConnector.java:369)</div><div class="line">	at javax.management.remote.JMXConnectorFactory.connect(JMXConnectorFactory.java:270)</div><div class="line">	at io.prometheus.jmx.JmxScraper.doScrape(JmxScraper.java:106)</div><div class="line">	at io.prometheus.jmx.JmxCollector.collect(JmxCollector.java:436)</div><div class="line">	at io.prometheus.client.CollectorRegistry$MetricFamilySamplesEnumeration.findNextElement(CollectorRegistry.java:180)</div><div class="line">	at io.prometheus.client.CollectorRegistry$MetricFamilySamplesEnumeration.nextElement(CollectorRegistry.java:213)</div><div class="line">	at io.prometheus.client.CollectorRegistry$MetricFamilySamplesEnumeration.nextElement(CollectorRegistry.java:134)</div><div class="line">	at io.prometheus.client.exporter.common.TextFormat.write004(TextFormat.java:22)</div><div class="line">	at io.prometheus.client.exporter.HTTPServer$HTTPMetricHandler.handle(HTTPServer.java:43)</div><div class="line">	at com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:79)</div><div class="line">	at sun.net.httpserver.AuthFilter.doFilter(AuthFilter.java:83)</div><div class="line">	at com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:82)</div><div class="line">	at sun.net.httpserver.ServerImpl$Exchange$LinkHandler.handle(ServerImpl.java:675)</div><div class="line">	at com.sun.net.httpserver.Filter$Chain.doFilter(Filter.java:79)</div><div class="line">	at sun.net.httpserver.ServerImpl$Exchange.run(ServerImpl.java:647)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div><div class="line">Caused by: javax.naming.ServiceUnavailableException [Root exception is java.rmi.ConnectException: Connection refused to host: 10.2.19.64; nested exception is: </div><div class="line">	java.net.ConnectException: Connection refused (Connection refused)]</div><div class="line">	at com.sun.jndi.rmi.registry.RegistryContext.lookup(RegistryContext.java:122)</div><div class="line">	at com.sun.jndi.toolkit.url.GenericURLContext.lookup(GenericURLContext.java:205)</div><div class="line">	at javax.naming.InitialContext.lookup(InitialContext.java:417)</div><div class="line">	at javax.management.remote.rmi.RMIConnector.findRMIServerJNDI(RMIConnector.java:1955)</div><div class="line">	at javax.management.remote.rmi.RMIConnector.findRMIServer(RMIConnector.java:1922)</div><div class="line">	at javax.management.remote.rmi.RMIConnector.connect(RMIConnector.java:287)</div><div class="line">	... 17 more</div><div class="line">Caused by: java.rmi.ConnectException: Connection refused to host: 10.2.19.64; nested exception is: </div><div class="line">	java.net.ConnectException: Connection refused (Connection refused)</div><div class="line">	at sun.rmi.transport.tcp.TCPEndpoint.newSocket(TCPEndpoint.java:619)</div><div class="line">	at sun.rmi.transport.tcp.TCPChannel.createConnection(TCPChannel.java:216)</div><div class="line">	at sun.rmi.transport.tcp.TCPChannel.newConnection(TCPChannel.java:202)</div><div class="line">	at sun.rmi.server.UnicastRef.newCall(UnicastRef.java:342)</div><div class="line">	at sun.rmi.registry.RegistryImpl_Stub.lookup(Unknown Source)</div><div class="line">	at com.sun.jndi.rmi.registry.RegistryContext.lookup(RegistryContext.java:118)</div><div class="line">	... 22 more</div><div class="line">Caused by: java.net.ConnectException: Connection refused (Connection refused)</div><div class="line">	at java.net.PlainSocketImpl.socketConnect(Native Method)</div><div class="line">	at java.net.AbstractPlainSocketImpl.doConnect(AbstractPlainSocketImpl.java:350)</div><div class="line">	at java.net.AbstractPlainSocketImpl.connectToAddress(AbstractPlainSocketImpl.java:206)</div><div class="line">	at java.net.AbstractPlainSocketImpl.connect(AbstractPlainSocketImpl.java:188)</div><div class="line">	at java.net.SocksSocketImpl.connect(SocksSocketImpl.java:392)</div><div class="line">	at java.net.Socket.connect(Socket.java:589)</div><div class="line">	at java.net.Socket.connect(Socket.java:538)</div><div class="line">	at java.net.Socket.&lt;init&gt;(Socket.java:434)</div><div class="line">	at java.net.Socket.&lt;init&gt;(Socket.java:211)</div><div class="line">	at sun.rmi.transport.proxy.RMIDirectSocketFactory.createSocket(RMIDirectSocketFactory.java:40)</div><div class="line">	at sun.rmi.transport.proxy.RMIMasterSocketFactory.createSocket(RMIMasterSocketFactory.java:148)</div><div class="line">	at sun.rmi.transport.tcp.TCPEndpoint.newSocket(TCPEndpoint.java:613)</div><div class="line">	... 27 more</div></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[django的单元测试]]></title>
      <url>/2017/09/18/django%E7%9A%84%E5%8D%95%E5%85%83%E6%B5%8B%E8%AF%95/</url>
      <content type="html"><![CDATA[<h2 id="编写测试"><a href="#编写测试" class="headerlink" title="编写测试"></a>编写测试</h2><p>使用了unittest<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">from django.test import TestCase</div><div class="line">from myapp.models import Animal</div><div class="line"></div><div class="line">class AnimalTestCase(TestCase):</div><div class="line">    def setUp(self):</div><div class="line">        Animal.objects.create(name=&quot;lion&quot;, sound=&quot;roar&quot;)</div><div class="line">        Animal.objects.create(name=&quot;cat&quot;, sound=&quot;meow&quot;)</div><div class="line"></div><div class="line">    def test_animals_can_speak(self):</div><div class="line">        &quot;&quot;&quot;Animals that can speak are correctly identified&quot;&quot;&quot;</div><div class="line">        lion = Animal.objects.get(name=&quot;lion&quot;)</div><div class="line">        cat = Animal.objects.get(name=&quot;cat&quot;)</div><div class="line">        self.assertEqual(lion.speak(), &apos;The lion says &quot;roar&quot;&apos;)</div><div class="line">        self.assertEqual(cat.speak(), &apos;The cat says &quot;meow&quot;&apos;)</div></pre></td></tr></table></figure></p>
<h2 id="运行测试"><a href="#运行测试" class="headerlink" title="运行测试"></a>运行测试</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"># Run all the tests in the animals.tests module</div><div class="line">$ ./manage.py test animals.tests</div><div class="line"></div><div class="line"># Run all the tests found within the &apos;animals&apos; package</div><div class="line">$ ./manage.py test animals</div><div class="line"></div><div class="line"># Run just one test case</div><div class="line">$ ./manage.py test animals.tests.AnimalTestCase</div><div class="line"></div><div class="line"># Run just one test method</div><div class="line">$ ./manage.py test animals.tests.AnimalTestCase.test_animals_can_speak</div><div class="line"></div><div class="line">$ ./manage.py test animals/</div><div class="line"></div><div class="line">$ ./manage.py test --pattern=&quot;tests_*.py&quot;</div></pre></td></tr></table></figure>
<h2 id="测试数据库"><a href="#测试数据库" class="headerlink" title="测试数据库"></a>测试数据库</h2><p>通过settings文件中的DATABASES里的TEST字段指定测试数据库的名称。要求对应的用户有创建测试数据库的权限。</p>
<h2 id="执行顺序"><a href="#执行顺序" class="headerlink" title="执行顺序"></a>执行顺序</h2><p>为确保所有的TestCase代码都运行在一个clean的database之上，django的测试运行顺序如下：</p>
<ul>
<li>所有的django.test.TestCase子类</li>
<li>所有SimpleTestCase的子类，包括TransactionTestCase。他们的运行顺序不能保证</li>
<li>unittest.TestCase的子类，这些类可能会修改db，而且不能恢复db的原始状态</li>
</ul>
<p>你可以通过test –reverse选项，反转执行顺序。这样可以确保所有的TestCase之间都是无依赖的。</p>
<h2 id="回滚"><a href="#回滚" class="headerlink" title="回滚"></a>回滚</h2><p>任何在migration里加载的初始数据都可以在TestCase中被使用，但是在TranactionTestCase里就不能使用，除非对于后台引擎支持事务才行，比如MyISAM引擎就不行。</p>
<p>django可以通过设置serialized_rollback 为true，为每个TestCase reload数据，但是注意这会让速度变慢。</p>
<p>第三方的app必须要设置这个，通常，我们都是用事务性数据库，就没有必要使用了。</p>
<p>初始序列化工作其实挺快的，但是如果有些APP并不需要序列化的话，可以通过TEST_NON_SERIALIZED_APPS进行配置。</p>
<h2 id="加速测试"><a href="#加速测试" class="headerlink" title="加速测试"></a>加速测试</h2><ul>
<li>使用并行测试 test –parallel 3</li>
<li>密码hash。默认密码hasher比较慢，可以指定自己的。</li>
<li>test –keepdb，测试完成后不删除测试数据库。跳过创建于删除动作</li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[cloudnative]]></title>
      <url>/2017/09/15/cloudnative/</url>
      <content type="html"><![CDATA[<table>
<thead>
<tr>
<th>sdf</th>
<th>特点</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>pet</td>
<td>1.物理机</td>
<td>dsf</td>
</tr>
<tr>
<td>cattle</td>
<td></td>
</tr>
</tbody>
</table>
<p>pet</p>
<hr>
<ul>
<li>物理机 或 虚拟机</li>
<li>OS + app + data</li>
<li>stateful : LB后的server对state有粘性sticky【1对1】</li>
<li>server对OS环境的依赖性极大，迁移扩展困难</li>
<li></li>
</ul>
<h2 id="cattle"><a href="#cattle" class="headerlink" title="cattle"></a>cattle</h2><ul>
<li>虚拟技术(container) + manifest【记录环境部署的一切】，迁移或扩展方便</li>
<li>state存储于第三方，对于所有app共享【数据、server启动的配置信息、manifest信息】</li>
<li>puppet等devops工具栈</li>
<li>app与OS解耦？</li>
<li>聚焦于app + data，不关心OS等环境</li>
</ul>
<p>参考： <a href="https://www.youtube.com/watch?v=zWgq6sd1Ols" target="_blank" rel="external">https://www.youtube.com/watch?v=zWgq6sd1Ols</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[mesos-+-marathon快速启动]]></title>
      <url>/2017/09/14/mesos-+-marathon%E5%BF%AB%E9%80%9F%E5%90%AF%E5%8A%A8/</url>
      <content type="html"><![CDATA[<h2 id="master"><a href="#master" class="headerlink" title="master"></a>master</h2><p>mesos_master_start.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">export MESOS_cluster=will</div><div class="line">export MESOS_zk=zk://10.1.5.65:2181/wesos</div><div class="line">export MESOS_work_dir=/var/lib/mesos/master</div><div class="line">export MESOS_quorum=1</div><div class="line">export MESOS_log_dir=/server/mesos_log</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">. mesos_master_start.sh &amp;&amp; mesos-master</div></pre></td></tr></table></figure>
<h2 id="agent"><a href="#agent" class="headerlink" title="agent"></a>agent</h2><p>通过zk与mesos master建立关系</p>
<p>mesos_agent_env.sh<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">export MESOS_executor_registration_timeout=5mins</div><div class="line">export MESOS_containerizers=docker,mesos</div><div class="line">export MESOS_isolation=cgroups/cpu,cgroups/mem</div><div class="line">export MESOS_work_dir=/var/lib/mesos/agent</div><div class="line">export MESOS_master=zk://10.1.5.65:2181/wesos</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">. mesos_agent_env.sh &amp;&amp; mesos-agent --resources=&apos;ports:[10000-60000]&apos;</div></pre></td></tr></table></figure>
<h2 id="marathon"><a href="#marathon" class="headerlink" title="marathon"></a>marathon</h2><p>通过zk与mesos master建立关系<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">marathon --master zk://10.1.5.65:2181/wesos --zk zk://10.1.5.65:2181/mt</div></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[marathon坑记---restart失败]]></title>
      <url>/2017/09/08/marathon%E5%9D%91%E8%AE%B0---restart%E5%A4%B1%E8%B4%A5/</url>
      <content type="html"><![CDATA[<p>接上一篇的场景。</p>
<p>我们通过marathon的REST API修改某个app的json配置，然后会触发restart操作。</p>
<p>因为json里指定了host的port，所以会导致mesos agent的31111端口被占用，然后新的app就起不来，然后就一直处于waiting状态了。</p>
<p>这个被占用的信息可以从mesos master的/state接口里used_resources看到。</p>
<p>尝试把hostPort解放开，重新设置成0…..果然就成功了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;id&quot;: &quot;basic-3&quot;,</div><div class="line">  &quot;cmd&quot;: &quot;python3 -m http.server 8080&quot;,</div><div class="line">  &quot;cpus&quot;: 0.5,</div><div class="line">  &quot;mem&quot;: 32.0,</div><div class="line">  &quot;container&quot;: &#123;</div><div class="line">    &quot;type&quot;: &quot;DOCKER&quot;,</div><div class="line">    &quot;docker&quot;: &#123;</div><div class="line">      &quot;image&quot;: &quot;python:3&quot;,</div><div class="line">      &quot;network&quot;: &quot;BRIDGE&quot;,</div><div class="line">      &quot;portMappings&quot;: [</div><div class="line">        &#123; &quot;containerPort&quot;: 8080, &quot;hostPort&quot;: 0 &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样的话，对于服务的使用有以下几个方案</p>
<ul>
<li>HAProxy。需要在HAProxy注册每个service的端口就行了。hostPort不用开，都通过HAProxy去访问。</li>
<li>继续单个服务指定端口。需要每次都先将app缩容到0，再扩容回来。</li>
<li>使用smartstack或者consul等服务发现工具，对HAProxy进行动态修改。</li>
</ul>
<p>我们的应用是监控平台，每个监控app只需要有一个实例，而且并不要求每个实例有严格高可用。所以暂时使用上面最简单的方案2.</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Yelp开源的pass平台工具]]></title>
      <url>/2017/09/08/Yelp%E5%BC%80%E6%BA%90%E7%9A%84pass%E5%B9%B3%E5%8F%B0%E5%B7%A5%E5%85%B7/</url>
      <content type="html"><![CDATA[<ol>
<li>git push到git仓库</li>
<li>jenkins pipeline - jenkins执行git pull </li>
<li>jenkins pipeline - jenkins执行单元测试</li>
<li>jenkins pipeline - 通过测试后添加git tag: passta-cluseter1.servicename-20160505T090305-deploy、passta-cluseter1.servicename-20160505T090305-start</li>
<li>jenkins pipeline - docker build &amp;&amp; 推送到仓库</li>
<li>jenkins pipeline - marathon拉取指定tag的commit id，开始运行service服务。</li>
<li>使用smartstack做服务发现工作</li>
<li>sensu进行监控工作</li>
</ol>
<ul>
<li><a href="https://github.com/Yelp/paasta" target="_blank" rel="external">https://github.com/Yelp/paasta</a></li>
<li><a href="https://www.youtube.com/watch?v=vISUXKeoqXM&amp;feature=youtu.be" target="_blank" rel="external">https://www.youtube.com/watch?v=vISUXKeoqXM&amp;feature=youtu.be</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[marathon---event-bus]]></title>
      <url>/2017/09/07/marathon---event-bus/</url>
      <content type="html"><![CDATA[<p>marathon有一个内部的event bus，处理所有的API请求和扩容event。通过订阅这个eventbus，我们可以实时了解发生的所有事件。event bus对于整合基于状态的实体很有用处，比如load balancer，或者compile statistics。</p>
<p>Evet可通过插件化的subscriber进行订阅。</p>
<p>event bus有两个API：</p>
<ul>
<li>event stream。详情见/v2/events/</li>
<li>回调endpoint，以json的方式把event发送到一个或多个endpoint中。这个方式已经过期了。</li>
</ul>
<p>event stream相对好处</p>
<ul>
<li>容易设置</li>
<li>传递较快。没有req/resp的处理</li>
<li>event是有序的</li>
</ul>
<h4 id="回调方式"><a href="#回调方式" class="headerlink" title="回调方式"></a>回调方式</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./bin/start --master ... --event_subscriber http_callback --http_endpoints http://host1/foo,http://host2/bar</div></pre></td></tr></table></figure>
<h4 id="event类型"><a href="#event类型" class="headerlink" title="event类型"></a>event类型</h4><h5 id="API请求"><a href="#API请求" class="headerlink" title="API请求"></a>API请求</h5><p>marathon接收到修改某个app的时候收到的API请求。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;eventType&quot;: &quot;api_post_event&quot;,</div><div class="line">  &quot;timestamp&quot;: &quot;2014-03-01T23:29:30.158Z&quot;,</div><div class="line">  &quot;clientIp&quot;: &quot;0:0:0:0:0:0:0:1&quot;,</div><div class="line">  &quot;uri&quot;: &quot;/v2/apps/my-app&quot;,</div><div class="line">  &quot;appDefinition&quot;: &#123;</div><div class="line">    &quot;args&quot;: [],</div><div class="line">    &quot;backoffFactor&quot;: 1.15,</div><div class="line">    &quot;backoffSeconds&quot;: 1,</div><div class="line">    &quot;cmd&quot;: &quot;sleep 30&quot;,</div><div class="line">    &quot;constraints&quot;: [],</div><div class="line">    &quot;container&quot;: null,</div><div class="line">    &quot;cpus&quot;: 0.2,</div><div class="line">    &quot;dependencies&quot;: [],</div><div class="line">    &quot;disk&quot;: 0.0,</div><div class="line">    &quot;env&quot;: &#123;&#125;,</div><div class="line">    &quot;executor&quot;: &quot;&quot;,</div><div class="line">    &quot;healthChecks&quot;: [],</div><div class="line">    &quot;id&quot;: &quot;/my-app&quot;,</div><div class="line">    &quot;instances&quot;: 2,</div><div class="line">    &quot;mem&quot;: 32.0,</div><div class="line">    &quot;ports&quot;: [10001],</div><div class="line">    &quot;requirePorts&quot;: false,</div><div class="line">    &quot;storeUrls&quot;: [],</div><div class="line">    &quot;upgradeStrategy&quot;: &#123;</div><div class="line">        &quot;minimumHealthCapacity&quot;: 1.0</div><div class="line">    &#125;,</div><div class="line">    &quot;uris&quot;: [],</div><div class="line">    &quot;user&quot;: null,</div><div class="line">    &quot;version&quot;: &quot;2014-09-09T05:57:50.866Z&quot;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="状态更新"><a href="#状态更新" class="headerlink" title="状态更新"></a>状态更新</h5><p>task的状态变更时发送的event:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;eventType&quot;: &quot;status_update_event&quot;,</div><div class="line">  &quot;timestamp&quot;: &quot;2014-03-01T23:29:30.158Z&quot;,</div><div class="line">  &quot;slaveId&quot;: &quot;20140909-054127-177048842-5050-1494-0&quot;,</div><div class="line">  &quot;taskId&quot;: &quot;my-app_0-1396592784349&quot;,</div><div class="line">  &quot;taskStatus&quot;: &quot;TASK_RUNNING&quot;,</div><div class="line">  &quot;appId&quot;: &quot;/my-app&quot;,</div><div class="line">  &quot;host&quot;: &quot;slave-1234.acme.org&quot;,</div><div class="line">  &quot;ports&quot;: [31372],</div><div class="line">  &quot;version&quot;: &quot;2014-04-04T06:26:23.051Z&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>所有的状态</p>
<ul>
<li>TASK_STAGING</li>
<li>TASK_STARTING</li>
<li>TASK_RUNNING</li>
<li>TASK_FINISHED</li>
<li>TASK_FAILED</li>
<li>TASK_KILLING</li>
<li>TASK_KILLED</li>
<li>TASK_LOST<br>后面四种是终止状态。</li>
</ul>
<h5 id="framework-message"><a href="#framework-message" class="headerlink" title="framework message"></a>framework message</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;eventType&quot;: &quot;framework_message_event&quot;,</div><div class="line">  &quot;timestamp&quot;: &quot;2014-03-01T23:29:30.158Z&quot;,</div><div class="line">  &quot;slaveId&quot;: &quot;20140909-054127-177048842-5050-1494-0&quot;,</div><div class="line">  &quot;executorId&quot;: &quot;my-app.3f80d17a-37e6-11e4-b05e-56847afe9799&quot;,</div><div class="line">  &quot;message&quot;: &quot;aGVsbG8gd29ybGQh&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="Event订阅"><a href="#Event订阅" class="headerlink" title="Event订阅"></a>Event订阅</h5><p>订阅者消息有变化时触发。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;eventType&quot;: &quot;subscribe_event&quot;,</div><div class="line">  &quot;timestamp&quot;: &quot;2014-03-01T23:29:30.158Z&quot;,</div><div class="line">  &quot;clientIp&quot;: &quot;1.2.3.4&quot;,</div><div class="line">  &quot;callbackUrl&quot;: &quot;http://subscriber.acme.org/callbacks&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;eventType&quot;: &quot;unsubscribe_event&quot;,</div><div class="line">  &quot;timestamp&quot;: &quot;2014-03-01T23:29:30.158Z&quot;,</div><div class="line">  &quot;clientIp&quot;: &quot;1.2.3.4&quot;,</div><div class="line">  &quot;callbackUrl&quot;: &quot;http://subscriber.acme.org/callbacks&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="Health-Check"><a href="#Health-Check" class="headerlink" title="Health Check"></a>Health Check</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;eventType&quot;: &quot;add_health_check_event&quot;,</div><div class="line">  &quot;timestamp&quot;: &quot;2014-03-01T23:29:30.158Z&quot;,</div><div class="line">  &quot;appId&quot;: &quot;/my-app&quot;,</div><div class="line">  &quot;healthCheck&quot;: &#123;</div><div class="line">    &quot;protocol&quot;: &quot;HTTP&quot;,</div><div class="line">    &quot;path&quot;: &quot;/health&quot;,</div><div class="line">    &quot;portIndex&quot;: 0,</div><div class="line">    &quot;gracePeriodSeconds&quot;: 5,</div><div class="line">    &quot;intervalSeconds&quot;: 10,</div><div class="line">    &quot;timeoutSeconds&quot;: 10,</div><div class="line">    &quot;maxConsecutiveFailures&quot;: 3</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;eventType&quot;: &quot;remove_health_check_event&quot;,</div><div class="line">  &quot;timestamp&quot;: &quot;2014-03-01T23:29:30.158Z&quot;,</div><div class="line">  &quot;appId&quot;: &quot;/my-app&quot;,</div><div class="line">  &quot;healthCheck&quot;: &#123;</div><div class="line">    &quot;protocol&quot;: &quot;HTTP&quot;,</div><div class="line">    &quot;path&quot;: &quot;/health&quot;,</div><div class="line">    &quot;portIndex&quot;: 0,</div><div class="line">    &quot;gracePeriodSeconds&quot;: 5,</div><div class="line">    &quot;intervalSeconds&quot;: 10,</div><div class="line">    &quot;timeoutSeconds&quot;: 10,</div><div class="line">    &quot;maxConsecutiveFailures&quot;: 3</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;eventType&quot;: &quot;failed_health_check_event&quot;,</div><div class="line">  &quot;timestamp&quot;: &quot;2014-03-01T23:29:30.158Z&quot;,</div><div class="line">  &quot;appId&quot;: &quot;/my-app&quot;,</div><div class="line">  &quot;taskId&quot;: &quot;my-app_0-1396592784349&quot;,</div><div class="line">  &quot;healthCheck&quot;: &#123;</div><div class="line">    &quot;protocol&quot;: &quot;HTTP&quot;,</div><div class="line">    &quot;path&quot;: &quot;/health&quot;,</div><div class="line">    &quot;portIndex&quot;: 0,</div><div class="line">    &quot;gracePeriodSeconds&quot;: 5,</div><div class="line">    &quot;intervalSeconds&quot;: 10,</div><div class="line">    &quot;timeoutSeconds&quot;: 10,</div><div class="line">    &quot;maxConsecutiveFailures&quot;: 3</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;eventType&quot;: &quot;health_status_changed_event&quot;,</div><div class="line">  &quot;timestamp&quot;: &quot;2014-03-01T23:29:30.158Z&quot;,</div><div class="line">  &quot;appId&quot;: &quot;/my-app&quot;,</div><div class="line">  &quot;instanceId&quot;: &quot;my-app.instance-c7c311a4-b669-11e6-a48f-0ea4f4b1778c&quot;,</div><div class="line">  &quot;version&quot;: &quot;2014-04-04T06:26:23.051Z&quot;,</div><div class="line">  &quot;alive&quot;: true</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;appId&quot;: &quot;/my-app&quot;,</div><div class="line">  &quot;taskId&quot;: &quot;my-app_0-1396592784349&quot;,</div><div class="line">  &quot;version&quot;: &quot;2016-03-16T13:05:00.590Z&quot;,</div><div class="line">  &quot;reason&quot;: &quot;500 Internal Server Error&quot;,</div><div class="line">  &quot;host&quot;: &quot;localhost&quot;,</div><div class="line">  &quot;slaveId&quot;: &quot;4fb620fa-ba8d-4eb0-8ae3-f2912aaf015c-S0&quot;,</div><div class="line">  &quot;eventType&quot;: &quot;unhealthy_task_kill_event&quot;,</div><div class="line">  &quot;timestamp&quot;: &quot;2016-03-21T09:15:10.764Z&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="deployment"><a href="#deployment" class="headerlink" title="deployment"></a>deployment</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;eventType&quot;: &quot;group_change_success&quot;,</div><div class="line">  &quot;timestamp&quot;: &quot;2014-03-01T23:29:30.158Z&quot;,</div><div class="line">  &quot;groupId&quot;: &quot;/product-a/backend&quot;,</div><div class="line">  &quot;version&quot;: &quot;2014-04-04T06:26:23.051Z&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;eventType&quot;: &quot;group_change_failed&quot;,</div><div class="line">  &quot;timestamp&quot;: &quot;2014-03-01T23:29:30.158Z&quot;,</div><div class="line">  &quot;groupId&quot;: &quot;/product-a/backend&quot;,</div><div class="line">  &quot;version&quot;: &quot;2014-04-04T06:26:23.051Z&quot;,</div><div class="line">  &quot;reason&quot;: &quot;&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;eventType&quot;: &quot;deployment_success&quot;,</div><div class="line">  &quot;timestamp&quot;: &quot;2014-03-01T23:29:30.158Z&quot;,</div><div class="line">  &quot;id&quot;: &quot;867ed450-f6a8-4d33-9b0e-e11c5513990b&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;eventType&quot;: &quot;deployment_failed&quot;,</div><div class="line">  &quot;timestamp&quot;: &quot;2014-03-01T23:29:30.158Z&quot;,</div><div class="line">  &quot;id&quot;: &quot;867ed450-f6a8-4d33-9b0e-e11c5513990b&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;eventType&quot;: &quot;deployment_info&quot;,</div><div class="line">  &quot;timestamp&quot;: &quot;2014-03-01T23:29:30.158Z&quot;,</div><div class="line">  &quot;plan&quot;: &#123;</div><div class="line">    &quot;id&quot;: &quot;867ed450-f6a8-4d33-9b0e-e11c5513990b&quot;,</div><div class="line">    &quot;original&quot;: &#123;</div><div class="line">      &quot;apps&quot;: [],</div><div class="line">      &quot;dependencies&quot;: [],</div><div class="line">      &quot;groups&quot;: [],</div><div class="line">      &quot;id&quot;: &quot;/&quot;,</div><div class="line">      &quot;version&quot;: &quot;2014-09-09T06:30:49.667Z&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;target&quot;: &#123;</div><div class="line">      &quot;apps&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;args&quot;: [],</div><div class="line">          &quot;backoffFactor&quot;: 1.15,</div><div class="line">          &quot;backoffSeconds&quot;: 1,</div><div class="line">          &quot;cmd&quot;: &quot;sleep 30&quot;,</div><div class="line">          &quot;constraints&quot;: [],</div><div class="line">          &quot;container&quot;: null,</div><div class="line">          &quot;cpus&quot;: 0.2,</div><div class="line">          &quot;dependencies&quot;: [],</div><div class="line">          &quot;disk&quot;: 0.0,</div><div class="line">          &quot;env&quot;: &#123;&#125;,</div><div class="line">          &quot;executor&quot;: &quot;&quot;,</div><div class="line">          &quot;healthChecks&quot;: [],</div><div class="line">          &quot;id&quot;: &quot;/my-app&quot;,</div><div class="line">          &quot;instances&quot;: 2,</div><div class="line">          &quot;mem&quot;: 32.0,</div><div class="line">          &quot;ports&quot;: [10001],</div><div class="line">          &quot;requirePorts&quot;: false,</div><div class="line">          &quot;storeUrls&quot;: [],</div><div class="line">          &quot;upgradeStrategy&quot;: &#123;</div><div class="line">              &quot;minimumHealthCapacity&quot;: 1.0</div><div class="line">          &#125;,</div><div class="line">          &quot;uris&quot;: [],</div><div class="line">          &quot;user&quot;: null,</div><div class="line">          &quot;version&quot;: &quot;2014-09-09T05:57:50.866Z&quot;</div><div class="line">        &#125;</div><div class="line">      ],</div><div class="line">      &quot;dependencies&quot;: [],</div><div class="line">      &quot;groups&quot;: [],</div><div class="line">      &quot;id&quot;: &quot;/&quot;,</div><div class="line">      &quot;version&quot;: &quot;2014-09-09T05:57:50.866Z&quot;</div><div class="line">    &#125;,</div><div class="line">    &quot;steps&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;action&quot;: &quot;ScaleApplication&quot;,</div><div class="line">        &quot;app&quot;: &quot;/my-app&quot;</div><div class="line">      &#125;</div><div class="line">    ],</div><div class="line">    &quot;version&quot;: &quot;2014-03-01T23:24:14.846Z&quot;</div><div class="line">  &#125;,</div><div class="line">  &quot;currentStep&quot;: &#123;</div><div class="line">    &quot;actions&quot;: [</div><div class="line">      &#123;</div><div class="line">        &quot;type&quot;: &quot;ScaleApplication&quot;,</div><div class="line">        &quot;app&quot;: &quot;/my-app&quot;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[marathon---constraints]]></title>
      <url>/2017/09/07/marathon---constraints/</url>
      <content type="html"><![CDATA[<p>constraint控制app运行的位置，可以用来调优容错以及本地部署。constraint包含3个部分：fieldname， operator， 可选参数。field可以是agent node 的hostname或者agent node的其他属性。</p>
<h2 id="Fields"><a href="#Fields" class="headerlink" title="Fields"></a>Fields</h2><h4 id="Hostname"><a href="#Hostname" class="headerlink" title="Hostname"></a>Hostname</h4><p>支持所有的marathon operator 。</p>
<h4 id="Attribute"><a href="#Attribute" class="headerlink" title="Attribute"></a>Attribute</h4><p>如果filed name不是hostname，就会被看作一个mesos agent node 的attribute。一个mesos agent attribute可以用来给agent node打tag。可以看一下mesos-slave –help.</p>
<p>如果制定的attribute还没有在agent node上定义，那么多数的operator都会拒绝在agent node上运行任务。目前是有UNLIKE operator会接受这个offer，其他的都会拒绝。</p>
<p>attribute field支持marathon所有的operator。</p>
<p>Marathon 支持text，scalar，range以及set类型的attribute的值。对于scalar、range、set类型的值，marathon会基于格式化的值执行一个字符串对比操作。对于range和set类型，格式分别是[begin-end,….]和{item,….}。例如: [100-200]和{a,b,c]</p>
<p>LIKE和UNLIKE的operator支持正则表达式。</p>
<h2 id="Operator"><a href="#Operator" class="headerlink" title="Operator"></a>Operator</h2><h4 id="UNIQUE-operator"><a href="#UNIQUE-operator" class="headerlink" title="UNIQUE operator"></a>UNIQUE operator</h4><p>UNIQUE是告诉marathon对于一个app的所有task保证attribute的唯一性。例如下面的contraint保证了每个host上只运行一个app任务。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">curl -X POST -H &quot;Content-type: application/json&quot; localhost:8080/v2/apps -d &apos;&#123;</div><div class="line">   &quot;id&quot;: &quot;sleep-unique&quot;,</div><div class="line">   &quot;cmd&quot;: &quot;sleep 60&quot;,</div><div class="line">   &quot;instances&quot;: 3,</div><div class="line">   &quot;constraints&quot;: [[&quot;hostname&quot;, &quot;UNIQUE&quot;]]</div><div class="line"> &#125;&apos;</div></pre></td></tr></table></figure>
<h4 id="CLUSTER-operator"><a href="#CLUSTER-operator" class="headerlink" title="CLUSTER operator"></a>CLUSTER operator</h4><p>CLUSTER可以让app 的task运行在共享指定attribute的agent node上。对于有硬件要求的任务比较适用，或者想要把任务集中运行在同一个机栈中。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">curl -X POST -H &quot;Content-type: application/json&quot; localhost:8080/v2/apps -d &apos;&#123;</div><div class="line">    &quot;id&quot;: &quot;sleep-cluster&quot;,</div><div class="line">    &quot;cmd&quot;: &quot;sleep 60&quot;,</div><div class="line">    &quot;instances&quot;: 3,</div><div class="line">    &quot;constraints&quot;: [[&quot;rack_id&quot;, &quot;CLUSTER&quot;, &quot;rack-1&quot;]]</div><div class="line">  &#125;&apos;</div></pre></td></tr></table></figure></p>
<p>也可以指定一个hostname，把app绑定在指定的一个机器上。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">curl -X POST -H &quot;Content-type: application/json&quot; localhost:8080/v2/apps -d &apos;&#123;</div><div class="line">    &quot;id&quot;: &quot;sleep-cluster&quot;,</div><div class="line">    &quot;cmd&quot;: &quot;sleep 60&quot;,</div><div class="line">    &quot;instances&quot;: 3,</div><div class="line">    &quot;constraints&quot;: [[&quot;hostname&quot;, &quot;CLUSTER&quot;, &quot;a.specific.node.com&quot;]]</div><div class="line">  &#125;&apos;</div></pre></td></tr></table></figure></p>
<h4 id="GROUP-BY-operator"><a href="#GROUP-BY-operator" class="headerlink" title="GROUP_BY operator"></a>GROUP_BY operator</h4><p>风来在不同的rack或者数据中心中均匀地分配任务，实现HA。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">curl -X POST -H &quot;Content-type: application/json&quot; localhost:8080/v2/apps -d &apos;&#123;</div><div class="line">    &quot;id&quot;: &quot;sleep-group-by&quot;,</div><div class="line">    &quot;cmd&quot;: &quot;sleep 60&quot;,</div><div class="line">    &quot;instances&quot;: 3,</div><div class="line">    &quot;constraints&quot;: [[&quot;rack_id&quot;, &quot;GROUP_BY&quot;]]</div><div class="line">  &#125;&apos;</div></pre></td></tr></table></figure>
<p>marathon会分析mesos进来的offer，获取不同的rack_id属性。如果任务没有覆盖到所有的值，那么在constraint中指定一个数。如果不指定，可能会出现任务只被部署到一个rack的情况。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">curl -X POST -H &quot;Content-type: application/json&quot; localhost:8080/v2/apps -d &apos;&#123;</div><div class="line">    &quot;id&quot;: &quot;sleep-group-by&quot;,</div><div class="line">    &quot;cmd&quot;: &quot;sleep 60&quot;,</div><div class="line">    &quot;instances&quot;: 3,</div><div class="line">    &quot;constraints&quot;: [[&quot;rack_id&quot;, &quot;GROUP_BY&quot;, &quot;3&quot;]]</div><div class="line">  &#125;&apos;</div></pre></td></tr></table></figure></p>
<h4 id="LIKE-operator"><a href="#LIKE-operator" class="headerlink" title="LIKE operator"></a>LIKE operator</h4><p>接收一个正则表达式作为参数，允许filed值满足这个正则的所有agent node运行当前任务。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">curl -X POST -H &quot;Content-type: application/json&quot; localhost:8080/v2/apps -d &apos;&#123;</div><div class="line">    &quot;id&quot;: &quot;sleep-group-by&quot;,</div><div class="line">    &quot;cmd&quot;: &quot;sleep 60&quot;,</div><div class="line">    &quot;instances&quot;: 3,</div><div class="line">    &quot;constraints&quot;: [[&quot;rack_id&quot;, &quot;LIKE&quot;, &quot;rack-[1-3]&quot;]]</div><div class="line">  &#125;&apos;</div></pre></td></tr></table></figure></p>
<p>注意，参数一定要有，不然会有警告。</p>
<h4 id="UNLIKE-operator"><a href="#UNLIKE-operator" class="headerlink" title="UNLIKE operator"></a>UNLIKE operator</h4><p>和LIKE operator一样的道理。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">curl -X POST -H &quot;Content-type: application/json&quot; localhost:8080/v2/apps -d &apos;&#123;</div><div class="line">   &quot;id&quot;: &quot;sleep-group-by&quot;,</div><div class="line">   &quot;cmd&quot;: &quot;sleep 60&quot;,</div><div class="line">   &quot;instances&quot;: 3,</div><div class="line">   &quot;constraints&quot;: [[&quot;rack_id&quot;, &quot;UNLIKE&quot;, &quot;rack-[7-9]&quot;]]</div><div class="line"> &#125;&apos;</div></pre></td></tr></table></figure>
<h4 id="MAX-PER-operator"><a href="#MAX-PER-operator" class="headerlink" title="MAX_PER operator"></a>MAX_PER operator</h4><p>接受一个数字参数，制定每个group的最大大小。可以用来限制跨rack或者数据中心的任务数量。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">curl -X POST -H &quot;Content-type: application/json&quot; localhost:8080/v2/apps -d &apos;&#123;</div><div class="line">   &quot;id&quot;: &quot;sleep-group-by&quot;,</div><div class="line">   &quot;cmd&quot;: &quot;sleep 60&quot;,</div><div class="line">   &quot;instances&quot;: 3,</div><div class="line">   &quot;constraints&quot;: [[&quot;rack_id&quot;, &quot;MAX_PER&quot;, &quot;2&quot;]]</div><div class="line"> &#125;&apos;</div></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[compose版本]]></title>
      <url>/2017/09/05/compose%E7%89%88%E6%9C%AC/</url>
      <content type="html"><![CDATA[<p>compose文件是一个yaml文件，定义了docker app的service, network, volume等</p>
<p>有三个版本</p>
<ul>
<li>version1， 在YAML文件中别指定version就是了。</li>
<li>version2.x。在YAML里指定version: ‘2’,或者version: ‘2.1’</li>
<li>version3.x。最新版本，也是最推荐使用的版本，可以兼容swarm模式。通过在YAML中指定version: ‘3’或者version: ‘3.1’声明。</li>
</ul>
<p>如果使用了多个compose文件模式，或者用了extending service，那么每个文件的version声明应该是一样的。</p>
<h2 id="Version1"><a href="#Version1" class="headerlink" title="Version1"></a>Version1</h2><p>不额外指定version的compose文件被看作”version1”。所有的service都被定义在yaml文件的root上。</p>
<p>version1是compose 1.6.x开始支持的，未来会被放弃。</p>
<p>version1文件不能声明volume, network或者build arguments。</p>
<p>compose不能使用网络：每个container都是连接在default bridge网络上的，相互之间用IP沟通。可以使用links来启用container之间的相互发现。</p>
<p>例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">web:</div><div class="line">  build: .</div><div class="line">  ports:</div><div class="line">   - &quot;5000:5000&quot;</div><div class="line">  volumes:</div><div class="line">   - .:/code</div><div class="line">  links:</div><div class="line">   - redis</div><div class="line">redis:</div><div class="line">  image: redis</div></pre></td></tr></table></figure></p>
<h2 id="version-2"><a href="#version-2" class="headerlink" title="version 2"></a>version 2</h2><p>compose文件中，必须在root指定相应version，而且所有的service都要定义在services下。</p>
<p>version 2要求compose 1.6.0+， docker engine版本1.10。0+。</p>
<p>可以通过volumes指定volume，也可以通过networks指定容器的网络。</p>
<p>默认情况下，每个container都加入一个app级别的默认网络，而且可以通过自身的hostname被发现。也就是说links就没啥必要了，详情<a href="https://docs.docker.com/compose/compose-file/compose-file-v2/#networking/" target="_blank" rel="external">参考</a>。</p>
<p>简单例子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">version: &apos;2&apos;</div><div class="line">services:</div><div class="line">  web:</div><div class="line">    build: .</div><div class="line">    ports:</div><div class="line">     - &quot;5000:5000&quot;</div><div class="line">    volumes:</div><div class="line">     - .:/code</div><div class="line">  redis:</div><div class="line">    image: redis</div></pre></td></tr></table></figure></p>
<p>稍微复杂点儿的例子, 定义了volumes和network<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">version: &apos;2&apos;</div><div class="line">services:</div><div class="line">  web:</div><div class="line">    build: .</div><div class="line">    ports:</div><div class="line">     - &quot;5000:5000&quot;</div><div class="line">    volumes:</div><div class="line">     - .:/code</div><div class="line">    networks:</div><div class="line">      - front-tier</div><div class="line">      - back-tier</div><div class="line">  redis:</div><div class="line">    image: redis</div><div class="line">    volumes:</div><div class="line">      - redis-data:/var/lib/redis</div><div class="line">    networks:</div><div class="line">      - back-tier</div><div class="line">volumes:</div><div class="line">  redis-data:</div><div class="line">    driver: local</div><div class="line">networks:</div><div class="line">  front-tier:</div><div class="line">    driver: bridge</div><div class="line">  back-tier:</div><div class="line">    driver: bridge</div></pre></td></tr></table></figure></p>
<p>还有一些其他的选项来支持网络：</p>
<ul>
<li>aliases</li>
<li><p>depends_on用来指定service之间的依赖关系</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">version: &apos;2&apos;</div><div class="line">services:</div><div class="line">  web:</div><div class="line">    build: .</div><div class="line">    depends_on:</div><div class="line">      - db</div><div class="line">      - redis</div><div class="line">  redis:</div><div class="line">    image: redis</div><div class="line">  db:</div><div class="line">    image: postgres</div></pre></td></tr></table></figure>
</li>
<li><p>ipv4_address, ipv6_address</p>
</li>
</ul>
<h2 id="Version2-1"><a href="#Version2-1" class="headerlink" title="Version2.1"></a>Version2.1</h2><p>是version2的升级版，需要docker engine是1.12.0+， compose版本是1.9.0+。</p>
<p>添加了以下参数</p>
<ul>
<li>link_local_ips</li>
<li>isolation</li>
<li>volume和network的labels</li>
<li>volumes的name</li>
<li>userns_mode</li>
<li>healthcheck</li>
<li>sysctls</li>
<li>pids_limit</li>
</ul>
<h2 id="Version2-2"><a href="#Version2-2" class="headerlink" title="Version2.2"></a>Version2.2</h2><p>version2.1的升级，，需要docker engine是1.14.0+， compose版本是1.13.0+。允许指定默认的scale数。<br>添加了下面参数：</p>
<ul>
<li>init</li>
<li>scale</li>
</ul>
<h2 id="version2-3"><a href="#version2-3" class="headerlink" title="version2.3"></a>version2.3</h2><p>version2.2的升级，，需要docker engine是17.06.0+， compose版本是1.16.0+。</p>
<p>添加了下面参数:</p>
<ul>
<li>target for build configurations</li>
<li>start_period for healthchecks</li>
</ul>
<h2 id="version3"><a href="#version3" class="headerlink" title="version3"></a>version3</h2><p>主要是解决compose和docker swarm mode的兼容性问题。</p>
<ul>
<li>移除选项：volume_driver, volumes_from, cpu_shares, cpu_quota, cpuset, mem_limit, memswap_limit, extends, group_add</li>
<li>添加选项：deploy</li>
</ul>
<h2 id="version3-3"><a href="#version3-3" class="headerlink" title="version3.3"></a>version3.3</h2><p>version3的升级版。添加以下参数：</p>
<ul>
<li>build的labels</li>
<li>credential_spec</li>
<li>configs</li>
<li>deploy endpoint_mode</li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[label的生命周期]]></title>
      <url>/2017/09/04/label%E7%9A%84%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F/</url>
      <content type="html"><![CDATA[<p>Prometheus label让我们为我们的app部署与组织间建立模型。直接支持所有可能出现的配置是不太可能，但是prometheus给力一个relabel功能，给出了足够大的灵活性。</p>
<p>基本原则：你的服务发现给你提供了一些元数据，例如机器类型、tag、region，这些都可以在_<em>meta</em>*的label中找到。然后你可以在relbel_configs配置中把他们进行定制化修改。还可以制定drop和keep操作。</p>
<p>在我们抓取target的时候也一样，metric_relabel_config配置可以让我们纠正数据的时间戳。还可以过滤掉一些比较<a href="https://www.robustperception.io/dropping-metrics-at-scrape-time-with-prometheus/" target="_blank" rel="external">昂贵，比如 太大</a>的metric。</p>
<p>为了更好的理解这些内容，看下图：<br><img src="http://www.robustperception.io/wp-content/uploads/2016/03/Life-of-a-Label-Target-Labels.png" alt=""></p>
<p>这个图包含了创建target、爬取、在时序数据插入DB之前的操作等。</p>
<ul>
<li>从服务发现获取target</li>
<li>基于配置设置_<em>param</em>*的label</li>
<li>如果job,<strong>scheme</strong>或者<strong>metrics_path</strong>的label没有设置，就基于配置设置一下</li>
<li>是否有<strong>address</strong>的label<ul>
<li>没有，丢掉这个target</li>
<li>有，执行relabel_config<ul>
<li>drop操作的话直接drop掉</li>
<li><strong>address</strong>有么有端口<ul>
<li>有端口， <strong>address</strong>是否包含 “/“<ul>
<li>drop target</li>
<li>删除所有以_<em>meta</em>开头的label</li>
</ul>
</li>
<li>没有端口，<strong>scheme</strong>是http就默认80，https就默认443</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>下面是实际爬取过程中发生的事情：<br><img src="http://www.robustperception.io/wp-content/uploads/2016/03/Life-of-a-Label-Scraping.png" alt="爬取流程图"></p>
<p>_<em>param</em>*的label包含每个URL参数的第一个值，可以进行relabel。在爬取的时候，这些会与第二个以及后续的参数值连接在一起。</p>
<p>因为metric_relabel_configs需要每次爬取的时候都执行一次，最好还是通过improve instrumentation。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Prometheus配置]]></title>
      <url>/2017/09/01/Prometheus%E9%85%8D%E7%BD%AE/</url>
      <content type="html"><![CDATA[<p>主要定义了需要抓取的job和这些job所包含的instance，还有告警规则文件。</p>
<p>可以执行 prometheus -h 来查看具体支持的命令行参数。</p>
<p>Prometheus可以在运行时reload，如果新的配置是有效的，我们只需要发送一个SIGHUP给到Prometheus进程，或者发送一个HTTP POST请求到/-/reload终端REST API。</p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>可以通过-config.file指定具体文件，需要是yaml格式。</p>
<p>下面是来源于<a href="https://github.com/prometheus/prometheus/blob/master/config/testdata/conf.good.yml的示例配置文件：" target="_blank" rel="external">https://github.com/prometheus/prometheus/blob/master/config/testdata/conf.good.yml的示例配置文件：</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div></pre></td><td class="code"><pre><div class="line"># 全局配置</div><div class="line">global:</div><div class="line">  scrape_interval:     15s</div><div class="line">  evaluation_interval: 30s</div><div class="line">  # scrape_timeout is set to the global default (10s).</div><div class="line"></div><div class="line">  external_labels:</div><div class="line">    monitor: codelab</div><div class="line">    foo:     bar</div><div class="line"></div><div class="line"># 告警规则文件</div><div class="line">rule_files:</div><div class="line">- &quot;first.rules&quot;</div><div class="line">- &quot;my/*.rules&quot;</div><div class="line"></div><div class="line"># 与实际远程写入相关的配置</div><div class="line">remote_write:</div><div class="line">  - url: http://remote1/push</div><div class="line">    write_relabel_configs:</div><div class="line">    - source_labels: [__name__]</div><div class="line">      regex:         expensive.*</div><div class="line">      action:        drop</div><div class="line">  - url: http://remote2/push</div><div class="line"></div><div class="line"># 抓取配置</div><div class="line">scrape_configs:</div><div class="line">- job_name: prometheus</div><div class="line"></div><div class="line">  honor_labels: true</div><div class="line">  # scrape_interval is defined by the configured global (15s).</div><div class="line">  # scrape_timeout is defined by the global default (10s).</div><div class="line"></div><div class="line">  # metrics_path defaults to &apos;/metrics&apos;</div><div class="line">  # scheme defaults to &apos;http&apos;.</div><div class="line"></div><div class="line">  #基于文件的服务发现</div><div class="line">  file_sd_configs:</div><div class="line">    - files:</div><div class="line">      - foo/*.slow.json</div><div class="line">      - foo/*.slow.yml</div><div class="line">      - single/file.yml</div><div class="line">      refresh_interval: 10m</div><div class="line">    - files:</div><div class="line">      - bar/*.yaml</div><div class="line"></div><div class="line">  static_configs:</div><div class="line">  - targets: [&apos;localhost:9090&apos;, &apos;localhost:9191&apos;]</div><div class="line">    labels:</div><div class="line">      my:   label</div><div class="line">      your: label</div><div class="line"></div><div class="line">  relabel_configs:</div><div class="line">  - source_labels: [job, __meta_dns_name]</div><div class="line">    regex:         (.*)some-[regex]</div><div class="line">    target_label:  job</div><div class="line">    replacement:   foo-$&#123;1&#125;</div><div class="line">    # action defaults to &apos;replace&apos;</div><div class="line">  - source_labels: [abc]</div><div class="line">    target_label:  cde</div><div class="line">  - replacement:   static</div><div class="line">    target_label:  abc</div><div class="line">  - regex:</div><div class="line">    replacement:   static</div><div class="line">    target_label:  abc</div><div class="line"></div><div class="line">  bearer_token_file: valid_token_file</div><div class="line"></div><div class="line"></div><div class="line">- job_name: service-x</div><div class="line"></div><div class="line">  basic_auth:</div><div class="line">    username: admin_name</div><div class="line">    password: &quot;multiline\nmysecret\ntest&quot;</div><div class="line"></div><div class="line">  scrape_interval: 50s</div><div class="line">  scrape_timeout:  5s</div><div class="line"></div><div class="line">  sample_limit: 1000</div><div class="line"></div><div class="line">  metrics_path: /my_path</div><div class="line">  scheme: https</div><div class="line"></div><div class="line">  dns_sd_configs:</div><div class="line">  - refresh_interval: 15s</div><div class="line">    names:</div><div class="line">    - first.dns.address.domain.com</div><div class="line">    - second.dns.address.domain.com</div><div class="line">  - names:</div><div class="line">    - first.dns.address.domain.com</div><div class="line">    # refresh_interval defaults to 30s.</div><div class="line"></div><div class="line">  relabel_configs:</div><div class="line">  - source_labels: [job]</div><div class="line">    regex:         (.*)some-[regex]</div><div class="line">    action:        drop</div><div class="line">  - source_labels: [__address__]</div><div class="line">    modulus:       8</div><div class="line">    target_label:  __tmp_hash</div><div class="line">    action:        hashmod</div><div class="line">  - source_labels: [__tmp_hash]</div><div class="line">    regex:         1</div><div class="line">    action:        keep</div><div class="line">  - action:        labelmap</div><div class="line">    regex:         1</div><div class="line">  - action:        labeldrop</div><div class="line">    regex:         d</div><div class="line">  - action:        labelkeep</div><div class="line">    regex:         k</div><div class="line"></div><div class="line">  metric_relabel_configs:</div><div class="line">  - source_labels: [__name__]</div><div class="line">    regex:         expensive_metric.*</div><div class="line">    action:        drop</div><div class="line"></div><div class="line">- job_name: service-y</div><div class="line"></div><div class="line"># 基于consul的服务发现</div><div class="line">  consul_sd_configs:</div><div class="line">  - server: &apos;localhost:1234&apos;</div><div class="line">    token: mysecret</div><div class="line">    services: [&apos;nginx&apos;, &apos;cache&apos;, &apos;mysql&apos;]</div><div class="line">    scheme: https</div><div class="line">    tls_config:</div><div class="line">      ca_file: valid_ca_file</div><div class="line">      cert_file: valid_cert_file</div><div class="line">      key_file:  valid_key_file</div><div class="line">      insecure_skip_verify: false</div><div class="line"></div><div class="line">  relabel_configs:</div><div class="line">  - source_labels: [__meta_sd_consul_tags]</div><div class="line">    separator:     &apos;,&apos;</div><div class="line">    regex:         label:([^=]+)=([^,]+)</div><div class="line">    target_label:  $&#123;1&#125;</div><div class="line">    replacement:   $&#123;2&#125;</div><div class="line"></div><div class="line">- job_name: service-z</div><div class="line"></div><div class="line">  tls_config:</div><div class="line">    cert_file: valid_cert_file</div><div class="line">    key_file: valid_key_file</div><div class="line"></div><div class="line">  bearer_token: mysecret</div><div class="line"></div><div class="line">- job_name: service-kubernetes</div><div class="line"></div><div class="line">  kubernetes_sd_configs:</div><div class="line">  - role: endpoints</div><div class="line">    api_server: &apos;https://localhost:1234&apos;</div><div class="line"></div><div class="line">    basic_auth:</div><div class="line">      username: &apos;myusername&apos;</div><div class="line">      password: &apos;mysecret&apos;</div><div class="line"></div><div class="line"># 基于kubernetes的服务发现</div><div class="line">- job_name: service-kubernetes-namespaces</div><div class="line"></div><div class="line">  kubernetes_sd_configs:</div><div class="line">  - role: endpoints</div><div class="line">    api_server: &apos;https://localhost:1234&apos;</div><div class="line">    namespaces:</div><div class="line">      names:</div><div class="line">        - default</div><div class="line"></div><div class="line"># 基于marathon的服务发现</div><div class="line">- job_name: service-marathon</div><div class="line">  marathon_sd_configs:</div><div class="line">  - servers:</div><div class="line">    - &apos;https://marathon.example.com:443&apos;</div><div class="line"></div><div class="line">    tls_config:</div><div class="line">      cert_file: valid_cert_file</div><div class="line">      key_file: valid_key_file</div><div class="line"></div><div class="line">- job_name: service-ec2</div><div class="line">  ec2_sd_configs:</div><div class="line">    - region: us-east-1</div><div class="line">      access_key: access</div><div class="line">      secret_key: mysecret</div><div class="line">      profile: profile</div><div class="line"></div><div class="line">- job_name: service-azure</div><div class="line">  azure_sd_configs:</div><div class="line">    - subscription_id: 11AAAA11-A11A-111A-A111-1111A1111A11</div><div class="line">      tenant_id: BBBB222B-B2B2-2B22-B222-2BB2222BB2B2</div><div class="line">      client_id: 333333CC-3C33-3333-CCC3-33C3CCCCC33C</div><div class="line">      client_secret: mysecret</div><div class="line">      port: 9100</div><div class="line"></div><div class="line">- job_name: service-nerve</div><div class="line">  nerve_sd_configs:</div><div class="line">    - servers:</div><div class="line">      - localhost</div><div class="line">      paths:</div><div class="line">      - /monitoring</div><div class="line"></div><div class="line">- job_name: 0123service-xxx</div><div class="line">  metrics_path: /metrics</div><div class="line">  static_configs:</div><div class="line">    - targets:</div><div class="line">      - localhost:9090</div><div class="line"></div><div class="line">- job_name: 測試</div><div class="line">  metrics_path: /metrics</div><div class="line">  static_configs:</div><div class="line">    - targets:</div><div class="line">      - localhost:9090</div><div class="line"></div><div class="line">- job_name: service-triton</div><div class="line">  triton_sd_configs:</div><div class="line">  - account: &apos;testAccount&apos;</div><div class="line">    dns_suffix: &apos;triton.example.com&apos;</div><div class="line">    endpoint: &apos;triton.example.com&apos;</div><div class="line">    port: 9163</div><div class="line">    refresh_interval: 1m</div><div class="line">    version: 1</div><div class="line">    tls_config:</div><div class="line">      cert_file: testdata/valid_cert_file</div><div class="line">      key_file: testdata/valid_key_file</div><div class="line"></div><div class="line"># 关于alertmanager相关的配置</div><div class="line">alerting:</div><div class="line">  alertmanagers:</div><div class="line">  - scheme: https</div><div class="line">    static_configs:</div><div class="line">    - targets:</div><div class="line">      - &quot;1.2.3.4:9093&quot;</div><div class="line">      - &quot;1.2.3.5:9093&quot;</div><div class="line">      - &quot;1.2.3.6:9093&quot;</div></pre></td></tr></table></figure>
<p>scrape_config部分描述一些列的target和参数，指定抓取策略。一般情况下，一个scrape配置就对应一个job。</p>
<p>target可以是通过static_config静态配置的，也可以是使用某种动态发现机制进行动态获取的。</p>
<p>另外，relabel_config允许在抓取之前更新任意target的label。</p>
<p>已经测试过file_sd_config是可以跟随文件的变化，动态调整target的。<br>但是对于rule文件的reload，并不能自动识别并执行，官网建议是通过<a href="https://github.com/prometheus/prometheus/issues/108" target="_blank" rel="external"><strong>定时触发prometheus的reload</strong></a>来实现这个东西。<br>个人认为：如果rule 的修改也并不是那么频繁，而且既有的app里已经包含队列的话，可以在每次修改rule之后，每隔几分钟消费一次reload事件。或者可以修改prometheus的rule相关代码，让其定时消费mysql或者某些目录的rule文件，如有变化则更新rule的缓存。</p>
<p>其他与动态加载rule相关 </p>
<ul>
<li><a href="https://groups.google.com/forum/#!topic/prometheus-developers/UsiCxDbFjN0" target="_blank" rel="external">https://groups.google.com/forum/#!topic/prometheus-developers/UsiCxDbFjN0</a></li>
<li><a href="https://www.robustperception.io/reloading-prometheus-configuration/" target="_blank" rel="external">https://www.robustperception.io/reloading-prometheus-configuration/</a></li>
<li></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Prometheus关键概念]]></title>
      <url>/2017/09/01/Prometheus%E5%85%B3%E9%94%AE%E6%A6%82%E5%BF%B5/</url>
      <content type="html"><![CDATA[<p>job和instance<br>在prometheus看来，每个单独的抓取目标是一个instance，通常对应一个单独的进程。同种类型的instance的集合组成一种job。</p>
<p>例如，一个API server的job会有下面的instance：</p>
<ul>
<li>job: api-server<ul>
<li>instance 1.2.3.4:5769</li>
<li>instance 1.2.3.4:5768</li>
</ul>
</li>
</ul>
<h2 id="自动产生的label"><a href="#自动产生的label" class="headerlink" title="自动产生的label"></a>自动产生的label</h2><p>在prometheus抓取target的时候，会自动在后面追加一些label：</p>
<ul>
<li>job</li>
<li>instance</li>
</ul>
<p>如果这些label是否已经出现在抓取的数据中，就参考honor_labels的配置部分。</p>
<p>每个instance的抓取，prometheus都存储一个sample：</p>
<ul>
<li>up{job=”<job-name>“, instance=”<instance-id>“}: 1 表示这个instance是否健康的存在</instance-id></job-name></li>
<li>scrape_duration_seconds{job=”<job-name>“, instance=”<instance-id>“}: 抓取时间</instance-id></job-name></li>
<li>scrape_samples_post_metric_relabeling{job=”<job-name>“, instance=”<instance-id>“}:metric被relabel的sample个数</instance-id></job-name></li>
<li>scrape_samples_scraped{job=”<job-name>“, instance=”<instance-id>“}: target中暴露的sample个数</instance-id></job-name></li>
</ul>
<p>up时间序列一般用来监控instance的可用性。</p>
<p>但是，如果这样的话，我的instance就没有办法动态添加进去，因为Prometheus并没有提供动态修改target的REST API.</p>
<p><a href="https://prometheus.io/docs/querying/api/" target="_blank" rel="external">https://prometheus.io/docs/querying/api/</a></p>
<p><a href="http://ordina-jworks.github.io/monitoring/2016/09/23/Monitoring-with-Prometheus.html#architecture" target="_blank" rel="external">一片不错的prometheus监控使用总结</a></p>
<p>相关链接： <a href="https://groups.google.com/forum/#!topic/prometheus-users/fTPKx5Eg8bo" target="_blank" rel="external">https://groups.google.com/forum/#!topic/prometheus-users/fTPKx5Eg8bo</a></p>
<p><a href="https://github.com/prometheus/jmx_exporter/pull/180#issuecomment-326229999" target="_blank" rel="external">https://github.com/prometheus/jmx_exporter/pull/180#issuecomment-326229999</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[marathon-蓝绿部署]]></title>
      <url>/2017/08/31/marathon-%E8%93%9D%E7%BB%BF%E9%83%A8%E7%BD%B2/</url>
      <content type="html"><![CDATA[<p>蓝绿部署是一种安全部署app的方式，它会创建两个版本的app(BLUE和GREEN)。要部署一个新版本的app，应该先将所有旧版本的请求、挂起的操作等处理完，并且将流量定向到新版本app那边。蓝绿部署预估app的停掉的时间，允许我们在必要时快速从BLUE版本恢复。详细过程，参考<a href="http://martinfowler.com/bliki/BlueGreenDeployment.html" target="_blank" rel="external">蓝绿部署</a></p>
<p>不错的解释：<a href="http://www.tuicool.com/articles/2Iji2ue" target="_blank" rel="external">http://www.tuicool.com/articles/2Iji2ue</a></p>
<p><a href="https://www.v2ex.com/t/344341" target="_blank" rel="external">https://www.v2ex.com/t/344341</a></p>
<p>在生产环境中，最好将这个过程脚本化，将它集成进已经存在的部署系统中。下面，我们提供一个使用DC/OS CLI的例子。</p>
<h2 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h2><p>我们需要把BLUE，也就是当前版本的app，替换成GREEN(新版本)。</p>
<ol>
<li>在marathon上启动新版本的app。给app名字一个唯一的id，比如git的commit id。在这个例子中，我们把GREEN添加到新版本app的名字中：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># launch green</div><div class="line"> dcos marathon app add green-myapp.json</div></pre></td></tr></table></figure>
</li>
</ol>
<p>注意：如果你使用的不是dcos的CLI，而是API，那命令会长很多。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -H &quot;Content-Type: application/json&quot; -X POST -d @green-myapp.json &lt;hosturl&gt;/marathon/v2/apps</div></pre></td></tr></table></figure></p>
<ol>
<li>扩容GREEN的app。初始的时候一般是0，设置一下需要的实例数量。记住，现在还并没有流量过来：我们并没有到LB那边注册。</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># scale green</div><div class="line">dcos marathon app update /green-myapp instances=1</div></pre></td></tr></table></figure>
<ol>
<li><p>等所有的GREEN app都健康部署。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># wait until healthy</div><div class="line">dcos marathon app show /green-myapp | jq &apos;.tasks[].healthCheckResults[] | select (.alive == false)&apos;</div></pre></td></tr></table></figure>
</li>
<li><p>如果看到又不健康的，就中止部署，开始rollback</p>
</li>
<li>把GREEN app加入到LB中</li>
<li><p>选一个或多个BLUE app。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># pick tasks from blue</div><div class="line">dcos marathon task list /blue-myapp</div></pre></td></tr></table></figure>
</li>
<li><p>更新LB，将这些BLUE app移除资源池</p>
</li>
<li>等所有的BLUE app都被移除完，这个过程可以通过app的metrics终端API进行监控。</li>
<li>一旦BLUE app的操作都完成，就杀掉BLUE app的进程，并缩容，避免被杀掉的重启.<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># kill and scale blue tasks</div><div class="line">echo &quot;&#123;\&quot;ids\&quot;:[\&quot;&lt;task_id&gt;\&quot;]&#125;&quot; | curl -H &quot;Content-Type: application/json&quot; -X POST -d @- &lt;hosturl&gt;/marathon/v2/tasks/delete?scale=true</div></pre></td></tr></table></figure>
</li>
</ol>
<p>marathon会移除指定的所有的实例。上面的hosturl是master node所在的位置<br>10.重复步骤2-9，直到不再有BLUE app</p>
<ol>
<li>从marathon中移除BLUE app。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># remove blue</div><div class="line">dcos marathon app remove /blue-myapp</div></pre></td></tr></table></figure>
</li>
</ol>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[marathon-应用部署]]></title>
      <url>/2017/08/31/marathon-%E5%BA%94%E7%94%A8%E9%83%A8%E7%BD%B2/</url>
      <content type="html"><![CDATA[<p>每次app的配置文件修改生效就出发一次deployment。一次deployment是一系列动作的集合：</p>
<ul>
<li>启动或者停止一个或多个app</li>
<li>升级一个或多个app</li>
<li>扩展一个或多个app</li>
</ul>
<p>Deloyment需要花费时间，并不能马上使app恢复可用。</p>
<p>只要每个app只被一次deployment修改，那么你就可以同时执行多个deployment。在我们尝试执行一个已经被别人修改过的deployment 的时候，marathon会驳回此次deployment。</p>
<h4 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h4><p>没有依赖的app可以以任意顺序部署。如果app间有依赖，那么deployment就应该严格按照app的依赖顺序执行。</p>
<p><img src="https://mesosphere.github.io/marathon/img/dependency.png" alt=""></p>
<p>如上图，app是以来db的。</p>
<p>启动： 先启动db，再启动app<br>停止： 先停止app，再停止db<br>升级： 参考 Rolling Restart 部分<br>扩容： db先扩容，然后app</p>
<h4 id="Rolling-Restart"><a href="#Rolling-Restart" class="headerlink" title="Rolling Restart"></a>Rolling Restart</h4><p>我们可以通过 Rolling Restart来部署新版本的app。通常，有两个阶段：启动一些新版本的进程，然后停掉旧版本的进程。</p>
<p>在marathon中，可以在app级别使用minimumHealthCapacity 定义一个upgrade strategy。</p>
<p>minimumHealthCapacity是指达升级过程中，处于正常服务状态的实例不能少于整体的百分之多少。如果是0， 在新版本部署前，就把所有的旧版本杀掉。如果是1，就先启动所有的新版本实例，然后再杀掉所有的旧版本实例。</p>
<p>这个动作在有依赖关系的时候会复杂一些。上面的例子来说：</p>
<ol>
<li>先升级db到所有的实例都完成；</li>
<li>升级app到所有的实例都完成。<br>上面两个app的具体过程，还是按照upgradeStrategy来处理。假设我们设置的db和app对应的参数分别是0.6和0.8，那么过程中就会出现db有12个实例（6个新的，6个旧的），app出现32个实例（16个新的，16个旧的）</li>
</ol>
<h4 id="强制deployment"><a href="#强制deployment" class="headerlink" title="强制deployment"></a>强制deployment</h4><p>一个app只能同时被一个deployment修改。其他的修改必须等待当前的完成才行。如果运行deployement的时候加上force标记就可以打破这个限制。</p>
<p>但是<strong>注意</strong>： force标记只适用于失败的deployment</p>
<p>如果指定了force，那么所有其他的修改都会被取消。这个操作可能让系统进入一个不一致状态，尤其是在一个app执行rolling upgrade的时候，会导致一部分新版本app与一些旧版本app并行的秦广。如果新的deployment没有更新这些app，就会一直处于这种不一致状态了。</p>
<p>唯一可以进行force-update的app是那些只有一个app实例的。<strong>要强制部署多个app的唯一理由，是修正一个失败的deployment。</strong></p>
<h4 id="失败的deployment"><a href="#失败的deployment" class="headerlink" title="失败的deployment"></a>失败的deployment</h4><p>deployment是包含很多严谨的、有次序的步骤的。</p>
<p>下面是一些永远不能成功的情景：</p>
<ul>
<li>新app没启动成功</li>
<li>新app不能进入healthy状态</li>
<li>新app的依赖没有声明、或者不可用</li>
<li>集群资源耗尽</li>
<li>app使用docker container，docker相关配置没有启用</li>
</ul>
<p>这些情况会导致app一直循环重启，又不能成功，需要重新部署正确的app配置才行。</p>
<h4 id="v2-deployment终端API"><a href="#v2-deployment终端API" class="headerlink" title="/v2/deployment终端API"></a>/v2/deployment终端API</h4><p>参考 <a href="https://mesosphere.github.io/marathon/docs/rest-api.html" target="_blank" rel="external">marathon的REST API</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[RunningAlert]]></title>
      <url>/2017/08/31/RunningAlert/</url>
      <content type="html"><![CDATA[<h2 id="ReadMe"><a href="#ReadMe" class="headerlink" title="ReadMe"></a>ReadMe</h2><p>一个大数据集群监控项目，主要依赖于当前比较流行的<a href="https://prometheus.io/" target="_blank" rel="external">Prometheus</a>。</p>
<h2 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h2><h4 id="1-采集注册"><a href="#1-采集注册" class="headerlink" title="1. 采集注册"></a>1. 采集注册</h4><p>指的是向JsonExporter<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">app_name : h2_streaming_...</div><div class="line">url: http://sdfsfdsd:0080/metrics</div><div class="line">service_type : spark_streaming</div></pre></td></tr></table></figure></p>
<p>提供数据示例参考，也就是马上爬取一下metrics，并显示出来，以方便表达式编写。</p>
<h4 id="2-json-exporter-开始采集"><a href="#2-json-exporter-开始采集" class="headerlink" title="2. json_exporter 开始采集"></a>2. json_exporter 开始采集</h4><p>启动marathon上json_exporter的docker镜像，并指定当前对应的参数。开始metric的采集工作。</p>
<h4 id="3-指定alertManager的告警规则"><a href="#3-指定alertManager的告警规则" class="headerlink" title="3. 指定alertManager的告警规则"></a>3. 指定alertManager的告警规则</h4><p>直接开放给用户直接编辑</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">ALERT &#123;&#123; pro_alert.alert_name &#125;&#125;</div><div class="line">   IF absent(json_val&#123;rowkey=~&quot;&#123;&#123; pro_alert.key_regex &#125;&#125;&quot;, app_name=&quot;&#123;&#123; app_name &#125;&#125;&quot;&#125;)</div><div class="line">   FOR &#123;&#123; pro_alert.time_spent &#125;&#125;s</div><div class="line">   LABELS &#123; severity = &quot;critical&quot;&#125;</div><div class="line">   ANNOTATIONS &#123;</div><div class="line">    summary= &quot;&#123;&#123; pro_alert.summary &#125;&#125;&quot;,</div><div class="line">    description= &quot;&#123;&#123; pro_alert.description &#125;&#125;&quot;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">ALERT &#123;&#123; pro_alert.alert_name &#125;&#125;</div><div class="line">   IF consul_health_service_status&#123;check=&quot;service:web&quot;,node=&quot;agent-two&quot;,service_id=&quot;web&quot;,service_name=&quot;web&quot;,status=&quot;critical&quot;&#125;  == 1</div><div class="line">   FOR &#123;&#123; pro_alert.time_spent &#125;&#125;s</div><div class="line">   LABELS &#123; severity = &quot;critical&quot;&#125;</div><div class="line">   ANNOTATIONS &#123;</div><div class="line">    summary= &quot;&#123;&#123; pro_alert.summary &#125;&#125;&quot;,</div><div class="line">    description= &quot;&#123;&#123; pro_alert.description &#125;&#125;&quot;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>之后，保存或者保存并立即生效。</p>
<p>立即生效其实就是调用一下prometheus的alertManager的/-/reload/接口。</p>
<p>之后Prometheus会自动检验对应metric规则，并发送给AlertManager的receiver，并产生告警动作。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[marathon坑记]]></title>
      <url>/2017/08/30/marathon%E5%9D%91%E8%AE%B0/</url>
      <content type="html"><![CDATA[<h2 id="资源不足"><a href="#资源不足" class="headerlink" title="资源不足"></a>资源不足</h2><h4 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h4><p>运行marathon官网提供的docker get started案例(<a href="https://mesosphere.github.io/marathon/docs/application-basics.html)可以成功。" target="_blank" rel="external">https://mesosphere.github.io/marathon/docs/application-basics.html)可以成功。</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;id&quot;: &quot;basic-3&quot;,</div><div class="line">  &quot;cmd&quot;: &quot;python3 -m http.server 8080&quot;,</div><div class="line">  &quot;cpus&quot;: 0.5,</div><div class="line">  &quot;mem&quot;: 32.0,</div><div class="line">  &quot;container&quot;: &#123;</div><div class="line">    &quot;type&quot;: &quot;DOCKER&quot;,</div><div class="line">    &quot;docker&quot;: &#123;</div><div class="line">      &quot;image&quot;: &quot;python:3&quot;,</div><div class="line">      &quot;network&quot;: &quot;BRIDGE&quot;,</div><div class="line">      &quot;portMappings&quot;: [</div><div class="line">        &#123; &quot;containerPort&quot;: 8080, &quot;hostPort&quot;: 0 &#125;</div><div class="line">      ]</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我自己提了一个,屡次卡住不能deploy成功。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;id&quot;: &quot;/docker-tt&quot;,</div><div class="line">  &quot;cmd&quot;: null,</div><div class="line">  &quot;cpus&quot;: 1,</div><div class="line">  &quot;mem&quot;: 128,</div><div class="line">  &quot;disk&quot;: 0,</div><div class="line">  &quot;instances&quot;: 1,</div><div class="line">  &quot;acceptedResourceRoles&quot;: [</div><div class="line">    &quot;*&quot;</div><div class="line">  ],</div><div class="line">  &quot;container&quot;: &#123;</div><div class="line">    &quot;type&quot;: &quot;DOCKER&quot;,</div><div class="line">    &quot;volumes&quot;: [],</div><div class="line">    &quot;docker&quot;: &#123;</div><div class="line">      &quot;image&quot;: &quot;nginx:stable-alpine&quot;,</div><div class="line">      &quot;network&quot;: &quot;BRIDGE&quot;,</div><div class="line">      &quot;portMappings&quot;: [</div><div class="line">        &#123;</div><div class="line">          &quot;containerPort&quot;: 80,</div><div class="line">          &quot;hostPort&quot;: 880,</div><div class="line">          &quot;servicePort&quot;: 10000,</div><div class="line">          &quot;protocol&quot;: &quot;tcp&quot;,</div><div class="line">          &quot;name&quot;: &quot;nn&quot;,</div><div class="line">          &quot;labels&quot;: &#123;&#125;</div><div class="line">        &#125;</div><div class="line">      ],</div><div class="line">      &quot;privileged&quot;: false,</div><div class="line">      &quot;parameters&quot;: [],</div><div class="line">      &quot;forcePullImage&quot;: false</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;portDefinitions&quot;: [</div><div class="line">    &#123;</div><div class="line">      &quot;port&quot;: 10000,</div><div class="line">      &quot;protocol&quot;: &quot;tcp&quot;,</div><div class="line">      &quot;name&quot;: &quot;default&quot;,</div><div class="line">      &quot;labels&quot;: &#123;&#125;</div><div class="line">    &#125;</div><div class="line">  ]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>参考了官网的<a href="https://mesosphere.github.io/marathon/docs/troubleshooting.html#an-app-stays-in-quot-waiting-quot-forever" target="_blank" rel="external">这个链接</a> 的第一个，提示说：如果app一直都处于<strong>waiting</strong>的状态，那么很可能是由于资源不足的造成的，例如CPU，内存，磁盘等。</p>
<p>最后还说，如果还找不到问题，就到github提一个issue，把/state的内容贴近issue，这样就可以让社区的人帮忙分析。 </p>
<p>按照提示，我么有找到任何资源匮乏，当前的framework占用资源都是0.在查看slaves提供的物理资源的时候被亮瞎了狗眼：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&quot;resources&quot;: &#123;</div><div class="line">    &quot;disk&quot;: 12758,</div><div class="line">    &quot;mem&quot;: 2767,</div><div class="line">    &quot;gpus&quot;: 0,</div><div class="line">    &quot;cpus&quot;: 2,</div><div class="line">    &quot;ports&quot;: &quot;[31000-32000]&quot;</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<p>注意<strong>ports</strong>…..每个slave为什么要把自己的端口范围也限制啊……跪了。把上面的docker启动host端口改为31111后，测试通过，成功部署了nginx服务。</p>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p><a href="https://mesosphere.github.io/marathon/docs/ports.html" target="_blank" rel="external">官网端口映射相关</a></p>
<p>portMapping： 对于所有需要给外部访问的docker容器，端口映射都很重要。一个端口映射是一个包含host port、container port、service port以及protocaol的tuple。有时也需要多个端口映射定义。不固定的hostPort默认是0，这样marathons会随机选一个端口。在Docker的USER模式下，hostPort是几乎不变的：hostport并不是必要的，如果没有制定，那么marathon不会自动随机选一个。这样就允许container可以在USER网络里发布，只包含containerPort和发现信息，但是不暴露这些端口给hsot网络。</p>
<p>portDefinitions： 一个数据定义了端口资源池。只在使用HOST网络，并且没有指定portMapping的时候是必须要有的。</p>
<p>servicePort：当在marathon创建新的app时，要为其指定一个或多个service port。你可以指定合理的port，也可以设为0让marathon自动分配可用端口。如果自己选择，就需要确保这个端口在所有app中是唯一的。</p>
<p>如果containerport和hostport同时被设置为0，那么他俩的端口虽然是会被随机分配，但是他俩是一样的，比如8888，那么就都是8888。</p>
<h5 id="配置实例"><a href="#配置实例" class="headerlink" title="配置实例"></a>配置实例</h5><h6 id="host"><a href="#host" class="headerlink" title="host"></a>host</h6><p>host网络模式是默认的网络模式，也是非docker app的唯一网络模式。注意在你的dockerfile里expose端口并不是必须的。</p>
<h6 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&quot;container&quot;: &#123;</div><div class="line">  &quot;type&quot;: &quot;DOCKER&quot;,</div><div class="line">  &quot;docker&quot;: &#123;</div><div class="line">    &quot;image&quot;: &quot;my-image:1.0&quot;,</div><div class="line">    &quot;network&quot;: &quot;HOST&quot;</div><div class="line">  &#125;</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p>指定端口的两种方式<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&quot;ports&quot;: [</div><div class="line">        2001, 2002, 3000</div><div class="line">    ],</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&quot;portDefinitions&quot;: [</div><div class="line">        &#123;&quot;port&quot;: 2001&#125;, &#123;&quot;port&quot;: 2002&#125;, &#123;&quot;port&quot;: 3000&#125;</div><div class="line">    ],</div></pre></td></tr></table></figure>
<p>这时环境变量$PORT0,$PORT1, $PORT2就分别是2001，2002，3000，如果都是0的话就都是随机分配的。</p>
<p>另外，保证一个服务发现程序例如haproxy从service port请求host port也是必须的。那么我们或许希望这个app的service ports与host ports保持一致，那么就可以设置requirePorts为true。这样marathons就只调度这个app到有这些端口的agent上了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&quot;ports&quot;: [</div><div class="line">        2001, 2002, 3000</div><div class="line">    ],</div><div class="line">    &quot;requirePorts&quot; : true</div></pre></td></tr></table></figure></p>
<p>现在，service 和host的ports就都是2001， 2002， 3000了。</p>
<p>定义portDefinitions队列可以让我们制定protocol，每个port都有一个名字和自己的label。在启动新的task的时候，marathon会把metadata发送给mesos。mesos会在这个task的discovery字段中暴露这些信息。自定义网络发现服务可以读取这个字段，发现app服务。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&quot;portDefinitions&quot;: [</div><div class="line">     &#123;</div><div class="line">         &quot;port&quot;: 0,</div><div class="line">         &quot;protocol&quot;: &quot;tcp&quot;,</div><div class="line">         &quot;name&quot;: &quot;http&quot;,</div><div class="line">         &quot;labels&quot;: &#123;&quot;VIP_0&quot;: &quot;10.0.0.1:80&quot;&#125;</div><div class="line">     &#125;</div><div class="line"> ],</div></pre></td></tr></table></figure>
<p>这是一个动态的tcp端口，name为http，并包含一个label。 port字段是必须的，protocol、name、labels是可选的。如果portDefinitions中只定义port字段的时候，其实跟定义ports数组没有分别。</p>
<p>注意：如果ports和portDefinitions内容不一致，那么就不能同时定义。</p>
<h5 id="bridge"><a href="#bridge" class="headerlink" title="bridge"></a>bridge</h5><p>bridge网络模型允许映射hostport到内部的container端口，而且只能用于docker container。通常在使用一个拥有固定端口的docker image的时候只用这种方式。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">&quot;container&quot;: &#123;</div><div class="line">   &quot;type&quot;: &quot;DOCKER&quot;,</div><div class="line">   &quot;docker&quot;: &#123;</div><div class="line">     &quot;image&quot;: &quot;my-image:1.0&quot;,</div><div class="line">     &quot;network&quot;: &quot;BRIDGE&quot;</div><div class="line">   &#125;</div><div class="line"> &#125;,</div></pre></td></tr></table></figure>
<p>指定USER网络<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&quot;container&quot;: &#123;</div><div class="line">    &quot;type&quot;: &quot;DOCKER&quot;,</div><div class="line">    &quot;docker&quot;: &#123;</div><div class="line">      &quot;image&quot;: &quot;my-image:1.0&quot;,</div><div class="line">      &quot;network&quot;: &quot;USER&quot;</div><div class="line">    &#125;</div><div class="line">  &#125;,</div><div class="line">  &quot;ipAddress&quot;: &#123;</div><div class="line">    &quot;networkName&quot;: &quot;someUserNetwork&quot;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>指定端口</p>
<p>端口隐射与把-p参数传递给docker命令行差不多。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&quot;container&quot;: &#123;</div><div class="line">  &quot;type&quot;: &quot;DOCKER&quot;,</div><div class="line">  &quot;docker&quot;: &#123;</div><div class="line">    &quot;image&quot;: &quot;my-image:1.0&quot;,</div><div class="line">    &quot;network&quot;: &quot;BRIDGE&quot;,</div><div class="line">    &quot;portMappings&quot;: [</div><div class="line">      &#123; &quot;containerPort&quot;: 0, &quot;hostPort&quot;: 0 &#125;,</div><div class="line">      &#123; &quot;containerPort&quot;: 0, &quot;hostPort&quot;: 0 &#125;,</div><div class="line">      &#123; &quot;containerPort&quot;: 0, &quot;hostPort&quot;: 0 &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<p>上面的例子中，containerPort会和hostPort一致，都是随机的。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&quot;container&quot;: &#123;</div><div class="line">  &quot;type&quot;: &quot;DOCKER&quot;,</div><div class="line">  &quot;docker&quot;: &#123;</div><div class="line">    &quot;image&quot;: &quot;my-image:1.0&quot;,</div><div class="line">    &quot;network&quot;: &quot;BRIDGE&quot;,</div><div class="line">    &quot;portMappings&quot;: [</div><div class="line">      &#123; &quot;containerPort&quot;: 80, &quot;hostPort&quot;: 0 &#125;,</div><div class="line">      &#123; &quot;containerPort&quot;: 443, &quot;hostPort&quot;: 0 &#125;,</div><div class="line">      &#123; &quot;containerPort&quot;: 4000, &quot;hostPort&quot;: 0 &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;,</div></pre></td></tr></table></figure>
<p>这个例子，marathon会随机分配端口来与容器的80，443，4000进行对应。</p>
<p>marathon会为每port都穿件service port。service port用来给服务发现程序使用，通常用一些常见的port。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&quot;container&quot;: &#123;</div><div class="line">  &quot;type&quot;: &quot;DOCKER&quot;,</div><div class="line">  &quot;docker&quot;: &#123;</div><div class="line">    &quot;image&quot;: &quot;my-image:1.0&quot;,</div><div class="line">    &quot;network&quot;: &quot;BRIDGE&quot;,</div><div class="line">    &quot;portMappings&quot;: [</div><div class="line">      &#123; &quot;containerPort&quot;: 80, &quot;hostPort&quot;: 0, &quot;protocol&quot;: &quot;tcp&quot;, &quot;servicePort&quot;: 2000 &#125;,</div><div class="line">      &#123; &quot;containerPort&quot;: 443, &quot;hostPort&quot;: 0, &quot;protocol&quot;: &quot;tcp&quot;, &quot;servicePort&quot;: 2001 &#125;,</div><div class="line">      &#123; &quot;containerPort&quot;: 4000, &quot;hostPort&quot;: 0, &quot;protocol&quot;: &quot;udp&quot;, &quot;servicePort&quot;: 3000&#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">&#125;,</div></pre></td></tr></table></figure></p>
<p>host port还是随机的，但是service port固定了。HAProxy就可以配置路由从这些<br>service port 到host port 了。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[prometheus的alertmanager部分]]></title>
      <url>/2017/08/23/prometheus%E7%9A%84alertmanager%E9%83%A8%E5%88%86/</url>
      <content type="html"><![CDATA[<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><h4 id="分组"><a href="#分组" class="headerlink" title="分组"></a>分组</h4><p>把近似的告警放进单个通知中。</p>
<p>例如：一个服务的几百台实例分布在不同的机器中，如果出现局部的网络问题，那么可能会报出部分服务大约100个报警信息，我们是需要知道哪些实例有问题的，这样才能快速定位区域。但是没有必要发送几百条通知，只需要一条通知，包含所有的实例列表就可以了。</p>
<h4 id="inhibit"><a href="#inhibit" class="headerlink" title="inhibit"></a>inhibit</h4><p>inhibition是用来避免关联报警的。</p>
<p>例如：如果一个集群不可用的告警已经firing了。那么Altermanager可以让其他的与集群相关的告警不发出。这样能避免此种类型的告警爆炸问题。</p>
<h4 id="silence"><a href="#silence" class="headerlink" title="silence"></a>silence</h4><p>一般用来指定不告警的时段。通常基于matcher进行配置。</p>
<h2 id="告警规则"><a href="#告警规则" class="headerlink" title="告警规则"></a>告警规则</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">ALERT &lt;alert name&gt;</div><div class="line">  IF &lt;expression&gt;</div><div class="line">  [ FOR &lt;duration&gt; ]    发生持续时长</div><div class="line">  [ LABELS &lt;label set&gt; ]    为告警指定label，同样label的告警会被最新的告警覆盖</div><div class="line">  [ ANNOTATIONS &lt;label set&gt; ]</div></pre></td></tr></table></figure>
<p>例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"># Alert for any instance that is unreachable for &gt;5 minutes.</div><div class="line">ALERT InstanceDown</div><div class="line">  IF up == 0</div><div class="line">  FOR 5m</div><div class="line">  LABELS &#123; severity = &quot;page&quot; &#125;</div><div class="line">  ANNOTATIONS &#123;</div><div class="line">    summary = &quot;Instance &#123;&#123; $labels.instance &#125;&#125; down&quot;,</div><div class="line">    description = &quot;&#123;&#123; $labels.instance &#125;&#125; of job &#123;&#123; $labels.job &#125;&#125; has been down for more than 5 minutes.&quot;,</div><div class="line">  &#125;</div><div class="line"></div><div class="line"># Alert for any instance that have a median request latency &gt;1s.</div><div class="line">ALERT APIHighRequestLatency</div><div class="line">  IF api_http_request_latencies_second&#123;quantile=&quot;0.5&quot;&#125; &gt; 1</div><div class="line">  FOR 1m</div><div class="line">  ANNOTATIONS &#123;</div><div class="line">    summary = &quot;High request latency on &#123;&#123; $labels.instance &#125;&#125;&quot;,</div><div class="line">    description = &quot;&#123;&#123; $labels.instance &#125;&#125; has a median request latency above 1s (current value: &#123;&#123; $value &#125;&#125;s)&quot;,</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>label存的是实例的label信息，value是IF表达式的结果。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[apache-atlas数据治理]]></title>
      <url>/2017/08/22/apache-atlas%E6%95%B0%E6%8D%AE%E6%B2%BB%E7%90%86/</url>
      <content type="html"><![CDATA[<p>Atlas是一个可扩展的一系列的核心基础管理服务。</p>
<p>特性</p>
<ul>
<li>数据分类<ul>
<li>为数据定义面向业务的分类标签</li>
<li>定义、annotate、自动获取数据集之间的关系【source、target、中间处理的process】</li>
<li>导出元数据到第三方系统</li>
</ul>
</li>
<li>中心化监听<ul>
<li>捕获每个app、process等数据交互的安全信息</li>
<li>捕获每个步骤【execution、step、activities】的操作信息</li>
</ul>
</li>
<li>搜索和lineage<ul>
<li>预定义导航路径来检索数据分类和监听信息</li>
<li>基于文本的索引，定位对应数据和监听的事件</li>
<li>对数据集的血统可视化，可以看到操作、安全等信息</li>
</ul>
</li>
<li>安全和策略引擎<ul>
<li>基于数据分类、属性、角色的运行时Rationalize compliance policy</li>
<li>Advanced definition of policies for preventing data derivation based on classification (i.e. re-identification) – Prohibitions</li>
<li>Column and Row level masking based on cell values and attibutes.</li>
</ul>
</li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[prometheus自定义exporter]]></title>
      <url>/2017/08/18/prometheus%E8%87%AA%E5%AE%9A%E4%B9%89exporter/</url>
      <content type="html"><![CDATA[<h2 id="可维护性和简洁度"><a href="#可维护性和简洁度" class="headerlink" title="可维护性和简洁度"></a>可维护性和简洁度</h2><p>最核心的地方是考虑一下获取metrics的成本与途径。</p>
<p>如果已经有了一个不错的、不怎么修改的metrics，那么就很容易搞定。例如haproxy exporter</p>
<p>如果有上百个metrcis，而且随着版本变化metric也一直在变，那就会有得受了。例如mysql exporter </p>
<p>node exporter介于两者之间，是个别的module总在变化。</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>exporter不应该关心app在哪里的配置，也能够使用filter过滤一些太稀碎的metric。</p>
<p>与监控系统协作的时候，framework和protocol相关的东西会很复杂。</p>
<p>最好是既有系统的数据结构能有prometheus一致，或者近似。这样就可以自动转化metric的形式，例如Cloudwatch, SNMP and Collectd。</p>
<p>其实更多情况是不那么标准的。例如jmx exporter， 用户必须说明怎样进行metric转化才行。</p>
<p>YAML是标准的prometheus配置文件格式。</p>
<h2 id="metrics"><a href="#metrics" class="headerlink" title="metrics"></a>metrics</h2><h4 id="命名"><a href="#命名" class="headerlink" title="命名"></a>命名</h4><h4 id="label"><a href="#label" class="headerlink" title="label"></a>label</h4><p>避免使用type作为label名称，太通用，而且无意义。应该是用避免使用一些类似region, zone, cluster,az,datacenter,dc,woner,customer,stage,environment, env等字眼。</p>
<h4 id="实例"><a href="#实例" class="headerlink" title="实例"></a>实例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> prometheus_client <span class="keyword">import</span> start_http_server, Metric, REGISTRY</div><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">import</span> requests</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">import</span> time</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JsonCollector</span><span class="params">()</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">init</span><span class="params">(self, endpoint, appname, srvtype, separator=<span class="string">'__'</span>)</span>:</span></div><div class="line">        self._endpoint = endpoint</div><div class="line">        self._appname = appname</div><div class="line">        self._separator = separator</div><div class="line">        self._srvtype = srvtype</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, target)</span>:</span></div><div class="line">        self.init(target.url, target.appname, target.srvtype)</div><div class="line"></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle_type</span><span class="params">(self, prefix, d, metric</span></span></div><div class="line">        <span class="string">'''</span></div><div class="line">        本来是应该使用具体的metric类型的，调用其add_metric接口。</div><div class="line">        但是由于这是一个JSON到prometheus的通用方法，所以没有那样处理。</div><div class="line">        '''</div><div class="line">        prefix = prefix.upper<span class="params">()</span></div><div class="line">        if isinstance<span class="params">(d, dict)</span>:</div><div class="line">            self.extract_dict<span class="params">(prefix, d, metric)</span></div><div class="line">        elif isinstance<span class="params">(d, list)</span>:</div><div class="line">            self.extract_list<span class="params">(prefix, d, metric)</span></div><div class="line">        else:</div><div class="line">            if not isinstance<span class="params">(d, <span class="params">(str, unicode)</span>)</span>:</div><div class="line">                metric.add_sample<span class="params">(<span class="string">'json_val'</span>,</span></div><div class="line">                                  value=d, labels=&#123;<span class="string">'app_name'</span>: self._appname, <span class="string">'rowkey'</span>: prefix&#125;)</div><div class="line">            else:</div><div class="line">                try:</div><div class="line">                    val = float<span class="params">(d)</span></div><div class="line">                    metric.add_sample<span class="params">(<span class="string">'json_val'</span>,</span></div><div class="line">                                  value=val, labels=&#123;<span class="string">'app_name'</span>: self._appname, <span class="string">'rowkey'</span>: prefix&#125;)</div><div class="line">                except ValueError:</div><div class="line">                    print<span class="params">(<span class="string">'Error convert %s to float for %s'</span> % <span class="params">(d, prefix)</span>)</span></div><div class="line">    </div><div class="line">    </div><div class="line">    def extract_dict<span class="params">(self, prefix, dd, metric)</span>:</div><div class="line">        for k, v in dd.items<span class="params">()</span>:</div><div class="line">            if len<span class="params">(prefix)</span> == <span class="number">0</span>:</div><div class="line">                self.handle_type<span class="params">(k, v, metric)</span></div><div class="line">            else:</div><div class="line">                self.handle_type<span class="params">(prefix + self._separator + k, v, metric)</span></div><div class="line">    </div><div class="line">    </div><div class="line">    def extract_list<span class="params">(self, prefix, dd, metric)</span>:</div><div class="line">        for i in dd:</div><div class="line">            if len<span class="params">(prefix)</span> == <span class="number">0</span>:</div><div class="line">                self.handle_type<span class="params">(dd.index<span class="params">(i)</span>, i, metric)</span></div><div class="line">            else:</div><div class="line">                self.handle_type<span class="params">(prefix + self._separator + dd.index<span class="params">(i)</span>, i, metric)</span></div><div class="line"></div><div class="line">    def collect<span class="params">(self)</span>:</div><div class="line">        <span class="string">'''</span></div><div class="line">        此处需要注意，接口返回的是这里的结果，不要把metric弄成成员变量。</div><div class="line">        应该每次都new一个返回去，不然add_sample会把所有的变量都累加进去</div><div class="line">        '''</div><div class="line">        try:</div><div class="line">            response = json.loads<span class="params">(requests.get<span class="params">(self._endpoint)</span>.content.decode<span class="params">(<span class="string">'UTF-8'</span>)</span>)</span></div><div class="line">            metric = Metric<span class="params">(self._srvtype, <span class="string">'spark program id'</span>, <span class="string">'summary'</span>)</span></div><div class="line">            self.handle_type<span class="params">(<span class="string">''</span>, response, metric)</span></div><div class="line">            yield metric</div><div class="line">        except Exception, e:</div><div class="line">            print e.message</div><div class="line"></div><div class="line"></div><div class="line">class Target<span class="params">()</span>:</div><div class="line">    def __init__<span class="params">(self, srvtype, appname, url)</span>:</div><div class="line">        self.srvtype = srvtype</div><div class="line">        self.appname = appname</div><div class="line">        self.url = url</div><div class="line"></div><div class="line">if __name__ == <span class="string">'__main__'</span>:</div><div class="line">    # Usage: json_exporter.py port</div><div class="line">    </div><div class="line">    print<span class="params">(sys.argv)</span></div><div class="line">    start_http_server<span class="params">(int<span class="params">(sys.argv[<span class="number">1</span>])</span>)</span></div><div class="line">    targets = list<span class="params">()</span></div><div class="line">    targets.append<span class="params">(Target<span class="params">(<span class="string">'flume'</span>, <span class="string">'haijun_flume_test1'</span>, <span class="string">'http://10.2.19.94:34545/metrics'</span>)</span>)</span></div><div class="line">    targets.append<span class="params">(Target<span class="params">(<span class="string">'spark_streaming'</span>, <span class="string">'h5_streaming_test1'</span>, <span class="string">'http://datanode02.will.com:8088/proxy/application_1501827559666_32228/metrics/json'</span>)</span>)</span></div><div class="line">    for target in targets:</div><div class="line">        REGISTRY.register<span class="params">(JsonCollector<span class="params">(target)</span>)</span></div><div class="line">    #REGISTRY.register<span class="params">(JsonCollector<span class="params">()</span>)</span></div><div class="line"></div><div class="line">    while True: time.sleep<span class="params">(<span class="number">10</span>)</span></div></pre></td></tr></table></figure>
<p>下面是爬取yarn中指定名称规范的运行中的app的简单示例代码。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> requests</div><div class="line"><span class="keyword">import</span> json</div><div class="line"><span class="keyword">import</span> re</div><div class="line"></div><div class="line"></div><div class="line">url = <span class="string">'http://datanode02.will.com:8088/ws/v1/cluster/apps?states=RUNNING'</span></div><div class="line">html_doc = requests.get(url).content</div><div class="line">result = json.loads(html_doc)</div><div class="line"><span class="keyword">for</span> app <span class="keyword">in</span> result[<span class="string">'apps'</span>][<span class="string">'app'</span>]:</div><div class="line">    <span class="keyword">if</span> re.match(<span class="string">'.*_online'</span>, app[<span class="string">'name'</span>]): </div><div class="line">        print(app[<span class="string">'name'</span>], app[<span class="string">'trackingUrl'</span>] + <span class="string">'metrics/json'</span>)</div></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Quota]]></title>
      <url>/2017/07/28/Quota/</url>
      <content type="html"><![CDATA[<p>在mesos上运行多个framework的时候有个问题，就是如果当前没有其他framework接受剩余资源，默认的WDRF分配器可能会把剩余资源分配给已经满足公平共享的framework。并没有把剩余资源留下备用的机制。尽管dynamic reservations允许operator和framework可在指定的mesos agent上动态保留资源，但是并不能从根本上解决问题，因为每个agent都可能挂掉。</p>
<p>Mesos 0.27提出了quota，用来保证一个role会获取指定大小的最小资源保留。当然，这个role也可以获得比这个quota配置的更多的资源。</p>
<p>quota有些类似reserved resource，稍有不同。quota资源不能绑定到指定的agent上，就是说一个quota保证一个role会有指定大小的资源，但是可以是在集群的任意位置。然而 reservations是用来指定特定的资源给指定role的特定的agent使用。quota只能让operator通过HTTP终端进行配置，而dynamic reservations则可以通过framework的principal验证后进行控制。</p>
<p>注意：reserved reservations是用来满足一个role的quota配置的。例如，如果一个role指定定了一个4CPU和一个agent上的2个CPU的reserved reservations。那么这个role有一个4CPU的最小保证，而不是6个。</p>
<h2 id="Terminology【术语】"><a href="#Terminology【术语】" class="headerlink" title="Terminology【术语】"></a>Terminology【术语】</h2><p>operator是一个管理mesos集群的东西，可以是人，工具，或者脚本。</p>
<p>在计算机领域，quota通常指下面的事情：</p>
<ul>
<li>一个最小保证</li>
<li>一个最大范围</li>
<li>以上两者</li>
</ul>
<p>在mesos中，quota是一个role即将游泳的资源的最小保证。</p>
<h2 id="动力和限制"><a href="#动力和限制" class="headerlink" title="动力和限制"></a>动力和限制</h2><p>通过下面场景，进一步了解quota。</p>
<h4 id="场景1：-贪婪framework"><a href="#场景1：-贪婪framework" class="headerlink" title="场景1： 贪婪framework"></a>场景1： 贪婪framework</h4><p>在一个集群中有两个framework，每个都订阅了自己特有的role，每个role都有相同的权重。frameworkA定于了role RA，frameworkB订阅了role RB。集群中只有一种单一资源：100CPU. fA只需要10个CPU，而FB需要全部的CPU。如果没有Quota的话，FA就会根据默认的公平调度，每个framework都50个CPU，那么就会有40个是浪费的。</p>
<h4 id="场景2：-新framework的资源"><a href="#场景2：-新framework的资源" class="headerlink" title="场景2： 新framework的资源"></a>场景2： 新framework的资源</h4><p>贪婪framework FB订阅role RB，是当前集群唯一的framework，那么它就都占了100CPU.如果一个fa新加入进来，需要等待FB的任务完成后才能获取属于自己的50CPU资源。</p>
<p>对于场景2来说，quota自己是不足以解决这个问题的，然而可以一直保持一个资源池作为保留或者或者进行资源抢占。</p>
<h2 id="Operator-HTTP终端"><a href="#Operator-HTTP终端" class="headerlink" title="Operator HTTP终端"></a>Operator HTTP终端</h2><p>master的/quota HTTP终端使operator可以操控quota。目前是提供一种类REST接口，支持下面的操作：</p>
<ul>
<li>POST设置一个新的quota</li>
<li>DELETE 移除一个已经存在的quota</li>
<li>GET 查询当前的quota</li>
</ul>
<p>目前并不支持更新原有的quota，需要先删除，后添加。</p>
<h2 id="工作原理"><a href="#工作原理" class="headerlink" title="工作原理"></a>工作原理</h2><p>首先mesos master会处理quota相关的请求，然后allocator来实施quota。</p>
<p>要注意quota具体怎样被实施是依赖于你所使用的allocator的。还有就是实施过程中，可能会对正在运行的framework造成一些影响，因为要把资源重新分配一下。还有资源是只可扩展的资源，端口号这种不行….</p>
<h2 id="quota请求处理过程"><a href="#quota请求处理过程" class="headerlink" title="quota请求处理过程"></a>quota请求处理过程</h2><p>添加的过程</p>
<ol>
<li>认证</li>
<li>解析与验证request</li>
<li>如果开启了授权，就授权认证</li>
<li>运行capacity heuristic</li>
<li>存储quota</li>
<li>解除outstanding offer</li>
</ol>
<p>移除的过程</p>
<ol>
<li>认证</li>
<li>确认request有效性</li>
<li>鉴权</li>
<li>移除quota</li>
</ol>
<h4 id="capacity-heuristic检查"><a href="#capacity-heuristic检查" class="headerlink" title="capacity heuristic检查"></a>capacity heuristic检查</h4><p>配置错误的quota可能会导致所有的framework都分配不到资源。例如假设一个opetaror给不存在的role 设置了100CPU的quota，而当前集群只用100CPU.</p>
<p>为了防止这种极端情形的出现，mesos master会用一个capacity heuristic来检查quota是不是对于当前集群资源合理。这个heuristic会测试总的quota是不是超过了集群非静态保留的总资源。</p>
<blockquote>
<p>总资源 - 静态保留资源 》= 总资源 + quota request</p>
</blockquote>
<p>注意即便当前是有足够的资源的，但是agent随时可能挂掉，导致集群不能满足配置的quota的需求。</p>
<p>使用force标志可以让check通过，通常是因为operator知道后期会有新的资源加进来。</p>
<h4 id="接触outstanding-offer"><a href="#接触outstanding-offer" class="headerlink" title="接触outstanding offer"></a>接触outstanding offer</h4><p>设置新quota的过程中，master会接触outstanding offer。这避免了当前剩余的没有offer出去，但是很多分配出去给其他framework的资源还没有被使用，造成的资源不足情况。因此，按照下面规则解除outstanding offer：</p>
<ul>
<li>解除至少跟quota请求中一样多的资源</li>
<li>如果一个agent有一个offer需要被解除，那么这个agent的所有offer都会被解除。This is done in order to make the potential offer bigger, which increases the chances that a quota’ed framework will be able to use the offer.</li>
<li>尽可能多的解除当前quota的role的framework的offer。这会让每个订阅这个role的framework收到一个offer。</li>
</ul>
<h4 id="通过wDRF-Allocator实施"><a href="#通过wDRF-Allocator实施" class="headerlink" title="通过wDRF Allocator实施"></a>通过wDRF Allocator实施</h4><p>wDRF Allocator首先会根据quota设置的分配资源给role。如果所有的quota都满足了，就为剩余的role执行标准的wDRF。</p>
<p>注意： 一个已经quota的role不会会获取到多一些的未被预定的不可撤销的资源。如果这个role中framework没有选择可撤销的资源，那么他们可能会在role满足之后停止获取offer。这时设置任何比这个role的fair share还低的quota值都很可能导致给这个role的总资源降低。</p>
<p>注意：当前auota保证也是一个quota限制。就是说，一旦一个role的quota满足了，这个role就不会获得更多的资源了。这是为了减轻缺乏quota限制。</p>
<p>如果有多个framework订阅了一个role，这个role有一个quota，标准的wDRF算法来决定这些framework的offer比例。</p>
<p>默认的wDRF allocator认为只有不可撤销的资源才是quota可用的。</p>
<h2 id="容灾"><a href="#容灾" class="headerlink" title="容灾"></a>容灾</h2><p>如果一个role里有quota，master容灾恢复就很重要。在恢复过程中会有一段时间并不是所有的agent都向master注册了自己。因此不可能所有的quota都被满足。</p>
<p>为了定位这个问题，如果恢复的时候任何前面的quota被探测到后，allocator就进入recovery模式，在这个过程中，allocator并不保证offer。只有满足下面任何一个条件的时候才退出这个模式</p>
<ul>
<li>指定数量的agent重新注册自己(默认80%)</li>
<li>一个超时时间(默认10分钟)</li>
</ul>
<h2 id="当前不足"><a href="#当前不足" class="headerlink" title="当前不足"></a>当前不足</h2><ul>
<li>quota不允许指定详细资源粒度(例如每个节点上10个CPU)</li>
<li>不允许指定约束条件(比如，在互斥节点上分配2 * 5个CPU，形成HA)</li>
<li>不能为默认的role *设置quota</li>
<li>目前不支持更新</li>
</ul>
<p>参考： <a href="http://mesos.apache.org/documentation/latest/quota/" target="_blank" rel="external">http://mesos.apache.org/documentation/latest/quota/</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[阿里中间件笔记]]></title>
      <url>/2017/07/27/%E9%98%BF%E9%87%8C%E4%B8%AD%E9%97%B4%E4%BB%B6%E7%AC%94%E8%AE%B0/</url>
      <content type="html"><![CDATA[<p>AliSQL：何登成</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ul>
<li>主从复制，数据一致性</li>
<li>HA依赖外部组件</li>
</ul>
<h2 id="解决【XCluster】"><a href="#解决【XCluster】" class="headerlink" title="解决【XCluster】"></a>解决【XCluster】</h2><p>基于paxos标准构建alisql集群</p>
<ul>
<li>高性能、可异地部署、网络抖动高容忍<ul>
<li>batching和pipelining，有了pipeline可以同个时间点传输多批数据，问题是乱序收取、日志空洞。等全部到来的时候再去处理，两外的方案是乱序也通过多数派确认提交。</li>
</ul>
</li>
<li>独立基础库，可单独部署【并不限于alisql使用】</li>
</ul>
<p>raft是不会出现日志空洞的，但是不能支持pipeline。poxos可以使用pipelining，但是会有乱序。</p>
<p>sysbench是一个模块化的、跨平台、多线程基准测试工具，主要用于评估测试各种不同系统参数下的数据库负载情况。</p>
<h2 id="HIStroe：阿里OLAP，-焦方飞"><a href="#HIStroe：阿里OLAP，-焦方飞" class="headerlink" title="HIStroe：阿里OLAP， 焦方飞"></a>HIStroe：阿里OLAP， 焦方飞</h2><p>MPP计算</p>
<p>知识网格的列式存储</p>
<p>存储：</p>
<p>succinct data</p>
<p>lsm  index</p>
<p>查询优化： 让更苛刻的条件优先执行</p>
<p>Hi-index原理，不需要解压数据就可以检索</p>
<h2 id="rocketMQ-万亿级数据洪峰下的消息引擎-冯嘉"><a href="#rocketMQ-万亿级数据洪峰下的消息引擎-冯嘉" class="headerlink" title="rocketMQ: 万亿级数据洪峰下的消息引擎 冯嘉"></a>rocketMQ: 万亿级数据洪峰下的消息引擎 冯嘉</h2>]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Roles]]></title>
      <url>/2017/07/25/Roles/</url>
      <content type="html"><![CDATA[<h2 id="role"><a href="#role" class="headerlink" title="role"></a>role</h2><p>好多host-level的OS(例如Linux，BSDs等)都支持多用户。同样的，mesos也是一个多用户集群管理系统，使用一个mesos集群管理一个组织的所有资源，服务于这个组织的用户。</p>
<p>mesos里与资源相关的东西如下：</p>
<ul>
<li>用户之间对于资源的公平共享</li>
<li>保证用户资源(优先级、隔离、限额等)</li>
<li>精确地资源计算能力<ul>
<li>分别有多少资源是 已分配/未分配等等</li>
<li>基于每个用户计算</li>
</ul>
</li>
</ul>
<p>在mesos中，我们为所有用户分配一个或多个role。其实，role就是mesos资源的消费者。这个消费者可以代表一个组织的一个用户，也可能是一个组、一个群、一个service，一个framework等等。</p>
<p>调度器会订阅一个或多个role，监听他们申请到的资源，然后执行调度任务。</p>
<p>下面是一些例子：</p>
<ul>
<li>保证一个role可以分配到指定的资源（通过quota指定）</li>
<li>保证个别agent上的一些或者所有资源都分配给一个指定的role(通过reservations)</li>
<li>保证资源是在role之间公平共享(通过DRF)</li>
<li>声明某些role获取相对更多的资源(通过weight)</li>
</ul>
<h2 id="role与acl"><a href="#role与acl" class="headerlink" title="role与acl"></a>role与acl</h2><p>有两种方式来控制一个framework应该订阅哪些role。首先，可以指定ACLs。其次，可以在mesos master启动的时候传递–roles参数，代表role的白名单，逗号隔开。注意在HA环境下，要保证多个master的启动白名单是一致的。</p>
<h2 id="role与framework的关联"><a href="#role与framework的关联" class="headerlink" title="role与framework的关联"></a>role与framework的关联</h2><p>framework通过制定FrameworkInfo里的roles订阅role。</p>
<p>作为用户，你可以在启动framework的时候指定要订阅哪些role。具体怎样弄需要看你的framework相关的接口是怎样的。例如，一个单用户的scheduler可能会通过–mesos_role参数指定，多用户的scheduerl就通过 –mesos_roles参数指定。或者也可以通过一个LDAP系统动态调整framwork和role之间的订阅关系。</p>
<h4 id="订阅多个role"><a href="#订阅多个role" class="headerlink" title="订阅多个role"></a>订阅多个role</h4><p>上面有提到，一个framework可以同时订阅多个role，通过MULTI_ROLE实现。</p>
<p>一个framework对外提供资源的时候，这些资源只能属于一个role。framework可以通过Offer对象的allocation_info.role字段来确认某个offer是提供给哪个role的，或者通过每个提供的Resource对象的allocation_info.role字段。（当前实现中，在一个Offer中的所有资源都是提供给同一个role的）</p>
<h4 id="同一个role的多个framework"><a href="#同一个role的多个framework" class="headerlink" title="同一个role的多个framework"></a>同一个role的多个framework</h4><p>多个framework可以订阅同一个role。例如：一个framework可以创建一个持久化的数据卷，然后往里面写数据。一旦这个写数据的任务完成后，这个数据卷就可以提供给订阅同一个role的其他的framewo使用了。第二个framework就可以读取前一个framework写的数据。</p>
<p>然而，配置多个framework使用同一个role的时候需要慎重一些，因为所有的framework都能够访问到这个role申请到的资源。例如，如果一个framework把一些敏感信息存到了数据卷中，其他的framework就可以读取了。类似地，如果一个framework创建了一个持久化的数据卷，其他framework可以直接偷走自己用来启动自己的任务。通常来说，订阅同一个role的framework之间是具有良好的协作关系的。</p>
<h2 id="资源与role的关系"><a href="#资源与role的关系" class="headerlink" title="资源与role的关系"></a>资源与role的关系</h2><p>资源通过reservation分配给一个role。资源可以永久静态地或者动态地提供给role使用。framework和operator可以指定一定量的资源作为某个role的最小持有量。</p>
<h2 id="默认的role"><a href="#默认的role" class="headerlink" title="默认的role"></a>默认的role</h2><p>名称为*的role是一个特殊的role。没有分配的资源是用这个*代表的。</p>
<p>对于没有提供FrameworkInfo.role的framework注册，会分配给他的就是*这个role。</p>
<h2 id="role与资源分配"><a href="#role与资源分配" class="headerlink" title="role与资源分配"></a>role与资源分配</h2><p>默认，mesos master使用基于权重的资源分配方式(weighted Dominant Resource Fairness)。 In particular, this implementation of wDRF first identifies which role is furthest below its fair share of the role’s dominant resource. 然后每个订阅这个role的framework就获取到返回的资源。</p>
<p>资源分配过程可以通过指定role的权重进行自定义控制。</p>
<h2 id="Role与quota"><a href="#Role与quota" class="headerlink" title="Role与quota"></a>Role与quota</h2><p>为了保证一个role能够分配到指定大小的资源，我们可以通过/quota终端指定quota。</p>
<p>资源分配者在公平分配剩余资源之前，会首先满足quota的需求。</p>
<h2 id="Role与Principal"><a href="#Role与Principal" class="headerlink" title="Role与Principal"></a>Role与Principal</h2><p>Principal代表一个与mesos互动的实体，更像是用户名。例如，framework在向mesos master注册的时候会提供principal，在使用HTTP终端的时候会提供principal。一个实体需要提供principal来认证自己的身份。</p>
<p>Role，仅仅用来控制资源分配。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[mesos的containerizer]]></title>
      <url>/2017/07/24/mesos%E7%9A%84containerizer/</url>
      <content type="html"><![CDATA[<h2 id="Docker-Containerizer"><a href="#Docker-Containerizer" class="headerlink" title="Docker Containerizer"></a>Docker Containerizer</h2><p>Docker containerizer使用dockers engine管理container。</p>
<h4 id="container启动过程"><a href="#container启动过程" class="headerlink" title="container启动过程"></a>container启动过程</h4><ul>
<li>Docker containerizer 在ContainerInfo::type为DOCKER的时候尝试在docker里启动task</li>
<li>Docker containerizer先pull image</li>
<li>调用pre-launch的hook</li>
<li>executor以下面两种方式启动起来<ul>
<li>mesos agent运行在一个docker container中<ul>
<li>这种方式需要提供–docker_mesos_image的参数。使用指定的docker image启动mesos agent</li>
<li>如果task包含自定义的executor，那么这个executor就在docker container中被启动</li>
<li>如果task并不包含executor。就是说它定义了一个command，默认的mesos-docker-executor就在docker container中通过docker Cli执行这个command。</li>
</ul>
</li>
<li>mesos agent不运行在docker container中<ul>
<li>如果task中包含自定义的executor，那么在docker container中执行</li>
<li>如果task不博阿涵自定义的executor，也就是定义了一个command，就fork一个子进程来执行默认的mesos-docker-executor. 然后mesos-docker-executor产生一个shell通过docker cli执行这个command。</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="Mesos-Containerizer"><a href="#Mesos-Containerizer" class="headerlink" title="Mesos Containerizer"></a>Mesos Containerizer</h2><p>Mesos Containerizer是原生的。Mesos Containerizer会处理所有没有制定ContainerInfo::DockerInfo的executor/task。</p>
<h4 id="container启动过程-1"><a href="#container启动过程-1" class="headerlink" title="container启动过程"></a>container启动过程</h4><ul>
<li>在每个isolator上调用prepare</li>
<li>使用Launcher fork出executor。在isolated之前，这个被fork出来的executor是不能执行的</li>
<li>Isolate这个executor。通过pid调用每个isolator的isolate方法</li>
<li>抽取executor</li>
<li>执行executor。就是上面的executor会获得执行的信号。先执行一些准备的命令，然后再执行executor的内容。</li>
</ul>
<h4 id="Launcher"><a href="#Launcher" class="headerlink" title="Launcher"></a>Launcher</h4><p>Launcher负责产生和销毁container。</p>
<ul>
<li>在containerizerd context中fork新的进程。这个子进程会执行给定路径的可执行文件，接受参数、flag和环境变量等。</li>
<li>子进程的IO会根据指定的方式进行重定向</li>
</ul>
<h6 id="linux-launcher"><a href="#linux-launcher" class="headerlink" title="linux launcher"></a>linux launcher</h6><ul>
<li>为container创建一个freezer 的cgroup</li>
<li>创建一个posix的pipe为host和container进程提供通信通道</li>
<li>使用系统的clone方法生成子进程(也就是container进程)</li>
<li>把新生成的container放进freezer的对应层级中</li>
<li>通过上面的pip给子进程一个signal，让它继续执行</li>
</ul>
<h6 id="Posix-launcher-TBD"><a href="#Posix-launcher-TBD" class="headerlink" title="Posix launcher (TBD)"></a>Posix launcher (TBD)</h6><h4 id="Isolators"><a href="#Isolators" class="headerlink" title="Isolators"></a>Isolators</h4><p>Isolator负责创建container中的运行环境【CPU, NETWORK, 存储，内存等】</p>
<h2 id="Containerizer-states"><a href="#Containerizer-states" class="headerlink" title="Containerizer states"></a>Containerizer states</h2><p>Docker</p>
<ul>
<li>FETCHING</li>
<li>PULLING</li>
<li>RUNNING</li>
<li>DESTROYING</li>
</ul>
<p>Mesos</p>
<ul>
<li>PREPARING</li>
<li>ISOLATING</li>
<li>FETCHING</li>
<li>RUNNING</li>
<li>DESTROYING</li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[docker内OS的相关事宜]]></title>
      <url>/2017/07/20/docker%E5%86%85OS%E7%9A%84%E7%9B%B8%E5%85%B3%E4%BA%8B%E5%AE%9C/</url>
      <content type="html"><![CDATA[<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>假设宿主机是centos7，然后docker镜像使用ubuntu16.04。</p>
<p>那么dockers容器在启动的时候是怎样运行ubuntu的，这种情境咋总是感觉跟启动虚拟机一样呢？</p>
<p>各种cgroup什么的还好理解，但是这些os内核它是怎样运作起来的呢？</p>
<h2 id="答案"><a href="#答案" class="headerlink" title="答案"></a>答案</h2><p>容器是依赖宿主机内核的，如果内核不能满足容器需求，就不能run。 这么看来，其实docker也不是那么“万能”的。</p>
<p>甚至如果容器里需要使用高版本内核的时候，宿主机不能支持，那么这个容器就run不起来………….理论上是这样，用的时候就要注意了。不知道这种docker是不是会自动下载这个内核，然后完全单独运行的话，其实本质上，真的和虚拟机差不多了</p>
<p>都独立内核了，ns和cg都不能用宿主机的了，那就是彻底的虚拟机了。</p>
<p>docker 和 传统的虚拟机的区别就是 ， 传统虚拟机假装有一套新的硬件，系统跑在硬件上就行了， docker 假装有一个系统，进程跑在系统里就行了，其实个人认为准确说，应该是docker假装有一个内核。</p>
<h2 id="翻译"><a href="#翻译" class="headerlink" title="翻译"></a>翻译</h2><p>docker最开始使用的是LXC，后来切换到了libcontainer。这样就可以跟宿主机共享操作系统资源。docker使用一种分层的文件系统AUFS，并且管理自己的网络。</p>
<p>AUFS是一个分层的文件系统，将只读的和可写的部分merge在一起。OS公用的地方是只读的，每个container自己挂载的是可写的。</p>
<p>假设我们有一个1g的image，需要1000个节点的扩容。如果使用一个完整的VM的话，需要1000G的空间。使用Docker的话，这1000个container节点可以共享1g的OS资源。</p>
<p>一个完整的VM拥有自己的一组资源，基本不共享什么东西。用重量换得了更多的独立性。Docker相反，独立性相对差一些，但是很轻量。所以可以在宿主机上跑上千个container。</p>
<p>一个完整的VM通常要花费几分钟才能启动，一个docker container则只需要几秒。</p>
<p>两个东西各有优缺点。</p>
<p>参考：</p>
<ul>
<li><a href="https://stackoverflow.com/questions/33112137/run-different-linux-os-in-docker-container" target="_blank" rel="external">https://stackoverflow.com/questions/33112137/run-different-linux-os-in-docker-container</a></li>
<li><a href="https://stackoverflow.com/questions/33112137/run-different-linux-os-in-docker-container" target="_blank" rel="external">https://stackoverflow.com/questions/33112137/run-different-linux-os-in-docker-container</a></li>
<li><a href="https://stackoverflow.com/questions/16047306/how-is-docker-different-from-a-normal-virtual-machine" target="_blank" rel="external">https://stackoverflow.com/questions/16047306/how-is-docker-different-from-a-normal-virtual-machine</a></li>
<li><a href="https://docs.docker.com/engine/faq/#what-is-different-between-a-docker-container-and-a-vm" target="_blank" rel="external">https://docs.docker.com/engine/faq/#what-is-different-between-a-docker-container-and-a-vm</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[使用portainer监控docker容器]]></title>
      <url>/2017/07/14/%E4%BD%BF%E7%94%A8portainer%E7%9B%91%E6%8E%A7docker%E5%AE%B9%E5%99%A8/</url>
      <content type="html"><![CDATA[<p>我们先监控一个远程的docker daemon，那么这个docker daemon先要允许远程访问才行。</p>
<p>修改113的配置文件/etc/docker/daemon.json<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;registry-mirrors&quot;: [&quot;https://docker.mirrors.ustc.edu.cn&quot;,&quot;http://3a35aff6.m.daocloud.io&quot;,&quot;http://ethanzhu.m.tenxcloud.net&quot;],</div><div class="line">  &quot;hosts&quot;: [&quot;tcp://0.0.0.0:2375&quot;]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注意，启用hosts，也就是远程接口之后，本地的命令行就不能用了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@etl03 ~]# docker images</div><div class="line">Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?</div><div class="line">[root@etl03 ~]# docker -H 0.0.0.0:2375 images</div><div class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">sso                 latest              f8fdedf3edca        13 hours ago        246MB</div><div class="line">centos              7.3.1611            67591570dd29        7 months ago        192MB</div></pre></td></tr></table></figure></p>
<p>在112上启动portainer<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -d -p 9000:9000 --rm -v /var/run/docker.sock:/var/run/docker.sock portainer/portainer</div></pre></td></tr></table></figure></p>
<p>如果要持久化一些配置文件的话，可以参考以下命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -d -p 9000:9000 -v /path/on/host/data:/data portainer/portainer</div></pre></td></tr></table></figure></p>
<p>配置初始密码，然后</p>
<p>参考：</p>
<ul>
<li><a href="https://docs.docker.com/engine/reference/commandline/dockerd/#extended-description" target="_blank" rel="external">https://docs.docker.com/engine/reference/commandline/dockerd/#extended-description</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[docker问题整理]]></title>
      <url>/2017/07/14/docker%E9%97%AE%E9%A2%98%E6%95%B4%E7%90%86/</url>
      <content type="html"><![CDATA[<h2 id="容器内ping不同外部宿主机"><a href="#容器内ping不同外部宿主机" class="headerlink" title="容器内ping不同外部宿主机"></a>容器内ping不同外部宿主机</h2><p>默认使用bridge网络，应该是通畅的。通常就是简单的防火墙导致，需要注意的是：<strong>调整防火墙之后，需要重启docker engine才能生效</strong>，仅仅重启docker容器是不会起作用的。。。。</p>
<h2 id="loopback-devices的告警"><a href="#loopback-devices的告警" class="headerlink" title="loopback devices的告警"></a>loopback devices的告警</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">WARNING: devicemapper: usage of loopback devices is strongly discouraged for production use.</div><div class="line">         Use `--storage-opt dm.thinpooldev` to specify a custom block storage device.</div><div class="line">WARNING: IPv4 forwarding is disabled</div><div class="line">WARNING: bridge-nf-call-iptables is disabled</div><div class="line">WARNING: bridge-nf-call-ip6tables is disabled</div></pre></td></tr></table></figure>
<p>参考</p>
<ul>
<li><a href="http://www.dockerinfo.net/2182.html" target="_blank" rel="external">http://www.dockerinfo.net/2182.html</a></li>
</ul>
<h2 id="容器名称变化"><a href="#容器名称变化" class="headerlink" title="容器名称变化"></a>容器名称变化</h2><p>主要是对于代理层，比如有三个backend服务节点，只要一重启，这三个容器的host和ip有可能都会变。</p>
<p>方案：</p>
<ul>
<li>代理 + 动态服务发现。nginx/haproxy + consul/etcd</li>
<li>traefix，专为此种场景提供了定制接口配置。</li>
</ul>
<p>参考： </p>
<ul>
<li><a href="http://blog.hypriot.com/post/microservices-bliss-with-docker-and-traefik/" target="_blank" rel="external">http://blog.hypriot.com/post/microservices-bliss-with-docker-and-traefik/</a></li>
<li><a href="https://www.consul.io/intro/getting-started/install.html" target="_blank" rel="external">https://www.consul.io/intro/getting-started/install.html</a></li>
</ul>
<h2 id="devicemapper-Can’t-set-cookie-dm-task-set-cookie-failed"><a href="#devicemapper-Can’t-set-cookie-dm-task-set-cookie-failed" class="headerlink" title="devicemapper: Can’t set cookie dm_task_set_cookie failed"></a>devicemapper: Can’t set cookie dm_task_set_cookie failed</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker: failed to register layer: devmapper: Error activating devmapper device for &apos;24ea1e709520627a2862d2b9130b6aff77dde03fef39cc0169568cde5883b013&apos;: devicemapper: Can&apos;t set cookie dm_task_set_cookie failed.</div></pre></td></tr></table></figure>
<p>问题貌似是在我重新启动</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Error response from daemon: driver &quot;devicemapper&quot; failed to remove root filesystem for 1d7c4b287c27ef61fd0d9ac37c401c5da213b81b31dcc42448b1864b6b838f14: failed to remove device f45fd625ac4cdaccddfdd0ea02ac97f9e529a13594a4cfc92a883b8674d2658a: devicemapper: Can not set cookie: dm_task_set_cookie failed</div></pre></td></tr></table></figure>
<p>临时方案：echo ‘y’ | sudo dmsetup udevcomplete_all<br><a href="https://github.com/kubevirt/kubevirt/issues/321" target="_blank" rel="external">https://github.com/kubevirt/kubevirt/issues/321</a></p>
<h2 id="动态配置"><a href="#动态配置" class="headerlink" title="动态配置"></a>动态配置</h2><p>一共有三个方案可以支持</p>
<h4 id="使用自定义的DNS服务器"><a href="#使用自定义的DNS服务器" class="headerlink" title="使用自定义的DNS服务器"></a>使用自定义的DNS服务器</h4><p>这个方案仅仅是应对容器内需要访问容器外的其他机器的host时起作用，如果还需要变化其他配置，那么可以忽略掉</p>
<h4 id="使用env或者env文件"><a href="#使用env或者env文件" class="headerlink" title="使用env或者env文件"></a>使用env或者env文件</h4><ol>
<li>首先要把应用依赖的外部配置从代码里面抽出来，做成配置文件</li>
<li>容器启动的时候，执行一个自定义脚本，脚本内容就是从容器系统环境变量里面读取环境变量，然后用sed替换配置文件里面的配置</li>
<li>那么在docker run启动容器的阶段，通过-e选项传递你的配置值到容器的环境变量，就能修改容器内应用的配置</li>
<li>迁移到其他环境，修改docker run -e的环境变量配置就OK</li>
</ol>
<h4 id="直接使用-v挂载不同环境的配置文件"><a href="#直接使用-v挂载不同环境的配置文件" class="headerlink" title="直接使用-v挂载不同环境的配置文件"></a>直接使用-v挂载不同环境的配置文件</h4><p>这种与第二种本质上没有太大区别。但是关键在于env或者env文件是在client端的，而-v挂载目录是需要在server端的。也就是是说每个server都需要有那个目录或者文件才行，而env方式的话，就只需要client端有就可以了。</p>
<p>鉴于server端一般是多于client端的，所以选用env的会相对多一些。</p>
<h2 id="网络"><a href="#网络" class="headerlink" title="网络"></a>网络</h2><p>docker attach容器后，退出的时候ctrl + q</p>
<h4 id="docker默认的docker0"><a href="#docker默认的docker0" class="headerlink" title="docker默认的docker0"></a>docker默认的docker0</h4><p>bridge是不支持服务发现的，也就在这个网络里的docker容器相互之间并不能通过名称通信。<br>要支持服务发现的话，需要自定义一个bridge网络。</p>
<p>只有swarm service可以连到overylay网络，独立的容器是连不上的。</p>
<p>docker是会动态修改宿主机的iptables规则的。</p>
<p>参考： <a href="https://docs.docker.com/engine/userguide/networking/" target="_blank" rel="external">https://docs.docker.com/engine/userguide/networking/</a></p>
<h2 id="关闭防火墙引起的问题"><a href="#关闭防火墙引起的问题" class="headerlink" title="关闭防火墙引起的问题"></a>关闭防火墙引起的问题</h2><p>在dockerd运行的时候，关闭防火墙的话，会清空iptables里的docker相关规则，导致docker容器启动失败。</p>
<p>centos7, docker ce17</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables: No chain/target/match by that name</div></pre></td></tr></table></figure>
<p>解决办法，在关闭防火墙之后再启动dockerd，或者重启dockerd，它会自己根据现有docker网络和容器重建iptables相关规则。</p>
<h2 id="devicemapper-Can-not-set-cookie-dm-task-set-cookie-failed"><a href="#devicemapper-Can-not-set-cookie-dm-task-set-cookie-failed" class="headerlink" title="devicemapper: Can not set cookie: dm_task_set_cookie failed"></a>devicemapper: Can not set cookie: dm_task_set_cookie failed</h2><p>重命名container名称导致。</p>
<p>解决：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo &apos;y&apos; | sudo dmsetup udevcomplete_all</div></pre></td></tr></table></figure></p>
<p>最好能执行<code>docker rm $(docker ps -a -q)</code>把现有container都移除。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[centos7-搭建DNS服务器]]></title>
      <url>/2017/07/12/centos7-%E6%90%AD%E5%BB%BADNS%E6%9C%8D%E5%8A%A1%E5%99%A8/</url>
      <content type="html"><![CDATA[<h2 id="主服务器"><a href="#主服务器" class="headerlink" title="主服务器"></a>主服务器</h2><h4 id="安装bind9"><a href="#安装bind9" class="headerlink" title="安装bind9"></a>安装bind9</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install bind bind-utils -y</div></pre></td></tr></table></figure>
<h4 id="编辑-etc-named-conf"><a href="#编辑-etc-named-conf" class="headerlink" title="编辑/etc/named.conf"></a>编辑/etc/named.conf</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">options &#123;</div><div class="line">    listen-on port 53 &#123; any; &#125;;</div><div class="line">	listen-on-v6 port 53 &#123; ::1; &#125;;</div><div class="line">	directory 	&quot;/var/named&quot;;</div><div class="line">	dump-file 	&quot;/var/named/data/cache_dump.db&quot;;</div><div class="line">	statistics-file &quot;/var/named/data/named_stats.txt&quot;;</div><div class="line">	memstatistics-file &quot;/var/named/data/named_mem_stats.txt&quot;;</div><div class="line">	allow-query     &#123; any; &#125;;</div><div class="line">	allow-transfer&#123; localhost; 10.2.19.113; &#125;;</div><div class="line"></div><div class="line">......</div><div class="line">...</div><div class="line"></div><div class="line">zone &quot;will.com&quot; IN &#123;</div><div class="line">type master;</div><div class="line">file &quot;forward.unixmen&quot;;</div><div class="line">allow-update &#123; none; &#125;;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">zone &quot;19.2.10.in-addr.arpa&quot; IN &#123;</div><div class="line">type master;</div><div class="line">file &quot;reverse.unixmen&quot;;</div><div class="line">allow-update &#123; none; &#125;;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="创建上面我们配置的zone文件"><a href="#创建上面我们配置的zone文件" class="headerlink" title="创建上面我们配置的zone文件"></a>创建上面我们配置的zone文件</h4><p>vi /var/named/forward.unixmen<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">$TTL 86400</div><div class="line">@   IN  SOA     etl02.will.com. root.will.com. (</div><div class="line">        2017071001  ;Serial</div><div class="line">        3600        ;Refresh</div><div class="line">        1800        ;Retry</div><div class="line">        604800      ;Expire</div><div class="line">        86400       ;Minimum TTL</div><div class="line">)</div><div class="line">@       IN  NS          etl02.will.com.</div><div class="line">@       IN  NS          etl03.will.com.</div><div class="line">@       IN  NS          schedule.will.com.</div><div class="line">@       IN  A           10.2.19.112</div><div class="line">@       IN  A           10.2.19.113</div><div class="line">@       IN  A           10.2.19.62</div><div class="line">etl02       IN  A   10.2.19.112</div><div class="line">etl03    IN  A   10.2.19.113</div><div class="line">schedule    IN  A   10.2.19.62</div></pre></td></tr></table></figure></p>
<p>检查配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@etl02 ~]# named-checkzone will.com /var/named/forward.unixmen</div><div class="line">zone will.com/IN: loaded serial 2017071001</div><div class="line">OK</div></pre></td></tr></table></figure></p>
<p>vi /var/named/reverse.unixmen<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">$TTL 86400</div><div class="line">@   IN  SOA     etl02.will.com. root.will.com. (</div><div class="line">        2017071001  ;Serial</div><div class="line">        3600        ;Refresh</div><div class="line">        1800        ;Retry</div><div class="line">        604800      ;Expire</div><div class="line">        86400       ;Minimum TTL</div><div class="line">)</div><div class="line">@       IN  NS          etl02.will.com.</div><div class="line">@       IN  NS          etl03.will.com.</div><div class="line">@       IN  NS          schedule.will.com.</div><div class="line">@       IN  PTR         will.com.</div><div class="line">etl02       IN  A   10.2.19.112</div><div class="line">etl03    IN  A   10.2.19.113</div><div class="line">schedule    IN  A   10.2.19.62</div><div class="line">62     IN  PTR         schedule.will.com.</div><div class="line">112     IN  PTR         etl02.will.com.</div><div class="line">113     IN  PTR         etl03.will.com.</div></pre></td></tr></table></figure></p>
<p>同样检查一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@etl02 ~]# named-checkzone will.com /var/named/reverse.unixmen </div><div class="line">zone will.com/IN: loaded serial 2017071001</div><div class="line">OK</div></pre></td></tr></table></figure></p>
<h2 id="启动DNS服务"><a href="#启动DNS服务" class="headerlink" title="启动DNS服务"></a>启动DNS服务</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">systemctl enable named</div><div class="line">systemctl start named</div></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><ol>
<li>编辑/etc/resolv.conf文件, 修改nameserver为etl02.will.com</li>
<li>编辑网卡配置文件/etc/sysconfig/network-scripts/ifcfg-eth0, 修改DNS为我们的DNS服务器地址10.2.19.112</li>
<li>重启网络服务：systemctl restart network</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">[root@etl02 ~]# dig etl02.will.com</div><div class="line"></div><div class="line">; &lt;&lt;&gt;&gt; DiG 9.9.4-RedHat-9.9.4-50.el7_3.1 &lt;&lt;&gt;&gt; etl02.will.com</div><div class="line">;; global options: +cmd</div><div class="line">;; Got answer:</div><div class="line">;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 48492</div><div class="line">;; flags: qr aa rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 3, ADDITIONAL: 3</div><div class="line"></div><div class="line">;; OPT PSEUDOSECTION:</div><div class="line">; EDNS: version: 0, flags:; udp: 4096</div><div class="line">;; QUESTION SECTION:</div><div class="line">;etl02.will.com.		IN	A</div><div class="line"></div><div class="line">;; ANSWER SECTION:</div><div class="line">etl02.will.com.	86400	IN	A	10.2.19.112</div><div class="line"></div><div class="line">;; AUTHORITY SECTION:</div><div class="line">will.com.		86400	IN	NS	etl02.will.com.</div><div class="line">will.com.		86400	IN	NS	schedule.will.com.</div><div class="line">will.com.		86400	IN	NS	etl03.will.com.</div><div class="line"></div><div class="line">;; ADDITIONAL SECTION:</div><div class="line">etl03.will.com.	86400	IN	A	10.2.19.113</div><div class="line">schedule.will.com.	86400	IN	A	10.2.19.62</div><div class="line"></div><div class="line">;; Query time: 0 msec</div><div class="line">;; SERVER: 127.0.0.1#53(127.0.0.1)</div><div class="line">;; WHEN: Fri Jul 14 11:52:31 EDT 2017</div><div class="line">;; MSG SIZE  rcvd: 150</div></pre></td></tr></table></figure>
<p>参考：<a href="https://www.unixmen.com/setting-dns-server-centos-7/" target="_blank" rel="external">https://www.unixmen.com/setting-dns-server-centos-7/</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[自如爬虫]]></title>
      <url>/2017/07/04/%E8%87%AA%E5%A6%82%E7%88%AC%E8%99%AB/</url>
      <content type="html"><![CDATA[<p>筛选房源的URL</p>
<p>筛选的是北土城的房子：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">https://phoenix.ziroom.com/v7/room/list.json?uid=0&amp;os=android%3A4.2.2&amp;suggestion_type=3&amp;model=HTC+One+X+-+4.2.2+-+API+17+-+720x1280&amp;sort=2&amp;suggestion_value=%E5%8C%97%E5%9C%9F%E5%9F%8E&amp;imei=000000000000000&amp;app_version=5.2.7&amp;network=WIFI&amp;ip=10.0.3.15&amp;size=10&amp;sign=fed60ace709254dbe7ca5b471ea8bb62&amp;timestamp=1499155383&amp;price=%2C&amp;page=1&amp;sign_open=1&amp;city_code=110000</div><div class="line"></div><div class="line">-- 下拉一页面</div><div class="line">https://phoenix.ziroom.com/v7/room/list.json?uid=0&amp;os=android%3A4.2.2&amp;suggestion_type=3&amp;model=HTC+One+X+-+4.2.2+-+API+17+-+720x1280&amp;sort=2&amp;suggestion_value=%E5%8C%97%E5%9C%9F%E5%9F%8E&amp;imei=000000000000000&amp;app_version=5.2.7&amp;network=WIFI&amp;ip=10.0.3.15&amp;size=10&amp;sign=924565090bc8a24dfd8f9dd07e04f4af&amp;timestamp=1499155456&amp;price=%2C&amp;page=2&amp;sign_open=1&amp;city_code=110000</div><div class="line"></div><div class="line">-- 下拉一页面</div><div class="line">https://phoenix.ziroom.com/v7/room/list.json?uid=0&amp;os=android%3A4.2.2&amp;suggestion_type=3&amp;model=HTC+One+X+-+4.2.2+-+API+17+-+720x1280&amp;sort=2&amp;suggestion_value=%E5%8C%97%E5%9C%9F%E5%9F%8E&amp;imei=000000000000000&amp;app_version=5.2.7&amp;network=WIFI&amp;ip=10.0.3.15&amp;size=10&amp;sign=2d87dcd80f06daf1b967b9b445fb302e&amp;timestamp=1499155491&amp;price=%2C&amp;page=3&amp;sign_open=1&amp;city_code=110000</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">uid	0</div><div class="line">os	android:4.2.2</div><div class="line">suggestion_type	3</div><div class="line">model	HTC One X - 4.2.2 - API 17 - 720x1280</div><div class="line">sort	2</div><div class="line">suggestion_value	北土城</div><div class="line">imei	000000000000000</div><div class="line">app_version	5.2.7</div><div class="line">network	WIFI</div><div class="line">ip	10.0.3.15</div><div class="line">size	10</div><div class="line">sign	fed60ace709254dbe7ca5b471ea8bb62</div><div class="line">timestamp	1499155383</div><div class="line">price	,</div><div class="line">page	1</div><div class="line">sign_open	1</div><div class="line">city_code	110000</div></pre></td></tr></table></figure>
<p>房子详情页<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">https://phoenix.ziroom.com/v7/room/detail.json?sign=a97bdae17004d4c9bc535068316b2185&amp;uid=0&amp;timestamp=1499155557&amp;id=146610&amp;os=android%3A4.2.2&amp;model=HTC+One+X+-+4.2.2+-+API+17+-+720x1280&amp;imei=000000000000000&amp;app_version=5.2.7&amp;sign_open=1&amp;city_code=110000&amp;house_id=20624&amp;network=WIFI&amp;ip=10.0.3.15</div></pre></td></tr></table></figure></p>
<p>可视化一下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">sign	a97bdae17004d4c9bc535068316b2185</div><div class="line">uid	0</div><div class="line">timestamp	1499155557</div><div class="line">id	146610</div><div class="line">os	android:4.2.2</div><div class="line">model	HTC One X - 4.2.2 - API 17 - 720x1280</div><div class="line">imei	000000000000000</div><div class="line">app_version	5.2.7</div><div class="line">sign_open	1</div><div class="line">city_code	110000</div><div class="line">house_id	20624</div><div class="line">network	WIFI</div><div class="line">ip	10.0.3.15</div></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[pyenv多版本安装]]></title>
      <url>/2017/07/04/pyenv%E5%A4%9A%E7%89%88%E6%9C%AC%E5%AE%89%E8%A3%85/</url>
      <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">yum install -y git python-pip</div><div class="line">git clone https://github.com/pyenv/pyenv.git ~/.pyenv</div><div class="line">echo &apos;export PYENV_ROOT=&quot;$HOME/.pyenv&quot;&apos; &gt;&gt; ~/.bash_profile</div><div class="line">echo &apos;export PATH=&quot;$PYENV_ROOT/bin:$PATH&quot;&apos; &gt;&gt; ~/.bash_profile</div><div class="line">echo &apos;eval &quot;$(pyenv init -)&quot;&apos; &gt;&gt; ~/.bash_profile</div><div class="line"> yum install readline readline-devel readline-static openssl openssl-devel openssl-static sqlite-devel bzip2-devel bzip2-libs -y</div><div class="line"> pyenv install 3.6.1</div><div class="line"> git clone https://github.com/pyenv/pyenv-virtualenv.git $(pyenv root)/plugins/pyenv-virtualenv</div><div class="line"> pyenv shell 3.6.1</div><div class="line"> echo &apos;eval &quot;$(pyenv virtualenv-init -)&quot;&apos; &gt;&gt; ~/.bash_profile</div><div class="line"> pyenv virtualenv 3.6.1 will_3.6.1</div></pre></td></tr></table></figure>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">pyenv versions</div><div class="line"></div><div class="line">pyenv activate  will_3.6.1</div></pre></td></tr></table></figure>
<p> 安装加速: 提前下载好对应python版本的tar.zx包，放到~/.pyenv/cache/下，然后再运行 pyenv install 3.6.1</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[RunningData执行用户迁移计划]]></title>
      <url>/2017/07/03/RunningData%E6%89%A7%E8%A1%8C%E7%94%A8%E6%88%B7%E8%BF%81%E7%A7%BB%E8%AE%A1%E5%88%92/</url>
      <content type="html"><![CDATA[<h2 id="超级用户准备"><a href="#超级用户准备" class="headerlink" title="超级用户准备"></a>超级用户准备</h2><ul>
<li>jlc</li>
<li>wplan</li>
<li>xiaov</li>
</ul>
<h2 id="文件权限"><a href="#文件权限" class="headerlink" title="文件权限"></a>文件权限</h2><h4 id="HDFS"><a href="#HDFS" class="headerlink" title="HDFS"></a>HDFS</h4><ul>
<li>所有数仓调整owner为所在事业部的超级用户<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">hdfs dfs -chown jlc:jlc -R /log/statistics</div><div class="line"></div><div class="line"></div><div class="line">hdfs dfs -ls /apps/hive/warehouse/ | awk &apos;&#123;print(&quot;hdfs dfs -chown -R &quot;, $4, &quot;:&quot;,$4, $8)&#125;&apos;</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="本地"><a href="#本地" class="headerlink" title="本地"></a>本地</h4><table>
<thead>
<tr>
<th>名称</th>
<th>位置</th>
<th>操作q</th>
</tr>
</thead>
<tbody>
<tr>
<td>sqoop目录权限</td>
<td>/server/app/sqoop</td>
<td>rm -vfr /server/app/sqoop/vo</td>
</tr>
<tr>
<td></td>
<td></td>
<td>/server/metamap/metamap_django</td>
<td>/server/metamap/metamap_django/*.java</td>
</tr>
</tbody>
</table>
<h2 id="azkaban执行用户"><a href="#azkaban执行用户" class="headerlink" title="azkaban执行用户"></a>azkaban执行用户</h2><ul>
<li>sqoop</li>
<li>hive</li>
</ul>
<p>需要修改M2H，H2H，H2M以及新版本的generate_job_file里的执行用户，包含两个地方</p>
<ul>
<li>生成执行脚本</li>
<li>生成命令【测试执行】</li>
</ul>
<p>在settings文件中添加参数USE_ROOT</p>
<h2 id="jenkins调度"><a href="#jenkins调度" class="headerlink" title="jenkins调度"></a>jenkins调度</h2><p>资产匹配问题: 62远程调用106上的脚步任务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Message from syslogd@datanode17 at Jul  3 15:50:52 ...</div><div class="line"> kernel:BUG: soft lockup - CPU#7 stuck for 67s! [python:2708]</div></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[关于kylin分时段merge之后体积变小]]></title>
      <url>/2017/06/26/%E5%85%B3%E4%BA%8Ekylin%E5%88%86%E6%97%B6%E6%AE%B5merge%E4%B9%8B%E5%90%8E%E4%BD%93%E7%A7%AF%E5%8F%98%E5%B0%8F/</url>
      <content type="html"><![CDATA[<p>我们设置了一个cube，指定的mandatory dimension为create_year，问了一下，说是因为有按照年去查询指标的需求。</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>mandatory dimension: create_year</p>
<p>自动merge : 7天、28天</p>
<h2 id="现象"><a href="#现象" class="headerlink" title="现象"></a>现象</h2><p>merge之前单天的数据大小平均为3G，而单周的数据大小平均为11G。</p>
<p>就是说： <strong>merge完之后数据变小了</strong>！</p>
<p>那么为什么呢？</p>
<p>几个人想了好半天，终于有个同事想到了….就是因为对于不包含merge时间【一般是天】的所有其他维度的组合，都减少了6倍的大小。</p>
<p>那么，由此延伸，我们是可以将create_day设置为mandatory dimension的，这样每天的cube就会减少很多大小，merge以后也不会有对应的压缩。这样对于单天记录的体积会有很大压缩提升。。。</p>
<p>那么对于年指标的查询应该怎样处理呢？由于这种比较少，建议可以前端解决。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hbase频繁挂掉]]></title>
      <url>/2017/06/25/hbase%E9%A2%91%E7%B9%81%E6%8C%82%E6%8E%89/</url>
      <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">2017-06-25 09:42:34,262 ERROR [RS_OPEN_REGION-datanode20:16020-0] coprocessor.CoprocessorHost: The coprocessor org.apache.kylin.stora</div><div class="line">ge.hbase.cube.v2.coprocessor.endpoint.CubeVisitService threw org.apache.hadoop.ipc.RemoteException(org.apache.hadoop.ipc.StandbyExcep</div><div class="line">tion): Operation category READ is not supported in state standby</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">2017-06-25 09:42:34,336 FATAL [RS_OPEN_REGION-datanode20:16020-2] regionserver.HRegionServer: ABORTING region server datanode20.yinke</div><div class="line">r.com,16020,1498354685968: The coprocessor org.apache.kylin.storage.hbase.cube.v1.coprocessor.observer.AggregateRegionObserver threw </div><div class="line">org.apache.hadoop.ipc.RemoteException(org.apache.hadoop.ipc.StandbyException): Operation category READ is not supported in state stan</div><div class="line">dby</div><div class="line"></div><div class="line"></div><div class="line">2017-06-25 09:42:34,336 FATAL [RS_OPEN_REGION-datanode20:16020-2] regionserver.HRegionServer: RegionServer abort: loaded coprocessors are: [org.apache.hadoop.hbase.security.access.SecureBulkLoadEndpoint]</div><div class="line"></div><div class="line"></div><div class="line">2017-06-25 09:42:34,338 FATAL [RS_OPEN_REGION-datanode20:16020-0] regionserver.HRegionServer: ABORTING region server datanode20.will.com,16020,1498354685968: The coprocessor org.apache.kylin.storage.hbase.cube.v1.coprocessor.observer.AggregateRegionObserver threw org.apache.hadoop.ipc.RemoteException(org.apache.hadoop.ipc.StandbyException): Operation category READ is not supported in state standby</div><div class="line"></div><div class="line"></div><div class="line">2017-06-25 09:42:34,370 INFO  [RS_OPEN_REGION-datanode20:16020-1] regionserver.RegionCoprocessorHost: Loaded coprocessor org.apache.k</div><div class="line">ylin.storage.hbase.cube.v2.coprocessor.endpoint.CubeVisitService from HTD of KYLIN_4L40B34P11 successfully.</div><div class="line">2017-06-25 09:42:34,379 ERROR [RS_OPEN_REGION-datanode20:16020-2] handler.OpenRegionHandler: Failed open of region=KYLIN_HBWCQ5ZQR1,\</div><div class="line">x001,1494915979852.71f4a908f1e460ac95dfadcf5ab8ecfd., starting to roll back the global memstore size.</div><div class="line">2017-06-25 09:42:34,381 INFO  [RS_OPEN_REGION-datanode20:16020-2] coordination.ZkOpenRegionCoordination: Opening of region &#123;ENCODED =</div><div class="line">&gt; 71f4a908f1e460ac95dfadcf5ab8ecfd, NAME =&gt; &apos;KYLIN_HBWCQ5ZQR1,\x001,1494915979852.71f4a908f1e460ac95dfadcf5ab8ecfd.&apos;, STARTKEY =&gt; &apos;\x</div><div class="line">001&apos;, ENDKEY =&gt; &apos;\x002&apos;&#125; failed, transitioning from OPENING to FAILED_OPEN in ZK, expecting version 3</div><div class="line">2017-06-25 09:42:34,382 ERROR [RS_OPEN_REGION-datanode20:16020-0] handler.OpenRegionHandler: Failed open of region=KYLIN_HBWCQ5ZQR1,\</div><div class="line">x00\x15,1494915979852.c4940efcc8efa3f3a9b7c2a546a1d1f5., starting to roll back the global memstore size.</div><div class="line">org.apache.hadoop.ipc.RemoteException(org.apache.hadoop.ipc.StandbyException): Operation category READ is not supported in state stan</div><div class="line">dby</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">java.io.IOException: Cannot append; log is closed</div><div class="line">        at org.apache.hadoop.hbase.regionserver.wal.FSHLog.append(FSHLog.java:1223)</div><div class="line">        at org.apache.hadoop.hbase.regionserver.wal.WALUtil.writeRegionEventMarker(WALUtil.java:95)</div><div class="line">        at org.apache.hadoop.hbase.regionserver.HRegion.writeRegionOpenMarker(HRegion.java:978)</div><div class="line">        at org.apache.hadoop.hbase.regionserver.HRegion.openHRegion(HRegion.java:6335)</div><div class="line">        at org.apache.hadoop.hbase.regionserver.HRegion.openHRegion(HRegion.java:6289)</div><div class="line">        at org.apache.hadoop.hbase.regionserver.HRegion.openHRegion(HRegion.java:6260)</div><div class="line">        at org.apache.hadoop.hbase.regionserver.HRegion.openHRegion(HRegion.java:6216)</div><div class="line">        at org.apache.hadoop.hbase.regionserver.HRegion.openHRegion(HRegion.java:6167)</div><div class="line">        at org.apache.hadoop.hbase.regionserver.handler.OpenRegionHandler.openRegion(OpenRegionHandler.java:362)</div><div class="line">        ...............</div><div class="line">2017-06-25 09:42:44,168 INFO  [regionserver/datanode20.will.com/10.2.19.109:16020.logRoller] regionserver.LogRoller: LogRoller exit</div><div class="line">ing.</div><div class="line">2017-06-25 09:42:44,168 INFO  [regionserver/datanode20.will.com/10.2.19.109:16020] regionserver.CompactSplitThread: Waiting for Spl</div><div class="line">it Thread to finish...</div><div class="line">2017-06-25 09:42:44,168 INFO  [regionserver/datanode20.will.com/10.2.19.109:16020] regionserver.CompactSplitThread: Waiting for Mer</div><div class="line">ge Thread to finish...</div><div class="line">2017-06-25 09:42:44,168 INFO  [regionserver/datanode20.will.com/10.2.19.109:16020] regionserver.CompactSplitThread: Waiting for Lar</div><div class="line">ge Compaction Thread to finish...</div><div class="line">2017-06-25 09:42:44,168 INFO  [regionserver/datanode20.will.com/10.2.19.109:16020] regionserver.CompactSplitThread: Waiting for Sma</div><div class="line">ll Compaction Thread to finish...</div><div class="line">2017-06-25 09:42:44,170 INFO  [regionserver/datanode20.will.com/10.2.19.109:16020.leaseChecker] regionserver.Leases: regionserver/d</div><div class="line">atanode20.will.com/10.2.19.109:16020.leaseChecker closing leases</div><div class="line">2017-06-25 09:42:44,171 INFO  [regionserver/datanode20.will.com/10.2.19.109:16020.leaseChecker] regionserver.Leases: regionserver/d</div><div class="line">atanode20.will.com/10.2.19.109:16020.leaseChecker closed leases</div><div class="line">2017-06-25 09:42:44,183 INFO  [regionserver/datanode20.will.com/10.2.19.109:16020] ipc.RpcServer: Stopping server on 16020</div></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[NN-HA后引发的问题]]></title>
      <url>/2017/06/22/NN-HA%E5%90%8E%E5%BC%95%E5%8F%91%E7%9A%84%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<h6 id="最表面问题"><a href="#最表面问题" class="headerlink" title="最表面问题:"></a>最表面问题:</h6><p>几乎所有用户执行权限都出现问题。</p>
<h6 id="问题原因："><a href="#问题原因：" class="headerlink" title="问题原因："></a>问题原因：</h6><ul>
<li>所有HDFS之上的应用都是使用linux的posix文件权限控制</li>
<li>当Active NN是DN17的时候，DN17本机并没有这些用户的相关权限信息。<h6 id="解决方法："><a href="#解决方法：" class="headerlink" title="解决方法："></a>解决方法：</h6></li>
<li>尝试copyNN01的用户以及组信息到DN17<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">/etc/passwd</div><div class="line">/etc/shadow</div><div class="line"></div><div class="line"></div><div class="line">/etc/group</div><div class="line">/etc/gshadow</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">[root@namenode01 hdfs]# cat /etc/group | grep xiaov</div><div class="line">xiaov:x:1015:zhoujian,wangchenqi,zhangyuntao,wangxu,wanghao_fengkong,linzhixin,yangqiankun,tianye,zhaoyanchao,tinyv,wangyin,lihaoyue,zhuxiuwei,yangluan,qizhenpeng,zhanglining,xiaovtest,yanghuanyuzi,zhanghaigang,shichengjie,luanzhiwei,wangyasen,kangyimin,luiyahui,liuyahui,liulinyuan,caoyunqing,tianyang,chengyao,gezhao,hehaojun,hujunjie,liuwei,xiongpeng</div><div class="line">xiaovtest:x:1040:</div><div class="line">metastoremanager:x:1041:xiaovtest,wangchenqi</div></pre></td></tr></table></figure>
</li>
</ul>
<p>将上面所有的用户保存到另一台的xiaov文件中，然后执行下面的逻辑：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">for name in `cat xiaov | awk &apos;&#123;split($0, atr,&quot;,&quot;);   </div><div class="line"> </div><div class="line"> for (i=0;i&lt;length(atr);i++) &#123;</div><div class="line"> print(atr[i])</div><div class="line"> &#125;</div><div class="line"> &#125;&apos;`;</div><div class="line">do</div><div class="line">useradd $name -G xiaov</div><div class="line">done</div></pre></td></tr></table></figure></p>
<ul>
<li>使用fabric维护用户权限相关信息，每次都同时操作两台NN。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">-- fabric.py</div><div class="line"></div><div class="line">nns=(&apos;namenode01.will.com&apos;, &apos;datanode17.will.com&apos;)</div><div class="line"></div><div class="line">env.roledefs = &#123;</div><div class="line">    &apos;services&apos;: services,</div><div class="line">    &apos;datanodes&apos;: datanodes,</div><div class="line">    &apos;tmp&apos;: tmpnodes,</div><div class="line">    &apos;nns&apos;: nns</div><div class="line">&#125;</div><div class="line"></div><div class="line">------------------</div><div class="line"></div><div class="line">[root@datanode21 ~]# fab cmd:roles=nns,cmd=&quot;echo hello from `hostname`&quot;</div><div class="line">This text is green!</div><div class="line">This sentence is red, except for these words, which are green.</div><div class="line">[namenode01.will.com] Executing task &apos;cmd&apos;</div><div class="line">[namenode01.will.com] run: echo hello from datanode21.will.com</div><div class="line">[namenode01.will.com] out: hello from datanode21.will.com</div><div class="line">[namenode01.will.com] out: </div><div class="line"></div><div class="line">[datanode17.will.com] Executing task &apos;cmd&apos;</div><div class="line">[datanode17.will.com] run: echo hello from datanode21.will.com</div><div class="line">[datanode17.will.com] out: hello from datanode21.will.com</div><div class="line">[datanode17.will.com] out: </div><div class="line"></div><div class="line"></div><div class="line">Done.</div><div class="line">Disconnecting from datanode17.will.com... done.</div><div class="line">Disconnecting from namenode01.will.com... done</div></pre></td></tr></table></figure>
<h4 id="NN切换的相关日志"><a href="#NN切换的相关日志" class="headerlink" title="NN切换的相关日志"></a>NN切换的相关日志</h4><p>NN01的log。</p>
<p>出现这个错误后，NN自己直接shutdown<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">2017-06-15 22:35:35,329 WARN  client.QuorumJournalManager (QuorumCall.java:waitFor(134)) - Waited 18014 ms (timeout=20000 ms) for a r</div><div class="line">esponse for sendEdits. Succeeded so far: [10.2.19.121:8485]</div><div class="line">2017-06-15 22:35:36,331 WARN  client.QuorumJournalManager (QuorumCall.java:waitFor(134)) - Waited 19015 ms (timeout=20000 ms) for a r</div><div class="line">esponse for sendEdits. Succeeded so far: [10.2.19.121:8485]</div><div class="line">2017-06-15 22:35:37,317 FATAL namenode.FSEditLog (JournalSet.java:mapJournalsAndReportErrors(398)) - Error: flush failed for required</div><div class="line"> journal (JournalAndStream(mgr=QJM to [10.2.19.123:8485, 10.2.19.127:8485, 10.2.19.121:8485], stream=QuorumOutputStream starting at t</div><div class="line">xid 118442295))</div><div class="line">java.io.IOException: Timed out waiting 20000ms for a quorum of nodes to respond.</div><div class="line">        at org.apache.hadoop.hdfs.qjournal.client.AsyncLoggerSet.waitForWriteQuorum(AsyncLoggerSet.java:137)</div><div class="line">        at org.apache.hadoop.hdfs.qjournal.client.QuorumOutputStream.flushAndSync(QuorumOutputStream.java:107)</div><div class="line">        at org.apache.hadoop.hdfs.server.namenode.EditLogOutputStream.flush(EditLogOutputStream.java:113)</div><div class="line">        at org.apache.hadoop.hdfs.server.namenode.EditLogOutputStream.flush(EditLogOutputStream.java:107)</div><div class="line">        at org.apache.hadoop.hdfs.server.namenode.JournalSet$JournalSetOutputStream$8.apply(JournalSet.java:533)</div><div class="line">        at org.apache.hadoop.hdfs.server.namenode.JournalSet.mapJournalsAndReportErrors(JournalSet.java:393)</div><div class="line">        at org.apache.hadoop.hdfs.server.namenode.JournalSet.access$100(JournalSet.java:57)</div><div class="line">        at org.apache.hadoop.hdfs.server.namenode.JournalSet$JournalSetOutputStream.flush(JournalSet.java:529)</div><div class="line">        at org.apache.hadoop.hdfs.server.namenode.FSEditLog.logSync(FSEditLog.java:647)</div><div class="line">        at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.startFileInt(FSNamesystem.java:2512)</div><div class="line">        at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.startFile(FSNamesystem.java:2377)</div><div class="line">        at org.apache.hadoop.hdfs.server.namenode.NameNodeRpcServer.create(NameNodeRpcServer.java:708)</div><div class="line">        at org.apache.hadoop.hdfs.protocolPB.ClientNamenodeProtocolServerSideTranslatorPB.create(ClientNamenodeProtocolServerSideTran</div><div class="line">slatorPB.java:405)</div><div class="line">        at org.apache.hadoop.hdfs.protocol.proto.ClientNamenodeProtocolProtos$ClientNamenodeProtocol$2.callBlockingMethod(ClientNamen</div><div class="line">odeProtocolProtos.java)</div><div class="line">        at org.apache.hadoop.ipc.ProtobufRpcEngine$Server$ProtoBufRpcInvoker.call(ProtobufRpcEngine.java:616)</div><div class="line">        at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:969)</div><div class="line">        at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2206)</div><div class="line">        at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2202)</div><div class="line">        at java.security.AccessController.doPrivileged(Native Method)</div><div class="line">        at javax.security.auth.Subject.doAs(Subject.java:422)</div><div class="line">        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1709)</div><div class="line">        at org.apache.hadoop.ipc.Server$Handler.run(Server.java:2200)</div><div class="line">2017-06-15 22:35:37,318 WARN  client.QuorumJournalManager (QuorumOutputStream.java:abort(72)) - Aborting QuorumOutputStream starting </div><div class="line">at txid 118442295</div><div class="line">2017-06-15 22:35:37,337 INFO  BlockStateChange (BlockManager.java:computeReplicationWorkForBlocks(1531)) - BLOCK* neededReplications </div><div class="line">= 0, pendingReplications = 0.</div><div class="line">2017-06-15 22:35:37,342 INFO  util.ExitUtil (ExitUtil.java:terminate(124)) - Exiting with status 1</div><div class="line">2017-06-15 22:35:37,396 INFO  namenode.NameNode (LogAdapter.java:info(47)) - SHUTDOWN_MSG: </div><div class="line">/************************************************************</div><div class="line">SHUTDOWN_MSG: Shutting down NameNode at namenode01.will.com/10.2.19.72</div></pre></td></tr></table></figure></p>
<p>DN17的log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">2017-06-19 16:34:39,682 WARN  client.QuorumJournalManager (QuorumCall.java:waitFor(134)) - Waited 27324 ms (timeout=20000 ms) for a r</div><div class="line">esponse for selectInputStreams. No responses yet.</div><div class="line"></div><div class="line">.........</div><div class="line">2017-06-19 16:34:46,859 INFO  util.JvmPauseMonitor (JvmPauseMonitor.java:run(196)) - Detected pause in JVM or host machine (eg GC): p</div><div class="line">ause of approximately 6029ms</div><div class="line">No GCs detected</div><div class="line">2017-06-19 16:34:49,739 INFO  util.JvmPauseMonitor (JvmPauseMonitor.java:run(196)) - Detected pause in JVM or host machine (eg GC): p</div><div class="line">ause of approximately 2380ms</div><div class="line">No GCs detected</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">2017-06-26 13:39:04,029 INFO  ipc.Server (Server.java:doRead(891)) - Socket Reader #1 for port 8020: readAndProcess from client 10.2.</div><div class="line">19.83 threw exception [java.io.IOException: Connection reset by peer]</div><div class="line">java.io.IOException: Connection reset by peer</div><div class="line">        at sun.nio.ch.FileDispatcherImpl.read0(Native Method)</div><div class="line">        at sun.nio.ch.SocketDispatcher.read(SocketDispatcher.java:39)</div><div class="line">        at sun.nio.ch.IOUtil.readIntoNativeBuffer(IOUtil.java:223)</div><div class="line">        at sun.nio.ch.IOUtil.read(IOUtil.java:197)</div><div class="line">        at sun.nio.ch.SocketChannelImpl.read(SocketChannelImpl.java:380)</div><div class="line">        at org.apache.hadoop.ipc.Server.channelRead(Server.java:2773)</div><div class="line">        at org.apache.hadoop.ipc.Server.access$2800(Server.java:136)</div><div class="line">        at org.apache.hadoop.ipc.Server$Connection.readAndProcess(Server.java:1606)</div><div class="line">        at org.apache.hadoop.ipc.Server$Listener.doRead(Server.java:880)</div><div class="line">        at org.apache.hadoop.ipc.Server$Listener$Reader.doRunLoop(Server.java:746)</div><div class="line">        at org.apache.hadoop.ipc.Server$Listener$Reader.run(Server.java:717)</div><div class="line">2017-06-26 13:39:04,066 INFO  ipc.Server (Server.java:doRead(891)) - Socket Reader #1 for port 8020: readAndProcess from client 10.2.</div><div class="line">19.110 threw exception [java.io.IOException: Connection reset by peer]</div><div class="line">java.io.IOException: Connection reset by peer</div><div class="line">        at sun.nio.ch.FileDispatcherImpl.read0(Native Method)</div><div class="line">        at sun.nio.ch.SocketDispatcher.read(SocketDispatcher.java:39)</div><div class="line">        at sun.nio.ch.IOUtil.readIntoNativeBuffer(IOUtil.java:223)</div><div class="line">        at sun.nio.ch.IOUtil.read(IOUtil.java:197)</div><div class="line"></div><div class="line">.......</div><div class="line"></div><div class="line"></div><div class="line">2017-06-26 13:39:08,310 WARN  client.QuorumJournalManager (IPCLoggerChannel.java:call(406)) - Took 4136ms to send a batch of 3 edits (262 bytes) to remote journal 10.2.19.121:8485</div><div class="line">2017-06-26 13:39:08,310 WARN  client.QuorumJournalManager (IPCLoggerChannel.java:call(406)) - Took 4130ms to send a batch of 3 edits (262 bytes) to remote journal 10.2.19.123:8485</div><div class="line">2017-06-26 13:39:08,310 WARN  client.QuorumJournalManager (IPCLoggerChannel.java:call(388)) - Remote journal 10.2.19.127:8485 failed to write txns 134233020-134233022. Will try to write to this JN again after the next log roll.</div><div class="line">org.apache.hadoop.ipc.RemoteException(java.io.IOException): IPC&apos;s epoch 15 is less than the last promised epoch 16</div><div class="line">        at org.apache.hadoop.hdfs.qjournal.server.Journal.checkRequest(Journal.java:418)</div><div class="line">        at org.apache.hadoop.hdfs.qjournal.server.Journal.checkWriteRequest(Journal.java:446)</div><div class="line">        at org.apache.hadoop.hdfs.qjournal.server.Journal.journal(Journal.java:341)</div><div class="line">        at org.apache.hadoop.hdfs.qjournal.server.JournalNodeRpcServer.journal(JournalNodeRpcServer.java:148)</div><div class="line">        at org.apache.hadoop.hdfs.qjournal.protocolPB.QJournalProtocolServerSideTranslatorPB.journal(QJournalProtocolServerSideTranslatorPB.java:158)</div><div class="line">        at org.apache.hadoop.hdfs.qjournal.protocol.QJournalProtocolProtos$QJournalProtocolService$2.callBlockingMethod(QJournalProto</div><div class="line">colProtos.java:25421)</div><div class="line">        at org.apache.hadoop.ipc.ProtobufRpcEngine$Server$ProtoBufRpcInvoker.call(ProtobufRpcEngine.java:616)</div><div class="line">        at org.apache.hadoop.ipc.RPC$Server.call(RPC.java:969)</div><div class="line">        at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2206)</div><div class="line">        at org.apache.hadoop.ipc.Server$Handler$1.run(Server.java:2202)</div><div class="line">        at java.security.AccessController.doPrivileged(Native Method)</div><div class="line">        at javax.security.auth.Subject.doAs(Subject.java:422)</div><div class="line">        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1709)</div><div class="line">        at org.apache.hadoop.ipc.Server$Handler.run(Server.java:2200)</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">..........</div><div class="line"></div><div class="line">org.apache.hadoop.hdfs.qjournal.client.QuorumException: Got too many exceptions to achieve quorum size 2/3. 3 exceptions thrown:</div><div class="line">10.2.19.127:8485: IPC&apos;s epoch 15 is less than the last promised epoch 16</div></pre></td></tr></table></figure>
<p>又一次<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">2017-06-28 10:05:21,397 INFO  namenode.FSNamesystem (FSNamesystem.java:stopStandbyServices(1297)) - Stopping services started for standby state</div><div class="line">2017-06-28 10:05:21,398 WARN  ha.EditLogTailer (EditLogTailer.java:doWork(349)) - Edit log tailer interrupted</div><div class="line">java.lang.InterruptedException: sleep interrupted</div><div class="line">        at java.lang.Thread.sleep(Native Method)</div><div class="line">        at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$EditLogTailerThread.doWork(EditLogTailer.java:347)</div><div class="line">        at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$EditLogTailerThread.access$200(EditLogTailer.java:284)</div><div class="line">        at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$EditLogTailerThread$1.run(EditLogTailer.java:301)</div><div class="line">        at org.apache.hadoop.security.SecurityUtil.doAsLoginUserOrFatal(SecurityUtil.java:449)</div><div class="line">        at org.apache.hadoop.hdfs.server.namenode.ha.EditLogTailer$EditLogTailerThread.run(EditLogTailer.java:297)</div><div class="line">2017-06-28 10:05:21,403 INFO  namenode.FSNamesystem (FSNamesystem.java:startActiveServices(1098)) - Starting services required for active state</div></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[runningdatav2版本迁移计划]]></title>
      <url>/2017/06/13/RunningDataV2%E7%89%88%E6%9C%AC%E8%BF%81%E7%A7%BB%E8%AE%A1%E5%88%92/</url>
      <content type="html"><![CDATA[<h4 id="注意点"><a href="#注意点" class="headerlink" title="注意点"></a>注意点</h4><ul>
<li>编辑、更新<ul>
<li>各类ETL自动创建与之对应的ExecObj对象【重载save方法实现】</li>
<li>个别自动分析依赖的ETL同时新建或更新相关ExecBlood【H2H, H2M】</li>
<li>个别需要输入产出的ETL类型需要添加outputs字段，并在save的时候自创创建对应的NullETL对象【JAR】</li>
<li>根据自身特性创建自身的rel_name 【save的时候分析并添加上】</li>
</ul>
</li>
<li>调度相关<ul>
<li>(日月周)日常调度【完成依赖解析与任务文件生成，测试通过】</li>
<li>定时调度【执行部分使用既有方案】</li>
<li>临时调度【使用既有方案】</li>
<li>新建调度时，针对的对象应该是修改为ExecObj</li>
</ul>
</li>
</ul>
<h4 id="影响范围"><a href="#影响范围" class="headerlink" title="影响范围"></a>影响范围</h4><ul>
<li>整体过程中xstorm新建、编辑不可用</li>
<li>任务调度中间可能出现失败</li>
</ul>
<h4 id="实施步骤"><a href="#实施步骤" class="headerlink" title="实施步骤"></a>实施步骤</h4><ol>
<li>向各事业部发送不可用通知</li>
<li>数据库备份</li>
<li>确保新的save方法都已经注释掉,否则会影响清洗过程。</li>
<li>将数据库对应model字段全部添加上<blockquote>
<p>./manage.py migrate metamap 0052 –settings=metamap.config</p>
</blockquote>
</li>
</ol>
<p>可能需要手动添加exec_obj_id字段…【历史原因】<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="comment">--</span></div><div class="line"><span class="comment">-- Add field exec_obj to anaetl</span></div><div class="line"><span class="comment">--</span></div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`metamap_anaetl`</span> <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> <span class="string">`exec_obj_id`</span> <span class="built_in">integer</span> <span class="literal">NULL</span>;</div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`metamap_anaetl`</span> <span class="keyword">ALTER</span> <span class="keyword">COLUMN</span> <span class="string">`exec_obj_id`</span> <span class="keyword">DROP</span> <span class="keyword">DEFAULT</span>;</div><div class="line"><span class="comment">--</span></div><div class="line"><span class="comment">-- Add field exec_obj to etl</span></div><div class="line"><span class="comment">--</span></div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`metamap_etl`</span> <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> <span class="string">`exec_obj_id`</span> <span class="built_in">integer</span> <span class="literal">NULL</span>;</div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`metamap_etl`</span> <span class="keyword">ALTER</span> <span class="keyword">COLUMN</span> <span class="string">`exec_obj_id`</span> <span class="keyword">DROP</span> <span class="keyword">DEFAULT</span>;</div><div class="line"><span class="comment">--</span></div><div class="line"><span class="comment">-- Add field exec_obj to jarapp</span></div><div class="line"><span class="comment">--</span></div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`metamap_jarapp`</span> <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> <span class="string">`exec_obj_id`</span> <span class="built_in">integer</span> <span class="literal">NULL</span>;</div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`metamap_jarapp`</span> <span class="keyword">ALTER</span> <span class="keyword">COLUMN</span> <span class="string">`exec_obj_id`</span> <span class="keyword">DROP</span> <span class="keyword">DEFAULT</span>;</div><div class="line"><span class="comment">--</span></div><div class="line"><span class="comment">-- Add field exec_obj to sqoophive2mysql</span></div><div class="line"><span class="comment">--</span></div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`metamap_sqoophive2mysql`</span> <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> <span class="string">`exec_obj_id`</span> <span class="built_in">integer</span> <span class="literal">NULL</span>;</div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`metamap_sqoophive2mysql`</span> <span class="keyword">ALTER</span> <span class="keyword">COLUMN</span> <span class="string">`exec_obj_id`</span> <span class="keyword">DROP</span> <span class="keyword">DEFAULT</span>;</div><div class="line"><span class="comment">--</span></div><div class="line"><span class="comment">-- Add field exec_obj to sqoopmysql2hive</span></div><div class="line"><span class="comment">--</span></div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`metamap_sqoopmysql2hive`</span> <span class="keyword">ADD</span> <span class="keyword">COLUMN</span> <span class="string">`exec_obj_id`</span> <span class="built_in">integer</span> <span class="literal">NULL</span>;</div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`metamap_sqoopmysql2hive`</span> <span class="keyword">ALTER</span> <span class="keyword">COLUMN</span> <span class="string">`exec_obj_id`</span> <span class="keyword">DROP</span> <span class="keyword">DEFAULT</span>;</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> <span class="string">`metamap_anaetl_30a76f4d`</span> <span class="keyword">ON</span> <span class="string">`metamap_anaetl`</span> (<span class="string">`exec_obj_id`</span>);</div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`metamap_anaetl`</span> <span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> <span class="string">`metamap_anaetl_exec_obj_id_1bac03db_fk_metamap_execobj_id`</span> FOREIGN <span class="keyword">KEY</span> (<span class="string">`exec_obj_id`</span>) <span class="keyword">REFERENCES</span> <span class="string">`metamap_execobj`</span> (<span class="string">`id`</span>);</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> <span class="string">`metamap_etl_30a76f4d`</span> <span class="keyword">ON</span> <span class="string">`metamap_etl`</span> (<span class="string">`exec_obj_id`</span>);</div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`metamap_etl`</span> <span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> <span class="string">`metamap_etl_exec_obj_id_8c6a086a_fk_metamap_execobj_id`</span> FOREIGN <span class="keyword">KEY</span> (<span class="string">`exec_obj_id`</span>) <span class="keyword">REFERENCES</span> <span class="string">`metamap_execobj`</span> (<span class="string">`id`</span>);</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> <span class="string">`metamap_jarapp_30a76f4d`</span> <span class="keyword">ON</span> <span class="string">`metamap_jarapp`</span> (<span class="string">`exec_obj_id`</span>);</div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`metamap_jarapp`</span> <span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> <span class="string">`metamap_jarapp_exec_obj_id_6340f92e_fk_metamap_execobj_id`</span> FOREIGN <span class="keyword">KEY</span> (<span class="string">`exec_obj_id`</span>) <span class="keyword">REFERENCES</span> <span class="string">`metamap_execobj`</span> (<span class="string">`id`</span>);</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> <span class="string">`metamap_sqoophive2mysql_30a76f4d`</span> <span class="keyword">ON</span> <span class="string">`metamap_sqoophive2mysql`</span> (<span class="string">`exec_obj_id`</span>);</div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`metamap_sqoophive2mysql`</span> <span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> <span class="string">`metamap_sqoophive2mys_exec_obj_id_ee2cb5c2_fk_metamap_execobj_id`</span> FOREIGN <span class="keyword">KEY</span> (<span class="string">`exec_obj_id`</span>) <span class="keyword">REFERENCES</span> <span class="string">`metamap_execobj`</span> (<span class="string">`id`</span>);</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">INDEX</span> <span class="string">`metamap_sqoopmysql2hive_30a76f4d`</span> <span class="keyword">ON</span> <span class="string">`metamap_sqoopmysql2hive`</span> (<span class="string">`exec_obj_id`</span>);</div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> <span class="string">`metamap_sqoopmysql2hive`</span> <span class="keyword">ADD</span> <span class="keyword">CONSTRAINT</span> <span class="string">`metamap_sqoopmysql2hi_exec_obj_id_9d61c4ff_fk_metamap_execobj_id`</span> FOREIGN <span class="keyword">KEY</span> (<span class="string">`exec_obj_id`</span>) <span class="keyword">REFERENCES</span> <span class="string">`metamap_execobj`</span> (<span class="string">`id`</span>);</div></pre></td></tr></table></figure></p>
<ol>
<li>按照以下顺序开始清洗</li>
</ol>
<ul>
<li><p>clean_etl </p>
<p>  生成对应ETL的ExecObj</p>
</li>
<li><p>clean_rel </p>
<p>  清洗H2M,M2H中不规范的name，规范化hive表名到rel_name字段中</p>
</li>
<li><p>clean_m2h </p>
<p>  清洗M2H任务，生成对应的ExecObj。另外找到所有TBLBlood中父表是此表rel_name的记录，新建与之对应的ExecBlood记录</p>
</li>
<li><p>before_clean_blood</p>
<p>  过滤一下TblBlood中的parent，对于不存在于H2H和M2好的父表，临时创建为之创建NULLETL，并创建对应ExecObj，然后再创建ExecBlood。 </p>
<p>  <strong>==注意==</strong>：由于NULLETL的特殊性，需要在此创建ExecObj的deptask的日月周调度【在save方法中已实现】</p>
</li>
<li><p>clean_blood</p>
<p>  清洗TblBlood到对应ExecBlood，因为前面已经处理了所有情况，不该出现任务child或者parent不存在的问题。</p>
<p>  自检sql</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> <span class="keyword">name</span> <span class="keyword">from</span> metamap_execobj <span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">name</span> <span class="keyword">HAVING</span> <span class="keyword">count</span>(<span class="number">1</span>) &gt; <span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> metamap_execobj <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">'w_data_platform@drop_d_regula_stock'</span>;</div><div class="line"></div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> metamap_execobj <span class="keyword">where</span> <span class="keyword">name</span> = <span class="string">'app_jlc@jlc_life_accumulative'</span>;</div></pre></td></tr></table></figure>
</li>
<li><p>clean_h2m</p>
<p>  清洗H2M到ExecObj对象，获取依赖ETL的H2H ExecObj对象，添加对应ExecBlood。<br>  如果是JAR产生的表，暂不支持，需要额外处理【JAR添加自身的output】。</p>
<p>  <strong>==注意==</strong>：<br>  H2M中的个别现象，多个周期的数据存放在同一个表中：<br>  SELECT * from metamap_sqoophive2mysql where id in (71,72,73,74,75,76)<br>  需要额外手动维护execblood</p>
</li>
<li><p>clean_jar</p>
<p>  清洗JAR到ExecObj对象</p>
</li>
<li><p>clean_email</p>
<p>  清洗ANAETL到ExecObj对象</p>
</li>
<li><p>clean_task</p>
<p>  分别执行clean， type=4, type=1等(1,2,3,4,6)</p>
  <figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">--- 这些都是ana_etl本身的valid是0</span></div><div class="line"><span class="keyword">SELECT</span> * <span class="keyword">from</span> metamap_willdependencytask <span class="keyword">where</span> <span class="keyword">id</span> <span class="keyword">in</span> (<span class="number">864</span>, <span class="number">870</span>, <span class="number">759</span>, <span class="number">643</span>, <span class="number">164</span>, <span class="number">143</span>, <span class="number">85</span>)</div></pre></td></tr></table></figure>
</li>
<li><p>clean_ptask</p>
<p>  更新定时任务的task参数，由原来的will_deptask的id，更新为type为100的最新清洗完的task id.</p>
</li>
<li><p>clean_null</p>
<p>  为所有的NULLETL对象创建日月周的task调度</p>
</li>
</ul>
<ol>
<li>测试各种任务调度【日常调度、定时调度、即时调度】</li>
<li><p>clean_exec_id</p>
<p> 清洗原有的ETL对象的exec_obj_id字段</p>
</li>
<li><p>放开ETL对象的save方法注释</p>
</li>
<li>恢复线上使用，开启beta测试，随时解决未发现的新生bug</li>
<li>修改日调度脚本中的url到新版本</li>
<li>添加调度的页面覆盖回来[sche/edit_new.html， /views/sche_etl_v2.py]</li>
</ol>
<p>稳定运行一周，将dep task中旧的task全部删除</p>
<p>TODO</p>
<ol>
<li>H2M的依赖手动添加以下。SELECT * from metamap_sqoophive2mysql where id in (71,72,73,74,75,76)</li>
<li>测试各种ETL的save方法</li>
</ol>
<p>新增逻辑：</p>
<ol>
<li></li>
</ol>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[gobblin-architecture译文]]></title>
      <url>/2017/06/09/gobblin-architecture%E8%AF%91%E6%96%87/</url>
      <content type="html"><![CDATA[<h2 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h2><p>gobblin主要考虑的是扩展性，永固可以添加新的adapter或者集成已经存在的adapter来加入新的source，从新的source抽取数据。架构图：<br><img src="http://gobblin.readthedocs.io/en/latest/img/Gobblin-Architecture-Overview.png" alt="架构图"></p>
<p>一个gobblin job是一些列组件协同的结果。所有的组件都是可插拔可扩展的。(<a href="http://gobblin.readthedocs.io/en/latest/Gobblin-Architecture#gobblin-constructs" target="_blank" rel="external">http://gobblin.readthedocs.io/en/latest/Gobblin-Architecture#gobblin-constructs</a>)</p>
<p>一个gobblin job有一些列的task组成，每个task对应着一个工作单元，负责抽取一部分数据。这些task会根据配置选择(红色部分)通过gobblin runtime执行(上面橙色的部分)。</p>
<p><a href="http://gobblin.readthedocs.io/en/latest/Gobblin-Architecture/" target="_blank" rel="external">http://gobblin.readthedocs.io/en/latest/Gobblin-Architecture/</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[nginx代理HDP集群代码段]]></title>
      <url>/2017/06/07/nginx%E4%BB%A3%E7%90%86HDP%E9%9B%86%E7%BE%A4%E4%BB%A3%E7%A0%81%E6%AE%B5/</url>
      <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#user  nobody;</div><div class="line">worker_processes  1;</div><div class="line"></div><div class="line"></div><div class="line">events &#123;</div><div class="line">    worker_connections  1024;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">http &#123;</div><div class="line">    include       mime.types;</div><div class="line">    default_type  application/octet-stream;</div><div class="line"></div><div class="line"></div><div class="line">upstream jobhis &#123;</div><div class="line">        server servicenode03.will.com:19888 fail_timeout=30s;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    upstream azk &#123;</div><div class="line">        server schedule.will.com:8081 fail_timeout=30s;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    upstream yarn &#123;</div><div class="line">        server datanode02.will.com:8088 fail_timeout=30s;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    sendfile        on;</div><div class="line">    keepalive_timeout  65;</div><div class="line"></div><div class="line"></div><div class="line">    server &#123;</div><div class="line">        listen       81;</div><div class="line">        server_name  localhost;</div><div class="line"></div><div class="line">	subs_filter_types *;</div><div class="line">#        subs_filter overwrite willhistory i;</div><div class="line">        subs_filter datanode02.will.com:8088 $host:$server_port;</div><div class="line">	subs_filter 10.2.19.(\d*) unknown_ip ir;</div><div class="line">	subs_filter (data|name|service)node(\d*).will.com $1_$2.data.com ir;</div><div class="line">#        subs_filter will.com will.data.com ir;</div><div class="line"></div><div class="line"></div><div class="line">        #charset koi8-r;</div><div class="line"></div><div class="line">        #access_log  logs/host.access.log  main;</div><div class="line"></div><div class="line">	location /cluster/app &#123;</div><div class="line">                auth_request /auth;</div><div class="line">                try_files $uri @yarn;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        location /proxy &#123;</div><div class="line">                auth_request /auth;</div><div class="line">                try_files $uri @yarn;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        location /jobhistory &#123;</div><div class="line">               auth_request /auth;</div><div class="line">               try_files $uri @jobhis;</div><div class="line">		rewrite ^/jobhistory/logs/(data|service|name)_(\d*).data.com:(\d*)/(.*)$  /jobhistory/logs/$1node$2.will.com:$3/$4 break;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">	location / &#123;</div><div class="line">                try_files $uri @azk;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">	location @jobhis&#123;</div><div class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</div><div class="line">            proxy_set_header Host $http_host;</div><div class="line">            proxy_redirect off;</div><div class="line">            proxy_pass http://jobhis;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line">        location = /auth &#123;</div><div class="line">           internal;</div><div class="line">           proxy_pass http://10.2.19.62:8088/metamap/nginx_auth_test;</div><div class="line">           proxy_set_header Content-Length &quot;&quot;;</div><div class="line">           proxy_set_header X-Original-URI $request_uri;</div><div class="line">           proxy_pass_request_body off;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        location /static &#123;</div><div class="line">                 try_files $uri @yarn;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">	location @yarn&#123;</div><div class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</div><div class="line">            proxy_set_header Host $http_host;</div><div class="line">            proxy_redirect off;</div><div class="line">            proxy_pass http://yarn;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        location @azk&#123;</div><div class="line">            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</div><div class="line">            proxy_set_header Host $http_host;</div><div class="line">            proxy_redirect off;</div><div class="line">            proxy_pass http://azk;</div><div class="line">	    subs_filter_types *;</div><div class="line">	    subs_filter datanode(\d\d).will.com will.will.com ir;</div><div class="line">	    subs_filter 10.2.19.(\d*) unknowip ir;</div><div class="line">        &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">        error_page   500 502 503 504  /50x.html;</div><div class="line">        location = /50x.html &#123;</div><div class="line">            root   html;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">   </div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">   </div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[fabric与anisible对比]]></title>
      <url>/2017/05/26/fabric%E4%B8%8Eanisible%E5%AF%B9%E6%AF%94/</url>
      <content type="html"><![CDATA[<p>主要是跟anisible做对比，搞数据集群的环境越来越大，机器越来越多，不弄点儿自动化维护的工具，真心折腾不过来，而且容易出现失误。</p>
<p>这两天陪媳妇去图书馆自习，我就看书，看了一本不错的小说《兄弟》：余华写的，相当不错，笑中带泪，奔放中带着坚韧。因为近期工作中想要用一下docker来部署生产环境，为算法的同学提供动态可自定义的各种语言程序运行环境。前面听过几场关于docker环境部署的，听过几个人使用anisible进行docker部署，所以就在图书馆拿了本《奔跑吧：anisible》。</p>
<h2 id="吸引"><a href="#吸引" class="headerlink" title="吸引"></a>吸引</h2><p>里面提到anisible的我看中的功能性卖点：</p>
<ul>
<li>host分组</li>
<li>任务有顺序依赖的执行</li>
<li>获取上一个task的输出，比如docker容器mysql部署后，把这个容器的id保存给下一个容器web服务的配置文件使用。</li>
<li>配置文件模板化，接受外来变量赋值后，copy进入指定主机的指定目录。</li>
</ul>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><p>但是有一个比较恶心的问题，要记住一些概念</p>
<ul>
<li>inventory 主机</li>
<li>task<ul>
<li>module 具体执行的一些功能模块</li>
</ul>
</li>
<li>handler 等待被task触发</li>
<li>fact 主机相关的一些信息，比如CPU、内存、ip啥的</li>
</ul>
<h4 id="问题-1"><a href="#问题-1" class="headerlink" title="问题"></a>问题</h4><ul>
<li>module之类的都是别人封装好的，自己要完全按照人家的规则走，不舒服</li>
<li>有些需要额外处理的东西还是要自己写python代码处理，因为有些自定义的处理逻辑，是不会存在于既有的module中的</li>
</ul>
<p>那么恶心的事情就出现了：既要去使用module中别人给自己制定的规则， 又他么要自己写代码完成自己的逻辑。还不如fabric，完全按照自己的代码去执行逻辑。</p>
<h2 id="fabric"><a href="#fabric" class="headerlink" title="fabric"></a>fabric</h2><p>今儿早上看了一下fabric</p>
<ul>
<li>主机分组 【Y：有role进行分组】</li>
<li>任务 【Y】</li>
<li>任务依赖 【Y：通过定义额外的任务组合惹怒我】</li>
<li>主机信息【并没有感觉有什么用】</li>
<li><strong>task间变量传递</strong>【上一个任务给环境中的变量赋值，下一个任务可以直接接收到，比如dict】 —— <strong>失败</strong></li>
</ul>
<p>直接上自己的脚本文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">from fabric.api import *</div><div class="line"></div><div class="line"># 不指定用户的话，就是当前用户，跟ssh一样</div><div class="line">env.hosts = [</div><div class="line">    &apos;user@192.168.1.1&apos;,</div><div class="line">    &apos;user@192.168.1.2&apos;,</div><div class="line">]</div><div class="line"></div><div class="line"># 必须全面指定 ： user@ip:port</div><div class="line">env.passwords = &#123;</div><div class="line">    &apos;user@192.168.1.1:22&apos;: &apos;password1&apos;,</div><div class="line">    &apos;user@192.168.1.2:22&apos;: &apos;password2&apos;,</div><div class="line">&#125;</div><div class="line"></div><div class="line"># 这个标识有么有都可以 1.6.3版本</div><div class="line">@task</div><div class="line">def echo():</div><div class="line">    run(&apos;echo &quot;hello,world&quot;&apos;)</div></pre></td></tr></table></figure></p>
<p>动态为自己的机器分组, 那么就在fabric.py里执行以下逻辑：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">services = []</div><div class="line">datanodes = []</div><div class="line">hosts = list()</div><div class="line"></div><div class="line">def get_host():</div><div class="line">    with open(&apos;/etc/hosts&apos;, &apos;r&apos;) as hf:</div><div class="line">        for line in hf.readlines():</div><div class="line">            ss = line.split()</div><div class="line">            if &apos;node&apos; in ss[1]:</div><div class="line">                hosts.append(ss[0])</div><div class="line">            if &apos;servicenode&apos; in ss[1]:</div><div class="line">                services.append(ss[0])</div><div class="line">            if &apos;datanode&apos; in ss[1]:</div><div class="line">                datanodes.append(ss[0])</div><div class="line">    hosts.remove(&apos;10.2.19.104&apos;)</div><div class="line"></div><div class="line">env.hosts=hosts</div><div class="line"></div><div class="line">env.roledefs = &#123;</div><div class="line">    &apos;services&apos;: services,</div><div class="line">    &apos;datanodes&apos;: datanodes</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>其实这里的/etc/hosts就相当于anisible的inventory文件了。</p>
<p>调用的时候指定host组：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fab cmd:roles=services,cmd=&apos;df -h&apos;</div></pre></td></tr></table></figure></p>
<p>至此：放弃fabric……不能支持依赖部署，或者容器编排。离开……【尝试在任务重使用变量赋值失败，因为每个remote机器赋值都是对于自己的，并不能对全局变量赋值。但是其实通过获取任务的output，所以不放弃了】</p>
<p>稻草一枚：</p>
<ul>
<li><a href="http://fabric-chs.readthedocs.io/zh_CN/chs/api/core/tasks.html" target="_blank" rel="external">http://fabric-chs.readthedocs.io/zh_CN/chs/api/core/tasks.html</a></li>
<li><a href="https://stackoverflow.com/questions/42946197/return-value-from-fabric-task" target="_blank" rel="external">https://stackoverflow.com/questions/42946197/return-value-from-fabric-task</a></li>
<li></li>
</ul>
<h2 id="并行任务"><a href="#并行任务" class="headerlink" title="并行任务"></a>并行任务</h2><p>fabric现在也支持并行执行task，并且提供一次并行多少的粒度<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">from fabric.api import *</div><div class="line"></div><div class="line">@parallel(pool_size=5)</div><div class="line">def heavy_task():</div><div class="line">    # lots of heavy local lifting or lots of IO here</div></pre></td></tr></table></figure></p>
<p>指定一次并行5个远程机器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">fab -P -z 5 heavy_task</div></pre></td></tr></table></figure></p>
<p><a href="http://docs.fabfile.org/en/1.13/usage/parallel.html" target="_blank" rel="external">http://docs.fabfile.org/en/1.13/usage/parallel.html</a></p>
<h2 id="获取任务结果"><a href="#获取任务结果" class="headerlink" title="获取任务结果"></a>获取任务结果</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">from fabric.api import task, execute, run, runs_once</div><div class="line"></div><div class="line">@task</div><div class="line">def workhorse():</div><div class="line">    return run(&quot;get my infos&quot;)</div><div class="line"></div><div class="line">@task</div><div class="line">@runs_once</div><div class="line">def go():</div><div class="line">    results = execute(workhorse)</div><div class="line">    print results</div></pre></td></tr></table></figure>
<p>注意：execute是在任务在每个remote host上执行完之后获取结果，而run的stdout则是在单个任务内返回。</p>
<p><a href="http://docs.fabfile.org/en/1.13/usage/execution.html#intelligently-executing-tasks-with-execute" target="_blank" rel="external">http://docs.fabfile.org/en/1.13/usage/execution.html#intelligently-executing-tasks-with-execute</a></p>
<h2 id="文件传递"><a href="#文件传递" class="headerlink" title="文件传递"></a>文件传递</h2><p>使用put放到远程机器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">with cd(&apos;/tmp&apos;):</div><div class="line">    put(&apos;/path/to/local/test.txt&apos;, &apos;files&apos;)</div><div class="line">    </div><div class="line">put(&apos;bin/project.zip&apos;, &apos;/tmp/project.zip&apos;)</div><div class="line">put(&apos;*.py&apos;, &apos;cgi-bin/&apos;)</div><div class="line">put(&apos;index.html&apos;, &apos;index.html&apos;, mode=0755)</div></pre></td></tr></table></figure></p>
<p>使用get获取远程机器文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">get(&apos;/path/to/remote_file.txt&apos;, &apos;local_directory&apos;)</div></pre></td></tr></table></figure></p>
<p>上面的put对比anisible来说，只有一方面不足，就是对于类似nginx配置文件中的一些变量信息，我们需要额外自己引入模板，渲染之后再put出去。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[linux中的hang进程]]></title>
      <url>/2017/05/25/linux%E4%B8%AD%E7%9A%84hang%E8%BF%9B%E7%A8%8B/</url>
      <content type="html"><![CDATA[<p>5月24号晚上发现62上有两个hang的进程，占满了内存与cpu</p>
<p>第一个是M2H任务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">root     10082     1 97 May21 ?        3-20:08:33 /server/java/jdk1.8.0_60/bin/java -Xmx4096m -Dhdp.version=2.4.2.0-258 -Djava.net.preferIPv4Stack=true -Dhdp.version=2.4.2.0-258 -Dhadoop.log.dir=/var/log/hadoop/root -Dhadoop.log.file=hadoop.log -Dhadoop.home.dir=/usr/hdp/2.4.2.0-258/hadoop -Dhadoop.id.str=root -Dhadoop.root.logger=INFO,console -Djava.library.path=:/usr/hdp/2.4.2.0-258/hadoop/lib/native/Linux-amd64-64:/usr/hdp/2.4.2.0-258/hadoop/lib/native -Dhadoop.policy.file=hadoop-policy.xml -Djava.net.preferIPv4Stack=true -Xmx4096m -Dhadoop.security.logger=INFO,NullAppender org.apache.sqoop.Sqoop import -Dmapreduce.job.queuename=xstorm --connect jdbc:mysql://10.0.100.73:3306/xiaodai?useCursorFetch=true&amp;dontTrackOpenResources=true&amp;defaultFetchSize=2000 --driver com.mysql.jdbc.Driver --username weixddata_read --password G7iu1BMo9LWs2e --hive-database ods_tinyv --columns ID,USER_ID,WB_USERNAME,MOBILE,BIZ_ID,MSG_TYPE,SMS_TYPE,DATA_SOURCE,SMS_ID,TASK_ID,SEND_STATUS,RES_CODE,REPORT_STATUS,SEND_TIME,REPORT_TIME,SEND_EXCEPTION --where DATE_FORMAT(SEND_TIME, &apos;%Y-%m-%d&apos;)=&apos;2017-05-20&apos; --table SMS_INFO --hive-import --hive-overwrite --target-dir ods_tinyv_SMS_INFO --outdir /server/app/sqoop/vo --bindir /server/app/sqoop/vo --verbose -m 1 --delete-target-dir --hive-import --hive-table o_wb_xiaodai_sms_info_i --hive-partition-key dt --hive-partition-value 2017-05-20 --null-string \\N --null-non-string \\N</div></pre></td></tr></table></figure></p>
<p>还有一个HIVE任务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">root      3483     1 96 May23 ?        1-11:12:07 /server/java/jdk1.8.0_60/bin/java -Xmx4096m -Dhdp.version=2.4.2.0-258 -Djava.net.preferIPv4Stack=true -Dhdp.version=2.4.2.0-258 -Djava.net.preferIPv4Stack=true -XX:NewRatio=12 -XX:MaxHeapFreeRatio=40 -XX:MinHeapFreeRatio=15 -XX:+UseNUMA -XX:+UseParallelGC -XX:-UseGCOverheadLimit -Dhdp.version=2.4.2.0-258 -Dhadoop.log.dir=/var/log/hadoop/root -Dhadoop.log.file=hadoop.log -Dhadoop.home.dir=/usr/hdp/2.4.2.0-258/hadoop -Dhadoop.id.str=root -Dhadoop.root.logger=INFO,console -Djava.library.path=:/usr/hdp/2.4.2.0-258/hadoop/lib/native/Linux-amd64-64:/usr/hdp/2.4.2.0-258/hadoop/lib/native -Dhadoop.policy.file=hadoop-policy.xml -Djava.net.preferIPv4Stack=true -Xmx4096m -Xmx1024m -Dhadoop.security.logger=INFO,NullAppender -Dhdp.version=2.4.2.0-258 -Dhadoop.log.dir=/var/log/hadoop/root -Dhadoop.log.file=hadoop.log -Dhadoop.home.dir=/usr/hdp/2.4.2.0-258/hadoop -Dhadoop.id.str=root -Dhadoop.root.logger=INFO,console -Djava.library.path=:/usr/hdp/2.4.2.0-258/hadoop/lib/native/Linux-amd64-64:/usr/hdp/2.4.2.0-258/hadoop/lib/native:/usr/hdp/2.4.2.0-258/hadoop/lib/native/Linux-amd64-64:/usr/hdp/2.4.2.0-258/hadoop/lib/native -Dhadoop.policy.file=hadoop-policy.xml -Djava.net.preferIPv4Stack=true -Xmx4096m -Xmx4096m -Xmx1024m -Dhadoop.security.logger=INFO,NullAppender org.apache.hadoop.util.RunJar /usr/hdp/2.4.2.0-258/hive/lib/hive-exec-1.2.1000.2.4.2.0-258.jar org.apache.hadoop.hive.ql.exec.mr.ExecDriver -localtask -plan file:/tmp/root/228f95e6-26ee-4466-bd3d-a91195c86bf4/hive_2017-05-23_10-38-11_000_7465740175512782543-1/-local-10004/plan.xml -jobconffile file:/tmp/root/228f95e6-26ee-4466-bd3d-a91195c86bf4/hive_2017-05-23_10-38-11_000_7465740175512782543-1/-local-10005/jobconf.xml</div></pre></td></tr></table></figure></p>
<p>手贱，先kill掉了，不然还能看到上面的plan文件，和job配置文件什么的。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[runningdata改版记录]]></title>
      <url>/2017/05/18/runningdata%E6%94%B9%E7%89%88%E8%AE%B0%E5%BD%95/</url>
      <content type="html"><![CDATA[<p>抽象ETLObjRelated，其他对象继承之</p>
<ul>
<li>ETL的字段名tbl_name需要在数据库里修改为name<ul>
<li>tasks里的exec_etl_sche任务会调用etl.name【老表的tbl_name会报错找不到】</li>
</ul>
</li>
<li>执行metamap 0045的migrations，这个只是添加字段，不会造成额外影响</li>
<li></li>
</ul>
<p>sdf </p>
<ol>
<li><p>确保新的save方法都已经注释掉</p>
</li>
<li><p>./manage.py migrate metamap 0050 –settings=metamap.config</p>
</li>
<li><p>开始清洗</p>
</li>
</ol>
<ul>
<li>clean_etl</li>
<li>clean_rel</li>
<li>clean_m2h</li>
<li>before_clean_blood</li>
<li>clean_blood</li>
<li>clean_h2m</li>
<li>clean_jar</li>
<li>clean_email</li>
<li>clean_task[分别执行clean， type=4, type=1等等]</li>
<li>clean_period</li>
</ul>
<h2 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h2><ol>
<li>H2M中的个别现象，多个周期的数据存放在同一个表中：<br>SELECT * from metamap_sqoophive2mysql where id in (71,72,73,74,75,76)<br>需要额外手动维护execblood</li>
<li>放开那些注释</li>
</ol>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[django用户组的思考]]></title>
      <url>/2017/05/10/django%E7%94%A8%E6%88%B7%E7%BB%84%E7%9A%84%E6%80%9D%E8%80%83/</url>
      <content type="html"><![CDATA[<p>我们有两个不同的事业部A, B， 目前是用django的group来做的。。。都在我的平台上编辑自己的内容OBJ，我给OBJ指定了唯一一个group_id外键来保证AB事业部内容的隔离。。。。现在遇到问题，因为要控制一些权限，当加group的时候…..自己就懵逼了</p>
<p>不该这样处理AB，对吧。。。应该额外建立一个oaganization来作为AB隔离的。django的group用来做操作权限控制更好，而不是对象隔离。</p>
<p>所以现在的代码结构是：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrgGroup</span><span class="params">(models.Model)</span>:</span></div><div class="line">    name = models.CharField(max_length=<span class="number">200</span>, verbose_name=<span class="string">u"组织名称"</span>)</div><div class="line">    owners = models.CharField(max_length=<span class="number">100</span>, verbose_name=<span class="string">u"负责人"</span>, blank=<span class="keyword">True</span>, default=<span class="string">''</span>)</div><div class="line">    hdfs_path = models.CharField(max_length=<span class="number">100</span>, verbose_name=<span class="string">u"HDFS临时路径"</span>, blank=<span class="keyword">True</span>, default=<span class="string">''</span>)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.name</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserProfile</span><span class="params">(models.Model)</span>:</span></div><div class="line">    user = models.OneToOneField(User)</div><div class="line">    phone = models.BigIntegerField(default=<span class="number">110</span>)</div><div class="line">    org_group = models.ForeignKey(OrgGroup, on_delete=models.DO_NOTHING, related_name=<span class="string">'user_cgroup'</span>, null=<span class="keyword">True</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.user.username</div></pre></td></tr></table></figure></p>
<p>重新定义了一个组织的model，然后每个人都有属于某个特定的组织。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">JarApp</span><span class="params">(models.Model)</span>:</span></div><div class="line">    .....</div><div class="line">    cgroup = models.ForeignKey(OrgGroup, on_delete=models.DO_NOTHING, </div><div class="line">    .....</div></pre></td></tr></table></figure>
<p>上面的cgroup原来是<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cgroup = models.ForeignKey(auth.Group, on_delete=models.DO_NOTHING, related_name=&apos;jar_cgroup&apos;, null=True)</div></pre></td></tr></table></figure></p>
<p>然后还要重构JarApp的新建与查询的一些代码。</p>
<p>这样，使用自定义的组织来划分人员与面向的内容。使用django的group来控制是否组织内特定人员组具有的权限【ETL开发人员、与报表开发人员】。</p>
<p>自定义的组织用来限定报表和ETL所属的组织。而django的auth.group可以管理一组权限【对ETL、报表的访问权限、操作权限等】。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ambari个别component扩张]]></title>
      <url>/2017/05/09/ambari%E4%B8%AA%E5%88%ABcomponent%E6%89%A9%E5%BC%A0/</url>
      <content type="html"><![CDATA[<p>需要扩展20个NodeManager，ambari只能手动到每个datanode界面上去安装NodeManager，并启动。啰嗦，麻烦。</p>
<p>看了一下ajax请求，整理了一个脚本。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">#!/bin/bash</div><div class="line"></div><div class="line">for i in `seq 26 33`;</div><div class="line">do</div><div class="line"></div><div class="line">echo handing $i</div><div class="line"></div><div class="line"># 安装service</div><div class="line">curl -u admin:will@bj15. -H &quot;X-Requested-By: ambari&quot; -X POST -d &apos;</div><div class="line">&#123;&quot;RequestInfo&quot;:&#123;&quot;context&quot;:&quot;Install NodeManager&quot;&#125;,&quot;Body&quot;:&#123;&quot;host_components&quot;:[&#123;&quot;HostRoles&quot;:&#123;&quot;component_name&quot;:&quot;NODEMANAGER&quot;&#125;&#125;]&#125;&#125;&apos; http://namenode01.will.com:8080/api/v1/clusters/datacenter/hosts?Hosts/host_name=datanode$&#123;i&#125;.will.com</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"># 安装component</div><div class="line">curl -u admin:will@bj15. -H &quot;X-Requested-By: ambari&quot; -X PUT -d &apos;</div><div class="line">&#123;&quot;RequestInfo&quot;:&#123;&quot;context&quot;:&quot;Install NodeManager&quot;,&quot;operation_level&quot;:&#123;&quot;level&quot;:&quot;HOST_COMPONENT&quot;,&quot;cluster_name&quot;:&quot;datacenter&quot;,&quot;host_name&quot;:&quot;datanode$&#123;i&#125;.will.com&quot;,&quot;service_name&quot;:&quot;YARN&quot;&#125;&#125;,&quot;Body&quot;:&#123;&quot;HostRoles&quot;:&#123;&quot;state&quot;:&quot;INSTALLED&quot;&#125;&#125;&#125;&apos; http://namenode01.will.com:8080/api/v1/clusters/datacenter/hosts/datanode$&#123;i&#125;.will.com/host_components/NODEMANAGER?HostRoles/state=INIT</div><div class="line"></div><div class="line"></div><div class="line"># 启动</div><div class="line">curl -u admin:will@bj15. -H &quot;X-Requested-By: ambari&quot; -X PUT -d &apos;&#123;&quot;RequestInfo&quot;:&#123;&quot;context&quot;:&quot;Start NodeManager&quot;,&quot;operation_level&quot;:&#123;&quot;level&quot;:&quot;HOST_COMPONENT&quot;,&quot;cluster_name&quot;:&quot;datacenter&quot;,&quot;host_name&quot;:&quot;datanode$&#123;i&#125;.will.com&quot;,&quot;service_name&quot;:&quot;YARN&quot;&#125;&#125;,&quot;Body&quot;:&#123;&quot;HostRoles&quot;:&#123;&quot;state&quot;:&quot;STARTED&quot;&#125;&#125;&#125;&apos; http://namenode01.will.com:8080/api/v1/clusters/datacenter/hosts/datanode$&#123;i&#125;.will.com/host_components/NODEMANAGER</div><div class="line">done</div></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[自制RPM包并发布到自己的yum源]]></title>
      <url>/2017/04/27/%E8%87%AA%E5%88%B6RPM%E5%8C%85%E5%B9%B6%E5%8F%91%E5%B8%83%E5%88%B0%E8%87%AA%E5%B7%B1%E7%9A%84yum%E6%BA%90/</url>
      <content type="html"><![CDATA[<p>使用一个普通用户执行，以免对系统造成重伤。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y rpmdevtools rpm-build</div></pre></td></tr></table></figure>
<h2 id="自定义工作空间"><a href="#自定义工作空间" class="headerlink" title="自定义工作空间"></a>自定义工作空间</h2><p>方案1：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rpmdev-setuptree</div></pre></td></tr></table></figure>
<p>方案2</p>
<p>创建文件~/.rpmmacros<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">%_topdir        /home/will/rpmbuild</div></pre></td></tr></table></figure></p>
<p>配置了空间之后，还得手动创建一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">mkdir /home/will/rpmbuild</div></pre></td></tr></table></figure></p>
<p>创建需要的目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">cd ~/rpmbuild  </div><div class="line">mkdir -pv &#123;BUILD,BUILDROOT,RPMS,SOURCES,SPECS,SRPMS&#125;</div></pre></td></tr></table></figure></p>
<ul>
<li>BUILD #编译之前，如解压包后存放的路径</li>
<li>BUILDROOT #编译后存放的路径</li>
<li>RPMS #打包完成后rpm包存放的路径</li>
<li>SOURCES #源包所放置的路径</li>
<li>SPECS #spec文档放置的路径</li>
<li>SPRMS #源码rpm包放置的路径</li>
</ul>
<p>注：一般我们都把源码打包成tar.gz格式然后存放于SOURCES路径下，而在SPECS路径下编写spec文档，通过命令打包后，默认会把打包后的rpm包放在RPMS下，而源码包会被放置在SRPMS下</p>
<h2 id="源码放到SOURCES目录"><a href="#源码放到SOURCES目录" class="headerlink" title="源码放到SOURCES目录"></a>源码放到SOURCES目录</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">cp /tmp/redis-3.2.8.tar.gz SOURCES</div></pre></td></tr></table></figure>
<h2 id="SPECS下创建配置"><a href="#SPECS下创建配置" class="headerlink" title="SPECS下创建配置"></a>SPECS下创建配置</h2><p>到SPECS下创建指定配置，编辑的时候会自动生成模板。编辑<code>SPECS/redis.spec</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">Name:		redis</div><div class="line">Version:	3.2.8	</div><div class="line">Release:	3%&#123;dist&#125;</div><div class="line">Summary:	redis from will	</div><div class="line"></div><div class="line">Group:		System Environment/Daemons</div><div class="line">License:	GPLv2</div><div class="line">URL:		https://github.com/willcup</div><div class="line">Source0:	redis-3.2.8.tar.gz</div><div class="line"></div><div class="line">Packager:       WillCup &lt;willcup@163.com&gt; </div><div class="line">BuildRequires:	gcc,make</div><div class="line">Requires:	openssl,chkconfig</div><div class="line">BuildRoot:      %_topdir/BUILDROOT</div><div class="line"></div><div class="line"></div><div class="line">%define PortFindDir /usr/local/will_redis</div><div class="line"></div><div class="line">%description</div><div class="line">this is build from will, just for ambari service.</div><div class="line"></div><div class="line">%prep</div><div class="line">%setup -q</div><div class="line"></div><div class="line">%build</div><div class="line">make %&#123;?_smp_mflags&#125;</div><div class="line"></div><div class="line"></div><div class="line">%install</div><div class="line">[ ! -e $RPM_BUILD_ROOT%&#123;PortFindDir&#125; ] &amp;&amp; mkdir -p $RPM_BUILD_ROOT%&#123;PortFindDir&#125;</div><div class="line">cp -rfv * $RPM_BUILD_ROOT%&#123;PortFindDir&#125;</div><div class="line">[ ! -e $RPM_BUILD_ROOT/etc/init.d ] &amp;&amp; mkdir -p $RPM_BUILD_ROOT/etc/init.d</div><div class="line">[ ! -e $RPM_BUILD_ROOT/usr/local/bin ] &amp;&amp; mkdir -p $RPM_BUILD_ROOT/usr/local/bin</div><div class="line">cp -vf $RPM_BUILD_ROOT%&#123;PortFindDir&#125;/utils/redis_init_script $RPM_BUILD_ROOT/etc/init.d/redis</div><div class="line">cp -vf $RPM_BUILD_ROOT%&#123;PortFindDir&#125;/src/redis-server $RPM_BUILD_ROOT/usr/local/bin</div><div class="line">cp -vf $RPM_BUILD_ROOT%&#123;PortFindDir&#125;/src/redis-cli $RPM_BUILD_ROOT/usr/local/bin</div><div class="line">#mkdir -p &quot;$RPM_BUILD_ROOT&quot;</div><div class="line">#cp -rvf * &quot;$RPM_BUILD_ROOT&quot;</div><div class="line">#ls -l &quot;$RPM_BUILD_ROOT&quot;</div><div class="line">echo &quot;no reason to install redis, just move it&quot;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">%files</div><div class="line">%defattr (-,root,root,0755)</div><div class="line">%dir %&#123;PortFindDir&#125;</div><div class="line">%attr(0755, root, root) %&#123;PortFindDir&#125;/*</div><div class="line">%attr(0755, root, root)	/etc/init.d/redis</div><div class="line">%attr(0755, root, root) /usr/local/bin</div><div class="line">%doc</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">%postun	</div><div class="line">rm -fr %(PortFindDir&#125;</div><div class="line">rm -vf /usr/local/bin/redis-*</div><div class="line">rm -vf /etc/init.d/redis</div><div class="line"></div><div class="line">%changelog</div><div class="line">* Fri Dec 29 2016 willcup &lt;willcup@163.com&gt; - 3.2.8-1 </div><div class="line">- Initial version just changelog</div></pre></td></tr></table></figure></p>
<p>其实上面的buildroot就相当于是后面rpm安装时候的系统根目录。所以一般都需要指定一个子目录。不然是行不通的，会发现弄完以后RPM包里没有任何文件。</p>
<h2 id="开始构建"><a href="#开始构建" class="headerlink" title="开始构建"></a>开始构建</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">rpmbuild -ba redis.spec</div></pre></td></tr></table></figure>
<p>可以看到已经有了结果</p>
<p>这个是构建过程中的源码目录：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">[will@datanode08 rpmbuild]$ ll BUILD/redis-3.2.8/</div><div class="line">total 204</div><div class="line">-rw-r--r--.  1 will will 85775 Feb 12 23:14 00-RELEASENOTES</div><div class="line">-rw-r--r--.  1 will will    53 Feb 12 23:14 BUGS</div><div class="line">-rw-r--r--.  1 will will  1805 Feb 12 23:14 CONTRIBUTING</div><div class="line">-rw-r--r--.  1 will will  1487 Feb 12 23:14 COPYING</div><div class="line">-rw-r--r--.  1 will will     0 Apr 27 12:25 debugfiles.list</div><div class="line">-rw-r--r--.  1 will will     0 Apr 27 12:25 debuglinks.list</div><div class="line">-rw-r--r--.  1 will will     0 Apr 27 12:25 debugsources.list</div><div class="line">drwxr-xr-x.  7 will will  4096 Apr 27 12:25 deps</div><div class="line">-rw-r--r--.  1 will will    11 Feb 12 23:14 INSTALL</div><div class="line">-rw-r--r--.  1 will will   151 Feb 12 23:14 Makefile</div><div class="line">-rw-r--r--.  1 will will  4223 Feb 12 23:14 MANIFESTO</div><div class="line">-rw-r--r--.  1 will will  6834 Feb 12 23:14 README.md</div><div class="line">-rw-r--r--.  1 will will 46695 Feb 12 23:14 redis.conf</div><div class="line">-rwxr-xr-x.  1 will will   271 Feb 12 23:14 runtest</div><div class="line">-rwxr-xr-x.  1 will will   280 Feb 12 23:14 runtest-cluster</div><div class="line">-rwxr-xr-x.  1 will will   281 Feb 12 23:14 runtest-sentinel</div><div class="line">-rw-r--r--.  1 will will  7606 Feb 12 23:14 sentinel.conf</div><div class="line">drwxr-xr-x.  2 will will  4096 Apr 27 12:25 src</div><div class="line">drwxr-xr-x. 10 will will  4096 Feb 12 23:14 tests</div><div class="line">drwxr-xr-x.  7 will will  4096 Feb 12 23:14 utils</div></pre></td></tr></table></figure></p>
<p>打包完成后rpm包存放的路径：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[will@datanode08 rpmbuild]$ ll RPMS/x86_64/</div><div class="line">total 8</div><div class="line">-rw-rw-r--. 1 will will 1752 Apr 27 12:25 redis-3.2.8-1.el6.x86_64.rpm</div><div class="line">-rw-rw-r--. 1 will will 1880 Apr 27 12:25 redis-debuginfo-3.2.8-1.el6.x86_64.rpm</div></pre></td></tr></table></figure></p>
<p>源码rpm包放置的路径<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[will@datanode08 rpmbuild]$ ll SRPMS/</div><div class="line">total 1516</div><div class="line">-rw-rw-r--. 1 will will 1549338 Apr 27 12:25 redis-3.2.8-1.el6.src.rpm</div></pre></td></tr></table></figure></p>
<p>然而查看rpm包的文件，竟然什么都没有。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[will@datanode08 rpmbuild]$ rpm -qlp RPMS/x86_64/redis-3.2.8-1.el6.x86_64.rpm </div><div class="line">(contains no files)</div></pre></td></tr></table></figure></p>
<p>修改之后，能够正常安装与使用了。</p>
<p>使用 rpm -ivh xx.rpm成功测试。</p>
<p>下一步，将RPM发布至我们自有的yum源上。</p>
<p>按照其他的类似hadoop之类，创建一个redis目录，然后把我们的rpm包放上去</p>
<p>目录样子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@datanode21 2.4.2.0]# ll</div><div class="line">total 2146284</div><div class="line">.....</div><div class="line">drwxr-xr-x  2 ambari-qa users       4096 Apr 25  2016 hadoop</div><div class="line">drwxr-xr-x  2 ambari-qa users       4096 Apr 25  2016 hadooplzo</div><div class="line">drwxr-xr-x  2 ambari-qa users       4096 Apr 25  2016 hbase</div><div class="line">.......</div><div class="line">drwxr-xr-x  2 ambari-qa users       4096 Apr 25  2016 oozie</div><div class="line">drwxr-xr-x  2 ambari-qa users       4096 Apr 25  2016 phoenix</div><div class="line">drwxr-xr-x  2 ambari-qa users       4096 Apr 25  2016 pig</div><div class="line">drwxr-xr-x  2 ambari-qa users       4096 Apr 25  2016 ranger</div><div class="line">drwxr-xr-x  2 root      root        4096 Apr 27 16:45 redis</div><div class="line">You have new mail in /var/spool/mail/root</div><div class="line">[root@datanode21 2.4.2.0]# pwd</div><div class="line">/server/www/html/hdp/HDP/centos6/2.x/updates/2.4.2.0</div></pre></td></tr></table></figure></p>
<p>先看下我们的HDP.repo<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[HDP-2.4]</div><div class="line">name=HDP-2.4</div><div class="line">baseurl=http://10.2.19.110/hdp/HDP/centos6/2.x/updates/2.4.2.0</div><div class="line"></div><div class="line">path=/</div><div class="line">enabled=1</div><div class="line">gpgcheck=0</div></pre></td></tr></table></figure></p>
<p>可以看到是同一个目录，我们需要在这个目录下重新执行<code>createrepo</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">[root@datanode21 2.4.2.0]# createrepo .</div><div class="line">Spawning worker 0 with 182 pkgs</div><div class="line">Workers Finished</div><div class="line">Gathering worker results</div><div class="line"></div><div class="line">Saving Primary metadata</div><div class="line">Saving file lists metadata</div><div class="line">Saving other metadata</div><div class="line">Generating sqlite DBs</div><div class="line">Sqlite DBs complete</div><div class="line">[root@datanode21 2.4.2.0]# ll repodata</div><div class="line">total 856</div><div class="line">-rw-r--r-- 1 root root 373992 Apr 27 17:59 458b198ae4b61c02b0f7bb03ae9421365dcb2076ffb6087e6808e7915ec31778-filelists.sqlite.bz2</div><div class="line">-rw-r--r-- 1 root root   9092 Apr 27 17:59 9a59871d45121b0be43f188ae7ffe788e2eceb07d03648717323dedd26faf567-other.xml.gz</div><div class="line">-rw-r--r-- 1 root root  12162 Apr 27 17:59 bb3c2dc4c1f7ae17b172f104e3df5171d0d09db797a5f5a9227ab4ae424a45b7-other.sqlite.bz2</div><div class="line">-rw-r--r-- 1 root root  37245 Apr 27 17:59 c23cec21ae4b3e9b89a029b593362ca1e2483316e1d07843a9035ad8e3c93053-primary.xml.gz</div><div class="line">-rw-r--r-- 1 root root 363468 Apr 27 17:59 c521ec682137ff19e61f7ec91e86c725d6d6fa7553be01c783a67ffb68b30afe-filelists.xml.gz</div><div class="line">-rw-r--r-- 1 root root  65483 Apr 27 17:59 eb98320b3ad040203135b91f26caee107900f2e9bdc86a4be6c5218fcc505036-primary.sqlite.bz2</div><div class="line">-rw-r--r-- 1 root root   2996 Apr 27 17:59 repomd.xml</div></pre></td></tr></table></figure></p>
<p>然后更新客户机上，也就是要安装redis 的机器上的repo信息。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">yum clean all</div><div class="line">yum update</div><div class="line">yum search redis</div></pre></td></tr></table></figure></p>
<p>能够搜到，至此结束。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>我们要构建redis，主要是为了适应既有ambari的redis service，它执行安装的命令是<code>yum install redis.3.2.8</code>。当然我们是可以修改一下他的install代码的，但是考虑到以后其他组件很有可能还是通过yum安装，那还是现在就把自己动手构建yum的rpm包这个问题解决了吧，以绝后患。</p>
<p>问题来了，上面我们搜到的只是<code>redis.x86_64</code>,实际安装的时候请求的是3.2.8，需要版本号加进去才行。看到spec里有version关键字。。。折腾了好半天，都不是，构建出来search的时候都还是只有redis。</p>
<p>后来参考既有的hadoop、flume等yum源，成功搞定。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">flume_2_4_2_0_258-1.5.2.2.4.2.0-258.el6.noarch.rpm	25-Apr-2016 19:54	40M	 </div><div class="line">	</div><div class="line">flume_2_4_2_0_258-agent-1.5.2.2.4.2.0-258.el6.noarch.rpm	25-Apr-2016 19:54	6.4K</div></pre></td></tr></table></figure></p>
<p>发现这个版本号貌似是跟着文件夹的。</p>
<p>所以，修改如下:</p>
<ul>
<li>修改redis.spec为redis-3.2.8.spec</li>
<li>编辑spec文件<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Name:           redis-3.2.8</div><div class="line">Version:        1_0_0</div><div class="line"></div><div class="line">URL:            https://github.com/willcup</div><div class="line">Source0:        redis-3.2.8.tar.gz</div></pre></td></tr></table></figure>
</li>
</ul>
<p>关键在于Name，后面都是喽啰</p>
<ul>
<li>这样解压后会去redis-3.2.8-1_0_0，也就是根据name和version生成的规则，所以可能要调整一下tar.gz里的文件夹名称</li>
<li>重新构建预发布，即可<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">redis-3.2.8-1_0_0-4.el6.x86_64.rpm</div><div class="line"></div><div class="line">yum search redis</div><div class="line">redis.x86_64 : redis from will</div><div class="line">redis-3.2.8.x86_64 : redis 3 2 8 from will</div></pre></td></tr></table></figure>
</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="https://docs.fedoraproject.org/en-US/Fedora_Draft_Documentation/0.1/html/Packagers_Guide/chap-Packagers_Guide-Spec_File_Reference-Preamble.html" target="_blank" rel="external">https://docs.fedoraproject.org/en-US/Fedora_Draft_Documentation/0.1/html/Packagers_Guide/chap-Packagers_Guide-Spec_File_Reference-Preamble.html</a></li>
<li><a href="https://fedoraproject.org/wiki/How_to_create_an_RPM_package/zh-cn#.E5.AE.9E.E4.BE.8B" target="_blank" rel="external">https://fedoraproject.org/wiki/How_to_create_an_RPM_package/zh-cn#.E5.AE.9E.E4.BE.8B</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[TEZ-hadoop上数据处理的新篇章]]></title>
      <url>/2017/04/26/TEZ-hadoop%E4%B8%8A%E6%95%B0%E6%8D%AE%E5%A4%84%E7%90%86%E7%9A%84%E6%96%B0%E7%AF%87%E7%AB%A0/</url>
      <content type="html"><![CDATA[<h2 id="TEZ"><a href="#TEZ" class="headerlink" title="TEZ"></a>TEZ</h2><p>生成一个复杂的DAG task图</p>
<p>目前基本所有的hadoop任务都是MapReduce程序，面向批数据的特性使得它并不能够满足一些特定查询。TEZ是传统MR程序的另一个选择，可以更快地返回结果，而且减少过程中的吞吐。</p>
<h2 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h2><p>分布式处理是hadoop的核心。存储与分析各种不同的大量的数据使得hadoop之上产生了很多工具。随着hadoop进入yarn时代，它把MR解耦了出来，这样可以使用其他的数据处理方式来迎接新的不同的挑战。</p>
<h2 id="设计"><a href="#设计" class="headerlink" title="设计"></a>设计</h2><p>hive,pig这些高层次的数据处理工具需要一个引擎来解析他们的语句，然后执行。TEZ就是这样一个引擎。</p>
<h4 id="解析，建模，执行"><a href="#解析，建模，执行" class="headerlink" title="解析，建模，执行"></a>解析，建模，执行</h4><p>TEZ把数据处理看作一个数据流图，节点代表数据处理逻辑，边代表着数据的流向。TEZ有一个很好的数据流相关API,能够让用户清晰表达出自己的复杂查询逻辑，也能够支持hive、pig等高级应用生成的查询计划。</p>
<p>如下图，使用range partitioning进行分布式sort的模型。Preprocessor stage中发送samples给Sampler，计算每个数据分区的range，以保证平均分配。然后这些range再被发送给Partition stage。然后partition stage和aggregate stage就读取分配的stage，执行数据的扫描与后续聚合工作。</p>
<p><img src="https://2xbbhjxc6wk3v21p62t8n4d4-wpengine.netdna-ssl.com/wp-content/uploads/2013/09/tez1-450x257.png" alt=""></p>
<h4 id="灵活的input-processor-output任务模型"><a href="#灵活的input-processor-output任务模型" class="headerlink" title="灵活的input-processor-output任务模型"></a>灵活的input-processor-output任务模型</h4><p>TEZ中对于数据流中每个处理逻辑都是由三部分组成：input, processor, output。input和output决定数据接口。processor则是数据处理逻辑。TEZ只要求在同一个vertex task中这三部分之间是相互兼容的即可。</p>
<p><img src="https://2xbbhjxc6wk3v21p62t8n4d4-wpengine.netdna-ssl.com/wp-content/uploads/2013/09/tez2-450x154.png" alt=""></p>
<h4 id="动态图配置的性能"><a href="#动态图配置的性能" class="headerlink" title="动态图配置的性能"></a>动态图配置的性能</h4><p>分布式数据处理天生就是动态的，所以很难提前知道最优并发和数据走向。更多的信息只能在运行时才获知，比如数据的内容和大小，这其实是可以帮助我们优化执行计划的。我们还注意到TEZ自身并不能总是自己执行这些动态优化。</p>
<p><img src="https://2xbbhjxc6wk3v21p62t8n4d4-wpengine.netdna-ssl.com/wp-content/uploads/2013/09/tez3-450x208.png" alt=""></p>
<ul>
<li><a href="https://hortonworks.com/blog/apache-tez-a-new-chapter-in-hadoop-data-processing/" target="_blank" rel="external">https://hortonworks.com/blog/apache-tez-a-new-chapter-in-hadoop-data-processing/</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hiveserver2负载均衡]]></title>
      <url>/2017/04/26/hiveserver2%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/</url>
      <content type="html"><![CDATA[<p>hiveserver2是通过在zookeeper注册一个namespace，然后管理所有的hiveserver实例，实现动态服务发现的。</p>
<p>znode样式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/&lt;hiveserver2_namespace&gt;/serverUri=&lt;host:port&gt;;version=&lt;versionInfo&gt;; sequence=&lt;sequence_number&gt;,</div></pre></td></tr></table></figure></p>
<p>hiveserver实例会在znode上设置一个watch。当znode被修改的时候，watch会发送给hiveserver相关信息。这个通知能够让所有的hiveserver实例知道它是不是对于client端可用。</p>
<p>当有hiveserver实例退出时，会从zk的对应node里移除，但是只对新的客户端连接生效。(已经连接的session不能生效了)。只有已经连接到这个hiveserver的最后一个client的session结束后，才会自动把这个hiveserver完全关闭，下面这个命令就是做这个工作的。</p>
<p>使用下面命令移除一个hiveserver<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hive --service hiveserver2 --deregister &lt;package ID&gt;</div></pre></td></tr></table></figure></p>
<h4 id="没有zk时的查询"><a href="#没有zk时的查询" class="headerlink" title="没有zk时的查询"></a>没有zk时的查询</h4><p>下面是一个传统的查询流程：</p>
<ul>
<li>通过JDBC/ODBC driver连接到HS2实例，建立一个session</li>
<li>然后每次查询的时候client都发送语句给HS2，转化成Hadoop上的执行任务</li>
<li>每个查询的结果都写道一个临时文件中</li>
<li>客户端driver从HS2抽取临时文件中的数据记录</li>
</ul>
<p><img src="https://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.4.0/bk_hadoop-ha/content/figures/2/figures/Query_Ex_Path_No_ZK.png" alt="典型查询流程"></p>
<h4 id="带有zk的查询"><a href="#带有zk的查询" class="headerlink" title="带有zk的查询"></a>带有zk的查询</h4><p>因为可以使用动态服务发现，所以客户端driver必须知道怎样使用这个特性。对于HDP2.2或者JDBC driver2.0.0版本之后才能支持。</p>
<p>动态服务发现实现如下：</p>
<ul>
<li>多个HS2实例使用zk注册自己</li>
<li>客户端driver连接zk<blockquote>
<p> jdbc:hive2://<zookeeper_ensemble>;serviceDiscoveryMode=zooKeeper; zooKeeperNamespace=&lt;hiveserver2_namespace</zookeeper_ensemble></p>
</blockquote>
</li>
<li>zk随机返回一个host:port给客户端</li>
<li>客户端执行单个服务传统查询过程</li>
</ul>
<p><img src="https://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.4.0/bk_hadoop-ha/content/figures/2/figures/Query_Ex_Path_With_ZK.png" alt="带有zk的查询过程"></p>
<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4><p>hive.zookeeper.quorum zk列表<br>hive.zookeeper.session.timeout 超时就关闭session<br>hive.server2.support.dynamic.service.discovery  设置为true<br>hive.server2.zookeeper.namespace    指定一个就行了，默认是hiveserver2</p>
<ul>
<li><a href="https://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.4.0/bk_hadoop-ha/content/ha-hs2-requests.html" target="_blank" rel="external">https://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.4.0/bk_hadoop-ha/content/ha-hs2-requests.html</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hue对于多个hiveserver2的支持]]></title>
      <url>/2017/04/26/hue%E5%AF%B9%E4%BA%8E%E5%A4%9A%E4%B8%AAhiveserver2%E7%9A%84%E6%94%AF%E6%8C%81/</url>
      <content type="html"><![CDATA[<p>相关连接代码：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hiveserver2_jdbc_url</span><span class="params">()</span>:</span></div><div class="line">  urlbase = <span class="string">'jdbc:hive2://%s:%s/default'</span> % (beeswax.conf.HIVE_SERVER_HOST.get(),</div><div class="line">                                            beeswax.conf.HIVE_SERVER_PORT.get())</div><div class="line">  <span class="keyword">if</span> get_conf().get(_CNF_HIVESERVER2_USE_SSL, <span class="string">'FALSE'</span>).upper() == <span class="string">'TRUE'</span>:</div><div class="line">    <span class="keyword">return</span> <span class="string">'%s;ssl=true;sslTrustStore=%s;trustStorePassword=%s'</span> % (urlbase,</div><div class="line">            get_conf().get(_CNF_HIVESERVER2_TRUSTSTORE_PATH),</div><div class="line">            get_conf().get(_CNF_HIVESERVER2_TRUSTSTORE_PASSWORD))</div><div class="line">  <span class="keyword">else</span>:</div><div class="line">     <span class="keyword">return</span> urlbase</div></pre></td></tr></table></figure></p>
<p>可以看到，除非启用SSL，否则咋样都拼不进去下面这种串：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jdbc:hive2://zkNode1:<span class="number">2181</span>,zkNode2:<span class="number">2181</span>,zkNode3:<span class="number">2181</span>/;serviceDiscoveryMode=zooKeeper;zooKeeperNamespace=hiveserver2_zk</div></pre></td></tr></table></figure></p>
<p>Tip:</p>
<p>可以先用tengine配置TCP代理，然后在这里实现负载均衡，hue端只需要配置代理的地址就可以了。 —— 希望hive的driver可以支持，有待测试。</p>
<p>参考：</p>
<ul>
<li><a href="http://lxw1234.com/archives/2016/05/675.htm" target="_blank" rel="external">http://lxw1234.com/archives/2016/05/675.htm</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hive中使用向量化查询引擎Vectorized-Query-Execution]]></title>
      <url>/2017/04/25/hive%E4%B8%AD%E4%BD%BF%E7%94%A8%E5%90%91%E9%87%8F%E5%8C%96%E6%9F%A5%E8%AF%A2%E5%BC%95%E6%93%8EVectorized-Query-Execution/</url>
      <content type="html"><![CDATA[<h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>向量化查询引擎可以在执行scan, filter, aggregate, join等操作的时候很大程度上降低CPU损耗。标准sql执行系统每次只处理一行数据，内部执行的时候会包括很长的代码路径和重要的metadata解析。向量化查询引擎简化了这个过程，一次读取1024行数据，在这个数据块中，每个字段都被存储成向量化的结构(一个原是数据类型的数组)。对于一些简单的算法可以通过快速迭代这个vector完成，只需要在循环过程中调用甚至不用调用几个函数。这些loop以一种流式方式编译，在固定时间内结束，为了提高效率，会使用processor pipline和内存缓存。<a href="https://issues.apache.org/jira/browse/HIVE-4160" target="_blank" rel="external">详细设计</a></p>
<p>个人理解：就是每行都执行很小的计算，但是要处理N多次。改成一次处理多行，同时针对多行做计算处理，节省CPU时间。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h4 id="启用"><a href="#启用" class="headerlink" title="启用"></a>启用</h4><p>要使用向量化查询引擎，必须先把hive表存储成ORC格式的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">set hive.vectorized.execution.enabled = true;</div></pre></td></tr></table></figure></p>
<p>默认是没有开启向量化查询引擎的，需要手动开启。</p>
<h4 id="支持的数据类型与操作"><a href="#支持的数据类型与操作" class="headerlink" title="支持的数据类型与操作"></a>支持的数据类型与操作</h4><ul>
<li>tinyint</li>
<li>smallint</li>
<li>int</li>
<li>bigint</li>
<li>boolean</li>
<li>float</li>
<li>double</li>
<li>decimal</li>
<li>date</li>
<li>timestamp (see Limitations below)</li>
<li>string<br>其他的数据类型还是会按照传统方式一行行处理。</li>
</ul>
<p>支持的表达式：</p>
<ul>
<li>简单算法: +, -, *, /, %</li>
<li>AND, OR, NOT</li>
<li>比较 &lt;, &gt;, &lt;=, &gt;=, =, !=, BETWEEN, IN ( list-of-constants ) as filters</li>
<li>布尔表达式 (non-filters) using AND, OR, NOT, &lt;, &gt;, &lt;=, &gt;=, =, !=</li>
<li>IS [NOT] NULL</li>
<li>所有的匹配函数 (SIN, LOG, etc.)</li>
<li>string相关函数 SUBSTR, CONCAT, TRIM, LTRIM, RTRIM, LOWER, UPPER, LENGTH</li>
<li>类型转换</li>
<li>UDF</li>
<li>日期函数 (YEAR, MONTH, DAY, HOUR, MINUTE, SECOND, UNIX_TIMESTAMP)</li>
<li>IF 条件表达式</li>
</ul>
<p>UDF通过向后兼容的方式支持，不过执行的时候就是执行向量化查询引擎，但是没有内置的快。向量化的filter操作是从左到右执行，所以最好把UDF放在带有and的where语句的最后：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">where column1 = 10 and myUDF(column2) = "x"</div></pre></td></tr></table></figure></p>
<h2 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h2><p>Timestamps 只能是 1677-09-20 到2262-04-11. </p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[集群service配置相关]]></title>
      <url>/2017/04/21/%E9%9B%86%E7%BE%A4service%E9%85%8D%E7%BD%AE%E7%9B%B8%E5%85%B3/</url>
      <content type="html"><![CDATA[<h2 id="YARN"><a href="#YARN" class="headerlink" title="YARN"></a>YARN</h2><table>
<thead>
<tr>
<th>服务名称</th>
<th>现有配置</th>
<th>TO </th>
</tr>
</thead>
<tbody>
<tr>
<td>resourcemanager</td>
<td>1G</td>
<td>4G</td>
</tr>
<tr>
<td>nodemanager</td>
<td>1G</td>
<td>2G</td>
</tr>
<tr>
<td>timeline server</td>
<td>1G</td>
<td>4G</td>
</tr>
</tbody>
</table>
<p>resource + timline server = 2G</p>
<h2 id="HDFS"><a href="#HDFS" class="headerlink" title="HDFS "></a>HDFS </h2><table>
<thead>
<tr>
<th>服务名称</th>
<th>现有配置</th>
<th>TO</th>
</tr>
</thead>
<tbody>
<tr>
<td>datanode</td>
<td>1G</td>
<td>2G</td>
</tr>
<tr>
<td>namenode</td>
<td>3G </td>
</tr>
</tbody>
</table>
<p>namenode * 2 =  6G</p>
<h2 id="MAPRED"><a href="#MAPRED" class="headerlink" title="MAPRED"></a>MAPRED</h2><table>
<thead>
<tr>
<th>服务名称</th>
<th>现有配置</th>
<th>TO</th>
</tr>
</thead>
<tbody>
<tr>
<td>history server</td>
<td>1G</td>
<td>2G</td>
</tr>
</tbody>
</table>
<h2 id="HIVE"><a href="#HIVE" class="headerlink" title="HIVE"></a>HIVE</h2><table>
<thead>
<tr>
<th>服务名称</th>
<th>配置</th>
</tr>
</thead>
<tbody>
<tr>
<td>hiveserver2</td>
<td>769M</td>
</tr>
<tr>
<td>metastore</td>
<td>1G</td>
</tr>
<tr>
<td>hcatserver</td>
<td>1G</td>
</tr>
</tbody>
</table>
<p>3G</p>
<h2 id="HBASE"><a href="#HBASE" class="headerlink" title="HBASE"></a>HBASE</h2><table>
<thead>
<tr>
<th>服务名称</th>
<th>配置</th>
</tr>
</thead>
<tbody>
<tr>
<td>regionserver</td>
<td>2G</td>
</tr>
<tr>
<td>master</td>
<td>1G</td>
</tr>
</tbody>
</table>
<p>regionserver <em> 8 + master </em> 2 = 18G</p>
<h2 id="ZK"><a href="#ZK" class="headerlink" title="ZK"></a>ZK</h2><table>
<thead>
<tr>
<th>服务名称</th>
<th>配置</th>
</tr>
</thead>
<tbody>
<tr>
<td>zk server</td>
<td>1G</td>
</tr>
</tbody>
</table>
<p>zk * 3 = 3G</p>
<h2 id="KAFKA"><a href="#KAFKA" class="headerlink" title="KAFKA"></a>KAFKA</h2><table>
<thead>
<tr>
<th>服务名称</th>
<th>配置</th>
</tr>
</thead>
<tbody>
<tr>
<td>broker</td>
<td>1G</td>
</tr>
</tbody>
</table>
<p>broker * 3 =3G</p>
<h2 id="SPAKR"><a href="#SPAKR" class="headerlink" title="SPAKR"></a>SPAKR</h2><table>
<thead>
<tr>
<th>服务名称</th>
<th>配置</th>
</tr>
</thead>
<tbody>
<tr>
<td>spark history server</td>
<td>1G</td>
</tr>
</tbody>
</table>
<h2 id="需要copy的机器"><a href="#需要copy的机器" class="headerlink" title="需要copy的机器"></a>需要copy的机器</h2><p>以下机器copy完成后，全部将内存提升至32G、CPU提升到8核</p>
<h5 id="迁出机器"><a href="#迁出机器" class="headerlink" title="迁出机器"></a>迁出机器</h5><ul>
<li>datanode15.will.com     -&gt; NM，DN</li>
<li>1.103-prd-datanode14.will.com   -&gt;kafka, DN,NM</li>
<li>1.108-prd-datanode19.will.com -&gt; regionserver, DN,NM</li>
<li>1.110-prd-datanode21.will.com -&gt; NM, DN</li>
<li>1.99-prd-datanode10.will.com -&gt; kafka, DB, NM</li>
<li>1.113-fengkong.data.com 风控 -&gt; NONE</li>
<li>1.87-prd-datanode05.data.com -&gt; DN, NM, regionserver</li>
<li>1.97-prd-datanode08.data.com -&gt; DN, NM, regionserver</li>
<li>1.95-prd-datanode06.data.com -&gt; kafka, DN, NM, SB HbaseMaster</li>
<li>1.96-prd-datanode07.data.com -&gt; DN, NM, regionserver</li>
</ul>
<p>原有机器迁出会占新资源的内存32G <em> 10 + CPU</em>80</p>
<h5 id="原有机器资源升级"><a href="#原有机器资源升级" class="headerlink" title="原有机器资源升级"></a>原有机器资源升级</h5><p>在原有资源基础上，添加16G内存，CPU核数翻倍【把迁移出去的机器空闲出来的资源充分利用】：</p>
<ul>
<li>1.107-prd-datanode18.will.com</li>
<li>1.109-prd-datanode20.will.com</li>
<li>1.102-prd-datanode13.will.com</li>
<li>1.106-prd-datanode17.will.com</li>
<li>1.100-prd-datanode11.will.com</li>
<li>1.98-prd-datanode09.will.com</li>
<li>1.110-prd-datanode21.will.com</li>
<li>1.86-prd-datanode04.data.com</li>
<li>1.82-prd-datanode01.data.com</li>
<li>1.83-prd-datanode02.data.com</li>
<li>1.84-prd-datanode03.data.com</li>
<li>1.105-prd-datanode16.will.com</li>
<li>1.101-prd-datanode12.will.com</li>
</ul>
<p>理论上，对原有机器不会有额外资源要求，对新机器资源也不会有影响。</p>
<h2 id="需要新建的机器"><a href="#需要新建的机器" class="headerlink" title="需要新建的机器"></a>需要新建的机器</h2><h4 id="新服务节点"><a href="#新服务节点" class="headerlink" title="新服务节点"></a>新服务节点</h4><p>可按照service01.will.com开始弄主机名。</p>
<p>单机配置： 32G内存 + 8核 + 50G硬【整机空间即可】 + CentOS release 6.8 (Final)</p>
<p>机器数量： 8台<br>共占：内存32G <em> 8 + CPU8 </em> 8 = 内存256G + CPU 64</p>
<h4 id="新数据节点"><a href="#新数据节点" class="headerlink" title="新数据节点"></a>新数据节点</h4><p>目前最新数据节点的主机名编号到了21，新机器可以datanode22.will.com开始。</p>
<p>单机配置：32G内存 + 8核CPU + 640G硬盘【/server/目录挂载空间】 + CentOS release 6.8 (Final)</p>
<p>机器数量： 12【如果物理机资源不够，可以暂时弄10台，以后酌情扩容】</p>
<p>共占：内存32G <em> 12 + CPU8 </em> 12 = 内存384G + CPU 96</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ambari中启用hive-ACID事务]]></title>
      <url>/2017/04/20/ambari%E4%B8%AD%E5%90%AF%E7%94%A8hive-ACID%E4%BA%8B%E5%8A%A1/</url>
      <content type="html"><![CDATA[<p>场景</p>
<ul>
<li>数据重新执行</li>
<li>数据流重新执行</li>
<li>逐渐改变的维度</li>
<li>维度历史变更</li>
</ul>
<p>标准sql通过insert、update、delete、事务还有最近出现的merge方式来提供acid操作。这些已经被证明足够使用的了。</p>
<h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><ul>
<li>事务表。hive支持单表事务，但是目标表必须需要声明是支持事务的。</li>
<li>分区表。hive支持表分区，把数据分开以提供快速查询。分区与ACID是相互独立的概念。通常大表都是有分区的。</li>
<li>ACID操作（insert/update/delete）。</li>
<li>主键</li>
<li>流式数据。数据可以通过storm、flume等流式进入hive的事务表中</li>
<li>优化并发。</li>
<li>压缩。数据必须时段性的被压缩一下，节省空间，优化数据访问。最好让系统自动处理这件事情。，不过也可以设置外部的调度器。</li>
</ul>
<h4 id="启用ACID事务"><a href="#启用ACID事务" class="headerlink" title="启用ACID事务"></a>启用ACID事务</h4><h4 id="hello"><a href="#hello" class="headerlink" title="hello"></a>hello</h4><p>创建一个事务表，并插入一些数据<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> hello_acid;</div><div class="line"><span class="keyword">create</span> <span class="keyword">table</span> hello_acid (<span class="keyword">key</span> <span class="built_in">int</span>, <span class="keyword">value</span> <span class="built_in">int</span>)</div><div class="line">partitioned <span class="keyword">by</span> (load_date <span class="built_in">date</span>)</div><div class="line">clustered <span class="keyword">by</span>(<span class="keyword">key</span>) <span class="keyword">into</span> <span class="number">3</span> buckets</div><div class="line"><span class="keyword">stored</span> <span class="keyword">as</span> orc tblproperties (<span class="string">'transactional'</span>=<span class="string">'true'</span>);</div></pre></td></tr></table></figure></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> hello_acid <span class="keyword">partition</span> (load_date=<span class="string">'2016-03-01'</span>) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>);</div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> hello_acid <span class="keyword">partition</span> (load_date=<span class="string">'2016-03-02'</span>) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">2</span>);</div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> hello_acid <span class="keyword">partition</span> (load_date=<span class="string">'2016-03-03'</span>) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">3</span>);</div><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> hello_acid;</div></pre></td></tr></table></figure>
<p>删除数据：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">delete</span> <span class="keyword">from</span> hello_acid <span class="keyword">where</span> <span class="keyword">key</span> = <span class="number">2</span>;</div><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> hello_acid;</div></pre></td></tr></table></figure></p>
<p>更新数据：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">update</span> hello_acid <span class="keyword">set</span> <span class="keyword">value</span> = <span class="number">10</span> <span class="keyword">where</span> <span class="keyword">key</span> = <span class="number">3</span>;</div><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> hello_acid;</div></pre></td></tr></table></figure></p>
<p>这些DML语句意在在大数据中执行少量修改，应该是记录级别的数据管理。如果你有小的多个批量修改，应该使用streaming data ingestion。</p>
<h4 id="Streaming-Data-Ingestion"><a href="#Streaming-Data-Ingestion" class="headerlink" title="Streaming Data Ingestion"></a>Streaming Data Ingestion</h4><p>许多时候我们需要处理连续的实时数据流，想要更方便的操作这些数据。hive可以自动把流式数据加入hive表中，也支持实时的数据抽取与查询。</p>
<p>现在hive提供两种：</p>
<ul>
<li>已经存在是<a href="https://github.com/apache/storm/tree/master/external/storm-hive" target="_blank" rel="external">storm hive bolt</a>方案，<a href="https://flume.apache.org/FlumeUserGuide.html#hive-sink" target="_blank" rel="external">flume hive sink</a>方案。这些工具对数据有较少的操作，重在转移数据</li>
<li>直接使用低级的<a href="https://cwiki.apache.org/confluence/display/Hive/Streaming+Data+Ingest" target="_blank" rel="external">Streaming Ingest API</a>.</li>
</ul>
<p>在使用streaming api之前，需要先创建好分区事务表。从查询角度来看，一切应该都是确定好的。</p>
<h4 id="4-实践"><a href="#4-实践" class="headerlink" title="4. 实践"></a>4. 实践</h4><p>插入几条数据对我们测试起来很简单，但是实际环境中，我们需要一次性处理几千或者几百万的数据。下面我们通过几个通用场景讨论一下怎样处理数据批次。</p>
<p>这些模型需要你建立一个主键。hive并不强制主键唯一，所以你必须在你app中控制一下。虽然hive2.1介绍了non-validating 外键，但是这东西目前还并没有被完整全面的验证过。</p>
<h5 id="4-1-searched-updates"><a href="#4-1-searched-updates" class="headerlink" title="4.1 searched updates"></a>4.1 searched updates</h5><p>hive  ACID支持searched updates，这是一种常见的更新方式。注意，基于hive ACID的架构，更新必须通过批处理的方式执行。一次更新一行这种事情在实际使用中是行不通的。如果想通过某种方式一次性更新大量数据，那么searched updates就可以帮你了。</p>
<p>假设有一个维度表，包含的一个flag，指示当前记录是不是最新的值。这样我们就可以沿时间追踪维度变更情况。当维度表发生更新的时候，我们就把已经存在记录的设置成old。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> mydim;</div><div class="line"><span class="keyword">create</span> <span class="keyword">table</span> mydim (<span class="keyword">key</span> <span class="built_in">int</span>, <span class="keyword">name</span> <span class="keyword">string</span>, zip <span class="keyword">string</span>, is_current <span class="built_in">boolean</span>)</div><div class="line">clustered <span class="keyword">by</span>(<span class="keyword">key</span>) <span class="keyword">into</span> <span class="number">3</span> buckets</div><div class="line"><span class="keyword">stored</span> <span class="keyword">as</span> orc tblproperties (<span class="string">'transactional'</span>=<span class="string">'true'</span>);</div></pre></td></tr></table></figure></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> mydim <span class="keyword">values</span></div><div class="line">  (<span class="number">1</span>, <span class="string">'bob'</span>,   <span class="string">'95136'</span>, <span class="literal">true</span>),</div><div class="line">  (<span class="number">2</span>, <span class="string">'joe'</span>,   <span class="string">'70068'</span>, <span class="literal">true</span>),</div><div class="line">  (<span class="number">3</span>, <span class="string">'steve'</span>, <span class="string">'22150'</span>, <span class="literal">true</span>);</div></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> updates_staging_table;</div><div class="line"><span class="keyword">create</span> <span class="keyword">table</span> updates_staging_table (<span class="keyword">key</span> <span class="built_in">int</span>, newzip <span class="keyword">string</span>);</div><div class="line"><span class="keyword">insert</span> <span class="keyword">into</span> updates_staging_table <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">87102</span>), (<span class="number">3</span>, <span class="number">45220</span>);</div></pre></td></tr></table></figure>
<p>执行更新,执行前后可以看一下维度表的数据变化，其实就是更新了flag而已。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">update</span> mydim <span class="keyword">set</span> is_current=<span class="literal">false</span></div><div class="line">  <span class="keyword">where</span> mydim.key <span class="keyword">in</span> (<span class="keyword">select</span> <span class="keyword">key</span> <span class="keyword">from</span> updates_staging_table);</div></pre></td></tr></table></figure></p>
<h5 id="4-2-searched-deletes"><a href="#4-2-searched-deletes" class="headerlink" title="4.2 searched deletes"></a>4.2 searched deletes</h5><p>批量删除也可以使用staging table轻松搞定。但是需要你在表之间放置一个公共key，有些类似RDBMS中的主键。<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">delete</span> <span class="keyword">from</span> mydim</div><div class="line"><span class="keyword">where</span> mydim.key <span class="keyword">in</span> (<span class="keyword">select</span> <span class="keyword">key</span> <span class="keyword">from</span> updates_staging_table);</div><div class="line"><span class="keyword">select</span> * <span class="keyword">from</span> mydim;</div></pre></td></tr></table></figure></p>
<h4 id="5-批量覆盖更新"><a href="#5-批量覆盖更新" class="headerlink" title="5. 批量覆盖更新"></a>5. 批量覆盖更新</h4><p>有的时候我们需要批量更新一些数据。例如第一种SCD更新或者数据重导。hive目前还不支持merge操作，在支持之前，我们只能考虑使用先删除后插入的方式，但这样可能会造成查询客户端脏读。或者也可以在重新清洗的时候临时停掉查询。</p>
<h4 id="6-ACID工具"><a href="#6-ACID工具" class="headerlink" title="6. ACID工具"></a>6. ACID工具</h4><p>ACID事务执行过程中会创建一系列的锁。事务和他们的事务锁可以通过hive的一些工具来查看。</p>
<h5 id="6-1-查看事务"><a href="#6-1-查看事务" class="headerlink" title="6.1 查看事务"></a>6.1 查看事务</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">show transactions</div></pre></td></tr></table></figure>
<h5 id="6-1-查看锁"><a href="#6-1-查看锁" class="headerlink" title="6.1 查看锁"></a>6.1 查看锁</h5><p>有read, update，X lock。update锁与update操作互斥，但是与read兼容。X锁，与所有锁都互斥，属于独占。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">show locks</div></pre></td></tr></table></figure></p>
<h5 id="6-1-终止事务"><a href="#6-1-终止事务" class="headerlink" title="6.1 终止事务"></a>6.1 终止事务</h5><p>注意这并不会马上kill掉所有相关查询。ACID查询是周期性执行的，默认是2.5分钟，如果他们检测到自己的事务被kill，就会执行自动退出。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">abort transactions T1 T2 T3</div></pre></td></tr></table></figure></p>
<h4 id="7-性能考虑"><a href="#7-性能考虑" class="headerlink" title="7. 性能考虑"></a>7. 性能考虑</h4><ul>
<li>创建分区</li>
<li>insert快，update和delete都会比较慢一些，因为要扫描整个分区。</li>
<li>如果你们的工作里需要大量更新数据，那么请周期行执行compaction操作。不然数据大小会越来越大，查询也会越来越慢。</li>
</ul>
<h4 id="8-深入探究"><a href="#8-深入探究" class="headerlink" title="8. 深入探究"></a>8. 深入探究</h4><p>在使用之前一定要深入了解这套系统的工作原理，并且在你的可以容忍丢失的数据上执行测试。过程中也注意备份数据。</p>
<p>ACID表有一个隐藏字段<code>row__id</code>。这个系统内置的字段名称有可能会变。你应该构建一个基于这个字段的长远的方案。</p>
<p>这个字段记录的内容有：</p>
<ul>
<li>数据被insert或者update的active的事务id</li>
<li>数据所在bucket的bucketid</li>
<li>此次事务或者bucket中的rowid</li>
</ul>
<p>看一下<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">hive&gt; select row__id from hello_acid;</div><div class="line">OK</div><div class="line">&#123;"transactionid":12,"bucketid":0,"rowid":0&#125;</div><div class="line">&#123;"transactionid":10,"bucketid":1,"rowid":0&#125;</div></pre></td></tr></table></figure></p>
<p>常用场景就是确认所有的数据都load进来了。假设上游数据provider认为hive里的持久化数据丢失了，那么你的provider(storm Bolt比如)就会告诉你插入这些数据的事务ID。然后我们可以使用这个事务id计算一下实际的记录数。查询的时候使用X替换掉你的事务ID<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">set</span> hive.optimize.ppd=<span class="literal">false</span>;</div><div class="line"><span class="keyword">select</span> <span class="keyword">count</span>(*) <span class="keyword">from</span> hello_acid <span class="keyword">where</span> row__id.transactionid = X;</div></pre></td></tr></table></figure></p>
<p>记牢，事务中插入的数据有可能会被后续的update或者delete语句影响到，所以如果count数并不符合，那就可能是这些因素造成的。</p>
<p>参考：</p>
<p><a href="https://hortonworks.com/hadoop-tutorial/using-hive-acid-transactions-insert-update-delete-data/" target="_blank" rel="external">https://hortonworks.com/hadoop-tutorial/using-hive-acid-transactions-insert-update-delete-data/</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[HIVE创建bucketed表]]></title>
      <url>/2017/04/20/HIVE%E5%88%9B%E5%BB%BAbucketed%E8%A1%A8/</url>
      <content type="html"><![CDATA[<p>建表语句<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">CREATE TABLE user_info_bucketed(user_id BIGINT, firstname STRING, lastname STRING)</div><div class="line">COMMENT &apos;A bucketed copy of user_info&apos;</div><div class="line">PARTITIONED BY(ds STRING)</div><div class="line">CLUSTERED BY(user_id) INTO 256 BUCKETS;</div></pre></td></tr></table></figure></p>
<p>基于字段user_id分桶的。</p>
<p>使用<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">set</span> hive.enforce.bucketing = <span class="literal">true</span>;  <span class="comment">-- (<span class="doctag">Note:</span> Not needed in Hive 2.x onward)</span></div><div class="line">FROM user_id</div><div class="line"><span class="keyword">INSERT</span> OVERWRITE <span class="keyword">TABLE</span> user_info_bucketed</div><div class="line"><span class="keyword">PARTITION</span> (ds=<span class="string">'2009-02-25'</span>)</div><div class="line"><span class="keyword">SELECT</span> userid, firstname, lastname <span class="keyword">WHERE</span> ds=<span class="string">'2009-02-25'</span>;</div></pre></td></tr></table></figure></p>
<p>hive怎样把row打散到不同的bucket中去的呢？一般是决定于hash函数，使用什么hash函数又取决于分桶字段的类型。比如整型字段就使用hash_int函数。</p>
<p>注意，如果分桶字段类型不同于insert进来的数据类型会出错的，或者手动使用不同类型的数据执行分桶操作也会出错。只要设置了<code>set hive.enforce.bucketing=true</code>，就能够正确的把数据发布到对应的地方。</p>
<p>再来一个例子<br>Bucketed Sorted Table<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> page_view(viewTime <span class="built_in">INT</span>, userid <span class="built_in">BIGINT</span>,</div><div class="line">     page_url <span class="keyword">STRING</span>, referrer_url <span class="keyword">STRING</span>,</div><div class="line">     ip <span class="keyword">STRING</span> <span class="keyword">COMMENT</span> <span class="string">'IP Address of the User'</span>)</div><div class="line"> <span class="keyword">COMMENT</span> <span class="string">'This is the page view table'</span></div><div class="line"> PARTITIONED <span class="keyword">BY</span>(dt <span class="keyword">STRING</span>, country <span class="keyword">STRING</span>)</div><div class="line"> CLUSTERED <span class="keyword">BY</span>(userid) SORTED <span class="keyword">BY</span>(viewTime) <span class="keyword">INTO</span> <span class="number">32</span> BUCKETS</div><div class="line"> <span class="keyword">ROW</span> <span class="keyword">FORMAT</span> <span class="keyword">DELIMITED</span></div><div class="line">   <span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'\001'</span></div><div class="line">   COLLECTION ITEMS <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'\002'</span></div><div class="line">   <span class="keyword">MAP</span> <span class="keyword">KEYS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'\003'</span></div><div class="line"> <span class="keyword">STORED</span> <span class="keyword">AS</span> SEQUENCEFILE;</div></pre></td></tr></table></figure></p>
<p>这个表根据userid分桶，每个bucket中按照viewTime升序排列。这种组织结果允许用户更高效的抽取clustered的字段，这里就是userid字段了。排序属性让内部操作能够快速处理估算查询的任务。MAP KEYS和COLLECTION ITEMS关键词可以用来处理字段是list或者map的情况。</p>
<p>CLUSTERED BY 和 SORTED BY并不影响insert数据。用户需要注意reducer数必须要跟bucket的数量一致，在query语句中还要使用CLUSTER BY 和SORT BY语句。</p>
<p>还有一种倾斜表。适用于某些表中确认包含倾斜数据的情况。通过指定倾斜key，hive会把他们打散到不同的文件中。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> list_bucket_single (<span class="keyword">key</span> <span class="keyword">STRING</span>, <span class="keyword">value</span> <span class="keyword">STRING</span>)</div><div class="line">  SKEWED <span class="keyword">BY</span> (<span class="keyword">key</span>) <span class="keyword">ON</span> (<span class="number">1</span>,<span class="number">5</span>,<span class="number">6</span>) [<span class="keyword">STORED</span> <span class="keyword">AS</span> DIRECTORIES];</div></pre></td></tr></table></figure>
<p>下面这个是有两个倾斜key<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">CREATE TABLE list_bucket_multiple (col1 STRING, col2 int, col3 STRING)</div><div class="line">  SKEWED BY (col1, col2) ON ((&apos;s1&apos;,1), (&apos;s3&apos;,3), (&apos;s13&apos;,13), (&apos;s78&apos;,78)) [STORED AS DIRECTORIES];</div></pre></td></tr></table></figure></p>
<p>参考：</p>
<ul>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL+BucketedTables" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL+BucketedTables</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-BucketedSortedTables" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-BucketedSortedTables</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[关于hive-update]]></title>
      <url>/2017/04/19/%E5%85%B3%E4%BA%8Ehive-update/</url>
      <content type="html"><![CDATA[<h2 id="ACID"><a href="#ACID" class="headerlink" title="ACID"></a>ACID</h2><ul>
<li>A: atomicity。原子性，一个操作要么成功要么失败，不能存在中间状态。</li>
<li>C：consistency。一致性。一旦某个操作完成之后，后续所有的操作都能访问到上个操作完成之后的状态</li>
<li>I：isolation。隔离性。一个未完成的操作只对当前操作用户有影响，不能影响到其他用户</li>
<li>D：durability。持久性。一个操作完成之后，就会把成功的状态持久化，即便系统挂掉也要持久化。</li>
</ul>
<p>0.13版本之前，只在分区层次上支持原子性、一致性、持久性。隔离性通过调整可用的锁机制来达成(通过zk或者内存)。0.13之后完全支持了row级别的ACID，这样就可以在别人读取数据的时候添加行，也不会有影响。</p>
<h4 id="用例"><a href="#用例" class="headerlink" title="用例"></a>用例</h4><p>一般具有ACID特性的事务适用于以下场景</p>
<ul>
<li>流式数据接受。许多用户使用flume、storm、kafka等将数据放到hadoop集群中。这些工具可能会以每秒几百条甚至更多的速度写入。hive只能每十五分钟或者1个小时创建一个分区来接受他们。添加分区的策略会导致表里的分区暴增。也可以把流式数据放到既有的分区中，但是这会导致用户脏读（他们可能会看到一些他们开始查询时还没有的数据），还有就是会有很多的小文件产生，这对namenode也是一个很大的压力。有了ACID之后，就可以解决这个问题了</li>
<li>慢慢改变的维度表。在一个典型的星型数据仓库架构中，维度表可能会随着时间推移慢慢修改。例如，零售商可能会慢慢增开新店，那么新店就应该被添加到store表里，或者已经存在的店面可能会修改店面大小或者其他的因素。这些改变都会产生数据的insert或者update。从0.14开始，支持了</li>
<li>数据重导。有时手机来的数据发现不对，需要纠正。或者，开始有90%的数据，后面又有全量数据了。或者业务规则改变需要修改对应规则的一些数据。0.14之后用户可以insert、update、delete。</li>
<li>使用SQL MERGE语句批量更新。</li>
</ul>
<h4 id="限制"><a href="#限制" class="headerlink" title="限制"></a>限制</h4><ul>
<li>BEGIN,COMMIT,ROLLBACK目前还不支持。所有的语言都是auto-commit。后面版本会支持</li>
<li>只支持ORC的文件格式。</li>
<li>默认这种事务是关闭的。</li>
<li>数据表必须是bucketed的。外部表不支持ACID，因为它不受compactor的控制<a href="https://issues.apache.org/jira/browse/HIVE-13175" target="_blank" rel="external">HIVE-13175</a></li>
<li>在一个非ACID的session里执行ACID操作是不可以的。hive的事务manager必须设置成  <code>org.apache.hadoop.hive.ql.lockmgr.DbTxnManager</code>才能使用ACID表。</li>
<li>目前只支持快照级别的隔离性。当一个查询开始后，会给它提供一个一致的数据快照。不支持dirty read, read committed, repeatable read, seializable。</li>
<li>已经存在的zk或者内存锁manager与此类事务并不兼容。这里不详说了，参考<a href="https://cwiki.apache.org/confluence/display/Hive/Hive+Transactions#HiveTransactions-BasicDesign" target="_blank" rel="external">这里</a></li>
<li><p>使用oracle作为元数据库可能会有些问题，设置<code>datanucleus.connectionPoolingType=DBCP</code></p>
<h4 id="语法改变"><a href="#语法改变" class="headerlink" title="语法改变"></a>语法改变</h4></li>
<li><p>添加了 <code>SHOW TRANSACTIONS</code>、<code>SHOW COMPACTIONS</code>、<code>ABORT TRANSACTIONS</code></p>
</li>
<li><code>SHOW LOCKS</code>命令改成了提供事务相关的锁的信息。如果在使用ak或者内存的lock manager的话，你会发现其实输出的东西没什么区别。</li>
<li>alter table的时候增加了一个是否执行表或者分区的压缩。通常用户不用管，系统会自动做这些事情。然而，如果compaction被关闭了，那么系统就不会自动处理了。alter table用来初始化压缩。具体参考<a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+DDL#LanguageManualDDL-AlterTable/PartitionCompact" target="_blank" rel="external">这里</a>。这会把压缩请求放进一个队列里。要看压缩进度的话，就使用<code>SHOW COMPACTIONS</code>语句。</li>
</ul>
<h4 id="基本设计"><a href="#基本设计" class="headerlink" title="基本设计"></a>基本设计</h4><p>HDFS是不支持直接修改文件的。当有人写数据到文件的时候也不提供读的一致性。为了提供这些特性，我们使用了其他的数据仓库工具。表和分区的数据存在一系列的base文件里。新的insert、update、delete存在delta文件中，读取的时候把这些更新都执行上。</p>
<h5 id="base和delta文件夹"><a href="#base和delta文件夹" class="headerlink" title="base和delta文件夹"></a>base和delta文件夹</h5><p>以前一个分区的所有文件都放在一个单独的目录下。ACID的writer会有一个base文件的目录，还有一堆delta文件的目录。下面是一个没有分区的数据表“t”<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">hive&gt; dfs -ls -R /user/hive/warehouse/t;</div><div class="line">drwxr-xr-x   - ekoifman staff          0 2016-06-09 17:03 /user/hive/warehouse/t/base_0000022</div><div class="line">-rw-r--r--   1 ekoifman staff        602 2016-06-09 17:03 /user/hive/warehouse/t/base_0000022/bucket_00000</div><div class="line">drwxr-xr-x   - ekoifman staff          0 2016-06-09 17:06 /user/hive/warehouse/t/delta_0000023_0000023_0000</div><div class="line">-rw-r--r--   1 ekoifman staff        611 2016-06-09 17:06 /user/hive/warehouse/t/delta_0000023_0000023_0000/bucket_00000</div><div class="line">drwxr-xr-x   - ekoifman staff          0 2016-06-09 17:07 /user/hive/warehouse/t/delta_0000024_0000024_0000</div><div class="line">-rw-r--r--   1 ekoifman staff        610 2016-06-09 17:07 /user/hive/warehouse/t/delta_0000024_0000024_0000/bucket_00000</div></pre></td></tr></table></figure></p>
<h5 id="compactor"><a href="#compactor" class="headerlink" title="compactor"></a>compactor</h5><p>compactor是在metastore中运行的一系列的后台进程，用来支持ACID系统。包含Initiator, Worker, Cleaner,AcidHouseKeeperService等。</p>
<h6 id="delta文件压缩"><a href="#delta文件压缩" class="headerlink" title="delta文件压缩"></a>delta文件压缩</h6><p>随着修改表数据的操作越来越多，delta文件也越来越多，需要压缩提高后面的处理效率。类似hbase，也是有minor compaction和major compaction</p>
<ul>
<li>Minor compaction把已经存在的同一个bucket的多个delta文件合并成一个</li>
<li>Majro compaction把bucket中的base文件和delta文件合并到一个新的base文件。这个会耗时多一些，不过也更高效。</li>
</ul>
<p>压缩工作是后台自动运行的，不会阻止并发的读写操作。执行压缩之后，系统会等用户读完所有的旧文件之后移除这些旧文件。</p>
<h6 id="Initiator"><a href="#Initiator" class="headerlink" title="Initiator"></a>Initiator</h6><p>这个模块是负责发现哪些table或者分区需要压缩。使用<code>hive.compactor.initiator.on</code>参数启用。每个compaction task负责处理一个分区(没分区的就是一个表)。如果连续压缩失败，超过<code>hive.compactor.initiator.failed.compacts.threshold</code>设置的阈值,就停止compaction了。</p>
<h6 id="Worker"><a href="#Worker" class="headerlink" title="Worker"></a>Worker</h6><p>一个Woker处理一个compaction task。通常是MR任务，名字格式是：主机名-compactor-数据库.表名.分区。使用<code>hive.compactor.worker.threads</code>设置每个metastore启动的compactor线程数。</p>
<h6 id="Cleaner"><a href="#Cleaner" class="headerlink" title="Cleaner"></a>Cleaner</h6><p>用来删除压缩之后，之前的一些旧文件</p>
<h6 id="AcidHouseKeeperService"><a href="#AcidHouseKeeperService" class="headerlink" title="AcidHouseKeeperService"></a>AcidHouseKeeperService</h6><p>找到心跳超时<code>hive.txn.timeout</code>的事务，终止它。释放资源。</p>
<h4 id="SHOW-COMPACTIONS"><a href="#SHOW-COMPACTIONS" class="headerlink" title="SHOW COMPACTIONS"></a>SHOW COMPACTIONS</h4><p>这个命令用来显示目前正在运行的compaction信息，还有最近的压缩历史。</p>
<h4 id="事务-锁-manager"><a href="#事务-锁-manager" class="headerlink" title="事务/锁 manager"></a>事务/锁 manager</h4><p>添加了新的逻辑实体<code>事务管理器</code>，包含原有的<code>database/table/partition lock manager</code>的概念在里面。原来默认的<code>hive.lock.manager</code>是<code>org.apache.hadoop.hive.ql.lockmgr.zookeeper.ZooKeeperHiveLockManager</code>。新的事务管理器现在也负责管理事务锁了。默认的<code>DummyTxnManager</code>跟原有版本的hive一样：并没有事务，使用hive.lock.manager来为表、分区、数据库创建lock manager。新的<code>DbTxnManager</code>使用hive metastore中的<code>DbLockManager</code>管理所有的锁与事务（系统挂掉也不会碍事儿）。这就是说启用事务特性之后，并没有必要弄什么zookeeper来搞这些了。为了避免客户端挂掉、离开当前事务、或者锁悬停的情况，我们需要锁的拥有者和事务发起者以一定频率发送心跳给metastore。如果心跳超时几次，那么这个锁或者食物就会被终止。</p>
<p>在1.3.0版本中，DbLockManager会持续重试去获取锁。每次获取不到，都会double下一次获取锁的时间间隔，再重试，以支持短时间的查询，也降低metastore压力。假设初始等待时间是100ms，如果重试10次的话，总时间会是91m:42s:300ms。</p>
<p>注意DbTxnManager的lock manager会获取所有表的锁。默认情况下，对于非事务表的insert操作会获取一个排它锁，不允许其他的读写操作。虽然从技术角度来看是正确的，但是违背hive的传统工作方式的。为了向后兼容，提供了<code>hive.txn.strict.locking.mode</code>参数，可以让lock manager在对于非事务表insert操作的时候获取共享锁。这样就保证在读取的时候，不会出现数据被drop的情况。注意，对于事务表，insert操作是总会获取共享锁的，因为这些表在存储层支持MVCC架构，即便有并发写的时候也能够提供对于读的强一致性(快照隔离).</p>
<h6 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h6><p>客户端</p>
<ul>
<li>hive.support.concurrency - true</li>
<li>hive.enforce.bucketing - true(2.0版本后不需要)</li>
<li>hive.exec.dynamic.partition.mode - nonstrict</li>
<li>hive.txn.manager - org.apache.hadoop.hive.ql.lockmgr.DbTxnManager</li>
</ul>
<p>服务端(metastore)</p>
<ul>
<li>hive.compactor.initiator.on - true</li>
<li>hive.compactor.worker.threads - 正数就行，看情况</li>
</ul>
<h4 id="事务相关的新配置参数"><a href="#事务相关的新配置参数" class="headerlink" title="事务相关的新配置参数"></a>事务相关的新配置参数</h4><h4 id="表属性"><a href="#表属性" class="headerlink" title="表属性"></a>表属性</h4><p>如果一个表要使用ACID写操作，那么必须在表上设置<code>transactional=true</code>。从0.14.0开始，一旦一个表通过·TBLPROPERTIES (“transactional”=”true”)·定义为一个ACID表之后，就不能在改成非ACID表了，就是说不能执行TBLPROPERTIES (“transactional”=”false”) 这种修改。还有，hive.txn.manager必须设置为org.apache.hadoop.hive.ql.lockmgr.DbTxnManager, 可以再hive-site.xml里设置，也可以在session开始的时候设置。不然insert就会按照老的方式运行，delete操作会被禁止。</p>
<p>如果一个表的owner不想让系统自动决定什么时候compact，那就在表上设置<code>NO_AUTO_COMPACTION</code>。</p>
<p>在表创建之后表属性通过TBLPROPERTIES语句设置。</p>
<p>更多关于压缩的选项可以通过TBLPROPERTIES设置。可以在创建表时设置，也可以执行修改表的时候设置。例如，要覆盖一个压缩任务的MR参数，就可在创建表或者修改表的时候加上<code>compactor.&lt;mr property&gt;=xx</code>。</p>
<p>表级别设置<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> table_name (</div><div class="line">  <span class="keyword">id</span>                <span class="built_in">int</span>,</div><div class="line">  <span class="keyword">name</span>              <span class="keyword">string</span></div><div class="line">)</div><div class="line">CLUSTERED <span class="keyword">BY</span> (<span class="keyword">id</span>) <span class="keyword">INTO</span> <span class="number">2</span> BUCKETS <span class="keyword">STORED</span> <span class="keyword">AS</span> ORC</div><div class="line">TBLPROPERTIES (<span class="string">"transactional"</span>=<span class="string">"true"</span>,</div><div class="line">  <span class="string">"compactor.mapreduce.map.memory.mb"</span>=<span class="string">"2048"</span>,     <span class="comment">-- specify compaction map job properties</span></div><div class="line">  <span class="string">"compactorthreshold.hive.compactor.delta.num.threshold"</span>=<span class="string">"4"</span>,  <span class="comment">-- trigger minor compaction if there are more than 4 delta directories</span></div><div class="line">  <span class="string">"compactorthreshold.hive.compactor.delta.pct.threshold"</span>=<span class="string">"0.5"</span> <span class="comment">-- trigger major compaction if the ratio of size of delta files to</span></div><div class="line">                                                                   <span class="comment">-- size of base files is greater than 50%</span></div><div class="line">);</div></pre></td></tr></table></figure></p>
<p>单次请求时候设置<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">COMPACT</span> <span class="string">'minor'</span> </div><div class="line">   <span class="keyword">WITH</span> OVERWRITE TBLPROPERTIES (<span class="string">"compactor.mapreduce.map.memory.mb"</span>=<span class="string">"3072"</span>);  <span class="comment">-- specify compaction map job properties</span></div><div class="line"><span class="keyword">ALTER</span> <span class="keyword">TABLE</span> table_name <span class="keyword">COMPACT</span> <span class="string">'major'</span></div><div class="line">   <span class="keyword">WITH</span> OVERWRITE TBLPROPERTIES (<span class="string">"tblprops.orc.compress.size"</span>=<span class="string">"8192"</span>);         <span class="comment">-- change any other Hive table properties</span></div></pre></td></tr></table></figure></p>
<p>参考：<br><a href="https://cwiki.apache.org/confluence/display/Hive/Hive+Transactions" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/Hive+Transactions</a></p>
<p><a href="https://hortonworks.com/hadoop-tutorial/using-hive-acid-transactions-insert-update-delete-data/" target="_blank" rel="external">https://hortonworks.com/hadoop-tutorial/using-hive-acid-transactions-insert-update-delete-data/</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[gradle一次性配置所有的maven仓库]]></title>
      <url>/2017/04/17/gradle%E4%B8%80%E6%AC%A1%E6%80%A7%E9%85%8D%E7%BD%AE%E6%89%80%E6%9C%89%E7%9A%84maven%E4%BB%93%E5%BA%93/</url>
      <content type="html"><![CDATA[<p>在~/.gradle/init.gradle文件中添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">allprojects&#123;</div><div class="line">    repositories &#123;</div><div class="line">        def REPOSITORY_URL = &apos;http://maven.oschina.net/content/groups/public&apos;</div><div class="line">        all &#123; ArtifactRepository repo -&gt;</div><div class="line">            if(repo instanceof MavenArtifactRepository)&#123;</div><div class="line">                def url = repo.url.toString()</div><div class="line">                if (url.startsWith(&apos;https://repo1.maven.org/maven2&apos;) || url.startsWith(&apos;https://jcenter.bintray.com/&apos;)) &#123;</div><div class="line">                    project.logger.lifecycle &quot;Repository $&#123;repo.url&#125; replaced by $REPOSITORY_URL.&quot;</div><div class="line">                    remove repo</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        maven &#123;</div><div class="line">            url REPOSITORY_URL</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>参考：</p>
<ul>
<li><a href="https://docs.gradle.org/current/userguide/init_scripts.html" target="_blank" rel="external">https://docs.gradle.org/current/userguide/init_scripts.html</a></li>
<li><a href="https://yrom.net/blog/2015/02/07/change-gradle-maven-repo-url/" target="_blank" rel="external">https://yrom.net/blog/2015/02/07/change-gradle-maven-repo-url/</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[linkedin--gobblin]]></title>
      <url>/2017/04/16/linkedin--gobblin/</url>
      <content type="html"><![CDATA[<p>这些年来，linkedin的数据设施团队为集成多种数据源到hadoop生态系统中提供了很多解决方案。目前，有15中整合pipeline正在运行，包含重要的数据质量、元数据管理、元数据开发、运维相关的调整等等。</p>
<p>这些挑战与经验促使我们构建了gobblin。gobblin是为从各种数据源【数据库、rest api、 ftp server， 文件等】抽取、转化、加载数据到hadoop上。gobblin包含了日常通用的数据ETL操作任务，如任务调度、任务分区、错误处理、状态管理、数据质量检测、数据发布等等。Gobblin把多种数据源集成进同样的执行框架中，然后在同一个地方管理不同的数据源的元数据。 还有自动扩容、容错、数据质量保证、扩展性高、处理数据模型演化等特性，gobblin很易用、而且可以自我服务，是一个高效的数据集成框架。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ambari给hbase添加component]]></title>
      <url>/2017/04/05/ambari%E7%BB%99hbase%E6%B7%BB%E5%8A%A0component/</url>
      <content type="html"><![CDATA[<p>因为原生的ambari并没有原生支持habse的thriftserver在UI端操作。而且业务部门需要使用这个，我们运维的过程中，总是需要去到指定机器启动才行，不太方便，总会遗漏。所以添加到ambari的hbase service里。</p>
<p>ps:<br>按照参考的位置<code>/var/lib/ambari-server/resources/stacks/HDP/2.4/services/HBASE/metainfo.xml</code>里面空空如也。</p>
<h2 id="添加component"><a href="#添加component" class="headerlink" title="添加component"></a>添加component</h2><p>编辑/var/lib/ambari-server/resources/common-services/HBASE/0.96.0.2.0/metainfo.xml文件，添加对应component<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">  <span class="tag">&lt;<span class="name">component</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>HBASE_THRIFT_SERVER<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">displayName</span>&gt;</span>ThriftServer<span class="tag">&lt;/<span class="name">displayName</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">category</span>&gt;</span>MASTER<span class="tag">&lt;/<span class="name">category</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">cardinality</span>&gt;</span>1+<span class="tag">&lt;/<span class="name">cardinality</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">versionAdvertised</span>&gt;</span>true<span class="tag">&lt;/<span class="name">versionAdvertised</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">timelineAppid</span>&gt;</span>HBASE<span class="tag">&lt;/<span class="name">timelineAppid</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">commandScript</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="undefined">scripts/hbase_thrift_server.py</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">scriptType</span>&gt;</span>PYTHON<span class="tag">&lt;/<span class="name">scriptType</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">commandScript</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">component</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="添加对应脚本"><a href="#添加对应脚本" class="headerlink" title="添加对应脚本"></a>添加对应脚本</h2><p><code>/var/lib/ambari-server/resources/common-services/HBASE/0.96.0.2.0/package/scripts/hbase_thrift_server.py</code>:<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="keyword">from</span> resource_management <span class="keyword">import</span> *</div><div class="line"><span class="keyword">from</span> resource_management.libraries.functions.security_commons <span class="keyword">import</span> build_expectations, \</div><div class="line">  cached_kinit_executor, get_params_from_filesystem, validate_security_config_properties, \</div><div class="line">  FILE_TYPE_XML</div><div class="line"><span class="keyword">from</span> hbase <span class="keyword">import</span> hbase</div><div class="line"><span class="keyword">from</span> hbase_service <span class="keyword">import</span> hbase_service</div><div class="line"><span class="keyword">import</span> upgrade</div><div class="line"><span class="keyword">from</span> ambari_commons <span class="keyword">import</span> OSCheck, OSConst</div><div class="line"><span class="keyword">from</span> ambari_commons.os_family_impl <span class="keyword">import</span> OsFamilyImpl</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">HbaseThriftServer</span><span class="params">(Script)</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">install</span><span class="params">(self, env)</span>:</span></div><div class="line">   <span class="comment"># import params</span></div><div class="line">   <span class="comment"># self.install_packages(env, params.exclude_packages)</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"Decommission not yet implemented!"</span></div><div class="line">   </div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">configure</span><span class="params">(self, env)</span>:</span></div><div class="line">   <span class="comment"># import params</span></div><div class="line">   <span class="comment"># env.set_params(params)</span></div><div class="line">   <span class="comment"># hbase(name='thrift')</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"Decommission not yet implemented!"</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">decommission</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"Decommission not yet implemented!"</span></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@OsFamilyImpl(os_family=OsFamilyImpl.DEFAULT)</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">HbaseThriftServerDefault</span><span class="params">(HbaseThriftServer)</span>:</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">get_stack_to_component</span><span class="params">(self)</span>:</span></div><div class="line">    <span class="keyword">return</span> &#123;<span class="string">"HDP"</span>: <span class="string">"hbase-thrift"</span>&#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">pre_upgrade_restart</span><span class="params">(self, env, upgrade_type=None)</span>:</span></div><div class="line">    <span class="keyword">import</span> params</div><div class="line">    env.set_params(params)</div><div class="line">    upgrade.prestart(env, <span class="string">"hbase-thrift"</span>)</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">post_upgrade_restart</span><span class="params">(self, env, upgrade_type=None)</span>:</span></div><div class="line">    <span class="keyword">import</span> params</div><div class="line">    env.set_params(params)</div><div class="line">    upgrade.post_thrift(env)</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self, env, upgrade_type=None)</span>:</span></div><div class="line">    <span class="keyword">import</span> params</div><div class="line">    env.set_params(params)</div><div class="line">    self.configure(env) <span class="comment"># for security</span></div><div class="line">    hbase_service( <span class="string">'thrift'</span>,</div><div class="line">      action = <span class="string">'start'</span></div><div class="line">    )</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">stop</span><span class="params">(self, env, upgrade_type=None)</span>:</span></div><div class="line">    <span class="keyword">import</span> params</div><div class="line">    env.set_params(params)</div><div class="line"></div><div class="line">    hbase_service( <span class="string">'thrift'</span>,</div><div class="line">      action = <span class="string">'stop'</span></div><div class="line">    )</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">status</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">import</span> status_params</div><div class="line">    env.set_params(status_params)</div><div class="line">    pid_file = format(<span class="string">"&#123;pid_dir&#125;/hbase-&#123;hbase_user&#125;-thrift.pid"</span>)</div><div class="line">    check_process_status(pid_file)</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">security_status</span><span class="params">(self, env)</span>:</span></div><div class="line">    <span class="keyword">import</span> status_params</div><div class="line"></div><div class="line">    env.set_params(status_params)</div><div class="line">    <span class="keyword">if</span> status_params.security_enabled:</div><div class="line">      props_value_check = &#123;<span class="string">"hbase.security.authentication"</span> : <span class="string">"kerberos"</span>,</div><div class="line">                           <span class="string">"hbase.security.authorization"</span>: <span class="string">"true"</span>&#125;</div><div class="line">      props_empty_check = [<span class="string">'hbase.thrift.keytab.file'</span>,</div><div class="line">                           <span class="string">'hbase.thrift.kerberos.principal'</span>]</div><div class="line">      props_read_check = [<span class="string">'hbase.thrift.keytab.file'</span>]</div><div class="line">      hbase_site_expectations = build_expectations(<span class="string">'hbase-site'</span>, props_value_check, props_empty_check,</div><div class="line">                                                   props_read_check)</div><div class="line"></div><div class="line">      hbase_expectations = &#123;&#125;</div><div class="line">      hbase_expectations.update(hbase_site_expectations)</div><div class="line"></div><div class="line">      security_params = get_params_from_filesystem(status_params.hbase_conf_dir,</div><div class="line">                                                   &#123;<span class="string">'hbase-site.xml'</span>: FILE_TYPE_XML&#125;)</div><div class="line">      result_issues = validate_security_config_properties(security_params, hbase_expectations)</div><div class="line">      <span class="keyword">if</span> <span class="keyword">not</span> result_issues:  <span class="comment"># If all validations passed successfully</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">          <span class="comment"># Double check the dict before calling execute</span></div><div class="line">          <span class="keyword">if</span> ( <span class="string">'hbase-site'</span> <span class="keyword">not</span> <span class="keyword">in</span> security_params</div><div class="line">               <span class="keyword">or</span> <span class="string">'hbase.thrift.keytab.file'</span> <span class="keyword">not</span> <span class="keyword">in</span> security_params[<span class="string">'hbase-site'</span>]</div><div class="line">               <span class="keyword">or</span> <span class="string">'hbase.thrift.kerberos.principal'</span> <span class="keyword">not</span> <span class="keyword">in</span> security_params[<span class="string">'hbase-site'</span>]):</div><div class="line">            self.put_structured_out(&#123;<span class="string">"securityState"</span>: <span class="string">"UNSECURED"</span>&#125;)</div><div class="line">            self.put_structured_out(</div><div class="line">              &#123;<span class="string">"securityIssuesFound"</span>: <span class="string">"Keytab file or principal are not set property."</span>&#125;)</div><div class="line">            <span class="keyword">return</span></div><div class="line"></div><div class="line">          cached_kinit_executor(status_params.kinit_path_local,</div><div class="line">                                status_params.hbase_user,</div><div class="line">                                security_params[<span class="string">'hbase-site'</span>][<span class="string">'hbase.thrift.keytab.file'</span>],</div><div class="line">                                security_params[<span class="string">'hbase-site'</span>][<span class="string">'hbase.thrift.kerberos.principal'</span>],</div><div class="line">                                status_params.hostname,</div><div class="line">                                status_params.tmp_dir)</div><div class="line">          self.put_structured_out(&#123;<span class="string">"securityState"</span>: <span class="string">"SECURED_KERBEROS"</span>&#125;)</div><div class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</div><div class="line">          self.put_structured_out(&#123;<span class="string">"securityState"</span>: <span class="string">"ERROR"</span>&#125;)</div><div class="line">          self.put_structured_out(&#123;<span class="string">"securityStateErrorInfo"</span>: str(e)&#125;)</div><div class="line">      <span class="keyword">else</span>:</div><div class="line">        issues = []</div><div class="line">        <span class="keyword">for</span> cf <span class="keyword">in</span> result_issues:</div><div class="line">          issues.append(<span class="string">"Configuration file %s did not pass the validation. Reason: %s"</span> % (cf, result_issues[cf]))</div><div class="line">        self.put_structured_out(&#123;<span class="string">"securityIssuesFound"</span>: <span class="string">". "</span>.join(issues)&#125;)</div><div class="line">        self.put_structured_out(&#123;<span class="string">"securityState"</span>: <span class="string">"UNSECURED"</span>&#125;)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">      self.put_structured_out(&#123;<span class="string">"securityState"</span>: <span class="string">"UNSECURED"</span>&#125;)</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</div><div class="line">  HbaseThriftServer().execute()</div></pre></td></tr></table></figure></p>
<p>其实是copy的regionserver的脚本，因为install什么的都不用，所以就全设置为print了。</p>
<h2 id="重启ambari-server"><a href="#重启ambari-server" class="headerlink" title="重启ambari-server"></a>重启ambari-server</h2><h2 id="添加hbase服务"><a href="#添加hbase服务" class="headerlink" title="添加hbase服务"></a>添加hbase服务</h2><h2 id="插曲"><a href="#插曲" class="headerlink" title="插曲"></a>插曲</h2><p>install的时候出现错误，启动的时候也会这样。。。看来是应该先注册一下自己的名字：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">2017-04-05 09:32:30,375 - Could not determine HDP version for component hbase-thrift by calling &apos;/usr/bin/hdp-select status hbase-thrift &gt; /tmp/tmpa6nhtU&apos;. Return Code: 1, Output: ERROR: Invalid package - hbase-thrift</div><div class="line"></div><div class="line">Packages:</div><div class="line">  accumulo-client</div><div class="line">  accumulo-gc</div><div class="line">  accumulo-master</div><div class="line">  accumulo-monitor</div><div class="line">  accumulo-tablet</div><div class="line">  accumulo-tracer</div><div class="line">  atlas-server</div><div class="line">  falcon-client</div><div class="line">  falcon-server</div><div class="line">  flume-server</div><div class="line">  hadoop-client</div><div class="line">  hadoop-hdfs-datanode</div><div class="line">  hadoop-hdfs-journalnode</div><div class="line">  hadoop-hdfs-namenode</div><div class="line">  hadoop-hdfs-nfs3</div><div class="line">  hadoop-hdfs-portmap</div><div class="line">  hadoop-hdfs-secondarynamenode</div><div class="line">  hadoop-httpfs</div><div class="line">  hadoop-mapreduce-historyserver</div><div class="line">  hadoop-yarn-nodemanager</div><div class="line">  hadoop-yarn-resourcemanager</div><div class="line">  hadoop-yarn-timelineserver</div><div class="line">  hbase-client</div><div class="line">  hbase-master</div><div class="line">  hbase-regionserver</div><div class="line">  hive-metastore</div><div class="line">  hive-server2</div><div class="line">  hive-webhcat</div><div class="line">  kafka-broker</div><div class="line">  knox-server</div><div class="line">  livy-server</div><div class="line">  mahout-client</div><div class="line">  oozie-client</div><div class="line">  oozie-server</div><div class="line">  phoenix-client</div><div class="line">  phoenix-server</div><div class="line">  ranger-admin</div><div class="line">  ranger-kms</div><div class="line">  ranger-usersync</div><div class="line">  slider-client</div><div class="line">  spark-client</div><div class="line">  spark-historyserver</div><div class="line">  spark-thriftserver</div><div class="line">  sqoop-client</div><div class="line">  sqoop-server</div><div class="line">  storm-client</div><div class="line">  storm-nimbus</div><div class="line">  storm-slider-client</div><div class="line">  storm-supervisor</div><div class="line">  zeppelin-server</div><div class="line">  zookeeper-client</div><div class="line">  zookeeper-server</div><div class="line">Aliases:</div><div class="line">  accumulo-server</div><div class="line">  all</div><div class="line">  client</div><div class="line">  hadoop-hdfs-server</div><div class="line">  hadoop-mapreduce-server</div><div class="line">  hadoop-yarn-server</div><div class="line">  hive-server</div><div class="line">.</div></pre></td></tr></table></figure></p>
<p>找了老半天，问题竟然在shell里，服了。<br>在/usr/bin/hdp-select里的leaves字典里添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&quot;hbase-thrift&quot;: &quot;hbase&quot;,</div></pre></td></tr></table></figure></p>
<p>然后还要创建一个目录才行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ln -s /usr/hdp/2.4.2.0-258/hbase-regionserver /usr/hdp/current/hbase-thrift</div></pre></td></tr></table></figure></p>
<p>参考：</p>
<ul>
<li><a href="https://cwiki.apache.org/confluence/display/AMBARI/Defining+a+Custom+Stack+and+Services" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/AMBARI/Defining+a+Custom+Stack+and+Services</a></li>
<li></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hdfs-ACL开启后出现问题]]></title>
      <url>/2017/04/01/hdfs-ACL%E5%BC%80%E5%90%AF%E5%90%8E%E5%87%BA%E7%8E%B0%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<p>已经用测试环境重现了此问题。</p>
<ol>
<li>启用namenode的acl，在hdfs-site.xml中添加</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;property&gt;</div><div class="line">    &lt;name&gt;dfs.namenode.acls.enabled&lt;/name&gt;</div><div class="line">    &lt;value&gt;true&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div></pre></td></tr></table></figure>
<ol>
<li><p>使用root用户创建初始文件夹, 并给以同生产环境的ACL设置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">root@will-vm:/opt/hadoop-2.7.1# ./bin/hdfs dfs -mkdir -p /tmp/ods_tinyv_outer.db/channel=wb</div><div class="line">root@will-vm:/opt/hadoop-2.7.1# ./bin/hdfs dfs -getfacl /tmp/ods_tinyv_outer.db/channel=wb</div><div class="line"># file: /tmp/ods_tinyv_outer.db/channel=wb</div><div class="line"># owner: root</div><div class="line"># group: supergroup</div><div class="line">user::rwx</div><div class="line">group::r-x</div><div class="line">other::r-x</div><div class="line"></div><div class="line">root@will-vm:/opt/hadoop-2.7.1# ./bin/hdfs dfs -setfacl -R -m default:user::rwx /tmp/ods_tinyv_outer.db</div><div class="line">root@will-vm:/opt/hadoop-2.7.1# ./bin/hdfs dfs -setfacl -R -m default:group:wil:rwx /tmp/ods_tinyv_outer.db</div><div class="line"></div><div class="line">root@will-vm:/opt/hadoop-2.7.1# ./bin/hdfs dfs -getfacl /tmp/ods_tinyv_outer.db/channel=wb</div><div class="line"># file: /tmp/ods_tinyv_outer.db/channel=wb</div><div class="line"># owner: root</div><div class="line"># group: supergroup</div><div class="line">user::rwx</div><div class="line">group::r-x</div><div class="line">other::r-x</div><div class="line">default:user::rwx</div><div class="line">default:group::r-x</div><div class="line">default:group:wil:rwx</div><div class="line">default:mask::rwx</div><div class="line">default:other::r-x</div><div class="line">root@will-vm:/opt/hadoop-2.7.1# ./bin/hdfs dfs -chown -R wil:wil /tmp/ods_tinyv_outer.db/channel=wb</div><div class="line">root@will-vm:/opt/hadoop-2.7.1# ./bin/hdfs dfs -getfacl /tmp/ods_tinyv_outer.db/channel=wb</div><div class="line"># file: /tmp/ods_tinyv_outer.db/channel=wb</div><div class="line"># owner: wil</div><div class="line"># group: wil</div><div class="line">user::rwx</div><div class="line">group::r-x</div><div class="line">other::r-x</div><div class="line">default:user::rwx</div><div class="line">default:group::r-x</div><div class="line">default:group:wil:rwx</div><div class="line">default:mask::rwx</div><div class="line">default:other::r-x</div><div class="line">root@will-vm:/opt/hadoop-2.7.1# ./bin/hdfs dfs -chmod 770 /tmp/ods_tinyv_outer.db/channel=wb</div><div class="line">root@will-vm:/opt/hadoop-2.7.1# ./bin/hdfs dfs -getfacl /tmp/ods_tinyv_outer.db/channel=wb</div><div class="line"># file: /tmp/ods_tinyv_outer.db/channel=wb</div><div class="line"># owner: wil</div><div class="line"># group: wil</div><div class="line">user::rwx</div><div class="line">group::rwx</div><div class="line">other::---</div><div class="line">default:user::rwx</div><div class="line">default:group::r-x</div><div class="line">default:group:wil:rwx</div><div class="line">default:mask::rwx</div><div class="line">default:other::r-x</div></pre></td></tr></table></figure>
</li>
<li><p>重现问题</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">wil@will-vm:/opt/hadoop-2.7.1$ ./bin/hdfs dfs -rmr /tmp/ods_tinyv_outer.db/channel=wb</div><div class="line">rmr: DEPRECATED: Please use &apos;rm -r&apos; instead.</div><div class="line">17/04/02 23:01:41 INFO fs.TrashPolicyDefault: Namenode trash configuration: Deletion interval = 0 minutes, Emptier interval = 0 minutes.</div><div class="line">rmr: Permission denied: user=wil, access=WRITE, inode=&quot;/tmp/ods_tinyv_outer.db/channel=wb&quot;:root:supergroup:drwxr-xr-x</div></pre></td></tr></table></figure>
</li>
</ol>
<p>这个文件明明是属于wil用户wil用户组的，并且从acl来看是有权限的。然而实际执行的时候，却提示没权，而且列出来的权限竟然是<code>:root:supergroup:drwxr-xr-x</code>，这个应该是刚刚创建时的权限。</p>
<ol>
<li>解决<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">root@will-vm:/opt/hadoop-2.7.1# ./bin/hdfs dfs -chown wil:wil /tmp/ods_tinyv_outer.db</div></pre></td></tr></table></figure>
</li>
</ol>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hue metastore引出的HDFS权限问题]]></title>
      <url>/2017/03/31/hue-metastore%E5%BC%95%E5%87%BA%E7%9A%84HDFS%E6%9D%83%E9%99%90%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<h2 id="需求"><a href="#需求" class="headerlink" title="需求"></a>需求</h2><p>支持的某个事业部提出一个需求：<strong>在hue里开放修改表或者字段的权限</strong>。</p>
<p>在hue里就给她一个人开了相应的权限，账户名是wcq。因为不知道wcq的密码，所以使用的mm的测试账户登陆的，<strong>在hue里给了两个人相同的权限组：lv和metastoremanger</strong>。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>然而奇怪的现象就发生了：<strong>wcq在hue的metastore管理界面修改表的字段之后，看网络请求是成功了的。然而，刷新页面以后就没有了。mm这个账户确都可以使用。</strong></p>
<h2 id="追查"><a href="#追查" class="headerlink" title="追查"></a>追查</h2><p>经查验，mm这个用户在HDFS中除了是lv组的用户，而且还是hdfs组的用户，而<strong>hdfs组是超级用户组，拥有任何权限</strong>。所以这两个用户所在的组并不是对等的，只是在hue里对等而已。</p>
<p>理论上如果hue直接操作hive元数据库的话是不会有此问题的。</p>
<h4 id="查一下网络请求有什么异常？"><a href="#查一下网络请求有什么异常？" class="headerlink" title="查一下网络请求有什么异常？"></a>查一下网络请求有什么异常？</h4><p>发送的request包摘要：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Request URL:http://10.1.5.83/metastore/table/dim_tinyv/data_dict/alter_column</div><div class="line">Request Method:POST</div><div class="line"></div><div class="line">column:id</div><div class="line">comment:ss</div></pre></td></tr></table></figure></p>
<p>返回的response内容：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"status"</span>: <span class="number">0</span>,</div><div class="line">    <span class="attr">"message"</span>: <span class="string">""</span>,</div><div class="line">    <span class="attr">"data"</span>: &#123;</div><div class="line">        <span class="attr">"comment"</span>: <span class="string">""</span>,</div><div class="line">        <span class="attr">"type"</span>: <span class="string">"int"</span>,</div><div class="line">        <span class="attr">"name"</span>: <span class="string">"id"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="hue源码确认逻辑"><a href="#hue源码确认逻辑" class="headerlink" title="hue源码确认逻辑"></a>hue源码确认逻辑</h4><p>以url为线索查看hue相关源码<code>apps/metastore/src/metastore/urls.py</code>中找到<code>alter_table</code>，在<code>apps/metastore/src/metastore/views.py</code>里：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">check_has_write_access_permission</div><div class="line"><span class="meta">@require_http_methods(["POST"])</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">alter_column</span><span class="params">(request, database, table)</span>:</span></div><div class="line">  db = dbms.get(request.user)</div><div class="line">  response = &#123;<span class="string">'status'</span>: <span class="number">-1</span>, <span class="string">'message'</span>: <span class="string">''</span>&#125;</div><div class="line">  <span class="keyword">try</span>:</div><div class="line">    column = request.POST.get(<span class="string">'column'</span>, <span class="keyword">None</span>)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> column <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">      <span class="keyword">raise</span> PopupException(_(<span class="string">'alter_column requires a column parameter'</span>))</div><div class="line"></div><div class="line">    column_obj = db.get_column(database, table, column)</div><div class="line">    <span class="keyword">if</span> column_obj:</div><div class="line">      new_column_name = request.POST.get(<span class="string">'new_column_name'</span>, column_obj.name)</div><div class="line">      new_column_type = request.POST.get(<span class="string">'new_column_type'</span>, column_obj.type)</div><div class="line">      comment = request.POST.get(<span class="string">'comment'</span>, <span class="keyword">None</span>)</div><div class="line">      partition_spec = request.POST.get(<span class="string">'partition_spec'</span>, <span class="keyword">None</span>)</div><div class="line"></div><div class="line">      column_obj = db.alter_column(database, table, column, new_column_name, new_column_type, comment=comment, partition_spec=partition_spec)</div><div class="line"></div><div class="line">      response[<span class="string">'status'</span>] = <span class="number">0</span></div><div class="line">      response[<span class="string">'data'</span>] = &#123;</div><div class="line">        <span class="string">'name'</span>: column_obj.name,</div><div class="line">        <span class="string">'type'</span>: column_obj.type,</div><div class="line">        <span class="string">'comment'</span>: column_obj.comment</div><div class="line">      &#125;</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">      <span class="keyword">raise</span> PopupException(_(<span class="string">'Column `%s`.`%s` `%s` not found'</span>) % (database, table, column))</div><div class="line">  <span class="keyword">except</span> Exception, ex:</div><div class="line">    response[<span class="string">'status'</span>] = <span class="number">1</span></div><div class="line">    response[<span class="string">'message'</span>] = _(<span class="string">"Failed to alter column `%s`.`%s` `%s`: %s"</span>) % (database, table, column, str(ex))</div><div class="line"></div><div class="line">  <span class="keyword">return</span> JsonResponse(response)</div></pre></td></tr></table></figure>
<p>看到是使用了dbms里返回的数据库执行的语句，找到<code>apps/beeswax/src/beeswax/server/dbms.py</code>，对应代码：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(user, query_server=None)</span>:</span></div><div class="line">  <span class="keyword">global</span> DBMS_CACHE</div><div class="line">  <span class="keyword">global</span> DBMS_CACHE_LOCK</div><div class="line"></div><div class="line">  <span class="keyword">if</span> query_server <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">    query_server = get_query_server_config()</div><div class="line"></div><div class="line">  DBMS_CACHE_LOCK.acquire()</div><div class="line">  <span class="keyword">try</span>:</div><div class="line">    DBMS_CACHE.setdefault(user.username, &#123;&#125;)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> query_server[<span class="string">'server_name'</span>] <span class="keyword">not</span> <span class="keyword">in</span> DBMS_CACHE[user.username]:</div><div class="line">      <span class="comment"># Avoid circular dependency</span></div><div class="line">      <span class="keyword">from</span> beeswax.server.hive_server2_lib <span class="keyword">import</span> HiveServerClientCompatible</div><div class="line"></div><div class="line">      <span class="keyword">if</span> query_server[<span class="string">'server_name'</span>] == <span class="string">'impala'</span>:</div><div class="line">        <span class="keyword">from</span> impala.dbms <span class="keyword">import</span> ImpalaDbms</div><div class="line">        <span class="keyword">from</span> impala.server <span class="keyword">import</span> ImpalaServerClient</div><div class="line">        DBMS_CACHE[user.username][query_server[<span class="string">'server_name'</span>]] = ImpalaDbms(HiveServerClientCompatible(ImpalaServerClient(query_server, user)), QueryHistory.SERVER_TYPE[<span class="number">1</span>][<span class="number">0</span>])</div><div class="line">      <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">from</span> beeswax.server.hive_server2_lib <span class="keyword">import</span> HiveServerClient</div><div class="line">        DBMS_CACHE[user.username][query_server[<span class="string">'server_name'</span>]] = HiveServer2Dbms(HiveServerClientCompatible(HiveServerClient(query_server, user)), QueryHistory.SERVER_TYPE[<span class="number">1</span>][<span class="number">0</span>])</div><div class="line"></div><div class="line">    <span class="keyword">return</span> DBMS_CACHE[user.username][query_server[<span class="string">'server_name'</span>]]</div><div class="line">  <span class="keyword">finally</span>:</div><div class="line">    DBMS_CACHE_LOCK.release()</div></pre></td></tr></table></figure></p>
<p>可以看到是使用hiveserver2建立连接，搞定的。并不是最开始猜测的直接操作hive的元数据库。</p>
<p>修改数据字段的方法也在这里：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">alter_column</span><span class="params">(self, database, table_name, column_name, new_column_name, column_type, comment=None,</span></span></div><div class="line">                   partition_spec=None, cascade=False):</div><div class="line">    hql = <span class="string">'ALTER TABLE `%s`.`%s`'</span> % (database, table_name)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> partition_spec:</div><div class="line">      hql += <span class="string">' PARTITION (%s)'</span> % partition_spec</div><div class="line"></div><div class="line">    hql += <span class="string">' CHANGE COLUMN `%s` `%s` %s'</span> % (column_name, new_column_name, column_type.upper())</div><div class="line"></div><div class="line">    <span class="keyword">if</span> comment:</div><div class="line">      hql += <span class="string">" COMMENT '%s'"</span> % comment</div><div class="line"></div><div class="line">    <span class="keyword">if</span> cascade:</div><div class="line">      hql += <span class="string">' CASCADE'</span></div><div class="line"></div><div class="line">    timeout = SERVER_CONN_TIMEOUT.get()</div><div class="line">    query = hql_query(hql)</div><div class="line">    handle = self.execute_and_wait(query, timeout_sec=timeout)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> handle:</div><div class="line">      self.close(handle)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">      msg = _(<span class="string">"Failed to execute alter column statement: %s"</span>) % hql</div><div class="line">      <span class="keyword">raise</span> QueryServerException(msg)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> self.get_column(database, table_name, new_column_name)</div></pre></td></tr></table></figure></p>
<h4 id="执行相应逻辑"><a href="#执行相应逻辑" class="headerlink" title="执行相应逻辑"></a>执行相应逻辑</h4><p>这样的话，我们直接在命令行里，切换到wcq用户执行hive命令行，应该是一样的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hive&gt; alter table default.batting CHANGE COLUMN dtdontquery dtdontquery string COMMENT &apos;ss&apos;;</div><div class="line">FAILED: Execution Error, return code 1 from org.apache.hadoop.hive.ql.exec.DDLTask. Unable to alter table. java.security.AccessControlException: Permission denied: user=wcq, access=WRITE, inode=&quot;/apps/hive/warehouse/batting&quot;:root:jlc:drwxr-xr-x</div></pre></td></tr></table></figure></p>
<p>此阶段结论：<strong>hue通过hiveserver执行hql语句，而且hive本身修改表元数据的时候也会验证是否有对HDFS目录有写权限</strong>。</p>
<h2 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h2><p>那么应该怎样解决呢？</p>
<p>当前的目录权限都是给的：<code>drwxr-x---</code>，也就是只有owner有写权限, 指定组的用户有读权限，匿名用户没有任何权限。</p>
<p>这样授权的理由在于，以事业部为组，所有同一个事业部的人都可读，但是只能通过我们的数据平台用户来进行写操作【当前是root】。</p>
<p>既不想违背这个初衷，又要满足新的需求，再不进行任何自主研发的前提下，只能<strong>启用HDFS的ACL</strong>，才能添加额外的权限。</p>
<p>hue中也支持*ACL修改，而且执行遍历目录修改.</p>
<p>步骤如下：<br><img src="/imgs/hue_acl/hue_dfs_acl_1.png" alt=""><br><img src="/imgs/hue_acl/hue_dfs_acl_2.png" alt=""><br><img src="/imgs/hue_acl/hue_dfs_acl_3.png" alt=""><br><img src="/imgs/hue_acl/hue_dfs_acl_4.png" alt=""></p>
<h2 id="遗留"><a href="#遗留" class="headerlink" title="遗留"></a>遗留</h2><p>对官网说的mask不太理解。字面意思好像是用来过滤所有用户、组、匿名组的权限的。</p>
<p>以官网例子来看：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">user::rw-</div><div class="line"> user:bruce:rwx                  #effective:r--</div><div class="line"> group::r-x                      #effective:r--</div><div class="line"> group:sales:rwx                 #effective:r--</div><div class="line"> mask::r--</div><div class="line"> other::r--</div></pre></td></tr></table></figure></p>
<p>因为上面指定的mask是只读，所以即便其他指定了额外的权限也是白费的，生效的只有只读。所以这样理解，mask就是这个文件可以有的所有权限的总和。如果不单独设置mask的话，其默认值也是这样算出来的。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-hdfs/HdfsPermissionsGuide.html#The_Super-User" target="_blank" rel="external">https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-hdfs/HdfsPermissionsGuide.html#The_Super-User</a></li>
<li><a href="https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-common/FileSystemShell.html#setfacl" target="_blank" rel="external">https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-common/FileSystemShell.html#setfacl</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> hdfs </tag>
            
            <tag> hue </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[HDFS权限问题]]></title>
      <url>/2017/03/31/HDFS%E6%9D%83%E9%99%90%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<p>支持的某个事业部提出一个需求：在hue里开放修改表或者字段的权限。</p>
<p>在hue里就给她一个人开了相应的权限，账户名是wcq。因为不知道wcq的密码，所以使用的mm的测试账户登陆的，<strong>在hue里给了两个人相同的权限组：lv和metastoremanger</strong>。</p>
<p>然而奇怪的现象就发生了：<strong>wcq在hue的metastore管理界面修改表的字段之后，看网络请求是成功了的。然而，刷新页面以后就没有了。mm这个账户确都可以使用。</strong></p>
<p>经查验，mm这个用户在HDFS中除了是lv组的用户，而且还是hdfs组的用户，而<strong>hdfs组是超级用户组，拥有任何权限</strong>。所以这两个用户所在的组并不是对等的，只是在hue里对等而已。</p>
<p>理论上如果hue直接操作hive元数据库的话是不会有此问题的。</p>
<p>查一下网络请求有什么异常？<br>发送的request包摘要：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Request URL:http://10.1.5.83/metastore/table/dim_tinyv/data_dict/alter_column</div><div class="line">Request Method:POST</div><div class="line"></div><div class="line">column:id</div><div class="line">comment:ss</div></pre></td></tr></table></figure></p>
<p>返回的response内容：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"status"</span>: <span class="number">0</span>,</div><div class="line">    <span class="attr">"message"</span>: <span class="string">""</span>,</div><div class="line">    <span class="attr">"data"</span>: &#123;</div><div class="line">        <span class="attr">"comment"</span>: <span class="string">""</span>,</div><div class="line">        <span class="attr">"type"</span>: <span class="string">"int"</span>,</div><div class="line">        <span class="attr">"name"</span>: <span class="string">"id"</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>以url为线索查看hue相关源码<code>apps/metastore/src/metastore/urls.py</code>中找到<code>alter_table</code>，在<code>apps/metastore/src/metastore/views.py</code>里：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">check_has_write_access_permission</div><div class="line"><span class="meta">@require_http_methods(["POST"])</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">alter_column</span><span class="params">(request, database, table)</span>:</span></div><div class="line">  db = dbms.get(request.user)</div><div class="line">  response = &#123;<span class="string">'status'</span>: <span class="number">-1</span>, <span class="string">'message'</span>: <span class="string">''</span>&#125;</div><div class="line">  <span class="keyword">try</span>:</div><div class="line">    column = request.POST.get(<span class="string">'column'</span>, <span class="keyword">None</span>)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> column <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">      <span class="keyword">raise</span> PopupException(_(<span class="string">'alter_column requires a column parameter'</span>))</div><div class="line"></div><div class="line">    column_obj = db.get_column(database, table, column)</div><div class="line">    <span class="keyword">if</span> column_obj:</div><div class="line">      new_column_name = request.POST.get(<span class="string">'new_column_name'</span>, column_obj.name)</div><div class="line">      new_column_type = request.POST.get(<span class="string">'new_column_type'</span>, column_obj.type)</div><div class="line">      comment = request.POST.get(<span class="string">'comment'</span>, <span class="keyword">None</span>)</div><div class="line">      partition_spec = request.POST.get(<span class="string">'partition_spec'</span>, <span class="keyword">None</span>)</div><div class="line"></div><div class="line">      column_obj = db.alter_column(database, table, column, new_column_name, new_column_type, comment=comment, partition_spec=partition_spec)</div><div class="line"></div><div class="line">      response[<span class="string">'status'</span>] = <span class="number">0</span></div><div class="line">      response[<span class="string">'data'</span>] = &#123;</div><div class="line">        <span class="string">'name'</span>: column_obj.name,</div><div class="line">        <span class="string">'type'</span>: column_obj.type,</div><div class="line">        <span class="string">'comment'</span>: column_obj.comment</div><div class="line">      &#125;</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">      <span class="keyword">raise</span> PopupException(_(<span class="string">'Column `%s`.`%s` `%s` not found'</span>) % (database, table, column))</div><div class="line">  <span class="keyword">except</span> Exception, ex:</div><div class="line">    response[<span class="string">'status'</span>] = <span class="number">1</span></div><div class="line">    response[<span class="string">'message'</span>] = _(<span class="string">"Failed to alter column `%s`.`%s` `%s`: %s"</span>) % (database, table, column, str(ex))</div><div class="line"></div><div class="line">  <span class="keyword">return</span> JsonResponse(response)</div></pre></td></tr></table></figure>
<p>看到是使用了dbms里返回的数据库执行的语句，找到<code>apps/beeswax/src/beeswax/server/dbms.py</code>，对应代码：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span><span class="params">(user, query_server=None)</span>:</span></div><div class="line">  <span class="keyword">global</span> DBMS_CACHE</div><div class="line">  <span class="keyword">global</span> DBMS_CACHE_LOCK</div><div class="line"></div><div class="line">  <span class="keyword">if</span> query_server <span class="keyword">is</span> <span class="keyword">None</span>:</div><div class="line">    query_server = get_query_server_config()</div><div class="line"></div><div class="line">  DBMS_CACHE_LOCK.acquire()</div><div class="line">  <span class="keyword">try</span>:</div><div class="line">    DBMS_CACHE.setdefault(user.username, &#123;&#125;)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> query_server[<span class="string">'server_name'</span>] <span class="keyword">not</span> <span class="keyword">in</span> DBMS_CACHE[user.username]:</div><div class="line">      <span class="comment"># Avoid circular dependency</span></div><div class="line">      <span class="keyword">from</span> beeswax.server.hive_server2_lib <span class="keyword">import</span> HiveServerClientCompatible</div><div class="line"></div><div class="line">      <span class="keyword">if</span> query_server[<span class="string">'server_name'</span>] == <span class="string">'impala'</span>:</div><div class="line">        <span class="keyword">from</span> impala.dbms <span class="keyword">import</span> ImpalaDbms</div><div class="line">        <span class="keyword">from</span> impala.server <span class="keyword">import</span> ImpalaServerClient</div><div class="line">        DBMS_CACHE[user.username][query_server[<span class="string">'server_name'</span>]] = ImpalaDbms(HiveServerClientCompatible(ImpalaServerClient(query_server, user)), QueryHistory.SERVER_TYPE[<span class="number">1</span>][<span class="number">0</span>])</div><div class="line">      <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">from</span> beeswax.server.hive_server2_lib <span class="keyword">import</span> HiveServerClient</div><div class="line">        DBMS_CACHE[user.username][query_server[<span class="string">'server_name'</span>]] = HiveServer2Dbms(HiveServerClientCompatible(HiveServerClient(query_server, user)), QueryHistory.SERVER_TYPE[<span class="number">1</span>][<span class="number">0</span>])</div><div class="line"></div><div class="line">    <span class="keyword">return</span> DBMS_CACHE[user.username][query_server[<span class="string">'server_name'</span>]]</div><div class="line">  <span class="keyword">finally</span>:</div><div class="line">    DBMS_CACHE_LOCK.release()</div></pre></td></tr></table></figure></p>
<p>可以看到是使用hiveserver2建立连接，搞定的。并不是最开始猜测的直接操作hive的元数据库。</p>
<p>修改数据字段的方法也在这里：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">alter_column</span><span class="params">(self, database, table_name, column_name, new_column_name, column_type, comment=None,</span></span></div><div class="line">                   partition_spec=None, cascade=False):</div><div class="line">    hql = <span class="string">'ALTER TABLE `%s`.`%s`'</span> % (database, table_name)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> partition_spec:</div><div class="line">      hql += <span class="string">' PARTITION (%s)'</span> % partition_spec</div><div class="line"></div><div class="line">    hql += <span class="string">' CHANGE COLUMN `%s` `%s` %s'</span> % (column_name, new_column_name, column_type.upper())</div><div class="line"></div><div class="line">    <span class="keyword">if</span> comment:</div><div class="line">      hql += <span class="string">" COMMENT '%s'"</span> % comment</div><div class="line"></div><div class="line">    <span class="keyword">if</span> cascade:</div><div class="line">      hql += <span class="string">' CASCADE'</span></div><div class="line"></div><div class="line">    timeout = SERVER_CONN_TIMEOUT.get()</div><div class="line">    query = hql_query(hql)</div><div class="line">    handle = self.execute_and_wait(query, timeout_sec=timeout)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> handle:</div><div class="line">      self.close(handle)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">      msg = _(<span class="string">"Failed to execute alter column statement: %s"</span>) % hql</div><div class="line">      <span class="keyword">raise</span> QueryServerException(msg)</div><div class="line"></div><div class="line">    <span class="keyword">return</span> self.get_column(database, table_name, new_column_name)</div></pre></td></tr></table></figure></p>
<p>这样的话，我们直接在命令行里，切换到wcq用户执行hive命令行，应该是一样的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hive&gt; alter table default.batting CHANGE COLUMN dtdontquery dtdontquery string COMMENT &apos;ss&apos;;</div><div class="line">FAILED: Execution Error, return code 1 from org.apache.hadoop.hive.ql.exec.DDLTask. Unable to alter table. java.security.AccessControlException: Permission denied: user=wcq, access=WRITE, inode=&quot;/apps/hive/warehouse/batting&quot;:root:jlc:drwxr-xr-x</div></pre></td></tr></table></figure></p>
<p>此阶段结论：hue通过hiveserver执行hql语句，而且hive本身修改表元数据的时候也会验证是否有对HDFS目录有写权限。</p>
<p>那么应该怎样解决呢？</p>
<p>当前的目录权限都是给的：<code>drwxr-x---</code>，也就是只有owner有写权限, 指定组的用户有读权限，匿名用户没有任何权限。</p>
<p>这样授权的理由在于，以事业部为组，所有同一个事业部的人都可读，但是只能通过我们的数据平台用户来进行写操作【当前是root】。</p>
<p>既不想违背这个初衷，又要满足新的需求，再不进行任何自主研发的前提下，只能<strong>启用HDFS的ACL</strong>，才能添加额外的权限。</p>
<p>hue中也支持*ACL修改，而且执行遍历目录修改.</p>
<p>问题<br>=<br>对官网说的mask不太理解。字面意思好像是用来过滤所有用户、组、匿名组的权限的。</p>
<p>以官网例子来看：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">user::rw-</div><div class="line"> user:bruce:rwx                  #effective:r--</div><div class="line"> group::r-x                      #effective:r--</div><div class="line"> group:sales:rwx                 #effective:r--</div><div class="line"> mask::r--</div><div class="line"> other::r--</div></pre></td></tr></table></figure></p>
<p>因为上面指定的mask是只读，所以即便其他指定了额外的权限也是白费的，生效的只有只读。所以这样理解，mask就是这个文件可以有的所有权限的总和。如果不单独设置mask的话，其默认值也是这样算出来的。</p>
<p>参考<br>=</p>
<ul>
<li><a href="https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-hdfs/HdfsPermissionsGuide.html#The_Super-User" target="_blank" rel="external">https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-hdfs/HdfsPermissionsGuide.html#The_Super-User</a></li>
<li><a href="https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-common/FileSystemShell.html#setfacl" target="_blank" rel="external">https://hadoop.apache.org/docs/r2.7.2/hadoop-project-dist/hadoop-common/FileSystemShell.html#setfacl</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ambari脚本更新配置]]></title>
      <url>/2017/03/31/ambari%E8%84%9A%E6%9C%AC%E6%9B%B4%E6%96%B0%E9%85%8D%E7%BD%AE/</url>
      <content type="html"><![CDATA[<p>类似于<code>hdfs_log_dir_prefix</code>这种配置项一旦在服务初始化完成之后，就不能在UI界面上进行修改了。具体ambari为什么要这样限制，个人表示无从知晓。</p>
<p>通过文件<code>/var/lib/ambari-agent/cache/cluster_configuration/configurations.json</code>，我们可以直接看到所有的环境相关配置。暂时猜测可能是为了统一一次性生成此文件，而所有UI的操作都是修改的各自的对应的xml配置文件。</p>
<p>官方提供了两种方式修改对于此json文件相关的配置。一个是API，另一个就是通过<code>/var/lib/ambari-server/resources/scripts/config.sh</code>脚本。</p>
<p>个人比较倾向于脚本，更不易出错。查看config.sh的使用方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">/var/lib/ambari-server/resources/scripts/configs.py --help</div><div class="line">Usage: configs.py [options]</div><div class="line">Options:</div><div class="line">  -h, --help            show this help message and exit</div><div class="line">  -t PORT, --port=PORT  Optional port number for Ambari server. Default is</div><div class="line">                        &apos;8080&apos;. Provide empty string to not use port.</div><div class="line">  -s PROTOCOL, --protocol=PROTOCOL</div><div class="line">                        Optional support of SSL. Default protocol is &apos;http&apos;</div><div class="line">  -a ACTION, --action=ACTION</div><div class="line">                        Script action: &lt;get&gt;, &lt;set&gt;, &lt;delete&gt;</div><div class="line">  -l HOST, --host=HOST  Server external host name</div><div class="line">  -n CLUSTER, --cluster=CLUSTER</div><div class="line">                        Name given to cluster. Ex: &apos;c1&apos;</div><div class="line">  -c CONFIG_TYPE, --config-type=CONFIG_TYPE</div><div class="line">                        One of the various configuration types in Ambari. Ex:</div><div class="line">                        core-site, hdfs-site, mapred-queue-acls, etc.</div><div class="line">  To specify credentials please use &quot;-e&quot; OR &quot;-u&quot; and &quot;-p&apos;&quot;:</div><div class="line">    -u USER, --user=USER</div><div class="line">                        Optional user ID to use for authentication. Default is</div><div class="line">                        &apos;admin&apos;</div><div class="line">    -p PASSWORD, --password=PASSWORD</div><div class="line">                        Optional password to use for authentication. Default</div><div class="line">                        is &apos;admin&apos;</div><div class="line">    -e CREDENTIALS_FILE, --credentials-file=CREDENTIALS_FILE</div><div class="line">                        Optional file with user credentials separated by new</div><div class="line">                        line.</div><div class="line">  To specify property(s) please use &quot;-f&quot; OR &quot;-k&quot; and &quot;-v&apos;&quot;:</div><div class="line">    -f FILE, --file=FILE</div><div class="line">                        File where entire configurations are saved to, or read</div><div class="line">                        from. Supported extensions (.xml, .json&gt;)</div><div class="line">    -k KEY, --key=KEY   Key that has to be set or deleted. Not necessary for</div><div class="line">                        &apos;get&apos; action.</div><div class="line">    -v VALUE, --value=VALUE</div><div class="line">                        Optional value to be set. Not necessary for &apos;get&apos; or</div><div class="line">                        &apos;delete&apos; actions.</div></pre></td></tr></table></figure></p>
<p>首先，我们可以先用api查看一下配置项的分布：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div></pre></td><td class="code"><pre><div class="line">[hdfs@data-test01 scripts]$ curl -k -s -u admin:admin &quot;http://10.1.5.79:8080/api/v1/clusters/willcluster?fields=Clusters/desired_configs&quot;</div><div class="line">&#123;</div><div class="line">  &quot;href&quot; : &quot;http://10.1.5.79:8080/api/v1/clusters/willcluster?fields=Clusters/desired_configs&quot;,</div><div class="line">  &quot;Clusters&quot; : &#123;</div><div class="line">    &quot;cluster_name&quot; : &quot;willcluster&quot;,</div><div class="line">    &quot;version&quot; : &quot;HDP-2.4&quot;,</div><div class="line">    &quot;desired_configs&quot; : &#123;</div><div class="line">      &quot;capacity-scheduler&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1490254923891&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 2</div><div class="line">      &#125;,</div><div class="line">      &quot;cluster-env&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1490254925199&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 2</div><div class="line">      &#125;,</div><div class="line">      &quot;core-site&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1490345767824&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 5</div><div class="line">      &#125;,</div><div class="line">      &quot;hadoop-env&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1490254923436&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 2</div><div class="line">      &#125;,</div><div class="line">      &quot;hadoop-policy&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 1</div><div class="line">      &#125;,</div><div class="line">      &quot;hdfs-log4j&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 1</div><div class="line">      &#125;,</div><div class="line">      &quot;hdfs-site&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1490344980013&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 4</div><div class="line">      &#125;,</div><div class="line">      &quot;kerberos-env&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1490254524258&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 2</div><div class="line">      &#125;,</div><div class="line">      &quot;krb5-conf&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1490254524258&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 2</div><div class="line">      &#125;,</div><div class="line">      &quot;mapred-env&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 1</div><div class="line">      &#125;,</div><div class="line">      &quot;mapred-site&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1490254925210&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 2</div><div class="line">      &#125;,</div><div class="line">      &quot;ranger-hdfs-audit&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 1</div><div class="line">      &#125;,</div><div class="line">      &quot;ranger-hdfs-plugin-properties&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 1</div><div class="line">      &#125;,</div><div class="line">      &quot;ranger-hdfs-policymgr-ssl&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 1</div><div class="line">      &#125;,</div><div class="line">      &quot;ranger-hdfs-security&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 1</div><div class="line">      &#125;,</div><div class="line">      &quot;ranger-yarn-audit&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 1</div><div class="line">      &#125;,</div><div class="line">      &quot;ranger-yarn-plugin-properties&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 1</div><div class="line">      &#125;,</div><div class="line">      &quot;ranger-yarn-policymgr-ssl&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 1</div><div class="line">      &#125;,</div><div class="line">      &quot;ranger-yarn-security&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 1</div><div class="line">      &#125;,</div><div class="line">      &quot;ssl-client&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 1</div><div class="line">      &#125;,</div><div class="line">      &quot;ssl-server&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 1</div><div class="line">      &#125;,</div><div class="line">      &quot;yarn-env&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 1</div><div class="line">      &#125;,</div><div class="line">      &quot;yarn-log4j&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 1</div><div class="line">      &#125;,</div><div class="line">      &quot;yarn-site&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1490254924330&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 6</div><div class="line">      &#125;,</div><div class="line">      &quot;zoo.cfg&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 1</div><div class="line">      &#125;,</div><div class="line">      &quot;zookeeper-env&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1490254924765&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 2</div><div class="line">      &#125;,</div><div class="line">      &quot;zookeeper-log4j&quot; : &#123;</div><div class="line">        &quot;tag&quot; : &quot;version1&quot;,</div><div class="line">        &quot;user&quot; : &quot;admin&quot;,</div><div class="line">        &quot;version&quot; : 1</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面的key就对应于<code>config.sh</code> set的一些可选项,也就是CONFIG_TYPE。</p>
<p>下面列出一些常用的样例。按照amabri的惯例，每个log目录都应该是由对应的user创建并修改的。这里我们的所有机器都只有/server目录，下面并没有添加或配置log目录，试一下能不能像初始化环境的时候自动配置对应权限。一试成功了。真好，哈哈<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">./configs.sh  set 10.1.5.79 willcluster hadoop-env hdfs_log_dir_prefix &quot;/server/log/hadoop&quot;</div><div class="line">./configs.sh  set 10.1.5.79 willcluster mapred-env mapred_log_dir_prefix &quot;/server/log/hadoop-mapred&quot;</div><div class="line">./configs.sh  set 10.1.5.79 willcluster yarn-env yarn_log_dir_prefix &quot;/server/log/yarn&quot;</div><div class="line">./configs.sh  set 10.1.5.79 willcluster zookeeper-env zk_log_dir &quot;/server/log/zookeeper&quot;</div></pre></td></tr></table></figure></p>
<p>刷新amabri的UI的配置页就可以看到，对应配置已经修改成功，等待重启生效了。</p>
<p>然后tail一下各个服务对应的日志，都没有问题。</p>
<p>参考：</p>
<ul>
<li><a href="https://cwiki.apache.org/confluence/display/AMBARI/Modify+configurations" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/AMBARI/Modify+configurations</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[centos7-安装k8s]]></title>
      <url>/2017/03/30/centos7-%E5%AE%89%E8%A3%85k8s/</url>
      <content type="html"><![CDATA[<p>代理设置<br>=<br>先弄一下代理，弄一下hosts文件，参考： <a href="https://github.com/racaljk/hosts" target="_blank" rel="external">https://github.com/racaljk/hosts</a></p>
<p>安装<br>=<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">cat &lt;&lt;EOF &gt; /etc/yum.repos.d/kubernetes.repo</div><div class="line">[kubernetes]</div><div class="line">name=Kubernetes</div><div class="line">baseurl=http://yum.kubernetes.io/repos/kubernetes-el7-x86_64</div><div class="line">enabled=1</div><div class="line">gpgcheck=1</div><div class="line">repo_gpgcheck=1</div><div class="line">gpgkey=https://packages.cloud.google.com/yum/doc/yum-key.gpg</div><div class="line">       https://packages.cloud.google.com/yum/doc/rpm-package-key.gpg</div><div class="line">EOF</div><div class="line">setenforce 0</div><div class="line">yum install -y docker kubelet kubeadm kubectl kubernetes-cni</div><div class="line">systemctl enable docker &amp;&amp; systemctl start docker</div><div class="line">systemctl enable kubelet &amp;&amp; systemctl start kubelet</div></pre></td></tr></table></figure></p>
<p>要是安装过docker了，就不用再弄了，最好保持一致。</p>
<p>初始化<br>=<br>controller组件运行在master上，它包含etcd和API server。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">root@controller kubernetes]# kubeadm init</div><div class="line">[kubeadm] WARNING: kubeadm is in beta, please do not use it for production clusters.</div><div class="line">[init] Using Kubernetes version: v1.6.0</div><div class="line">[init] Using Authorization mode: RBAC</div><div class="line">[preflight] Running pre-flight checks</div><div class="line">[preflight] WARNING: docker version is greater than the most recently validated version. Docker version: 17.03.1-ce. Max validated version: 1.12</div><div class="line">[certificates] Generated CA certificate and key.</div><div class="line">[certificates] Generated API server certificate and key.</div><div class="line">[certificates] API Server serving cert is signed for DNS names [controller kubernetes kubernetes.default kubernetes.default.svc kubernetes.default.svc.cluster.local] and IPs [10.96.0.1 10.1.5.129]</div><div class="line">[certificates] Generated API server kubelet client certificate and key.</div><div class="line">[certificates] Generated service account token signing key and public key.</div><div class="line">[certificates] Generated front-proxy CA certificate and key.</div><div class="line">[certificates] Generated front-proxy client certificate and key.</div><div class="line">[certificates] Valid certificates and keys now exist in &quot;/etc/kubernetes/pki&quot;</div><div class="line">[kubeconfig] Wrote KubeConfig file to disk: &quot;/etc/kubernetes/kubelet.conf&quot;</div><div class="line">[kubeconfig] Wrote KubeConfig file to disk: &quot;/etc/kubernetes/controller-manager.conf&quot;</div><div class="line">[kubeconfig] Wrote KubeConfig file to disk: &quot;/etc/kubernetes/scheduler.conf&quot;</div><div class="line">[kubeconfig] Wrote KubeConfig file to disk: &quot;/etc/kubernetes/admin.conf&quot;</div><div class="line">[apiclient] Created API client, waiting for the control plane to become ready</div></pre></td></tr></table></figure>
<p>这个命令会自动探查网络接口，告诉默认的网关master所在的地址。要是想指定额外的master地址，使用参数–api-advertise-addresses <ip-address>。</ip-address></p>
<p>上面的命令也会自动下载所有的必须的镜像：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">gcr.io/google_containers/kube-proxy-amd64                v1.5.3         </div><div class="line">gcr.io/google_containers/kube-controller-manager-amd64   v1.5.3         </div><div class="line">gcr.io/google_containers/kube-scheduler-amd64            v1.5.3         </div><div class="line">gcr.io/google_containers/kube-apiserver-amd64            v1.5.3         </div><div class="line">gcr.io/google_containers/etcd-amd64                      3.0.14-kubeadm </div><div class="line">gcr.io/google_containers/kube-discovery-amd64            1.0            </div><div class="line">gcr.io/google_containers/pause-amd64                     3.0</div></pre></td></tr></table></figure></p>
<p>中间提示我/proc/sys/net/bridge/bridge-nf-call-iptables的内容不是1，看了一下是0，修改了之后可以了。</p>
<p>注意 kubeadm init 只能在你确定的master上执行一次。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ambari---迁移某master-component]]></title>
      <url>/2017/03/27/ambari---%E8%BF%81%E7%A7%BB%E6%9F%90master-component/</url>
      <content type="html"><![CDATA[<p>以AMBARI_METRICS服务的component：METRICS_COLLECTOR为例。</p>
<ol>
<li><p>停止对应service</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">curl -u admin:admin -H &quot;X-Requested-By: ambari&quot; -X PUT -d &apos;&#123;&quot;RequestInfo&quot;:&#123;&quot;context&quot;:&quot;Stop Service&quot;&#125;,&quot;Body&quot;:&#123;&quot;ServiceInfo&quot;:&#123;&quot;state&quot;:&quot;INSTALLED&quot;&#125;&#125;&#125;&apos; http://namenode01.will.com:8080/api/v1/clusters/datacenter/services/AMBARI_METRICS/</div><div class="line">`</div></pre></td></tr></table></figure>
</li>
<li><p>确认目前node上的component已经停止</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -u admin:admin -H &quot;X-Requested-By: ambari&quot; -X PUT -d &apos;&#123;&quot;RequestInfo&quot;:&#123;&quot;context&quot;:&quot;Stop Component&quot;&#125;,&quot;Body&quot;:&#123;&quot;HostRoles&quot;:&#123;&quot;state&quot;:&quot;INSTALLED&quot;&#125;&#125;&#125;&apos; http://namenode01.will.com:8080/api/v1/clusters/datacenter/hosts/datanode04.will.com/host_components/METRICS_COLLECTOR</div></pre></td></tr></table></figure>
</li>
<li><p>删除目前servcie里的component</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i -H &quot;X-Requested-By:ambari&quot; -u admin:admin -X DELETE http://namenode01.will.com:8080/api/v1/clusters/datacenter/services/AMBARI_METRICS/components/METRICS_COLLECTOR</div></pre></td></tr></table></figure>
</li>
<li><p>在service的元数据里再加上这个component</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i -H &quot;X-Requested-By:ambari&quot; -u admin:admin -X POST http://namenode01.will.com:8080/api/v1/clusters/datacenter/services/AMBARI_METRICS/components/METRICS_COLLECTOR</div></pre></td></tr></table></figure>
</li>
<li><p>安装component到指定node上</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -i -u admin:admin -H &quot;X-Requested-By:ambari&quot; -i -X POST -d &apos;&#123;&quot;host_components&quot; : [&#123;&quot;HostRoles&quot;:&#123;&quot;component_name&quot;:&quot;METRICS_COLLECTOR&quot;&#125;&#125;] &#125;&apos;  http://namenode01.will.com:8080/api/v1/clusters/datacenter/hosts?Hosts/host_name=datanode17.will.com</div></pre></td></tr></table></figure>
</li>
<li><p>web端，到新的node上的component点击re-install，之后重启整个service。完成</p>
</li>
</ol>
<p>ps:<br>如果没有删除干净的话，就到指定node上删除component<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl -u admin:admin -H &quot;X-Requested-By: ambari&quot; -X DELETE http://namenode01.will.com:8080/api/v1/clusters/datacenter/hosts/datanode04.will.com/host_components/METRICS_COLLECTOR</div></pre></td></tr></table></figure></p>
<p>参考：</p>
<ul>
<li><a href="https://community.hortonworks.com/questions/82689/how-to-add-component-spark-jobhistoryserver-to-spa.html#answer-82695" target="_blank" rel="external">https://community.hortonworks.com/questions/82689/how-to-add-component-spark-jobhistoryserver-to-spa.html#answer-82695</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/AMBARI/Using+APIs+to+delete+a+service+or+all+host+components+on+a+host" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/AMBARI/Using+APIs+to+delete+a+service+or+all+host+components+on+a+host</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[iptables手记]]></title>
      <url>/2017/03/24/iptables%E6%89%8B%E8%AE%B0/</url>
      <content type="html"><![CDATA[<p>先看一下网络流程图，以及所有的控制点<br><img src="/imgs/iptables/iptables_controls.png" alt="网络流程图"><br><img src="/imgs/iptables/iptables_control_detail.png" alt="网络流程细节图"><br><img src="/imgs/iptables/iptables_2.png" alt="控制点规则结构"><br><img src="/imgs/iptables/iptables_3_filter.png" alt="filter表相关流程与控制点图"><br><img src="/imgs/iptables/iptables_3_mangle.png" alt="mangle表相关流程与控制点"><br><img src="/imgs/iptables/iptables_3_nat.png" alt="nat表相关流程与控制点"><br><img src="/imgs/iptables/iptables_4_command.png" alt="语法结构"><br><img src="/imgs/iptables/iptables_4_command1.png" alt="语法结构"></p>
<p>查看filter表里的数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@schedule ~]#iptables -t filter -L</div><div class="line">Chain INPUT (policy ACCEPT)</div><div class="line">target     prot opt source               destination</div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT)</div><div class="line">target     prot opt source               destination</div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT)</div><div class="line">target     prot opt source               destination</div></pre></td></tr></table></figure></p>
<p>添加一条规则， 在OUTPUT上记录所有tcp的日志，默认是添加在syslog里的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@data-test03 hadoop-client]# iptables -t filter -A OUTPUT -p tcp -j LOG</div><div class="line">[root@data-test03 hadoop-client]# iptables -t filter -L</div><div class="line">Chain INPUT (policy ACCEPT)</div><div class="line">target     prot opt source               destination</div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT)</div><div class="line">target     prot opt source               destination</div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT)</div><div class="line">target     prot opt source               destination</div><div class="line">LOG        tcp  --  anywhere             anywhere            LOG level warning</div></pre></td></tr></table></figure></p>
<p>找一下syslog里是否生效：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@data-test03 hadoop-client]# tail -n 10 /var/log/messages</div><div class="line">Mar 23 18:30:35 data-test03 kernel: IN= OUT=eth0 SRC=10.1.5.81 DST=10.1.5.237 LEN=136 TOS=0x10 PREC=0x00 TTL=64 ID=32153 DF PROTO=TCP SPT=22 DPT=60206 WINDOW=2233 RES=0x00 ACK PSH URGP=0 </div><div class="line">Mar 23 18:30:36 data-test03 kernel: IN= OUT=eth0 SRC=10.1.5.81 DST=10.1.5.237 LEN=136 TOS=0x10 PREC=0x00 TTL=64 ID=32154 DF PROTO=TCP SPT=22 DPT=60206 WINDOW=2233 RES=0x00 ACK PSH URGP=0 </div><div class="line">Mar 23 18:30:36 data-test03 kernel: IN= OUT=eth0 SRC=10.1.5.81 DST=10.1.5.80 LEN=72 TOS=0x00 PREC=0x00 TTL=64 ID=39647 DF PROTO=TCP SPT=56998 DPT=2888 WINDOW=501 RES=0x00 ACK PSH URGP=0 </div><div class="line">Mar 23 18:30:36 data-test03 kernel: IN= OUT=lo SRC=10.1.5.81 DST=10.1.5.81 LEN=228 TOS=0x00 PREC=0x00 TTL=64 ID=42802 DF PROTO=TCP SPT=36920 DPT=8025 WINDOW=265 RES=0x00 ACK PSH URGP=0 </div><div class="line">Mar 23 18:30:36 data-test03 kernel: IN= OUT=lo SRC=10.1.5.81 DST=10.1.5.81 LEN=93 TOS=0x00 PREC=0x00 TTL=64 ID=14446 DF PROTO=TCP SPT=8025 DPT=36920 WINDOW=384 RES=0x00 ACK PSH URGP=0 </div><div class="line">Mar 23 18:30:36 data-test03 kernel: IN= OUT=lo SRC=10.1.5.81 DST=10.1.5.81 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=42803 DF PROTO=TCP SPT=36920 DPT=8025 WINDOW=265 RES=0x00 ACK URGP=0 </div><div class="line">Mar 23 18:30:36 data-test03 kernel: IN= OUT=eth0 SRC=10.1.5.81 DST=10.1.5.237 LEN=136 TOS=0x10 PREC=0x00 TTL=64 ID=32155 DF PROTO=TCP SPT=22 DPT=60206 WINDOW=2233 RES=0x00 ACK PSH URGP=0 </div><div class="line">Mar 23 18:30:36 data-test03 kernel: IN= OUT=eth0 SRC=10.1.5.81 DST=10.1.5.80 LEN=93 TOS=0x00 PREC=0x00 TTL=64 ID=13946 DF PROTO=TCP SPT=8025 DPT=38421 WINDOW=499 RES=0x00 ACK PSH URGP=0 </div><div class="line">Mar 23 18:30:36 data-test03 kernel: IN= OUT=eth0 SRC=10.1.5.81 DST=10.1.5.79 LEN=93 TOS=0x00 PREC=0x00 TTL=64 ID=15862 DF PROTO=TCP SPT=8025 DPT=37458 WINDOW=499 RES=0x00 ACK PSH URGP=0 </div><div class="line">Mar 23 18:30:36 data-test03 kernel: IN= OUT=eth0 SRC=10.1.5.81 DST=10.1.5.237 LEN=104 TOS=0x10 PREC=0x00 TTL=64 ID=32156 DF PROTO=TCP SPT=22 DPT=60206 WINDOW=2233 RES=0x00 ACK PSH URGP=0</div></pre></td></tr></table></figure></p>
<p>为日志添加前缀<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t filter -A OUTPUT -p tcp -j LOG --log-prefix will</div></pre></td></tr></table></figure></p>
<p>再看log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@data-test03 hadoop-client]# tail -n 5 /var/log/messages</div><div class="line">Mar 23 18:33:58 data-test03 kernel: willIN= OUT=eth0 SRC=10.1.5.81 DST=10.1.5.80 LEN=72 TOS=0x00 PREC=0x00 TTL=64 ID=39849 DF PROTO=TCP SPT=56998 DPT=2888 WINDOW=501 RES=0x00 ACK PSH URGP=0 </div><div class="line">Mar 23 18:33:58 data-test03 kernel: willIN= OUT=lo SRC=10.1.5.81 DST=10.1.5.81 LEN=228 TOS=0x00 PREC=0x00 TTL=64 ID=43206 DF PROTO=TCP SPT=36920 DPT=8025 WINDOW=265 RES=0x00 ACK PSH URGP=0 </div><div class="line">Mar 23 18:33:58 data-test03 kernel: willIN= OUT=lo SRC=10.1.5.81 DST=10.1.5.81 LEN=93 TOS=0x00 PREC=0x00 TTL=64 ID=14648 DF PROTO=TCP SPT=8025 DPT=36920 WINDOW=384 RES=0x00 ACK PSH URGP=0 </div><div class="line">Mar 23 18:33:58 data-test03 kernel: willIN= OUT=lo SRC=10.1.5.81 DST=10.1.5.81 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=43207 DF PROTO=TCP SPT=36920 DPT=8025 WINDOW=265 RES=0x00 ACK URGP=0 </div><div class="line">Mar 23 18:33:58 data-test03 kernel: willIN= OUT=eth0 SRC=10.1.5.81 DST=10.1.5.237 LEN=136 TOS=0x10 PREC=0x00 TTL=64 ID=34907 DF PROTO=TCP SPT=22 DPT=60206 WINDOW=2233 RES=0x00 ACK PSH URGP=0</div></pre></td></tr></table></figure></p>
<p>命令规范：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t 表 操作 5个控制点之一 匹配规则 -j 动作 动作的选项</div></pre></td></tr></table></figure></p>
<p>拒绝79对于8020端口的请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t filter -A INPUT -p tcp --dport 8020 -s 10.1.5.79 -j REJECT</div></pre></td></tr></table></figure></p>
<p>匹配包含：基本匹配、隐世匹配、等。</p>
<p>拒绝79所有请求, 第二条是给一个拒绝原因，顺序执行，如果一起都有的话，只执行第一条动作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -t filter -A INPUT -s 10.1.5.79 -j REJECT</div><div class="line">iptables -t filter -A INPUT -s 10.1.5.79 -j REJECT --reject-with tcp-reset</div></pre></td></tr></table></figure></p>
<p>这样就连ping都ping不通了。</p>
<p><a href="http://blog.csdn.net/czhphp/article/details/19123673" target="_blank" rel="external">网段知识补充</a></p>
<p>参考：</p>
<ul>
<li><a href="http://www.cnblogs.com/yi-meng/p/3213925.html" target="_blank" rel="external">http://www.cnblogs.com/yi-meng/p/3213925.html</a></li>
<li><a href="http://www.dabu.info/iptables-based-tutorial-grammar-rules.html" target="_blank" rel="external">http://www.dabu.info/iptables-based-tutorial-grammar-rules.html</a></li>
<li><a href="http://v.youku.com/v_show/id_XNzIxOTAxODky.html?from=s1.8-1-1.2&amp;spm=a2h0k.8191407.0.0" target="_blank" rel="external">http://v.youku.com/v_show/id_XNzIxOTAxODky.html?from=s1.8-1-1.2&amp;spm=a2h0k.8191407.0.0</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> iptables </tag>
            
            <tag> linux </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[iptables]]></title>
      <url>/2017/03/23/iptables/</url>
      <content type="html"><![CDATA[<p>查看filter表里的数据<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@schedule ~]#iptables -t filter -L</div><div class="line">Chain INPUT (policy ACCEPT)</div><div class="line">target     prot opt source               destination         </div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT)</div><div class="line">target     prot opt source               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT)</div><div class="line">target     prot opt source               destination</div></pre></td></tr></table></figure></p>
<p>添加一条规则， 在OUTPUT上记录所有tcp的日志，默认是添加在syslog里的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@data-test03 hadoop-client]# iptables -t filter -A OUTPUT -p tcp -j LOG</div><div class="line">[root@data-test03 hadoop-client]# iptables -t filter -L</div><div class="line">Chain INPUT (policy ACCEPT)</div><div class="line">target     prot opt source               destination         </div><div class="line"></div><div class="line">Chain FORWARD (policy ACCEPT)</div><div class="line">target     prot opt source               destination         </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT)</div><div class="line">target     prot opt source               destination         </div><div class="line">LOG        tcp  --  anywhere             anywhere            LOG level warning</div></pre></td></tr></table></figure></p>
<p>找一下syslog里是否生效：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">[root@data-test03 hadoop-client]# tail -n 10 /var/log/messages</div><div class="line">Mar 23 18:30:35 data-test03 kernel: IN= OUT=eth0 SRC=10.1.5.81 DST=10.1.5.237 LEN=136 TOS=0x10 PREC=0x00 TTL=64 ID=32153 DF PROTO=TCP SPT=22 DPT=60206 WINDOW=2233 RES=0x00 ACK PSH URGP=0 </div><div class="line">Mar 23 18:30:36 data-test03 kernel: IN= OUT=eth0 SRC=10.1.5.81 DST=10.1.5.237 LEN=136 TOS=0x10 PREC=0x00 TTL=64 ID=32154 DF PROTO=TCP SPT=22 DPT=60206 WINDOW=2233 RES=0x00 ACK PSH URGP=0 </div><div class="line">Mar 23 18:30:36 data-test03 kernel: IN= OUT=eth0 SRC=10.1.5.81 DST=10.1.5.80 LEN=72 TOS=0x00 PREC=0x00 TTL=64 ID=39647 DF PROTO=TCP SPT=56998 DPT=2888 WINDOW=501 RES=0x00 ACK PSH URGP=0 </div><div class="line">Mar 23 18:30:36 data-test03 kernel: IN= OUT=lo SRC=10.1.5.81 DST=10.1.5.81 LEN=228 TOS=0x00 PREC=0x00 TTL=64 ID=42802 DF PROTO=TCP SPT=36920 DPT=8025 WINDOW=265 RES=0x00 ACK PSH URGP=0 </div><div class="line">Mar 23 18:30:36 data-test03 kernel: IN= OUT=lo SRC=10.1.5.81 DST=10.1.5.81 LEN=93 TOS=0x00 PREC=0x00 TTL=64 ID=14446 DF PROTO=TCP SPT=8025 DPT=36920 WINDOW=384 RES=0x00 ACK PSH URGP=0 </div><div class="line">Mar 23 18:30:36 data-test03 kernel: IN= OUT=lo SRC=10.1.5.81 DST=10.1.5.81 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=42803 DF PROTO=TCP SPT=36920 DPT=8025 WINDOW=265 RES=0x00 ACK URGP=0 </div><div class="line">Mar 23 18:30:36 data-test03 kernel: IN= OUT=eth0 SRC=10.1.5.81 DST=10.1.5.237 LEN=136 TOS=0x10 PREC=0x00 TTL=64 ID=32155 DF PROTO=TCP SPT=22 DPT=60206 WINDOW=2233 RES=0x00 ACK PSH URGP=0 </div><div class="line">Mar 23 18:30:36 data-test03 kernel: IN= OUT=eth0 SRC=10.1.5.81 DST=10.1.5.80 LEN=93 TOS=0x00 PREC=0x00 TTL=64 ID=13946 DF PROTO=TCP SPT=8025 DPT=38421 WINDOW=499 RES=0x00 ACK PSH URGP=0 </div><div class="line">Mar 23 18:30:36 data-test03 kernel: IN= OUT=eth0 SRC=10.1.5.81 DST=10.1.5.79 LEN=93 TOS=0x00 PREC=0x00 TTL=64 ID=15862 DF PROTO=TCP SPT=8025 DPT=37458 WINDOW=499 RES=0x00 ACK PSH URGP=0 </div><div class="line">Mar 23 18:30:36 data-test03 kernel: IN= OUT=eth0 SRC=10.1.5.81 DST=10.1.5.237 LEN=104 TOS=0x10 PREC=0x00 TTL=64 ID=32156 DF PROTO=TCP SPT=22 DPT=60206 WINDOW=2233 RES=0x00 ACK PSH URGP=0</div></pre></td></tr></table></figure></p>
<p>为日志添加前缀<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t filter -A OUTPUT -p tcp -j LOG --log-prefix will</div></pre></td></tr></table></figure></p>
<p>再看log<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@data-test03 hadoop-client]# tail -n 5 /var/log/messages</div><div class="line">Mar 23 18:33:58 data-test03 kernel: willIN= OUT=eth0 SRC=10.1.5.81 DST=10.1.5.80 LEN=72 TOS=0x00 PREC=0x00 TTL=64 ID=39849 DF PROTO=TCP SPT=56998 DPT=2888 WINDOW=501 RES=0x00 ACK PSH URGP=0 </div><div class="line">Mar 23 18:33:58 data-test03 kernel: willIN= OUT=lo SRC=10.1.5.81 DST=10.1.5.81 LEN=228 TOS=0x00 PREC=0x00 TTL=64 ID=43206 DF PROTO=TCP SPT=36920 DPT=8025 WINDOW=265 RES=0x00 ACK PSH URGP=0 </div><div class="line">Mar 23 18:33:58 data-test03 kernel: willIN= OUT=lo SRC=10.1.5.81 DST=10.1.5.81 LEN=93 TOS=0x00 PREC=0x00 TTL=64 ID=14648 DF PROTO=TCP SPT=8025 DPT=36920 WINDOW=384 RES=0x00 ACK PSH URGP=0 </div><div class="line">Mar 23 18:33:58 data-test03 kernel: willIN= OUT=lo SRC=10.1.5.81 DST=10.1.5.81 LEN=52 TOS=0x00 PREC=0x00 TTL=64 ID=43207 DF PROTO=TCP SPT=36920 DPT=8025 WINDOW=265 RES=0x00 ACK URGP=0 </div><div class="line">Mar 23 18:33:58 data-test03 kernel: willIN= OUT=eth0 SRC=10.1.5.81 DST=10.1.5.237 LEN=136 TOS=0x10 PREC=0x00 TTL=64 ID=34907 DF PROTO=TCP SPT=22 DPT=60206 WINDOW=2233 RES=0x00 ACK PSH URGP=0</div></pre></td></tr></table></figure></p>
<p>命令规范：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t 表 操作 5个控制点之一 匹配规则 -j 动作 动作的选项</div></pre></td></tr></table></figure></p>
<p>拒绝79对于8020端口的请求<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t filter -A INPUT -p tcp --dport 8020 -s 10.1.5.79 -j REJECT</div></pre></td></tr></table></figure></p>
<p>匹配包含：基本匹配、隐世匹配、等。</p>
<p>拒绝79所有请求, 第二条是给一个拒绝原因，顺序执行，如果一起都有的话，优先执行第一条动作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">iptables -t filter -A INPUT -s 10.1.5.79 -j REJECT</div><div class="line">iptables -t filter -A INPUT -s 10.1.5.79 -j REJECT --reject-with tcp-reset</div></pre></td></tr></table></figure></p>
<p>这样就连ping都ping不通了。</p>
<p>插入到第三行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t filter -I INPUT 3 -p tcp -s 10.1.5.237 -j ACCEPT</div></pre></td></tr></table></figure></p>
<p>删除第3行的规则：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">iptables -t filter -D INPUT 3</div></pre></td></tr></table></figure></p>
<p><a href="http://blog.csdn.net/czhphp/article/details/19123673" target="_blank" rel="external">网段知识补充</a></p>
<p>参考：</p>
<ul>
<li><a href="http://www.cnblogs.com/yi-meng/p/3213925.html" target="_blank" rel="external">http://www.cnblogs.com/yi-meng/p/3213925.html</a></li>
<li><a href="http://www.dabu.info/iptables-based-tutorial-grammar-rules.html" target="_blank" rel="external">http://www.dabu.info/iptables-based-tutorial-grammar-rules.html</a></li>
<li><a href="http://v.youku.com/v_show/id_XNzIxOTAxODky.html?from=s1.8-1-1.2&amp;spm=a2h0k.8191407.0.0" target="_blank" rel="external">http://v.youku.com/v_show/id_XNzIxOTAxODky.html?from=s1.8-1-1.2&amp;spm=a2h0k.8191407.0.0</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ambari集群添加kerberos认证]]></title>
      <url>/2017/03/22/ambari%E9%9B%86%E7%BE%A4%E6%B7%BB%E5%8A%A0kerberos%E8%AE%A4%E8%AF%81/</url>
      <content type="html"><![CDATA[<p>host准备<br>ip | 名字 | 备注<br>—|—|—<br>10.1.5.79 | data-test01 | ambari-server/KDC<br>10.1.5.80 | data-test02 |<br>10.1.5.81 | data-test03 |</p>
<p>1.KDC配置<br>=</p>
<h5 id="a-安装"><a href="#a-安装" class="headerlink" title="a. 安装"></a>a. 安装</h5><p>在test01上安装KDC:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install -y krb5-server krb5-libs krb5-auth-dialog krb5-workstation</div></pre></td></tr></table></figure></p>
<p>其他机器安装客户端<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install krb5-devel krb5-workstation -y</div></pre></td></tr></table></figure></p>
<h5 id="b-编辑配置文件"><a href="#b-编辑配置文件" class="headerlink" title="b.编辑配置文件"></a>b.编辑配置文件</h5><p>/etc/krb5.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">[logging]</div><div class="line"> default = FILE:/var/log/krb5libs.log</div><div class="line"> kdc = FILE:/var/log/krb5kdc.log</div><div class="line"> admin_server = FILE:/var/log/kadmind.log</div><div class="line"></div><div class="line">[libdefaults]</div><div class="line"> default_realm = WILLCLUSTER.COM</div><div class="line"> dns_lookup_realm = false</div><div class="line"> dns_lookup_kdc = false</div><div class="line"> ticket_lifetime = 24h</div><div class="line"> renew_lifetime = 7d</div><div class="line"> forwardable = true</div><div class="line"> udp_preference_limit = 1</div><div class="line"></div><div class="line">[realms]</div><div class="line"> WILLCLUSTER.COM = &#123;</div><div class="line">  kdc = kerberos.willcluster.com</div><div class="line">  admin_server = kerberos.willcluster.com</div><div class="line"> &#125;</div><div class="line"></div><div class="line">[domain_realm]</div><div class="line"> .willcluster.com = WILLCLUSTER.COM</div><div class="line"> willcluster.com = WILLCLUSTER.COM</div></pre></td></tr></table></figure></p>
<p>/var/kerberos/krb5kdc/kdc.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[kdcdefaults]</div><div class="line"> kdc_ports = 88</div><div class="line"> kdc_tcp_ports = 88</div><div class="line"></div><div class="line">[realms]</div><div class="line"> WILLCLUSTER.COM = &#123;</div><div class="line">  #master_key_type = aes256-cts</div><div class="line">  acl_file = /var/kerberos/krb5kdc/kadm5.acl</div><div class="line">  dict_file = /usr/share/dict/words</div><div class="line">  admin_keytab = /var/kerberos/krb5kdc/kadm5.keytab</div><div class="line">  supported_enctypes = aes256-cts:normal aes128-cts:normal des3-hmac-sha1:normal arcfour-hmac:normal des-hmac-sha1:normal des-cbc-md5:normal des-cbc-crc:normal</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<h5 id="c-分发-etc-krb5-conf到各个节点"><a href="#c-分发-etc-krb5-conf到各个节点" class="headerlink" title="c.分发/etc/krb5.conf到各个节点"></a>c.分发/etc/krb5.conf到各个节点</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">scp /etc/krb5.conf data-test02:/etc/</div><div class="line">scp /etc/krb5.conf data-test03:/etc/</div></pre></td></tr></table></figure>
<h5 id="d-test01上启动服务"><a href="#d-test01上启动服务" class="headerlink" title="d. test01上启动服务"></a>d. test01上启动服务</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">chkconfig --level 35 krb5kdc on</div><div class="line">chkconfig --level 35 kadmin on</div><div class="line">service krb5kdc start</div><div class="line">service kadmin start</div></pre></td></tr></table></figure>
<p>2.数据库<br>=</p>
<h6 id="创建kerberos数据库"><a href="#创建kerberos数据库" class="headerlink" title="创建kerberos数据库"></a>创建kerberos数据库</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kdb5_util create -r WILLCLUSTER.COM -s</div></pre></td></tr></table></figure>
<h6 id="在test01上创建超级用户"><a href="#在test01上创建超级用户" class="headerlink" title="在test01上创建超级用户"></a>在test01上创建超级用户</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kadmin.local -q &quot;addprinc root/admin&quot;</div></pre></td></tr></table></figure>
<h5 id="创建ambari各个服务用户与相应权限"><a href="#创建ambari各个服务用户与相应权限" class="headerlink" title="创建ambari各个服务用户与相应权限"></a>创建ambari各个服务用户与相应权限</h5><p>HDP里的每个服务都必须有自己的principal。为避免每次都输入密码，我们使用keytab文件作为认证，keytab是从kerberos数据库中抽取出来的。</p>
<p>下面使用超级用户来创建对应service的principal<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">kadmin.local -q &quot;addprinc -randkey yarn/data-test01@WILLCLUSTER.COM&quot;</div><div class="line">kadmin.local -q &quot;addprinc -randkey yarn/data-test02@WILLCLUSTER.COM&quot;</div><div class="line">kadmin.local -q &quot;addprinc -randkey yarn/data-test03@WILLCLUSTER.COM&quot;</div><div class="line"></div><div class="line">kadmin.local -q &quot;addprinc -randkey zookeeper/data-test01@WILLCLUSTER.COM&quot;</div><div class="line">kadmin.local -q &quot;addprinc -randkey zookeeper/data-test02@WILLCLUSTER.COM&quot;</div><div class="line">kadmin.local -q &quot;addprinc -randkey zookeeper/data-test03@WILLCLUSTER.COM&quot;</div><div class="line"></div><div class="line">kadmin.local -q &quot;addprinc -randkey hdfs/data-test01@WILLCLUSTER.COM&quot;</div><div class="line">kadmin.local -q &quot;addprinc -randkey hdfs/data-test02@WILLCLUSTER.COM&quot;</div><div class="line">kadmin.local -q &quot;addprinc -randkey hdfs/data-test03@WILLCLUSTER.COM&quot;</div><div class="line"></div><div class="line">kadmin.local -q &quot;addprinc -randkey nn/data-test01@WILLCLUSTER.COM&quot;</div><div class="line">kadmin.local -q &quot;addprinc -randkey nn/data-test02@WILLCLUSTER.COM&quot;</div><div class="line"></div><div class="line">...</div></pre></td></tr></table></figure></p>
<p><strong>Tips</strong>：<strong>为什么要每个node都要弄一份呢？</strong></p>
<p>两个原因：</p>
<ul>
<li>如果一个node的kerberos认证通过，并不能自动扩散到所有node。kerberos认证是以node为单位的</li>
<li>如果多个node共用同一个认证的话，万一这些node的kerberos认证同时发出去，也就是带有同样的时间戳，那么这些请求会被认为是重复的请求，后面来的会被拒绝</li>
</ul>
<p>然后抽取keytab文件到本地目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">kadmin.local -q &quot;xst  -k yarn.keytab  yarn/data-test01@WILLCLUSTER.COM&quot;</div><div class="line">kadmin.local -q &quot;xst  -k yarn.keytab  yarn/data-test02@WILLCLUSTER.COM&quot;</div><div class="line">kadmin.local -q &quot;xst  -k yarn.keytab  yarn/data-test03@WILLCLUSTER.COM&quot;</div><div class="line"></div><div class="line">kadmin.local -q &quot;xst  -k zookeeper.keytab zookeeper/data-test01@WILLCLUSTER.COM&quot;</div><div class="line">kadmin.local -q &quot;xst  -k zookeeper.keytab zookeeper/data-test02@WILLCLUSTER.COM&quot;</div><div class="line">kadmin.local -q &quot;xst  -k zookeeper.keytab zookeeper/data-test03@WILLCLUSTER.COM&quot;</div><div class="line"></div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>再把keytab文件分发到每个服务对应的每个节点<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">scp yarn.keytab zookeeper.keytab data-test02:/usr/hdp/current/hadoop-client/conf</div><div class="line">scp yarn.keytab zookeeper.keytab data-test03:/usr/hdp/current/hadoop-client/conf</div></pre></td></tr></table></figure></p>
<p>或者也可以先将所有的keytab合并到一个里面，方便copy，但是这也带来了各个node权限控制的问题。进入ktutil，读取原有的keytab，写入到统一的一个keytab文件。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ktutil: rkt yarn.keytab</div><div class="line">ktutil: rkt zookeeper.keytab</div><div class="line">....</div><div class="line">ktutil: wkt all_in_one.keytab</div></pre></td></tr></table></figure></p>
<p>写完之后查看一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">klist -ket  all_in_one.keytab</div></pre></td></tr></table></figure></p>
<p>3.HDP相关<br>=</p>
<p>给HDP配置kerberos包含两个部分：</p>
<ul>
<li>创建unix系统里对应用户名的service principal。因为hadoop默认是使用的ShellBasedUnixGroupsMapping，它继承自GroupMappingServiceProvider接口，使用namenode的linux文件与用户权限系统。</li>
<li>在对应service的配置文件中添加kerberos相关配置。</li>
</ul>
<h4 id="3-1-创建unix系统里对应用户名的service-principal"><a href="#3-1-创建unix系统里对应用户名的service-principal" class="headerlink" title="3.1 创建unix系统里对应用户名的service principal"></a>3.1 创建unix系统里对应用户名的service principal</h4><p>HDP使用一个基于规则的系统来创建service principal和对应unix用户的映射。这些rule配置在core-site.xml的hadoop.security.auth_to_local属性。默认是把所有的principal对应于这个principal的第一个组件。</p>
<p>创建一个分层的rule来提供多种复杂的情形。每个rule由三个部分组成：</p>
<ul>
<li><p>base<br>以对应的service principal名字的的组件个数开头，跟一个冒号，然后是用户名的pattern。 有点儿类似awk的处理，$0代表realm，$1代表第一个组件，以此类推<br>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[1:$1@$0] 把 myusername@APACHE.ORG 对应到 myusername@APACHE.ORG </div><div class="line">[2:$1] 把 myusername/admin@APACHE.ORG 对应到 myusername </div><div class="line">[2:$1%$2] 把 myusername/admin@APACHE.ORG 对应到 “myusername%admin</div></pre></td></tr></table></figure>
</li>
<li><p>filter<br>一个正则表达式, 过滤rule。</p>
</li>
<li>substitution【置换】<br>把一个正则转化为一个固定字符串,类似sed，例如：<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">s/@ACME\.COM// 删除第一个 @ACME.DOMAIN</div><div class="line">s/@[A-Z]*\.COM// 删除第一个后面跟着COM的@. </div><div class="line">s/X/Y/g 替换所有的 X成 Y</div></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="3-1-1-例子"><a href="#3-1-1-例子" class="headerlink" title="3.1.1 例子"></a>3.1.1 例子</h5><ul>
<li><p>如果你的默认realm是APACHE.COM,但是你想获取所有的ACME.COM的principal，下面的rule可以做到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">RULE:[1:$1@$0](.@ACME.COM)s/@.//</div><div class="line">DEFAULT</div></pre></td></tr></table></figure>
</li>
<li><p>要把名字对应于第二个组件，使用下面规则：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">RULE:[1:$1@$0](.@ACME.COM)s/@.//</div><div class="line">RULE:[2:$1@$0](.@ACME.COM)s/@.// DEFAULT</div></pre></td></tr></table></figure>
</li>
<li><p>把所有带有admin的APACHE.ORG对应于admin</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">RULE[2:$1%$2@$0](.%admin@APACHE.ORG)s/./admin/</div><div class="line">DEFAULT</div></pre></td></tr></table></figure>
</li>
<li><p>把所有用户名转为小写</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">RULE:[1:$1]/L</div><div class="line">RULE:[2:$1]/L</div><div class="line">RULE:[2:$1;$2](^.*;admin$)s/;admin$///L</div><div class="line">RULE:[2:$1;$2](^.*;guest$)s/;guest$//g/L</div></pre></td></tr></table></figure>
</li>
</ul>
<p>基于上面的rule，输入与对应输出如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&quot;JOE@FOO.COM&quot; to &quot;joe&quot;</div><div class="line">&quot;Joe/root@FOO.COM&quot; to &quot;joe&quot;</div><div class="line">&quot;Joe/admin@FOO.COM&quot; to &quot;joe&quot;</div><div class="line">&quot;Joe/guestguest@FOO.COM&quot; to &quot;joe&quot;</div></pre></td></tr></table></figure></p>
<h4 id="3-2-修改配置文件"><a href="#3-2-修改配置文件" class="headerlink" title="3.2 修改配置文件"></a>3.2 修改配置文件</h4><p>首先，在hadoop-env.sh里配置JSVC_HOME<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">export JSVC_HOME=/usr/libexec/bigtop-utils</div></pre></td></tr></table></figure></p>
<h6 id="core-site-xml"><a href="#core-site-xml" class="headerlink" title="core-site.xml"></a>core-site.xml</h6><table>
<thead>
<tr>
<th>Property Name</th>
<th>Property Value</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>hadoop.security.authentication</td>
<td>kerberos</td>
</tr>
<tr>
<td>hadoop.rpc.protection</td>
<td>authentication; integrity; privacy</td>
<td>可选</td>
</tr>
<tr>
<td>hadoop.security.authorization</td>
<td>true</td>
</tr>
<tr>
<td>hadoop.security.auth_to_local</td>
<td>上面提到的rule</td>
</tr>
</tbody>
</table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&lt;property&gt; </div><div class="line">     &lt;name&gt;hadoop.security.authentication&lt;/name&gt; </div><div class="line">     &lt;value&gt;kerberos&lt;/value&gt; </div><div class="line">     &lt;description&gt; Set the authentication for the cluster. </div><div class="line">     Valid values are: simple or kerberos.&lt;/description&gt; </div><div class="line">&lt;/property&gt; </div><div class="line"> </div><div class="line">&lt;property&gt; </div><div class="line">     &lt;name&gt;hadoop.security.authorization&lt;/name&gt; </div><div class="line">     &lt;value&gt;true&lt;/value&gt; </div><div class="line">     &lt;description&gt;Enable authorization for different protocols.&lt;/description&gt; </div><div class="line">&lt;/property&gt; </div><div class="line"> </div><div class="line">&lt;property&gt;</div><div class="line">    &lt;name&gt;hadoop.security.auth_to_local&lt;/name&gt; </div><div class="line">    &lt;value&gt; </div><div class="line">    RULE:[2:$1@$0]([jt]t@.*EXAMPLE.COM)s/.*/mapred/ </div><div class="line">    RULE:[2:$1@$0]([nd]n@.*EXAMPLE.COM)s/.*/hdfs/ </div><div class="line">    RULE:[2:$1@$0](hm@.*EXAMPLE.COM)s/.*/hbase/ </div><div class="line">    RULE:[2:$1@$0](rs@.*EXAMPLE.COM)s/.*/hbase/ </div><div class="line">    DEFAULT</div><div class="line">    &lt;/value&gt; </div><div class="line">    &lt;description&gt;The mapping from kerberos principal names</div><div class="line">    to local OS user names.&lt;/description&gt;</div><div class="line">&lt;/property&gt;</div></pre></td></tr></table></figure>
<p>下面是有关hue和knox的配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">&lt;property&gt; </div><div class="line">     &lt;name&gt;hadoop.security.authentication&lt;/name&gt; </div><div class="line">     &lt;value&gt;kerberos&lt;/value&gt; </div><div class="line">     &lt;description&gt;Set the authentication for the cluster. </div><div class="line">     Valid values are: simple or kerberos.&lt;/description&gt; </div><div class="line">&lt;/property&gt; </div><div class="line"> </div><div class="line">&lt;property&gt; </div><div class="line">     &lt;name&gt;hadoop.security.authorization&lt;/name&gt; </div><div class="line">     &lt;value&gt;true&lt;/value&gt; </div><div class="line">     &lt;description&gt;Enable authorization for different protocols. </div><div class="line">     &lt;/description&gt; </div><div class="line">&lt;/property&gt; </div><div class="line"> </div><div class="line">&lt;property&gt;</div><div class="line">     &lt;name&gt;hadoop.security.auth_to_local&lt;/name&gt; </div><div class="line">     &lt;value&gt; </div><div class="line">     RULE:[2:$1@$0]([jt]t@.*EXAMPLE.COM)s/.*/mapred/ </div><div class="line">     RULE:[2:$1@$0]([nd]n@.*EXAMPLE.COM)s/.*/hdfs/ </div><div class="line">     RULE:[2:$1@$0](hm@.*EXAMPLE.COM)s/.*/hbase/ </div><div class="line">     RULE:[2:$1@$0](rs@.*EXAMPLE.COM)s/.*/hbase/ </div><div class="line">     DEFAULT</div><div class="line">     &lt;/value&gt; </div><div class="line">     &lt;description&gt;The mapping from kerberos principal names</div><div class="line">     to local OS user names.&lt;/description&gt;</div><div class="line">&lt;/property&gt;</div><div class="line"> </div><div class="line">&lt;property&gt;</div><div class="line">     &lt;name&gt;hadoop.proxyuser.knox.groups&lt;/name&gt;</div><div class="line">     &lt;value&gt;users&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line"> </div><div class="line">&lt;property&gt;</div><div class="line">     &lt;name&gt;hadoop.proxyuser.knox.hosts&lt;/name&gt;</div><div class="line">     &lt;value&gt;Knox.EXAMPLE.COM&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div></pre></td></tr></table></figure></p>
<p>HTTP Cookie 持久化<br>默认HTTP 认证过程中，cookie是不会保留的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&lt;property&gt;</div><div class="line">   &lt;name&gt;hadoop.http.authentication.cookie.persistent&lt;/name&gt;</div><div class="line">   &lt;value&gt;true&lt;/value&gt; </div><div class="line">&lt;/property&gt;</div></pre></td></tr></table></figure></p>
<h6 id="hdfs-site-xml"><a href="#hdfs-site-xml" class="headerlink" title="hdfs-site.xml"></a>hdfs-site.xml</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div></pre></td><td class="code"><pre><div class="line">&lt;property&gt; </div><div class="line">     &lt;name&gt;dfs.permissions&lt;/name&gt; </div><div class="line">     &lt;value&gt;true&lt;/value&gt; </div><div class="line">     &lt;description&gt; If &quot;true&quot;, enable permission checking in</div><div class="line">     HDFS. If &quot;false&quot;, permission checking is turned</div><div class="line">     off, but all other behavior is</div><div class="line">     unchanged. Switching from one parameter value to the other does</div><div class="line">     not change the mode, owner or group of files or</div><div class="line">     directories. &lt;/description&gt; </div><div class="line">&lt;/property&gt; </div><div class="line"> </div><div class="line">&lt;property&gt; </div><div class="line">     &lt;name&gt;dfs.permissions.supergroup&lt;/name&gt; </div><div class="line">     &lt;value&gt;hdfs&lt;/value&gt; </div><div class="line">     &lt;description&gt;The name of the group of</div><div class="line">     super-users.&lt;/description&gt; </div><div class="line">&lt;/property&gt; </div><div class="line"> </div><div class="line">&lt;property&gt; </div><div class="line">     &lt;name&gt;dfs.block.access.token.enable&lt;/name&gt; </div><div class="line">     &lt;value&gt;true&lt;/value&gt; </div><div class="line">     &lt;description&gt; If &quot;true&quot;, access tokens are used as capabilities</div><div class="line">     for accessing datanodes. If &quot;false&quot;, no access tokens are checked on</div><div class="line">     accessing datanodes. &lt;/description&gt; </div><div class="line">&lt;/property&gt; </div><div class="line"> </div><div class="line">&lt;property&gt; </div><div class="line">     &lt;name&gt;dfs.namenode.kerberos.principal&lt;/name&gt; </div><div class="line">     &lt;value&gt;nn/_HOST@EXAMPLE.COM&lt;/value&gt; </div><div class="line">     &lt;description&gt; Kerberos principal name for the</div><div class="line">     NameNode &lt;/description&gt; </div><div class="line">&lt;/property&gt; </div><div class="line"> </div><div class="line">&lt;property&gt; </div><div class="line">     &lt;name&gt;dfs.secondary.namenode.kerberos.principal&lt;/name&gt; </div><div class="line">     &lt;value&gt;nn/_HOST@EXAMPLE.COM&lt;/value&gt; </div><div class="line">     &lt;description&gt;Kerberos principal name for the secondary NameNode. </div><div class="line">     &lt;/description&gt; </div><div class="line">&lt;/property&gt; </div><div class="line"> </div><div class="line">&lt;property&gt; </div><div class="line">     &lt;name&gt;dfs.web.authentication.kerberos.principal&lt;/name&gt; </div><div class="line">     &lt;value&gt;HTTP/_HOST@EXAMPLE.COM&lt;/value&gt; </div><div class="line">     &lt;description&gt; The HTTP Kerberos principal used by Hadoop-Auth in the HTTP endpoint.</div><div class="line">     The HTTP Kerberos principal MUST start with &apos;HTTP/&apos; per Kerberos HTTP</div><div class="line">     SPNEGO specification. </div><div class="line">     &lt;/description&gt; </div><div class="line">&lt;/property&gt; </div><div class="line"> </div><div class="line">&lt;property&gt; </div><div class="line">     &lt;name&gt;dfs.web.authentication.kerberos.keytab&lt;/name&gt; </div><div class="line">     &lt;value&gt;/etc/security/keytabs/spnego.service.keytab&lt;/value&gt; </div><div class="line">     &lt;description&gt;The Kerberos keytab file with the credentials for the HTTP</div><div class="line">     Kerberos principal used by Hadoop-Auth in the HTTP endpoint. </div><div class="line">     &lt;/description&gt; </div><div class="line">&lt;/property&gt; </div><div class="line"> </div><div class="line">&lt;property&gt; </div><div class="line">     &lt;name&gt;dfs.datanode.kerberos.principal&lt;/name&gt; </div><div class="line">     &lt;value&gt;dn/_HOST@EXAMPLE.COM&lt;/value&gt; </div><div class="line">     &lt;description&gt; </div><div class="line">     The Kerberos principal that the DataNode runs as. &quot;_HOST&quot; is replaced by the real</div><div class="line">     host name. </div><div class="line">     &lt;/description&gt; </div><div class="line">&lt;/property&gt; </div><div class="line"> </div><div class="line">&lt;property&gt; </div><div class="line">     &lt;name&gt;dfs.namenode.keytab.file&lt;/name&gt; </div><div class="line">     &lt;value&gt;/etc/security/keytabs/nn.service.keytab&lt;/value&gt; </div><div class="line">     &lt;description&gt; </div><div class="line">     Combined keytab file containing the namenode service and host</div><div class="line">     principals. </div><div class="line">     &lt;/description&gt; </div><div class="line">&lt;/property&gt; </div><div class="line"> </div><div class="line">&lt;property&gt; </div><div class="line">     &lt;name&gt;dfs.secondary.namenode.keytab.file&lt;/name&gt; </div><div class="line">     &lt;value&gt;/etc/security/keytabs/nn.service.keytab&lt;/value&gt; </div><div class="line">     &lt;description&gt; </div><div class="line">     Combined keytab file containing the namenode service and host</div><div class="line">     principals. </div><div class="line">     &lt;/description&gt; </div><div class="line">&lt;/property&gt; </div><div class="line"> </div><div class="line">&lt;property&gt; </div><div class="line">     &lt;name&gt;dfs.datanode.keytab.file&lt;/name&gt; </div><div class="line">     &lt;value&gt;/etc/security/keytabs/dn.service.keytab&lt;/value&gt; </div><div class="line">     &lt;description&gt; </div><div class="line">     The filename of the keytab file for the DataNode. </div><div class="line">     &lt;/description&gt; </div><div class="line">&lt;/property&gt; </div><div class="line"> </div><div class="line">&lt;property&gt; </div><div class="line">     &lt;name&gt;dfs.access.time.precision&lt;/name&gt; </div><div class="line">     &lt;value&gt;0&lt;/value&gt; </div><div class="line">     &lt;description&gt;The access time for HDFS file is precise upto this</div><div class="line">     value.The default value is 1 hour. Setting a value of 0</div><div class="line">     disables access times for HDFS. </div><div class="line">     &lt;/description&gt; </div><div class="line">&lt;/property&gt; </div><div class="line">&lt;property&gt; </div><div class="line">     &lt;name&gt;dfs.namenode.kerberos.internal.spnego.principal&lt;/name&gt; </div><div class="line">     &lt;value&gt;$&#123;dfs.web.authentication.kerberos.principal&#125;&lt;/value&gt; </div><div class="line">&lt;/property&gt; </div><div class="line"> </div><div class="line">&lt;property&gt; </div><div class="line">     &lt;name&gt;dfs.secondary.namenode.kerberos.internal.spnego.principal&lt;/name&gt; </div><div class="line">     &lt;value&gt;$&#123;dfs.web.authentication.kerberos.principal&#125;&lt;/value&gt; </div><div class="line">&lt;/property&gt;</div></pre></td></tr></table></figure>
<p>另外，还需加上如下配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">export HADOOP_SECURE_DN_USER=hdfs</div><div class="line">export HADOOP_SECURE_DN_PID_DIR=/grid/0/var/run/hadoop/$HADOOP_SECURE_DN_USER</div></pre></td></tr></table></figure>
<h6 id="yarn-site-xml"><a href="#yarn-site-xml" class="headerlink" title="yarn-site.xml"></a>yarn-site.xml</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">&lt;property&gt;</div><div class="line">     &lt;name&gt;yarn.resourcemanager.principal&lt;/name&gt;</div><div class="line">     &lt;value&gt;yarn/localhost@EXAMPLE.COM&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line"> </div><div class="line">&lt;property&gt;</div><div class="line">     &lt;name&gt;yarn.resourcemanager.keytab&lt;/name&gt;</div><div class="line">     &lt;value&gt;/etc/krb5.keytab&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line"> </div><div class="line">&lt;property&gt;</div><div class="line">     &lt;name&gt;yarn.nodemanager.principal&lt;/name&gt;</div><div class="line">     &lt;value&gt;yarn/localhost@EXAMPLE.COM&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line"> </div><div class="line">&lt;property&gt;</div><div class="line">     &lt;name&gt;yarn.nodemanager.keytab&lt;/name&gt;</div><div class="line">     &lt;value&gt;/etc/krb5.keytab&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line"> </div><div class="line">&lt;property&gt;</div><div class="line">     &lt;name&gt;yarn.nodemanager.container-executor.class&lt;/name&gt;</div><div class="line">     &lt;value&gt;org.apache.hadoop.yarn.server.nodemanager.LinuxContainerExecutor&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line"> </div><div class="line">&lt;property&gt;</div><div class="line">     &lt;name&gt;yarn.nodemanager.linux-container-executor.path&lt;/name&gt;</div><div class="line">     &lt;value&gt;hadoop-3.0.0-SNAPSHOT/bin/container-executor&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line"> </div><div class="line">&lt;property&gt;</div><div class="line">     &lt;name&gt;yarn.nodemanager.linux-container-executor.group&lt;/name&gt;</div><div class="line">     &lt;value&gt;hadoop&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line"> </div><div class="line">&lt;property&gt;</div><div class="line">     &lt;name&gt;yarn.timeline-service.principal&lt;/name&gt;</div><div class="line">     &lt;value&gt;yarn/localhost@EXAMPLE.COM&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line"> </div><div class="line">&lt;property&gt;</div><div class="line">     &lt;name&gt;yarn.timeline-service.keytab&lt;/name&gt;</div><div class="line">     &lt;value&gt;/etc/krb5.keytab&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line"> </div><div class="line">&lt;property&gt;</div><div class="line">     &lt;name&gt;yarn.resourcemanager.webapp.delegation-token-auth-filter.enabled&lt;/name&gt;</div><div class="line">     &lt;value&gt;true&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line"> </div><div class="line">&lt;property&gt;</div><div class="line">     &lt;name&gt;yarn.timeline-service.http-authentication.type&lt;/name&gt;</div><div class="line">     &lt;value&gt;kerberos&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line"> </div><div class="line">&lt;property&gt;</div><div class="line">     &lt;name&gt;yarn.timeline-service.http-authentication.kerberos.principal&lt;/name&gt;</div><div class="line">     &lt;value&gt;HTTP/localhost@EXAMPLE.COM&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div><div class="line"> </div><div class="line">&lt;property&gt;</div><div class="line">     &lt;name&gt;yarn.timeline-service.http-authentication.kerberos.keytab&lt;/name&gt;</div><div class="line">     &lt;value&gt;/etc/krb5.keytab&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div></pre></td></tr></table></figure>
<h6 id="mapred-site-xml"><a href="#mapred-site-xml" class="headerlink" title="mapred-site.xml"></a>mapred-site.xml</h6><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">&lt;property&gt;</div><div class="line">     &lt;name&gt;mapreduce.jobhistory.keytab&lt;/name&gt;</div><div class="line">     &lt;value&gt;/etc/security/keytabs/jhs.service.keytab&lt;/value&gt;</div><div class="line">&lt;/property&gt; </div><div class="line"> </div><div class="line">&lt;property&gt;</div><div class="line">     &lt;name&gt;mapreduce.jobhistory.principal&lt;/name&gt;</div><div class="line">     &lt;value&gt;jhs/_HOST@TODO-KERBEROS-DOMAIN&lt;/value&gt;</div><div class="line">&lt;/property&gt; </div><div class="line"> </div><div class="line">&lt;property&gt;</div><div class="line">     &lt;name&gt;mapreduce.jobhistory.webapp.address&lt;/name&gt;</div><div class="line">     &lt;value&gt;TODO-JOBHISTORYNODE-HOSTNAME:19888&lt;/value&gt;</div><div class="line">&lt;/property&gt; </div><div class="line"> </div><div class="line">&lt;property&gt;</div><div class="line">     &lt;name&gt;mapreduce.jobhistory.webapp.https.address&lt;/name&gt;</div><div class="line">     &lt;value&gt;TODO-JOBHISTORYNODE-HOSTNAME:19889&lt;/value&gt;</div><div class="line">&lt;/property&gt; </div><div class="line"> </div><div class="line">&lt;property&gt;</div><div class="line">     &lt;name&gt;mapreduce.jobhistory.webapp.spnego-keytab-file&lt;/name&gt;</div><div class="line">     &lt;value&gt;/etc/security/keytabs/spnego.service.keytab&lt;/value&gt;</div><div class="line">&lt;/property&gt; </div><div class="line"> </div><div class="line">&lt;property&gt;</div><div class="line">     &lt;name&gt;mapreduce.jobhistory.webapp.spnego-principal&lt;/name&gt;</div><div class="line">     &lt;value&gt;HTTP/_HOST@TODO-KERBEROS-DOMAIN&lt;/value&gt;</div><div class="line">&lt;/property&gt;</div></pre></td></tr></table></figure>
<p>参考：</p>
<ul>
<li><a href="http://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.4.2/bk_Security_Guide/content/install-kdc.html" target="_blank" rel="external">http://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.4.2/bk_Security_Guide/content/install-kdc.html</a></li>
<li><a href="https://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.4.2/bk_installing_manually_book/content/ch_security_for_manual_installs_chapter.html" target="_blank" rel="external">https://docs.hortonworks.com/HDPDocuments/HDP2/HDP-2.4.2/bk_installing_manually_book/content/ch_security_for_manual_installs_chapter.html</a></li>
<li><a href="http://blog.csdn.net/wulantian/article/details/42173023" target="_blank" rel="external">http://blog.csdn.net/wulantian/article/details/42173023</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[《集体智慧编程》--5---优化]]></title>
      <url>/2017/03/17/%E3%80%8A%E9%9B%86%E4%BD%93%E6%99%BA%E6%85%A7%E7%BC%96%E7%A8%8B%E3%80%8B--5---%E4%BC%98%E5%8C%96/</url>
      <content type="html"><![CDATA[<p>针对问题：<br>受多种变量的影响，存在许多可能解，结果因这些变量组合的变化产生巨大反应。</p>
<p>优化算法是通过尝试许多不同题解并给这些题解打分以确认其质量的方式找到一个问题的最优解。</p>
<h1 id="成本函数"><a href="#成本函数" class="headerlink" title="成本函数"></a>成本函数</h1><p>成本函数需要一个返回值代表方案的好坏。旅游团的例子中：</p>
<ul>
<li>价格</li>
<li>旅行时间</li>
<li>等待时间</li>
<li>汽车租用时间</li>
</ul>
<p>我们需要明确怎样把上面所有的成本综合在一起，表示最终的成本。</p>
<h2 id="获取方案的方法"><a href="#获取方案的方法" class="headerlink" title="获取方案的方法"></a>获取方案的方法</h2><table>
<thead>
<tr>
<th>方法</th>
<th>原理</th>
<th>缺点</th>
<th>优点</th>
</tr>
</thead>
<tbody>
<tr>
<td>随机搜索</td>
<td>随机生成N个方案，选取其中成本最低的方案</td>
<td>低效</td>
<td></td>
</tr>
<tr>
<td>爬山法</td>
<td>以一个随机解开始，在其临近解集中寻找更好的解，类似走成本的下坡路</td>
<td>陷入局部最优</td>
<td></td>
</tr>
<tr>
<td>模拟退火算法</td>
<td>退火是将合金加热后再慢慢冷却的过程。大量的原子因为受到激发而向四周跳跃，然后又逐渐稳定到一个低能的状态，所以这些原子能够找到一个低能阶的配置。<br>以一个随机解开始，用一个变量表示温度，开始时高，逐渐变低。第一次迭代，算法会随机选中某个数据，然后朝某个方向变化。它总是会接受一个更优的解，但是在算法开始阶段也会接受表现稍差的解。随着算法进行，越来越不能接受较差的解，最后只接受更优解。 <br>算法接受较差解的概率 P = exp[-(highcost-lowcost)/temperature]</td>
<td>前提：最优解接近其他优解</td>
</tr>
<tr>
<td>遗传算法</td>
<td>随机生成一组解，成为<strong>种群</strong>。计算整个种群的成本函数，得到一个有序列表，选出表现比较好的几个。然后对一个既有解做微小的、简单的、随机的改变，这称为<strong>变异</strong>。另一种方法是选择最优解中的两个，按照某种方式进行结合，称为<strong>交叉</strong>或者<strong>配对</strong>。这样就会衍生很多不同的解。</td>
<td>前提：最优解接近其他优解</td>
</tr>
</tbody>
</table>
<p>注意：利用优化算法解决问题的基本要求是：问题本身有一个定义好的成本函数，并且相似的解会产生相似的结果。</p>
<h2 id="学生分宿舍"><a href="#学生分宿舍" class="headerlink" title="学生分宿舍"></a>学生分宿舍</h2><p>如何将有限的资源分配给表达了偏好的人，并尽可能使他们都满意。(或根据他们的意愿，尽可能让他们都满意)。</p>
<p>将违反意愿的程度作为成本函数借用上述算法求解。</p>
<h2 id="网络可视化"><a href="#网络可视化" class="headerlink" title="网络可视化"></a>网络可视化</h2><p>运用优化算法构建条例明晰的网络图。成本函数就是计算相互交叉线的条数。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[索引相关]]></title>
      <url>/2017/03/15/%E7%B4%A2%E5%BC%95%E7%9B%B8%E5%85%B3/</url>
      <content type="html"><![CDATA[<ul>
<li>哈希存储引擎</li>
</ul>
<p>哈希表的持久化实现，支持增、删、改以及随机读取操作，但不支持顺序扫描，对应的存储系统为key-value存储系统。对于key-value的插入以及查询，哈希表的复杂度都是O(1)，明显比树的操作O(n)快,如果不需要有序的遍历数据，哈希表就是your Mr.Right</p>
<ul>
<li>B树存储引擎</li>
</ul>
<p>不仅支持单条记录的增、删、读、改操作，还支持顺序扫描（B+树的叶子节点之间的指针），对应的存储系统就是关系数据库（Mysql等）。</p>
<ul>
<li>LSM树【Log-Structured Merge-Tree】</li>
</ul>
<p>存储引擎和B树存储引擎一样，同样支持增、删、读、改、顺序扫描操作。而且通过批量存储技术规避磁盘随机写入问题。当然凡事有利有弊，LSM树和B+树相比，LSM树牺牲了部分读性能，用来大幅提高写性能。</p>
<p>==LSM树的设计思想==非常朴素：将对数据的修改增量保持在内存中，达到指定的大小限制后将这些修改操作批量写入磁盘，不过读取的时候稍微麻烦，需要合并磁盘中历史数据和内存中最近修改操作，所以写入性能大大提升，读取时可能需要先看是否命中内存，否则需要访问较多的磁盘文件。极端的说，基于LSM树实现的HBase的写性能比Mysql高了一个数量级，读性能低了一个数量级。</p>
<p><strong>LSM树原理把一棵大树拆分成N棵小树，它首先写入内存中，随着小树越来越大，内存中的小树会flush到磁盘中，磁盘中的树定期可以做merge操作，合并成一棵大树，以优化读性能.</strong></p>
<p>因为小树先写到内存中，为了防止内存数据丢失，写内存的同时需要暂时持久化到磁盘，对应了HBase的MemStore和HLog.</p>
<p>MemStore上的树达到一定大小之后，需要flush到HRegion磁盘中（一般是Hadoop DataNode），这样MemStore就变成了DataNode上的磁盘文件StoreFile，定期HRegionServer对DataNode的数据做merge操作，彻底删除无效空间，多棵小树在这个时机合并成大树，来增强读性能。</p>
<p>按照大小进行compact有三个缺点：</p>
<ul>
<li>因为不能确定单行数据的版本都在哪里，所以无法保证一致性。最坏的情况下，每个sstable里都有一个某row的版本，分别包含不同的字段；</li>
<li>如果有大量删除操作的话，在merge以前很多数据的空间都是没有必要占用的；</li>
<li>在每个sstable在merge完成之前还是会占用很大的数据空间。最坏的情况就是，一个sstable并没有任何东西删除，那么Cassandra就使用同样大小的空间来进行compact操作。</li>
</ul>
<h2 id="Leveled-Compaction"><a href="#Leveled-Compaction" class="headerlink" title="Leveled Compaction"></a>Leveled Compaction</h2><p>Leveled Compaction 创建相对小的固定大小的sstable(默认5M)，按照level分组。每层的sstable都不重复，每一层都是前一层的10倍大小。</p>
<p>解决了以上三个问题：</p>
<ul>
<li>level compaction保证90%的读请求只需要一个sstable里。最坏也就是每层有一个版本，加入10T数据，也就只有7个版本【10的7次方】</li>
<li>最多只有10%的空间浪费给要被删除的数据</li>
<li>每次只有10倍于sstable固定大小的空间被用于compaction的过程</li>
</ul>
<p>由于level compaction上面的原理，相对于hbase 的基于大小的compaction，会有两倍的io。如果是以插入为主的系统，额外的io可能相对于上面的益处更严重一些，因为插入为主的话，还是很少出现row的相同版本的。</p>
<p>参考：</p>
<ul>
<li><a href="http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.44.2782&amp;rep=rep1&amp;type=pdf" target="_blank" rel="external">http://citeseerx.ist.psu.edu/viewdoc/download?doi=10.1.1.44.2782&amp;rep=rep1&amp;type=pdf</a></li>
<li><a href="http://www.cnblogs.com/yanghuahui/p/3483754.html" target="_blank" rel="external">http://www.cnblogs.com/yanghuahui/p/3483754.html</a></li>
<li><a href="http://www.open-open.com/lib/view/open1424916275249.html" target="_blank" rel="external">http://www.open-open.com/lib/view/open1424916275249.html</a></li>
<li><a href="http://www.datastax.com/dev/blog/leveled-compaction-in-apache-cassandra" target="_blank" rel="external">http://www.datastax.com/dev/blog/leveled-compaction-in-apache-cassandra</a></li>
<li><a href="http://hbasefly.com/2016/03/25/hbase-hfile/" target="_blank" rel="external">http://hbasefly.com/2016/03/25/hbase-hfile/</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[对于runningdata失败任务流重启的思考]]></title>
      <url>/2017/03/09/%E5%AF%B9%E4%BA%8Erunningdata%E5%A4%B1%E8%B4%A5%E4%BB%BB%E5%8A%A1%E6%B5%81%E9%87%8D%E5%90%AF%E7%9A%84%E6%80%9D%E8%80%83/</url>
      <content type="html"><![CDATA[<p>对于单个ETL的重导。可以在ETL里自己写IF语句，然后配置调度的时候.</p>
<h2 id="重导的方案A："><a href="#重导的方案A：" class="headerlink" title="重导的方案A："></a>重导的方案A：</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">files=$1</div><div class="line">other_files=$2</div><div class="line">sh $other_files</div><div class="line">if [ $? -eq 0 ]; then</div><div class="line">     echo &quot;echo $other_files done&quot; &gt; $file</div><div class="line">fi</div></pre></td></tr></table></figure>
<p>然后在azkaban执行这个就可以了。<br>other_files里是我们实际要执行的命令，$file是我们的azkaban执行的command.<br>一个更简便的方案，就是把azkaban的命令写成这样，省去自己判断上个命令推出状态：<br><code>ipconfig &amp;&amp; echo xxxxxxxxxxxxxx &gt; test.sh</code><br>如果第一个命令出问题，那么肯定就不会执行第二个了。<br>这样就可以执行日常任务的时候进行任务恢复了，只要是某个任务出现功能性失败，那么就会报错，而且不影响要执行的命令脚本；而成功的任务则会在执行完成后，修改执行的命令脚本，只是echo一下这个任务已经执行过了就好了。<br>然后每次要执行失败任务恢复的时候，就直接重新执行整个flow，前面成功执行过的就会自动pass，输出已经执行过了。</p>
<p>还有一个问题，就是如果是代码问题，例如sql问题，必须通过修改ETL里的sql或者配置、或者presql等来解决的话，应该怎样处理？</p>
<p>最简单的支持方式是：直接提供一个页面给管理员，编辑azkaban执行的任务文件，再进行重调。</p>
<p>现在我们azkaban的任务调度形式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hive -f /var/azkaban-metamap/h2h-20170308050120/fact_jlc@redeem_record.hql</div></pre></td></tr></table></figure></p>
<p>对应修改成的就是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hive -f /var/azkaban-metamap/h2h-20170308050120/fact_jlc@redeem_record.hql &amp;&amp; echo &quot;select &apos;/var/azkaban-metamap/h2h-20170308050120/fact_jlc@redeem_record.hql&apos; done&quot;</div></pre></td></tr></table></figure></p>
<p>如果出现问题，需要从这个地方开始恢复数据的话，走以下流程：</p>
<ul>
<li>a. 编辑修改ETL</li>
<li>b. 测试新ETL是否无误</li>
<li>c. review hql，如需要修改个别地方手动修改</li>
<li>d. 打开编辑/var/azkaban-metamap/h2h-20170308050120/fact_jlc@redeem_record.hql的web页面，将c步骤中获取的内容放进来</li>
<li>e. 到azkaban重新执行今天的任务</li>
</ul>
<p>期望出现的现象：</p>
<ul>
<li>a. 前面已经执行过的任务，自动输出已执行并跳过</li>
<li>b. 失败任务继续执行，读取的/var/azkaban-metamap/h2h-20170308050120/fact_jlc@redeem_record.hql是已经修改了的没有问题的文件</li>
</ul>
<p>额外提示：</p>
<ul>
<li>a. 如果使用此种失败重启的方式，那么所有依赖关系都会被认为是<strong>强依赖</strong>。假设一个极端情况，就是一个大宽表依赖10个小表，并服务于8个应用，如果只有一个小表失败，就得使得整个宽表都不能跑。有可能这个小表只服务于一个小业务模块，但是其他几个就很重要。这样影响面比较大。</li>
<li>b. 如果使用此种重启方式，使用弱依赖，也就是当前表的失败并不影响下游任务继续执行的话，那么重新调度的时下游就不能执行了，因为它可能已经echo自己是成功的了。变态支持此方案的话，需要在d步骤的时候，添加一个hook，遍历所有没有成功的ETL的所有子节点，然后把这些子节点恢复为可执行状态。</li>
</ul>
<h2 id="方案B"><a href="#方案B" class="headerlink" title="方案B"></a>方案B</h2><p>指定ETL，生成这个ETL及其所有相关字节点的任务，上传到azkaban进行调度。</p>
<p><strong>问题</strong>：<br>如果多个ETL失败，交叉的子节点会重复执行。</p>
<p><strong>解决方案</strong>：<br>一次接收多个ETL为参数，放进set里，再去生成相应任务</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[《集体智慧编程》--2---分级聚类]]></title>
      <url>/2017/03/07/%E3%80%8A%E9%9B%86%E4%BD%93%E6%99%BA%E6%85%A7%E7%BC%96%E7%A8%8B%E3%80%8B--2---%E5%88%86%E7%BA%A7%E8%81%9A%E7%B1%BB/</url>
      <content type="html"><![CDATA[<p>分级聚类：<strong>每个群组都从单一元素开始，迭代过程中，分级聚类算法计算每两个群组间的距离，并将距离最近的两个群组合并成一个新的群组。这个过程一直重复下去，知道只剩下一个群组为止。</strong></p>
<p><img src="http://blog.pureisle.net/wp-content/uploads/2012/09/11-600x375.png" alt=""></p>
<p>也可以用树表示，树状图还能通过节点距离快速获取两个类的<strong>紧密程度</strong>。</p>
<p><img src="http://images2015.cnblogs.com/blog/822124/201703/822124-20170306200317656-1586066395.png" alt=""></p>
<p>参考：<a href="http://jingyan.baidu.com/article/29697b9109d147ab21de3c44.html" target="_blank" rel="external">http://jingyan.baidu.com/article/29697b9109d147ab21de3c44.html</a></p>
<p>【个人从分级聚类的概念出发，其实这个2是个可变的，也就是说可以5个为一群，对应的树就是每个节点有5个分叉】</p>
<p>这一章还是使用皮尔逊相关度系数来作为衡量标准。皮尔逊相关系数是一种度量两个变量间相关程度的方法。它是一个介于 1 和 -1 之间的值，其中，1 表示变量完全正相关， 0 表示无关，-1 表示完全负相关。</p>
<p>分层角力算法以一组对应于原始数据向的聚类开始。函数的主循环部分会尝试每一组可能的配对并计算他们的相关度，找出最佳配对。新生成的聚类中包含的数据是两个旧聚类的数据均值。</p>
<p>参考：</p>
<ul>
<li><a href="https://segmentfault.com/q/1010000000094674" target="_blank" rel="external">皮尔逊相关度系数</a></li>
<li><a href="http://blog.csdn.net/beta2/article/details/5045020" target="_blank" rel="external">相似度度量</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Fabric自动化运维脚本]]></title>
      <url>/2017/02/27/Fabric%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E8%84%9A%E6%9C%AC/</url>
      <content type="html"><![CDATA[<p>综合考察了salt和Fabric两个东西，最后使用灵活的Fabric来自动化运维HDFS集群的日志文件维护。</p>
<p>使用前提：</p>
<ul>
<li>node之间的ssh互信</li>
<li>本机安装fabric</li>
</ul>
<p>下面是fabric.py的脚本：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> fabric.api <span class="keyword">import</span> *</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_host</span><span class="params">()</span>:</span></div><div class="line">    hosts = list()</div><div class="line">    <span class="keyword">with</span> open(<span class="string">'/etc/hosts'</span>, <span class="string">'r'</span>) <span class="keyword">as</span> hf:</div><div class="line">        <span class="keyword">for</span> line <span class="keyword">in</span> hf.readlines():</div><div class="line">            ss = line.split()</div><div class="line">            <span class="keyword">if</span> <span class="string">'node'</span> <span class="keyword">in</span> ss[<span class="number">1</span>]:</div><div class="line">		hosts.append(ss[<span class="number">0</span>])</div><div class="line">    hosts.remove(<span class="string">'10.0.1.111'</span>)</div><div class="line">    hosts.remove(<span class="string">'10.0.1.112'</span>)</div><div class="line">    <span class="keyword">return</span> hosts</div><div class="line"></div><div class="line">env.hosts = get_host()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">hello</span><span class="params">()</span>:</span></div><div class="line">    print(<span class="string">"Hello world!"</span>)</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">will</span><span class="params">()</span>:</span></div><div class="line">    run(<span class="string">'ifconfig'</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">clean_log</span><span class="params">()</span>:</span></div><div class="line"><span class="comment">#    run("ls /var/log/hadoop/hdfs/ | awk '&#123;if (index($0, '2017') &gt; 0) print $0&#125;' | exec rm -rf &#123;&#125; \ ; ")</span></div><div class="line">    <span class="keyword">with</span> settings(warn_only=<span class="keyword">True</span>):    </div><div class="line">	local(<span class="string">'echo `date` &gt;&gt; ~/clean_log.log'</span>)</div><div class="line">	<span class="keyword">if</span> run(<span class="string">'find /var/log/hadoop/hdfs/ -mtime +3 -name "*log-2016*" -exec rm -rvf &#123;&#125; \;'</span>).failed:</div><div class="line">            print(<span class="string">'failed for %s '</span> % env.host)</div><div class="line">        <span class="keyword">if</span> run(<span class="string">'find /var/log/hadoop/hdfs/ -mtime +3 -name "*will.com.out.[3,4,5,6,7,8]" -exec rm -rvf &#123;&#125; \;'</span>).failed:</div><div class="line">	    print(<span class="string">'failed for %s '</span> % env.host)</div><div class="line">        <span class="keyword">if</span> run(<span class="string">'find /var/log/hadoop/hdfs/ -mtime +3 -name "*will.com.log.[3,4,5,6,7,8]" -exec rm -rvf &#123;&#125; \;'</span>).failed:</div><div class="line">            print(<span class="string">'failed for %s '</span> % env.host)</div></pre></td></tr></table></figure></p>
<p>上面例子中，是读取了当前/etc/hosts文件中的所有host的IP，之后逐一执行远程命令，删除过期的日志。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[安装dockercenter的ucp]]></title>
      <url>/2017/02/17/%E5%AE%89%E8%A3%85dockercenter%E7%9A%84ucp/</url>
      <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker pull docker/ucp:2.1.0</div><div class="line">2.1.0: Pulling from docker/ucp</div><div class="line">b7f33cc0b48e: Pulling fs layer </div><div class="line">8257d57cc15c: Pulling fs layer </div><div class="line">b7f33cc0b48e: Pull complete </div><div class="line">8257d57cc15c: Extracting [==================================================&gt;] 348.8 kB/348.8 kB</div><div class="line">8257d57cc15c: Pull complete </div><div class="line">f691f14109b2: Pull complete </div><div class="line">Digest: sha256:fd43a6560b6f5731d0e383a7b5fe6da91cea11bc6b3fd65afe08f5e4a97dbc90</div><div class="line">Status: Downloaded newer image for docker/ucp:2.1.0</div><div class="line">[root@controller wil]# docker run --rm -it --name ucp   -v /var/run/docker.sock:/var/run/docker.sock   docker/ucp:2.1.0 install   --host-address 10.1.5.129   --interactive</div><div class="line"></div><div class="line">INFO[0000] Verifying your system is compatible with UCP </div><div class="line">INFO[0000] Your engine version 1.13.1, build 092cba3 (3.10.0-514.2.2.el7.x86_64) is compatible </div><div class="line">WARN[0003] Your system uses devicemapper.  We can not accurately detect available storage space.  Please make sure you have at least 3.00 GB available in /server/dspace </div><div class="line">Admin Username: unable to scan value: unexpected newline</div><div class="line">FATA[0005] unable to get admin username, giving up    </div><div class="line">[root@controller wil]# docker login</div><div class="line">Login with your Docker ID to push and pull images from Docker Hub. If you don&apos;t have a Docker ID, head over to https://hub.docker.com to create one.</div><div class="line">Username (willcup): </div><div class="line">Password: </div><div class="line">Login Succeeded</div><div class="line">[root@controller wil]# docker run --rm -it --name ucp   -v /var/run/docker.sock:/var/run/docker.sock   docker/ucp:2.1.0 install   --host-address 10.1.5.129   --interactive</div><div class="line">INFO[0000] Verifying your system is compatible with UCP </div><div class="line">INFO[0000] Your engine version 1.13.1, build 092cba3 (3.10.0-514.2.2.el7.x86_64) is compatible </div><div class="line">WARN[0001] Your system uses devicemapper.  We can not accurately detect available storage space.  Please make sure you have at least 3.00 GB available in /server/dspace </div><div class="line">Admin Username: willcup</div><div class="line">Admin Password: </div><div class="line">Confirm Admin Password: </div><div class="line">INFO[0021] Pulling required images... (this may take a while)</div></pre></td></tr></table></figure>
<p>可以看到如果不先docker login的话，启动时候就报错找不到admin name。然而启动的时候又让我们自己定义admin name和passwd。醉了。</p>
<p>打开debug：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker run --rm -it --name ucp   -v /var/run/docker.sock:/var/run/docker.sock   docker/ucp:2.1.0 install   --host-address 10.1.5.129   -D --interactive</div><div class="line">DEBU[0000] New UCP Instance ID will be &quot;XZNK:CP6T:DHHE:XJZA:OXOM:CLS6:RIRW:SAVZ:4JIL:G3Q4:DJ7F:L7P3&quot; </div><div class="line">INFO[0000] Verifying your system is compatible with UCP </div><div class="line">DEBU[0000] Checking for compatible kernel version       </div><div class="line">DEBU[0000] Kernel version 3.10.0-514.2.2.el7.x86_64 is compatible </div><div class="line">DEBU[0000] Checking for compatible engine version       </div><div class="line">INFO[0000] Your engine version 1.13.1, build 092cba3 (3.10.0-514.2.2.el7.x86_64) is compatible </div><div class="line">DEBU[0000] Container ucp-phase2 not present: Error: No such container: ucp-phase2 </div><div class="line">DEBU[0000] Detected container ucp                       </div><div class="line">DEBU[0000] Container ucp-controller not present: Error: No such container: ucp-controller </div><div class="line">DEBU[0000] Container ucp-swarm-manager not present: Error: No such container: ucp-swarm-manager </div><div class="line">DEBU[0000] Container ucp-swarm-join not present: Error: No such container: ucp-swarm-join </div><div class="line">DEBU[0000] Container ucp-kv not present: Error: No such container: ucp-kv </div><div class="line">DEBU[0000] Container ucp-proxy not present: Error: No such container: ucp-proxy </div><div class="line">DEBU[0000] Container ucp-client-root-ca not present: Error: No such container: ucp-client-root-ca </div><div class="line">DEBU[0000] Container ucp-cluster-root-ca not present: Error: No such container: ucp-cluster-root-ca </div><div class="line">DEBU[0000] Container ucp-auth-store not present: Error: No such container: ucp-auth-store </div><div class="line">DEBU[0000] Container ucp-auth-api not present: Error: No such container: ucp-auth-api </div><div class="line">DEBU[0000] Container ucp-auth-worker not present: Error: No such container: ucp-auth-worker </div><div class="line">DEBU[0000] Container ucp-kv-backup not present: Error: No such container: ucp-kv-backup </div><div class="line">DEBU[0000] Container ucp-kv-restore not present: Error: No such container: ucp-kv-restore </div><div class="line">DEBU[0000] Container ucp-metrics not present: Error: No such container: ucp-metrics </div><div class="line">DEBU[0000] Validating base system meets minimum requirements </div><div class="line">DEBU[0000] Your system meets minimum memory requirements:  3.88 GB &gt;= 2.00 GB </div><div class="line">WARN[0000] Your system uses devicemapper.  We can not accurately detect available storage space.  Please make sure you have at least 3.00 GB available in /server/dspace </div><div class="line">Admin Username: will</div><div class="line">Admin Password: </div><div class="line">Confirm Admin Password: </div><div class="line">DEBU[0207] Checking for images                          </div><div class="line">INFO[0207] All required images are present              </div><div class="line">DEBU[0208] Local Name: controller                       </div><div class="line">WARN[0208] None of the hostnames we&apos;ll be using in the UCP certificates [controller 127.0.0.1 172.17.0.1] contain a domain component.  Your generated certs may fail TLS validation unless you only use one of these shortnames or IPs to connect.  You can use the --san flag to add more aliases </div><div class="line"></div><div class="line">You may enter additional aliases (SANs) now or press enter to proceed with the above list.</div><div class="line">Additional aliases: willalias</div><div class="line">DEBU[0222] User entered: willalias</div><div class="line">                     </div><div class="line">DEBU[0222] Hostnames: [controller 127.0.0.1 172.17.0.1 willalias] </div><div class="line">DEBU[0245] Launching phase 2 with: [install --host-address 10.1.5.129 -D --interactive] (6f2f352ea35e614de1005fe6d93c9843c3f972dc1e7cf5191ea9ed7a0e46fb25) </div><div class="line">DEBU[0000] Beginning phase 2 install for instance XZNK:CP6T:DHHE:XJZA:OXOM:CLS6:RIRW:SAVZ:4JIL:G3Q4:DJ7F:L7P3 </div><div class="line">DEBU[0000] Checking for compatible kernel version       </div><div class="line">DEBU[0000] Kernel version 3.10.0-514.2.2.el7.x86_64 is compatible </div><div class="line">DEBU[0000] Checking for compatible engine version       </div><div class="line">DEBU[0000] Detected container ucp-phase2                </div><div class="line">DEBU[0001] Container ucp-controller not present: Error: No such container: ucp-controller </div><div class="line">DEBU[0001] Container ucp-swarm-manager not present: Error: No such container: ucp-swarm-manager </div><div class="line">DEBU[0001] Container ucp-swarm-join not present: Error: No such container: ucp-swarm-join </div><div class="line">DEBU[0001] Container ucp-kv not present: Error: No such container: ucp-kv </div><div class="line">DEBU[0001] Container ucp-proxy not present: Error: No such container: ucp-proxy </div><div class="line">DEBU[0001] Container ucp-client-root-ca not present: Error: No such container: ucp-client-root-ca </div><div class="line">DEBU[0001] Container ucp-cluster-root-ca not present: Error: No such container: ucp-cluster-root-ca </div><div class="line">DEBU[0001] Container ucp-auth-store not present: Error: No such container: ucp-auth-store </div><div class="line">DEBU[0001] Container ucp-auth-api not present: Error: No such container: ucp-auth-api </div><div class="line">DEBU[0001] Container ucp-auth-worker not present: Error: No such container: ucp-auth-worker </div><div class="line">DEBU[0001] Container ucp-kv-backup not present: Error: No such container: ucp-kv-backup </div><div class="line">DEBU[0001] Container ucp-kv-restore not present: Error: No such container: ucp-kv-restore </div><div class="line">DEBU[0001] Container ucp-metrics not present: Error: No such container: ucp-metrics </div><div class="line">DEBU[0001] Local Name: controller                       </div><div class="line">DEBU[0001] Hostnames: [controller 127.0.0.1 172.17.0.1 willalias] </div><div class="line">DEBU[0001] This node is known as efpood09fyouiyib1f78y5oa6 </div><div class="line">DEBU[0001] Got node IP 10.1.5.129 from swarm            </div><div class="line">DEBU[0001] EnginePortCheck: port 2375, prpl http, err Get http://10.1.5.129:2375/info: dial tcp 10.1.5.129:2375: getsockopt: connection refused </div><div class="line">DEBU[0001] EnginePortCheck: port 2375, prpl https, err Get https://10.1.5.129:2375/info: dial tcp 10.1.5.129:2375: getsockopt: connection refused </div><div class="line">DEBU[0001] EnginePortCheck: port 2376, prpl http, err Get http://10.1.5.129:2376/info: dial tcp 10.1.5.129:2376: getsockopt: connection refused </div><div class="line">DEBU[0001] EnginePortCheck: port 2376, prpl https, err Get https://10.1.5.129:2376/info: dial tcp 10.1.5.129:2376: getsockopt: connection refused </div><div class="line">DEBU[0001] Checking for available and accessible port 12387 </div><div class="line">DEBU[0001] Checking for available and accessible port 12380 </div><div class="line">DEBU[0001] Checking for available and accessible port 12381 </div><div class="line">DEBU[0001] Checking for available and accessible port 443 </div><div class="line">DEBU[0001] Checking for available and accessible port 12382 </div><div class="line">DEBU[0001] Checking for available and accessible port 2376 </div><div class="line">DEBU[0001] Checking for available and accessible port 12383 </div><div class="line">DEBU[0001] Checking for available and accessible port 12376 </div><div class="line">DEBU[0001] Checking for available and accessible port 12384 </div><div class="line">DEBU[0001] Checking for available and accessible port 4789 </div><div class="line">DEBU[0001] Checking for available and accessible port 12385 </div><div class="line">DEBU[0001] Checking for available and accessible port 12379 </div><div class="line">DEBU[0001] Checking for available and accessible port 12386 </div><div class="line">DEBU[0038] Checking for liveness of http://10.1.5.129:4789/ </div><div class="line">DEBU[0039] Connected to http://10.1.5.129:4789/         </div><div class="line">DEBU[0063] Checking for liveness of http://10.1.5.129:12387/ </div><div class="line">DEBU[0063] Connected to http://10.1.5.129:12387/        </div><div class="line">DEBU[0089] Checking for liveness of http://10.1.5.129:12382/ </div><div class="line">DEBU[0089] Connected to http://10.1.5.129:12382/        </div><div class="line">DEBU[0114] Checking for liveness of http://10.1.5.129:12384/ </div><div class="line">DEBU[0114] Connected to http://10.1.5.129:12384/        </div><div class="line">DEBU[0126] Checking for liveness of http://10.1.5.129:12376/ </div><div class="line">DEBU[0126] Connected to http://10.1.5.129:12376/        </div><div class="line">DEBU[0158] Checking for liveness of http://10.1.5.129:12383/ </div><div class="line">DEBU[0161] Connected to http://10.1.5.129:12383/        </div><div class="line">DEBU[0183] Checking for liveness of http://10.1.5.129:443/ </div><div class="line">DEBU[0185] Connected to http://10.1.5.129:443/          </div><div class="line">DEBU[0199] Checking for liveness of http://10.1.5.129:2376/ </div><div class="line">DEBU[0201] Connected to http://10.1.5.129:2376/         </div><div class="line">DEBU[0235] Checking for liveness of http://10.1.5.129:12386/ </div><div class="line">DEBU[0240] Connected to http://10.1.5.129:12386/        </div><div class="line">DEBU[0260] Checking for liveness of http://10.1.5.129:12381/ </div><div class="line">DEBU[0260] Connected to http://10.1.5.129:12381/        </div><div class="line">DEBU[0271] Checking for liveness of http://10.1.5.129:12385/ </div><div class="line">DEBU[0271] Connected to http://10.1.5.129:12385/        </div><div class="line">DEBU[0295] Checking for liveness of http://10.1.5.129:12379/ </div><div class="line">DEBU[0295] Connected to http://10.1.5.129:12379/        </div><div class="line">DEBU[0321] Checking for liveness of http://10.1.5.129:12380/ </div><div class="line">DEBU[0321] Connected to http://10.1.5.129:12380/        </div><div class="line">DEBU[0429] All ports are open and available             </div><div class="line">DEBU[0429] Purging old state from UCP volumes mounted in /var/lib/docker/ucp </div><div class="line">INFO[0429] Establishing mutual Cluster Root CA with Swarm </div><div class="line">INFO[0429] Installing UCP with host address 10.1.5.129 - If this is incorrect, please specify an alternative address with the &apos;--host-address&apos; flag </div><div class="line">INFO[0429] Generating UCP Client Root CA                </div><div class="line">DEBU[0429] Writing /var/lib/docker/ucp/ucp-client-root-ca/key.pem </div><div class="line">INFO[0430] Deploying UCP Service                        </div><div class="line">DEBU[0433] Local task container not found, trying again. </div><div class="line">DEBU[0459] Local task container not found, trying again. </div><div class="line">................</div><div class="line">................</div><div class="line">DEBU[0461] Local task container not found, trying again. </div><div class="line">ERRO[0461] Unable to get local task container for ucp-agent service </div><div class="line">FATA[0461] unable to find local task container</div></pre></td></tr></table></figure></p>
<p>重新仔细阅读一下官方文档，发现有些前置条件没有满足：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Docker Engine 1.13.0</div><div class="line">Docker Remote API 1.25</div><div class="line">Compose 1.9</div></pre></td></tr></table></figure></p>
<p>刚才docker remote没有开启，compose的版本也不够。</p>
<p>先升级一下所有docker节点的compose：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@dnode2 willyarnbase]# curl -L &quot;https://github.com/docker/compose/releases/download/1.11.1/docker-compose-$(uname -s)-$(uname -m)&quot; -o /usr/local/bin/docker-compose</div><div class="line">  % Total    % Received % Xferd  Average Speed   Time    Time     Time  Current</div><div class="line">                                 Dload  Upload   Total   Spent    Left  Speed</div><div class="line">100   600    0   600    0     0    534      0 --:--:--  0:00:01 --:--:--   534</div><div class="line">100 8053k  100 8053k    0     0   403k      0  0:00:19  0:00:19 --:--:--  806k</div><div class="line">[root@dnode2 willyarnbase]# docker-compose -v</div><div class="line">docker-compose version 1.11.1, build 7c5d5e4</div></pre></td></tr></table></figure></p>
<p>再编辑/etc/docker/daemon.json配置文件，添加下面配置，启动docker remote API:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&quot;hosts&quot;: [&quot;tcp://0.0.0.0:4243&quot;,&quot;unix:///var/run/docker.sock&quot;]</div></pre></td></tr></table></figure></p>
<p>然后访问此docker节点的4243接口，例如：<a href="http://10.1.5.129:4243/images/json，测试可以获取到当前节点的image信息，代表已经成功启用了docker" target="_blank" rel="external">http://10.1.5.129:4243/images/json，测试可以获取到当前节点的image信息，代表已经成功启用了docker</a> remote api。</p>
<p>访问<a href="http://10.1.5.129:4243/version，查看相关版本信息：" target="_blank" rel="external">http://10.1.5.129:4243/version，查看相关版本信息：</a><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">&quot;Version&quot;: &quot;1.13.1&quot;,</div><div class="line">&quot;ApiVersion&quot;: &quot;1.26&quot;,</div><div class="line">&quot;MinAPIVersion&quot;: &quot;1.12&quot;,</div><div class="line">&quot;GitCommit&quot;: &quot;092cba3&quot;,</div><div class="line">&quot;GoVersion&quot;: &quot;go1.7.5&quot;,</div><div class="line">&quot;Os&quot;: &quot;linux&quot;,</div><div class="line">&quot;Arch&quot;: &quot;amd64&quot;,</div><div class="line">&quot;KernelVersion&quot;: &quot;3.10.0-514.2.2.el7.x86_64&quot;,</div><div class="line">&quot;BuildTime&quot;: &quot;2017-02-08T06:38:28.018621521+00:00&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>版本是1.26，已经满足前面的各个docker组件的版本需求，把这个配置scp给其他的docker节点即可。</p>
<p>参考： <a href="https://docs.docker.com/engine/api/v1.26/" target="_blank" rel="external">https://docs.docker.com/engine/api/v1.26/</a></p>
<p>再去controller启动ucp：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker run --rm -it --name ucp   -v /var/run/docker.sock:/var/run/docker.sock   docker/ucp:2.1.0 install   --host-address 10.1.5.129  --interactive</div><div class="line">INFO[0000] Verifying your system is compatible with UCP </div><div class="line">INFO[0000] Your engine version 1.13.1, build 092cba3 (3.10.0-514.2.2.el7.x86_64) is compatible </div><div class="line">FATA[0019] This swarm is already managed by UCP. Please either uninstall UCP first using the &apos;uninstall-ucp&apos; operation or upgrade your cluster to a newer version</div></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[机器学习与R语言——模型Tips]]></title>
      <url>/2017/02/09/%E6%9C%BA%E5%99%A8%E5%AD%A6%E4%B9%A0%E4%B8%8ER%E8%AF%AD%E8%A8%80%E2%80%94%E2%80%94%E6%A8%A1%E5%9E%8BTips/</url>
      <content type="html"><![CDATA[<p>通用<br>=<br>对于NA缺失值的处理，连续型的可以给以均值、枚举型应该给一个unknown的计数。</p>
<p>距离类的算法，需要将各个特征进行标准化【z-score、max-min】</p>
<p>kmeans聚类<br>=<br>选择类的数量：根据业务判断</p>
<p>聚类结果的各类中的数量不应相差过于悬殊【也跟业务有关】</p>
<p>可以根据各个cluster中的特征z-score看出各个cluster自己的特性，并为之冠以业务名称。</p>
<p>模型性能评价<br>=<br>我们通常只用了分类结果，但是隐藏的概率没有看到。</p>
<p>例如，一个分类器可以同99%的把握确信包含“免费”和“铃声”等词语的短信是垃圾短信，但是只有51%的把握确信包含“今晚”的短信是垃圾短信。这两种情况都会被预测为垃圾短信，但是对两者做判断的确信程度就很大。一个是99，另一个才只有51，后者就极容易出现错误判断。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&gt; head(subset(sms_results, actual_type != predict_type))</div></pre></td></tr></table></figure></p>
<h4 id="混淆矩阵"><a href="#混淆矩阵" class="headerlink" title="混淆矩阵"></a>混淆矩阵</h4><p>通常使用二元的混淆矩阵：</p>
<p>准确率、错误率<br>kappa统计量<br>灵敏度（真阳性lv）、特异性（真阴性率）<br>精确度（阳性预测值）、召回率<br>F度量（综合精确度和召回率）</p>
<p>使用ROC曲线来可视化模型的可用性，ROC曲线是Y为真阳性比例、X为假阳性比例的线图。<br>AUC是ROC曲线下的面积，一般作为评价分类器的统计量。(Area Under the ROC)</p>
<h4 id="抽样"><a href="#抽样" class="headerlink" title="抽样"></a>抽样</h4><p>分层抽样：在从全量数据中抽取训练集或测试集的时候有个问题，就是每个类别中的数量可能过大或过小，因此我们应该从每个类别中按同样比例随机抽取数据。</p>
<p>K折交叉验证的方法默认就是使用分层抽样进行每次数据集的划分的。</p>
<p>较小数据集的时候，自助法抽样比K折的效果更好一些。</p>
<h4 id="提高模型的性能"><a href="#提高模型的性能" class="headerlink" title="提高模型的性能"></a>提高模型的性能</h4><p>可以使用caret进行自动参数调整，考虑三个问题：</p>
<ul>
<li>需要使用数据来训练哪种机器学习模型</li>
<li>哪些模型参数是可以调整的，能调整的空间有多大</li>
<li>使用何种评价标准来评估模型从而找到最优的候选者</li>
<li></li>
</ul>
<p>朴素贝叶斯<br>=<br>假设数据集的所有特征都具有相同的重要性和独立性。</p>
<p>在贝叶斯算法中，概率值是相乘的，所以概率为0的值将导致该消息是垃圾邮件的后验概率为0.这种问题使用一种叫做拉普拉斯估计(Laplace estimator)的方法解决，本质上就是给频率表中的每个技术都加上一个较小的数，保证每一类中每个特征发生的概率是非零的。</p>
<p>决策树<br>=<br>boosting算法思想：通过将很多能力弱的学习算法组合在一起，就可以创建一个团队，这比任何一个单独学习算法都强的多。每个模型都有一组特定的优点和缺点，对于特定的问题，可能更好，也可能更差，而使用优缺互补的多种学习方法的结合，就可以显著提高分类器的准确性。</p>
<p>C5.0中是添加一个trials参数，表示在模型增强团队中使用的独立决策树的数量。trials设置了一个上限，如果该算法识别出额外的试验似乎没有提高模型准确性，那么它将停止添加决策树。</p>
<p>为啥默认不用boosting呢？一是时间因素，二是如果训练数据集很杂乱，那么boosting可能根本不会改善模型性能。</p>
<p>针对具体业务，设置风险矩阵cost matrix，添加到模型训练过程中，虽然整体预测准确率会降低，但是能够降低业务风险。</p>
<p>规则学习<br>=<br>规则学习经常以一种类似决策树学习的方式被使用。分类规则代表的是if-else逻辑语句形式的知识，可以用来对未标记的案例指定一个分类。</p>
<p>与决策树不同的是，决策树必须从上倒下地应用，而规则是单独存在的事实。根据相同数据建立的模型，规则学习的结果通常比决策树的结果更简洁、更直接、更容易理解。</p>
<p>规则学习擅长识别偶发事件。</p>
<p>决策树是分而治之，规则学习是独立而治之，区别是考虑决策节点的时候是否受过去决策历史的影响。</p>
<p>分类规则也可以直接从决策树获得。从一个叶子节点开始沿着树枝回到树根，就获得一系列的决策，这些决策可以组合成一个单一的规则。</p>
<p>当训练模型事，如果制定rules=TRUE,C5.0函数就利用分类规则生成模型了。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[R数据结构]]></title>
      <url>/2017/02/08/R%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84/</url>
      <content type="html"><![CDATA[<p>类型<br>=</p>
<ul>
<li>NULL表示没有任何值</li>
<li>NA 表示缺失值</li>
</ul>
<p>因子<br>=<br>用类别值来代表特征的属性成为<strong>名义属性</strong>。尽管可以用字符型向量存储名义属性，但是R提供了因子的专用数据结构。</p>
<p>一个是省空间、另外一些机器学习算法是用特别的程序来处理分类变量的，把分类变量编码为因子可以确保模型能够合理地处理这类数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt; gender &lt;- factor(c(&quot;MALE&quot;, &quot;FAMALE&quot;,&quot;FAMALE&quot;))</div><div class="line">&gt; gender</div><div class="line">[1] MALE   FAMALE FAMALE</div><div class="line">Levels: FAMALE MALE</div><div class="line">&gt; blood &lt;- factor(c(&quot;A&quot;, &quot;B&quot;), levels = c(&quot;A&quot;, &quot;B&quot;, &quot;O&quot;))</div><div class="line">&gt; blood</div><div class="line">[1] A B</div><div class="line">Levels: A B O</div></pre></td></tr></table></figure>
<p>levels是说这个字段可能会有多少值</p>
<p>集合<br>=<br>向量必须是同样类型的元素，而列表可以包含不同类型的元素，还可以指定元素的key。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&gt; obj &lt;- list(name=&quot;will&quot;, age=21, job=&quot;coder&quot;)</div><div class="line">&gt; obj</div><div class="line">$name</div><div class="line">[1] &quot;will&quot;</div><div class="line"></div><div class="line">$age</div><div class="line">[1] 21</div><div class="line"></div><div class="line">$job</div><div class="line">[1] &quot;coder&quot;</div><div class="line"></div><div class="line">&gt; obj$age</div><div class="line">[1] 21</div><div class="line">&gt; obj[2]</div><div class="line">$age</div><div class="line">[1] 21</div><div class="line"></div><div class="line">&gt; obj[c(&quot;name&quot;, &quot;age&quot;)]</div><div class="line">$name</div><div class="line">[1] &quot;will&quot;</div><div class="line"></div><div class="line">$age</div><div class="line">[1] 21</div></pre></td></tr></table></figure></p>
<p>DataFrame可以看作是带有每列含义的matrix矩阵。</p>
<p>文件操作<br>=<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&gt; p_data &lt;- read.csv(&quot;D:/qdsj-20170204094000&quot;)</div><div class="line">&gt; typeof(p_data)</div><div class="line">[1] &quot;list&quot;</div><div class="line">&gt; p_data$用户id[1]</div><div class="line">[1] 0f1d4b839353400998b7b289f895e369</div><div class="line">67788 Levels: 000188cb8d044291bd9984b8e04a224a ... ffff69f594cf48eb8867e8edcdb21e87</div></pre></td></tr></table></figure></p>
<p>可以看到有67788个level，也就是说这是已经把用户id这个字段自动因子化了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; p_data &lt;- read.csv(&quot;D:/qdsj-20170204094000&quot;, stringsAsFactors = FALSE)</div><div class="line">&gt; p_data$用户id[1]</div><div class="line">[1] &quot;0f1d4b839353400998b7b289f895e369&quot;</div><div class="line">&gt; typeof(p_data)</div><div class="line">[1] &quot;list&quot;</div></pre></td></tr></table></figure>
<p>探索数据结构<br>=</p>
<p>进行可读化输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&gt; str(p_data)</div><div class="line">&apos;data.frame&apos;:	67788 obs. of  13 variables:</div><div class="line"> $ 用户id      : chr  &quot;0f1d4b839353400998b7b289f895e369&quot; &quot;d57eb5a615004c00af1476471577bcf8&quot; &quot;8ffd3d4e84db4cad841d0ed8c31e0fb5&quot; &quot;49cdd310f2854af09ccfde82e3ea4e06&quot; ...</div><div class="line"> $ 用户渠道    : chr  &quot;laiqiang_cpa_01&quot; &quot;laiqiang_cpa_01&quot; &quot;laiqiang_cpa_01&quot; &quot;laiqiang_cpa_01&quot; ...</div><div class="line"> $ 用户手机号  : chr  &quot;186****5084&quot; &quot;134****3636&quot; &quot;188****2253&quot; &quot;134****3632&quot; ...</div><div class="line"> $ 用户姓名    : chr  &quot;马先生&quot; &quot;张先生&quot; &quot;&quot; &quot;&quot; ...</div><div class="line"> $ 注册时间    : chr  &quot;2016-10-19 17:46:28&quot; &quot;2016-10-20 16:07:05&quot; &quot;2016-10-20 16:08:37&quot; &quot;2016-10-20 19:21:22&quot; ...</div><div class="line"> $ 开户时间    : chr  &quot;2016-10-19 17:51:24&quot; &quot;2016-10-20 16:09:13&quot; &quot;null&quot; &quot;null&quot; ...</div><div class="line"> $ 首投时间    : chr  &quot;2016-10-19 17:51:54&quot; &quot;2016-10-20 16:29:34&quot; &quot;null&quot; &quot;null&quot; ...</div><div class="line"> $ 首投金额    : num  1000 1000 0 0 1000 1000 1000 0 1000 1000 ...</div><div class="line"> $ 二投时间    : chr  &quot;null&quot; &quot;null&quot; &quot;null&quot; &quot;null&quot; ...</div><div class="line"> $ 二投金额    : num  0 0 0 0 1208 ...</div><div class="line"> $ 首投定期时间: chr  &quot;2016-10-19 17:52:38&quot; &quot;2016-10-20 16:30:27&quot; &quot;null&quot; &quot;null&quot; ...</div><div class="line"> $ 首投定期金额: num  1000 1000 0 0 0 1000 1000 0 1000 1000 ...</div><div class="line"> $ 凌晨前存量  : chr  &quot;\\N&quot; &quot;\\N&quot; &quot;\\N&quot; &quot;\\N&quot; ...</div></pre></td></tr></table></figure></p>
<p>探索数值型变量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt; summary(p_data$首投金额)</div><div class="line">   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </div><div class="line">    0.0     0.0     0.0   128.1     0.0 50000.0</div></pre></td></tr></table></figure></p>
<p>可以找到DataFrame中这列的数值属性：最小值、第一四分位数、中位数、平均数、第三四分位数、最大值。</p>
<p>也可以同时看两列的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt; summary(p_data[c(&quot;首投金额&quot;, &quot;二投金额&quot;)])</div><div class="line">    首投金额          二投金额       </div><div class="line"> Min.   :    0.0   Min.   :     0.0  </div><div class="line"> 1st Qu.:    0.0   1st Qu.:     0.0  </div><div class="line"> Median :    0.0   Median :     0.0  </div><div class="line"> Mean   :  128.1   Mean   :   228.7  </div><div class="line"> 3rd Qu.:    0.0   3rd Qu.:     0.0  </div><div class="line"> Max.   :50000.0   Max.   :200000.0</div></pre></td></tr></table></figure></p>
<table>
<thead>
<tr>
<th>示例</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>range(p_data$首投金额)</td>
<td>返回最小值和最大值</td>
</tr>
<tr>
<td>diff(a, b)</td>
<td>a和b的差值</td>
</tr>
<tr>
<td>IQR(p_data$首投金额)</td>
<td>四分位数中，中间的50%的差值（第三四分位数减去第一四分位数）</td>
</tr>
<tr>
<td>quantile(p_data$首投金额)</td>
<td>返回四分位的五个位置上的数。 还可以通过probs指定获取百分位数中任意位置的数</td>
</tr>
<tr>
<td>boxplot(p_data$首投金额, main=”sss”, ylab=”Money($)”)</td>
<td>将首投金额以箱图的形式绘图展示，名字是sss</td>
</tr>
<tr>
<td>hist(p_data$首投定期金额, main=”首投定期金额”, xlab= “Money($”)</td>
<td>直方图</td>
</tr>
<tr>
<td>var(p_data$首投金额)</td>
<td>方差</td>
</tr>
<tr>
<td>sd(p_data$首投金额)</td>
<td>标准差</td>
</tr>
<tr>
<td>table(p_data$首投金额)</td>
<td>以表的形式输出数据分布情况，每种值的个数</td>
</tr>
<tr>
<td>prop.table(table(p_data$首投金额))</td>
<td>以表的形式输出数据分布情况，每种值占总数的比例</td>
</tr>
<tr>
<td>plot(x=p_data$首投金额, y =p_data$二投金额, main=”变量关系”, xlab=”手头”, ylab=”二头”)</td>
<td>使用散点图展示两种特征值之间的关系， y是因变量，x是自变量</td>
</tr>
<tr>
<td>CrossTable(x=userdcars$model, y= userdcars$conservative)</td>
<td>使用双向交叉表检验变量之间的关系</td>
</tr>
</tbody>
</table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line">&gt; max(p_data$首投金额)</div><div class="line">[1] 50000</div><div class="line">&gt; min(p_data$首投金额)</div><div class="line">[1] 0</div><div class="line">&gt; IQR(p_data$首投金额)</div><div class="line">[1] 0</div><div class="line">&gt; range(p_data$首投金额)</div><div class="line">[1]     0 50000</div><div class="line">&gt; diff(range(p_data$首投金额))</div><div class="line">[1] 50000</div><div class="line">&gt; quantile(p_data$首投金额)</div><div class="line">   0%   25%   50%   75%  100% </div><div class="line">    0     0     0     0 50000 </div><div class="line">&gt; quantile(p_data$首投金额, probs = c (0.25, 0.5, 0.75, 0.97, 0.99))</div><div class="line"> 25%  50%  75%  97%  99% </div><div class="line">   0    0    0 1000 3000</div><div class="line">&gt; quantile(p_data$首投金额, probs = c (0.25, 0.5, 0.75, 0.97, 0.9999))</div><div class="line">25%     50%     75%     97%  99.99% </div><div class="line">0.0     0.0     0.0  1000.0 26106.5 </div><div class="line">&gt; quantile(p_data$首投金额, seq(from=0, to=1, by=0.1))</div><div class="line">   0%   10%   20%   30%   40%   50%   60%   70%   80%   90%  100% </div><div class="line">    0     0     0     0     0     0     0     0     0   100 50000 </div><div class="line">&gt; table(p_data$首投金额)</div><div class="line"></div><div class="line">      0     100     101  105.58     110     112     120     150     168     170 </div><div class="line">  60435    1282       3       1       2       1       1       1       1       1 </div><div class="line">&gt; prop.table(table(p_data$首投金额))</div><div class="line"></div><div class="line">           0          100          101       105.58          110          112 </div><div class="line">8.915295e-01 1.891190e-02 4.425562e-05 1.475187e-05 2.950375e-05 1.475187e-05</div><div class="line"></div><div class="line">&gt; usedcars$conservative &lt;-</div><div class="line">+   usedcars$color %in% c(&quot;Black&quot;, &quot;Gray&quot;, &quot;Silver&quot;, &quot;White&quot;)</div><div class="line">&gt; table(usedcars$conservative)</div><div class="line"></div><div class="line">FALSE  TRUE </div><div class="line">   51    99 </div><div class="line">&gt; CrossTable(x = usedcars$model, y = usedcars$conservative)</div><div class="line"></div><div class="line"> </div><div class="line">   Cell Contents</div><div class="line">|-------------------------|</div><div class="line">|                       N |</div><div class="line">| Chi-square contribution |</div><div class="line">|           N / Row Total |</div><div class="line">|           N / Col Total |</div><div class="line">|         N / Table Total |</div><div class="line">|-------------------------|</div><div class="line"></div><div class="line"> </div><div class="line">Total Observations in Table:  150 </div><div class="line"></div><div class="line"> </div><div class="line">               | usedcars$conservative </div><div class="line">usedcars$model |     FALSE |      TRUE | Row Total | </div><div class="line">---------------|-----------|-----------|-----------|</div><div class="line">            SE |        27 |        51 |        78 | </div><div class="line">               |     0.009 |     0.004 |           | </div><div class="line">               |     0.346 |     0.654 |     0.520 | </div><div class="line">               |     0.529 |     0.515 |           | </div><div class="line">               |     0.180 |     0.340 |           | </div><div class="line">---------------|-----------|-----------|-----------|</div><div class="line">           SEL |         7 |        16 |        23 | </div><div class="line">               |     0.086 |     0.044 |           | </div><div class="line">               |     0.304 |     0.696 |     0.153 | </div><div class="line">               |     0.137 |     0.162 |           | </div><div class="line">               |     0.047 |     0.107 |           | </div><div class="line">---------------|-----------|-----------|-----------|</div><div class="line">           SES |        17 |        32 |        49 | </div><div class="line">               |     0.007 |     0.004 |           | </div><div class="line">               |     0.347 |     0.653 |     0.327 | </div><div class="line">               |     0.333 |     0.323 |           | </div><div class="line">               |     0.113 |     0.213 |           | </div><div class="line">---------------|-----------|-----------|-----------|</div><div class="line">  Column Total |        51 |        99 |       150 | </div><div class="line">               |     0.340 |     0.660 |           | </div><div class="line">---------------|-----------|-----------|-----------|</div></pre></td></tr></table></figure>
<p>根据每个人所属年级，添加对应的平均年龄</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[R安装工具]]></title>
      <url>/2017/02/08/R%E5%AE%89%E8%A3%85%E5%B7%A5%E5%85%B7/</url>
      <content type="html"><![CDATA[<p>安装R的packages的时候官方提供了两种方式：</p>
<ul>
<li>交互式REPL里执行install.packages()</li>
<li>命令行执行R CMD INSTALL XXX.tar.gz</li>
</ul>
<p>由于是要初始化docker的R运行环境，如果要安装多个package，这两种方法都不太方便。</p>
<p>找到一个不错的工具R-littler, 安装完成后，可以通过执行自己定义的脚本进行R环境甚至程序的执行。</p>
<p>下面是实际使用的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env r</div><div class="line"></div><div class="line">repos &lt;- &quot;http://mirrors.tuna.tsinghua.edu.cn/CRAN/&quot;</div><div class="line"></div><div class="line">lib.loc &lt;- &quot;/usr/lib64/R/library&quot;</div><div class="line"></div><div class="line">install.packages(&quot;data.table&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;rJava&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;dplyr&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;bit64&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;stringr&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;ggplot2&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;RODBC&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;RJDBC&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;timeSeries&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;fUnitRoots&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;forecast&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;sqldf&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;lubridate&quot;, lib.loc, repos)</div></pre></td></tr></table></figure>
<p>把以上文件命名为install.r，赋予可执行权限即可。</p>
<p>这只是给准备环境而已，其实也可以尝试直接写自己的业务逻辑的。</p>
<p>参考：</p>
<ul>
<li><a href="http://dirk.eddelbuettel.com/code/littler.examples.html" target="_blank" rel="external">http://dirk.eddelbuettel.com/code/littler.examples.html</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[git-同时push到两个远程仓库]]></title>
      <url>/2017/02/08/git-%E5%90%8C%E6%97%B6push%E5%88%B0%E4%B8%A4%E4%B8%AA%E8%BF%9C%E7%A8%8B%E4%BB%93%E5%BA%93/</url>
      <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@will-vm:~/gitLearning/dobuleremote# git remote -v</div><div class="line">origin	git@github.com:WillCup/dobuleremote.git (fetch)</div><div class="line">origin	git@github.com:WillCup/dobuleremote.git (push)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git remote add ink git@10.1.5.83:/server/gitrepo/dpush.git</div></pre></td></tr></table></figure>
<p>之后就可以看到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">root@will-vm:~/gitLearning/dobuleremote# git remote -v</div><div class="line">ink	git@10.1.5.83:/server/gitrepo/dpush.git (fetch)</div><div class="line">ink	git@10.1.5.83:/server/gitrepo/dpush.git (push)</div><div class="line">origin	git@github.com:WillCup/dobuleremote.git (fetch)</div><div class="line">origin	git@github.com:WillCup/dobuleremote.git (push)</div></pre></td></tr></table></figure></p>
<p>可以通过push ink推送到新的远程仓库。</p>
<p>但是执行git status的时候发现，他是以origin为准的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">root@will-vm:~/gitLearning/dobuleremote# git st</div><div class="line">位于分支 master</div><div class="line">您的分支与上游分支 &apos;origin/master&apos; 一致。</div><div class="line">未跟踪的文件:</div><div class="line">  （使用 &quot;git add &lt;文件&gt;...&quot; 以包含要提交的内容）</div><div class="line"></div><div class="line">	both1</div><div class="line"></div><div class="line">提交为空，但是存在尚未跟踪的文件（使用 &quot;git add&quot; 建立跟踪）</div></pre></td></tr></table></figure></p>
<p>新建一个both文件，然后不加参数提交：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">root@will-vm:~/gitLearning/dobuleremote# ll</div><div class="line">总用量 12</div><div class="line">drwxr-xr-x  3 root root 4096 2月   8 14:17 ./</div><div class="line">drwxr-xr-x 29 root root 4096 2月   8 14:21 ../</div><div class="line">-rw-r--r--  1 root root    0 2月   8 14:17 both1</div><div class="line">drwxr-xr-x  8 root root 4096 2月   8 14:20 .git/</div><div class="line">-rw-r--r--  1 root root    0 2月   8 14:05 githubside</div><div class="line">-rw-r--r--  1 root root    0 2月   8 14:06 githubside2</div><div class="line"></div><div class="line">root@will-vm:~/gitLearning/dobuleremote# git push</div><div class="line">warning: push.default 尚未设置，它的默认值在 Git 2.0 已从 &apos;matching&apos;</div><div class="line">变更为 &apos;simple&apos;。若要不再显示本信息并保持传统习惯，进行如下设置：</div><div class="line"></div><div class="line">  git config --global push.default matching</div><div class="line"></div><div class="line">若要不再显示本信息并从现在开始采用新的使用习惯，设置：</div><div class="line"></div><div class="line">  git config --global push.default simple</div><div class="line"></div><div class="line">当 push.default 设置为 &apos;matching&apos; 后，git 将推送和远程同名的所有</div><div class="line">本地分支。</div><div class="line"></div><div class="line">从 Git 2.0 开始，Git 默认采用更为保守的 &apos;simple&apos; 模式，只推送当前</div><div class="line">分支到远程关联的同名分支，即 &apos;git push&apos; 推送当前分支。</div><div class="line"></div><div class="line">参见 &apos;git help config&apos; 并查找 &apos;push.default&apos; 以获取更多信息。</div><div class="line">（&apos;simple&apos; 模式由 Git 1.7.11 版本引入。如果您有时要使用老版本的 Git，</div><div class="line">为保持兼容，请用 &apos;current&apos; 代替 &apos;simple&apos;）</div><div class="line"></div><div class="line">对象计数中: 2, 完成.</div><div class="line">Delta compression using up to 2 threads.</div><div class="line">压缩对象中: 100% (2/2), 完成.</div><div class="line">写入对象中: 100% (2/2), 231 bytes | 0 bytes/s, 完成.</div><div class="line">Total 2 (delta 1), reused 0 (delta 0)</div><div class="line">remote: Resolving deltas: 100% (1/1), completed with 1 local objects.</div><div class="line">To git@github.com:WillCup/dobuleremote.git</div><div class="line">   2ba4199..8697e51  master -&gt; master</div></pre></td></tr></table></figure></p>
<p>可以看到是推送到了github端。到dpush那边也查看了一下，最新版本并没有出现这个文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">root@will-vm:~/gitLearning/dpush# ll</div><div class="line">总用量 12</div><div class="line">drwxr-xr-x  3 root root 4096 2月   8 14:21 ./</div><div class="line">drwxr-xr-x 29 root root 4096 2月   8 14:21 ../</div><div class="line">drwxr-xr-x  8 root root 4096 2月   8 14:21 .git/</div><div class="line">-rw-r--r--  1 root root    0 2月   8 14:21 githubside</div><div class="line">-rw-r--r--  1 root root    0 2月   8 14:21 githubside2</div></pre></td></tr></table></figure></p>
<p>其实也可以只为某个remote添加push，而并不添加pull：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">root@will-vm:~/gitLearning/dobuleremote# git remote set-url --add --push ink git@github.com:WillCup/dobuleremote.git</div><div class="line">root@will-vm:~/gitLearning/dobuleremote# git remote -v</div><div class="line">ink	git@10.1.5.83:/server/gitrepo/dpush.git (fetch)</div><div class="line">ink	git@github.com:WillCup/dobuleremote.git (push)</div><div class="line">origin	git@github.com:WillCup/dobuleremote.git (fetch)</div><div class="line">origin	git@github.com:WillCup/dobuleremote.git (push)</div><div class="line">root@will-vm:~/gitLearning/dobuleremote# git --version</div><div class="line">git version 2.7.4</div><div class="line">root@will-vm:~/gitLearning/dobuleremote# git remote set-url --add --push ink git@10.1.5.83:/server/gitrepo/dpush.git</div><div class="line">root@will-vm:~/gitLearning/dobuleremote# git remote -v</div><div class="line">ink	git@10.1.5.83:/server/gitrepo/dpush.git (fetch)</div><div class="line">ink	git@github.com:WillCup/dobuleremote.git (push)</div><div class="line">ink	git@10.1.5.83:/server/gitrepo/dpush.git (push)</div><div class="line">origin	git@github.com:WillCup/dobuleremote.git (fetch)</div><div class="line">origin	git@github.com:WillCup/dobuleremote.git (push)</div></pre></td></tr></table></figure></p>
<p>再添加一个文件both2，然后再push测试一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">root@will-vm:~/gitLearning/dobuleremote# touch both2</div><div class="line">root@will-vm:~/gitLearning/dobuleremote# git st</div><div class="line">位于分支 master</div><div class="line">您的分支与上游分支 &apos;origin/master&apos; 一致。</div><div class="line">未跟踪的文件:</div><div class="line">  （使用 &quot;git add &lt;文件&gt;...&quot; 以包含要提交的内容）</div><div class="line"></div><div class="line">	both2</div><div class="line"></div><div class="line">提交为空，但是存在尚未跟踪的文件（使用 &quot;git add&quot; 建立跟踪）</div><div class="line">root@will-vm:~/gitLearning/dobuleremote# git add .</div><div class="line">root@will-vm:~/gitLearning/dobuleremote# git ci -am &quot;both test 2&quot;</div><div class="line">[master 40cdebb] both test 2</div><div class="line"> 1 file changed, 0 insertions(+), 0 deletions(-)</div><div class="line"> create mode 100644 both2</div><div class="line">root@will-vm:~/gitLearning/dobuleremote# git push ink master</div><div class="line">对象计数中: 2, 完成.</div><div class="line">Delta compression using up to 2 threads.</div><div class="line">压缩对象中: 100% (2/2), 完成.</div><div class="line">写入对象中: 100% (2/2), 223 bytes | 0 bytes/s, 完成.</div><div class="line">Total 2 (delta 1), reused 0 (delta 0)</div><div class="line">remote: Resolving deltas: 100% (1/1), completed with 1 local objects.</div><div class="line">To git@github.com:WillCup/dobuleremote.git</div><div class="line">   8697e51..40cdebb  master -&gt; master</div><div class="line">对象计数中: 4, 完成.</div><div class="line">Delta compression using up to 2 threads.</div><div class="line">压缩对象中: 100% (4/4), 完成.</div><div class="line">写入对象中: 100% (4/4), 414 bytes | 0 bytes/s, 完成.</div><div class="line">Total 4 (delta 1), reused 0 (delta 0)</div><div class="line">To git@10.1.5.83:/server/gitrepo/dpush.git</div><div class="line">   2ba4199..40cdebb  master -&gt; master</div></pre></td></tr></table></figure></p>
<p>从上面的输出就可以看到，是push到了两个remote端，刚才落下的提交也一并被push过去了。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ETL平台生产计划]]></title>
      <url>/2017/01/20/ETL%E5%B9%B3%E5%8F%B0%E7%94%9F%E4%BA%A7%E8%AE%A1%E5%88%92/</url>
      <content type="html"><![CDATA[<table>
<thead>
<tr>
<th>模块</th>
<th>功能简介</th>
<th>功效</th>
<th>备注</th>
<th>进度</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据导出</td>
<td>分批定时</td>
<td>易于操作，一个调度时间，多个任务。减少人员修改数据调度的时间【当需要批量修改的时候】</td>
<td>调度的时候不再提供任务参数配置，只能在任务里这一个地方配置</td>
</tr>
<tr>
<td><del>任务恢复</del></td>
<td>任务执行中失败，修复后，原地爬起</td>
<td>避免重复执行前面已经成功的调度，提高资源使用价值，减少数据恢复需要的时间</td>
<td>方案：抽取azkaban的今日调度最新一次executions，找到失败的job，恢复执行。【看了一下azkaban的mysql数据结构，很难支持】   <br> <strong>最后方案</strong>：通过生成指定几个etl，重新生成其子节点的调度任务</td>
<td>完成</td>
</tr>
<tr>
<td>调度审核</td>
<td>所有需要上线的调度，都需专人review</td>
<td>保证线上集群的稳定运行，将风险降到最低</td>
</tr>
<tr>
<td>数据导出依赖感知</td>
<td>数据导出对平日ETL调度的依赖感知</td>
<td>对每日调度产生强依赖，不空跑</td>
<td>细粒度感知： 血统父表完成 <br> 粗粒度感知：调度完成</td>
</tr>
<tr>
<td>指定重新执行的脉路</td>
<td>生成指定ETL的所有子节点的调度</td>
<td>由于单个节点数据问题，导致所有子节点都要重跑的时候，一键完成</td>
<td>可以与上面的任务回复同效</td>
<td>完成</td>
</tr>
<tr>
<td>生成二代ETL模型</td>
<td>抽象出一个有依赖、有自己引擎的ETL模型，m2h/h2h/h2m/spark等都与这个东西关联，生成DAG的时候按照这个东西去生成</td>
<td>解决多重任务之间的依赖调度问题</td>
<td>可以作为2.0计划，改动稍大</td>
</tr>
<tr>
<td>HDFS概览</td>
<td>记录指定文件夹每天的数据量变化</td>
<td>各个业务线可以方便的看到自己数据库甚至表的大小变化情况</td>
<td>优先级别并不高，主要是为了提前预知一些突飞猛涨的数据目录，采取限制或者扩展的措施</td>
<td></td>
</tr>
<tr>
<td>非正常操作报警</td>
<td>出现数据调度变更，或者ETL对象变更的时候， 如果发起人并不是前一个发起人的话，就发送邮件或者短信通知，告诉前一个发起人，有人修改了你负责的东西</td>
<td>跨部门或者同部门人员出现误操作后，可追溯到责任人</td>
<td>调度可以通过在WillDependencyTask里添加完成，ETL对象可以在通用被继承的对象里完成。最简单可以通过log实现，但是不具备及时性，而且log是会定时清理的</td>
</tr>
<tr>
<td>YARN界面开放</td>
<td>开发给业务端开发人员查看，但是需要登陆权限验证，还有就是需要替换掉一些后端的url为代理的url，尽量让业务端少知晓后面的任何事情</td>
<td>辅助业务端人员调试</td>
<td>这个跟上一个功能一样，是个辅助功能, 可以共同放在一个辅助模块中</td>
<td></td>
</tr>
</tbody>
</table>
<p>docker化的nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -d -p 80:80 -p 7070:7070 -p 8088:8088 -p 7000:7000 -p 9000:9000 -p 9090:9090 --name willnginx -v /server/wil/willnginx/conf.d:/etc/nginx/conf.d nginx:1.10</div></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[R语言简记]]></title>
      <url>/2017/01/18/R%E8%AF%AD%E8%A8%80%E7%AE%80%E8%AE%B0/</url>
      <content type="html"><![CDATA[<p>为新生成的data.frame指定列名：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">colnames(df) &lt;- c(&quot;a&quot;,&quot;b&quot;)</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">## 聚合one ~ one, one ~ many, many ~ one, and many ~ many:</div><div class="line">aggregate(weight ~ feed, data = chickwts, mean)</div><div class="line">aggregate(breaks ~ wool + tension, data = warpbreaks, mean)</div><div class="line">aggregate(cbind(Ozone, Temp) ~ Month, data = airquality, mean)</div><div class="line">aggregate(cbind(ncases, ncontrols) ~ alcgp + tobgp, data = esoph, sum)</div></pre></td></tr></table></figure>
<p>set.seed<br>=<br>set.seed()是为了设置一个随机数的种子，当想产生同样的一组随机数字的时候，就设置一下。这在统计分析中是经常用到的。</p>
<p>dim<br>=<br>dim()返回一个data.table的行、列数量。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&gt; x &lt;- 1:12 ; dim(x) &lt;- c(3,4)</div><div class="line">&gt; x</div><div class="line">     [,1] [,2] [,3] [,4]</div><div class="line">[1,]    1    4    7   10</div><div class="line">[2,]    2    5    8   11</div><div class="line">[3,]    3    6    9   12</div><div class="line">&gt; dim(x)[1]</div><div class="line">[1] 3</div><div class="line">&gt; dim(x)[2]</div><div class="line">[1] 4</div></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[使用harbor安装docker-registry]]></title>
      <url>/2017/01/17/%E4%BD%BF%E7%94%A8harbor%E5%AE%89%E8%A3%85docker-registry/</url>
      <content type="html"><![CDATA[<h2 id="1-安装docker和docker-compose"><a href="#1-安装docker和docker-compose" class="headerlink" title="1. 安装docker和docker compose"></a>1. 安装docker和docker compose</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">sudo curl -sSL https://get.docker.com/ | sh</div><div class="line"># 设置Docker以非Root用户运行，确保安全。</div><div class="line">sudo usermod -aG docker your-user</div><div class="line"># 安装Compose：</div><div class="line">curl -L https://github.com/docker/compose/releases/download/1.7.0-rc1/docker-compose-`uname -s`-`uname -m` &gt; /usr/local/bin/docker-compose</div><div class="line">chmod +x /usr/local/bin/docker-compose</div></pre></td></tr></table></figure>
<ol>
<li>获取SSL证书[可选]</li>
</ol>
<p>如果使用域名绑定私有仓库，就必须开启SSL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/letsencrypt/letsencrypt</div><div class="line">cd letsencrypt</div><div class="line">./letsencrypt-auto certonly -d docker.will.me</div></pre></td></tr></table></figure>
<ol>
<li>安装harbor</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wget https://github.com/vmware/harbor/releases/download/0.5.0/harbor-offline-installer-0.5.0.tgz</div><div class="line">tar zxvf harbor-offline-installer-0.5.0.tgz</div></pre></td></tr></table></figure>
<p>修改一下harbor.cfg里的hostname<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hostname = 10.1.5.129</div></pre></td></tr></table></figure></p>
<p>其他的都没敢改，因为安装文档也没有特别深入的说明，暂时跑个demo而已，不要太拼。</p>
<p>但是目前有疑问的有两点：</p>
<blockquote>
<ol>
<li>mysql的连接没有指定，只有一个db_password, 那元数据存在哪？</li>
<li>没有指定docker image的数据文件存储位置，理论上这会是一个比较大的数据量</li>
</ol>
</blockquote>
<p>带着疑问，先开始安装：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">[root@controller harbor]# ./install.sh </div><div class="line"></div><div class="line">[Step 0]: checking installation environment ...</div><div class="line"></div><div class="line">Note: docker version: 1.12.6</div><div class="line"></div><div class="line">Note: docker-compose version: 1.7.0</div><div class="line"></div><div class="line">[Step 1]: loading Harbor images ...</div><div class="line">dd60b611baaa: Loading layer [==================================================&gt;] 133.2 MB/133.2 MB</div><div class="line">e541edf73dfb: Loading layer [==================================================&gt;] 3.072 kB/3.072 kB</div><div class="line">Loaded image: vmware/harbor-log:0.5.0&gt;                                          ]    512 B/3.072 kB</div><div class="line">f96222d75c55: Loading layer [==================================================&gt;] 128.9 MB/128.9 MB</div><div class="line">5a3deeae1518: Loading layer [==================================================&gt;] 4.608 kB/4.608 kB</div><div class="line">Loaded image: vmware/harbor-db:0.5.0                                            ]    512 B/4.608 kB</div><div class="line">7b612c5c8104: Loading layer [==================================================&gt;] 1.536 kB/1.536 kB</div><div class="line">5c07a2fe7c73: Loading layer [==================================================&gt;] 20.94 MB/20.94 MB</div><div class="line">Loaded image: vmware/harbor-jobservice:0.5.0                                    ] 229.4 kB/20.94 MB</div><div class="line">fe4c16cbf7a4: Loading layer [==================================================&gt;] 128.9 MB/128.9 MB</div><div class="line">c4a8b7411af4: Loading layer [==================================================&gt;] 60.57 MB/60.57 MB</div><div class="line">3f117c44afbb: Loading layer [==================================================&gt;] 3.584 kB/3.584 kB</div><div class="line">Loaded image: nginx:1.11.5r [=======&gt;                                           ]    512 B/3.584 kB</div><div class="line">4fe15f8d0ae6: Loading layer [==================================================&gt;] 5.046 MB/5.046 MB</div><div class="line">3bb5bc5ad373: Loading layer [==================================================&gt;] 2.048 kB/2.048 kB</div><div class="line">Loaded image: registry:2.5.0[============&gt;                                      ]    512 B/2.048 kB</div><div class="line">Loaded image: photon:1.0</div><div class="line">41be4a382617: Loading layer [==================================================&gt;] 58.31 MB/58.31 MB</div><div class="line">32ec73a38f19: Loading layer [==================================================&gt;] 23.62 MB/23.62 MB</div><div class="line">Loaded image: vmware/harbor-ui:0.5.0                                            ] 262.1 kB/23.62 MB</div><div class="line"></div><div class="line"></div><div class="line">[Step 2]: preparing environment ...</div><div class="line">generated and saved secret key</div><div class="line">Generated configuration file: ./common/config/nginx/nginx.conf</div><div class="line">Generated configuration file: ./common/config/ui/env</div><div class="line">Generated configuration file: ./common/config/ui/app.conf</div><div class="line">Generated configuration file: ./common/config/registry/config.yml</div><div class="line">Generated configuration file: ./common/config/db/env</div><div class="line">Generated configuration file: ./common/config/jobservice/env</div><div class="line">Generated configuration file: ./common/config/jobservice/app.conf</div><div class="line">Generated configuration file: ./common/config/ui/private_key.pem</div><div class="line">Generated configuration file: ./common/config/registry/root.crt</div><div class="line">The configuration files are ready, please use docker-compose to start the service.</div><div class="line"></div><div class="line"></div><div class="line">[Step 3]: checking existing instance of Harbor ...</div><div class="line"></div><div class="line"></div><div class="line">[Step 4]: starting Harbor ...</div><div class="line">Creating network &quot;harbor_default&quot; with the default driver</div><div class="line">Creating harbor-log</div><div class="line">Creating registry</div><div class="line">Creating harbor-db</div><div class="line">Creating harbor-ui</div><div class="line">Creating harbor-jobservice</div><div class="line">Creating nginx</div><div class="line"></div><div class="line">✔ ----Harbor has been installed and started successfully.----</div><div class="line"></div><div class="line">Now you should be able to visit the admin portal at http://10.1.5.129. </div><div class="line">For more details, please visit https://github.com/vmware/harbor .</div></pre></td></tr></table></figure></p>
<p>可以看到这是安装了一系列的docker iamge啊，难怪有离线和在线之分了。</p>
<p>闲着没事儿，看一下install.sh都干了啥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"># 检查docker和docker-compose是不是符合版本要求</div><div class="line">check_docker</div><div class="line">check_dockercompose</div><div class="line"></div><div class="line"># load harbor的压缩包到当前docker的images库里</div><div class="line">if [ -f harbor*.tgz ]</div><div class="line">then</div><div class="line">        h2 &quot;[Step $item]: loading Harbor images ...&quot;; let item+=1</div><div class="line">        docker load -i ./harbor*.tgz</div><div class="line">fi</div><div class="line">echo &quot;&quot;</div><div class="line"></div><div class="line"># prepare就是读取harbor.cfg配置文件，准备环境变量</div><div class="line">h2 &quot;[Step $item]: preparing environment ...&quot;;  let item+=1</div><div class="line">if [ -n &quot;$host&quot; ]</div><div class="line">then</div><div class="line">        sed &quot;s/^hostname = .*/hostname = $host/g&quot; -i ./harbor.cfg</div><div class="line">fi</div><div class="line">./prepare</div><div class="line"></div><div class="line"># 查看有没有正在运行的harbor实例，有的话就停掉</div><div class="line">h2 &quot;[Step $item]: checking existing instance of Harbor ...&quot;; let item+=1</div><div class="line">if [ -n &quot;$(docker-compose -f docker-compose*.yml ps -q)&quot;  ]</div><div class="line">then</div><div class="line">        note &quot;stopping existing Harbor instance ...&quot;</div><div class="line">        docker-compose -f docker-compose*.yml down</div><div class="line">fi</div><div class="line">echo &quot;&quot;</div><div class="line"></div><div class="line"># 启动新的harbor实例</div><div class="line">h2 &quot;[Step $item]: starting Harbor ...&quot;</div><div class="line">docker-compose -f docker-compose*.yml up -d</div></pre></td></tr></table></figure></p>
<p>以上是主要步骤，其他的全都是不重要的。</p>
<p>查看一下当前的docker进程：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@controller harbor]# docker ps</div><div class="line">CONTAINER ID        IMAGE                            COMMAND                  CREATED             STATUS              PORTS                                      NAMES</div><div class="line">b8ed2fce6816        nginx:1.11.5                     &quot;nginx -g &apos;daemon off&quot;   5 minutes ago       Up 4 minutes        0.0.0.0:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp   nginx</div><div class="line">8408e2b03a4b        vmware/harbor-jobservice:0.5.0   &quot;/harbor/harbor_jobse&quot;   5 minutes ago       Up 4 minutes                                                   harbor-jobservice</div><div class="line">48b280c1caba        vmware/harbor-ui:0.5.0           &quot;/harbor/harbor_ui&quot;      6 minutes ago       Up 5 minutes                                                   harbor-ui</div><div class="line">0235e55493d0        vmware/harbor-db:0.5.0           &quot;docker-entrypoint.sh&quot;   6 minutes ago       Up 5 minutes        3306/tcp                                   harbor-db</div><div class="line">5bc55096ba78        library/registry:2.5.0           &quot;/entrypoint.sh serve&quot;   6 minutes ago       Up 5 minutes        5000/tcp                                   registry</div><div class="line">805f744b40ae        vmware/harbor-log:0.5.0          &quot;/bin/sh -c &apos;crond &amp;&amp;&quot;   6 minutes ago       Up 6 minutes        0.0.0.0:1514-&gt;514/tcp                      harbor-log</div></pre></td></tr></table></figure></p>
<p>该起来的全起来了，下面看一下harbor-db的参数，把数据弄到哪里去了？</p>
<p>docker inspect 看了一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&quot;Mounts&quot;: [</div><div class="line">            &#123;</div><div class="line">                &quot;Source&quot;: &quot;/data/database&quot;,</div><div class="line">                &quot;Destination&quot;: &quot;/var/lib/mysql&quot;,</div><div class="line">                &quot;Mode&quot;: &quot;rw&quot;,</div><div class="line">                &quot;RW&quot;: true,</div><div class="line">                &quot;Propagation&quot;: &quot;rprivate&quot;</div><div class="line">            &#125;</div><div class="line">        ],</div></pre></td></tr></table></figure></p>
<p>mysql数据放到/data/database了。</p>
<p>再看一下registry的挂载情况：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&quot;Mounts&quot;: [</div><div class="line">            &#123;</div><div class="line">                &quot;Source&quot;: &quot;/data/registry&quot;,</div><div class="line">                &quot;Destination&quot;: &quot;/storage&quot;,</div><div class="line">                &quot;Mode&quot;: &quot;rw&quot;,</div><div class="line">                &quot;RW&quot;: true,</div><div class="line">                &quot;Propagation&quot;: &quot;rprivate&quot;</div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                &quot;Source&quot;: &quot;/server/harbor/common/config/registry&quot;,</div><div class="line">                &quot;Destination&quot;: &quot;/etc/registry&quot;,</div><div class="line">                &quot;Mode&quot;: &quot;rw&quot;,</div><div class="line">                &quot;RW&quot;: true,</div><div class="line">                &quot;Propagation&quot;: &quot;rprivate&quot;</div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                &quot;Name&quot;: &quot;e8aab221ad99604d0f660695895eec3ff425cc0847ac5f0a3a803ab83e70275a&quot;,</div><div class="line">                &quot;Source&quot;: &quot;/var/lib/docker/volumes/e8aab221ad99604d0f660695895eec3ff425cc0847ac5f0a3a803ab83e70275a/_data&quot;,</div><div class="line">                &quot;Destination&quot;: &quot;/var/lib/registry&quot;,</div><div class="line">                &quot;Driver&quot;: &quot;local&quot;,</div><div class="line">                &quot;Mode&quot;: &quot;&quot;,</div><div class="line">                &quot;RW&quot;: true,</div><div class="line">                &quot;Propagation&quot;: &quot;&quot;</div><div class="line">            &#125;</div><div class="line">        ],</div></pre></td></tr></table></figure></p>
<p>此时以上两个目录还都是空的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@controller harbor]# ll /server/harbor/common/config/registry</div><div class="line">total 8</div><div class="line">-rw-r--r-- 1 root root  694 Jan 18 03:05 config.yml</div><div class="line">-rw-r--r-- 1 root root 2151 Jan 18 03:05 root.crt</div><div class="line">[root@controller harbor]# ll /data/database</div><div class="line">total 110608</div><div class="line">-rw-rw---- 1 systemd-bus-proxy ssh_keys       56 Jan 18 03:07 auto.cnf</div><div class="line">-rw-rw---- 1 systemd-bus-proxy ssh_keys 12582912 Jan 18 03:25 ibdata1</div><div class="line">-rw-rw---- 1 systemd-bus-proxy ssh_keys 50331648 Jan 18 03:25 ib_logfile0</div><div class="line">-rw-rw---- 1 systemd-bus-proxy ssh_keys 50331648 Jan 18 03:06 ib_logfile1</div><div class="line">drwx------ 2 systemd-bus-proxy ssh_keys     4096 Jan 18 03:07 mysql</div><div class="line">drwx------ 2 systemd-bus-proxy ssh_keys     4096 Jan 18 03:07 performance_schema</div><div class="line">drwx------ 2 systemd-bus-proxy ssh_keys     4096 Jan 18 03:07 registry</div></pre></td></tr></table></figure></p>
<p>参考：<br><a href="https://github.com/vmware/harbor/blob/master/docs/installation_guide.md" target="_blank" rel="external">https://github.com/vmware/harbor/blob/master/docs/installation_guide.md</a></p>
<h2 id="4-使用"><a href="#4-使用" class="headerlink" title="4. 使用"></a>4. 使用</h2><p>netstat -ntlp 发现80端口被启动了，应该就是它。下面就登陆一下harbor看一下</p>
<p>docker-compose.yml配置文件<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line"><span class="attr">version:</span> <span class="string">'2'</span></div><div class="line"><span class="attr">services:</span></div><div class="line"><span class="attr">  log:</span></div><div class="line"><span class="attr">    image:</span> vmware/harbor-log:<span class="number">0.5</span><span class="number">.0</span></div><div class="line"><span class="attr">    container_name:</span> harbor-log</div><div class="line"><span class="attr">    restart:</span> always</div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">      -</span> /var/log/harbor/:/var/log/docker/</div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="number">1514</span>:<span class="number">514</span></div><div class="line"><span class="attr">  registry:</span></div><div class="line"><span class="attr">    image:</span> library/registry:<span class="number">2.5</span><span class="number">.0</span></div><div class="line"><span class="attr">    container_name:</span> registry</div><div class="line"><span class="attr">    restart:</span> always</div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">      -</span> /data/registry:/storage</div><div class="line"><span class="bullet">      -</span> ./common/config/registry/:/etc/registry/</div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="bullet">      -</span> GODEBUG=netdns=cgo</div><div class="line"><span class="attr">    command:</span></div><div class="line">      [<span class="string">"serve"</span>, <span class="string">"/etc/registry/config.yml"</span>]</div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> log</div><div class="line"><span class="attr">    logging:</span></div><div class="line"><span class="attr">      driver:</span> <span class="string">"syslog"</span></div><div class="line"><span class="attr">      options:</span></div><div class="line"><span class="attr">        syslog-address:</span> <span class="string">"tcp://127.0.0.1:1514"</span></div><div class="line"><span class="attr">        tag:</span> <span class="string">"registry"</span></div><div class="line"><span class="attr">  mysql:</span></div><div class="line"><span class="attr">    image:</span> vmware/harbor-db:<span class="number">0.5</span><span class="number">.0</span></div><div class="line"><span class="attr">    container_name:</span> harbor-db</div><div class="line"><span class="attr">    restart:</span> always</div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">      -</span> /data/database:/var/lib/mysql</div><div class="line"><span class="attr">    env_file:</span></div><div class="line"><span class="bullet">      -</span> ./common/config/db/env</div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> log</div><div class="line"><span class="attr">    logging:</span></div><div class="line"><span class="attr">      driver:</span> <span class="string">"syslog"</span></div><div class="line"><span class="attr">      options:</span></div><div class="line"><span class="attr">        syslog-address:</span> <span class="string">"tcp://127.0.0.1:1514"</span></div><div class="line"><span class="attr">        tag:</span> <span class="string">"mysql"</span></div><div class="line"><span class="attr">  ui:</span></div><div class="line"><span class="attr">    image:</span> vmware/harbor-ui:<span class="number">0.5</span><span class="number">.0</span></div><div class="line"><span class="attr">    container_name:</span> harbor-ui</div><div class="line"><span class="attr">    env_file:</span></div><div class="line"><span class="bullet">      -</span> ./common/config/ui/env</div><div class="line"><span class="attr">    restart:</span> always</div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">      -</span> ./common/config/ui/app.conf:/etc/ui/app.conf</div><div class="line"><span class="bullet">      -</span> ./common/config/ui/private_key.pem:/etc/ui/private_key.pem</div><div class="line"><span class="bullet">      -</span> /data:/harbor_storage</div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> log</div><div class="line"><span class="attr">    logging:</span></div><div class="line"><span class="attr">      driver:</span> <span class="string">"syslog"</span></div><div class="line"><span class="attr">      options:</span></div><div class="line"><span class="attr">        syslog-address:</span> <span class="string">"tcp://127.0.0.1:1514"</span></div><div class="line"><span class="attr">        tag:</span> <span class="string">"ui"</span></div><div class="line"><span class="attr">  jobservice:</span></div><div class="line"><span class="attr">    image:</span> vmware/harbor-jobservice:<span class="number">0.5</span><span class="number">.0</span></div><div class="line"><span class="attr">    container_name:</span> harbor-jobservice</div><div class="line"><span class="attr">    env_file:</span></div><div class="line"><span class="bullet">      -</span> ./common/config/jobservice/env</div><div class="line"><span class="attr">    restart:</span> always</div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">      -</span> /data/job_logs:/var/log/jobs</div><div class="line"><span class="bullet">      -</span> ./common/config/jobservice/app.conf:/etc/jobservice/app.conf</div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> ui</div><div class="line"><span class="attr">    logging:</span></div><div class="line"><span class="attr">      driver:</span> <span class="string">"syslog"</span></div><div class="line"><span class="attr">      options:</span></div><div class="line"><span class="attr">        syslog-address:</span> <span class="string">"tcp://127.0.0.1:1514"</span></div><div class="line"><span class="attr">        tag:</span> <span class="string">"jobservice"</span></div><div class="line"><span class="attr">  proxy:</span></div><div class="line"><span class="attr">    image:</span> nginx:<span class="number">1.11</span><span class="number">.5</span></div><div class="line"><span class="attr">    container_name:</span> nginx</div><div class="line"><span class="attr">    restart:</span> always</div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">      -</span> ./common/config/nginx:/etc/nginx</div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="number">80</span>:<span class="number">80</span></div><div class="line"><span class="bullet">      -</span> <span class="number">443</span>:<span class="number">443</span></div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> mysql</div><div class="line"><span class="bullet">      -</span> registry</div><div class="line"><span class="bullet">      -</span> ui</div><div class="line"><span class="bullet">      -</span> log</div><div class="line"><span class="attr">    logging:</span></div><div class="line"><span class="attr">      driver:</span> <span class="string">"syslog"</span></div><div class="line"><span class="attr">      options:</span></div><div class="line"><span class="attr">        syslog-address:</span> <span class="string">"tcp://127.0.0.1:1514"</span></div><div class="line"><span class="attr">        tag:</span> <span class="string">"proxy"</span></div></pre></td></tr></table></figure></p>
<ol>
<li>上传镜像<br>找一个安装了docker的机器，在/etc/docker/daemon.json文件中指定insecure-registries【因为我们上面并没有启用HTTPS协议】<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&#123;</div><div class="line">  <span class="attr">"insecure-registries"</span>: [<span class="string">"10.1.5.129"</span>],</div><div class="line">  <span class="attr">"registry-mirrors"</span>: [<span class="string">"https://docker.mirrors.ustc.edu.cn"</span>,<span class="string">"http://3a35aff6.m.daocloud.io"</span>,<span class="string">"http://ethanzhu.m.tenxcloud.net"</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>把本地的镜像上传到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[root@dnode2 ~]# docker tag willr 10.1.5.129/library/willr:0.1</div><div class="line">[root@dnode2 ~]# docker login 10.1.5.129</div><div class="line">Username: admin</div><div class="line">Password: </div><div class="line">Login Succeeded</div><div class="line">[root@dnode2 ~]# docker images</div><div class="line">REPOSITORY                   TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">10.1.5.129/library/willr     0.1                 2a33c792d4aa        5 hours ago         718.7 MB</div><div class="line">willr                        latest              2a33c792d4aa        5 hours ago         718.7 MB</div><div class="line">&lt;none&gt;                       &lt;none&gt;              3dabf60e7d97        17 hours ago        714.7 MB</div><div class="line">uhopper/hadoop-nodemanager   2.7.2               046a3f819f63        41 hours ago        715.4 MB</div><div class="line">r-base                       3.3.2               dbee2cbef542        4 weeks ago         682.8 MB</div><div class="line">r-base                       latest              dbee2cbef542        4 weeks ago         682.8 MB</div><div class="line">[root@dnode2 ~]# docker push 10.1.5.129/library/willr:0.1</div><div class="line">The push refers to a repository [10.1.5.129/library/willr]</div><div class="line">0748650e84ed: Pushed </div><div class="line">72547fe7a086: Pushing [==================================================&gt;] 509.8 MB</div><div class="line">2cd05b2f5db4: Pushed </div><div class="line">72547fe7a086: Pushed </div><div class="line">c610e92140d8: Pushed </div><div class="line">3b04b5a81444: Pushed </div><div class="line">29d255cec883: Pushed </div><div class="line">29d255cec883: Preparing </div><div class="line"></div><div class="line">0.1: digest: sha256:9eb5d67aa235a1d7724b659310e8947c7e6cf967bef7ae02b955225fc7eb193a size: 1791</div><div class="line">[root@dnode2 ~]#</div></pre></td></tr></table></figure></p>
<p>页面中的显示<br><a href=""></a></p>
<p>参考：</p>
<ul>
<li><a href="http://www.jianshu.com/p/141855241f2d" target="_blank" rel="external">http://www.jianshu.com/p/141855241f2d</a></li>
<li><a href="https://vmware.github.io/harbor/index_cn.html" target="_blank" rel="external">https://vmware.github.io/harbor/index_cn.html</a></li>
<li><a href="https://my.oschina.net/u/1540325/blog/702260" target="_blank" rel="external">https://my.oschina.net/u/1540325/blog/702260</a></li>
<li><a href="http://www.zimug.com/317.html" target="_blank" rel="external">http://www.zimug.com/317.html</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[docker整理]]></title>
      <url>/2017/01/17/docker%E6%95%B4%E7%90%86/</url>
      <content type="html"><![CDATA[<h2 id="centos7的yum源"><a href="#centos7的yum源" class="headerlink" title="centos7的yum源"></a>centos7的yum源</h2><ul>
<li>清华的docker源<br><a href="https://mirrors.tuna.tsinghua.edu.cn/help/docker/" target="_blank" rel="external">https://mirrors.tuna.tsinghua.edu.cn/help/docker/</a></li>
<li>阿里的源<br><a href="http://mirrors.aliyun.com/" target="_blank" rel="external">http://mirrors.aliyun.com/</a></li>
</ul>
<h2 id="registry-mirror"><a href="#registry-mirror" class="headerlink" title="registry mirror"></a>registry mirror</h2><p>编辑或添加文件 /etc/docker/daemon.json<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;registry-mirrors&quot;: [&quot;https://docker.mirrors.ustc.edu.cn&quot;,&quot;http://3a35aff6.m.daocloud.io&quot;,&quot;http://ethanzhu.m.tenxcloud.net&quot;]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>之后重启docker-daemon就可以了。</p>
<p>参考：</p>
<ul>
<li><a href="http://ethanzhu.leanote.com/post/docker-%E6%9B%B4%E6%94%B9" target="_blank" rel="external">http://ethanzhu.leanote.com/post/docker-%E6%9B%B4%E6%94%B9</a></li>
</ul>
<h2 id="修改docker-daemon配置"><a href="#修改docker-daemon配置" class="headerlink" title="修改docker daemon配置"></a>修改docker daemon配置</h2><p>查了好多资料，都说直接修改/etc/default/docker里的DOCKER_OPTS就可以制定registry mirror、镜像存储路径等各种docker daemon的启动参数，但是试了N次都没有成功，</p>
<p>其实细想一下，从启动脚本入手/etc/systemd/system/docker.service，官方说要在/etc/systemd/system/docker.service.d目录下创建自己的conf文件，修改启动命令的参数。我创建了一个will.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[Service]</div><div class="line">ExecStart=</div><div class="line">ExecStart=/usr/bin/dockerd --graph=&quot;/server/dspace&quot;</div></pre></td></tr></table></figure></p>
<p>之后reload一下daemon的配置。供参考的<a href="http://docs-stage.docker.com/v1.10/engine/reference/commandline/daemon/" target="_blank" rel="external">参数信息</a></p>
<p>要修改的主要参数在于<strong>启动service里的ExecStart</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">systemctl daemon-reload</div></pre></td></tr></table></figure>
<p>再去看指定的目录和docker info信息，发现已经修改过来了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@dnode2 ~]# ll /server/dspace/</div><div class="line">total 32</div><div class="line">drwx------ 2 root root 4096 Jan 18 23:48 containers</div><div class="line">drwx------ 4 root root 4096 Jan 18 23:48 devicemapper</div><div class="line">drwx------ 3 root root 4096 Jan 18 23:48 image</div><div class="line">drwxr-x--- 3 root root 4096 Jan 18 23:48 network</div><div class="line">drwx------ 2 root root 4096 Jan 18 23:48 swarm</div><div class="line">drwx------ 2 root root 4096 Jan 18 23:48 tmp</div><div class="line">drwx------ 2 root root 4096 Jan 18 23:48 trust</div><div class="line">drwx------ 2 root root 4096 Jan 18 23:48 volumes</div><div class="line">[root@dnode2 ~]# docker images</div><div class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</div></pre></td></tr></table></figure></p>
<p>刚才的images也都查不到了，停掉docker daemon，手动把原来的镜像全都copy过来，启动docker daemon就可以了。</p>
<p>综上，其实已经有两种方式配置docker daemon的启动参数了，一个是在service.docker.d目录里添加自己id配置文件will.conf，直接修改启动命令并指定参数。另一个就是编辑/etc/docker/daemon.json文件。</p>
<p>应该是两种方式都可以行得通，但是命令行和json的参数并不完全对应，需要找一下json的mapping key，现在觉得json 的方式会更加友好一些。</p>
<p>参考</p>
<ul>
<li>官网 <a href="https://docs.docker.com/engine/admin/systemd/" target="_blank" rel="external">https://docs.docker.com/engine/admin/systemd/</a></li>
<li><a href="http://blog.csdn.net/l6807718/article/details/51325431" target="_blank" rel="external">http://blog.csdn.net/l6807718/article/details/51325431</a></li>
</ul>
<p>杂记<br>=</p>
<ol>
<li>docker容器的cpu和memory是可以调整集群资源参数的，有limit设置；</li>
<li>Dockerfile里声明volume的目录是对于任何的volumes命令参数不可变的，会自动生成一个挂载点，目的是不让host直接修改，作为一个数据容器为其他镜像提供volume挂载服务。【–volumes-from】<br><a href="https://docs.docker.com/engine/reference/builder/#/volume" target="_blank" rel="external">https://docs.docker.com/engine/reference/builder/#/volume</a><br><a href="http://www.cnblogs.com/51kata/p/5266626.html" target="_blank" rel="external">http://www.cnblogs.com/51kata/p/5266626.html</a></li>
</ol>
<p>docker swarm<br>=</p>
<h4 id="1-启动manager，初始化集群"><a href="#1-启动manager，初始化集群" class="headerlink" title="1. 启动manager，初始化集群"></a>1. 启动manager，初始化集群</h4><p>manager机器上执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker swarm init --advertise-addr 10.1.5.129</div><div class="line">Swarm initialized: current node (efpood09fyouiyib1f78y5oa6) is now a manager.</div><div class="line"></div><div class="line">To add a worker to this swarm, run the following command:</div><div class="line"></div><div class="line">    docker swarm join \</div><div class="line">    --token SWMTKN-1-50wivhmqel8u7pnorhfpu5a8qrfvged69b6r8v06jzscsysds2-3yllw8v8deku690gd8a8pfio1 \</div><div class="line">    10.1.5.129:2377</div><div class="line"></div><div class="line">To add a manager to this swarm, run &apos;docker swarm join-token manager&apos; and follow the instructions.</div><div class="line">[root@controller wil]# docker info</div><div class="line">.....</div><div class="line">.....</div><div class="line">Swarm: active</div><div class="line"> NodeID: efpood09fyouiyib1f78y5oa6</div><div class="line"> Is Manager: true</div><div class="line"> ClusterID: 4wnicl4f2vvtlpmpa2pyj28ji</div><div class="line"> Managers: 1</div><div class="line"> Nodes: 1</div><div class="line"> Orchestration:</div><div class="line">  Task History Retention Limit: 5</div><div class="line"> Raft:</div><div class="line">  Snapshot Interval: 10000</div><div class="line">  Heartbeat Tick: 1</div><div class="line">  Election Tick: 3</div><div class="line"> Dispatcher:</div><div class="line">  Heartbeat Period: 5 seconds</div><div class="line"> CA Configuration:</div><div class="line">  Expiry Duration: 3 months</div><div class="line"> Node Address: 10.1.5.129</div><div class="line">Runtimes: runc</div><div class="line">.....</div><div class="line">.....</div></pre></td></tr></table></figure></p>
<p>可以看到初始化后，docker info里显示了swarm相关的信息。</p>
<p>查看当前swarm集群中的机器：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]#  docker node ls</div><div class="line">ID                           HOSTNAME    STATUS  AVAILABILITY  MANAGER STATUS</div><div class="line">efpood09fyouiyib1f78y5oa6 *  controller  Ready   Active        Leader</div></pre></td></tr></table></figure></p>
<p>* 代表的是当前机器</p>
<h4 id="2-添加node"><a href="#2-添加node" class="headerlink" title="2.添加node"></a>2.添加node</h4><p>可以在manager节点上确认一下加入集群需要的token：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker swarm join-token worker</div><div class="line">To add a worker to this swarm, run the following command:</div><div class="line"></div><div class="line">    docker swarm join \</div><div class="line">    --token SWMTKN-1-50wivhmqel8u7pnorhfpu5a8qrfvged69b6r8v06jzscsysds2-3yllw8v8deku690gd8a8pfio1 \</div><div class="line">    10.1.5.129:2377</div></pre></td></tr></table></figure></p>
<p>然后分别在dnode1、dnode2上运行此命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@dnode2 willdjango]# docker swarm join \</div><div class="line">&gt;     --token SWMTKN-1-50wivhmqel8u7pnorhfpu5a8qrfvged69b6r8v06jzscsysds2-3yllw8v8deku690gd8a8pfio1 \</div><div class="line">&gt;     10.1.5.129:2377</div><div class="line"></div><div class="line">This node joined a swarm as a worker.</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@dnode1 server]# docker swarm join \</div><div class="line">&gt;     --token SWMTKN-1-50wivhmqel8u7pnorhfpu5a8qrfvged69b6r8v06jzscsysds2-3yllw8v8deku690gd8a8pfio1 \</div><div class="line">&gt;     10.1.5.129:2377</div><div class="line"></div><div class="line">This node joined a swarm as a worker.</div></pre></td></tr></table></figure>
<p>再查看当前集群node状态, 此命令只能在manager所在的节点上执行，worker节点没有权限：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker node ls</div><div class="line">ID                           HOSTNAME    STATUS  AVAILABILITY  MANAGER STATUS</div><div class="line">0c67km60csfft6paxdsodp8ss    dnode2      Ready   Active        </div><div class="line">759vbg6zxxzffj4i3pw21249y    dnode1      Ready   Active        </div><div class="line">efpood09fyouiyib1f78y5oa6 *  controller  Ready   Active        Leader</div></pre></td></tr></table></figure></p>
<h4 id="3-部署服务"><a href="#3-部署服务" class="headerlink" title="3. 部署服务"></a>3. 部署服务</h4><p>创建一个service：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker service create --replicas 1 --name resourcemanager_swarm willcup/yarn:0.1 /bin/bash</div><div class="line">0nnc9cpf1ebhbw6ixbro9q8wn</div><div class="line">[root@controller wil]# docker service ls</div><div class="line">ID            NAME                   REPLICAS  IMAGE             COMMAND</div><div class="line">0nnc9cpf1ebh  resourcemanager_swarm  0/1       willcup/yarn:0.1  /bin/bash</div></pre></td></tr></table></figure></p>
<p>查看这个service的元信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker service inspect --pretty resourcemanager_swarm</div><div class="line">ID:		0nnc9cpf1ebhbw6ixbro9q8wn</div><div class="line">Name:		resourcemanager_swarm</div><div class="line">Mode:		Replicated</div><div class="line"> Replicas:	1</div><div class="line">Placement:</div><div class="line">UpdateConfig:</div><div class="line"> Parallelism:	1</div><div class="line"> On failure:	pause</div><div class="line">ContainerSpec:</div><div class="line"> Image:		willcup/yarn:0.1</div><div class="line"> Args:		/bin/bash</div><div class="line">Resources:</div></pre></td></tr></table></figure></p>
<p>查看这个service的进程所在：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker service ps resourcemanager_swarm</div><div class="line">ID                         NAME                         IMAGE             NODE        DESIRED STATE  CURRENT STATE            ERROR</div><div class="line">dss32jnwz7aaxtqemvxpke4gg  resourcemanager_swarm.1      willcup/yarn:0.1  dnode2      Running        Preparing 5 minutes ago  </div><div class="line">1az4a1ctb9y3io2oswew0zab9   \_ resourcemanager_swarm.1  willcup/yarn:0.1  controller  Shutdown       Complete 2 minutes ago</div></pre></td></tr></table></figure></p>
<p>像这个我们的例子中就是，在controller中启动未成功，然后转到dnode1上运行了。但是两次执行的DESIRED STATE和CURRENT STATE并不吻合。看了一下是我们的manager机器【也就是上面的controller】并不认识dnode2，配置一下hosts。再查看一下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker service ps resourcemanager_swarm</div><div class="line">ID                         NAME                         IMAGE             NODE        DESIRED STATE  CURRENT STATE            ERROR</div><div class="line">bvrtqkl8iybt5rr5kqlj6mio2  resourcemanager_swarm.1      willcup/yarn:0.1  controller  Running        Running 10 seconds ago   </div><div class="line">dss32jnwz7aaxtqemvxpke4gg   \_ resourcemanager_swarm.1  willcup/yarn:0.1  dnode2      Shutdown       Complete 4 minutes ago   </div><div class="line">1az4a1ctb9y3io2oswew0zab9   \_ resourcemanager_swarm.1  willcup/yarn:0.1  controller  Shutdown       Complete 10 minutes ago  </div><div class="line">[root@controller wil]# docker service ps resourcemanager_swarm</div><div class="line">ID                         NAME                         IMAGE             NODE        DESIRED STATE  CURRENT STATE                ERROR</div><div class="line">c2btlmupl7r9ss3dents28928  resourcemanager_swarm.1      willcup/yarn:0.1  controller  Running        Preparing 22 seconds ago     </div><div class="line">99hilqo2an723j9k7n2grkf0o   \_ resourcemanager_swarm.1  willcup/yarn:0.1  dnode2      Shutdown       Complete 3 minutes ago       </div><div class="line">a16ktljr241g9zn6qluunx84l   \_ resourcemanager_swarm.1  willcup/yarn:0.1  controller  Shutdown       Complete about a minute ago  </div><div class="line">c52kek07d8uve9kqjsf3vcgh3   \_ resourcemanager_swarm.1  willcup/yarn:0.1  dnode2      Shutdown       Complete 6 minutes ago       </div><div class="line">bvrtqkl8iybt5rr5kqlj6mio2   \_ resourcemanager_swarm.1  willcup/yarn:0.1  controller  Shutdown       Complete 4 minutes ago</div></pre></td></tr></table></figure></p>
<p>总是出问题。。。</p>
<p>还是用官网的吧：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker service create --replicas 1 --name helloworld alpine ping docker.com</div><div class="line">2q5p0ahn92aa8be9el23j93yx</div><div class="line">[root@controller wil]# docker service ps helloworld</div><div class="line">ID                         NAME          IMAGE   NODE        DESIRED STATE  CURRENT STATE            ERROR</div><div class="line">dvjcrjztbqkj3x5e8fggraw0f  helloworld.1  alpine  controller  Running        Preparing 6 seconds ago  </div><div class="line">[root@controller wil]# docker service ps helloworld</div><div class="line">ID                         NAME          IMAGE   NODE        DESIRED STATE  CURRENT STATE           ERROR</div><div class="line">dvjcrjztbqkj3x5e8fggraw0f  helloworld.1  alpine  controller  Running        Starting 4 seconds ago  </div><div class="line">[root@controller wil]# docker service ps helloworld</div><div class="line">ID                         NAME          IMAGE   NODE        DESIRED STATE  CURRENT STATE           ERROR</div><div class="line">dvjcrjztbqkj3x5e8fggraw0f  helloworld.1  alpine  controller  Running        Starting 8 seconds ago  </div><div class="line">[root@controller wil]# docker service ps helloworld</div><div class="line">ID                         NAME          IMAGE   NODE        DESIRED STATE  CURRENT STATE               ERROR</div><div class="line">dvjcrjztbqkj3x5e8fggraw0f  helloworld.1  alpine  controller  Running        Running about a minute ago</div></pre></td></tr></table></figure></p>
<p>说是在controller上运行着的，我们就到controller机器上ps一下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker ps</div><div class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</div><div class="line">5653c87be989        alpine:latest       &quot;ping docker.com&quot;   4 minutes ago       Up 3 minutes                            helloworld.1.dvjcrjztbqkj3x5e8fggraw0f</div></pre></td></tr></table></figure></p>
<h4 id="4-服务扩容"><a href="#4-服务扩容" class="headerlink" title="4. 服务扩容"></a>4. 服务扩容</h4><p>对于后台服务，很多时候我们是部署多个，然后再前面部署负载均衡的。我们可以通过swarm的命令轻松的将我们的服务进行扩容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker service scale helloworld=5</div><div class="line">helloworld scaled to 5</div><div class="line">[root@controller wil]# docker service ps helloworld</div><div class="line">ID                         NAME          IMAGE   NODE        DESIRED STATE  CURRENT STATE                     ERROR</div><div class="line">dvjcrjztbqkj3x5e8fggraw0f  helloworld.1  alpine  controller  Running        Running 5 minutes ago             </div><div class="line">5x3rsxhw31w5prpwhvh5bzn8m  helloworld.2  alpine  dnode2      Running        Preparing 2 minutes ago           </div><div class="line">1ymr6qzfzvpjc86lwx7c7p938  helloworld.3  alpine  dnode1      Running        Preparing 16 seconds ago          </div><div class="line">3h36sr8m8c4f7utei50ss9tav  helloworld.4  alpine  dnode1      Running        Preparing 16 seconds ago          </div><div class="line">eneop6ooju630tzpxt8vlftjw  helloworld.5  alpine  controller  Running        Preparing less than a second ago  </div><div class="line">[root@controller wil]# docker service ps helloworld</div><div class="line">ID                         NAME          IMAGE   NODE        DESIRED STATE  CURRENT STATE               ERROR</div><div class="line">dvjcrjztbqkj3x5e8fggraw0f  helloworld.1  alpine  controller  Running        Running 7 minutes ago       </div><div class="line">5x3rsxhw31w5prpwhvh5bzn8m  helloworld.2  alpine  dnode2      Running        Running 3 minutes ago       </div><div class="line">1ymr6qzfzvpjc86lwx7c7p938  helloworld.3  alpine  dnode1      Running        Running about a minute ago  </div><div class="line">3h36sr8m8c4f7utei50ss9tav  helloworld.4  alpine  dnode1      Running        Running about a minute ago  </div><div class="line">eneop6ooju630tzpxt8vlftjw  helloworld.5  alpine  controller  Running        Running about a minute ago</div></pre></td></tr></table></figure></p>
<p>可以看到，实现了扩容，自动将container重命名，并且分布到了不同的节点之上。</p>
<h4 id="5-删除服务"><a href="#5-删除服务" class="headerlink" title="5. 删除服务"></a>5. 删除服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker service rm helloworld</div><div class="line">helloworld</div><div class="line">[root@controller wil]# docker service ps helloworld</div><div class="line">Error: No such service: helloworld</div></pre></td></tr></table></figure>
<p>虽然service很快就被删除了，但是其实container是需要一些时间才能清理干净的。开始的时候docker ps还能看到部分，稍等一下就没有了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker ps -a</div><div class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                     PORTS               NAMES</div><div class="line">5653c87be989        alpine:latest       &quot;ping docker.com&quot;        10 minutes ago      Removal In Progress                            helloworld.1.dvjcrjztbqkj3x5e8fggraw0f</div><div class="line">fb3c81306678        a6a1f5eb98f2        &quot;bash /entrypoint.sh &quot;   3 hours ago         Exited (1) 3 hours ago                         composetest_nodemanager_1</div><div class="line">c191fc0db545        a6a1f5eb98f2        &quot;bash /entrypoint.sh &quot;   19 hours ago        Exited (137) 3 hours ago                       composetest_resourcemanager_1</div><div class="line">[root@controller wil]# docker ps -a</div><div class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                     PORTS               NAMES</div><div class="line">fb3c81306678        a6a1f5eb98f2        &quot;bash /entrypoint.sh &quot;   3 hours ago         Exited (1) 3 hours ago                         composetest_nodemanager_1</div><div class="line">c191fc0db545        a6a1f5eb98f2        &quot;bash /entrypoint.sh &quot;   19 hours ago        Exited (137) 3 hours ago                       composetest_resourcemanager_1</div></pre></td></tr></table></figure></p>
<h4 id="5-节点维护"><a href="#5-节点维护" class="headerlink" title="5. 节点维护"></a>5. 节点维护</h4><p>有的时候我们要临时维护几台节点，就需要把这个节点标记下线，为了不影响服务质量，需要把正在运行的服务转移到其他节点上。swarm会自动为我们做这些工作，我们只需要标记某个节点为drain就可以了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker service ps helloworld</div><div class="line">ID                         NAME          IMAGE   NODE        DESIRED STATE  CURRENT STATE               ERROR</div><div class="line">ciw4f1ibuwuqjv2hvn6s1mqs9  helloworld.1  alpine  dnode1      Running        Running about a minute ago  </div><div class="line">0ezba4uegtfmajlkw6kbw66q5  helloworld.2  alpine  dnode2      Running        Running 4 minutes ago       </div><div class="line">dnb7d4cjwes3ubywn6iv2vpiu  helloworld.3  alpine  controller  Running        Running about a minute ago  </div><div class="line">dyidqdhh7n04m0sk3k0fy74yp  helloworld.4  alpine  controller  Running        Running about a minute ago  </div><div class="line">66lmmu30fywqqey7lpirz5o6s  helloworld.5  alpine  dnode1      Running        Running about a minute ago  </div><div class="line">[root@controller wil]# docker node update --availability drain dnode1</div><div class="line">dnode1</div><div class="line">[root@controller wil]# docker node ls</div><div class="line">ID                           HOSTNAME    STATUS  AVAILABILITY  MANAGER STATUS</div><div class="line">0c67km60csfft6paxdsodp8ss    dnode2      Ready   Active        </div><div class="line">759vbg6zxxzffj4i3pw21249y    dnode1      Ready   Drain         </div><div class="line">efpood09fyouiyib1f78y5oa6 *  controller  Ready   Active        Leader</div><div class="line">[root@controller wil]# docker service ps helloworld</div><div class="line">ID                         NAME              IMAGE   NODE        DESIRED STATE  CURRENT STATE               ERROR</div><div class="line">9sxv9bi0j7yy341rtp6hkrm0e  helloworld.1      alpine  dnode2      Ready          Preparing 3 minutes ago     </div><div class="line">ciw4f1ibuwuqjv2hvn6s1mqs9   \_ helloworld.1  alpine  dnode1      Shutdown       Running 2 minutes ago       </div><div class="line">0ezba4uegtfmajlkw6kbw66q5  helloworld.2      alpine  dnode2      Running        Running 4 minutes ago       </div><div class="line">dnb7d4cjwes3ubywn6iv2vpiu  helloworld.3      alpine  controller  Running        Running about a minute ago  </div><div class="line">dyidqdhh7n04m0sk3k0fy74yp  helloworld.4      alpine  controller  Running        Running about a minute ago  </div><div class="line">8ozxlg29d4ynko3plauupuuu5  helloworld.5      alpine  dnode2      Ready          Preparing 3 minutes ago     </div><div class="line">66lmmu30fywqqey7lpirz5o6s   \_ helloworld.5  alpine  dnode1      Shutdown       Running 2 minutes ago       </div><div class="line">[root@controller wil]# docker service ps helloworld</div><div class="line">ID                         NAME              IMAGE   NODE        DESIRED STATE  CURRENT STATE               ERROR</div><div class="line">9sxv9bi0j7yy341rtp6hkrm0e  helloworld.1      alpine  dnode2      Running        Preparing 3 minutes ago     </div><div class="line">ciw4f1ibuwuqjv2hvn6s1mqs9   \_ helloworld.1  alpine  dnode1      Shutdown       Shutdown 19 seconds ago     </div><div class="line">0ezba4uegtfmajlkw6kbw66q5  helloworld.2      alpine  dnode2      Running        Running 5 minutes ago       </div><div class="line">dnb7d4cjwes3ubywn6iv2vpiu  helloworld.3      alpine  controller  Running        Running about a minute ago  </div><div class="line">dyidqdhh7n04m0sk3k0fy74yp  helloworld.4      alpine  controller  Running        Running about a minute ago  </div><div class="line">8ozxlg29d4ynko3plauupuuu5  helloworld.5      alpine  dnode2      Running        Preparing 3 minutes ago     </div><div class="line">66lmmu30fywqqey7lpirz5o6s   \_ helloworld.5  alpine  dnode1      Shutdown       Shutdown 20 seconds ago</div></pre></td></tr></table></figure></p>
<p>当维护完成之后，再把node状态更新回来：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker node update --availability active dnode1</div><div class="line">dnode1</div><div class="line">[root@controller wil]# docker service ps helloworld</div><div class="line">ID                         NAME              IMAGE   NODE        DESIRED STATE  CURRENT STATE           ERROR</div><div class="line">9sxv9bi0j7yy341rtp6hkrm0e  helloworld.1      alpine  dnode2      Running        Running 4 minutes ago   </div><div class="line">ciw4f1ibuwuqjv2hvn6s1mqs9   \_ helloworld.1  alpine  dnode1      Shutdown       Shutdown 2 minutes ago  </div><div class="line">0ezba4uegtfmajlkw6kbw66q5  helloworld.2      alpine  dnode2      Running        Running 6 minutes ago   </div><div class="line">dnb7d4cjwes3ubywn6iv2vpiu  helloworld.3      alpine  controller  Running        Running 3 minutes ago   </div><div class="line">dyidqdhh7n04m0sk3k0fy74yp  helloworld.4      alpine  controller  Running        Running 3 minutes ago   </div><div class="line">8ozxlg29d4ynko3plauupuuu5  helloworld.5      alpine  dnode2      Running        Running 4 minutes ago   </div><div class="line">66lmmu30fywqqey7lpirz5o6s   \_ helloworld.5  alpine  dnode1      Shutdown       Shutdown 2 minutes ago  </div><div class="line">[root@controller wil]# docker node ls</div><div class="line">ID                           HOSTNAME    STATUS  AVAILABILITY  MANAGER STATUS</div><div class="line">0c67km60csfft6paxdsodp8ss    dnode2      Ready   Active        </div><div class="line">759vbg6zxxzffj4i3pw21249y    dnode1      Ready   Active        </div><div class="line">efpood09fyouiyib1f78y5oa6 *  controller  Ready   Active        Leader</div></pre></td></tr></table></figure></p>
<p>但是服务如果不出问题的话，不会自动迁移回dnode1了。</p>
<p>通常我们可以让manager节点是drain的，以保证它负载低，集群能正常运行。</p>
<h4 id="6-路由"><a href="#6-路由" class="headerlink" title="6. 路由"></a>6. 路由</h4><p>所有的swarm节点都加入了一个ingress的routing mesh。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker network ls</div><div class="line">NETWORK ID          NAME                  DRIVER              SCOPE</div><div class="line">6461c2e9e64e        bridge                bridge              local               </div><div class="line">5d5d0be2f5a6        docker_gwbridge       bridge              local               </div><div class="line">e2bbfd5c0b62        host                  host                local               </div><div class="line">0r5dk7ja8vw7        ingress               overlay             swarm               </div><div class="line">01c12cd7bba7        none                  null                local</div></pre></td></tr></table></figure>
<p>routing mesh会把所有对于public port的请求转发到所有对应service的节点的container上。</p>
<p>先搞一个有public接口的service:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker service create \</div><div class="line">&gt;   --name my-web \</div><div class="line">&gt;   --publish 8080:80 \</div><div class="line">&gt;   --replicas 2 \</div><div class="line">&gt;   nginx</div><div class="line">2lsi4py6pbcu96ttnjyqj7u4i</div><div class="line">[root@controller wil]# docker service ps my-web</div><div class="line">ID                         NAME      IMAGE  NODE    DESIRED STATE  CURRENT STATE             ERROR</div><div class="line">84xjxx4kth0idnzuob4186cn7  my-web.1  nginx  dnode1  Running        Preparing 20 seconds ago  </div><div class="line">0fqk2zwyp9u2ohi9iu91qli50  my-web.2  nginx  dnode2  Running        Preparing 3 minutes ago</div></pre></td></tr></table></figure></p>
<p>这个命令会在所有的node上都开放8080端口，swarm的load balancer会把对于任何一个node的8080接口的请求路由给active的container【这里就是dnode1和dnode2】。</p>
<p>也可以为正在运行的服务添加开放的端口映射：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ docker service update \</div><div class="line">  --publish-add &lt;PUBLISHED-PORT&gt;:&lt;TARGET-PORT&gt; \</div><div class="line">  &lt;SERVICE&gt;</div></pre></td></tr></table></figure></p>
<p>查看某service开放的端口：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]#  docker service inspect --format=&quot;&#123;&#123;json .Endpoint.Spec.Ports&#125;&#125;&quot; my-web</div><div class="line">[&#123;&quot;Protocol&quot;:&quot;tcp&quot;,&quot;TargetPort&quot;:80,&quot;PublishedPort&quot;:8080&#125;]</div></pre></td></tr></table></figure></p>
<p>单独指定开放tcp/udp端口，默认就是TCP：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ docker service create --name dns-cache -p 53:53/tcp dns-cache</div><div class="line">$ docker service create --name dns-cache -p 53:53/udp dns-cache</div></pre></td></tr></table></figure></p>
<p>因为目前是有三个node的8080都可以提供服务，所以我们也可以在他们之外再加个HAProxy做负载均衡。<br>其实如果swarm自己的调度器能够均匀分发请求给不同的container的话，也没有必要弄外部的LB了。</p>
<h4 id="7-其他"><a href="#7-其他" class="headerlink" title="7. 其他"></a>7. 其他</h4><p>另外，创建服务的时候和compose类似，也是有很多参数可以指定的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker service create --help</div><div class="line"></div><div class="line">Usage:	docker service create [OPTIONS] IMAGE [COMMAND] [ARG...]</div><div class="line"></div><div class="line">Create a new service</div><div class="line"></div><div class="line">Options:</div><div class="line">      --constraint value               Placement constraints (default [])</div><div class="line">      --container-label value          Container labels (default [])</div><div class="line">      --endpoint-mode string           Endpoint mode (vip or dnsrr)</div><div class="line">  -e, --env value                      Set environment variables (default [])</div><div class="line">      --help                           Print usage</div><div class="line">  -l, --label value                    Service labels (default [])</div><div class="line">      --limit-cpu value                Limit CPUs (default 0.000)</div><div class="line">      --limit-memory value             Limit Memory (default 0 B)</div><div class="line">      --log-driver string              Logging driver for service</div><div class="line">      --log-opt value                  Logging driver options (default [])</div><div class="line">      --mode string                    Service mode (replicated or global) (default &quot;replicated&quot;)</div><div class="line">      --mount value                    Attach a mount to the service</div><div class="line">      --name string                    Service name</div><div class="line">      --network value                  Network attachments (default [])</div><div class="line">  -p, --publish value                  Publish a port as a node port (default [])</div><div class="line">      --replicas value                 Number of tasks (default none)</div><div class="line">      --reserve-cpu value              Reserve CPUs (default 0.000)</div><div class="line">      --reserve-memory value           Reserve Memory (default 0 B)</div><div class="line">      --restart-condition string       Restart when condition is met (none, on-failure, or any)</div><div class="line">      --restart-delay value            Delay between restart attempts (default none)</div><div class="line">      --restart-max-attempts value     Maximum number of restarts before giving up (default none)</div><div class="line">      --restart-window value           Window used to evaluate the restart policy (default none)</div><div class="line">      --stop-grace-period value        Time to wait before force killing a container (default none)</div><div class="line">      --update-delay duration          Delay between updates</div><div class="line">      --update-failure-action string   Action on update failure (pause|continue) (default &quot;pause&quot;)</div><div class="line">      --update-parallelism uint        Maximum number of tasks updated simultaneously (0 to update all at once) (default 1)</div><div class="line">  -u, --user string                    Username or UID</div><div class="line">      --with-registry-auth             Send registry authentication details to swarm agents</div><div class="line">  -w, --workdir string                 Working directory inside the container</div></pre></td></tr></table></figure></p>
<p>需要注意的是：慎重使用mount。原因有以下三点：</p>
<ul>
<li>如果mount到host path上，那么需要每个node都有同样的path和文件。</li>
<li>需要确保所有node上的这个文件一直是可用的状态</li>
<li>这种方式完全就是反设计的。因为不能保证生产和测试的mount文件是一致的，从而导致运行出问题。</li>
</ul>
<p>参考：<a href="https://docs.docker.com/engine/swarm/services/" target="_blank" rel="external">https://docs.docker.com/engine/swarm/services/</a></p>
<p>可以通过demote和promote改变node的角色。</p>
<p><strong>重大发现</strong>： docker是有python的API的，可以用API管理集群： <a href="https://docker-py.readthedocs.io/en/stable/services.html。" target="_blank" rel="external">https://docker-py.readthedocs.io/en/stable/services.html。</a></p>
<h4 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h4><p>1.12版本的swarm模式里并不能获取已经失败了的service的container的日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker service ps yarn</div><div class="line">ID                         NAME        IMAGE             NODE        DESIRED STATE  CURRENT STATE              ERROR</div><div class="line">c317x0ovq833c6g83hi4iwzz4  yarn.1      willcup/yarn:0.1  controller  Running        Running 2 seconds ago      </div><div class="line">2w5k9c4efh8h188ompgnfvh57   \_ yarn.1  willcup/yarn:0.1  dnode1      Shutdown       Failed about a minute ago  &quot;task: non-zero exit (127)&quot;</div><div class="line">4jvdu7nz8kxvnd9wa9qzmy1pw   \_ yarn.1  willcup/yarn:0.1  controller  Shutdown       Failed about a minute ago  &quot;task: non-zero exit (127)&quot;</div><div class="line">5yu69ugxmndhfdetvd9kthel2   \_ yarn.1  willcup/yarn:0.1  dnode1      Shutdown       Failed 3 minutes ago       &quot;task: non-zero exit (127)&quot;</div><div class="line">7qyx81ptxouv6883h1o1pbiti   \_ yarn.1  willcup/yarn:0.1  controller  Shutdown       Failed 5 minutes ago       &quot;task: non-zero exit (127)&quot;</div></pre></td></tr></table></figure>
<p>上面失败的就都找不到了。而且rm service以后，那些container都会被自动清理掉。</p>
<p>对于某些功能支持的不完善.</p>
<p>参考：</p>
<ul>
<li><a href="http://www.jianshu.com/p/3efee6927833" target="_blank" rel="external">http://www.jianshu.com/p/3efee6927833</a></li>
<li><a href="https://github.com/docker/docker/issues/24812" target="_blank" rel="external">https://github.com/docker/docker/issues/24812</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[SparkR安装历程]]></title>
      <url>/2017/01/09/SparkR%E5%AE%89%E8%A3%85%E5%8E%86%E7%A8%8B/</url>
      <content type="html"><![CDATA[<ol>
<li><p>在centos上安装一下R的基础包。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">yum install -y R</div><div class="line"></div><div class="line">R CMD javareconf</div></pre></td></tr></table></figure>
</li>
<li><p>安装Rstudio server</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget https://download2.rstudio.org/rstudio-server-rhel-1.0.136-x86_64.rpm</div><div class="line">yum install --nogpgcheck rstudio-server-rhel-1.0.136-x86_64.rpm</div><div class="line">rstudio-server verify-installation</div></pre></td></tr></table></figure>
</li>
<li><p>为Rstudio server添加用户，默认是使用linux用户的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">useradd rtest</div><div class="line">passwd rtest</div></pre></td></tr></table></figure>
</li>
<li><p>R安装依赖<br>为R安装sparkR的库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">R CMD INSTALL /usr/hdp/current/spark-client/R/lib/SparkR/</div></pre></td></tr></table></figure>
</li>
</ol>
<p>安装forecast的时候报错, g++版本低，通过安装devtools-2解决：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo rpm --import http://ftp.scientificlinux.org/linux/scientific/5x/x86_64/RPM-GPG-KEYs/RPM-GPG-KEY-cern</div><div class="line">wget -O /etc/yum.repos.d/slc6-devtoolset.repo http://linuxsoft.cern.ch/cern/devtoolset/slc6-devtoolset.repo</div><div class="line">sudo yum install devtoolset-2</div><div class="line">scl enable devtoolset-2 bash</div></pre></td></tr></table></figure></p>
<p>这样版本就已经好了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ gcc --version</div><div class="line">gcc (GCC) 4.8.2 20140120 (Red Hat 4.8.2-15)</div><div class="line">...</div><div class="line"></div><div class="line">$ g++ --version</div><div class="line">g++ (GCC) 4.8.2 20140120 (Red Hat 4.8.2-15)</div><div class="line">...</div><div class="line"></div><div class="line">$ gfortran --version</div><div class="line">GNU Fortran (GCC) 4.8.2 20140120 (Red Hat 4.8.2-15)</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>参考： <a href="https://gist.github.com/stephenturner/e3bc5cfacc2dc67eca8b" target="_blank" rel="external">https://gist.github.com/stephenturner/e3bc5cfacc2dc67eca8b</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div></pre></td><td class="code"><pre><div class="line">&gt; sc&lt;-sparkR.init(master = &quot;yarn-client&quot;)</div><div class="line">Launching java with spark-submit command spark-submit   sparkr-shell /tmp/RtmpERrwOX/backend_port628c57c68104 </div><div class="line">17/01/10 15:28:50 INFO SparkContext: Running Spark version 1.5.2</div><div class="line">17/01/10 15:28:53 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable</div><div class="line">17/01/10 15:28:54 INFO SecurityManager: Changing view acls to: zhangjiayi</div><div class="line">17/01/10 15:28:54 INFO SecurityManager: Changing modify acls to: zhangjiayi</div><div class="line">17/01/10 15:28:54 INFO SecurityManager: SecurityManager: authentication disabled; ui acls disabled; users with view permissions: Set(zhangjiayi); users with modify permissions: Set(zhangjiayi)</div><div class="line">17/01/10 15:29:00 INFO Slf4jLogger: Slf4jLogger started</div><div class="line">17/01/10 15:29:00 INFO Remoting: Starting remoting</div><div class="line">17/01/10 15:29:01 INFO Remoting: Remoting started; listening on addresses :[akka.tcp://sparkDriver@10.1.5.65:34109]</div><div class="line">17/01/10 15:29:01 INFO Utils: Successfully started service &apos;sparkDriver&apos; on port 34109.</div><div class="line">17/01/10 15:29:01 INFO SparkEnv: Registering MapOutputTracker</div><div class="line">17/01/10 15:29:01 INFO SparkEnv: Registering BlockManagerMaster</div><div class="line">17/01/10 15:29:02 INFO DiskBlockManager: Created local directory at /tmp/blockmgr-ce31222a-c674-4391-be3c-43b075e758d4</div><div class="line">17/01/10 15:29:02 INFO MemoryStore: MemoryStore started with capacity 530.0 MB</div><div class="line">17/01/10 15:29:02 INFO HttpFileServer: HTTP File server directory is /tmp/spark-c2196ae2-3c1b-46e0-97dd-583cd7a240a3/httpd-af4e2720-d455-4d5a-93de-6a0e7231da34</div><div class="line">17/01/10 15:29:02 INFO HttpServer: Starting HTTP Server</div><div class="line">17/01/10 15:29:03 INFO Server: jetty-8.y.z-SNAPSHOT</div><div class="line">17/01/10 15:29:03 INFO AbstractConnector: Started SocketConnector@0.0.0.0:44708</div><div class="line">17/01/10 15:29:03 INFO Utils: Successfully started service &apos;HTTP file server&apos; on port 44708.</div><div class="line">17/01/10 15:29:03 INFO SparkEnv: Registering OutputCommitCoordinator</div><div class="line">17/01/10 15:29:03 INFO Server: jetty-8.y.z-SNAPSHOT</div><div class="line">17/01/10 15:29:03 INFO AbstractConnector: Started SelectChannelConnector@0.0.0.0:4040</div><div class="line">17/01/10 15:29:03 INFO Utils: Successfully started service &apos;SparkUI&apos; on port 4040.</div><div class="line">17/01/10 15:29:03 INFO SparkUI: Started SparkUI at http://10.1.5.65:4040</div><div class="line">17/01/10 15:29:04 WARN MetricsSystem: Using default name DAGScheduler for source because spark.app.id is not set.</div><div class="line">spark.yarn.driver.memoryOverhead is set but does not apply in client mode.</div><div class="line">17/01/10 15:29:05 INFO TimelineClientImpl: Timeline service address: http://slavenode4:8188/ws/v1/timeline/</div><div class="line">17/01/10 15:29:06 INFO RMProxy: Connecting to ResourceManager at slavenode3/10.1.5.64:8050</div><div class="line">17/01/10 15:29:11 WARN DomainSocketFactory: The short-circuit local reads feature cannot be used because libhadoop cannot be loaded.</div><div class="line">17/01/10 15:29:12 INFO Client: Requesting a new application from cluster with 5 NodeManagers</div><div class="line">17/01/10 15:29:12 INFO Client: Verifying our application has not requested more than the maximum memory capability of the cluster (5120 MB per container)</div><div class="line">17/01/10 15:29:12 INFO Client: Will allocate AM container, with 896 MB memory including 384 MB overhead</div><div class="line">17/01/10 15:29:12 INFO Client: Setting up container launch context for our AM</div><div class="line">17/01/10 15:29:12 INFO Client: Setting up the launch environment for our AM container</div><div class="line">17/01/10 15:29:12 INFO Client: Preparing resources for our AM container</div><div class="line">17/01/10 15:29:12 INFO Client: Uploading resource file:/usr/hdp/2.3.4.0-3485/spark/lib/spark-assembly-1.5.2.2.3.4.0-3485-hadoop2.7.1.2.3.4.0-3485.jar -&gt; hdfs://masternode:8020/user/zhangjiayi/.sparkStaging/application_1483512430911_0002/spark-assembly-1.5.2.2.3.4.0-3485-hadoop2.7.1.2.3.4.0-3485.jar</div><div class="line">17/01/10 15:29:22 INFO Client: Uploading resource file:/tmp/spark-c2196ae2-3c1b-46e0-97dd-583cd7a240a3/__spark_conf__1393429344923620787.zip -&gt; hdfs://masternode:8020/user/zhangjiayi/.sparkStaging/application_1483512430911_0002/__spark_conf__1393429344923620787.zip</div><div class="line">17/01/10 15:29:22 INFO SecurityManager: Changing view acls to: zhangjiayi</div><div class="line">17/01/10 15:29:22 INFO SecurityManager: Changing modify acls to: zhangjiayi</div><div class="line">17/01/10 15:29:22 INFO SecurityManager: SecurityManager: authentication disabled; ui acls disabled; users with view permissions: Set(zhangjiayi); users with modify permissions: Set(zhangjiayi)</div><div class="line">17/01/10 15:29:22 INFO Client: Submitting application 2 to ResourceManager</div><div class="line">17/01/10 15:29:22 INFO YarnClientImpl: Submitted application application_1483512430911_0002</div><div class="line">17/01/10 15:29:22 INFO YarnExtensionServices: Starting Yarn extension services with app application_1483512430911_0002 and attemptId None</div><div class="line">17/01/10 15:29:22 INFO YarnHistoryService: Starting YarnHistoryService for application application_1483512430911_0002 attempt None; state=1; endpoint=http://slavenode4:8188/ws/v1/timeline/; bonded to ATS=false; listening=false; batchSize=10; flush count=0; total number queued=0, processed=0; attempted entity posts=0 successful entity posts=0 failed entity posts=0; events dropped=0; app start event received=false; app end event received=false;</div><div class="line">17/01/10 15:29:22 INFO YarnHistoryService: Spark events will be published to the Timeline service at http://slavenode4:8188/ws/v1/timeline/</div><div class="line">17/01/10 15:29:22 INFO TimelineClientImpl: Timeline service address: http://slavenode4:8188/ws/v1/timeline/</div><div class="line">17/01/10 15:29:22 INFO YarnHistoryService: History Service listening for events: YarnHistoryService for application application_1483512430911_0002 attempt None; state=1; endpoint=http://slavenode4:8188/ws/v1/timeline/; bonded to ATS=true; listening=true; batchSize=10; flush count=0; total number queued=0, processed=0; attempted entity posts=0 successful entity posts=0 failed entity posts=0; events dropped=0; app start event received=false; app end event received=false;</div><div class="line">17/01/10 15:29:22 INFO YarnExtensionServices: Service org.apache.spark.deploy.yarn.history.YarnHistoryService started</div><div class="line">17/01/10 15:29:23 INFO Client: Application report for application_1483512430911_0002 (state: ACCEPTED)</div><div class="line">17/01/10 15:29:23 INFO Client: </div><div class="line">	 client token: N/A</div><div class="line">	 diagnostics: N/A</div><div class="line">	 ApplicationMaster host: N/A</div><div class="line">	 ApplicationMaster RPC port: -1</div><div class="line">	 queue: default</div><div class="line">	 start time: 1484033362415</div><div class="line">	 final status: UNDEFINED</div><div class="line">	 tracking URL: http://slavenode3:8088/proxy/application_1483512430911_0002/</div><div class="line">	 user: zhangjiayi</div><div class="line">17/01/10 15:29:24 INFO Client: Application report for application_1483512430911_0002 (state: ACCEPTED)</div><div class="line">17/01/10 15:29:25 INFO Client: Application report for application_1483512430911_0002 (state: ACCEPTED)</div><div class="line">17/01/10 15:29:26 INFO Client: Application report for application_1483512430911_0002 (state: ACCEPTED)</div><div class="line">17/01/10 15:29:27 INFO YarnSchedulerBackend$YarnSchedulerEndpoint: ApplicationMaster registered as AkkaRpcEndpointRef(Actor[akka.tcp://sparkYarnAM@10.1.5.66:34209/user/YarnAM#-468278157])</div><div class="line">17/01/10 15:29:27 INFO YarnClientSchedulerBackend: Add WebUI Filter. org.apache.hadoop.yarn.server.webproxy.amfilter.AmIpFilter, Map(PROXY_HOSTS -&gt; slavenode3, PROXY_URI_BASES -&gt; http://slavenode3:8088/proxy/application_1483512430911_0002), /proxy/application_1483512430911_0002</div><div class="line">17/01/10 15:29:27 INFO JettyUtils: Adding filter: org.apache.hadoop.yarn.server.webproxy.amfilter.AmIpFilter</div><div class="line">17/01/10 15:29:27 INFO Client: Application report for application_1483512430911_0002 (state: RUNNING)</div><div class="line">17/01/10 15:29:27 INFO Client: </div><div class="line">	 client token: N/A</div><div class="line">	 diagnostics: N/A</div><div class="line">	 ApplicationMaster host: 10.1.5.66</div><div class="line">	 ApplicationMaster RPC port: 0</div><div class="line">	 queue: default</div><div class="line">	 start time: 1484033362415</div><div class="line">	 final status: UNDEFINED</div><div class="line">	 tracking URL: http://slavenode3:8088/proxy/application_1483512430911_0002/</div><div class="line">	 user: zhangjiayi</div><div class="line">17/01/10 15:29:27 INFO YarnClientSchedulerBackend: Application application_1483512430911_0002 has started running.</div><div class="line">17/01/10 15:29:27 INFO Utils: Successfully started service &apos;org.apache.spark.network.netty.NettyBlockTransferService&apos; on port 44133.</div><div class="line">17/01/10 15:29:27 INFO NettyBlockTransferService: Server created on 44133</div><div class="line">17/01/10 15:29:27 INFO BlockManagerMaster: Trying to register BlockManager</div><div class="line">17/01/10 15:29:27 INFO BlockManagerMasterEndpoint: Registering block manager 10.1.5.65:44133 with 530.0 MB RAM, BlockManagerId(driver, 10.1.5.65, 44133)</div><div class="line">17/01/10 15:29:27 INFO BlockManagerMaster: Registered BlockManager</div><div class="line">17/01/10 15:29:28 INFO YarnHistoryService: Application started: SparkListenerApplicationStart(SparkR,Some(application_1483512430911_0002),1484033330463,zhangjiayi,None,None)</div><div class="line">17/01/10 15:29:28 INFO YarnHistoryService: About to POST entity application_1483512430911_0002 with 3 events to timeline service http://slavenode4:8188/ws/v1/timeline/</div><div class="line">17/01/10 15:29:34 INFO YarnClientSchedulerBackend: SchedulerBackend is ready for scheduling beginning after waiting maxRegisteredResourcesWaitingTime: 30000(ms)</div><div class="line">&gt; </div><div class="line">17/01/10 15:29:35 INFO YarnClientSchedulerBackend: Registered executor: AkkaRpcEndpointRef(Actor[akka.tcp://sparkExecutor@slavenode3:41731/user/Executor#207450695]) with ID 1</div><div class="line">17/01/10 15:29:35 INFO BlockManagerMasterEndpoint: Registering block manager slavenode3:45665 with 530.0 MB RAM, BlockManagerId(1, slavenode3, 45665)</div><div class="line">17/01/10 15:29:39 INFO YarnClientSchedulerBackend: Registered executor: AkkaRpcEndpointRef(Actor[akka.tcp://sparkExecutor@slavenode2:42294/user/Executor#1616446929]) with ID 2</div><div class="line">17/01/10 15:29:39 INFO BlockManagerMasterEndpoint: Registering block manager slavenode2:42279 with 530.0 MB RAM, BlockManagerId(2, slavenode2, 42279)</div><div class="line">&gt; sqlcontext&lt;-sparkRSQL.init(sc)</div><div class="line">&gt; df&lt;-createDataFrame(sqlContext = sqlcontext,data = iris)</div><div class="line">17/01/10 15:29:54 INFO SparkContext: Starting job: collectPartitions at NativeMethodAccessorImpl.java:-2</div><div class="line">17/01/10 15:29:54 INFO DAGScheduler: Got job 0 (collectPartitions at NativeMethodAccessorImpl.java:-2) with 1 output partitions</div><div class="line">17/01/10 15:29:54 INFO DAGScheduler: Final stage: ResultStage 0(collectPartitions at NativeMethodAccessorImpl.java:-2)</div><div class="line">17/01/10 15:29:54 INFO DAGScheduler: Parents of final stage: List()</div><div class="line">17/01/10 15:29:54 INFO DAGScheduler: Missing parents: List()</div><div class="line">17/01/10 15:29:54 INFO DAGScheduler: Submitting ResultStage 0 (ParallelCollectionRDD[0] at parallelize at RRDD.scala:454), which has no missing parents</div><div class="line">17/01/10 15:30:03 INFO MemoryStore: ensureFreeSpace(1280) called with curMem=0, maxMem=555755765</div><div class="line">17/01/10 15:30:03 INFO MemoryStore: Block broadcast_0 stored as values in memory (estimated size 1280.0 B, free 530.0 MB)</div><div class="line">17/01/10 15:30:03 INFO MemoryStore: ensureFreeSpace(854) called with curMem=1280, maxMem=555755765</div><div class="line">17/01/10 15:30:03 INFO MemoryStore: Block broadcast_0_piece0 stored as bytes in memory (estimated size 854.0 B, free 530.0 MB)</div><div class="line">17/01/10 15:30:03 INFO BlockManagerInfo: Added broadcast_0_piece0 in memory on 10.1.5.65:44133 (size: 854.0 B, free: 530.0 MB)</div><div class="line">17/01/10 15:30:03 INFO SparkContext: Created broadcast 0 from broadcast at DAGScheduler.scala:861</div><div class="line">17/01/10 15:30:03 INFO DAGScheduler: Submitting 1 missing tasks from ResultStage 0 (ParallelCollectionRDD[0] at parallelize at RRDD.scala:454)</div><div class="line">17/01/10 15:30:03 INFO YarnScheduler: Adding task set 0.0 with 1 tasks</div><div class="line">17/01/10 15:30:03 INFO TaskSetManager: Starting task 0.0 in stage 0.0 (TID 0, slavenode2, PROCESS_LOCAL, 16553 bytes)</div><div class="line">17/01/10 15:30:05 INFO BlockManagerInfo: Added broadcast_0_piece0 in memory on slavenode2:42279 (size: 854.0 B, free: 530.0 MB)</div><div class="line">17/01/10 15:30:05 INFO TaskSetManager: Finished task 0.0 in stage 0.0 (TID 0) in 1661 ms on slavenode2 (1/1)</div><div class="line">17/01/10 15:30:05 INFO DAGScheduler: ResultStage 0 (collectPartitions at NativeMethodAccessorImpl.java:-2) finished in 1.786 s</div><div class="line">17/01/10 15:30:05 INFO DAGScheduler: Job 0 finished: collectPartitions at NativeMethodAccessorImpl.java:-2, took 11.381818 s</div><div class="line">17/01/10 15:30:05 INFO YarnScheduler: Removed TaskSet 0.0, whose tasks have all completed, from pool </div><div class="line">17/01/10 15:30:06 INFO YarnHistoryService: About to POST entity application_1483512430911_0002 with 10 events to timeline service http://slavenode4:8188/ws/v1/timeline/</div><div class="line">Warning messages:</div><div class="line">1: In FUN(X[[i]], ...) :</div><div class="line">  Use Sepal_Length instead of Sepal.Length  as column name</div><div class="line">2: In FUN(X[[i]], ...) :</div><div class="line">  Use Sepal_Width instead of Sepal.Width  as column name</div><div class="line">3: In FUN(X[[i]], ...) :</div><div class="line">  Use Petal_Length instead of Petal.Length  as column name</div><div class="line">4: In FUN(X[[i]], ...) :</div><div class="line">  Use Petal_Width instead of Petal.Width  as column name</div><div class="line">&gt; </div><div class="line">&gt; typeof(df)</div><div class="line">[1] &quot;S4&quot;</div><div class="line">&gt; a&lt;-&apos;sdfsd&apos;</div><div class="line">&gt; typeof(a)</div><div class="line">[1] &quot;character&quot;</div><div class="line">&gt; head(df)</div><div class="line">17/01/10 15:31:24 INFO SparkContext: Starting job: dfToCols at NativeMethodAccessorImpl.java:-2</div><div class="line">17/01/10 15:31:24 INFO DAGScheduler: Got job 1 (dfToCols at NativeMethodAccessorImpl.java:-2) with 1 output partitions</div><div class="line">17/01/10 15:31:24 INFO DAGScheduler: Final stage: ResultStage 1(dfToCols at NativeMethodAccessorImpl.java:-2)</div><div class="line">17/01/10 15:31:24 INFO DAGScheduler: Parents of final stage: List()</div><div class="line">17/01/10 15:31:24 INFO DAGScheduler: Missing parents: List()</div><div class="line">17/01/10 15:31:24 INFO DAGScheduler: Submitting ResultStage 1 (MapPartitionsRDD[4] at dfToCols at NativeMethodAccessorImpl.java:-2), which has no missing parents</div><div class="line">17/01/10 15:31:24 INFO MemoryStore: ensureFreeSpace(9176) called with curMem=2134, maxMem=555755765</div><div class="line">17/01/10 15:31:24 INFO MemoryStore: Block broadcast_1 stored as values in memory (estimated size 9.0 KB, free 530.0 MB)</div><div class="line">17/01/10 15:31:24 INFO MemoryStore: ensureFreeSpace(3690) called with curMem=11310, maxMem=555755765</div><div class="line">17/01/10 15:31:24 INFO MemoryStore: Block broadcast_1_piece0 stored as bytes in memory (estimated size 3.6 KB, free 530.0 MB)</div><div class="line">17/01/10 15:31:24 INFO BlockManagerInfo: Added broadcast_1_piece0 in memory on 10.1.5.65:44133 (size: 3.6 KB, free: 530.0 MB)</div><div class="line">17/01/10 15:31:24 INFO SparkContext: Created broadcast 1 from broadcast at DAGScheduler.scala:861</div><div class="line">17/01/10 15:31:24 INFO DAGScheduler: Submitting 1 missing tasks from ResultStage 1 (MapPartitionsRDD[4] at dfToCols at NativeMethodAccessorImpl.java:-2)</div><div class="line">17/01/10 15:31:24 INFO YarnScheduler: Adding task set 1.0 with 1 tasks</div><div class="line">17/01/10 15:31:24 INFO TaskSetManager: Starting task 0.0 in stage 1.0 (TID 1, slavenode3, PROCESS_LOCAL, 16553 bytes)</div><div class="line">17/01/10 15:31:24 INFO BlockManagerInfo: Added broadcast_1_piece0 in memory on slavenode3:45665 (size: 3.6 KB, free: 530.0 MB)</div><div class="line">17/01/10 15:31:35 WARN TaskSetManager: Lost task 0.0 in stage 1.0 (TID 1, slavenode3): java.net.SocketTimeoutException: Accept timed out</div><div class="line">	at java.net.PlainSocketImpl.socketAccept(Native Method)</div><div class="line">	at java.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:409)</div><div class="line">	at java.net.ServerSocket.implAccept(ServerSocket.java:545)</div><div class="line">	at java.net.ServerSocket.accept(ServerSocket.java:513)</div><div class="line">	at org.apache.spark.api.r.RRDD$.createRWorker(RRDD.scala:426)</div><div class="line">	at org.apache.spark.api.r.BaseRRDD.compute(RRDD.scala:62)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:66)</div><div class="line">	at org.apache.spark.scheduler.Task.run(Task.scala:88)</div><div class="line">	at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:214)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div><div class="line"></div><div class="line">17/01/10 15:31:35 INFO TaskSetManager: Starting task 0.1 in stage 1.0 (TID 2, slavenode2, PROCESS_LOCAL, 16553 bytes)</div><div class="line">17/01/10 15:31:35 INFO BlockManagerInfo: Added broadcast_1_piece0 in memory on slavenode2:42279 (size: 3.6 KB, free: 530.0 MB)</div><div class="line">17/01/10 15:31:37 WARN TaskSetManager: Lost task 0.1 in stage 1.0 (TID 2, slavenode2): java.io.IOException: Cannot run program &quot;Rscript&quot;: error=13, Permission denied</div><div class="line">	at java.lang.ProcessBuilder.start(ProcessBuilder.java:1048)</div><div class="line">	at org.apache.spark.api.r.RRDD$.createRProcess(RRDD.scala:407)</div><div class="line">	at org.apache.spark.api.r.RRDD$.createRWorker(RRDD.scala:423)</div><div class="line">	at org.apache.spark.api.r.BaseRRDD.compute(RRDD.scala:62)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:66)</div><div class="line">	at org.apache.spark.scheduler.Task.run(Task.scala:88)</div><div class="line">	at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:214)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div><div class="line">Caused by: java.io.IOException: error=13, Permission denied</div><div class="line">	at java.lang.UNIXProcess.forkAndExec(Native Method)</div><div class="line">	at java.lang.UNIXProcess.&lt;init&gt;(UNIXProcess.java:248)</div><div class="line">	at java.lang.ProcessImpl.start(ProcessImpl.java:134)</div><div class="line">	at java.lang.ProcessBuilder.start(ProcessBuilder.java:1029)</div><div class="line">	... 20 more</div><div class="line"></div><div class="line">17/01/10 15:31:37 INFO TaskSetManager: Starting task 0.2 in stage 1.0 (TID 3, slavenode3, PROCESS_LOCAL, 16553 bytes)</div><div class="line">17/01/10 15:31:47 WARN TaskSetManager: Lost task 0.2 in stage 1.0 (TID 3, slavenode3): java.net.SocketTimeoutException: Accept timed out</div><div class="line">	at java.net.PlainSocketImpl.socketAccept(Native Method)</div><div class="line">	at java.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:409)</div><div class="line">	at java.net.ServerSocket.implAccept(ServerSocket.java:545)</div><div class="line">	at java.net.ServerSocket.accept(ServerSocket.java:513)</div><div class="line">	at org.apache.spark.api.r.RRDD$.createRWorker(RRDD.scala:426)</div><div class="line">	at org.apache.spark.api.r.BaseRRDD.compute(RRDD.scala:62)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:66)</div><div class="line">	at org.apache.spark.scheduler.Task.run(Task.scala:88)</div><div class="line">	at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:214)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div><div class="line"></div><div class="line">17/01/10 15:31:47 INFO TaskSetManager: Starting task 0.3 in stage 1.0 (TID 4, slavenode2, PROCESS_LOCAL, 16553 bytes)</div><div class="line">17/01/10 15:31:47 WARN TaskSetManager: Lost task 0.3 in stage 1.0 (TID 4, slavenode2): java.io.IOException: Cannot run program &quot;Rscript&quot;: error=13, Permission denied</div><div class="line">	at java.lang.ProcessBuilder.start(ProcessBuilder.java:1048)</div><div class="line">	at org.apache.spark.api.r.RRDD$.createRProcess(RRDD.scala:407)</div><div class="line">	at org.apache.spark.api.r.RRDD$.createRWorker(RRDD.scala:423)</div><div class="line">	at org.apache.spark.api.r.BaseRRDD.compute(RRDD.scala:62)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:66)</div><div class="line">	at org.apache.spark.scheduler.Task.run(Task.scala:88)</div><div class="line">	at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:214)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div><div class="line">Caused by: java.io.IOException: error=13, Permission denied</div><div class="line">	at java.lang.UNIXProcess.forkAndExec(Native Method)</div><div class="line">	at java.lang.UNIXProcess.&lt;init&gt;(UNIXProcess.java:248)</div><div class="line">	at java.lang.ProcessImpl.start(ProcessImpl.java:134)</div><div class="line">	at java.lang.ProcessBuilder.start(ProcessBuilder.java:1029)</div><div class="line">	... 20 more</div><div class="line"></div><div class="line">17/01/10 15:31:47 ERROR TaskSetManager: Task 0 in stage 1.0 failed 4 times; aborting job</div><div class="line">17/01/10 15:31:47 INFO YarnScheduler: Removed TaskSet 1.0, whose tasks have all completed, from pool </div><div class="line">17/01/10 15:31:47 INFO YarnScheduler: Cancelling stage 1</div><div class="line">17/01/10 15:31:47 INFO DAGScheduler: ResultStage 1 (dfToCols at NativeMethodAccessorImpl.java:-2) failed in 23.005 s</div><div class="line">17/01/10 15:31:47 INFO DAGScheduler: Job 1 failed: dfToCols at NativeMethodAccessorImpl.java:-2, took 23.056582 s</div><div class="line">17/01/10 15:31:47 ERROR RBackendHandler: dfToCols on org.apache.spark.sql.api.r.SQLUtils failed</div><div class="line">17/01/10 15:31:47 INFO YarnHistoryService: About to POST entity application_1483512430911_0002 with 10 events to timeline service http://slavenode4:8188/ws/v1/timeline/</div><div class="line">Error in invokeJava(isStatic = TRUE, className, methodName, ...) : </div><div class="line">  org.apache.spark.SparkException: Job aborted due to stage failure: Task 0 in stage 1.0 failed 4 times, most recent failure: Lost task 0.3 in stage 1.0 (TID 4, slavenode2): java.io.IOException: Cannot run program &quot;Rscript&quot;: error=13, Permission denied</div><div class="line">	at java.lang.ProcessBuilder.start(ProcessBuilder.java:1048)</div><div class="line">	at org.apache.spark.api.r.RRDD$.createRProcess(RRDD.scala:407)</div><div class="line">	at org.apache.spark.api.r.RRDD$.createRWorker(RRDD.scala:423)</div><div class="line">	at org.apache.spark.api.r.BaseRRDD.compute(RRDD.scala:62)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD</div><div class="line">17/01/10 16:30:49 INFO ContextCleaner: Cleaned accumulator 1</div><div class="line">17/01/10 16:30:49 INFO BlockManagerInfo: Removed broadcast_1_piece0 on slavenode3:45665 in memory (size: 3.6 KB, free: 530.0 MB)</div><div class="line">17/01/10 16:30:49 INFO BlockManagerInfo: Removed broadcast_1_piece0 on slavenode2:42279 in memory (size: 3.6 KB, free: 530.0 MB)</div><div class="line">17/01/10 16:30:49 INFO BlockManagerInfo: Removed broadcast_1_piece0 on 10.1.5.65:44133 in memory (size: 3.6 KB, free: 530.0 MB)</div><div class="line">17/01/10 16:30:49 INFO ContextCleaner: Cleaned accumulator 2</div><div class="line">17/01/10 16:30:49 INFO BlockManagerInfo: Removed broadcast_0_piece0 on 10.1.5.65:44133 in memory (size: 854.0 B, free: 530.0 MB)</div><div class="line">17/01/10 16:30:49 INFO BlockManagerInfo: Removed broadcast_0_piece0 on slavenode2:42279 in memory (size: 854.0 B, free: 530.0 MB)</div></pre></td></tr></table></figure>
<p>搜了一下没有理想答案，所以只能看源码了,下面是报错的代码位置：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">createRProcess</span></span>(port: <span class="type">Int</span>, script: <span class="type">String</span>): <span class="type">BufferedStreamThread</span> = &#123;</div><div class="line">    <span class="comment">// "spark.sparkr.r.command" is deprecated and replaced by "spark.r.command",</span></div><div class="line">    <span class="comment">// but kept here for backward compatibility.</span></div><div class="line">    <span class="keyword">val</span> sparkConf = <span class="type">SparkEnv</span>.get.conf</div><div class="line">    <span class="keyword">var</span> rCommand = sparkConf.get(<span class="string">"spark.sparkr.r.command"</span>, <span class="string">"Rscript"</span>)</div><div class="line">    rCommand = sparkConf.get(<span class="string">"spark.r.command"</span>, rCommand)</div><div class="line"></div><div class="line">    <span class="keyword">val</span> rOptions = <span class="string">"--vanilla"</span></div><div class="line">    <span class="keyword">val</span> rLibDir = <span class="type">RUtils</span>.sparkRPackagePath(isDriver = <span class="literal">false</span>)</div><div class="line">    <span class="keyword">val</span> rExecScript = rLibDir(<span class="number">0</span>) + <span class="string">"/SparkR/worker/"</span> + script</div><div class="line">    print(rCommand)</div><div class="line">    print(rOptions)</div><div class="line">    print(rExecScript)</div><div class="line">    <span class="keyword">val</span> pb = <span class="keyword">new</span> <span class="type">ProcessBuilder</span>(<span class="type">Arrays</span>.asList(rCommand, rOptions, rExecScript))</div><div class="line">    <span class="comment">// Unset the R_TESTS environment variable for workers.</span></div><div class="line">    <span class="comment">// This is set by R CMD check as startup.Rs</span></div><div class="line">    <span class="comment">// (http://svn.r-project.org/R/trunk/src/library/tools/R/testing.R)</span></div><div class="line">    <span class="comment">// and confuses worker script which tries to load a non-existent file</span></div><div class="line">    pb.environment().put(<span class="string">"R_TESTS"</span>, <span class="string">""</span>)</div><div class="line">    pb.environment().put(<span class="string">"SPARKR_RLIBDIR"</span>, rLibDir.mkString(<span class="string">","</span>))</div><div class="line">    pb.environment().put(<span class="string">"SPARKR_WORKER_PORT"</span>, port.toString)</div><div class="line">    pb.redirectErrorStream(<span class="literal">true</span>)  <span class="comment">// redirect stderr into stdout</span></div><div class="line">    <span class="keyword">val</span> proc = pb.start()</div><div class="line">    <span class="keyword">val</span> errThread = startStdoutThread(proc)</div><div class="line">    errThread</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>上面的print语句是我加上去的。</p>
<p>忘了一个前置条件，使用sparkR的时候不指定master，也就是local模式的话是可以成功的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line">&gt;sc&lt;-sparkR.init()</div><div class="line">Launching java with spark-submit command spark-submit   sparkr-shell /tmp/RtmpRKsp2x/backend_port306c2e180534 </div><div class="line">17/01/10 18:20:53 INFO SparkContext: Running Spark version 1.5.2</div><div class="line">17/01/10 18:20:54 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable</div><div class="line">17/01/10 18:20:54 INFO SecurityManager: Changing view acls to: zhangjiayi</div><div class="line">17/01/10 18:20:54 INFO SecurityManager: Changing modify acls to: zhangjiayi</div><div class="line">17/01/10 18:20:54 INFO SecurityManager: SecurityManager: authentication disabled; ui acls disabled; users with view permissions: Set(zhangjiayi); users with modify permissions: Set(zhangjiayi)</div><div class="line">17/01/10 18:20:59 INFO Slf4jLogger: Slf4jLogger started</div><div class="line">17/01/10 18:20:59 INFO Remoting: Starting remoting</div><div class="line">17/01/10 18:21:01 INFO Remoting: Remoting started; listening on addresses :[akka.tcp://sparkDriver@10.1.5.65:45017]</div><div class="line">17/01/10 18:21:01 INFO Utils: Successfully started service &apos;sparkDriver&apos; on port 45017.</div><div class="line">17/01/10 18:21:01 INFO SparkEnv: Registering MapOutputTracker</div><div class="line">17/01/10 18:21:02 INFO SparkEnv: Registering BlockManagerMaster</div><div class="line">17/01/10 18:21:02 INFO DiskBlockManager: Created local directory at /tmp/blockmgr-a7f2bf0d-c363-4220-ade9-5210fe54f9f7</div><div class="line">17/01/10 18:21:03 INFO MemoryStore: MemoryStore started with capacity 530.0 MB</div><div class="line">17/01/10 18:21:03 INFO HttpFileServer: HTTP File server directory is /tmp/spark-d5f07559-6482-4523-aa40-8b99b7fbc84b/httpd-00d9c253-b8f8-41c2-ae1e-ad5bac726bf1</div><div class="line">17/01/10 18:21:03 INFO HttpServer: Starting HTTP Server</div><div class="line">17/01/10 18:21:04 INFO Server: jetty-8.y.z-SNAPSHOT</div><div class="line">17/01/10 18:21:04 INFO AbstractConnector: Started SocketConnector@0.0.0.0:35349</div><div class="line">17/01/10 18:21:04 INFO Utils: Successfully started service &apos;HTTP file server&apos; on port 35349.</div><div class="line">17/01/10 18:21:04 INFO SparkEnv: Registering OutputCommitCoordinator</div><div class="line">17/01/10 18:21:05 INFO Server: jetty-8.y.z-SNAPSHOT</div><div class="line">17/01/10 18:21:05 INFO AbstractConnector: Started SelectChannelConnector@0.0.0.0:4040</div><div class="line">17/01/10 18:21:05 INFO Utils: Successfully started service &apos;SparkUI&apos; on port 4040.</div><div class="line">17/01/10 18:21:05 INFO SparkUI: Started SparkUI at http://10.1.5.65:4040</div><div class="line">17/01/10 18:21:05 WARN MetricsSystem: Using default name DAGScheduler for source because spark.app.id is not set.</div><div class="line">17/01/10 18:21:05 INFO Executor: Starting executor ID driver on host localhost</div><div class="line">17/01/10 18:21:05 INFO Utils: Successfully started service &apos;org.apache.spark.network.netty.NettyBlockTransferService&apos; on port 38751.</div><div class="line">17/01/10 18:21:05 INFO NettyBlockTransferService: Server created on 38751</div><div class="line">17/01/10 18:21:05 INFO BlockManagerMaster: Trying to register BlockManager</div><div class="line">17/01/10 18:21:05 INFO BlockManagerMasterEndpoint: Registering block manager localhost:38751 with 530.0 MB RAM, BlockManagerId(driver, localhost, 38751)</div><div class="line">17/01/10 18:21:05 INFO BlockManagerMaster: Registered BlockManager</div><div class="line">&gt; </div><div class="line">&gt; sqlcontext&lt;-sparkRSQL.init(sc)sc</div><div class="line">Error: unexpected symbol in &quot;sqlcontext&lt;-sparkRSQL.init(sc)sc&quot;</div><div class="line">&gt; sqlcontext&lt;-sparkRSQL.init(sc)</div><div class="line">&gt; df&lt;-createDataFrame(sqlContext = sqlcontext,data = iris)</div><div class="line">17/01/10 18:23:34 INFO SparkContext: Starting job: collectPartitions at NativeMethodAccessorImpl.java:-2</div><div class="line">17/01/10 18:23:34 INFO DAGScheduler: Got job 0 (collectPartitions at NativeMethodAccessorImpl.java:-2) with 1 output partitions</div><div class="line">17/01/10 18:23:34 INFO DAGScheduler: Final stage: ResultStage 0(collectPartitions at NativeMethodAccessorImpl.java:-2)</div><div class="line">17/01/10 18:23:34 INFO DAGScheduler: Parents of final stage: List()</div><div class="line">17/01/10 18:23:34 INFO DAGScheduler: Missing parents: List()</div><div class="line">17/01/10 18:23:34 INFO DAGScheduler: Submitting ResultStage 0 (ParallelCollectionRDD[0] at parallelize at RRDD.scala:454), which has no missing parents</div><div class="line">17/01/10 18:23:35 INFO MemoryStore: ensureFreeSpace(1280) called with curMem=0, maxMem=555755765</div><div class="line">17/01/10 18:23:35 INFO MemoryStore: Block broadcast_0 stored as values in memory (estimated size 1280.0 B, free 530.0 MB)</div><div class="line">17/01/10 18:23:35 INFO MemoryStore: ensureFreeSpace(854) called with curMem=1280, maxMem=555755765</div><div class="line">17/01/10 18:23:35 INFO MemoryStore: Block broadcast_0_piece0 stored as bytes in memory (estimated size 854.0 B, free 530.0 MB)</div><div class="line">17/01/10 18:23:35 INFO BlockManagerInfo: Added broadcast_0_piece0 in memory on localhost:38751 (size: 854.0 B, free: 530.0 MB)</div><div class="line">17/01/10 18:23:35 INFO SparkContext: Created broadcast 0 from broadcast at DAGScheduler.scala:861</div><div class="line">17/01/10 18:23:35 INFO DAGScheduler: Submitting 1 missing tasks from ResultStage 0 (ParallelCollectionRDD[0] at parallelize at RRDD.scala:454)</div><div class="line">17/01/10 18:23:35 INFO TaskSchedulerImpl: Adding task set 0.0 with 1 tasks</div><div class="line">17/01/10 18:23:36 INFO TaskSetManager: Starting task 0.0 in stage 0.0 (TID 0, localhost, PROCESS_LOCAL, 16553 bytes)</div><div class="line">17/01/10 18:23:36 INFO Executor: Running task 0.0 in stage 0.0 (TID 0)</div><div class="line">17/01/10 18:23:36 INFO Executor: Finished task 0.0 in stage 0.0 (TID 0). 15464 bytes result sent to driver</div><div class="line">17/01/10 18:23:36 INFO TaskSetManager: Finished task 0.0 in stage 0.0 (TID 0) in 249 ms on localhost (1/1)</div><div class="line">17/01/10 18:23:36 INFO TaskSchedulerImpl: Removed TaskSet 0.0, whose tasks have all completed, from pool </div><div class="line">17/01/10 18:23:36 INFO DAGScheduler: ResultStage 0 (collectPartitions at NativeMethodAccessorImpl.java:-2) finished in 0.300 s</div><div class="line">17/01/10 18:23:36 INFO DAGScheduler: Job 0 finished: collectPartitions at NativeMethodAccessorImpl.java:-2, took 1.618354 s</div><div class="line">Warning messages:</div><div class="line">1: In FUN(X[[i]], ...) :</div><div class="line">  Use Sepal_Length instead of Sepal.Length  as column name</div><div class="line">2: In FUN(X[[i]], ...) :</div><div class="line">  Use Sepal_Width instead of Sepal.Width  as column name</div><div class="line">3: In FUN(X[[i]], ...) :</div><div class="line">  Use Petal_Length instead of Petal.Length  as column name</div><div class="line">4: In FUN(X[[i]], ...) :</div><div class="line">  Use Petal_Width instead of Petal.Width  as column name</div><div class="line">&gt; </div><div class="line">&gt; head(df)</div><div class="line">17/01/10 18:23:45 INFO SparkContext: Starting job: dfToCols at NativeMethodAccessorImpl.java:-2</div><div class="line">17/01/10 18:23:45 INFO DAGScheduler: Got job 1 (dfToCols at NativeMethodAccessorImpl.java:-2) with 1 output partitions</div><div class="line">17/01/10 18:23:45 INFO DAGScheduler: Final stage: ResultStage 1(dfToCols at NativeMethodAccessorImpl.java:-2)</div><div class="line">17/01/10 18:23:45 INFO DAGScheduler: Parents of final stage: List()</div><div class="line">17/01/10 18:23:45 INFO DAGScheduler: Missing parents: List()</div><div class="line">17/01/10 18:23:45 INFO DAGScheduler: Submitting ResultStage 1 (MapPartitionsRDD[4] at dfToCols at NativeMethodAccessorImpl.java:-2), which has no missing parents</div><div class="line">17/01/10 18:23:45 INFO MemoryStore: ensureFreeSpace(9176) called with curMem=2134, maxMem=555755765</div><div class="line">17/01/10 18:23:45 INFO MemoryStore: Block broadcast_1 stored as values in memory (estimated size 9.0 KB, free 530.0 MB)</div><div class="line">17/01/10 18:23:45 INFO MemoryStore: ensureFreeSpace(3690) called with curMem=11310, maxMem=555755765</div><div class="line">17/01/10 18:23:45 INFO MemoryStore: Block broadcast_1_piece0 stored as bytes in memory (estimated size 3.6 KB, free 530.0 MB)</div><div class="line">17/01/10 18:23:45 INFO BlockManagerInfo: Added broadcast_1_piece0 in memory on localhost:38751 (size: 3.6 KB, free: 530.0 MB)</div><div class="line">17/01/10 18:23:45 INFO SparkContext: Created broadcast 1 from broadcast at DAGScheduler.scala:861</div><div class="line">17/01/10 18:23:45 INFO DAGScheduler: Submitting 1 missing tasks from ResultStage 1 (MapPartitionsRDD[4] at dfToCols at NativeMethodAccessorImpl.java:-2)</div><div class="line">17/01/10 18:23:45 INFO TaskSchedulerImpl: Adding task set 1.0 with 1 tasks</div><div class="line">17/01/10 18:23:45 INFO TaskSetManager: Starting task 0.0 in stage 1.0 (TID 1, localhost, PROCESS_LOCAL, 16553 bytes)</div><div class="line">17/01/10 18:23:45 INFO Executor: Running task 0.0 in stage 1.0 (TID 1)</div><div class="line">17/01/10 18:23:51 INFO Executor: Finished task 0.0 in stage 1.0 (TID 1). 1794 bytes result sent to driver</div><div class="line">17/01/10 18:23:51 INFO DAGScheduler: ResultStage 1 (dfToCols at NativeMethodAccessorImpl.java:-2) finished in 5.469 s</div><div class="line">17/01/10 18:23:51 INFO DAGScheduler: Job 1 finished: dfToCols at NativeMethodAccessorImpl.java:-2, took 5.493984 s</div><div class="line">17/01/10 18:23:51 INFO TaskSetManager: Finished task 0.0 in stage 1.0 (TID 1) in 5468 ms on localhost (1/1)</div><div class="line">17/01/10 18:23:51 INFO TaskSchedulerImpl: Removed TaskSet 1.0, whose tasks have all completed, from pool </div><div class="line">  Sepal_Length Sepal_Width Petal_Length Petal_Width Species</div><div class="line">1          5.1         3.5          1.4         0.2  setosa</div><div class="line">2          4.9         3.0          1.4         0.2  setosa</div><div class="line">3          4.7         3.2          1.3         0.2  setosa</div><div class="line">4          4.6         3.1          1.5         0.2  setosa</div><div class="line">5          5.0         3.6          1.4         0.2  setosa</div><div class="line">6          5.4         3.9          1.7         0.4  setosa</div></pre></td></tr></table></figure></p>
<p>单机 :<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-----------will---------------------will mid----------zhangjiayi</div><div class="line">-----------will-end----------rCommand is : RscriptrOptions is : --vanillarExecScript is : /usr/hdp/2.3.4.0-3485/spark/R/lib/SparkR/worker/daemon.R</div></pre></td></tr></table></figure></p>
<p>用户是zhangjiayi ,<br>执行的系统xi</p>
<p>集群是打印在yarn的container的stdout里的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">-----------will---------------------will mid----------yarn</div><div class="line">-----------will-end----------rCommand is : RscriptrOptions is : --vanillarExecScript is : /server/hadoop/yarn/local/usercache/zhangjiayi/appcache/application_1483512430911_0006/container_e18_1483512430911_0006_01_000002/sparkr/SparkR/worker/daemon.R-----------will---------------------will mid----------yarn</div><div class="line">-----------will-end----------rCommand is : RscriptrOptions is : --vanillarExecScript is : /server/hadoop/yarn/local/usercache/zhangjiayi/appcache/application_1483512430911_0006/container_e18_1483512430911_0006_01_000002/sparkr/SparkR/worker/daemon.R</div></pre></td></tr></table></figure></p>
<p>结果找不到：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@slavenode5 ~]# ll /server/hadoop/yarn/local/usercache/zhangjiayi/appcache/application_1483512430911_0006/container_e18_1483512430911_0006_01_000002/sparkr/SparkR/worker/daemon.R</div><div class="line">ls: cannot access /server/hadoop/yarn/local/usercache/zhangjiayi/appcache/application_1483512430911_0006/container_e18_1483512430911_0006_01_000002/sparkr/SparkR/worker/daemon.R: No such file or directory</div><div class="line">[root@slavenode5 ~]# ll /server/hadoop/yarn/local/usercache/zhangjiayi/appcache/application_1483512430911_0006/container_e18_1483512430911_0006_01_000002/sparkr/SparkR/worker/daemon.R</div><div class="line">ls: cannot access /server/hadoop/yarn/local/usercache/zhangjiayi/appcache/application_1483512430911_0006/container_e18_1483512430911_0006_01_000002/sparkr/SparkR/worker/daemon.R: No such file or directory</div><div class="line">[root@slavenode5 ~]# ll /server/hadoop/yarn/local/usercache/zhangjiayi/appcache/application_1483512430911_0006/container_e18_1483512430911_0006_01_000002/</div><div class="line">total 24</div><div class="line">-rw-r--r--. 1 yarn hadoop   88 Jan 11 12:25 container_tokens</div><div class="line">-rwx------. 1 yarn hadoop  687 Jan 11 12:25 default_container_executor_session.sh</div><div class="line">-rwx------. 1 yarn hadoop  741 Jan 11 12:25 default_container_executor.sh</div><div class="line">-rwx------. 1 yarn hadoop 4042 Jan 11 12:25 launch_container.sh</div><div class="line">lrwxrwxrwx. 1 yarn hadoop  122 Jan 11 12:25 __spark__.jar -&gt; /server/hadoop/yarn/local/usercache/zhangjiayi/filecache/19/spark-assembly-1.5.2.2.3.4.0-3485-hadoop2.7.1.2.3.4.0-3485.jar</div><div class="line">drwx--x---. 2 yarn hadoop 4096 Jan 11 12:25 tmp</div></pre></td></tr></table></figure></p>
<p>此时控制台的报错只有：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">17/01/11 12:25:42 INFO TaskSetManager: Starting task 0.2 in stage 1.0 (TID 3, slavenode5, PROCESS_LOCAL, 16553 bytes)</div><div class="line">17/01/11 12:25:52 WARN TaskSetManager: Lost task 0.2 in stage 1.0 (TID 3, slavenode5): java.net.SocketTimeoutException: Accept timed out</div><div class="line">	at java.net.PlainSocketImpl.socketAccept(Native Method)</div><div class="line">	at java.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:409)</div><div class="line">	at java.net.ServerSocket.implAccept(ServerSocket.java:545)</div><div class="line">	at java.net.ServerSocket.accept(ServerSocket.java:513)</div><div class="line">	at org.apache.spark.api.r.RRDD$.createRWorker(RRDD.scala:446)</div><div class="line">	at org.apache.spark.api.r.BaseRRDD.compute(RRDD.scala:62)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:66)</div><div class="line">	at org.apache.spark.scheduler.Task.run(Task.scala:88)</div><div class="line">	at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:214)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div><div class="line">17/01/11 12:25:52 INFO TaskSetManager: Starting task 0.3 in stage 1.0 (TID 4, slavenode1, PROCESS_LOCAL, 16553 bytes)</div><div class="line">17/01/11 12:26:02 WARN TaskSetManager: Lost task 0.3 in stage 1.0 (TID 4, slavenode1): java.net.SocketTimeoutException: Accept timed out</div><div class="line">	at java.net.PlainSocketImpl.socketAccept(Native Method)</div><div class="line">	at java.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:409)</div><div class="line">	at java.net.ServerSocket.implAccept(ServerSocket.java:545)</div><div class="line">	at java.net.ServerSocket.accept(ServerSocket.java:513)</div><div class="line">	at org.apache.spark.api.r.RRDD$.createRWorker(RRDD.scala:446)</div><div class="line">	at org.apache.spark.api.r.BaseRRDD.compute(RRDD.scala:62)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:66)</div><div class="line">	at org.apache.spark.scheduler.Task.run(Task.scala:88)</div><div class="line">	at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:214)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div><div class="line"></div><div class="line">17/01/11 12:26:02 ERROR TaskSetManager: Task 0 in stage 1.0 failed 4 times; aborting job</div><div class="line">17/01/11 12:26:02 INFO YarnScheduler: Removed TaskSet 1.0, whose tasks have all completed, from pool </div><div class="line">17/01/11 12:26:02 INFO YarnScheduler: Cancelling stage 1</div><div class="line">17/01/11 12:26:02 INFO DAGScheduler: ResultStage 1 (dfToCols at NativeMethodAccessorImpl.java:-2) failed in 42.286 s</div><div class="line">17/01/11 12:26:02 INFO DAGScheduler: Job 1 failed: dfToCols at NativeMethodAccessorImpl.java:-2, took 42.314808 s</div><div class="line">17/01/11 12:26:02 ERROR RBackendHandler: dfToCols on org.apache.spark.sql.api.r.SQLUtils failed</div><div class="line">Error in invokeJava(isStatic = TRUE, className, methodName, ...) : </div><div class="line">  org.apache.spark.SparkException: Job aborted due to stage failure: Task 0 in stage 1.0 failed 4 times, most recent failure: Lost task 0.3 in stage 1.0 (TID 4, slavenode1): java.net.SocketTimeoutException: Accept timed out</div><div class="line">	at java.net.PlainSocketImpl.socketAccept(Native Method)</div><div class="line">	at java.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:409)</div><div class="line">	at java.net.ServerSocket.implAccept(ServerSocket.java:545)</div><div class="line">	at java.net.ServerSocket.accept(ServerSocket.java:513)</div><div class="line">	at org.apache.spark.api.r.RRDD$.createRWorker(RRDD.scala:446)</div><div class="line">	at org.apache.spark.api.r.BaseRRDD.compute(RRDD.scala:62)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div></pre></td></tr></table></figure>
<p>可以看到是createRWorker里而不是createRProcess报错了。。</p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">Launching java with command  /server/java/jdk1.8.0_60/bin/java   -Xmx512m -cp &apos;/usr/lib64/R/library/SparkR/sparkr-assembly-0.1.jar:&apos; edu.berkeley.cs.amplab.sparkr.SparkRBackend /tmp/Rtmp34rELP/backend_port4e6c126d914 </div><div class="line">createSparkContext on edu.berkeley.cs.amplab.sparkr.RRDD failed with java.lang.NullPointerException</div><div class="line">java.lang.NullPointerException</div><div class="line">	at edu.berkeley.cs.amplab.sparkr.SparkRBackendHandler.handleMethodCall(SparkRBackendHandler.scala:111)</div><div class="line">	at edu.berkeley.cs.amplab.sparkr.SparkRBackendHandler.channelRead0(SparkRBackendHandler.scala:58)</div><div class="line">	at edu.berkeley.cs.amplab.sparkr.SparkRBackendHandler.channelRead0(SparkRBackendHandler.scala:19)</div><div class="line">	at io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:105)</div><div class="line">	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:308)</div><div class="line">	at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:294)</div><div class="line">	at io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:103)</div><div class="line">	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:308)</div><div class="line">	at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:294)</div><div class="line">	at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:244)</div><div class="line">	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:308)</div><div class="line">	at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:294)</div><div class="line">	at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:846)</div><div class="line">	at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:131)</div><div class="line">	at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:511)</div><div class="line">	at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:468)</div><div class="line">	at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:382)</div><div class="line">	at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:354)</div><div class="line">	at io.netty.util.concurrent.SingleThreadEventExecutor$2.run(SingleThreadEventExecutor.java:111)</div><div class="line">	at io.netty.util.concurrent.DefaultThreadFactory$DefaultRunnableDecorator.run(DefaultThreadFactory.java:137)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[R]]></title>
      <url>/2017/01/09/R/</url>
      <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">library(SparkR)</div><div class="line">library(tseries)</div><div class="line">library(forecast)</div><div class="line">library(magrittr)</div><div class="line"></div><div class="line">sc&lt;-sparkR.init()</div><div class="line">hivecontext&lt;-sparkRHive.init(sc)</div><div class="line">sqlcontext&lt;-sparkRSQL.init(sc)</div><div class="line"></div><div class="line">dateline&lt;-seq.Date(from = as.Date(&quot;2015-05-01&quot;),to=as.Date(&quot;2017-01-04&quot;),by=&quot;day&quot;)%&gt;%data.frame(.)</div><div class="line">colnames(dateline)&lt;-&quot;log_day&quot;</div><div class="line">dateline&lt;-createDataFrame(sqlContext=sqlcontext,data=dateline)</div><div class="line">registerTempTable(dateline,&quot;premium_date&quot;)</div><div class="line">  </div><div class="line"></div><div class="line">#  Query the premium log of the users who are still remained for 30d and not labeled as brush.</div><div class="line">z0&lt;-&quot;select	a.userid,</div><div class="line">		          from_unixtime(unix_timestamp(c.log_day,&apos;yyyyMMdd&apos;),&apos;yyyy-MM-dd&apos;) as log_day,</div><div class="line">              c.premium_final</div><div class="line">from dim_jlc.dim_user_info a</div><div class="line">left join app_jlc.brush_user b on a.userid=b.userid and b.log_day=&apos;2017-01-04&apos;</div><div class="line">left join fact_jlc.premium_record c on a.userid=c.userid</div><div class="line">where b.userid is null and datediff(&apos;2017-01-04&apos;,to_date(a.invest1st_time))&gt;30&quot;</div><div class="line"></div><div class="line">z1&lt;-&quot;select	a.userid,</div><div class="line">		to_date(a.invest1st_time) as invest1st_day</div><div class="line">from dim_jlc.dim_user_info a</div><div class="line">left join app_jlc.brush_user b on a.userid=b.userid</div><div class="line">where b.userid is null and datediff(&apos;2017-01-04&apos;,to_date(a.invest1st_time))&gt;30&quot;</div><div class="line"></div><div class="line">result&lt;-sql(hivecontext,z0)</div><div class="line">userinfo&lt;-sql(hivecontext,z1)</div><div class="line">colnames(result)&lt;-c(&quot;userid&quot;,&quot;log_day&quot;,&quot;premium&quot;)</div><div class="line">cache(result)</div><div class="line">cache(userinfo)</div><div class="line"></div><div class="line">user_num&lt;-dim(userinfo)[1]</div><div class="line">for(i in 1:user_num)&#123;</div><div class="line">  userid&lt;-</div><div class="line">  start_day&lt;-select(userinfo,&quot;invest1st_day&quot;)</div><div class="line">  dateline&lt;-seq()</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">#rawdata&lt;-fread(&quot;raw0104.csv&quot;)</div><div class="line">#rawdata_df&lt;-tbl_df(rawdata)</div><div class="line">#colnames(rawdata_df)&lt;-c(&quot;userid&quot;,&quot;log_day&quot;,&quot;premium&quot;)</div><div class="line"></div><div class="line">userinfo_df&lt;-collect(userinfo)</div><div class="line">userinfo_df&lt;-tbl_df(userinfo_df)</div></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[rancher上手与问题]]></title>
      <url>/2017/01/02/rancher%E4%B8%8A%E6%89%8B%E4%B8%8E%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<ol>
<li>rancher里的host能不能同时属于env1和env2，测试了一下，貌似一个host上只能启动一个agent。</li>
</ol>
<p>先把host1和host2添加到env1后，添加了wordpress的service stack，之后将所有服务都停掉，并deactivate两个hosts。</p>
<p>新建env2，将host1、host2同样的方法添加到env2中，布置mesos集群。</p>
<p>此时切回env1，再去激活host，发现已经不行了，host上提示disconnected。查看下面的container里，是有rancher agent的。有可能这个agent是在env2的那个把，所以不能连接到env1。</p>
<p>那：就是不能同时属于两个env咯？</p>
<ol>
<li>遇到get ip timeout问题，一般升级这个组件的版本就可以了</li>
<li>如果我们升级了某个组件的版本，再去调整这个组件的scale，它竟然会先自动降级，然后再调整scale。然后版本就<strong>又恢复成低版本</strong>的了。 Orz….</li>
<li></li>
</ol>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[saltstack自动化运维实施（二）]]></title>
      <url>/2016/12/30/saltstack%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E5%AE%9E%E6%96%BD%EF%BC%88%E4%BA%8C%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>我们安装saltstack的痛点在于文件同步，与分布式命令执行。</p>
<p>这一章我们弄一下文件同步的事情.<br>编辑master的配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">file_recv: True</div></pre></td></tr></table></figure></p>
<p>重启master。</p>
<p>从一个minion向master推送一个文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure></p>
<p>参考： </p>
<ul>
<li><a href="http://docs.saltstack.cn/ref/file_server/all/index.html" target="_blank" rel="external">http://docs.saltstack.cn/ref/file_server/all/index.html</a></li>
<li><a href="http://docs.saltstack.cn/ref/file_server/all/salt.fileserver.minionfs.html#module-salt.fileserver.minionfs" target="_blank" rel="external">http://docs.saltstack.cn/ref/file_server/all/salt.fileserver.minionfs.html#module-salt.fileserver.minionfs</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[saltstack自动化运维实施（一）]]></title>
      <url>/2016/12/30/saltstack%E8%87%AA%E5%8A%A8%E5%8C%96%E8%BF%90%E7%BB%B4%E5%AE%9E%E6%96%BD%EF%BC%88%E4%B8%80%EF%BC%89/</url>
      <content type="html"><![CDATA[<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install salt</div></pre></td></tr></table></figure>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h6 id="master"><a href="#master" class="headerlink" title="master"></a>master</h6><p>配置文件/etc/salt/master, 打开注释<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">autosign_file: /etc/salt/autosign.conf</div></pre></td></tr></table></figure></p>
<p>更多参考： <a href="https://docs.saltstack.com/en/latest/ref/configuration/master.html" target="_blank" rel="external">https://docs.saltstack.com/en/latest/ref/configuration/master.html</a></p>
<h6 id="minion"><a href="#minion" class="headerlink" title="minion"></a>minion</h6><p>一个是/etc/salt/minion_id, 一般可以取为hostname</p>
<p>还有/etc/salt/minion, 指定master的host<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">master: 10.0.1.110</div></pre></td></tr></table></figure></p>
<p>更多参考： <a href="https://docs.saltstack.com/en/latest/ref/configuration/minion.html" target="_blank" rel="external">https://docs.saltstack.com/en/latest/ref/configuration/minion.html</a></p>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><h6 id="master-1"><a href="#master-1" class="headerlink" title="master"></a>master</h6><p>salt-master restart</p>
<h6 id="minion-1"><a href="#minion-1" class="headerlink" title="minion"></a>minion</h6><p>salt-minion restart</p>
<h2 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h2><h6 id="手动认证"><a href="#手动认证" class="headerlink" title="手动认证"></a>手动认证</h6><p>默认是没有开启自动认证的，需要人工手动判断哪些id是允许的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@datanode21 ~]# salt-key -L    # 列出所有id</div><div class="line">Accepted Keys:</div><div class="line">datanode19</div><div class="line">datanode20</div><div class="line">datanode21</div><div class="line">Denied Keys:</div><div class="line">Unaccepted Keys:</div><div class="line">Rejected Keys:</div><div class="line">[root@datanode21 ~]# salt-key -A # 通过所有认证</div><div class="line">[root@datanode21 ~]# salt-key -d datanode21  # 删除指定id</div><div class="line">The following keys are going to be deleteed:</div><div class="line">Accepted Keys:</div><div class="line">datanode21</div><div class="line">Proceed? [N/y] y</div><div class="line">Key for minion datanode21 deleteed.</div></pre></td></tr></table></figure></p>
<p>官网有说把master.pub放到minion里，但是我使用的时候并没有发现什么卵用~~~</p>
<h6 id="自动认证"><a href="#自动认证" class="headerlink" title="自动认证"></a>自动认证</h6><p>我弄了一种并不是很安全，但是相对比较安全的方式，使用hostname来自动认证.<br>编辑/etc/salt/master文件, 打开注释<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">autosign_file: /etc/salt/autosign.conf</div></pre></td></tr></table></figure></p>
<p>之后编辑/etc/salt/autosign.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">datanode??.will.com</div></pre></td></tr></table></figure></p>
<p>这里是正则匹配id的，如果minion的id能满足这里的正则表达式，就可以自动通过认证。</p>
<p>因为修改了/etc/salt/master文件，所以需要重启一下，如果只修改匹配规则文件是不需要重启的。</p>
<p>参考：<a href="http://www.it610.com/article/3325439.htm" target="_blank" rel="external">http://www.it610.com/article/3325439.htm</a></p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>在master的机器上执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@datanode21 ~]# salt &apos;*&apos; test.ping</div><div class="line">datanode21.will.com:</div><div class="line">    True</div><div class="line">datanode19.will.com:</div><div class="line">    True</div><div class="line">datanode20.will.com:</div><div class="line">    True</div></pre></td></tr></table></figure></p>
<h2 id="分发脚本"><a href="#分发脚本" class="headerlink" title="分发脚本"></a>分发脚本</h2><p>先安装<a href="http://fabric-chs.readthedocs.io/zh_CN/chs/tutorial.html" target="_blank" rel="external"><strong>Fabric</strong></a>.</p>
<p>编辑fabfile.py：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># encoding: utf-8</span></div><div class="line"></div><div class="line"><span class="comment">#from fabric.api import local,cd,run,env,put</span></div><div class="line"><span class="keyword">from</span> fabric.api <span class="keyword">import</span> *</div><div class="line"></div><div class="line">env.hosts=[<span class="string">'172.16.4.74'</span>]</div><div class="line">env.password = <span class="string">'Yinker.com'</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@parallel</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">salt_install</span><span class="params">()</span>:</span></div><div class="line"><span class="comment">#    run('/etc/init.d/iptables stop')  #远程操作用run</span></div><div class="line"><span class="comment">#    run('mkdir /server')</span></div><div class="line">    run(<span class="string">'yum -y install openssh-clients'</span>)  <span class="comment">#远程操作用run</span></div><div class="line">    run(<span class="string">'yum -y install https://repo.saltstack.com/yum/redhat/salt-repo-latest-1.el6.noarch.rpm'</span>)  <span class="comment">#远程操作用run</span></div><div class="line">    run(<span class="string">'yum -y install python-devel'</span>)  <span class="comment">#远程操作用run</span></div><div class="line">    run(<span class="string">'yum -y install salt-minion'</span>)  <span class="comment">#远程操作用run</span></div><div class="line">    run(<span class="string">'test -f /etc/salt/minion &amp;&amp; rm -rf /etc/salt/minion'</span>)  <span class="comment">#远程操作用run</span></div><div class="line">    put(<span class="string">'/root/qian/minion'</span>,<span class="string">'/etc/salt/minion'</span>)</div><div class="line">    run(<span class="string">'echo `hostname` &gt;/etc/salt/minion_id'</span>)</div><div class="line">    put(<span class="string">'/root/qian/selinux'</span>,<span class="string">'/etc/sysconfig/selinux'</span>)</div><div class="line">    run(<span class="string">'setenforce 0'</span>)</div><div class="line">    run(<span class="string">'/etc/init.d/salt-minion restart'</span>)</div></pre></td></tr></table></figure></p>
<p>调用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/local/bin/fab -f fabfile.py salt_install</div></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[单点登出问题]]></title>
      <url>/2016/12/28/%E5%8D%95%E7%82%B9%E7%99%BB%E5%87%BA%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<h4 id="表现"><a href="#表现" class="headerlink" title="表现"></a>表现</h4><p>登陆后短时间内刷新页面，就会提示重新登陆。</p>
<p>后台对应的log：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">2016-12-28 14:32:53,094 INFO [org.jasig.inspektr.audit.support.Slf4jLoggingAuditTrailManager] - Audit trail record BEGIN</div><div class="line">=============================================================</div><div class="line">WHO: audit:unknown</div><div class="line">WHAT: TGT-************************************************OgnMZDqjiE-cas01.example.org</div><div class="line">ACTION: TICKET_GRANTING_TICKET_CREATED</div><div class="line">APPLICATION: CAS</div><div class="line">WHEN: Wed Dec 28 14:32:53 CST 2016</div><div class="line">CLIENT IP ADDRESS: 10.1.5.83</div><div class="line">SERVER IP ADDRESS: 10.0.1.62</div><div class="line">=============================================================</div></pre></td></tr></table></figure></p>
<p>正常的登陆log:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">2016-12-28 14:32:53,093 INFO [org.jasig.inspektr.audit.support.Slf4jLoggingAuditTrailManager] - Audit trail record BEGIN</div><div class="line">=============================================================</div><div class="line">WHO: admin</div><div class="line">WHAT: Supplied credentials: [admin]</div><div class="line">ACTION: AUTHENTICATION_SUCCESS</div><div class="line">APPLICATION: CAS</div><div class="line">WHEN: Wed Dec 28 14:32:53 CST 2016</div><div class="line">CLIENT IP ADDRESS: 10.1.5.83</div><div class="line">SERVER IP ADDRESS: 10.0.1.62</div><div class="line">=============================================================</div></pre></td></tr></table></figure></p>
<p>参考：</p>
<ul>
<li></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hdfs-rebalance引发的问题]]></title>
      <url>/2016/12/23/hdfs-rebalance%E5%BC%95%E5%8F%91%E7%9A%84%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<p>原来的集群节点是8台datanode…….HDFS的使用总量已经到了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Slow waitForAckedSeqno took 179279ms (threshold=30000ms)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Bad response ERROR for block BP-1029563541-10.0.1.72-1463106887558:blk_1077490973_3758370 from datanode DatanodeInfoWithStorage[10.0.1.98:50010,DS-a387140d-7</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Got error, status message , ack with firstBadLink as 10.0.1.101:50010</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">java.io.IOException: Bad response ERROR for block BP-1029563541-10.0.1.72-1463106887558:blk_1077490815_3758189 from datanode DatanodeInfoWithStorage[10.0.1.101:50010,DS-8786adb7-d8ae-4b29-a8af-4cb73a8a5e72,DISK]</div><div class="line">	at org.apache.hadoop.hdfs.DFSOutputStream$DataStreamer$ResponseProcessor.run(DFSOutputStream.java:785)</div></pre></td></tr></table></figure>
<p>map失败log信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">2016-12-24 22:19:01,865 WARN [main] org.apache.hadoop.metrics2.impl.MetricsConfig: Cannot locate configuration: tried hadoop-metrics2-maptask.properties,hadoop-metrics2.properties</div><div class="line">2016-12-24 22:19:05,431 INFO [main] org.apache.hadoop.metrics2.impl.MetricsSystemImpl: Scheduled snapshot period at 10 second(s).</div><div class="line">2016-12-24 22:19:05,431 INFO [main] org.apache.hadoop.metrics2.impl.MetricsSystemImpl: MapTask metrics system started</div><div class="line">2016-12-24 22:19:05,442 INFO [main] org.apache.hadoop.mapred.YarnChild: Executing with tokens:</div><div class="line">2016-12-24 22:19:05,442 INFO [main] org.apache.hadoop.mapred.YarnChild: Kind: mapreduce.job, Service: job_1482504625052_0529, Ident: (org.apache.hadoop.mapreduce.security.token.JobTokenIdentifier@57a78e3)</div><div class="line">2016-12-24 22:20:33,408 INFO [main] org.apache.hadoop.mapred.YarnChild: Sleeping for 0ms before retrying again. Got null now.</div><div class="line">2016-12-24 22:20:46,112 INFO [main] org.apache.hadoop.metrics2.impl.MetricsSystemImpl: Stopping MapTask metrics system...</div><div class="line">2016-12-24 22:20:46,119 INFO [main] org.apache.hadoop.metrics2.impl.MetricsSystemImpl: MapTask metrics system stopped.</div><div class="line">2016-12-24 22:20:46,119 INFO [main] org.apache.hadoop.metrics2.impl.MetricsSystemImpl: MapTask metrics system shutdown complete.</div></pre></td></tr></table></figure></p>
<p>MR任务之间有一段空白期<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">2016-12-24 21:29:50,046 Stage-1 map = 100%, reduce = 99%, Cumulative CPU 4516.43 sec</div><div class="line">2016-12-24 21:30:04,499 Stage-1 map = 100%, reduce = 100%, Cumulative CPU 4528.6 sec</div><div class="line">MapReduce Total cumulative CPU time: 0 days 1 hours 15 minutes 28 seconds 600 msec</div><div class="line">Ended Job = job_1482504625052_0527</div><div class="line">Launching Job 2 out of 3</div><div class="line">Number of reduce tasks not specified. Defaulting to jobconf value of: 30</div><div class="line">In order to change the average load for a reducer (in bytes):</div><div class="line">set hive.exec.reducers.bytes.per.reducer=</div><div class="line">In order to limit the maximum number of reducers:</div><div class="line">set hive.exec.reducers.max=</div><div class="line">In order to set a constant number of reducers:</div><div class="line">set mapreduce.job.reduces=</div><div class="line">Starting Job = job_1482504625052_0528, Tracking URL = http://datanode02.will.com:8088/proxy/application_1482504625052_0528/</div><div class="line">Kill Command = /usr/hdp/2.4.2.0-258/hadoop/bin/hadoop job -kill job_1482504625052_0528</div><div class="line">Hadoop job information for Stage-5: number of mappers: 7; number of reducers: 30</div><div class="line">2016-12-24 21:54:09,652 Stage-5 map = 0%, reduce = 0%</div><div class="line">2016-12-24 21:54:19,037 Stage-5 map = 14%, reduce = 0%, Cumulative CPU 7.53 sec</div><div class="line">2016-12-24 21:54:20,077 Stage-5 map = 29%, reduce = 0%, Cumulative CPU 15.38 sec</div><div class="line">2016-12-24 21:54:36,677 Stage-5 map = 39%, reduce = 0%, Cumulative CPU 44.43 sec</div><div class="line">2016-12-24 21:54:37,759 Stage-5 map = 71%, reduce = 0%, Cumulative CPU 52.41 sec</div><div class="line">2016-12-24 21:54:48,153 Stage-5 map = 71%, reduce = 1%, Cumulative CPU 53.96 sec</div><div class="line">2016-12-24 21:54:49,186 Stage-5 map = 71%, reduce = 2%, Cumulative CPU 56.57 sec</div></pre></td></tr></table></figure></p>
<p>21:30到21:54,这段时间namenode的log里的一些内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">2016-12-24 21:49:01,939 INFO  hdfs.StateChange (FSNamesystem.java:completeFile(3545)) - DIR* completeFile: /apps/hbase/data/data/default/KYLIN_U1V82JA44K/8c474006d2f4332bdaaee58105bb465a/.tmp/79460c3b99ba48f8b67cfadba06d277e is closed by DFSClient_NONMAPREDUCE_-90235743_1</div><div class="line">2016-12-24 21:49:02,045 INFO  hdfs.StateChange (FSNamesystem.java:logAllocatedBlock(3652)) - BLOCK* allocate blk_1077490355_3757707, replicas=10.0.1.86:50010, 10.0.1.95:50010, 10.0.1.84:50010 for /apps/hbase/data/data/default/KYLIN_U1V82JA44K/9674d0c2aec6aa86cb092088d9461163/.tmp/7d5802bddb694c25a84cdd2263bcca42</div><div class="line"></div><div class="line"></div><div class="line">2016-12-24 21:42:49,930 INFO  hdfs.StateChange (FSNamesystem.java:completeFile(3545)) - DIR* completeFile: /apps/hbase/data/data/default/KYLIN_V5P8H4CZJF/2c1b15e259130ca37d1c4808aade03e6/.tmp/d702471e4c784abba520d494c29b03f2 is closed by DFSClient_NONMAPREDUCE_434452785_1</div><div class="line"></div><div class="line"></div><div class="line">namenode.FSNamesystem (FSNamesystem.java:updatePipeline(6535)) - updatePipeline(blk_1077490302_3757650, newGS=3757651, newLength=114137522, newNodes=[10.0.1.96:50010, 10.0.1.83:50010], client=DFSClient_NONMAPREDUCE_829342269_1)</div><div class="line">2016-12-24 21:42:49,567 INFO  namenode.FSNamesystem (FSNamesystem.java:updatePipeline(6554)) - updatePipeline(blk_1077490302_3757650 =&gt; blk_1077490302_3757651) success</div><div class="line"></div><div class="line"></div><div class="line">chooseUnderReplicatedBlocks selected 1 blocks at priority level 2;  Total=1 Reset bookmarks? true</div><div class="line"></div><div class="line">namenode.FSEditLog (FSEditLog.java:printStatistics(699)) - Number of transactions: 106401 Total time fo</div><div class="line">r transactions(ms): 961 Number of transactions batched in Syncs: 3666 Number of syncs: 87634 SyncTimes(ms): 239376</div></pre></td></tr></table></figure></p>
<p>failed的reducer的提示note：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">AttemptID:attempt_1482504625052_0537_r_000003_0 Timed out after 300 secs Container killed by the ApplicationMaster. Container killed on request. Exit code is 143 Container exited with a non-zero exit code 143</div></pre></td></tr></table></figure></p>
<p>balance完成之后，运行了几天，每天的任务从2小时、1个小时40分钟、1小时30分钟、1小时20分钟递减~~也很少出现这种问题了……诡异</p>
<p>参考下面的资料，基本思想就是timeout的时间内，没有完成某个任务，所以把timeout延长就可以了。还没有实践测试….就好了</p>
<p>还是看一下这附近的源码比较好一些~</p>
<p>参考：</p>
<ul>
<li><a href="http://www.superwu.cn/2014/11/13/1334/" target="_blank" rel="external">http://www.superwu.cn/2014/11/13/1334/</a></li>
<li><a href="http://blog.sina.com.cn/s/blog_72827fb1010198j7.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_72827fb1010198j7.html</a></li>
<li><a href="http://blog.163.com/zhengjiu_520/blog/static/3559830620130743644473/" target="_blank" rel="external">http://blog.163.com/zhengjiu_520/blog/static/3559830620130743644473/</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[mesos的docker化安装部署]]></title>
      <url>/2016/12/22/mesos%E7%9A%84docker%E5%8C%96%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/</url>
      <content type="html"><![CDATA[<p>首先，还是从源头说起，用阿里云的yum源，下载安装都会快一些。<br>zookeeper<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -d  --net=&quot;host&quot;   -e SERVER_ID=3 -e ADDITIONAL_ZOOKEEPER_1=server.1=10.1.5.129:2888:3888 -e ADDITIONAL_ZOOKEEPER_2=server.2=10.1.5.180:2888:3888 -e ADDITIONAL_ZOOKEEPER_3=server.3=10.1.5.190:2888:3888 --name zk garland/zookeeper</div></pre></td></tr></table></figure></p>
<p>master<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">docker run --net=&quot;host&quot; \</div><div class="line">   -p 5050:5050 \</div><div class="line">   -e &quot;MESOS_HOSTNAME=10.1.5.129&quot; \</div><div class="line">  -e &quot;MESOS_IP=10.1.5.129&quot; \</div><div class="line">  -e &quot;MESOS_ZK=zk://10.1.5.129:2181,10.1.5.180:2181,10.1.5.190:2181/mesos&quot; \</div><div class="line">  -e &quot;MESOS_PORT=5050&quot; \</div><div class="line">   -e &quot;MESOS_LOG_DIR=/var/log/mesos&quot; \</div><div class="line">   -e &quot;MESOS_QUORUM=1&quot; \</div><div class="line">   -e &quot;MESOS_REGISTRY=in_memory&quot; \</div><div class="line">   -e &quot;MESOS_WORK_DIR=/var/lib/mesos&quot; \</div><div class="line">   -d --name mesos-master garland/mesosphere-docker-mesos-master</div><div class="line">   </div><div class="line">docker run --net=&quot;host&quot; \</div><div class="line">   -p 5050:5050 \</div><div class="line">   -e &quot;MESOS_HOSTNAME=10.1.5.180&quot; \</div><div class="line">  -e &quot;MESOS_IP=10.1.5.180&quot; \</div><div class="line">  -e &quot;MESOS_ZK=zk://10.1.5.129:2181,10.1.5.180:2181,10.1.5.190:2181/mesos&quot; \</div><div class="line">  -e &quot;MESOS_PORT=5050&quot; \</div><div class="line">   -e &quot;MESOS_LOG_DIR=/var/log/mesos&quot; \</div><div class="line">   -e &quot;MESOS_QUORUM=1&quot; \</div><div class="line">   -e &quot;MESOS_REGISTRY=in_memory&quot; \</div><div class="line">   -e &quot;MESOS_WORK_DIR=/var/lib/mesos&quot; \</div><div class="line">   -d --name mesos-master garland/mesosphere-docker-mesos-master</div><div class="line">   </div><div class="line">   </div><div class="line"> docker run --net=&quot;host&quot; \</div><div class="line">   -p 5050:5050 \</div><div class="line">   -e &quot;MESOS_HOSTNAME=10.1.5.190&quot; \</div><div class="line">  -e &quot;MESOS_IP=10.1.5.190&quot; \</div><div class="line">  -e &quot;MESOS_ZK=zk://10.1.5.129:2181,10.1.5.180:2181,10.1.5.190:2181/mesos&quot; \</div><div class="line">  -e &quot;MESOS_PORT=5050&quot; \</div><div class="line">   -e &quot;MESOS_LOG_DIR=/var/log/mesos&quot; \</div><div class="line">   -e &quot;MESOS_QUORUM=1&quot; \</div><div class="line">   -e &quot;MESOS_REGISTRY=in_memory&quot; \</div><div class="line">   -e &quot;MESOS_WORK_DIR=/var/lib/mesos&quot; \</div><div class="line">   -d --name mesos-master garland/mesosphere-docker-mesos-master</div></pre></td></tr></table></figure></p>
<p>marathon<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">docker run \</div><div class="line"> -d \</div><div class="line"> -p 8080:8080 \</div><div class="line"> garland/mesosphere-docker-marathon --master zk://10.1.5.129:2181,10.1.5.180:2181,10.1.5.190:2181/mesos --zk zk://10.1.5.129:2181,10.1.5.180:2181,10.1.5.190:2181/marathon</div></pre></td></tr></table></figure></p>
<p>slave<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">docker run -d \</div><div class="line"> --entrypoint=&quot;mesos-slave&quot; \</div><div class="line"> -e &quot;MESOS_MASTER=zk://10.1.5.129:2181,10.1.5.180:2181,10.1.5.190:2181/mesos&quot; \</div><div class="line"> -e &quot;MESOS_LOG_DIR=/var/log/mesos&quot; \</div><div class="line"> -e &quot;MESOS_LOGGING_LEVEL=INFO&quot; \</div><div class="line"> garland/mesosphere-docker-mesos-master:latest</div></pre></td></tr></table></figure></p>
<p>参考：</p>
<ul>
<li><a href="http://www.cnblogs.com/ee900222/p/docker_2.html" target="_blank" rel="external">http://www.cnblogs.com/ee900222/p/docker_2.html</a></li>
<li><a href="https://mesosphere.com/blog/2014/07/17/mesosphere-package-repositories/#" target="_blank" rel="external">https://mesosphere.com/blog/2014/07/17/mesosphere-package-repositories/#</a></li>
<li><a href="http://www.jingyuyun.com/article/8062.html" target="_blank" rel="external">http://www.jingyuyun.com/article/8062.html</a></li>
<li><a href="http://dockone.io/article/493" target="_blank" rel="external">http://dockone.io/article/493</a></li>
<li><a href="http://www.mesoscn.cn/document/runing-Mesos/Configuration.html" target="_blank" rel="external">http://www.mesoscn.cn/document/runing-Mesos/Configuration.html</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[一致性协议zab与raft]]></title>
      <url>/2016/12/09/%E4%B8%80%E8%87%B4%E6%80%A7%E5%8D%8F%E8%AE%AEzab%E4%B8%8Eraft/</url>
      <content type="html"><![CDATA[<p>zookeeper的zab1.0协议<br>raft协议<br>重视看来一下zookeeper的选举过程，并不是原来说的大家都排队拿一个号，谁小谁当。而是依次比较epoch(选举轮数)、zxid(处理的事务id)、serverid(my.ini里的server.id)，可能最后的server.id是原来那样说的原因吧。<br>zookeeper的实现是通过一个MessageSender和一个MessageReceiver来实现</p>
<p>raft算法中，follower跟leader不一致的地方会被leader覆盖掉。zookeeper同样也是这样，TRUNC类型的message的处理。</p>
<p>raft不同于zookeeper的地方：<br>选举的时候serverid的地方并不一样，是通过随机选举超时时间，防止瓜分选票</p>
<p>有一个难点，假设一共5个server，如果某个leader在将所有的logid/zxid同步到了大多数机器，也就是3台，term或者epoch为2。此时挂掉，选举了一个新的leader，它对于这三台机器中的新的log/zxid的处理方式。<br>raft会判断是否多数已经同步，如果是，就接受并发送出去，同步给其他server。zookeeper并没有提及 —— TODO 源码确认</p>
<p>####<br>参考：</p>
<ul>
<li><a href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/Zab1.0" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/ZOOKEEPER/Zab1.0</a></li>
<li><a href="http://www.tuicool.com/articles/IfQR3u3" target="_blank" rel="external">http://www.tuicool.com/articles/IfQR3u3</a></li>
<li><a href="https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md" target="_blank" rel="external">https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md</a><br>-<a href="http://www.cnblogs.com/yuyijq/p/4116365.html" target="_blank" rel="external">http://www.cnblogs.com/yuyijq/p/4116365.html</a><br>-<a href="http://iwinit.iteye.com/blog/1773531" target="_blank" rel="external">http://iwinit.iteye.com/blog/1773531</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[微服务（翻译）]]></title>
      <url>/2016/12/05/%E5%BE%AE%E6%9C%8D%E5%8A%A1%EF%BC%88%E7%BF%BB%E8%AF%91%EF%BC%89/</url>
      <content type="html"><![CDATA[<h2 id="新架构角度的定义"><a href="#新架构角度的定义" class="headerlink" title="新架构角度的定义"></a>新架构角度的定义</h2><p>微服务这个名词最近几年比较火，它代表一套独立部署的应用服务的软件设计。然而对于这种架构方式并没有精确的定义，微观组织的业务能力有几个共同的特征：自动化部署、智能终端、语言和数据的分散控制。</p>
<p>微服务是众多软件架构中的一种。以前我们只是轻蔑的瞥一眼，最近几年来微服务的使用效果让我们见证到了它的威力。而且有些学校已经把它当做企业编程系统模式来教学。可悲的是，并没有人明确指出应该怎样构建一个微服务架构~</p>
<p>简单来说，微服务就是提供一套服务来开发一个应用，其中每个服务都运行在自己的进程里，它们之间使用轻量级的协议进行沟通，多数是http。这些服务是围绕业务构建的，而且各自独立地被自动化部署。最低限度地集中管理这些服务，因为这些服务可能是各种编程语言写的，也有可能使用各自不同的存储技术。</p>
<p>下面对比整体编程架构来介绍一下微服务架构。一般的应用由三部分构成：前端、数据库、后端服务。后端服务负责处理http请求，执行业务逻辑，接收并更新数据到数据库，选择适当的视图返回给客户端。这样的后端服务就是一个整体编程架构。任何修改都要重新发布整个后端服务。</p>
<p>上面提到的整体架构是构建系统的一个很自然的方式。处理请求的所有的业务逻辑都在一个单一的进程里，你可以使用语言特性讲不通的功能分配给不同的类、函数、命名空间。对于个别关心的东西，你可以在开发人员的笔记本上运行测试。使用一个发布pipeline来保证改变的东西已经被测试过了，然后发布到生产环境。你可以在负载均衡后面运行多个app实例来横向扩展。</p>
<p>整体架构其实比较成功，只是人们慢慢感觉到有些受挫，尤其是越来越多的应用被发布到云中。修改环节紧紧联系在一起，对应用的一小部分进行修改，就需要整体应用都重新构建与发布。随着时间推移，要想保持一个很好的模块化架构变得特别困难。扩展的话也必须扩展整体应用，而不能紧紧扩展指定的一些模块，这样就耗费了很多资源。</p>
<p><img src="http://martinfowler.com/articles/microservices/images/sketch.png" alt="整体架构 与 微服务"></p>
<p>这些困难催生了微服务架构：把app当做服务组来构建。每个服务不但独立部署和扩展，他们还提供严格的模块边界，甚至不同的服务还可以使用不同的编程语言来实现，也可以由不同的团队负责开发与管理。</p>
<p>我们并不是说微服务是创新的，至少它回归到了Unix的设计原则。我们就是认为使用微服务架构思想编程的人还比较少，其实使用它会让我们的软件开发更好。</p>
<h2 id="微服务架构的特点"><a href="#微服务架构的特点" class="headerlink" title="微服务架构的特点"></a>微服务架构的特点</h2><p> While we authors have been active members of this rather loose community, our intention is to attempt a description of what we see in our own work and in similar efforts by teams we know of. In particular we are not laying down some definition to conform to.</p>
<p>我们并不能对微服务下一个官方定义，但是我们可以尝试描述一下微服务的几个共同特点。并不是所有的微服务架构都有这些特点，但是我们希望多数的微服务都展示出了这些特点的大部分。</p>
<h4 id="组件化服务"><a href="#组件化服务" class="headerlink" title="组件化服务"></a>组件化服务</h4><p>软件工业中我们一般把系统设计成可以将component组装起来的架构，多数是使用公用的libraries实现。</p>
<p>提到component，我们看一下它的定义，component是软件的一个单元，独立、可替换、可升级。</p>
<p>Microservice architectures will use libraries, but their primary way of componentizing their own software is by breaking down into services. We define libraries as components that are linked into a program and called using in-memory function calls, while services are out-of-process components who communicate with a mechanism such as a web service request, or remote procedure call. (This is a different concept to that of a service object in many OO programs [3].)</p>
<p>微服务架构把软件打散成不同的服务，也是用libraries。libraries是被链接到程序中，在内存中调用函数的component，而服务是进程之外的component，使用类似web service request进行沟通，或者RPC。</p>
<p>One main reason for using services as components (rather than libraries) is that services are independently deployable. If you have an application [4] that consists of a multiple libraries in a single process, a change to any single component results in having to redeploy the entire application. But if that application is decomposed into multiple services, you can expect many single service changes to only require that service to be redeployed. That’s not an absolute, some changes will change service interfaces resulting in some coordination, but the aim of a good microservice architecture is to minimize these through cohesive service boundaries and evolution mechanisms in the service contracts.</p>
<p>把服务组件化的一个主要理由就是服务可以独立部署。如果你有一个单进程中包含多个libraries的应用，修改任何一个component都需要重新部署整个应用。但是如果你的应用解耦成为多个服务，你可以只重新部署修改到的地方。当然这并不是绝对的，如果修改了服务接口，肯定也要重新修改部署协作的服务，但是微服务的目标就是通过黏着的服务边界和服务规范的进化机制最小化这个修改范围。</p>
<p>Another consequence of using services as components is a more explicit component interface. Most languages do not have a good mechanism for defining an explicit Published Interface. Often it’s only documentation and discipline that prevents clients breaking a component’s encapsulation, leading to overly-tight coupling between components. Services make it easier to avoid this by using explicit remote call mechanisms.</p>
<p>另一个服务组件化的结果就是更灵活的component接口。大多数语言都不能定义一个明确详实的公共接口。通常只能通过文档和规范来约束客户端遵循component的封装，导致组件之间过度依赖。组件化服务可以使用明确的远程调用机制避免这些。</p>
<p>Using services like this does have downsides. Remote calls are more expensive than in-process calls, and thus remote APIs need to be coarser-grained, which is often more awkward to use. If you need to change the allocation of responsibilities between components, such movements of behavior are harder to do when you’re crossing process boundaries.</p>
<p>使用这样的服务也是有缺点的。远程多用通常比进程内调用代价昂贵，因此远程API需要是粗粒度的。如果你必须修改component之间的职责分配，这样的行为移动非常难弄，尤其是跨进程边界的时候。</p>
<p>At a first approximation, we can observe that services map to runtime processes, but that is only a first approximation. A service may consist of multiple processes that will always be developed and deployed together, such as an application process and a database that’s only used by that service.</p>
<p>第一印象，我们可以把这样的服务看做是运行时进程。注意，这只是为了好理解一些，事实上一个service可以包含多个进程，比如一个应用进程和这个进程使用的数据库进程。</p>
<h4 id="业务管理"><a href="#业务管理" class="headerlink" title="业务管理"></a>业务管理</h4><p>When looking to split a large application into parts, often management focuses on the technology layer, leading to UI teams, server-side logic teams, and database teams. When teams are separated along these lines, even simple changes can lead to a cross-team project taking time and budgetary approval. A smart team will optimise around this and plump for the lesser of two evils - just force the logic into whichever application they have access to. Logic everywhere in other words. This is an example of Conway’s Law[5] in action.</p>
<p>当把一个大的应用切分成多个部分的时候，通常管理就集中在技术层面，出现UI团队，后端逻辑团队，数据库团队。当各个团队分成这些战线之后，即便是特别小的改变也是一个跨团队项目，需要时间和预算。一个牛逼的团队会优化这些东西，取这两个恶魔中比较少的那个。强制把业务逻辑放到一个必须存在的地方。换句话说导出都写逻辑。这是Conway’s Law in action的一个实例。</p>
<blockquote>
<p>Any organization that designs a system (defined broadly) will produce a design whose structure is a copy of the organization’s communication structure.<br>– Melvyn Conway, 1967</p>
<p>任何组织的系统都是组织结构沟通结构的复制。</p>
</blockquote>
<p><img src="http://martinfowler.com/articles/microservices/images/conways-law.png" alt="Conway&#39;s Law in action"></p>
<p>The microservice approach to division is different, splitting up into services organized around business capability. Such services take a broad-stack implementation of software for that business area, including user-interface, persistant storage, and any external collaborations. Consequently the teams are cross-functional, including the full range of skills required for the development: user-experience, database, and project management.</p>
<p>微服务的切分不同，它是围绕业务切分服务。这样的服务包含特定业务领域系统的所有技术栈的实现，包含UI、持久存储、外部协作。结果这样的团队就跨功能，包含开发所需的所有的技术：UI、数据库、项目管理。</p>
<p><img src="http://martinfowler.com/articles/microservices/images/PreferFunctionalStaffOrganization.png" alt="Service boundaries reinforced by team boundaries"></p>
<p>One company organised in this way is www.comparethemarket.com. Cross functional teams are responsible for building and operating each product and each product is split out into a number of individual services communicating via a message bus.</p>
<p>www.comparethemarket.com就是这样组织的一个公司。跨功能团队负责构建和操作每个产品，每个产品也都被切分成几个单独的服务，这些服务之间通过message bus沟通。</p>
<p>Large monolithic applications can always be modularized around business capabilities too, although that’s not the common case. Certainly we would urge a large team building a monolithic application to divide itself along business lines. The main issue we have seen here, is that they tend to be organised around too many contexts. If the monolith spans many of these modular boundaries it can be difficult for individual members of a team to fit them into their short-term memory. Additionally we see that the modular lines require a great deal of discipline to enforce. The necessarily more explicit separation required by service components makes it easier to keep the team boundaries clear.</p>
<p>大的整体应用通常也可以围绕业务进行模块化，尽管还不是通用案例。当然我们需要推动一个大的团队构建一个整体应用根据业务线进行切割。我们在这里遇到的主要的问题是，需要这里面的组织会包含太多的context。如果这个整体应用贯穿了所有模块边界，那么就很难让团队里的个人成员把他们短期记忆住。另外我们知道模块线需要一个准则。 服务组价需要一定更明确的分离，这样能够让团队边界也更清晰。</p>
<h4 id="产品而不是项目"><a href="#产品而不是项目" class="headerlink" title="产品而不是项目"></a>产品而不是项目</h4><p>Most application development efforts that we see use a project model: where the aim is to deliver some piece of software which is then considered to be completed. On completion the software is handed over to a maintenance organization and the project team that built it is disbanded.</p>
<p>我们见的多数的应用开发都是使用项目模型：目标就是交付软件的某些片段。完成后，软件就转交给运维，然后项目团队就解散了。</p>
<p>Microservice proponents tend to avoid this model, preferring instead the notion that a team should own a product over its full lifetime. A common inspiration for this is Amazon’s notion of “you build, you run it” where a development team takes full responsibility for the software in production. This brings developers into day-to-day contact with how their software behaves in production and increases contact with their users, as they have to take on at least some of the support burden.</p>
<p>微服务支持者要避免这种情况，一个团队应该负责产品的整个生命周期。亚马逊的口号：谁构建，谁运行。一个开发团队对于生产线上的软件要全权负责。这样开发者每天都会考虑他的软件在生成环境运行的情况咋样，也多跟他的用户沟通，他们必须多少承担一些事情。</p>
<p>The product mentality, ties in with the linkage to business capabilities. Rather than looking at the software as a set of functionality to be completed, there is an on-going relationship where the question is how can software assist its users to enhance the business capability.</p>
<p>产品是与业务线贴合的。除了把软件当做一组完成的功能，还有一个持续的关系，就是软件怎样辅助它的用户来加强业务能力。</p>
<h4 id="Smart-endpoints-and-dumb-pipes"><a href="#Smart-endpoints-and-dumb-pipes" class="headerlink" title="Smart endpoints and dumb pipes"></a>Smart endpoints and dumb pipes</h4><p>When building communication structures between different processes, we’ve seen many products and approaches that stress putting significant smarts into the communication mechanism itself. A good example of this is the Enterprise Service Bus (ESB), where ESB products often include sophisticated facilities for message routing, choreography, transformation, and applying business rules.</p>
<p>当为不同的进程构建沟通结构的时候，我们见过很多产品都强调吧关键的smart放进沟通机制本身中。一个例子就是ESB。ESB产品通常都包含复杂的设备来支持消息路由、编排、转化、应用业务规则。</p>
<p>The microservice community favours an alternative approach: smart endpoints and dumb pipes. Applications built from microservices aim to be as decoupled and as cohesive as possible - they own their own domain logic and act more as filters in the classical Unix sense - receiving a request, applying logic as appropriate and producing a response. These are choreographed using simple RESTish protocols rather than complex protocols such as WS-Choreography or BPEL or orchestration by a central tool.</p>
<p>微服务组织最喜欢另一种方式：smart endpoints and dumb pipes. 使用微服务构建的应用旨在尽可能解耦，边界尽可能清洗-他们都有自己的逻辑，表现的像个经典Unix派感觉的filter - 接收一个请求，应用业务逻辑，然后产生一个response。他们被使用简单的REST系列协议编排，而不是类似WS-Choreography或者BPRL啥的复杂的协议。</p>
<p>The two protocols used most commonly are HTTP request-response with resource API’s and lightweight messaging[6]. The best expression of the first is</p>
<p>两个最常用的协议是带有resource API的HTTP request-reponse，还有轻量级消息协议。前者最好的表达是：</p>
<blockquote>
<p>Be of the web, not behind the web<br>– Ian Robinson</p>
</blockquote>
<p>Microservice teams use the principles and protocols that the world wide web (and to a large extent, Unix) is built on. Often used resources can be cached with very little effort on the part of developers or operations folk.</p>
<p>不会翻译。</p>
<p>The second approach in common use is messaging over a lightweight message bus. The infrastructure chosen is typically dumb (dumb as in acts as a message router only) - simple implementations such as RabbitMQ or ZeroMQ don’t do much more than provide a reliable asynchronous fabric - the smarts still live in the end points that are producing and consuming messages; in the services.</p>
<p>后者通常通过一个轻量级的message bug来使用。基础设施通常选用dumb，简单的实现例如RabbitMQ、ZeroMQ，并没有为一个可靠的异步fabric多做了些什么 - smart还是在生成和消费message的终端上。</p>
<p>In a monolith, the components are executing in-process and communication between them is via either method invocation or function call. The biggest issue in changing a monolith into microservices lies in changing the communication pattern. A naive conversion from in-memory method calls to RPC leads to chatty communications which don’t perform well. Instead you need to replace the fine-grained communication with a coarser -grained approach.</p>
<p>在一个整体应用中，component是运行在同一个进程内的，可以通过方法触发或函数调用来相互沟通。切分成为微服务后，一个比较大的问题就是沟通模型。从内存中的方法调用到RPC导致了啰嗦的沟通机制。除此之外，你必须使用细粒度沟通替换为粗粒度的。</p>
<h4 id="Decentralized-Governance-（分权治理-去中心化）"><a href="#Decentralized-Governance-（分权治理-去中心化）" class="headerlink" title="Decentralized Governance （分权治理/去中心化）"></a>Decentralized Governance （分权治理/去中心化）</h4><p>One of the consequences of centralised governance is the tendency to standardise on single technology platforms. Experience shows that this approach is constricting - not every problem is a nail and not every solution a hammer. We prefer using the right tool for the job and while monolithic applications can take advantage of different languages to a certain extent, it isn’t that common.</p>
<p>中心化治理的结果是标准趋向于单一技术平台。经验表明这种方式是不太好的，通常不是一个方案就能解决掉所有问题。我们更愿意使用合适的工具来做对应的工作，整体应用可以利用不同语言解决某个特定的范围，但是这并不常见。</p>
<p>Splitting the monolith’s components out into services we have a choice when building each of them. You want to use Node.js to standup a simple reports page? Go for it. C++ for a particularly gnarly near-real-time component? Fine. You want to swap in a different flavour of database that better suits the read behaviour of one component? We have the technology to rebuild him.</p>
<p>把整体应用切分成组件化服务的话，我们可以选择啥时候构建每个组件。想用nodejs创建一个简单的表单页？做呗。想用c++弄一个实时处理组件？好啊。你想在不同的数据库支持之间切换，来适应个别组件的读取？我们可以重新构建它。</p>
<p>Of course, just because you can do something, doesn’t mean you should - but partitioning your system in this way means you have the option.</p>
<p>当然，并不是你可以做，你就应该做。只是把你当系统以这种方式拆分后，你可以选择做或者不做。</p>
<p>Teams building microservices prefer a different approach to standards too. Rather than use a set of defined standards written down somewhere on paper they prefer the idea of producing useful tools that other developers can use to solve similar problems to the ones they are facing. These tools are usually harvested from implementations and shared with a wider group, sometimes, but not exclusively using an internal open source model. Now that git and github have become the de facto version control system of choice, open source practices are becoming more and more common in-house .</p>
<p>各个团队构建微服务的方式也不尽相同。他们会设计对生产有用的工具，供其他开发者重用，解决类似的问题，而不是使用一系列定义好的标准写在纸上。这些工具通常从一些实现或者在一个共享组里获得的。现在git和github都成为了版本控制系统，开源的练习也越来越多见。</p>
<p>Netflix is a good example of an organisation that follows this philosophy. Sharing useful and, above all, battle-tested code as libraries encourages other developers to solve similar problems in similar ways yet leaves the door open to picking a different approach if required. Shared libraries tend to be focused on common problems of data storage, inter-process communication and as we discuss further below, infrastructure automation.</p>
<p>netflix是追随这个哲学的代表组织。分享有用的精炼的代码，作为libraries提供给其他的开发者使用，解决类似的问题。共享的libraries会慢慢在数据存储、进程内沟通、基础设置自动化问题上被注意到。</p>
<p>For the microservice community, overheads are particularly unattractive. That isn’t to say that the community doesn’t value service contracts. Quite the opposite, since there tend to be many more of them. It’s just that they are looking at different ways of managing those contracts. Patterns like Tolerant Reader and Consumer-Driven Contracts are often applied to microservices. These aid service contracts in evolving independently. Executing consumer driven contracts as part of your build increases confidence and provides fast feedback on whether your services are functioning. Indeed we know of a team in Australia who drive the build of new services with consumer driven contracts. They use simple tools that allow them to define the contract for a service. This becomes part of the automated build before code for the new service is even written. The service is then built out only to the point where it satisfies the contract - an elegant approach to avoid the ‘YAGNI’[9] dilemma when building new software. These techniques and the tooling growing up around them, limit the need for central contract management by decreasing the temporal coupling between services.</p>
<p>对于微服务社区，一般费用是不太惹人注意的。不是说社区不重视服务规范。正相反，很重视服务规范。只是在各种方式来管理这些规范。诸如 Tolerant Reader和Consumer-Driven的规范模型经常被应用于微服务。这帮助服务规范独立展开。</p>
<p>Perhaps the apogee of decentralised governance is the build it / run it ethos popularised by Amazon. Teams are responsible for all aspects of the software they build including operating the software 24/7. Devolution of this level of responsibility is definitely not the norm but we do see more and more companies pushing responsibility to the development teams. Netflix is another organisation that has adopted this ethos[11]. Being woken up at 3am every night by your pager is certainly a powerful incentive to focus on quality when writing your code. These ideas are about as far away from the traditional centralized governance model as it is possible to be.</p>
<p>获取去中心化治理的至高点是Amazon号召的构建/运行。各种团队也24/7的负责了软件的不同方面。责任的转义肯定不是规范，但是我们看到了越来越多的公司把责任推给了开发团队。netflix是融合了这种号召的另一类组织。你的手机每天教你半夜3点起来肯定一个很牛逼的动力，让你专注于写代码的质量。</p>
<h4 id="Decentralized-Data-Management（数据管理去中心化）"><a href="#Decentralized-Data-Management（数据管理去中心化）" class="headerlink" title="Decentralized Data Management（数据管理去中心化）"></a>Decentralized Data Management（数据管理去中心化）</h4><p>Decentralization of data management presents in a number of different ways. At the most abstract level, it means that the conceptual model of the world will differ between systems. This is a common issue when integrating across a large enterprise, the sales view of a customer will differ from the support view. Some things that are called customers in the sales view may not appear at all in the support view. Those that do may have different attributes and (worse) common attributes with subtly different semantics.</p>
<p>数据管理的去中心化代表着几种不同的方式。最抽象的层次上讲，它表示概念模型在系统之间是不同的。在整个大公司的系统的时候这个问题很常见，销售视图不同于支持视图。有一些customer在销售视图里，而在支持视图没有。还有有不同的属性和相同的属性，但是有不同的语义。</p>
<p>This issue is common between applications, but can also occur within applications, particular when that application is divided into separate components. A useful way of thinking about this is the Domain-Driven Design notion of Bounded Context. DDD divides a complex domain up into multiple bounded contexts and maps out the relationships between them. This process is useful for both monolithic and microservice architectures, but there is a natural correlation between service and context boundaries that helps clarify, and as we describe in the section on business capabilities, reinforce the separations.</p>
<p>这个问题在应用之间是很常见的，在app内部也会发生，尤其是应用拆分成多个component之后。考虑这个一个很好的方式是把它看做bounded contexts的Domain-Driven设计概念。DDD气氛一个复杂的domain到多个bounded contexts，然后映射这些关系。这个过程对整体应用和微服务架构都有用，但是在service和context边界之间有一层自然的关联，这层关联帮助清晰化、加强了分离界限。</p>
<p>As well as decentralizing decisions about conceptual models, microservices also decentralize data storage decisions. While monolithic applications prefer a single logical database for persistant data, enterprises often prefer a single database across a range of applications - many of these decisions driven through vendor’s commercial models around licensing. Microservices prefer letting each service manage its own database, either different instances of the same database technology, or entirely different database systems - an approach called Polyglot Persistence. You can use polyglot persistence in a monolith, but it appears more frequently with microservices.</p>
<p>像概念模型的去中心化一样，微服务也对数据存储方案去中心化。整体应用通常是一个逻辑数据库来持久化数据，企业通常使用一个单独的数据库给多个应用。微服务更原因让每个服务管理自己的数据库，甚至整个数据库系统-Polyglot Persistence。你可以在整体应用中使用Polyglot Persistence，但是它更常见与微服务架构中。</p>
<p><img src="http://martinfowler.com/articles/microservices/images/decentralised-data.png" alt=""></p>
<p>参考：<a href="http://martinfowler.com/articles/microservices.html" target="_blank" rel="external">http://martinfowler.com/articles/microservices.html</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ambari故障记录]]></title>
      <url>/2016/12/05/ambari%E6%95%85%E9%9A%9C%E8%AE%B0%E5%BD%95/</url>
      <content type="html"><![CDATA[<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ul>
<li>ambari的metric界面上全都load不出来</li>
<li>hive命令行进不去，通过beeline连接成功，但是执行命令卡住</li>
</ul>
<h5 id="观察ambari-server-log里："><a href="#观察ambari-server-log里：" class="headerlink" title="观察ambari-server.log里："></a>观察ambari-server.log里：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div></pre></td><td class="code"><pre><div class="line">27 May 2016 06:00:16,468  WARN [C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|229f66ed]-AdminTaskTimer] ThreadPoolAsynchronousRunner:220 - Task com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask@13d18137 (in deadlocked PoolThread) failed to complete in maximum time 60000ms. Trying interrupt().</div><div class="line">27 May 2016 06:00:16,481  WARN [C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|229f66ed]-AdminTaskTimer] ThreadPoolAsynchronousRunner:220 - Task com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask@28fdf8 (in deadlocked PoolThread) failed to complete in maximum time 60000ms. Trying interrupt().</div><div class="line">27 May 2016 06:00:16,481  WARN [C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|229f66ed]-AdminTaskTimer] ThreadPoolAsynchronousRunner:220 - Task com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask@7a7239f6 (in deadlocked PoolThread) failed to complete in maximum time 60000ms. Trying interrupt().</div><div class="line">27 May 2016 06:32:26,157  WARN [C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|74e262f6]-AdminTaskTimer] ThreadPoolAsynchronousRunner:220 - com.mchange.v2.async.ThreadPoolAsynchronousRunner$DeadlockDetector@40bbff68 -- APPARENT DEADLOCK!!! Creating emergency threads for unassigned pending tasks!</div><div class="line">27 May 2016 06:32:26,171  WARN [C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|74e262f6]-AdminTaskTimer] ThreadPoolAsynchronousRunner:220 - com.mchange.v2.async.ThreadPoolAsynchronousRunner$DeadlockDetector@40bbff68 -- APPARENT DEADLOCK!!! Complete Status: </div><div class="line">	Managed Threads: 3</div><div class="line">	Active Threads: 3</div><div class="line">	Active Tasks: </div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask@5383aba6</div><div class="line">			on thread: C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|74e262f6]-HelperThread-#2</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask@38f907f5</div><div class="line">			on thread: C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|74e262f6]-HelperThread-#1</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask@204f2da</div><div class="line">			on thread: C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|74e262f6]-HelperThread-#0</div><div class="line">	Pending Tasks: </div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask@1ddb0d4d</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask@534b5bcb</div><div class="line">Pool thread stack traces:</div><div class="line">	Thread[C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|74e262f6]-HelperThread-#2,5,main]</div><div class="line">		java.net.SocketInputStream.socketRead0(Native Method)</div><div class="line">		java.net.SocketInputStream.socketRead(SocketInputStream.java:116)</div><div class="line">		java.net.SocketInputStream.read(SocketInputStream.java:170)</div><div class="line">		java.net.SocketInputStream.read(SocketInputStream.java:141)</div><div class="line">		com.mysql.jdbc.util.ReadAheadInputStream.fill(ReadAheadInputStream.java:100)</div><div class="line">		com.mysql.jdbc.util.ReadAheadInputStream.readFromUnderlyingStreamIfNecessary(ReadAheadInputStream.java:143)</div><div class="line">		com.mysql.jdbc.util.ReadAheadInputStream.read(ReadAheadInputStream.java:173)</div><div class="line">		com.mysql.jdbc.MysqlIO.readFully(MysqlIO.java:2911)</div><div class="line">		com.mysql.jdbc.MysqlIO.readPacket(MysqlIO.java:559)</div><div class="line">		com.mysql.jdbc.MysqlIO.doHandshake(MysqlIO.java:1013)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.coreConnect(ConnectionImpl.java:2239)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.connectOneTryOnly(ConnectionImpl.java:2270)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.createNewIO(ConnectionImpl.java:2069)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.&lt;init&gt;(ConnectionImpl.java:794)</div><div class="line">		com.mysql.jdbc.JDBC4Connection.&lt;init&gt;(JDBC4Connection.java:44)</div><div class="line">		sun.reflect.GeneratedConstructorAccessor186.newInstance(Unknown Source)</div><div class="line">		sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</div><div class="line">		java.lang.reflect.Constructor.newInstance(Constructor.java:422)</div><div class="line">		com.mysql.jdbc.Util.handleNewInstance(Util.java:389)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.getInstance(ConnectionImpl.java:399)</div><div class="line">		com.mysql.jdbc.NonRegisteringDriver.connect(NonRegisteringDriver.java:325)</div><div class="line">		com.mchange.v2.c3p0.DriverManagerDataSource.getConnection(DriverManagerDataSource.java:175)</div><div class="line">		com.mchange.v2.c3p0.WrapperConnectionPoolDataSource.getPooledConnection(WrapperConnectionPoolDataSource.java:220)</div><div class="line">		com.mchange.v2.c3p0.WrapperConnectionPoolDataSource.getPooledConnection(WrapperConnectionPoolDataSource.java:206)</div><div class="line">		com.mchange.v2.c3p0.impl.C3P0PooledConnectionPool$1PooledConnectionResourcePoolManager.acquireResource(C3P0PooledConnectionPool.java:203)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool.doAcquire(BasicResourcePool.java:1138)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool.doAcquireAndDecrementPendingAcquiresWithinLockOnSuccess(BasicResourcePool.java:1125)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool.access$700(BasicResourcePool.java:44)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask.run(BasicResourcePool.java:1870)</div><div class="line">		com.mchange.v2.async.ThreadPoolAsynchronousRunner$PoolThread.run(ThreadPoolAsynchronousRunner.java:696)</div><div class="line">	Thread[C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|74e262f6]-HelperThread-#1,5,main]</div><div class="line">		java.net.SocketInputStream.socketRead0(Native Method)</div><div class="line">		java.net.SocketInputStream.socketRead(SocketInputStream.java:116)</div><div class="line">		java.net.SocketInputStream.read(SocketInputStream.java:170)</div><div class="line">		java.net.SocketInputStream.read(SocketInputStream.java:141)</div><div class="line">		com.mysql.jdbc.util.ReadAheadInputStream.fill(ReadAheadInputStream.java:100)</div><div class="line">		com.mysql.jdbc.util.ReadAheadInputStream.readFromUnderlyingStreamIfNecessary(ReadAheadInputStream.java:143)</div><div class="line">		com.mysql.jdbc.util.ReadAheadInputStream.read(ReadAheadInputStream.java:173)</div><div class="line">		com.mysql.jdbc.MysqlIO.readFully(MysqlIO.java:2911)</div><div class="line">		com.mysql.jdbc.MysqlIO.readPacket(MysqlIO.java:559)</div><div class="line">		com.mysql.jdbc.MysqlIO.doHandshake(MysqlIO.java:1013)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.coreConnect(ConnectionImpl.java:2239)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.connectOneTryOnly(ConnectionImpl.java:2270)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.createNewIO(ConnectionImpl.java:2069)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.&lt;init&gt;(ConnectionImpl.java:794)</div><div class="line">		com.mysql.jdbc.JDBC4Connection.&lt;init&gt;(JDBC4Connection.java:44)</div><div class="line">		sun.reflect.GeneratedConstructorAccessor186.newInstance(Unknown Source)</div><div class="line">		sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</div><div class="line">		java.lang.reflect.Constructor.newInstance(Constructor.java:422)</div><div class="line">		com.mysql.jdbc.Util.handleNewInstance(Util.java:389)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.getInstance(ConnectionImpl.java:399)</div><div class="line">		com.mysql.jdbc.NonRegisteringDriver.connect(NonRegisteringDriver.java:325)</div><div class="line">		com.mchange.v2.c3p0.DriverManagerDataSource.getConnection(DriverManagerDataSource.java:175)</div><div class="line">		com.mchange.v2.c3p0.WrapperConnectionPoolDataSource.getPooledConnection(WrapperConnectionPoolDataSource.java:220)</div><div class="line">		com.mchange.v2.c3p0.WrapperConnectionPoolDataSource.getPooledConnection(WrapperConnectionPoolDataSource.java:206)</div><div class="line">		com.mchange.v2.c3p0.impl.C3P0PooledConnectionPool$1PooledConnectionResourcePoolManager.acquireResource(C3P0PooledConnectionPool.java:203)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool.doAcquire(BasicResourcePool.java:1138)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool.doAcquireAndDecrementPendingAcquiresWithinLockOnSuccess(BasicResourcePool.java:1125)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool.access$700(BasicResourcePool.java:44)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask.run(BasicResourcePool.java:1870)</div><div class="line">		com.mchange.v2.async.ThreadPoolAsynchronousRunner$PoolThread.run(ThreadPoolAsynchronousRunner.java:696)</div><div class="line">	Thread[C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|74e262f6]-HelperThread-#0,5,main]</div><div class="line">		java.net.SocketInputStream.socketRead0(Native Method)</div><div class="line">		java.net.SocketInputStream.socketRead(SocketInputStream.java:116)</div><div class="line">		java.net.SocketInputStream.read(SocketInputStream.java:170)</div><div class="line">		java.net.SocketInputStream.read(SocketInputStream.java:141)</div><div class="line">		com.mysql.jdbc.util.ReadAheadInputStream.fill(ReadAheadInputStream.java:100)</div><div class="line">		com.mysql.jdbc.util.ReadAheadInputStream.readFromUnderlyingStreamIfNecessary(ReadAheadInputStream.java:143)</div><div class="line">		com.mysql.jdbc.util.ReadAheadInputStream.read(ReadAheadInputStream.java:173)</div><div class="line">		com.mysql.jdbc.MysqlIO.readFully(MysqlIO.java:2911)</div><div class="line">		com.mysql.jdbc.MysqlIO.readPacket(MysqlIO.java:559)</div><div class="line">		com.mysql.jdbc.MysqlIO.doHandshake(MysqlIO.java:1013)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.coreConnect(ConnectionImpl.java:2239)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.connectOneTryOnly(ConnectionImpl.java:2270)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.createNewIO(ConnectionImpl.java:2069)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.&lt;init&gt;(ConnectionImpl.java:794)</div><div class="line">		com.mysql.jdbc.JDBC4Connection.&lt;init&gt;(JDBC4Connection.java:44)</div><div class="line">		sun.reflect.GeneratedConstructorAccessor186.newInstance(Unknown Source)</div><div class="line">		sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</div><div class="line">		java.lang.reflect.Constructor.newInstance(Constructor.java:422)</div><div class="line">		com.mysql.jdbc.Util.handleNewInstance(Util.java:389)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.getInstance(ConnectionImpl.java:399)</div><div class="line">		com.mysql.jdbc.NonRegisteringDriver.connect(NonRegisteringDriver.java:325)</div><div class="line">		com.mchange.v2.c3p0.DriverManagerDataSource.getConnection(DriverManagerDataSource.java:175)</div><div class="line">		com.mchange.v2.c3p0.WrapperConnectionPoolDataSource.getPooledConnection(WrapperConnectionPoolDataSource.java:220)</div><div class="line">		com.mchange.v2.c3p0.WrapperConnectionPoolDataSource.getPooledConnection(WrapperConnectionPoolDataSource.java:206)</div><div class="line">		com.mchange.v2.c3p0.impl.C3P0PooledConnectionPool$1PooledConnectionResourcePoolManager.acquireResource(C3P0PooledConnectionPool.java:203)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool.doAcquire(BasicResourcePool.java:1138)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool.doAcquireAndDecrementPendingAcquiresWithinLockOnSuccess(BasicResourcePool.java:1125)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool.access$700(BasicResourcePool.java:44)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask.run(BasicResourcePool.java:1870)</div><div class="line">		com.mchange.v2.async.ThreadPoolAsynchronousRunner$PoolThread.run(ThreadPoolAsynchronousRunner.java:696)</div><div class="line">		27 May 2016 06:33:26,173  WARN [C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|74e262f6]-AdminTaskTimer] ThreadPoolAsynchronousRunner:220 - Task com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask@5383aba6 (in deadlocked PoolThread) failed to complete in maximum time 60000ms. Trying interrupt().</div><div class="line">27 May 2016 06:33:26,173  WARN [C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|74e262f6]-AdminTaskTimer] ThreadPoolAsynchronousRunner:220 - Task com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask@38f907f5 (in deadlocked PoolThread) failed to complete in maximum time 60000ms. Trying interrupt().</div><div class="line">27 May 2016 06:33:26,174  WARN [C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|74e262f6]-AdminTaskTimer] ThreadPoolAsynchronousRunner:220 - Task com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask@204f2da (in deadlocked PoolThread) failed to complete in maximum time 60000ms. Trying interrupt().</div></pre></td></tr></table></figure>
<p>尝试重启后，log如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">27 May 2016 10:24:07,167  INFO [main] Configuration:791 - Reading password from existing file</div><div class="line">27 May 2016 10:24:07,197  INFO [main] Configuration:1128 - Hosts Mapping File null</div><div class="line">27 May 2016 10:24:07,197  INFO [main] HostsMap:60 - Using hostsmap file null</div><div class="line">27 May 2016 10:24:08,493  INFO [main] ControllerModule:195 - Detected MYSQL as the database type from the JDBC URL</div><div class="line">27 May 2016 10:24:08,522  INFO [main] ControllerModule:237 - Using c3p0 ComboPooledDataSource as the EclipsLink DataSource</div><div class="line">27 May 2016 10:24:08,582  INFO [MLog-Init-Reporter] MLog:212 - MLog clients using slf4j logging.</div><div class="line">27 May 2016 10:24:08,963  INFO [main] C3P0Registry:212 - Initializing c3p0-0.9.5.2 [built 08-December-2015 22:06:04 -0800; debug? true; trace: 10]</div><div class="line">27 May 2016 10:24:11,656  INFO [main] ControllerModule:596 - Binding and registering notification dispatcher class org.apache.ambari.server.notifications.dispatchers.SNMPDispatcher</div><div class="line">27 May 2016 10:24:11,665  INFO [main] ControllerModule:596 - Binding and registering notification dispatcher class org.apache.ambari.server.notifications.dispatchers.AlertScriptDispatcher</div></pre></td></tr></table></figure></p>
<p>想了一下会不会是mysql的问题，然后就尝试连接一下mysql —— 端口通，但是连接不上。找运维看了一下，mysql所在的机器的cpu爆满，有一个线程给打满了。</p>
<p>运维重启了，昨天集群跑任务的时候也是资源没有变，但是cpu被打满，以往同样的资源根本不会耗时那么多。个人怀疑是被人攻击了。</p>
<p>hive meta库重启之后，通过beeline是可以成功连接hive并查询的。但是hive命令行还是进不去，卡在:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[hive@datanode01 root]$ hive</div><div class="line">WARNING: Use &quot;yarn jar&quot; to launch YARN applications.</div><div class="line"></div><div class="line">Logging initialized using configuration in file:/etc/hive/2.4.2.0-258/0/hive-log4j.properties</div></pre></td></tr></table></figure></p>
<p>查看hive的log:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">2016-05-27 11:33:14,153 INFO  [main]: SessionState (SessionState.java:printInfo(953)) - </div><div class="line">Logging initialized using configuration in file:/etc/hive/2.4.2.0-258/0/hive-log4j.properties</div><div class="line">2016-05-27 11:33:14,653 INFO  [main]: hive.metastore (HiveMetaStoreClient.java:open(382)) - Trying to connect to metastore with URI thrift://datanode03.will.com:9083</div><div class="line">2016-05-27 11:33:14,736 INFO  [main]: hive.metastore (HiveMetaStoreClient.java:open(478)) - Connected to metastore.</div></pre></td></tr></table></figure></p>
<p>正常命令行log：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">2016-05-19 10:40:59,299 INFO  [main]: SessionState (SessionState.java:printInfo(953)) -</div><div class="line">Logging initialized using configuration in file:/etc/hive/2.4.2.0-258/0/hive-log4j.properties</div><div class="line">2016-05-19 10:41:00,519 INFO  [main]: hive.metastore (HiveMetaStoreClient.java:open(382)) - Trying to connect to metastore with URI thrift://datanode03.will.com:9083</div><div class="line">2016-05-19 10:41:01,125 INFO  [main]: hive.metastore (HiveMetaStoreClient.java:open(478)) - Connected to metastore.</div><div class="line">2016-05-19 10:41:04,652 INFO  [main]: session.SessionState (SessionState.java:createPath(633)) - Created local directory: /tmp/1d1a2120-6339-40c1-b63b-5dbd4dc71074_resources</div><div class="line">2016-05-19 10:41:04,664 INFO  [main]: session.SessionState (SessionState.java:createPath(633)) - Created HDFS directory: /tmp/hive/hive/1d1a2120-6339-40c1-b63b-5dbd4dc71074</div><div class="line">2016-05-19 10:41:04,666 INFO  [main]: session.SessionState (SessionState.java:createPath(633)) - Created local directory: /tmp/hive/1d1a2120-6339-40c1-b63b-5dbd4dc71074</div><div class="line">2016-05-19 10:41:04,669 INFO  [main]: session.SessionState (SessionState.java:createPath(633)) - Created HDFS directory: /tmp/hive/hive/1d1a2120-6339-40c1-b63b-5dbd4dc71074/_tmp_space.db</div><div class="line">2016-05-19 10:41:04,717 INFO  [main]: sqlstd.SQLStdHiveAccessController (SQLStdHiveAccessController.java:&lt;init&gt;(95)) - Created SQLStdHiveAccessController for session context : HiveAuthzSessionContext [sessionString=1d1a2120-6339-40c1-b63b-5dbd4dc71074, clientType=HIVECLI]</div><div class="line">2016-05-19 10:41:04,720 INFO  [main]: hive.metastore (HiveMetaStoreClient.java:isCompatibleWith(296)) - Mestastore configuration hive.metastore.filter.hook changed from org.apache.hadoop.hive.metastore.DefaultMetaStoreFilterHookImpl to org.apache.hadoop.hive.ql.security.authorization.plugin.AuthorizationMetaStoreFilterHook</div><div class="line">2016-05-19 11:21:13,947 INFO  [main]: hive.metastore (HiveMetaStoreClient.java:open(382)) - Trying to connect to metastore with URI thrift://datanode03.will.com:9083</div><div class="line">2016-05-19 11:21:13,951 INFO  [main]: hive.metastore (HiveMetaStoreClient.java:open(478)) - Connected to metastore.</div><div class="line">2016-05-19 11:21:14,674 INFO  [main]: SessionState (SessionState.java:printInfo(953)) - Added [/server/app/hive/will_hive_udf.jar] to class path</div><div class="line">2016-05-19 11:21:14,674 INFO  [main]: SessionState (SessionState.java:printInfo(953)) - Added resources: [/server/app/hive/will_hive_udf.jar]</div><div class="line">2016-05-19 11:21:14,858 INFO  [main]: log.PerfLogger (PerfLogger.java:PerfLogBegin(135)) - &lt;PERFLOG method=Driver.run from=org.apache.hadoop.hive.ql.Driver&gt;</div><div class="line">2016-05-19 11:21:14,858 INFO  [main]: log.PerfLogger (PerfLogger.java:PerfLogBegin(135)) - &lt;PERFLOG method=TimeToSubmit from=org.apache.hadoop.hive.ql.Driver&gt;</div><div class="line">2016-05-19 11:21:14,858 INFO  [main]: log.PerfLogger (PerfLogger.java:PerfLogBegin(135)) - &lt;PERFLOG method=compile from=org.apache.hadoop.hive.ql.Driver&gt;</div><div class="line">2016-05-19 11:21:14,923 INFO  [main]: ql.Driver (Driver.java:compile(420)) - We are setting the hadoop caller context from  to hive_20160519112114_e4649b5a-c094-40ff-a9b1-aa6ab595c967</div><div class="line">2016-05-19 11:21:14,928 INFO  [main]: log.PerfLogger (PerfLogger.java:PerfLogBegin(135)) - &lt;PERFLOG method=parse from=org.apache.hadoop.hive.ql.Driver&gt;</div><div class="line">2016-05-19 11:21:14,937 INFO  [main]: parse.ParseDriver (ParseDriver.java:parse(185)) - Parsing command: </div><div class="line">create temporary function  strstart as &apos;com.will.common.hive.StrStart&apos;</div><div class="line">2016-05-19 11:21:16,408 INFO  [main]: parse.ParseDriver (ParseDriver.java:parse(209)) - Parse Completed</div><div class="line">2016-05-19 11:21:16,411 INFO  [main]: log.PerfLogger (PerfLogger.java:PerfLogEnd(162)) - &lt;/PERFLOG method=parse start=1463628074928 end=1463628076411 duration=1483 from=org.apache.hadoop.hi</div><div class="line">ve.ql.Driver&gt;</div><div class="line">2016-05-19 11:21:16,412 INFO  [main]: log.PerfLogger (PerfLogger.java:PerfLogBegin(135)) - &lt;PERFLOG method=semanticAnalyze from=org.apache.hadoop.hive.ql.Driver&gt;</div><div class="line">2016-05-19 11:21:17,249 INFO  [main]: parse.FunctionSemanticAnalyzer (FunctionSemanticAnalyzer.java:analyzeInternal(66)) - analyze done</div><div class="line">2016-05-19 11:21:17,249 INFO  [main]: ql.Driver (Driver.java:compile(471)) - Semantic Analysis Completed</div></pre></td></tr></table></figure></p>
<p>可以看到是createPath那卡住了，建立临时会话相关文件。同事那边要得急，就直接把hive metastore重启了，就恢复正常了。<br>这样看来如果hive metastore和mysql meta库失去连接的话，即便mysql恢复正常，启动hive命令行的时候，HiveMetaStoreClient也会有问题。</p>
<p><strong>这个可以修复一下，然后commit给hive官网。。。</strong></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[cas-4.2.6-server配置与http支持]]></title>
      <url>/2016/12/05/cas-4.2.6-server%E9%85%8D%E7%BD%AE%E4%B8%8Ehttp%E6%94%AF%E6%8C%81/</url>
      <content type="html"><![CDATA[<h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p>下载cas-server-webapp-4.2.6.war，放置到tomcat9的webapps下。</p>
<p>开始使用的tomcat7，结果报错：Unable to process Jar entry。查了一下是tomcat版本过低的原因。</p>
<p>启动tomcat，确认war正常解压，cas server正常启动。<br>关闭tomcat。</p>
<h2 id="编辑"><a href="#编辑" class="headerlink" title="编辑"></a>编辑</h2><p>cas的主要配置文件在于deployerConfigContext.xml。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></div><div class="line">       <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></div><div class="line">       <span class="attr">xmlns:c</span>=<span class="string">"http://www.springframework.org/schema/c"</span></div><div class="line">       <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></div><div class="line">       <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></div><div class="line">       <span class="attr">xmlns:util</span>=<span class="string">"http://www.springframework.org/schema/util"</span></div><div class="line">       <span class="attr">xmlns:sec</span>=<span class="string">"http://www.springframework.org/schema/security"</span></div><div class="line">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></div><div class="line">       http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd</div><div class="line">       http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd</div><div class="line">       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</div><div class="line">       http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security.xsd</div><div class="line">       http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"&gt;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">util:map</span> <span class="attr">id</span>=<span class="string">"authenticationHandlersResolvers"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key-ref</span>=<span class="string">"proxyAuthenticationHandler"</span> <span class="attr">value-ref</span>=<span class="string">"proxyPrincipalResolver"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key-ref</span>=<span class="string">"primaryAuthenticationHandler"</span> <span class="attr">value-ref</span>=<span class="string">"primaryPrincipalResolver"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">util:map</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">util:list</span> <span class="attr">id</span>=<span class="string">"authenticationMetadataPopulators"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"successfulHandlerMetaDataPopulator"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"rememberMeAuthenticationMetaDataPopulator"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">util:list</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"attributeRepository"</span> <span class="attr">class</span>=<span class="string">"org.jasig.services.persondir.support.NamedStubPersonAttributeDao"</span></span></div><div class="line">          <span class="attr">p:backingMap-ref</span>=<span class="string">"attrRepoBackingMap"</span> /&gt;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- 设置数据源 --&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://127.0.0.1:3306/metamap1?useUnicode=true&amp;amp;characterEncoding=utf8"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"primaryAuthenticationHandler"</span></span></div><div class="line">      <span class="attr">class</span>=<span class="string">"com.will.cas.auth.WillAuthenticationHandler"</span></div><div class="line">      <span class="attr">p:dataSource-ref</span>=<span class="string">"dataSource"</span></div><div class="line">      /&gt;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- &lt;alias name="acceptUsersAuthenticationHandler" alias="primaryAuthenticationHandler" /&gt; --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"personDirectoryPrincipalResolver"</span> <span class="attr">alias</span>=<span class="string">"primaryPrincipalResolver"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">util:map</span> <span class="attr">id</span>=<span class="string">"attrRepoBackingMap"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"uid"</span> <span class="attr">value</span>=<span class="string">"uid"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"eduPersonAffiliation"</span> <span class="attr">value</span>=<span class="string">"eduPersonAffiliation"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"groupMembership"</span> <span class="attr">value</span>=<span class="string">"groupMembership"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">entry</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span><span class="tag">&lt;<span class="name">value</span>&gt;</span>memberOf<span class="tag">&lt;/<span class="name">value</span>&gt;</span><span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>faculty<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>staff<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>org<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">util:map</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"serviceThemeResolver"</span> <span class="attr">alias</span>=<span class="string">"themeResolver"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- &lt;alias name="jsonServiceRegistryDao" alias="serviceRegistryDao" /&gt; --&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- 注册服务 --&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"serviceRegistryDao"</span> <span class="attr">class</span>=<span class="string">"org.jasig.cas.services.InMemoryServiceRegistryDaoImpl"</span></span></div><div class="line">             <span class="attr">p:registeredServices-ref</span>=<span class="string">"registeredServicesList"</span> /&gt;</div><div class="line"> </div><div class="line">     <span class="tag">&lt;<span class="name">util:list</span> <span class="attr">id</span>=<span class="string">"registeredServicesList"</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.jasig.cas.services.RegexRegisteredService"</span></span></div><div class="line">               <span class="attr">p:id</span>=<span class="string">"0"</span> <span class="attr">p:name</span>=<span class="string">"HTTP and IMAP"</span> <span class="attr">p:description</span>=<span class="string">"Allows HTTP(S) and IMAP(S) protocols"</span></div><div class="line">               <span class="attr">p:serviceId</span>=<span class="string">"^(https?|http?|imaps?)://.*"</span> <span class="attr">p:evaluationOrder</span>=<span class="string">"10000001"</span> /&gt;</div><div class="line">     <span class="tag">&lt;/<span class="name">util:list</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"defaultTicketRegistry"</span> <span class="attr">alias</span>=<span class="string">"ticketRegistry"</span> /&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"ticketGrantingTicketExpirationPolicy"</span> <span class="attr">alias</span>=<span class="string">"grantingTicketExpirationPolicy"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"multiTimeUseOrTimeoutExpirationPolicy"</span> <span class="attr">alias</span>=<span class="string">"serviceTicketExpirationPolicy"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"anyAuthenticationPolicy"</span> <span class="attr">alias</span>=<span class="string">"authenticationPolicy"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"acceptAnyAuthenticationPolicyFactory"</span> <span class="attr">alias</span>=<span class="string">"authenticationPolicyFactory"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"auditTrailManager"</span></span></div><div class="line">          <span class="attr">class</span>=<span class="string">"org.jasig.inspektr.audit.support.Slf4jLoggingAuditTrailManager"</span></div><div class="line">          <span class="attr">p:entrySeparator</span>=<span class="string">"$&#123;cas.audit.singleline.separator:|&#125;"</span></div><div class="line">          <span class="attr">p:useSingleLine</span>=<span class="string">"$&#123;cas.audit.singleline:false&#125;"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"neverThrottle"</span> <span class="attr">alias</span>=<span class="string">"authenticationThrottle"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">util:list</span> <span class="attr">id</span>=<span class="string">"monitorsList"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"memoryMonitor"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"sessionMonitor"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">util:list</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"defaultPrincipalFactory"</span> <span class="attr">alias</span>=<span class="string">"principalFactory"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"defaultAuthenticationTransactionManager"</span> <span class="attr">alias</span>=<span class="string">"authenticationTransactionManager"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"defaultPrincipalElectionStrategy"</span> <span class="attr">alias</span>=<span class="string">"principalElectionStrategy"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"tgcCipherExecutor"</span> <span class="attr">alias</span>=<span class="string">"defaultCookieCipherExecutor"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>cas提供了几种连接数据库验证的实现，但是对于我们验证django用户的需求不适合，因为django用户的密码的加密salt是动态的。如果是简单的数据库用户验证，可以参考：<a href="https://apereo.github.io/cas/4.2.x/installation/Database-Authentication.html" target="_blank" rel="external">https://apereo.github.io/cas/4.2.x/installation/Database-Authentication.html</a></p>
<p>这里我们实现了一个自己的AuthenticationHandler，主要代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.will.cas.auth;<span class="comment">/* Example implementation of password hasher similar on Django's PasswordHasher</span></div><div class="line"> * Requires Java8 (but should be easy to port to older JREs)</div><div class="line"> * Currently it would work only for pbkdf2_sha256 algorithm</div><div class="line"> *</div><div class="line"> * Django code: https://github.com/django/django/blob/1.6.5/django/contrib/auth/hashers.py#L221</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.jasig.cas.authentication.HandlerResult;</div><div class="line"><span class="keyword">import</span> org.jasig.cas.authentication.PreventedException;</div><div class="line"><span class="keyword">import</span> org.jasig.cas.authentication.UsernamePasswordCredential;</div><div class="line"><span class="keyword">import</span> org.jasig.cas.authentication.handler.support.AbstractUsernamePasswordAuthenticationHandler;</div><div class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.crypto.SecretKey;</div><div class="line"><span class="keyword">import</span> javax.crypto.SecretKeyFactory;</div><div class="line"><span class="keyword">import</span> javax.crypto.spec.PBEKeySpec;</div><div class="line"><span class="keyword">import</span> javax.security.auth.login.FailedLoginException;</div><div class="line"><span class="keyword">import</span> javax.sql.DataSource;</div><div class="line"><span class="keyword">import</span> javax.validation.constraints.NotNull;</div><div class="line"><span class="keyword">import</span> java.nio.charset.Charset;</div><div class="line"><span class="keyword">import</span> java.security.GeneralSecurityException;</div><div class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</div><div class="line"><span class="keyword">import</span> java.security.spec.InvalidKeySpecException;</div><div class="line"><span class="keyword">import</span> java.security.spec.KeySpec;</div><div class="line"><span class="keyword">import</span> java.util.Base64;</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WillAuthenticationHandler</span> <span class="keyword">extends</span> <span class="title">AbstractUsernamePasswordAuthenticationHandler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> DataSource dataSource;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Method to set the datasource and generate a JdbcTemplate.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> dataSource the datasource to use.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(@NotNull <span class="keyword">final</span> DataSource dataSource)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);</div><div class="line">        <span class="keyword">this</span>.dataSource = dataSource;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Method to return the jdbcTemplate.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> a fully created JdbcTemplate.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> JdbcTemplate <span class="title">getJdbcTemplate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.jdbcTemplate;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> DataSource <span class="title">getDataSource</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.dataSource;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Integer DEFAULT_ITERATIONS = <span class="number">10000</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String algorithm = <span class="string">"pbkdf2_sha256"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WillAuthenticationHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> HandlerResult <span class="title">authenticateUsernamePasswordInternal</span><span class="params">(UsernamePasswordCredential credential)</span> <span class="keyword">throws</span> GeneralSecurityException, PreventedException </span>&#123;</div><div class="line">        String username = credential.getUsername();</div><div class="line">        String pwd = credential.getPassword();</div><div class="line">        System.out.println(<span class="string">"Got username : "</span> + username + <span class="string">" and password : "</span> + pwd);</div><div class="line">        <span class="keyword">int</span> count = <span class="keyword">this</span>.jdbcTemplate.queryForObject(<span class="string">"select count(1) from auth_user where username=?"</span>, Integer.class, username);</div><div class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</div><div class="line">            System.out.println(username + <span class="string">" not found with SQL query."</span>);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FailedLoginException(username + <span class="string">" not found with SQL query."</span>);</div><div class="line">        &#125;</div><div class="line">        String encyptedPassword = <span class="keyword">this</span>.jdbcTemplate.queryForObject(<span class="string">"select password from auth_user where username=?"</span>, String.class, username);</div><div class="line">        System.out.println(<span class="string">"Got encyptedPassword : "</span> + encyptedPassword);</div><div class="line">        <span class="keyword">if</span> (checkPassword(pwd, encyptedPassword)) &#123;</div><div class="line">            System.out.println(<span class="string">" auth success for user : "</span> + username);</div><div class="line">            <span class="keyword">return</span> createHandlerResult(credential, <span class="keyword">this</span>.principalFactory.createPrincipal(username), <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> FailedLoginException(username + <span class="string">"'s password is wrong for : "</span> + pwd);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getEncodedHash</span><span class="params">(String password, String salt, <span class="keyword">int</span> iterations)</span> </span>&#123;</div><div class="line">        <span class="comment">// Returns only the last part of whole encoded password</span></div><div class="line">        SecretKeyFactory keyFactory = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            keyFactory = SecretKeyFactory.getInstance(<span class="string">"PBKDF2WithHmacSHA256"</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</div><div class="line">            System.err.println(<span class="string">"Could NOT retrieve PBKDF2WithHmacSHA256 algorithm"</span>);</div><div class="line">            System.exit(<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">        KeySpec keySpec = <span class="keyword">new</span> PBEKeySpec(password.toCharArray(), salt.getBytes(Charset.forName(<span class="string">"UTF-8"</span>)), iterations, <span class="number">256</span>);</div><div class="line">        SecretKey secret = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            secret = keyFactory.generateSecret(keySpec);</div><div class="line">        &#125; <span class="keyword">catch</span> (InvalidKeySpecException e) &#123;</div><div class="line">            System.out.println(<span class="string">"Could NOT generate secret key"</span>);</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">byte</span>[] rawHash = secret.getEncoded();</div><div class="line">        <span class="keyword">byte</span>[] hashBase64 = Base64.getEncoder().encode(rawHash);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String(hashBase64);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">encode</span><span class="params">(String password, String salt, <span class="keyword">int</span> iterations)</span> </span>&#123;</div><div class="line">        <span class="comment">// returns hashed password, along with algorithm, number of iterations and salt</span></div><div class="line">        String hash = getEncodedHash(password, salt, iterations);</div><div class="line">        <span class="keyword">return</span> String.format(<span class="string">"%s$%d$%s$%s"</span>, algorithm, iterations, salt, hash);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">encode</span><span class="params">(String password, String salt)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.encode(password, salt, <span class="keyword">this</span>.DEFAULT_ITERATIONS);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkPassword</span><span class="params">(String password, String hashedPassword)</span> </span>&#123;</div><div class="line">        <span class="comment">// hashedPassword consist of: ALGORITHM, ITERATIONS_NUMBER, SALT and</span></div><div class="line">        <span class="comment">// HASH; parts are joined with dollar character ("$")</span></div><div class="line">        String[] parts = hashedPassword.split(<span class="string">"\\$"</span>);</div><div class="line">        <span class="keyword">if</span> (parts.length != <span class="number">4</span>) &#123;</div><div class="line">            <span class="comment">// wrong hash format</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        Integer iterations = Integer.parseInt(parts[<span class="number">1</span>]);</div><div class="line">        String salt = parts[<span class="number">2</span>];</div><div class="line">        String hash = encode(password, salt, iterations);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> hash.equals(hashedPassword);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Following examples can be generated at any Django project:</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">//  &gt;&gt;&gt; from django.contrib.auth.hashers import make_password</span></div><div class="line">    <span class="comment">//  &gt;&gt;&gt; make_password('mystery', hasher='pbkdf2_sha256')  # salt would be randomly generated</span></div><div class="line">    <span class="comment">//  'pbkdf2_sha256$10000$HqxvKtloKLwx$HdmdWrgv5NEuaM4S6uMvj8/s+5Yj+I/d1ay6zQyHxdg='</span></div><div class="line">    <span class="comment">//  &gt;&gt;&gt; make_password('mystery', salt='mysalt', hasher='pbkdf2_sha256')</span></div><div class="line">    <span class="comment">//  'pbkdf2_sha256$10000$mysalt$KjUU5KrwyUbKTGYkHqBo1IwUbFBzKXrGQgwA1p2AuY0='</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// mystery</span></div><div class="line">    <span class="comment">// pbkdf2_sha256$10000$qx1ec0f4lu4l$3G81rAm/4ng0tCCPTrx2aWohq7ztDBfFYczGNoUtiKQ=</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// s3cr3t</span></div><div class="line">    <span class="comment">// pbkdf2_sha256$10000$BjDHOELBk7fR$xkh1Xf6ooTqwkflS3rAiz5Z4qOV1Jd5Lwd8P+xGtW+I=</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// puzzle</span></div><div class="line">    <span class="comment">// pbkdf2_sha256$10000$IFYFG7hiiKYP$rf8vHYFD7K4q2N3DQYfgvkiqpFPGCTYn6ZoenLE3jLc=</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// riddle</span></div><div class="line">    <span class="comment">// pbkdf2_sha256$10000$A0S5o3pNIEq4$Rk2sxXr8bonIDOGj6SU4H/xpjKHhHAKpFXfmNZ0dnEY=</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        runTests();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runTests</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"==========================="</span>);</div><div class="line">        System.out.println(<span class="string">"= Testing password hasher ="</span>);</div><div class="line">        System.out.println(<span class="string">"==========================="</span>);</div><div class="line">        System.out.println();</div><div class="line"></div><div class="line">        System.out.println();</div><div class="line">        passwordShouldMatch(<span class="string">"admin"</span>, <span class="string">"pbkdf2_sha256$12000$g3UeiuUEnwfp$Qr/Qb6cCntnCflkBcJ+OenxWubIu6O84xLWGgWqNftw="</span>);</div><div class="line">        passwordShouldMatch(<span class="string">"will@2016"</span>, <span class="string">"pbkdf2_sha256$30000$tTJpdOsd3eoN$GcBF0YoHg8eV7s6NBqjX1i3VllEIeYuMUsyH5stzuw4="</span>);</div><div class="line"></div><div class="line">        System.out.println();</div><div class="line">        passwordShouldNotMatch(<span class="string">"foo"</span>, <span class="string">""</span>);</div><div class="line">        passwordShouldNotMatch(<span class="string">"mystery"</span>, <span class="string">"pbkdf2_md5$10000$qx1ec0f4lu4l$3G81rAm/4ng0tCCPTrx2aWohq7ztDBfFYczGNoUtiKQ="</span>);</div><div class="line">        passwordShouldNotMatch(<span class="string">"mystery"</span>, <span class="string">"pbkdf2_sha1$10000$qx1ec0f4lu4l$3G81rAm/4ng0tCCPTrx2aWohq7ztDBfFYczGNoUtiKQ="</span>);</div><div class="line">        passwordShouldNotMatch(<span class="string">"mystery"</span>, <span class="string">"pbkdf2_sha256$10001$Qx1ec0f4lu4l$3G81rAm/4ng0tCCPTrx2aWohq7ztDBfFYczGNoUtiKQ="</span>);</div><div class="line">        passwordShouldNotMatch(<span class="string">"mystery"</span>, <span class="string">"pbkdf2_sha256$10001$qx1ec0f4lu4l$3G81rAm/4ng0tCCPTrx2aWohq7ztDBfFYczGNoUtiKQ="</span>);</div><div class="line">        passwordShouldNotMatch(<span class="string">"mystery"</span>, <span class="string">"pbkdf2_sha256$10000$qx7ztDBfFYczGNoUtiKQ="</span>);</div><div class="line">        passwordShouldNotMatch(<span class="string">"s3cr3t"</span>, <span class="string">"pbkdf2_sha256$10000$BjDHOELBk7fR$foobar"</span>);</div><div class="line">        passwordShouldNotMatch(<span class="string">"puzzle"</span>, <span class="string">"pbkdf2_sha256$10000$IFYFG7hiiKYP$rf8vHYFD7K4q2N3DQYfgvkiqpFPGCTYn6ZoenLE3jLcX"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">passwordShouldMatch</span><span class="params">(String password, String expectedHash)</span> </span>&#123;</div><div class="line">        WillAuthenticationHandler willAuthenticationHandler = <span class="keyword">new</span> WillAuthenticationHandler();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (willAuthenticationHandler.checkPassword(password, expectedHash)) &#123;</div><div class="line">            System.out.println(<span class="string">" =&gt; OK"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            String[] parts = expectedHash.split(<span class="string">"\\$"</span>);</div><div class="line">            <span class="keyword">if</span> (parts.length != <span class="number">4</span>) &#123;</div><div class="line">                System.out.printf(<span class="string">" =&gt; Wrong hash provided: '%s'\n"</span>, expectedHash);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            String salt = parts[<span class="number">2</span>];</div><div class="line">            String resultHash = willAuthenticationHandler.encode(password, salt);</div><div class="line">            String msg = <span class="string">" =&gt; Wrong! Password '%s' hash expected to be '%s' but is '%s'\n"</span>;</div><div class="line">            System.out.printf(msg, password, expectedHash, resultHash);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">passwordShouldNotMatch</span><span class="params">(String password, String expectedHash)</span> </span>&#123;</div><div class="line">        WillAuthenticationHandler willAuthenticationHandler = <span class="keyword">new</span> WillAuthenticationHandler();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (willAuthenticationHandler.checkPassword(password, expectedHash)) &#123;</div><div class="line">            System.out.printf(<span class="string">" =&gt; Wrong (password '%s' did '%s' match but were not supposed to)\n"</span>, password, expectedHash);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            System.out.println(<span class="string">" =&gt; OK (password didn't match)"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>基本是抄袭了AbstractJdbcUsernamePasswordAuthenticationHandler的内容，然后执行了自己的算法实现。本来是可以直接继承AbstractJdbcUsernamePasswordAuthenticationHandler，重写方法实现的，但是考虑到我们要兼容很多个系统的数据库用户，所以需要多个dataSource和jdbcTemplate，就放弃了。</p>
<p>对于cas配置的切入点在于authenticationHandlersResolvers，以前版本的都是有个authenticationManager，然后编辑他的构造参数来定义认证处理器的，4.2.6貌似把它内置了。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"> <span class="tag">&lt;<span class="name">util:map</span> <span class="attr">id</span>=<span class="string">"authenticationHandlersResolvers"</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key-ref</span>=<span class="string">"proxyAuthenticationHandler"</span> <span class="attr">value-ref</span>=<span class="string">"proxyPrincipalResolver"</span> /&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key-ref</span>=<span class="string">"primaryAuthenticationHandler"</span> <span class="attr">value-ref</span>=<span class="string">"primaryPrincipalResolver"</span> /&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">util:map</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://127.0.0.1:3306/metamap1?useUnicode=true&amp;amp;characterEncoding=utf8"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"primaryAuthenticationHandler"</span></span></div><div class="line">     <span class="attr">class</span>=<span class="string">"com.will.cas.auth.WillAuthenticationHandler"</span></div><div class="line">     <span class="attr">p:dataSource-ref</span>=<span class="string">"dataSource"</span></div><div class="line">     /&gt;</div></pre></td></tr></table></figure>
<p>如此，便指定了自定义的认证处理器。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>在app1配置cas server为当前cas server后，跳转到登录页面，结果提示：</p>
<blockquote>
<p>未认证的授权服务 不允许使用CAS来认证您访问的目标应用</p>
</blockquote>
<p>查了一下解决方案，同样是在deployerConfigContext.xml中配置服务注册的DAO serviceRegistryDao为内存实现类，然后使用正则表达式表示这个cas server接收的服务：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"jsonServiceRegistryDao"</span> <span class="attr">alias</span>=<span class="string">"serviceRegistryDao"</span> /&gt;</span></div></pre></td></tr></table></figure></p>
<p>改为：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"serviceRegistryDao"</span> <span class="attr">class</span>=<span class="string">"org.jasig.cas.services.InMemoryServiceRegistryDaoImpl"</span></span></div><div class="line">             <span class="attr">p:registeredServices-ref</span>=<span class="string">"registeredServicesList"</span> /&gt;</div><div class="line"> </div><div class="line">     <span class="tag">&lt;<span class="name">util:list</span> <span class="attr">id</span>=<span class="string">"registeredServicesList"</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.jasig.cas.services.RegexRegisteredService"</span></span></div><div class="line">               <span class="attr">p:id</span>=<span class="string">"0"</span> <span class="attr">p:name</span>=<span class="string">"HTTP and IMAP"</span> <span class="attr">p:description</span>=<span class="string">"Allows HTTP(S) and IMAP(S) protocols"</span></div><div class="line">               <span class="attr">p:serviceId</span>=<span class="string">"^(https?|http?|imaps?)://.*"</span> <span class="attr">p:evaluationOrder</span>=<span class="string">"10000001"</span> /&gt;</div><div class="line">     <span class="tag">&lt;/<span class="name">util:list</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>其实理论上应该也可以在默认的jsonServiceRegistryDao配置的，但是找了一会儿没有找到json配置文件的位置。注意了一下貌似它是属于cas-addons的，有些插件的意思，后面再探查一下。</p>
<p>参考：</p>
<ul>
<li><a href="https://github.com/Unicon/cas-addons/wiki/Configuring-JSON-Service-Registry" target="_blank" rel="external">https://github.com/Unicon/cas-addons/wiki/Configuring-JSON-Service-Registry</a></li>
<li><a href="http://www.cnphp6.com/archives/133139" target="_blank" rel="external">http://www.cnphp6.com/archives/133139</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[mondrian-定义schema]]></title>
      <url>/2016/12/05/mondrian-%E5%AE%9A%E4%B9%89schema/</url>
      <content type="html"><![CDATA[<p>一个schema定义了一个多维数据库。它包含一个逻辑模型，这个逻辑模型中包含了多个立方体、层级、成员、以及将这个模型映射到物理模型的映射。</p>
<p>逻辑模型包含了MDX语言中的构造组件：: cubes, dimensions, hierarchies, levels, and members.<br>物理模型是物理数据源。一般是星型模型，就是RDBMS中的一堆表。</p>
<h2 id="Scheme-文件"><a href="#Scheme-文件" class="headerlink" title="Scheme 文件"></a>Scheme 文件</h2><p>mondrian的schema是定义在xml文件中的。有一个比较全面的例子demo/FoodMart.xml。目前，创建schema只能通过编辑xml文件来实现。下面是xml结构：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Schema</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Cube</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Table</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">AggName</span>&gt;</span></div><div class="line">aggElements</div><div class="line"><span class="tag">&lt;<span class="name">AggPattern</span>&gt;</span></div><div class="line">aggElements</div><div class="line"><span class="tag">&lt;<span class="name">Dimension</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Hierarchy</span>&gt;</span></div><div class="line">relation</div><div class="line"><span class="tag">&lt;<span class="name">Closure</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Level</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">KeyExpression</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">SQL</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">NameExpression</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">SQL</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">CaptionExpression</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">SQL</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">OrdinalExpression</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">SQL</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">ParentExpression</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">SQL</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Property</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">PropertyExpression</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">SQL</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">DimensionUsage</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Measure</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">MeasureExpression</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">SQL</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">CalculatedMemberProperty</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">CalculatedMember</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Formula</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">CalculatedMemberProperty</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">NamedSet</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Formula</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">VirtualCube</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">CubeUsages</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">CubeUsage</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">VirtualCubeDimension</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">VirtualCubeMeasure</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Role</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">SchemaGrant</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">CubeGrant</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">DimensionGrant</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">HierarchyGrant</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">MemberGrant</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Union</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">RoleUsage</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">UserDefinedFunction</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Parameter</span>/&gt;</span></div><div class="line"></div><div class="line">relation ::=</div><div class="line"><span class="tag">&lt;<span class="name">Table</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">SQL</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">View</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">SQL</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">InlineTable</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">ColumnDefs</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">ColumnDef</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Rows</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Row</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Value</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Join</span>&gt;</span></div><div class="line">relation</div><div class="line"></div><div class="line">aggElement ::=</div><div class="line"><span class="tag">&lt;<span class="name">AggExclude</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">AggFactCount</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">AggIgnoreColumn</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">AggForeignKey</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">AggMeasure</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">AggLevel</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>注意：xml元素的顺序。<userdefinedfunction> 必须在 <cube>, <virtualcube>, <namedset> and <role> 元素后面。</role></namedset></virtualcube></cube></userdefinedfunction></p>
<h4 id="2-1-注解"><a href="#2-1-注解" class="headerlink" title="2.1 注解"></a>2.1 注解</h4><p>主要的元素(schema, cube, virtual cube, shared dimension, dimension, hierarchy, level, measure, calculated member)都支持注解。注解能够把用户定义的属性和元数据元素联系起来，允许工具在不继承mondrian schema的前提下添加元数据。</p>
<p>下面例子，为Schema添加了 Author和Date两个注解。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Schema</span> <span class="attr">name</span>=<span class="string">"Rock Sales"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Annotations</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Annotation</span> <span class="attr">name</span>=<span class="string">"Author"</span>&gt;</span>Fred Flintstone<span class="tag">&lt;/<span class="name">Annotation</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Annotation</span> <span class="attr">name</span>=<span class="string">"Date"</span>&gt;</span>10,000 BC<span class="tag">&lt;/<span class="name">Annotation</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Annotations</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Cube</span> <span class="attr">name</span>=<span class="string">"Sales"</span>&gt;</span></div><div class="line">...</div></pre></td></tr></table></figure></p>
<h2 id="3-逻辑模型"><a href="#3-逻辑模型" class="headerlink" title="3 逻辑模型"></a>3 逻辑模型</h2><p>最重要的三个组件： cubes, measures, dimensions。</p>
<ul>
<li>cube。 维度和指标在指定子区域的集合。</li>
<li>measure。量化的指标。</li>
<li>dimension。可切分指标的属性。</li>
</ul>
<p>下面是一个简单的schema:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Schema</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Cube</span> <span class="attr">name</span>=<span class="string">"Sales"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Table</span> <span class="attr">name</span>=<span class="string">"sales_fact_1997"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Dimension</span> <span class="attr">name</span>=<span class="string">"Gender"</span> <span class="attr">foreignKey</span>=<span class="string">"customer_id"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">Hierarchy</span> <span class="attr">hasAll</span>=<span class="string">"true"</span> <span class="attr">allMemberName</span>=<span class="string">"All Genders"</span> <span class="attr">primaryKey</span>=<span class="string">"customer_id"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">Table</span> <span class="attr">name</span>=<span class="string">"customer"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Gender"</span> <span class="attr">column</span>=<span class="string">"gender"</span> <span class="attr">uniqueMembers</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">Hierarchy</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">Dimension</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Dimension</span> <span class="attr">name</span>=<span class="string">"Time"</span> <span class="attr">foreignKey</span>=<span class="string">"time_id"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">Hierarchy</span> <span class="attr">hasAll</span>=<span class="string">"false"</span> <span class="attr">primaryKey</span>=<span class="string">"time_id"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">Table</span> <span class="attr">name</span>=<span class="string">"time_by_day"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Year"</span> <span class="attr">column</span>=<span class="string">"the_year"</span> <span class="attr">type</span>=<span class="string">"Numeric"</span> <span class="attr">uniqueMembers</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Quarter"</span> <span class="attr">column</span>=<span class="string">"quarter"</span> <span class="attr">uniqueMembers</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Month"</span> <span class="attr">column</span>=<span class="string">"month_of_year"</span> <span class="attr">type</span>=<span class="string">"Numeric"</span> <span class="attr">uniqueMembers</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">Hierarchy</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">Dimension</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Measure</span> <span class="attr">name</span>=<span class="string">"Unit Sales"</span> <span class="attr">column</span>=<span class="string">"unit_sales"</span> <span class="attr">aggregator</span>=<span class="string">"sum"</span> <span class="attr">formatString</span>=<span class="string">"#,###"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Measure</span> <span class="attr">name</span>=<span class="string">"Store Sales"</span> <span class="attr">column</span>=<span class="string">"store_sales"</span> <span class="attr">aggregator</span>=<span class="string">"sum"</span> <span class="attr">formatString</span>=<span class="string">"#,###.##"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Measure</span> <span class="attr">name</span>=<span class="string">"Store Cost"</span> <span class="attr">column</span>=<span class="string">"store_cost"</span> <span class="attr">aggregator</span>=<span class="string">"sum"</span> <span class="attr">formatString</span>=<span class="string">"#,###.00"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">CalculatedMember</span> <span class="attr">name</span>=<span class="string">"Profit"</span> <span class="attr">dimension</span>=<span class="string">"Measures"</span> <span class="attr">formula</span>=<span class="string">"[Measures].[Store Sales] - [Measures].[Store Cost]"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">CalculatedMemberProperty</span> <span class="attr">name</span>=<span class="string">"FORMAT_STRING"</span> <span class="attr">value</span>=<span class="string">"$#,##0.00"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">CalculatedMember</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">Cube</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Schema</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这个schema只有一个立方体，叫做’sales’。两个维度，time和gender。四个指标。</p>
<p>我们可以基于这个schema写出如下MDX查询：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> &#123;[<span class="keyword">Measures</span>].[Unit Sales], [<span class="keyword">Measures</span>].[<span class="keyword">Store</span> Sales]&#125; <span class="keyword">ON</span> <span class="keyword">COLUMNS</span>,</div><div class="line">  &#123;descendants([<span class="keyword">Time</span>].[<span class="number">1997</span>].[Q1])&#125; <span class="keyword">ON</span> <span class="keyword">ROWS</span></div><div class="line"><span class="keyword">FROM</span> [Sales]</div><div class="line"><span class="keyword">WHERE</span> [Gender].[F]</div></pre></td></tr></table></figure></p>
<h4 id="3-1-cube"><a href="#3-1-cube" class="headerlink" title="3.1 cube"></a>3.1 cube</h4><p>cube是指标和维度的集合。指标和维度的共同处之一就是都在事实表上，这里就是 “sales_fact_1997表。指标基于事实表里的字段计算，事实表里也包含所有的维度。</p>
<p>事实表使用<table>元素定义。如果事实表不在默认的schema中，你可以使用schema属性明确指定：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Table</span> <span class="attr">schema</span>=<span class="string">" dmart"</span> <span class="attr">name</span>=<span class="string">"sales_fact_1997"</span>/&gt;</span></div></pre></td></tr></table></figure></table></p>
<p>还可以使用<view>构造更复杂的SQL语句。事实表不支持<join>。</join></view></p>
<h4 id="3-2-measure"><a href="#3-2-measure" class="headerlink" title="3.2 measure"></a>3.2 measure</h4><p>Sales cube定义了 “Unit Sales” 和 “Store Sales”几个指标。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Measure</span> <span class="attr">name</span>=<span class="string">"Unit Sales"</span> <span class="attr">column</span>=<span class="string">"unit_sales"</span> <span class="attr">aggregator</span>=<span class="string">"sum"</span> <span class="attr">datatype</span>=<span class="string">"Integer"</span> <span class="attr">formatString</span>=<span class="string">"#,###"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Measure</span> <span class="attr">name</span>=<span class="string">"Store Sales"</span> <span class="attr">column</span>=<span class="string">"store_sales"</span> <span class="attr">aggregator</span>=<span class="string">"sum"</span> <span class="attr">datatype</span>=<span class="string">"Numeric"</span> <span class="attr">formatString</span>=<span class="string">"#,###.00"</span>/&gt;</span></div></pre></td></tr></table></figure></p>
<p>datatype是可选的属性，它指示着这个指标在mondrian缓存中存在的形式，也决定这些指标怎样通过XML返回。(“String”, “Integer”, “Numeric”, “Boolean”, “Date”, “Time”, “Timestamp”) 。 除了”count”或者 “distinct-count” 是”Integer”，其他的aggregator的默认值都是”Numeric”。</p>
<p>formatString也是可选的，它代表指标被打印的形式。<a href="http://mondrian.pentaho.com/documentation/mdx.php#Format_strings" target="_blank" rel="external">更多参考</a></p>
<p>获取某个指标的名称可以调用 Member.getCaption() 。</p>
<p>指标使用cell reader，而不是读取column，或者也能使用sql表达式来计算。 “Promotion Sales”就是通过sql表达式计算的：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Measure</span> <span class="attr">name</span>=<span class="string">"Promotion Sales"</span> <span class="attr">aggregator</span>=<span class="string">"sum"</span> <span class="attr">formatString</span>=<span class="string">"#,###.00"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">MeasureExpression</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">SQL</span> <span class="attr">dialect</span>=<span class="string">"generic"</span>&gt;</span></div><div class="line">			(case when sales_fact_1997.promotion_id = 0 then 0 else sales_fact_1997.store_sales end)</div><div class="line">		<span class="tag">&lt;/<span class="name">SQL</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">MeasureExpression</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Measure</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>要格式化cell 值，<a href="http://mondrian.pentaho.com/documentation/schema.php#Cell_formatter" target="_blank" rel="external">请参考</a></p>
<h4 id="3-3-dimension-hierarchy-level"><a href="#3-3-dimension-hierarchy-level" class="headerlink" title="3.3 dimension, hierarchy, level"></a>3.3 dimension, hierarchy, level</h4><p>先看一些定义：</p>
<ul>
<li>member。 指定维度中的一个点。性别hierarchy包含M和F两个member。</li>
<li>hierarchy。一组形成某个结构的member。store hierarchy包含name, city, state, nation。这个hierarchy允许出现中间层次，一个state的子聚合（sub-total）是这个state的所有city的所有子聚合(sub-total)之和。</li>
<li>level。同一个level的member距离hierarchy最上层root的距离相等，也就是说在同一层上</li>
<li>dimemsion。一组hierarchy的集合，用来区分同一个事实表中的属性。</li>
</ul>
<p>例子：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Dimension</span> <span class="attr">name</span>=<span class="string">"Gender"</span> <span class="attr">foreignKey</span>=<span class="string">"customer_id"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">Hierarchy</span> <span class="attr">hasAll</span>=<span class="string">"true"</span> <span class="attr">primaryKey</span>=<span class="string">"customer_id"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Table</span> <span class="attr">name</span>=<span class="string">"customer"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Gender"</span> <span class="attr">column</span>=<span class="string">"gender"</span> <span class="attr">uniqueMembers</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">Hierarchy</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Dimension</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这个维度包含了一个hierarchy，这个hierarchy包含了一个level。这个维度的值来源于customer表的gender字段。</p>
<p>对于任意一个订单，gender维度是这个顾客的性别，应该是事实表 “sales_fact_1997.customer_id” 和维度表”customer.customer_id” join的结果。</p>
<h5 id="3-3-1-将维度和hierarchy映射到表"><a href="#3-3-1-将维度和hierarchy映射到表" class="headerlink" title="3.3.1 将维度和hierarchy映射到表"></a>3.3.1 将维度和hierarchy映射到表</h5><p>一个维度通过一对儿字段join进入一个cube，一个字段来自事实表，另一个来自维度表。 <dimension>元素有一个foreignKey属性，它是事实表里字段的名字。<hierarchy>元素有一个primaryKey属性。</hierarchy></dimension></p>
<p>如果hierarchy涉及到多个表，我们可以使用primaryKey来区分。</p>
<p>column属性定义了level的key。必须是在level表中的名字。如果key是一个表达式，可以在level中使用<keyexpression>元素。下面是一个例子<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Dimension</span> <span class="attr">name</span>=<span class="string">"Gender"</span> <span class="attr">foreignKey</span>=<span class="string">"customer_id"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">Hierarchy</span> <span class="attr">hasAll</span>=<span class="string">"true"</span> <span class="attr">primaryKey</span>=<span class="string">"customer_id"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">Table</span> <span class="attr">name</span>=<span class="string">"customer"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Gender"</span> <span class="attr">column</span>=<span class="string">"gender"</span> <span class="attr">uniqueMembers</span>=<span class="string">"true"</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">KeyExpression</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">SQL</span> <span class="attr">dialect</span>=<span class="string">"generic"</span>&gt;</span>customer.gender<span class="tag">&lt;/<span class="name">SQL</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">KeyExpression</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">Level</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">Hierarchy</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Dimension</span>&gt;</span></div></pre></td></tr></table></figure></keyexpression></p>
<p><level>, <measure>, <property>还有一些嵌套属性：<br>Parent element    | 属性 |    Equivalent nested element |    描述<br>—|—|—|—</property></measure></level></p>
<p><level>    |     column        | <keyexpression>        | Key of level.</keyexpression></level></p>
<p><level |="" namecolumn="" <nameexpression="">    |     Expression which defines the name of members of this level. If not specified, the level key is used.</level></p>
<p><level>        | ordinalColumn    |     <ordinalexpression>    |     Expression which defines the order of members. If not specified, the level key is used.</ordinalexpression></level></p>
<p><level>        | captionColumn        | <captionexpression>    |     Expression which forms the caption of members. If not specified, the level name is used.</captionexpression></level></p>
<p><level>        |     |     <parentexpression>    |     Expression by which child members reference their parent member in a parent-child hierarchy. Not specified in a regular hierarchy.</parentexpression></level></p>
<p><measure>    |     column    |     <measureexpression>        | SQL expression to calculate the value of the measure (the argument to the SQL aggregate function).</measureexpression></measure></p>
<p><property>        | column    |     <propertyexpression>    |     SQL expression to calculate the value of the property.</propertyexpression></property></p>
<p>uniqueMembers 属性用来优化SQL生成过程。如果知道某个level字段的值是唯一的，就设置uniqueMembers为true。 例如[Year].[Month] 在Month level就不是唯一的，因为在不同年里会出现相同的月份。而[Product Class].[Product Name] 就是唯一的，因为产品名字不会有相同的。顶层的都是唯一的。</p>
<p>highCardinality 属性通知mondrian当前维度会有很大的不可预估的值。</p>
<h5 id="3-3-2-‘all’-member"><a href="#3-3-2-‘all’-member" class="headerlink" title="3.3.2 ‘all’ member"></a>3.3.2 ‘all’ member</h5><p>默认每个hierarchy都有一个顶层节点level，’all’。它是所有其他member的父节点，也是这个hierarchy的默认值，当hierarchy没有被包含在某个坐标系或者切片的时候，就使用这个值来计算cell值。allMemberName 和allLevelName 属性重写所有level和所有member的默认名称。</p>
<p>如果 <hierarchy> 元素有属性 hasAll=”false”，那么’all’这个level就失效了。维度的默认值就成了第一个level里的第一个元素，如果是time hierarchy的话，就是hierarchy的第一年。修改默认值的话，容易产生混淆，所以含是使用 hasAll=”true”吧。</hierarchy></p>
<p>下面是覆盖默认值的例子<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Dimension</span> <span class="attr">name</span>=<span class="string">"Time"</span> <span class="attr">type</span>=<span class="string">"TimeDimension"</span> <span class="attr">foreignKey</span>=<span class="string">"time_id"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Hierarchy</span> <span class="attr">hasAll</span>=<span class="string">"false"</span> <span class="attr">primaryKey</span>=<span class="string">"time_id"</span> <span class="attr">defaultMember</span>=<span class="string">"[Time].[1997].[Q1].[1]"</span>/&gt;</span></div><div class="line">    ....</div></pre></td></tr></table></figure></p>
<h5 id="3-3-3-Time-dimemsion"><a href="#3-3-3-Time-dimemsion" class="headerlink" title="3.3.3 Time dimemsion"></a>3.3.3 Time dimemsion</h5><p>时间维度是基于年月周日的。与之相关的MDX的内置函数如下：</p>
<ul>
<li>ParallelPeriod([level[, index[, member]]])</li>
<li>PeriodsToDate([level[, member]])</li>
<li>WTD([member])</li>
<li>MTD([member])</li>
<li>QTD([member])</li>
<li>YTD([member])</li>
<li>LastPeriod(index[, member])</li>
</ul>
<p>例子<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Dimension</span> <span class="attr">name</span>=<span class="string">"Time"</span> <span class="attr">type</span>=<span class="string">"TimeDimension"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">Hierarchy</span> <span class="attr">hasAll</span>=<span class="string">"true"</span> <span class="attr">allMemberName</span>=<span class="string">"All Periods"</span> <span class="attr">primaryKey</span>=<span class="string">"dateid"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Table</span> <span class="attr">name</span>=<span class="string">"datehierarchy"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Year"</span> <span class="attr">column</span>=<span class="string">"year"</span> <span class="attr">uniqueMembers</span>=<span class="string">"true"</span> <span class="attr">levelType</span>=<span class="string">"TimeYears"</span> <span class="attr">type</span>=<span class="string">"Numeric"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Quarter"</span> <span class="attr">column</span>=<span class="string">"quarter"</span> <span class="attr">uniqueMembers</span>=<span class="string">"false"</span> <span class="attr">levelType</span>=<span class="string">"TimeQuarters"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Month"</span> <span class="attr">column</span>=<span class="string">"month"</span> <span class="attr">uniqueMembers</span>=<span class="string">"false"</span> <span class="attr">ordinalColumn</span>=<span class="string">"month"</span> <span class="attr">nameColumn</span>=<span class="string">"month_name"</span> <span class="attr">levelType</span>=<span class="string">"TimeMonths"</span> <span class="attr">type</span>=<span class="string">"Numeric"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Week"</span> <span class="attr">column</span>=<span class="string">"week_in_month"</span> <span class="attr">uniqueMembers</span>=<span class="string">"false"</span> <span class="attr">levelType</span>=<span class="string">"TimeWeeks"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Day"</span> <span class="attr">column</span>=<span class="string">"day_in_month"</span> <span class="attr">uniqueMembers</span>=<span class="string">"false"</span> <span class="attr">ordinalColumn</span>=<span class="string">"day_in_month"</span> <span class="attr">nameColumn</span>=<span class="string">"day_name"</span> <span class="attr">levelType</span>=<span class="string">"TimeDays"</span> <span class="attr">type</span>=<span class="string">"Numeric"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">Hierarchy</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Dimension</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h5 id="3-3-4-level的顺序与展示"><a href="#3-3-4-level的顺序与展示" class="headerlink" title="3.3.4 level的顺序与展示"></a>3.3.4 level的顺序与展示</h5><p>注意时间hierarchy的例子中的ordinalColumn 和nameColumn 属性。这两个属性关系到level怎样在结果中展现。ordinalColumn 属性指定了hierarchy中的一个字段，根据这个字段排序，nameColumn 则指明了要展示的字段。</p>
<p>例如，在月份level中，datehierarchy有month (1 .. 12) ，和month_name (January, February, …)两个字段。MDX内部使用的字段是month，此种形式：[Time].[2005].[Q1].[1]。Month level的元素会按照January, February…的顺序显示。</p>
<p>在父子hierarchy中，元素都是按照层级顺序排序的。ordinalColumn控制着同一个分支的兄弟节点之间的顺序。</p>
<p>level包含一个type属性，它的枚举有 “String”, “Integer”, “Numeric”, “Boolean”, “Date”, “Time”, “Timestamp”.</p>
<h5 id="3-5-多个hierarchy"><a href="#3-5-多个hierarchy" class="headerlink" title="3.5 多个hierarchy"></a>3.5 多个hierarchy</h5><p>有的维度包含多个hierarchy：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Dimension</span> <span class="attr">name</span>=<span class="string">"Time"</span> <span class="attr">foreignKey</span>=<span class="string">"time_id"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">Hierarchy</span> <span class="attr">hasAll</span>=<span class="string">"false"</span> <span class="attr">primaryKey</span>=<span class="string">"time_id"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Table</span> <span class="attr">name</span>=<span class="string">"time_by_day"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Year"</span> <span class="attr">column</span>=<span class="string">"the_year"</span> <span class="attr">type</span>=<span class="string">"Numeric"</span> <span class="attr">uniqueMembers</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Quarter"</span> <span class="attr">column</span>=<span class="string">"quarter"</span> <span class="attr">uniqueMembers</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Month"</span> <span class="attr">column</span>=<span class="string">"month_of_year"</span> <span class="attr">type</span>=<span class="string">"Numeric"</span> <span class="attr">uniqueMembers</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">Hierarchy</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">Hierarchy</span> <span class="attr">name</span>=<span class="string">"Time Weekly"</span> <span class="attr">hasAll</span>=<span class="string">"false"</span> <span class="attr">primaryKey</span>=<span class="string">"time_id"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Table</span> <span class="attr">name</span>=<span class="string">"time_by_week"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Year"</span> <span class="attr">column</span>=<span class="string">"the_year"</span> <span class="attr">type</span>=<span class="string">"Numeric"</span> <span class="attr">uniqueMembers</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Week"</span> <span class="attr">column</span>=<span class="string">"week"</span> <span class="attr">uniqueMembers</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Day"</span> <span class="attr">column</span>=<span class="string">"day_of_week"</span> <span class="attr">type</span>=<span class="string">"String"</span> <span class="attr">uniqueMembers</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">Hierarchy</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Dimension</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>注意，第一个hierarchy并没有name属性，默认是继承它的dimemsion。</p>
<p>以上两个hierarchy之间除了都是使用time_id作为join的key以外没有任何其他地方有相同点。把两个hierarchy放在同一个dimemsion中完全是为了迎合终端用户，因为终端用户认为为’Time’ 和’Time Weekly’两个hierarchy弄两个坐标系完全是没有什么道理的。如果两个hierarchy在同一个dimemsion中，MDX语言就会强制你只能使用两者之中的一个。</p>
<h5 id="3-3-6-Degenerate-dimensions"><a href="#3-3-6-Degenerate-dimensions" class="headerlink" title="3.3.6 Degenerate dimensions"></a>3.3.6 Degenerate dimensions</h5><p>退化维度，是指特别简单都不值当给他创建一个表的问题。例如下面的事实表:<br>product_id|    time_id|    payment_method|    customer_id    store_id|    item_count    dollars<br>—|—|—|—|—<br>55    20040106|    Credit    |123|    22|    3|    $3.54<br>78    20040106|    Cash|    89|    22|    1|    $20.00<br>199    20040107|    ATM|    3|    22    |2    |$2.99<br>55    20040106|    Cash|    122|    22    |1|    $1.18</p>
<p>假设我们为payment_method 字段创建了一个表。：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">payment_method</div><div class="line">Credit</div><div class="line">Cash</div><div class="line">ATM</div></pre></td></tr></table></figure></p>
<p>它只有3个可能的值，建表没啥意义。我们应该创建一个退化维度。为此，我们要创建一个没有table的dimemsion，mondrian会认为这些字段来源于事实表：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Cube</span> <span class="attr">name</span>=<span class="string">"Checkout"</span>&gt;</span></div><div class="line">	<span class="comment">&lt;!-- The fact table is always necessary. --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">Table</span> <span class="attr">name</span>=<span class="string">"checkout"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">Dimension</span> <span class="attr">name</span>=<span class="string">"Payment method"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Hierarchy</span> <span class="attr">hasAll</span>=<span class="string">"true"</span>&gt;</span></div><div class="line">			<span class="comment">&lt;!-- No table element here. Fact table is assumed. --&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Payment method"</span> <span class="attr">column</span>=<span class="string">"payment_method"</span> <span class="attr">uniqueMembers</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">Hierarchy</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">Dimension</span>&gt;</span></div><div class="line">	<span class="comment">&lt;!-- other dimensions and measures --&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Cube</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>由于没有join操作，所以foreignKey也米有必要了。hierarchy也没有table元素以及primaryKey属性。</p>
<h5 id="3-3-7-inline-table"><a href="#3-3-7-inline-table" class="headerlink" title="3.3.7 inline table"></a>3.3.7 inline table</h5><p><inlinetable>用来在schema中定义一个简单的数据集。</inlinetable></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Dimension</span> <span class="attr">name</span>=<span class="string">"Severity"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">Hierarchy</span> <span class="attr">hasAll</span>=<span class="string">"true"</span> <span class="attr">primaryKey</span>=<span class="string">"severity_id"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">InlineTable</span> <span class="attr">alias</span>=<span class="string">"severity"</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">ColumnDefs</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">ColumnDef</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">type</span>=<span class="string">"Numeric"</span>/&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">ColumnDef</span> <span class="attr">name</span>=<span class="string">"desc"</span> <span class="attr">type</span>=<span class="string">"String"</span>/&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">ColumnDefs</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">Rows</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">Row</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">Value</span> <span class="attr">column</span>=<span class="string">"id"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">Value</span> <span class="attr">column</span>=<span class="string">"desc"</span>&gt;</span>High<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">Row</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">Row</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">Value</span> <span class="attr">column</span>=<span class="string">"id"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">Value</span> <span class="attr">column</span>=<span class="string">"desc"</span>&gt;</span>Medium<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">Row</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">Row</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">Value</span> <span class="attr">column</span>=<span class="string">"id"</span>&gt;</span>3<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">Value</span> <span class="attr">column</span>=<span class="string">"desc"</span>&gt;</span>Low<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">Row</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">Rows</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">InlineTable</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Severity"</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">nameColumn</span>=<span class="string">"desc"</span> <span class="attr">uniqueMembers</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">Hierarchy</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Dimension</span>&gt;</span></div></pre></td></tr></table></figure>
<p>以上面数据集声明dimemsion：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Dimension</span> <span class="attr">name</span>=<span class="string">"Severity"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">Hierarchy</span> <span class="attr">hasAll</span>=<span class="string">"true"</span> <span class="attr">primaryKey</span>=<span class="string">"severity_id"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Table</span> <span class="attr">name</span>=<span class="string">"severity"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Severity"</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">nameColumn</span>=<span class="string">"desc"</span> <span class="attr">uniqueMembers</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">Hierarchy</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Dimension</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h5 id="3-3-8-Member-properties-and-formatters"><a href="#3-3-8-Member-properties-and-formatters" class="headerlink" title="3.3.8 Member properties and formatters"></a>3.3.8 Member properties and formatters</h5><p>As we shall see later, a level definition can also define member properties and a member formatter.</p>
<h5 id="3-3-9-Approximate-level-cardinality"><a href="#3-3-9-Approximate-level-cardinality" class="headerlink" title="3.3.9 Approximate level cardinality"></a>3.3.9 Approximate level cardinality</h5><p>The <level> element allows specifying the optional attribute “approxRowCount”. Specifying approxRowCount can improve performance by reducing the need to determine level, hierarchy, and dimension cardinality. This can have a significant impact when connecting to Mondrian via XMLA.</level></p>
<h5 id="3-3-10-Default-Measure-Attribute"><a href="#3-3-10-Default-Measure-Attribute" class="headerlink" title="3.3.10 Default Measure Attribute"></a>3.3.10 Default Measure Attribute</h5>]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[公平调度器-capacity-scheduler]]></title>
      <url>/2016/12/05/%E5%85%AC%E5%B9%B3%E8%B0%83%E5%BA%A6%E5%99%A8-capacity-scheduler/</url>
      <content type="html"><![CDATA[<h2 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h2><p>公平调度器是Hadoop上的一个可配置的调度器，支持多租户共享集群资源，最大化利用集群资源。传统来说，每个组织都有自己的私有资源，这些资源能够在一些极端峰值状态足够满足自己部门的SLA。这样其实是有问题的，所有的集群都需要管理，而且每个部门的资源平均使用率并不高。集群共享其实是一个比较划算的事情，每个部门既能完成工作，又不用去单独管理各自的集群。但是，各部门又有些担心如果共享集群资源的话，其他部门的东西会不会对自己的SLA造成影响。CapacityScheduler就是解决这个问题而生的，它可以让多个部门共享一个大的集群资源，而且各个部门的资源不会被其他部门使用，这保证了部门之间资源共享的灵活性，而且很划算。</p>
<p>多个组织之间共享集群资源，很重要的一点是保证每个组织有一个自保的机制，保证自己的资源不受其他部门资源调度的影响。CapacityScheduler提供了一套严格的保证机制来限制应用、用户、queue等不能无限制地访问集群资源。另外，CapacityScheduler也限制了一个用户或者queue的应用的初始化与pending资源来保证集群的稳定性和公平性。</p>
<p>CapacityScheduler提供的主要概念是queue的概念。一般queue都是管理员创建的，反映了共享集群的各个经济单体。</p>
<p>为了进一步的控制资源共享情况，CapacityScheduler支持纵向队列，也就是资源还可以在sub-queue子队列里进行分配。<br>To provide further control and predictability on sharing of resources, the CapacityScheduler supports hierarchical queues to ensure resources are shared among the sub-queues of an organization before other queues are allowed to use free resources, there-by providing affinity for sharing free resources among applications of a given organization.</p>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><p>如下:</p>
<ul>
<li>Hierarchical Queues 纵向队列 -<br>在其他queue使用空闲资源之前，支持资源可被当前组织的sub-queue优先抢占，以此来提供更高的可控性和可预测性。<ul>
<li>保证容量 - 保证总资源的某个百分比的容量随时听候某queue的调遣。所有提交到这个queue的应用都可以访问这部分资源。 管理员可以灵活配置soft limit和hard limit限制每个queue的容量占比。</li>
<li>安全 - 每个queue都有严格的ACLs策略控制谁可以提交应用到哪个queue。另外，也不能让某些普通用户看到或者修改运行在其他queue里的应用。 管理员角色粒度可以对应一个queue或整个scheduler系统。</li>
<li>弹性 - 任何队列资源不够的话，都可以使用空闲资源区的资源。 When there is demand for these resources from queues running below capacity at a future point in time, as tasks scheduled on these resources complete, they will be assigned to applications on queues running below the capacity (pre-emption is not supported). This ensures that resources are available in a predictable and elastic manner to queues, thus preventing artifical silos of resources in the cluster which helps utilization.</li>
<li>多租户 - Comprehensive set of limits are provided to prevent a single application, user and queue from monopolizing resources of the queue or the cluster as a whole to ensure that the cluster isn’t overwhelmed.<br>Operability</li>
<li>运行时配置优先 - The queue definitions and properties such as capacity, ACLs can be changed, at runtime, by administrators in a secure manner to minimize disruption to users. Also, a console is provided for users and administrators to view current allocation of resources to various queues in the system. Administrators can add additional queues at runtime, but queues cannot be deleted at runtime.</li>
<li>清空应用 - .如果一个queue是STOPPED状态，就不能向它或者它的任何sub-queue提交应用了。 正在运行的应用会继续运行到完成，因此queue可以被优雅的清空。管理员也可以启动或者停掉某个queue。</li>
<li>基于资源的调度 - 可以多分配一些配置，主要是为了支持一些资源敏感的应用。<br>Queue Mapping based on User or Group - This feature allows users to map a job to a specific queue based on the user or group.<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4></li>
</ul>
</li>
</ul>
<p>配置ResourceManager使用CapacityScheduler</p>
<p>conf/yarn-site.xml:<br>|  属性 | 值  |<br>|—|—|<br>| yarn.resourcemanager.scheduler.class  |org.apache.hadoop.yarn.server.resourcemanager.scheduler.capacity.CapacityScheduler |<br>|   |   |<br>|   |   |</p>
<p>配置queues</p>
<p>etc/hadoop/capacity-scheduler.xml是CapacityScheduler的主配置文件.<br>CapacityScheduler又一个预定义的queue: root, 所有的队列都是这个队列的子队列sub-queue.其他的队列通过设置 <strong>yarn.scheduler.capacity.root.queues</strong>属性，弄一个逗号隔开的字符串就行.<br>CapacityScheduler使用queue path配置queue的层次. queue path是queue层级的全路径, 以root开始, 使用. (点)作为分隔符.<br>指定queue的所有sub-queue可以这样指定: <strong>yarn.scheduler.capacity.<queue-path>.queues</queue-path></strong>. 子队列并不自动继承queue的属性。<br>下面是一个例子，a\b\c为root的子队列，然后a\b还有自己的子队列:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.scheduler.capacity.root.queues<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>a,b,c<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>The queues at the this level (root is the root queue).</div><div class="line">  <span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.scheduler.capacity.root.a.queues<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>a1,a2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>The queues at the this level (root is the root queue).</div><div class="line">  <span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.scheduler.capacity.root.b.queues<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>b1,b2,b3<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>The queues at the this level (root is the root queue).</div><div class="line">  <span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h4 id="queue属性"><a href="#queue属性" class="headerlink" title="queue属性"></a>queue属性</h4><p>Resource Allocation<br>Property    Description<br>yarn.scheduler.capacity.<queue-path>.capacity    Queue capacity in percentage (%) as a float (e.g. 12.5). The sum of capacities for all queues, at each level, must be equal to 100. Applications in the queue may consume more resources than the queue’s capacity if there are free resources, providing elasticity.<br>yarn.scheduler.capacity.<queue-path>.maximum-capacity    Maximum queue capacity in percentage (%) as a float. This limits the elasticity for applications in the queue. Defaults to -1 which disables it.<br>yarn.scheduler.capacity.<queue-path>.minimum-user-limit-percent    Each queue enforces a limit on the percentage of resources allocated to a user at any given time, if there is demand for resources. The user limit can vary between a minimum and maximum value. The the former (the minimum value) is set to this property value and the latter (the maximum value) depends on the number of users who have submitted applications. For e.g., suppose the value of this property is 25. If two users have submitted applications to a queue, no single user can use more than 50% of the queue resources. If a third user submits an application, no single user can use more than 33% of the queue resources. With 4 or more users, no user can use more than 25% of the queues resources. A value of 100 implies no user limits are imposed. The default is 100. Value is specified as a integer.<br>yarn.scheduler.capacity.<queue-path>.user-limit-factor    The multiple of the queue capacity which can be configured to allow a single user to acquire more resources. By default this is set to 1 which ensures that a single user can never take more than the queue’s configured capacity irrespective of how idle th cluster is. Value is specified as a float.<br>yarn.scheduler.capacity.<queue-path>.maximum-allocation-mb    The per queue maximum limit of memory to allocate to each container request at the Resource Manager. This setting overrides the cluster configuration yarn.scheduler.maximum-allocation-mb. This value must be smaller than or equal to the cluster maximum.<br>yarn.scheduler.capacity.<queue-path>.maximum-allocation-vcores    The per queue maximum limit of virtual cores to allocate to each container request at the Resource Manager. This setting overrides the cluster configuration yarn.scheduler.maximum-allocation-vcores. This value must be smaller than or equal to the cluster maximum.<br>Running and Pending Application Limits<br>The CapacityScheduler supports the following parameters to control the running and pending applications:<br>Property    Description<br>yarn.scheduler.capacity.maximum-applications / yarn.scheduler.capacity.<queue-path>.maximum-applications    Maximum number of applications in the system which can be concurrently active both running and pending. Limits on each queue are directly proportional to their queue capacities and user limits. This is a hard limit and any applications submitted when this limit is reached will be rejected. Default is 10000. This can be set for all queues withyarn.scheduler.capacity.maximum-applications and can also be overridden on a per queue basis by setting yarn.scheduler.capacity.<queue-path>.maximum-applications. Integer value expected.<br>yarn.scheduler.capacity.maximum-am-resource-percent /yarn.scheduler.capacity.<queue-path>.maximum-am-resource-percent    Maximum percent of resources in the cluster which can be used to run application masters - controls number of concurrent active applications. Limits on each queue are directly proportional to their queue capacities and user limits. Specified as a float - ie 0.5 = 50%. Default is 10%. This can be set for all queues with yarn.scheduler.capacity.maximum-am-resource-percent and can also be overridden on a per queue basis by setting yarn.scheduler.capacity.<queue-path>.maximum-am-resource-percent<br>Queue Administration &amp; Permissions<br>The CapacityScheduler supports the following parameters to the administer the queues:<br>Property    Description<br>yarn.scheduler.capacity.<queue-path>.state    The state of the queue. Can be one of RUNNING or STOPPED. If a queue is in STOPPED state, new applications cannot be submitted to itself or any of its child queues. Thus, if the root queue is STOPPEDno applications can be submitted to the entire cluster. Existing applications continue to completion, thus the queue can be drained gracefully. Value is specified as Enumeration.<br>yarn.scheduler.capacity.root.<queue-path>.acl_submit_applications    The ACL which controls who can submit applications to the given queue. If the given user/group has necessary ACLs on the given queue or one of the parent queues in the hierarchy they can submit applications. ACLs for this property are inherited from the parent queue if not specified.<br>yarn.scheduler.capacity.root.<queue-path>.acl_administer_queue    The ACL which controls who can administer applications on the given queue. If the given user/group has necessary ACLs on the given queue or one of the parent queues in the hierarchy they can administer applications. ACLs for this property are inherited from the parent queue if not specified.<br>Note: An ACL is of the form user1, user2spacegroup1, group2. The special value of <em> implies anyone. The special value of space implies no one. The default is </em> for the root queue if not specified.<br>Queue Mapping based on User or Group<br>The CapacityScheduler supports the following parameters to configure the queue mapping based on user or group:<br>Property    Description<br>yarn.scheduler.capacity.queue-mappings    This configuration specifies the mapping of user or group to aspecific queue. You can map a single user or a list of users to queues. Syntax: [u or g]:[name]:[queue_name][,next_mapping]*. Here, u or gindicates whether the mapping is for a user or group. The value is u for user and g for group. name indicates the user name or group name. To specify the user who has submitted the application, %user can be used. queue_name indicates the queue name for which the application has to be mapped. To specify queue name same as user name, %user can be used. To specify queue name same as the name of the primary group for which the user belongs to, %primary_group can be used.<br>yarn.scheduler.capacity.queue-mappings-override.enable    This function is used to specify whether the user specified queues can be overridden. This is a Boolean value and the default value is false.<br>Example:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.scheduler.capacity.queue-mappings<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>u:user1:queue1,g:group1:queue2,u:%user:%user,u:user2:%primary_group<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span></div><div class="line">    Here, <span class="tag">&lt;<span class="name">user1</span>&gt;</span> is mapped to <span class="tag">&lt;<span class="name">queue1</span>&gt;</span>, <span class="tag">&lt;<span class="name">group1</span>&gt;</span> is mapped to <span class="tag">&lt;<span class="name">queue2</span>&gt;</span>, </div><div class="line">    maps users to queues with the same name as user, <span class="tag">&lt;<span class="name">user2</span>&gt;</span> is mapped </div><div class="line">    to queue name same as <span class="tag">&lt;<span class="name">primary</span> <span class="attr">group</span>&gt;</span> respectively. The mappings will be </div><div class="line">    evaluated from left to right, and the first valid mapping will be used.</div><div class="line">  <span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure></queue-path></queue-path></queue-path></queue-path></queue-path></queue-path></queue-path></queue-path></queue-path></queue-path></queue-path></queue-path></queue-path></p>
<h4 id="其他属性"><a href="#其他属性" class="headerlink" title="其他属性"></a>其他属性</h4><p>Resource Calculator<br>Property    Description<br>yarn.scheduler.capacity.resource-calculator    The ResourceCalculator implementation to be used to compare Resources in the scheduler. The default i.e. org.apache.hadoop.yarn.util.resource.DefaultResourseCalculator only uses Memory while DominantResourceCalculator uses Dominant-resource to compare multi-dimensional resources such as Memory, CPU etc. A Java ResourceCalculator class name is expected.<br>Data Locality<br>Property    Description<br>yarn.scheduler.capacity.node-locality-delay    Number of missed scheduling opportunities after which the CapacityScheduler attempts to schedule rack-local containers. Typically, this should be set to number of nodes in the cluster. By default is setting approximately number of nodes in one rack which is 40. Positive integer value is expected.<br>Reviewing the configuration of the CapacityScheduler</p>
<p>Once the installation and configuration is completed, you can review it after starting the YARN cluster from the web-ui.<br>Start the YARN cluster in the normal manner.<br>Open the ResourceManager web UI.<br>The /scheduler web-page should show the resource usages of individual queues.<br>Changing Queue Configuration</p>
<p>Changing queue properties and adding new queues is very simple. You need to edit conf/capacity-scheduler.xml and run yarn rmadmin -refreshQueues.<br>$ vi $HADOOP_CONF_DIR/capacity-scheduler.xml<br>$ $HADOOP_YARN_HOME/bin/yarn rmadmin -refreshQueues<br>Note: Queues cannot be deleted, only addition of new queues is supported - the updated queue configuration should be a valid one i.e. queue-capacity at each level should be equal to 100%.</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[metamap部署]]></title>
      <url>/2016/12/05/metamap%E9%83%A8%E7%BD%B2/</url>
      <content type="html"><![CDATA[<h2 id="vituralEnv"><a href="#vituralEnv" class="headerlink" title="vituralEnv"></a>vituralEnv</h2><p>先创建执行环境<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">virtualenv metamap</div></pre></td></tr></table></figure></p>
<p>这个命令会在当前目录下生成一个metamap目录，后来查实了一下，其实后面是指定要生成的目标记录的(<code>virtualenv /path/to/tartget/metamap</code>)，便于统一管理所有的env环境。</p>
<p>进入我们刚刚创建的环境:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">root@will-vm:/usr/local/metamap# source metamap/bin/activate</div><div class="line">(metamap) root@will-vm:/usr/local/metamap#</div></pre></td></tr></table></figure></p>
<p>我这里没有使用绝对路径，所以就成了当前目录。目录结构如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">(metamap) root@will-vm:/usr/local/metamap# tree -L 2 metamap</div><div class="line">metamap</div><div class="line">├── bin</div><div class="line">│   ├── activate</div><div class="line">│   ├── activate.csh</div><div class="line">│   ├── activate.fish</div><div class="line">│   ├── activate_this.py</div><div class="line">│   ├── django-admin</div><div class="line">│   ├── django-admin.py</div><div class="line">│   ├── django-admin.pyc</div><div class="line">│   ├── easy_install</div><div class="line">│   ├── easy_install-2.7</div><div class="line">│   ├── pip</div><div class="line">│   ├── pip2</div><div class="line">│   ├── pip2.7</div><div class="line">│   ├── python</div><div class="line">│   ├── python2 -&gt; python</div><div class="line">│   ├── python2.7 -&gt; python</div><div class="line">│   ├── python-config</div><div class="line">│   └── wheel</div><div class="line">├── include</div><div class="line">│   └── python2.7 -&gt; /usr/include/python2.7</div><div class="line">├── lib</div><div class="line">│   └── python2.7</div><div class="line">├── local</div><div class="line">│   ├── bin -&gt; /usr/local/metamap/metamap/bin</div><div class="line">│   ├── include -&gt; /usr/local/metamap/metamap/include</div><div class="line">│   └── lib -&gt; /usr/local/metamap/metamap/lib</div><div class="line">└── pip-selfcheck.json</div></pre></td></tr></table></figure></p>
<p>另外还会在新的env中安装三个基础依赖包：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(metamap) root@will-vm:/usr/local/metamap# pip list</div><div class="line">pip (8.1.2)</div><div class="line">setuptools (25.1.3)</div><div class="line">wheel (0.29.0)</div></pre></td></tr></table></figure></p>
<p>使用pip freeze &gt; requirements.txt来导出当前环境中的所有python依赖。</p>
<p>然后使用pip install -r path/to/requirements.txt安装，发现有一些是跟os有关的，比如包含Ubuntu的，根本就没有必要安装。所以就只保留了有印象的几个依赖。</p>
<p>最后requirements.txt只剩下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">tlr4-python2-runtime==4.5.3</div><div class="line">Django==1.9.7</div><div class="line">MySQL-python==1.2.5</div><div class="line">pyhs2==0.6.0</div></pre></td></tr></table></figure></p>
<p>如果要退出virtualenv，就使用deactivate。</p>
<h2 id="Gunicorn"><a href="#Gunicorn" class="headerlink" title="Gunicorn"></a>Gunicorn</h2><p>在vituralenv里安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install gunicorn</div></pre></td></tr></table></figure></p>
<p>进入我们的django项目根目录，也就是manage.py所在的目录：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">(metamap) root@will-vm:/usr/local/metamap/metamap_django# gunicorn_django -b 0.0.0.0:8089</div><div class="line">!!!</div><div class="line">!!! WARNING: This command is deprecated.</div><div class="line">!!! </div><div class="line">!!!     You should now run your application with the WSGI interface</div><div class="line">!!!     installed with your project. Ex.:</div><div class="line">!!! </div><div class="line">!!!         gunicorn myproject.wsgi:application</div><div class="line">!!! </div><div class="line">!!!     See https://docs.djangoproject.com/en/1.8/howto/deployment/wsgi/gunicorn/</div><div class="line">!!!     for more info.</div><div class="line">!!!</div><div class="line"></div><div class="line">[2016-08-03 19:13:32 +0000] [13020] [INFO] Starting gunicorn 19.6.0</div><div class="line">[2016-08-03 19:13:32 +0000] [13020] [INFO] Listening at: http://0.0.0.0:8089 (13020)</div><div class="line">[2016-08-03 19:13:32 +0000] [13020] [INFO] Using worker: sync</div><div class="line">[2016-08-03 19:13:32 +0000] [13025] [INFO] Booting worker with pid: 13025</div><div class="line">[2016-08-03 19:13:32 +0000] [13025] [ERROR] Exception in worker process</div><div class="line">Traceback (most recent call last):</div><div class="line">  File &quot;/usr/local/metamap/metamap/local/lib/python2.7/site-packages/gunicorn/arbiter.py&quot;, line 557, in spawn_worker</div><div class="line">    worker.init_process()</div><div class="line">  File &quot;/usr/local/metamap/metamap/local/lib/python2.7/site-packages/gunicorn/workers/base.py&quot;, line 126, in init_process</div><div class="line">    self.load_wsgi()</div><div class="line">  File &quot;/usr/local/metamap/metamap/local/lib/python2.7/site-packages/gunicorn/workers/base.py&quot;, line 136, in load_wsgi</div><div class="line">    self.wsgi = self.app.wsgi()</div><div class="line">  File &quot;/usr/local/metamap/metamap/local/lib/python2.7/site-packages/gunicorn/app/base.py&quot;, line 67, in wsgi</div><div class="line">    self.callable = self.load()</div><div class="line">  File &quot;/usr/local/metamap/metamap/local/lib/python2.7/site-packages/gunicorn/app/djangoapp.py&quot;, line 105, in load</div><div class="line">    mod = util.import_module(&quot;gunicorn.app.django_wsgi&quot;)</div><div class="line">  File &quot;/usr/lib/python2.7/importlib/__init__.py&quot;, line 37, in import_module</div><div class="line">    __import__(name)</div><div class="line">  File &quot;/usr/local/metamap/metamap/local/lib/python2.7/site-packages/gunicorn/app/django_wsgi.py&quot;, line 21, in &lt;module&gt;</div><div class="line">    from django.core.management.validation import get_validation_errors</div><div class="line">ImportError: No module named validation</div><div class="line">[2016-08-03 19:13:32 +0000] [13025] [INFO] Worker exiting (pid: 13025)</div><div class="line">[2016-08-03 19:13:32 +0000] [13020] [INFO] Shutting down: Master</div><div class="line">[2016-08-03 19:13:32 +0000] [13020] [INFO] Reason: Worker failed to boot.</div></pre></td></tr></table></figure></p>
<p>查了一下，是版本问题，改用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(metamap) root@will-vm:/usr/local/metamap/metamap_django# gunicorn metamap_django.wsgi:application -b 0.0.0.0:8089</div><div class="line">[2016-08-03 19:16:10 +0000] [13097] [INFO] Starting gunicorn 19.6.0</div><div class="line">[2016-08-03 19:16:10 +0000] [13097] [INFO] Listening at: http://0.0.0.0:8089 (13097)</div><div class="line">[2016-08-03 19:16:10 +0000] [13097] [INFO] Using worker: sync</div><div class="line">[2016-08-03 19:16:10 +0000] [13102] [INFO] Booting worker with pid: 13102</div></pre></td></tr></table></figure></p>
<p>wsgi为我们生成django项目时，跟settings.py同目录的wsgi.py。然后就可以到浏览器访问了。</p>
<p>看一下我们django自动生成的这个文件内容，可以看到还有：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os</div><div class="line"></div><div class="line"><span class="keyword">from</span> django.core.wsgi <span class="keyword">import</span> get_wsgi_application</div><div class="line"></div><div class="line">os.environ.setdefault(<span class="string">"DJANGO_SETTINGS_MODULE"</span>, <span class="string">"metamap_django.settings"</span>)</div><div class="line"></div><div class="line">application = get_wsgi_application()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_wsgi_application</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    The public interface to Django's WSGI support. Should return a WSGI</div><div class="line">    callable.</div><div class="line"></div><div class="line">    Allows us to avoid making django.core.handlers.WSGIHandler public API, in</div><div class="line">    case the internal WSGI implementation changes or moves in the future.</div><div class="line">    """</div><div class="line">    django.setup()</div><div class="line">    <span class="keyword">return</span> WSGIHandler()</div></pre></td></tr></table></figure></p>
<p>晚上整体浏览了一遍Gunicorn官网，整理以下几点注意的地方：</p>
<ul>
<li>可以指定django的settings文件</li>
<li>gunicorn 官网中指定的几个管理master和worker的signal其实都是Linux的kill命令的参数 <code>kill -TERM cat /tmp/xx.pid</code></li>
<li>worker和thread是不一样的概念，前者是进程，后者是线程，worker中包含thread。具体并发数需要压测结果来确定</li>
<li>为了防止出现内存泄露问题，可以为worker指定类似max_request之类的参数在一定阶段重启当前worker</li>
<li>Gunicorn可以动态增加worker实现调优</li>
<li>命令行可以加入运行目录并生成pid</li>
<li><p>环境中添加python插件setproctitle之后就可以为gunicorn进程命名了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"> (metamap) root@will-vm:/usr/local/metamap/metamap_django# ps -ef | grep gunicorn</div><div class="line">root      2258 10709  0 11:38 pts/26   00:00:00 tailf /tmp/gunicorn_error.log</div><div class="line">root      2494  2264  0 11:38 pts/27   00:00:00 tailf /tmp/gunicorn_access.log</div><div class="line">root      3190  2444  0 11:57 ?        00:00:00 gunicorn: master [will&apos;s metamap]                                                                                                    </div><div class="line">root      3195  3190  2 11:57 ?        00:00:00 gunicorn: worker [will&apos;s metamap]                                                                                                    </div><div class="line">root      3198  3190  2 11:57 ?        00:00:00 gunicorn: worker [will&apos;s metamap]                                                                                                    </div><div class="line">root      3199  3190  2 11:57 ?        00:00:00 gunicorn: worker [will&apos;s metamap]                                                                                                    </div><div class="line">root      3205  3190  2 11:57 ?        00:00:00 gunicorn: worker [will&apos;s metamap]                                                                                                    </div><div class="line">root      3207  3190  2 11:57 ?        00:00:00 gunicorn: worker [will&apos;s metamap]                                                                                                    </div><div class="line">root      3223 17309  0 11:57 pts/25   00:00:00 grep --color=auto gunicorn</div></pre></td></tr></table></figure>
</li>
<li><p>–statsd-host=localhost:8125会启动一个针对gunicorn的监控系统</p>
</li>
<li>master只负责管理worker，不处理请求，worker是真正处理请求的进程</li>
<li>可接受配置文件-c, 具体可配置项，参考<a href="http://docs.gunicorn.org/en/latest/settings.html" target="_blank" rel="external">这里</a></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># !/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*</span></div><div class="line"><span class="string">'''</span></div><div class="line">created by will</div><div class="line">'''</div><div class="line"></div><div class="line"><span class="keyword">import</span> multiprocessing</div><div class="line"></div><div class="line">print(<span class="string">'gunicorn config is running....'</span>)</div><div class="line"></div><div class="line">bind = <span class="string">"0.0.0.0:8088"</span></div><div class="line">workers = multiprocessing.cpu_count() * <span class="number">2</span> + <span class="number">1</span></div><div class="line">pidfile = <span class="string">'/tmp/gunicorn.pid'</span></div><div class="line">accesslog = <span class="string">'/tmp/gunicorn_access.log'</span></div><div class="line">errorlog = <span class="string">'/tmp/gunicorn_error.log'</span></div><div class="line">loglevel = <span class="string">'info'</span></div><div class="line">capture_output = <span class="keyword">True</span></div><div class="line">statsd_host = <span class="string">'0.0.0.0:8888'</span></div><div class="line">proc_name = <span class="string">'will\'s metamap'</span></div><div class="line">daemon = <span class="keyword">True</span></div></pre></td></tr></table></figure>
<p>然后运行的时候指定此文件的位置即可。</p>
<p>注意：</p>
<ul>
<li>启动指定wsgi位置的时候，需要是<code>gunicorn metamap_django.wsgi:application</code>，要注意的是metamap_django与wsgi之间是<code>.</code>，而不是能是文件路径<code>/</code>，否则启动gunicorn的时候报错:import by filename is not supported gunicorn</li>
<li>执行 kill -HUP cat /tmp/xx/pid来管理master和worker进程</li>
<li>如果要使用supervisord管理进程的话，最好就不要设置<code>daemon</code>为True了</li>
<li>有些东西跟官网说的不一致，比如: statsd_host，django_settings指定settings文件位置，access-log等</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="http://ju.outofmemory.cn/entry/105202" target="_blank" rel="external">http://ju.outofmemory.cn/entry/105202</a></li>
<li><a href="http://zqpythonic.qiniucdn.com/data/20130901152951/index.html" target="_blank" rel="external">http://zqpythonic.qiniucdn.com/data/20130901152951/index.html</a></li>
</ul>
<h2 id="Django"><a href="#Django" class="headerlink" title="Django"></a>Django</h2><p>注意一下几点：</p>
<ol>
<li><p>为django创建多个settings文件，如prod.py,test.py等,之后在gunicorn的配置文件里指定需要的配置文件即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># !/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*</span></div><div class="line"><span class="string">'''</span></div><div class="line">created by will</div><div class="line">'''</div><div class="line"></div><div class="line"><span class="keyword">import</span> multiprocessing, os</div><div class="line"></div><div class="line">print(<span class="string">'gunicorn config is running....'</span>)</div><div class="line"></div><div class="line">bind = <span class="string">"0.0.0.0:8088"</span></div><div class="line">workers = multiprocessing.cpu_count() * <span class="number">2</span> + <span class="number">1</span></div><div class="line">pidfile = <span class="string">'/tmp/gunicorn.pid'</span></div><div class="line"><span class="comment"># accesslog = '/tmp/gunicorn_access.log'</span></div><div class="line">errorlog = <span class="string">'/tmp/gunicorn_error.log'</span></div><div class="line">loglevel = <span class="string">'info'</span></div><div class="line">capture_output = <span class="keyword">True</span></div><div class="line"><span class="comment"># statsd_host = 'localhost:8077'</span></div><div class="line">proc_name = <span class="string">'will\'s metamap'</span></div><div class="line">daemon = <span class="keyword">True</span></div><div class="line"><span class="comment"># 测试确定，这里设置这个参数不生效</span></div><div class="line"><span class="comment"># django_settings = 'metamap.config.prod'</span></div><div class="line"></div><div class="line">os.environ.setdefault(<span class="string">"DJANGO_SETTINGS_MODULE"</span>, <span class="string">"metamap.config.prod"</span>)</div></pre></td></tr></table></figure>
</li>
<li><p>修改settings里的几个选项</p>
</li>
</ol>
<table>
<thead>
<tr>
<th>参数</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>DEBUG</td>
<td>改为False，不然程序出错的方法栈会直接展示在前端用户那里，不友好。</td>
</tr>
<tr>
<td>ALLOWED_HOSTS</td>
<td>添加可以访问你的项目的几个域名或主机地址，防止<a href="https://docs.djangoproject.com/es/1.9/topics/security/#host-headers-virtual-hosting" target="_blank" rel="external"> HTTP Host header attacks</a></td>
</tr>
<tr>
<td>ADMINS</td>
<td>当程序出错的时候django会发送错误给这些邮件列表</td>
</tr>
</tbody>
</table>
<p>参考：<a href="https://docs.djangoproject.com/es/1.9/topics/settings/" target="_blank" rel="external">https://docs.djangoproject.com/es/1.9/topics/settings/</a></p>
<ol>
<li>确认有处理view里抛出的异常的逻辑，如果没有的话，自定义一个处理异常的middleware，注册到setting离去。</li>
</ol>
<p>参考：<a href="https://docs.djangoproject.com/ja/1.9/topics/http/middleware/" target="_blank" rel="external">https://docs.djangoproject.com/ja/1.9/topics/http/middleware/</a></p>
<ol>
<li>将django的所有的静态文件整理到指定文件夹<br>在settings.py里设置static_root，然后执行<code>./manage.py collectstatic</code>，这个命令就会把所有的静态资源整理到static_root里面。</li>
</ol>
<p>参考：<a href="https://docs.djangoproject.com/en/1.10/howto/static-files/#deployment" target="_blank" rel="external">https://docs.djangoproject.com/en/1.10/howto/static-files/#deployment</a></p>
<h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><p>nginx的主要功能是分发动态请求，以及处理静态资源请求。</p>
<p>配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#user  nobody;</div><div class="line">worker_processes  1;</div><div class="line"></div><div class="line">events &#123;</div><div class="line">    worker_connections  1024;</div><div class="line">&#125;</div><div class="line"></div><div class="line">http &#123;</div><div class="line">    include       mime.types;</div><div class="line">    default_type  application/octet-stream;</div><div class="line"></div><div class="line">    #log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</div><div class="line">    #                  &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</div><div class="line">    #                  &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</div><div class="line"></div><div class="line">    access_log  /tmp/nginx.access.log combined;</div><div class="line"></div><div class="line">    sendfile        on;</div><div class="line">    </div><div class="line">    keepalive_timeout  65;</div><div class="line"></div><div class="line">    #gzip  on;</div><div class="line"></div><div class="line">     upstream app_server &#123;</div><div class="line"></div><div class="line">        # 指定后台地址</div><div class="line">        server 192.168.244.128:8088 fail_timeout=0;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      server &#123;</div><div class="line">        listen 80;</div><div class="line">        client_max_body_size 4G;</div><div class="line"></div><div class="line">        # 指定域名</div><div class="line">        server_name 192.168.244.128;</div><div class="line"></div><div class="line">        keepalive_timeout 5;</div><div class="line"></div><div class="line">        # static文件夹所在的根目录</div><div class="line">        root /usr/local/metamap;</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">          # 如果是静态资源就自己处理，如果不是就发送给proxy_to_app</div><div class="line">          # try_files-&gt;按顺序检查文件是否存在，返回第一个找到的文件或文件夹（结尾加斜线表示为文件夹），如果所有的文件或文件夹都找不到，会进行一个内部重定向到最后一个参数</div><div class="line">          try_files $uri @proxy_to_app;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        location @proxy_to_app &#123;</div><div class="line">          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</div><div class="line">          # enable this if and only if you use HTTPS</div><div class="line">          # proxy_set_header X-Forwarded-Proto https;</div><div class="line">          proxy_set_header Host $http_host;</div><div class="line">          # we don&apos;t want nginx trying to do something clever with</div><div class="line">          # redirects, we set the Host: header above already.</div><div class="line">          proxy_redirect off;</div><div class="line">          proxy_pass http://app_server;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        error_page 500 502 503 504 /50x.html;</div><div class="line">        location = /50x.html &#123;</div><div class="line">          root html;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="未解决的问题"><a href="#未解决的问题" class="headerlink" title="未解决的问题"></a>未解决的问题</h2><p>不定时出现找不到静态资源的问题：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">2016-08-04 10:04:10,128 [MainThread:-1219164416] [django.request:182] [base:get_response] [WARNING]- Not Found: /static/js/bootstrap.js</div><div class="line">2016-08-04 10:04:10,126 [MainThread:-1219164416] [django.request:182] [base:get_response] [WARNING]- Not Found: /static/js/jquery.js</div><div class="line">2016-08-04 10:04:10,148 [MainThread:-1219164416] [django.request:182] [base:get_response] [WARNING]- Not Found: /static/css/bootstrap.css</div><div class="line">2016-08-04 10:04:10,140 [MainThread:-1219164416] [django.request:182] [base:get_response] [WARNING]- Not Found: /static/style.css</div></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[celery队列路由]]></title>
      <url>/2016/12/05/celery%E9%98%9F%E5%88%97%E8%B7%AF%E7%94%B1/</url>
      <content type="html"><![CDATA[<p>同一个app里如果有多种不同的任务，也就是分由不同的task进行处理。假设只有一个worker的话，task1耗时特别长，有可能会阻塞短平快的task2、task3、task4的执行，也就是面临着小任务饿死的情况。</p>
<p>这时候我们就需要使用队列路由，将不同类型的任务路由至不同的queue，并且启动多个worker，分别负责消费指定queue的任务。这样，长少慢的任务就不会影响短频快的小任务的执行了。</p>
<h2 id="自动路由"><a href="#自动路由" class="headerlink" title="自动路由"></a>自动路由</h2><p>CELERY_CREATE_MISSING_QUEUES开启后，如果queue没有在CELERY_QUEUES中的话会自动创建。</p>
<p>假设我们有两个server：x y。他俩负责普通的task。然后z server只处理特定的跟种子有关的task，那么可以这样配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CELERY_ROUTES = &#123;&apos;feed.tasks.import_feed&apos;: &#123;&apos;queue&apos;: &apos;feeds&apos;&#125;&#125;</div></pre></td></tr></table></figure></p>
<p>所有feed.tasks.import_feed的任务都会被放进feeds队列，其他的就放进默认的队列【celery】。</p>
<p>然后启动z server的时候指定一下队列名称：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">user@z:/$ celery -A proj worker -Q feeds</div></pre></td></tr></table></figure></p>
<h2 id="修改默认队列的名称"><a href="#修改默认队列的名称" class="headerlink" title="修改默认队列的名称"></a>修改默认队列的名称</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> kombu <span class="keyword">import</span> Exchange, Queue</div><div class="line"></div><div class="line">CELERY_DEFAULT_QUEUE = <span class="string">'default'</span></div><div class="line">CELERY_QUEUES = (</div><div class="line">    Queue(<span class="string">'default'</span>, Exchange(<span class="string">'default'</span>), routing_key=<span class="string">'default'</span>),</div><div class="line">)</div></pre></td></tr></table></figure>
<h2 id="队列定义"><a href="#队列定义" class="headerlink" title="队列定义"></a>队列定义</h2><p>celery隐藏了后面负责的AMQP协议，但是有人也想知道怎样声明队列。</p>
<p>下面是创建一个video队列：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;&apos;exchange&apos;: &apos;video&apos;,</div><div class="line"> &apos;exchange_type&apos;: &apos;direct&apos;,</div><div class="line"> &apos;routing_key&apos;: &apos;video&apos;&#125;</div></pre></td></tr></table></figure></p>
<p>非AMQP协议的后端不支持exchange。</p>
<h2 id="手动配置"><a href="#手动配置" class="headerlink" title="手动配置"></a>手动配置</h2><p>还是上面一样，xy处理普通任务，z处理feed相关任务：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> kombu <span class="keyword">import</span> Queue</div><div class="line"></div><div class="line">CELERY_DEFAULT_QUEUE = <span class="string">'default'</span></div><div class="line">CELERY_QUEUES = (</div><div class="line">    Queue(<span class="string">'default'</span>,    routing_key=<span class="string">'task.#'</span>),</div><div class="line">    Queue(<span class="string">'feed_tasks'</span>, routing_key=<span class="string">'feed.#'</span>),</div><div class="line">)</div><div class="line">CELERY_DEFAULT_EXCHANGE = <span class="string">'tasks'</span></div><div class="line">CELERY_DEFAULT_EXCHANGE_TYPE = <span class="string">'topic'</span></div><div class="line">CELERY_DEFAULT_ROUTING_KEY = <span class="string">'task.default'</span></div></pre></td></tr></table></figure></p>
<p>CELERY_QUEUES里定义了一串队列的实例。如果没有设置exchange或者没给key设置exchange类型，会按照默认的CELERY_DEFAULT_EXCHANGE、CELERY_DEFAULT_EXCHANGE_TYPE。</p>
<p>要指定某个task的路由，需要在CELERY_ROUTES里添加一个入口<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">CELERY_ROUTES = &#123;</div><div class="line">        <span class="string">'feeds.tasks.import_feed'</span>: &#123;</div><div class="line">            <span class="string">'queue'</span>: <span class="string">'feed_tasks'</span>,</div><div class="line">            <span class="string">'routing_key'</span>: <span class="string">'feed.import'</span>,</div><div class="line">        &#125;,</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>也可以在代码调用的时候指定：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> feeds.tasks <span class="keyword">import</span> import_feed</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>import_feed.apply_async(args=[<span class="string">'http://cnn.com/rss'</span>],</div><div class="line"><span class="meta">... </span>                        queue=<span class="string">'feed_tasks'</span>,</div><div class="line"><span class="meta">... </span>                        routing_key=<span class="string">'feed.import'</span>)</div></pre></td></tr></table></figure></p>
<p>启动z：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">user@z:/$ celery -A proj worker -Q feed_tasks --hostname=z@%h</div></pre></td></tr></table></figure></p>
<p>还要配置x y启动的时候只消费默认队列default：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">user@x:/$ celery -A proj worker -Q default --hostname=x@%h</div><div class="line">user@y:/$ celery -A proj worker -Q default --hostname=y@%h</div></pre></td></tr></table></figure></p>
<p>这些队列也可以混搭在一起，如果你的server都能处理的话，也可以这么做：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">user@z:/$ celery -A proj worker -Q feed_tasks,default --hostname=z@%h</div></pre></td></tr></table></figure></p>
<p>要是想添加一个在其他exchange上的队列，自己定义好exchange以及exchange类型就行：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> kombu <span class="keyword">import</span> Exchange, Queue</div><div class="line"></div><div class="line">CELERY_QUEUES = (</div><div class="line">    Queue(<span class="string">'feed_tasks'</span>,    routing_key=<span class="string">'feed.#'</span>),</div><div class="line">    Queue(<span class="string">'regular_tasks'</span>, routing_key=<span class="string">'task.#'</span>),</div><div class="line">    Queue(<span class="string">'image_tasks'</span>,   exchange=Exchange(<span class="string">'mediatasks'</span>, type=<span class="string">'direct'</span>),</div><div class="line">                           routing_key=<span class="string">'image.compress'</span>),</div><div class="line">)</div></pre></td></tr></table></figure></p>
<p>要是对这部分内容有疑问，可以自行查阅一下AMQP。</p>
<h2 id="初识AMQP"><a href="#初识AMQP" class="headerlink" title="初识AMQP"></a>初识AMQP</h2><h4 id="message"><a href="#message" class="headerlink" title="message"></a>message</h4><p>message包含header和body。celery使用head来存储内容类型和内容编码。内容类型用来序列化message。body中是要执行的task的name，id，参数以及其他元数据信息。</p>
<p>下面是一个例子：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="string">'task'</span>: <span class="string">'myapp.tasks.add'</span>,</div><div class="line"> <span class="string">'id'</span>: <span class="string">'54086c5e-6193-4575-8308-dbab76798756'</span>,</div><div class="line"> <span class="string">'args'</span>: [<span class="number">4</span>, <span class="number">4</span>],</div><div class="line"> <span class="string">'kwargs'</span>: &#123;&#125;&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Producers-consumers，-brokers"><a href="#Producers-consumers，-brokers" class="headerlink" title="Producers, consumers， brokers"></a>Producers, consumers， brokers</h4><p>发送message的客户端叫做publisher，也叫producer。收到message的就叫做consumer。</p>
<p>broker是message所在的server，把message从producer路由到consumer。</p>
<h4 id="Exchanges-queues，-routing-keys"><a href="#Exchanges-queues，-routing-keys" class="headerlink" title="Exchanges, queues， routing keys"></a>Exchanges, queues， routing keys</h4><ol>
<li>message被发送给exchange</li>
<li>exchange路由message到一或多个队列。有多种exchange类型，提供不同的路由方式，实现不同的消息场景</li>
<li>message在队列中等着consumer消费</li>
<li>当message被ack之后就会从队列中移除</li>
</ol>
<p>下面是发送与接收message的必要步骤：</p>
<ol>
<li>创建一个exchange</li>
<li>创建一个队列</li>
<li>把队列绑定到exchange上</li>
</ol>
<p>celery自动为CELERY_QUEUES创建了以上这些对象【除非你关闭了自动创建不存在队列的配置】。</p>
<p>下面是一个包含三个队列的配置，一个video，一个image，还一个默认的：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> kombu <span class="keyword">import</span> Exchange, Queue</div><div class="line"></div><div class="line">CELERY_QUEUES = (</div><div class="line">    Queue(<span class="string">'default'</span>, Exchange(<span class="string">'default'</span>), routing_key=<span class="string">'default'</span>),</div><div class="line">    Queue(<span class="string">'videos'</span>,  Exchange(<span class="string">'media'</span>),   routing_key=<span class="string">'media.video'</span>),</div><div class="line">    Queue(<span class="string">'images'</span>,  Exchange(<span class="string">'media'</span>),   routing_key=<span class="string">'media.image'</span>),</div><div class="line">)</div><div class="line">CELERY_DEFAULT_QUEUE = <span class="string">'default'</span></div><div class="line">CELERY_DEFAULT_EXCHANGE_TYPE = <span class="string">'direct'</span></div><div class="line">CELERY_DEFAULT_ROUTING_KEY = <span class="string">'default'</span></div></pre></td></tr></table></figure></p>
<h4 id="Exchange类型"><a href="#Exchange类型" class="headerlink" title="Exchange类型"></a>Exchange类型</h4><p>标准的有：direct, topic, fanout, headers。非标准的就是一些rabbitMQ的插件了。</p>
<h5 id="direct"><a href="#direct" class="headerlink" title="direct"></a>direct</h5><p>匹配精确的routing key，绑定到routing key video的队列只会接收带有video routing key的message。</p>
<h5 id="topc"><a href="#topc" class="headerlink" title="topc"></a>topc</h5><p>支持对号隔开、带有通配符的routing key。</p>
<h4 id="相关API"><a href="#相关API" class="headerlink" title="相关API"></a>相关API</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">exchange.declare(exchange_name, type, passive,</div><div class="line">durable, auto_delete, internal)</div><div class="line">Declares an exchange by name.</div><div class="line"></div><div class="line">See amqp:Channel.exchange_declare.</div><div class="line"></div><div class="line">Parameters:	</div><div class="line">    passive – Passive means the exchange won’t be created, but you can use this to check if the exchange already exists.</div><div class="line">    durable – Durable exchanges are persistent. That is - they survive a broker restart.</div><div class="line">    auto_delete – This means the queue will be deleted by the broker when there are no more queues using it.</div><div class="line">    queue.declare(queue_name, passive, durable, exclusive, auto_delete)</div><div class="line">    Declares a queue by name.</div><div class="line"></div><div class="line">See amqp:Channel.queue_declare</div><div class="line"></div><div class="line">Exclusive queues can only be consumed from by the current connection. Exclusive also implies auto_delete.</div><div class="line"></div><div class="line">queue.bind(queue_name, exchange_name, routing_key)</div><div class="line">Binds a queue to an exchange with a routing key.</div><div class="line"></div><div class="line">Unbound queues will not receive messages, so this is necessary.</div><div class="line"></div><div class="line">See amqp:Channel.queue_bind</div><div class="line"></div><div class="line">queue.delete(name, if_unused=False, if_empty=False)</div><div class="line">Deletes a queue and its binding.</div><div class="line"></div><div class="line">See amqp:Channel.queue_delete</div><div class="line"></div><div class="line">exchange.delete(name, if_unused=False)¶</div><div class="line">Deletes an exchange.</div><div class="line"></div><div class="line">See amqp:Channel.exchange_delete</div></pre></td></tr></table></figure>
<h4 id="使用API"><a href="#使用API" class="headerlink" title="使用API"></a>使用API</h4><p>自带了一个工具 celery amqp，用来在命令行访问AMQP API，执行创建/删除队列或exchange的，清空队列或者正在发送的message。也能在没有AMQP broker的上面使用。</p>
<p>可以在celery amap后面指定参数来调用API, 或者不指定参数，就进入了shell模式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ celery -A proj amqp</div><div class="line">-&gt; connecting to amqp://guest@localhost:5672/.</div><div class="line">-&gt; connected.</div><div class="line">1&gt;</div></pre></td></tr></table></figure></p>
<p>这里的1是你执行命令个数的编号。可以输入help，这个模式也支持自动补全。</p>
<p>下面是创建队列的例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ celery -A proj amqp</div><div class="line">1&gt; exchange.declare testexchange direct</div><div class="line">ok.</div><div class="line">2&gt; queue.declare testqueue</div><div class="line">ok. queue:testqueue messages:0 consumers:0.</div><div class="line">3&gt; queue.bind testqueue testexchange testkey</div><div class="line">ok.</div></pre></td></tr></table></figure></p>
<p>这里队列名称是testqueue，使用routing key testkey绑定了exchange为testexchange。</p>
<p>现在开始所有发送到exchange  testchange的message，只要她的routing key是testkey，那么他就会进入testqueue这个队列。我们可以使用basic.publish来发送一个message:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">4&gt; basic.publish &apos;This is a message!&apos; testexchange testkey</div><div class="line">ok.</div></pre></td></tr></table></figure></p>
<p>现在message已经发送出去了，你可以使用basic.get命令抽取它了(这个命令指示用来维护task的，正常服务应该使用basic.consume替代)。</p>
<p>从队列中pop出一条message：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">5&gt; basic.get testqueue</div><div class="line">&#123;&apos;body&apos;: &apos;This is a message!&apos;,</div><div class="line"> &apos;delivery_info&apos;: &#123;&apos;delivery_tag&apos;: 1,</div><div class="line">                   &apos;exchange&apos;: u&apos;testexchange&apos;,</div><div class="line">                   &apos;message_count&apos;: 0,</div><div class="line">                   &apos;redelivered&apos;: False,</div><div class="line">                   &apos;routing_key&apos;: u&apos;testkey&apos;&#125;,</div><div class="line"> &apos;properties&apos;: &#123;&#125;&#125;</div></pre></td></tr></table></figure></p>
<p>AMQP使用ack来确认某个message被消费并且成功执行。如果message还没有被ack，consumer channel就关闭了，那么这个message就会被传递给其他的consumer。</p>
<p>注意传递的tag在上面结构中已经有了。在一个连接channel内，每个接收到的message都有唯一的传递tag，这个tag用来ack这个message。还要注意，传递tag在多个连接之中并不是唯一的，也就是说连接1中的连接tag为1的message是A，连接2中的连接tag为1的message有可能就是B。</p>
<p>使用basic.ack来加上这个标记：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">6&gt; basic.ack 1</div><div class="line">ok.</div></pre></td></tr></table></figure></p>
<p>记得要在测试会话完成后清空刚才创建的message：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">7&gt; queue.delete testqueue</div><div class="line">ok. 0 messages deleted.</div><div class="line">8&gt; exchange.delete testexchange</div><div class="line">ok.</div></pre></td></tr></table></figure></p>
<h2 id="Routing-Tasks"><a href="#Routing-Tasks" class="headerlink" title="Routing Tasks"></a>Routing Tasks</h2><h4 id="定义队列"><a href="#定义队列" class="headerlink" title="定义队列"></a>定义队列</h4><p>下面是一个包含三个队列定义的例子，一个是video，一个是images还有一个默认的队列<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">default_exchange = Exchange(<span class="string">'default'</span>, type=<span class="string">'direct'</span>)</div><div class="line">media_exchange = Exchange(<span class="string">'media'</span>, type=<span class="string">'direct'</span>)</div><div class="line"></div><div class="line">CELERY_QUEUES = (</div><div class="line">    Queue(<span class="string">'default'</span>, default_exchange, routing_key=<span class="string">'default'</span>),</div><div class="line">    Queue(<span class="string">'videos'</span>, media_exchange, routing_key=<span class="string">'media.video'</span>),</div><div class="line">    Queue(<span class="string">'images'</span>, media_exchange, routing_key=<span class="string">'media.image'</span>)</div><div class="line">)</div><div class="line">CELERY_DEFAULT_QUEUE = <span class="string">'default'</span></div><div class="line">CELERY_DEFAULT_EXCHANGE = <span class="string">'default'</span></div><div class="line">CELERY_DEFAULT_ROUTING_KEY = <span class="string">'default'</span></div></pre></td></tr></table></figure></p>
<p>若没有指定特定路由就都进入CELERY_DEFAULT_QUEUE里。</p>
<h4 id="指定task目的地"><a href="#指定task目的地" class="headerlink" title="指定task目的地"></a>指定task目的地</h4><p>按照如下顺序决定message的目的地：</p>
<ol>
<li>在CELERY_ROUTES中定义的路由</li>
<li>Task.apply_async()中指定的路由参数</li>
<li>在Task自身中定义的相关属性</li>
</ol>
<p>最好不要硬编码这些配置，使用 Routers来读取配置，这是最灵活的方式。但是一些敏感的默认值还是可以被设置为任务属性。</p>
<h4 id="Routers"><a href="#Routers" class="headerlink" title="Routers"></a>Routers</h4><p>Router类是用来决定某个task的路由选项的。</p>
<p>我们只需要创建一个新的路由类，带有一个route_for_task方法：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyRouter</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">route_for_task</span><span class="params">(self, task, args=None, kwargs=None)</span>:</span></div><div class="line">        <span class="keyword">if</span> task == <span class="string">'myapp.tasks.compress_video'</span>:</div><div class="line">            <span class="keyword">return</span> &#123;<span class="string">'exchange'</span>: <span class="string">'video'</span>,</div><div class="line">                    <span class="string">'exchange_type'</span>: <span class="string">'topic'</span>,</div><div class="line">                    <span class="string">'routing_key'</span>: <span class="string">'video.compress'</span>&#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div></pre></td></tr></table></figure></p>
<p>如果返回值中包含了 queue，那么会在CELERY_QUEUES里定义的配置上扩展，也就是会继承既有的配置。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&apos;queue&apos;: &apos;video&apos;, &apos;routing_key&apos;: &apos;video.compress&apos;&#125;</div></pre></td></tr></table></figure></p>
<p>就变成了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;&apos;queue&apos;: &apos;video&apos;,</div><div class="line"> &apos;exchange&apos;: &apos;video&apos;,</div><div class="line"> &apos;exchange_type&apos;: &apos;topic&apos;,</div><div class="line"> &apos;routing_key&apos;: &apos;video.compress&apos;&#125;</div></pre></td></tr></table></figure></p>
<p>完事儿后把Router放进CELERY_ROUTES配置信息里就好了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CELERY_ROUTES = (MyRouter(), )</div></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CELERY_ROUTES = (&apos;myapp.routers.MyRouter&apos;, )</div></pre></td></tr></table></figure></p>
<p>其实对于上面那种简单的路由规则， 也可以直接写在配置里：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">CELERY_ROUTES = (&#123;&apos;myapp.tasks.compress_video&apos;: &#123;</div><div class="line">                        &apos;queue&apos;: &apos;video&apos;,</div><div class="line">                        &apos;routing_key&apos;: &apos;video.compress&apos;</div><div class="line">                 &#125;&#125;, )</div></pre></td></tr></table></figure></p>
<h4 id="广播"><a href="#广播" class="headerlink" title="广播"></a>广播</h4><p>Celery也支持广播路由。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">from kombu.common import Broadcast</div><div class="line"></div><div class="line">CELERY_QUEUES = (Broadcast(&apos;broadcast_tasks&apos;), )</div><div class="line"></div><div class="line">CELERY_ROUTES = &#123;&apos;tasks.reload_cache&apos;: &#123;&apos;queue&apos;: &apos;broadcast_tasks&apos;&#125;&#125;</div></pre></td></tr></table></figure></p>
<p>这样，tasks.reload_cache任务就可以发送给每个消费这个队列的worker了。</p>
<p>注意celery的结果并没有定义如果两个任务都有同一个task_id。如果同样的task被分发给多个worker，那么state历史可能也不会被保存。</p>
<p>这样的话，设置task.ignore_result是一个不错的选择。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Ember-data---record操作]]></title>
      <url>/2016/12/05/Ember-data---record%E6%93%8D%E4%BD%9C/</url>
      <content type="html"><![CDATA[<h2 id="查询record"><a href="#查询record" class="headerlink" title="查询record"></a>查询record</h2><h3 id="抽取单个record"><a href="#抽取单个record" class="headerlink" title="抽取单个record"></a>抽取单个record</h3><p>使用 <a href="http://emberjs.com/api/data/classes/DS.Store.html#method_findRecord" target="_blank" rel="external"><code>store.findRecord()</code></a>方法，按照id和type进行查询. 返回一个包含对应record的promise:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> post = <span class="keyword">this</span>.store.findRecord(<span class="string">'post'</span>, <span class="number">1</span>); <span class="comment">// =&gt; GET /posts/1</span></div></pre></td></tr></table></figure>
<p>使用 <a href="http://emberjs.com/api/data/classes/DS.Store.html#method_peekRecord" target="_blank" rel="external"><code>store.peekRecord()</code></a>.跟上面的一样，但是只查询store中当前已经存在的record，不会向后端server请求:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> post = <span class="keyword">this</span>.store.peekRecord(<span class="string">'post'</span>, <span class="number">1</span>); <span class="comment">// =&gt; no network request</span></div></pre></td></tr></table></figure>
<h3 id="抽取多个Records"><a href="#抽取多个Records" class="headerlink" title="抽取多个Records"></a>抽取多个Records</h3><p>使用 <a href="http://emberjs.com/api/data/classes/DS.Store.html#method_findAll" target="_blank" rel="external"><code>store.findAll()</code></a>查询某个类型的所有record:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> posts = <span class="keyword">this</span>.store.findAll(<span class="string">'post'</span>); <span class="comment">// =&gt; GET /posts</span></div></pre></td></tr></table></figure>
<p>参上： <a href="http://emberjs.com/api/data/classes/DS.Store.html#method_peekAll" target="_blank" rel="external"><code>store.peekAll()</code></a>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> posts = <span class="keyword">this</span>.store.peekAll(<span class="string">'post'</span>); <span class="comment">// =&gt; no network request</span></div></pre></td></tr></table></figure>
<p><code>store.findAll()</code> 返回的<code>PromiseArray</code> 包含<br><code>RecordArray</code> 。 <code>store.peekAll</code>直接返回<code>RecordArray</code>.</p>
<p>注意<code>RecordArray</code>并不是JavaScript array，而是一个实现了<a href="http://emberjs.com/api/classes/Ember.Enumerable.html" target="_blank" rel="external"><code>Ember.Enumerable</code></a>的对象，所以如果要按照index访问数据，不能使用 <code>[]</code>，而应该使用 <code>objectAt(index)</code> .</p>
<h3 id="查询多个Records"><a href="#查询多个Records" class="headerlink" title="查询多个Records"></a>查询多个Records</h3><p>可以查一些满足某些范式的record。<br><a href="http://emberjs.com/api/data/classes/DS.Store.html#method_query" target="_blank" rel="external"><code>store.query()</code></a>会发起一个带有查询参数的GET请求，返回值跟findAll一样是一个 <code>PromiseArray</code>.</p>
<p>找出所有名字叫<code>Peter</code>的<code>person</code> models :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// GET to /persons?filter[name]=Peter</span></div><div class="line"><span class="keyword">this</span>.store.query(<span class="string">'person'</span>, &#123; <span class="attr">filter</span>: &#123; <span class="attr">name</span>: <span class="string">'Peter'</span> &#125; &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">peters</span>) </span>&#123;</div><div class="line">  <span class="comment">// Do something with `peters`</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="查询单个Record"><a href="#查询单个Record" class="headerlink" title="查询单个Record"></a>查询单个Record</h3><p><a href="http://emberjs.com/api/data/classes/DS.Store.html#method_queryRecord" target="_blank" rel="external"><code>store.queryRecord()</code></a>返回一个promise。</p>
<p>查询邮箱是’tomster@example.com’ 的person model:<br><code>tomster@example.com</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// GET to /persons?filter[email]=tomster@example.com</span></div><div class="line"><span class="keyword">this</span>.store.queryRecord(<span class="string">'person'</span>, &#123; <span class="attr">filter</span>: &#123; <span class="attr">email</span>: <span class="string">'tomster@example.com'</span> &#125; &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">tomster</span>) </span>&#123;</div><div class="line">  <span class="comment">// do something with `tomster`</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="创建、更新与删除"><a href="#创建、更新与删除" class="headerlink" title="创建、更新与删除"></a>创建、更新与删除</h2><h2 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h2><p><a href="http://emberjs.com/api/data/classes/DS.Store.html#method_createRecord" target="_blank" rel="external"><code>createRecord()</code></a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">store.createRecord(<span class="string">'post'</span>, &#123;</div><div class="line">  <span class="attr">title</span>: <span class="string">'Rails is Omakase'</span>,</div><div class="line">  <span class="attr">body</span>: <span class="string">'Lorem ipsum'</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>在controller或者route中直接调用 <code>this.store</code>就可以获得store对象.</p>
<h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.store.findRecord(<span class="string">'person'</span>, <span class="number">1</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">tyrion</span>) </span>&#123;</div><div class="line">  <span class="comment">// ...after the record has loaded</span></div><div class="line">  tyrion.set(<span class="string">'firstName'</span>, <span class="string">"Yollo"</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Ember中修改属性特别便捷。例如，你可以使用 <code>Ember.Object</code>的<br><a href="http://emberjs.com/api/classes/Ember.Object.html#method_incrementProperty" target="_blank" rel="external"><code>incrementProperty</code></a> helper:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">person.incrementProperty(<span class="string">'age'</span>); <span class="comment">// Happy birthday!</span></div></pre></td></tr></table></figure>
<h2 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h2><p>执行Model的任意实例的<a href="http://emberjs.com/api/data/classes/DS.Model.html#method_save" target="_blank" rel="external"><code>save()</code></a>方法都会触发网络请求.</p>
<p>Ember Data会跟踪每个record的状态。这样当存储新创建的record和已经存在的record的时候就能区别对待。</p>
<p>Ember Data默认<code>POST</code> 新创建的record到它的type对应的url.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> post = store.createRecord(<span class="string">'post'</span>, &#123;</div><div class="line">  <span class="attr">title</span>: <span class="string">'Rails is Omakase'</span>,</div><div class="line">  <span class="attr">body</span>: <span class="string">'Lorem ipsum'</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line">post.save(); <span class="comment">// =&gt; POST to '/posts'</span></div></pre></td></tr></table></figure>
<p>已经存在的record使用HTTP的 <code>PATCH</code>动作.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">store.findRecord(<span class="string">'post'</span>, <span class="number">1</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">post</span>) </span>&#123;</div><div class="line">  post.get(<span class="string">'title'</span>); <span class="comment">// =&gt; "Rails is Omakase"</span></div><div class="line"></div><div class="line">  post.set(<span class="string">'title'</span>, <span class="string">'A new post'</span>);</div><div class="line"></div><div class="line">  post.save(); <span class="comment">// =&gt; PATCH to '/posts/1'</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>你可以通过record的<br><a href="http://emberjs.com/api/data/classes/DS.Model.html#property_hasDirtyAttributes" target="_blank" rel="external"><code>hasDirtyAttributes</code></a><br>属性来辨别是否有没有提交的修改. 也可以使用<br><a href="http://emberjs.com/api/data/classes/DS.Model.html#method_changedAttributes" target="_blank" rel="external"><code>changedAttributes()</code></a><br>方法辨别，哪些属性修改了，哪些没有. <code>changedAttributes</code>返回一个对象，key是被修改的属性名称，值是<code>[oldValue, newValue]</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">person.get(<span class="string">'isAdmin'</span>);            <span class="comment">//=&gt; false</span></div><div class="line">person.get(<span class="string">'hasDirtyAttributes'</span>); <span class="comment">//=&gt; false</span></div><div class="line">person.set(<span class="string">'isAdmin'</span>, <span class="literal">true</span>);</div><div class="line">person.get(<span class="string">'hasDirtyAttributes'</span>); <span class="comment">//=&gt; true</span></div><div class="line">person.changedAttributes();       <span class="comment">//=&gt; &#123; isAdmin: [false, true] &#125;</span></div></pre></td></tr></table></figure>
<p>这时，你可以调用save()方法持久化这些改变，也可以调用<br><a href="http://emberjs.com/api/data/classes/DS.Model.html#method_rollbackAttributes" target="_blank" rel="external"><code>rollbackAttributes()</code></a><br>回滚这些修改。如果这个record <code>isNew</code>【是新建的】，那么就会被从store中删除.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">person.get(<span class="string">'hasDirtyAttributes'</span>); <span class="comment">//=&gt; true</span></div><div class="line">person.changedAttributes();       <span class="comment">//=&gt; &#123; isAdmin: [false, true] &#125;</span></div><div class="line"></div><div class="line">person.rollbackAttributes();</div><div class="line"></div><div class="line">person.get(<span class="string">'hasDirtyAttributes'</span>); <span class="comment">//=&gt; false</span></div><div class="line">person.get(<span class="string">'isAdmin'</span>);            <span class="comment">//=&gt; false</span></div><div class="line">person.changedAttributes();       <span class="comment">//=&gt; &#123;&#125;</span></div></pre></td></tr></table></figure>
<h2 id="验证错误"><a href="#验证错误" class="headerlink" title="验证错误"></a>验证错误</h2><p>如果后端server尝试save的时候返回了验证错误，那么会体现在你的model的<code>errors</code>属性上。你可以通过下面的方法在你的模板中展示这些错误：</p>
<figure class="highlight hbs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="template-tag">&#123;&#123;#<span class="name"><span class="builtin-name">each</span></span> post.errors.title as |error|&#125;&#125;</span></div><div class="line">  &lt;div class="error"&gt;<span class="template-variable">&#123;&#123;error.message&#125;&#125;</span>&lt;/div&gt;</div><div class="line"><span class="template-tag">&#123;&#123;/<span class="name"><span class="builtin-name">each</span></span>&#125;&#125;</span></div><div class="line"><span class="template-tag">&#123;&#123;#<span class="name"><span class="builtin-name">each</span></span> post.errors.body as |error|&#125;&#125;</span></div><div class="line">  &lt;div class="error"&gt;<span class="template-variable">&#123;&#123;error.message&#125;&#125;</span>&lt;/div&gt;</div><div class="line"><span class="template-tag">&#123;&#123;/<span class="name"><span class="builtin-name">each</span></span>&#125;&#125;</span></div></pre></td></tr></table></figure>
<h2 id="Promises"><a href="#Promises" class="headerlink" title="Promises"></a>Promises</h2><p><a href="http://emberjs.com/api/data/classes/DS.Model.html#method_save" target="_blank" rel="external"><code>save()</code></a> 返回一个promise。下面是典型操作:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> post = store.createRecord(<span class="string">'post'</span>, &#123;</div><div class="line">  <span class="attr">title</span>: <span class="string">'Rails is Omakase'</span>,</div><div class="line">  <span class="attr">body</span>: <span class="string">'Lorem ipsum'</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">transitionToPost</span>(<span class="params">post</span>) </span>&#123;</div><div class="line">  self.transitionToRoute(<span class="string">'posts.show'</span>, post);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">failure</span>(<span class="params">reason</span>) </span>&#123;</div><div class="line">  <span class="comment">// handle the error</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">post.save().then(transitionToPost).catch(failure);</div><div class="line"></div><div class="line"><span class="comment">// =&gt; POST to '/posts'</span></div><div class="line"><span class="comment">// =&gt; transitioning to posts.show route</span></div></pre></td></tr></table></figure>
<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><p>删除跟创建一样直接。 调用一个实例的<a href="http://emberjs.com/api/data/classes/DS.Model.html#method_deleteRecord" target="_blank" rel="external"><code>deleteRecord()</code></a>方法. 之后会标记record为 <code>isDeleted</code>. 使用<code>save()</code>持久化删除操作. 或者使用<code>destroyRecord</code> 方法直接物理删除.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">store.findRecord(<span class="string">'post'</span>, <span class="number">1</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">post</span>) </span>&#123;</div><div class="line">  post.deleteRecord();</div><div class="line">  post.get(<span class="string">'isDeleted'</span>); <span class="comment">// =&gt; true</span></div><div class="line">  post.save(); <span class="comment">// =&gt; DELETE to /posts/1</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// OR</span></div><div class="line">store.findRecord(<span class="string">'post'</span>, <span class="number">2</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">post</span>) </span>&#123;</div><div class="line">  post.destroyRecord(); <span class="comment">// =&gt; DELETE to /posts/2</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="事先推送record进入store"><a href="#事先推送record进入store" class="headerlink" title="事先推送record进入store"></a>事先推送record进入store</h2><p>controller或者route请求store中没有的store时，store还要向adapter发起网络请求。<br>除了等待app请求一个record，你也可以提前向store中push record。</p>
<p>如果你知道你的用户下一步会使用什么record，那这就很有用。当他们请求的时候，会飞速返回。Ember可以自动重新渲染模板。</p>
<p>另外一个用例是与后端建立streaming connection的时候。当一个record被创建或者修改后，你应该马上更新UI。</p>
<h3 id="推送"><a href="#推送" class="headerlink" title="推送"></a>推送</h3><p>调用store的 <a href="http://emberjs.com/api/data/classes/DS.Store.html#method_push" target="_blank" rel="external"><code>push()</code></a> 方法.</p>
<p>假设当app刚启动的时候，我们要预加载一些数据到store中。</p>
<p>我们使用<code>route:application</code>来做这项工作. <code>route:application</code> 是route层级结构中的最顶级route，他的 <code>model</code> hook 只在app启动的时候被调用一次.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">import Model from &apos;ember-data/model&apos;;</div><div class="line">import attr from &apos;ember-data/attr&apos;;</div><div class="line"></div><div class="line">export default Model.extend(&#123;</div><div class="line">  title: attr(),</div><div class="line">  artist: attr(),</div><div class="line">  songCount: attr()</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">export default Ember.Route.extend(&#123;</div><div class="line">  model() &#123;</div><div class="line">    this.store.push(&#123;</div><div class="line">      data: [&#123;</div><div class="line">        id: 1,</div><div class="line">        type: &apos;album&apos;,</div><div class="line">        attributes: &#123;</div><div class="line">          title: &apos;Fewer Moving Parts&apos;,</div><div class="line">          artist: &apos;David Bazan&apos;,</div><div class="line">          songCount: 10</div><div class="line">        &#125;,</div><div class="line">        relationships: &#123;&#125;</div><div class="line">      &#125;, &#123;</div><div class="line">        id: 2,</div><div class="line">        type: &apos;album&apos;,</div><div class="line">        attributes: &#123;</div><div class="line">          title: &apos;Calgary b/w I Can\&apos;t Make You Love Me/Nick Of Time&apos;,</div><div class="line">          artist: &apos;Bon Iver&apos;,</div><div class="line">          songCount: 2</div><div class="line">        &#125;,</div><div class="line">        relationships: &#123;&#125;</div><div class="line">      &#125;]</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>store的 <code>push()</code> 方法是一个低级API，接收JSON API文档，使用JSONAPISerializer进行解析 。JSON API终端 type名称必须跟model的严格对应。（这个例子里就是<code>album</code>，因为model就是<code>app/models/album.js</code>）。属性和关系的大小写也必须和model定义中完全一致。</p>
<p>如果你想在推送进store前标准化model默认的serializer，可使用<br><a href="http://emberjs.com/api/data/classes/DS.Store.html#method_pushPayload" target="_blank" rel="external"><code>store.pushPayload()</code></a> 方法.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">import RestSerializer from &apos;ember-data/serializers/rest&apos;;</div><div class="line"></div><div class="line">export default RestSerializer.extend(&#123;</div><div class="line">  normalize(typeHash, hash) &#123;</div><div class="line">    hash[&apos;songCount&apos;] = hash[&apos;song_count&apos;]</div><div class="line">    delete hash[&apos;song_count&apos;]</div><div class="line">    return this._super(typeHash, hash);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">export default Ember.Route.extend(&#123;</div><div class="line">  model() &#123;</div><div class="line">    this.store.pushPayload(&#123;</div><div class="line">      albums: [</div><div class="line">        &#123;</div><div class="line">          id: 1,</div><div class="line">          title: &apos;Fever Moving Parts&apos;,</div><div class="line">          artist: &apos;David Bazan&apos;,</div><div class="line">          song_count: 10</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          id: 2,</div><div class="line">          title: &apos;Calgary b/w I Can\&apos;t Make You Love Me/Nick Of Time&apos;,</div><div class="line">          artist: &apos;Bon Iver&apos;,</div><div class="line">          song_count: 2</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><code>push()</code> 方法在于复杂终端协同的时候也很重要。你的应用终端有时会执行一些业务逻辑，创建多个record。这对于Ember Data的<code>save()</code> API并不是完全对应，后者只能操作单条record。这是，你应该使用自己的ajax请求推送结果数据到store中，供其他UI页面使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">export default Ember.Route.extend(&#123;</div><div class="line">  actions: &#123;</div><div class="line">    confirm: function(data) &#123;</div><div class="line">      $.ajax(&#123;</div><div class="line">        data: data,</div><div class="line">        method: &apos;POST&apos;,</div><div class="line">        url: &apos;process-payment&apos;</div><div class="line">      &#125;).then((digitalInventory) =&gt; &#123;</div><div class="line">        this.store.pushPayload(digitalInventory);</div><div class="line">        this.transitionTo(&apos;thank-you&apos;);</div><div class="line">      &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ambari上hive-view添加用户]]></title>
      <url>/2016/12/05/ambari%E4%B8%8Ahive-view%E6%B7%BB%E5%8A%A0%E7%94%A8%E6%88%B7/</url>
      <content type="html"><![CDATA[<h4 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h4><p>在ambari 2.2.0.0中添加完用户和用户组之后，需要为这个用户单独给定一次ambari dashboard的只读权限以后才能正常访问hive view，否则就会报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">E090 RA040 I/O error while requesting Ambari [AmbariApiException]</div></pre></td></tr></table></figure></p>
<p>还有一个问题是，hive view里的每个用户都需要在/user/hive下有自己的文件夹才行，并且把文件夹的owner设置生当前用户才行。否则报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">E090 HDFS020 Could not write file query.hql [HdfsApiException]</div></pre></td></tr></table></figure></p>
<h4 id="以前总结"><a href="#以前总结" class="headerlink" title="以前总结"></a>以前总结</h4><pre><code>a. 给新用户开通dashboard的只读权限和指定view的使用权限【解决ambari的IO问题AmbariApiException】;
b. 到hdfs上创建/user/xxx目录，并将此目录的owner设置为xxx【解决hql写入问题HdfsApiException】
c. 使用没有问题的话，就可以把这个xxx用户的dashboard权限去掉了。
</code></pre><hr>
<h4 id="回想"><a href="#回想" class="headerlink" title="回想"></a>回想</h4><p>上面给用户readonly权限感觉就跟跑堂的似的，那么它实际是执行了什么操作呢？我怀疑它会在hdfs上创建一个user，但是并不存在于Linux中。</p>
<p>问题来了：</p>
<ol>
<li>hdfs和linux到底用的是不是同一套用户呢？还是说只是用的Linux的POSIX体系？<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@datanode04 ~]# groups will</div><div class="line">will : will hdfs</div><div class="line">[root@datanode04 ~]# hdfs groups will</div><div class="line">will :</div><div class="line">[will@datanode04 root]$ hdfs dfs -ls /apps/hive</div><div class="line">drwxrwxrw-   - hive hdfs          0 2016-05-30 10:47 /apps/hive/warehouse</div><div class="line">[will@datanode04 root]$ hdfs dfs -ls /apps/hive/warehouse</div><div class="line">ls: Permission denied: user=will, access=READ_EXECUTE, inode=&quot;/apps/hive/warehouse&quot;:hive:hdfs:drwxrwxrw-</div></pre></td></tr></table></figure>
</li>
</ol>
<p>看这样子，no！hdfs并没有使用Linux上已有的用户组和用户的关系。可以看到hdfs上的文件夹/apps/hive/warehouse对于all并没有x权限，也就是说不能进去。/apps/hive/warehouse这个文件夹是属于hive用户，hdfs组。而will不能访问，代表他在hdfs系统里并不属于hdfs组。</p>
<p>找了hdfs的官网命令，没有找到关于在hdfs里添加用户的命令。回头儿想了一下，有个失误的地方：我只在一个node上添加了will用户，其他node上并没有。参考<a href="http://dongxicheng.org/mapreduce/hadoop-permission-management/，hdfs就是使用的Linux用户和用户组，但是需要每个node分别创建。" target="_blank" rel="external">http://dongxicheng.org/mapreduce/hadoop-permission-management/，hdfs就是使用的Linux用户和用户组，但是需要每个node分别创建。</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">scp -v /etc/passwd /etc/group datanode05.will.com:/etc</div></pre></td></tr></table></figure>
<p>每个机器都scp过之后，再次查看hdfs里的效果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@datanode04 ~]# hdfs groups will</div><div class="line">will : will hdfs</div></pre></td></tr></table></figure></p>
<p>好了。那么为了验证上面给新用户dashboard的readonly权限是为了添加用户，我们再去ambari里添加普通用户will。还是报错，老套路，添加用户对集群的read权限，发现以下几个借口：</p>
<h5 id="为用户组添加dashboard的只读权限"><a href="#为用户组添加dashboard的只读权限" class="headerlink" title="为用户组添加dashboard的只读权限"></a>为用户组添加dashboard的只读权限</h5><p>PUT: <a href="http://namenode01.will.com:8080/api/v1/clusters/datacenter/privileges" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/clusters/datacenter/privileges</a><br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">    &#123;</div><div class="line">        <span class="attr">"PrivilegeInfo"</span>: &#123;</div><div class="line">            <span class="attr">"permission_name"</span>: <span class="string">"CLUSTER.READ"</span>,</div><div class="line">            <span class="attr">"principal_name"</span>: <span class="string">"analyst"</span>,</div><div class="line">            <span class="attr">"principal_type"</span>: <span class="string">"GROUP"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">]</div></pre></td></tr></table></figure></p>
<blockquote>
<p>curl  -u admin:admin -H ‘X-Requested-By:ambari’ -X PUT -d ‘[{“PrivilegeInfo”:{“permission_name”:”CLUSTER.READ”,”principal_name”:”testgroup”,”principal_type”:”GROUP”}}]’ <a href="http://namenode01.will.com:8080/api/v1/clusters/datacenter/privileges" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/clusters/datacenter/privileges</a></p>
</blockquote>
<h5 id="为用户添加dashboard的只读权限"><a href="#为用户添加dashboard的只读权限" class="headerlink" title="为用户添加dashboard的只读权限"></a>为用户添加dashboard的只读权限</h5><p>PUT：<a href="http://namenode01.will.com:8080/api/v1/clusters/datacenter/privileges" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/clusters/datacenter/privileges</a><br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">    &#123;</div><div class="line">        <span class="attr">"PrivilegeInfo"</span>: &#123;</div><div class="line">            <span class="attr">"permission_name"</span>: <span class="string">"CLUSTER.READ"</span>,</div><div class="line">            <span class="attr">"principal_name"</span>: <span class="string">"will"</span>,</div><div class="line">            <span class="attr">"principal_type"</span>: <span class="string">"USER"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">]</div></pre></td></tr></table></figure></p>
<h5 id="收回用户-用户组dashboard的只读权限"><a href="#收回用户-用户组dashboard的只读权限" class="headerlink" title="收回用户/用户组dashboard的只读权限"></a>收回用户/用户组dashboard的只读权限</h5><p>PUT：<a href="http://namenode01.will.com:8080/api/v1/clusters/datacenter/privileges" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/clusters/datacenter/privileges</a><br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[]</div></pre></td></tr></table></figure></p>
<p>更新成最新的权限组合就行了<br>【<strong>这种就存在并发问题了，如果操作的是group会有相互影响，user就好些</strong>】</p>
<h5 id="为用户-用户组添加hive-view的只读权限"><a href="#为用户-用户组添加hive-view的只读权限" class="headerlink" title="为用户/用户组添加hive view的只读权限"></a>为用户/用户组添加hive view的只读权限</h5><p>PUT：<a href="http://namenode01.will.com:8080/api/v1/views/HIVE/versions/1.0.0/instances/AUTO_HIVE_INSTANCE/privileges" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/views/HIVE/versions/1.0.0/instances/AUTO_HIVE_INSTANCE/privileges</a><br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">    &#123;</div><div class="line">        <span class="attr">"PrivilegeInfo"</span>: &#123;</div><div class="line">            <span class="attr">"permission_name"</span>: <span class="string">"VIEW.USE"</span>,</div><div class="line">            <span class="attr">"principal_name"</span>: <span class="string">"will"</span>,</div><div class="line">            <span class="attr">"principal_type"</span>: <span class="string">"USER"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">]</div></pre></td></tr></table></figure></p>
<blockquote>
<p>curl  -u admin:admin -H ‘X-Requested-By:ambari’ -X PUT -d ‘[{“PrivilegeInfo”:{“permission_name”:”VIEW.USE”,”principal_name”:”testgroup”,”principal_type”:”GROUP”}}]’ <a href="http://namenode01.will.com:8080/api/v1/views/HIVE/versions/1.0.0/instances/AUTO_HIVE_INSTANCE/privileges" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/views/HIVE/versions/1.0.0/instances/AUTO_HIVE_INSTANCE/privileges</a></p>
</blockquote>
<ul>
<li>以上接口移除权限的时候同样适用PUT方法，只是json为空：[]。</li>
</ul>
<h5 id="ambari删除用户"><a href="#ambari删除用户" class="headerlink" title="ambari删除用户"></a>ambari删除用户</h5><p>DELETE: <a href="http://namenode01.will.com:8080/api/v1/users/will" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/users/will</a><br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"id"</span>:<span class="string">"will"</span>&#125;</div></pre></td></tr></table></figure></p>
<h5 id="ambari添加用户"><a href="#ambari添加用户" class="headerlink" title="ambari添加用户"></a>ambari添加用户</h5><p>POST: <a href="http://namenode01.will.com:8080/api/v1/users" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/users</a><br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"Users/user_name"</span>: <span class="string">"will"</span>,</div><div class="line">    <span class="attr">"Users/password"</span>: <span class="string">"1234qwer"</span>,</div><div class="line">    <span class="attr">"Users/active"</span>: <span class="literal">true</span>,</div><div class="line">    <span class="attr">"Users/admin"</span>: <span class="literal">false</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>curl -u admin:admin -H ‘X-Requested-By:ambari’ -X POST -d ‘{“Users/user_name”:”testuser”,”Users/password”:”1234qwer”,”Users/active”:true,”Users/admin”:false}’ <a href="http://namenode01.will.com:8080/api/v1/users" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/users</a></p>
</blockquote>
<h5 id="ambari添加用户组"><a href="#ambari添加用户组" class="headerlink" title="ambari添加用户组"></a>ambari添加用户组</h5><p>POST: <a href="http://namenode01.will.com:8080/api/v1/groups" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/groups</a><br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"Groups/group_name"</span>:<span class="string">"tt"</span>&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>curl  -u admin:admin -H ‘X-Requested-By:ambari’ -X POST -d ‘{“Groups/group_name”:”testgroup”}’ <a href="http://namenode01.will.com:8080/api/v1/groups" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/groups</a></p>
</blockquote>
<h5 id="ambari删除用户组"><a href="#ambari删除用户组" class="headerlink" title="ambari删除用户组"></a>ambari删除用户组</h5><p>DELETE: <a href="http://namenode01.will.com:8080/api/v1/groups/tt" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/groups/tt</a><br>啥都不用传</p>
<h5 id="ambari为用户指定用户组"><a href="#ambari为用户指定用户组" class="headerlink" title="ambari为用户指定用户组"></a>ambari为用户指定用户组</h5><p>POST: <a href="http://namenode01.will.com:8080/api/v1/groups/**analyst**/members/**will**" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/groups/**analyst**/members/**will**</a></p>
<blockquote>
<p>curl  -u admin:admin -H ‘X-Requested-By:ambari’ -X POST <a href="http://namenode01.will.com:8080/api/v1/groups/testgroup/members/testuser" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/groups/testgroup/members/testuser</a></p>
</blockquote>
<p>这个参数在url里</p>
<hr>
<p>综上总结过程如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#! /bin/bash</span></div><div class="line"></div><div class="line">user=<span class="variable">$1</span></div><div class="line">group=<span class="variable">$2</span></div><div class="line">pri_grp=<span class="variable">$3</span></div><div class="line"></div><div class="line"><span class="comment"># 1.在namenode上执行添加用户以及指定用户组的Linux命令</span></div><div class="line">useradd -G <span class="variable">$group</span> <span class="variable">$user</span></div><div class="line">groups <span class="variable">$user</span></div><div class="line"></div><div class="line"><span class="comment"># 2.检查hdfs上的用户组</span></div><div class="line">hdfs groups <span class="variable">$user</span></div><div class="line"></div><div class="line"><span class="comment"># 3.ambari上添加用户</span></div><div class="line">curl -u admin:admin -H <span class="string">'X-Requested-By:ambari'</span> -X POST <span class="_">-d</span> <span class="string">'&#123;"Users/user_name":"$user","Users/password":"1234qwer","Users/active":true,"Users/admin":false&#125;'</span> http://namenode01.will.com:8080/api/v1/users</div><div class="line"></div><div class="line"><span class="comment"># 4.ambari 调整用户到用户组</span></div><div class="line">curl  -u admin:admin -H <span class="string">'X-Requested-By:ambari'</span> -X POST http://namenode01.will.com:8080/api/v1/groups/<span class="variable">$group</span>/members/<span class="variable">$user</span></div><div class="line"></div><div class="line"><span class="comment"># 为用户添加dashboard的只读权限</span></div><div class="line">curl  -u admin:admin -H <span class="string">'X-Requested-By:ambari'</span> -X PUT <span class="_">-d</span> <span class="string">'[&#123;"PrivilegeInfo":&#123;"permission_name":"CLUSTER.READ","principal_name":"$user","principal_type":"USER"&#125;&#125;]'</span> http://namenode01.will.com:8080/api/v1/clusters/datacenter/privileges</div><div class="line"></div><div class="line"><span class="comment"># 模拟用户登录，访问一下hive view登录，这个过程会自动创建/user/$user文件夹</span></div><div class="line"><span class="comment"># 用chrome找了半天，么有找到登录的API，看看源码吧</span></div><div class="line"></div><div class="line"><span class="comment"># 模拟登录用户，访问hive view</span></div><div class="line"></div><div class="line"><span class="comment"># 删除普通用户对dashboard的所有权限</span></div><div class="line">curl  -u admin:admin -H <span class="string">'X-Requested-By:ambari'</span> -X PUT <span class="_">-d</span> <span class="string">'[]'</span> http://namenode01.will.com:8080/api/v1/clusters/datacenter/privileges</div><div class="line"></div><div class="line"><span class="comment"># 6. 检查一下用户文件夹，以此作为终点</span></div><div class="line">hdfs dfs -ls /user/<span class="variable">$user</span></div></pre></td></tr></table></figure></p>
<h4 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h4><p>可以修改一下ambari添加用户和用户组的地方，后台自动针对namenode的Linux系统进行相应操作，就不用单独再去执行命令行了。这样ambari、hdfs、Linux的用户以及用户组就会是一致的，后面的依赖前面的。</p>
<p>hive view加载过程中会请求一个URL：<a href="http://namenode01.will.com:8080/api/v1/clusters/datacenter/hosts?fields=Hosts%2Fpublic_host_name%2Chost_components%2FHostRoles%2Fcomponent_name" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/clusters/datacenter/hosts?fields=Hosts%2Fpublic_host_name%2Chost_components%2FHostRoles%2Fcomponent_name</a></p>
<p>这个URL需要对集群有可读权限，奇怪的是使用chrome看下面的网络请求里压根儿没有这个。它是内嵌在某个接口调用里的。</p>
<h4 id="延迟问题："><a href="#延迟问题：" class="headerlink" title="延迟问题："></a>延迟问题：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">[root@namenode01 will]# useradd -G hdfs will1</div><div class="line">[root@namenode01 will]# groups will1</div><div class="line">will1 : will1 hdfs</div><div class="line">[root@namenode01 will]# hdfs groups will1</div><div class="line">will1 : will1 hdfs</div><div class="line">[root@namenode01 will]# userdel will1</div><div class="line">[root@namenode01 will]# groups will1</div><div class="line">groups: will1: No such user</div><div class="line">[root@namenode01 will]# hdfs groups will1</div><div class="line">will1 : will1 hdfs</div><div class="line">[root@namenode01 will]# cat /etc/group | grep will</div><div class="line">hdfs:x:511:hdfs,will</div><div class="line">will:x:1003:</div><div class="line">[root@namenode01 will]# hdfs groups will1</div><div class="line">will1 : will1 hdfs</div><div class="line">[root@namenode01 will]# hdfs groups will2</div><div class="line">will2 :</div><div class="line">[root@namenode01 will]# useradd -G sqoop will1</div><div class="line">[root@namenode01 will]# groups will1</div><div class="line">will1 : will1 sqoop</div><div class="line">[root@namenode01 will]# hdfs groups will1</div><div class="line">will1 : will1 hdfs  </div><div class="line">[root@namenode01 will]# su will1</div><div class="line">[will1@namenode01 will]$ hdfs dfs -ls /apps/hive/warehouse</div><div class="line">Found 2 items</div><div class="line">drwxrwxrw-   - hive hdfs          0 2016-05-30 10:40 /apps/hive/warehouse/batting</div><div class="line">drwxrwxrw-   - hive hdfs          0 2016-05-30 10:47 /apps/hive/warehouse/batting2</div><div class="line">[will1@namenode01 will]$ hdfs groups will1</div><div class="line">will1 : will1 hdfs</div><div class="line">[will1@namenode01 will]$ groups will1</div><div class="line">will1 : will1 sqoop</div></pre></td></tr></table></figure>
<p>上面看到，在namenode上添加用户后就可以生效了。但是假设我分配组分配错了，重新修改用户组后，hdfs并没有跟着修改，will1用户还是可以访问到hdfs组权限的文件。过了一段时间后，才可以了。目测盯了一下，差不多4分钟左右才生效。</p>
<p>可是如果Linux删除了这个用户，hdfs能够也跟着删除么？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@namenode01 will]# hdfs groups will1</div><div class="line">will1 : will1 hdfs</div><div class="line">[root@namenode01 will]# grep will /etc/passwd</div><div class="line">[root@namenode01 will]# grep will /etc/group</div></pre></td></tr></table></figure></p>
<p>刚删除同样没有生效，过一会儿再看。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@namenode01 will]# hdfs groups will1</div><div class="line">will1 :</div></pre></td></tr></table></figure></p>
<p>也是会删除的。但是如果<strong>权限给错就不能立即收回</strong>，这是个问题。</p>
<p>参考：<a href="https://issues.apache.org/jira/browse/AMBARI-12732" target="_blank" rel="external">https://issues.apache.org/jira/browse/AMBARI-12732</a><br><a href="https://docs.hortonworks.com/HDPDocuments/Ambari-2.2.0.0/bk_ambari_views_guide/content/troubleshooting.html" target="_blank" rel="external">https://docs.hortonworks.com/HDPDocuments/Ambari-2.2.0.0/bk_ambari_views_guide/content/troubleshooting.html</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[openLDAP-安装配置]]></title>
      <url>/2016/12/05/openLDAP-%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE/</url>
      <content type="html"><![CDATA[<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>LDAP是一个许多传统高级系统管理员喜欢的服务，但是门槛高。<br>这里及你进介绍一些实用的规则，最下面会有一些参考。</p>
<h4 id="LDAP在局域网中的角色"><a href="#LDAP在局域网中的角色" class="headerlink" title="LDAP在局域网中的角色"></a>LDAP在局域网中的角色</h4><p>openLDAP实现了Lightweight Directory Access Protocol协议。目录本身是一个树结构的、可读的数据库。</p>
<p>我们使用openLDAP提供了一个网络验证中心，每个用户登录的时候都要到这里验证身份，如果是第一次的就自动创建他们的home目录。</p>
<p>这篇文章会提到怎样使用openLDAP作为验证中心，并为用户提供元数据。但是，文中使用明文用户名密码在wire中传播的方式是不安全的。因此推荐大家结合Kerberos使用openLDAP。</p>
<p>下面介绍LDAP的安装。</p>
<p>技术角度来看，LDAP目录是由一系列的有层级的entry组成。每个entry都属于某个指定的Object Classes，而且每个entry都包多含个kv键值对，也就是attribute。<br>entry是使用DN(distinguished name)来区分彼此的。DN由一系列组件构成，这些组件之间用逗号隔开，表示从树的top节点到这个entry的全路径。例如，公司：dc=example,dc=com。员工:cn=person,ou=People,dc=example,dc=com。</p>
<p>entry的objectClasses决定哪些attribute必须有，哪些可以没有。</p>
<p>上面的cn=persion，就是键值对的形式。上面的键(cn,ou,dc)分别代表着Common Name, Organizational Unit以及Domain Component。这是一些常用的术语。</p>
<p>先说位一下我们安装的几个注意点：</p>
<ul>
<li>LDAP与传统的系统用户或者其他数据无关。但是，我们安装过程中会存储一部分信息在/etc/paswd和/etc/group中，然后让这些信息在一个网络中心位置共享。</li>
<li>可以配置LDAP存储用户的密码。密码主要用来验证用户是否有权限访问指定的目录，还有就是验证用户是否知道正确的密码。当某个用户打开一个LDAP client来查看目录的时候，他的DB和密码就用来验证他的权限。当LDAP用来验证用户的时候，他的DB和密码只是用来建立LDAP目录的连接。成功连接就意味着用户知道正确的密码。</li>
</ul>
<h4 id="粘结层：将LDAP于系统软件整合起来"><a href="#粘结层：将LDAP于系统软件整合起来" class="headerlink" title="粘结层：将LDAP于系统软件整合起来"></a>粘结层：将LDAP于系统软件整合起来</h4><h6 id="NSS"><a href="#NSS" class="headerlink" title="NSS"></a>NSS</h6><h6 id="PAM"><a href="#PAM" class="headerlink" title="PAM"></a>PAM</h6><h4 id="Conventions【约定】"><a href="#Conventions【约定】" class="headerlink" title="Conventions【约定】"></a>Conventions【约定】</h4><ul>
<li>Debian GNU平台，或者Ubuntu。</li>
<li>有sudo免密命令。</li>
<li>安装过程中会有很多提示问题，运行：sudo dpkg-reconfigure debconf。然后舒服interface=Dialog，还有priority=low</li>
<li>查看日志：<blockquote>
<p>cd /var/log; sudo tail -F daemon.log sulog user.log auth.log debug kern.log syslog dmesg messages kerberos/{krb5kdc,kadmin,krb5lib}.log</p>
</blockquote>
</li>
<li>我们的测试系统叫做monarch.spinlock.hr，ip地址是192.168.7.12。server和client都会安在同一个机器上，为了明确区分client相对于monarch.spinlock.hr，server对应ldap1.spinlock.hr。按照下面配置/etc/hosts：<blockquote>
<p>192.168.7.12    monarch.spinlock.hr monarch krb1.spinlock.hr krb1 ldap1.spinlock.hr ldap1<br><strong>注意</strong><br>有的机器域名会被设置成127.0.0.1，这可能会出现问题。需要保证/etc/hosts里只能是: 127.0.0.1   localhost</p>
</blockquote>
</li>
<li>最后，测试是不是成功了。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"> ping -c1 localhost</div><div class="line">PING localhost (127.0.0.1) 56(84) bytes of data.</div><div class="line">....</div><div class="line"></div><div class="line">ping -c1 monarch</div><div class="line">PING monarch.spinlock.hr (192.168.7.12) 56(84) bytes of data.</div><div class="line">....</div><div class="line"></div><div class="line">ping -c1 ldap1</div><div class="line">PING ldap1.spinlock.hr (192.168.7.12) 56(84) bytes of data.</div><div class="line">....</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="2-OpenLDAP"><a href="#2-OpenLDAP" class="headerlink" title="2. OpenLDAP"></a>2. OpenLDAP</h2><h4 id="2-1-server安装"><a href="#2-1-server安装" class="headerlink" title="2.1 server安装"></a>2.1 server安装</h4><p>openLDAP的server叫做slapd。</p>
<blockquote>
<p>sudo apt-get install slapd ladp-tuils</p>
</blockquote>
<p>Debconf如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Omit OpenLDAP server configuration? No</div><div class="line"></div><div class="line">DNS domain name: spinlock.hr</div><div class="line"></div><div class="line">Organization name? spinlock.hr</div><div class="line"></div><div class="line">Administrator password: PASSWORD</div><div class="line"></div><div class="line">Confirm password: PASSWORD</div><div class="line"></div><div class="line">Database backend to use: HDB</div><div class="line"></div><div class="line">Do you want the database to be removed when slapd is purged? No</div><div class="line"></div><div class="line">Allow LDAPv2 protocol? No</div></pre></td></tr></table></figure></p>
<p>安装完成后slapd会自动启动。</p>
<h6 id="2-1-1初始配置"><a href="#2-1-1初始配置" class="headerlink" title="2.1.1初始配置"></a>2.1.1初始配置</h6><p>server端的配置主要包含ObjectClasses、attribute、syntax、matching rules以及其他的LDAP数据结构的细节。配置文件目录是/etc/ldap/slapd.d/，每次启动的时候都会加载这些配置文件。</p>
<p>这些配置文件是以LDIF的形式保存的，预期是想使用标准的LDAP数据修改工具进行修改，然后slapd就会把新的配置存储在LDIF文件中，以保证下次重启生效。其实手动修改也是可以的。这种只能在运行时修改配置的方式叫做olc(on-line configuration)，也叫cn=config以及slapd.d。</p>
<p>以前版本的openLDAP是使用标准的txt配置文件/etc/ladp/slapd.conf，虽然目前也还是支持的，但是并不推荐使用这个文件。因为修改之后需要重启才能生效，cn=config是当前默认的方式。</p>
<p><strong><em>注意</em></strong></p>
<p>如果你的系统上游/etc/ldap/slapd.conf文件，但是没有/etc/ldap/slapd.d目录的话，运行以下命令：</p>
<blockquote>
<p>sudo slaptest -f /etc/ldap/slapd.conf -F /etc/ldap/slapd.d</p>
</blockquote>
<p>然后确认你的slapd是使用-F /etc/ldap/slapd.d启动的，而不是-f /etc/ldap/slapd.conf</p>
<blockquote>
<p>grep -e -F /etc/init.d/slapd<br>ps aux | grep slapd</p>
</blockquote>
<h6 id="2-1-1-1-CN-CONFIG配置"><a href="#2-1-1-1-CN-CONFIG配置" class="headerlink" title="2.1.1.1 CN=CONFIG配置"></a>2.1.1.1 CN=CONFIG配置</h6><p>cn=config是一个特殊的LDAP数据库，它保存着OpenLDAP server的配置，运行时可读可写。对它的修改直接影响当前运行的server，也会修改/etc/ldap/slapd.d/下对应的配置文件。</p>
<p>修改配置的时候我们需要利用已经存在的默认的cn=config配置，能让本地root用户连接到/var/run/slapd/ldapi的slapd socket修改cn=config数据库。</p>
<p>有了这个途径，我们先验证一下所有的LDAP schema定义(core,cosine,nis,inetorgperson)都已经加载成功。<br>在这一步出现重复entry问题的话不要紧张，目的在于知道我们的client以local user的身份验证身份，然后连接到slapd socket “-Y EXTERNAL -H ldapi:///“:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo ldapadd -c -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/core.ldif</div><div class="line">sudo ldapadd -c -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/cosine.ldif</div><div class="line">sudo ldapadd -c -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/nis.ldif</div><div class="line">sudo ldapadd -c -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/inetorgperson.ldif</div></pre></td></tr></table></figure></p>
<p>然后我们把默认的olcLogLevel: none替换成olcLogLevel: 256:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">echo &quot;dn: cn=config</div><div class="line">changetype: modify</div><div class="line">replace: olcLogLevel</div><div class="line">olcLogLevel: 256&quot; &gt; /var/tmp/loglevel.ldif</div><div class="line"></div><div class="line">sudo ldapmodify -Y EXTERNAL -H ldapi:/// -f /var/tmp/loglevel.ldif</div></pre></td></tr></table></figure></p>
<p>然后为attribute uid添加索引”eq”:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">echo &quot;</div><div class="line">dn: olcDatabase=&#123;1&#125;hdb,cn=config</div><div class="line">changetype: modify</div><div class="line">add: olcDbIndex</div><div class="line">olcDbIndex: uid eq</div><div class="line">&quot; &gt; /var/tmp/uid_eq.ldif</div><div class="line"></div><div class="line">sudo ldapmodify -Y EXTERNAL -H ldapi:/// -f /var/tmp/uid_eq.ldif</div></pre></td></tr></table></figure></p>
<p>最后，以同样的方式允许LDAP管理员用户对于cn=config可读可写，dc=spinlock,dc=hr数据树就也可写了。只要用户知道正确的管理员DN和密码，就可以很方便快捷地修改slapd的配置。使用图形化的LDAP client来查看和修改配置对于初学者来说会更好上手一些：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">echo &quot;dn: olcDatabase=&#123;0&#125;config,cn=config</div><div class="line">changetype: modify</div><div class="line">add: olcAccess</div><div class="line">olcAccess: to * by dn=&quot;cn=admin,dc=spinlock,dc=hr&quot; write&quot; &gt; /var/tmp/access.ldif</div><div class="line"></div><div class="line">sudo ldapmodify -c -Y EXTERNAL -H ldapi:/// -f /var/tmp/access.ldif</div></pre></td></tr></table></figure></p>
<h6 id="2-1-1-2-spapd-conf配置【失效】"><a href="#2-1-1-2-spapd-conf配置【失效】" class="headerlink" title="2.1.1.2 spapd.conf配置【失效】"></a>2.1.1.2 spapd.conf配置【失效】</h6><h6 id="2-1-1-3-client端配置"><a href="#2-1-1-3-client端配置" class="headerlink" title="2.1.1.3 client端配置"></a>2.1.1.3 client端配置</h6><p>server已经可以运行了。下面配置所有LDAP client的配置文件 /etc/ldap/ldap.conf。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">BASE  dc=spinlock, dc=hr </div><div class="line">URI ldap://192.168.7.12/</div></pre></td></tr></table></figure></p>
<h4 id="2-1-2-initial-test-初始测试"><a href="#2-1-2-initial-test-初始测试" class="headerlink" title="2.1.2 initial test 初始测试"></a>2.1.2 initial test 初始测试</h4><p>可以测试一下我们安装的成果了。我们的openLDAP server只包含基本的读取操作。从LDAP的角度来看，读取操作被成为search。要使用命令行工具执行search，我们需要安装ldapsearch和slapcat。</p>
<p>ldapsearch使用LDAP协议执行在线操作。</p>
<p>SLAPCAT执行离线操作，直接修改本地文件系统里的文件。因此，这些命令只能在openLDAP server的本机执行，而且还需要特殊权限。向数据库写数据之前，需要先停掉openLDAP server。</p>
<p>在以上两个命令的输出中，一会注意到有两个LDAP entry，一个代表树的top节点，另一个代表LDAP 管理员的entry。在slapcat的输出中，不会像ldapsearch一样把额外的attributes打印出来。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">ldapsearch -x</div><div class="line"></div><div class="line"># extended LDIF</div><div class="line">#</div><div class="line"># LDAPv3</div><div class="line"># base &lt;dc=spinlock, dc=hr&gt; (default) with scope subtree</div><div class="line"># filter: (objectclass=*)</div><div class="line"># requesting: ALL</div><div class="line">#</div><div class="line"></div><div class="line"># spinlock.hr</div><div class="line">dn: dc=spinlock,dc=hr</div><div class="line">objectClass: top</div><div class="line">objectClass: dcObject</div><div class="line">objectClass: organization</div><div class="line">o: spinlock.hr</div><div class="line">dc: spinlock</div><div class="line"></div><div class="line"># admin, spinlock.hr</div><div class="line">dn: cn=admin,dc=spinlock,dc=hr</div><div class="line">objectClass: simpleSecurityObject</div><div class="line">objectClass: organizationalRole</div><div class="line">cn: admin</div><div class="line">description: LDAP administrator</div><div class="line"></div><div class="line"># search result</div><div class="line">search: 2</div><div class="line">result: 0 Success</div><div class="line"></div><div class="line"># numResponses: 3</div><div class="line"># numEntries: 2</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">sudo slapcat</div><div class="line"></div><div class="line">dn: dc=spinlock,dc=hr</div><div class="line">objectClass: top</div><div class="line">objectClass: dcObject</div><div class="line">objectClass: organization</div><div class="line">o: spinlock.hr</div><div class="line">dc: spinlock</div><div class="line">structuralObjectClass: organization</div><div class="line">entryUUID: 350a2db6-87d3-102c-8c1c-1ffeac40db98</div><div class="line">creatorsName:</div><div class="line">modifiersName:</div><div class="line">createTimestamp: 20080316183324Z</div><div class="line">modifyTimestamp: 20080316183324Z</div><div class="line">entryCSN: 20080316183324.797498Z#000000#000#000000</div><div class="line"></div><div class="line">dn: cn=admin,dc=spinlock,dc=hr</div><div class="line">objectClass: simpleSecurityObject</div><div class="line">objectClass: organizationalRole</div><div class="line">cn: admin</div><div class="line">description: LDAP administrator</div><div class="line">userPassword:: e2NyeXB0fVdSZDJjRFdRODluNHM=</div><div class="line">structuralObjectClass: organizationalRole</div><div class="line">entryUUID: 350b330a-87d3-102c-8c1d-1ffeac40db98</div><div class="line">creatorsName:</div><div class="line">modifiersName:</div><div class="line">createTimestamp: 20080316183324Z</div><div class="line">modifyTimestamp: 20080316183324Z</div></pre></td></tr></table></figure>
<h4 id="创建基本树结构"><a href="#创建基本树结构" class="headerlink" title="创建基本树结构"></a>创建基本树结构</h4>]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[azkaban源码追踪(1)-——-上传zip文件]]></title>
      <url>/2016/12/05/azkaban%E6%BA%90%E7%A0%81%E8%BF%BD%E8%B8%AA(1)-%E2%80%94%E2%80%94-%E4%B8%8A%E4%BC%A0zip%E6%96%87%E4%BB%B6/</url>
      <content type="html"><![CDATA[<h4 id="相关类"><a href="#相关类" class="headerlink" title="相关类"></a>相关类</h4><ul>
<li>ProjectMangerServlet</li>
<li>ProjectManager</li>
<li>ValidatorManager</li>
<li>DirectoryFlowLoader</li>
<li>JdbcProjectLoader</li>
</ul>
<h4 id="对应的流程log"><a href="#对应的流程log" class="headerlink" title="对应的流程log"></a>对应的流程log</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">2016/06/14 15:39:18.537 +0800 INFO [ProjectManagerServlet] [Azkaban] Uploading file willjob.zip</div><div class="line">2016/06/14 15:39:23.861 +0800 INFO [ProjectManager] [Azkaban] Uploading files to mytestProject</div><div class="line">2016/06/14 15:40:16.454 +0800 WARN [XmlValidatorManager] [Azkaban] Validator directory validators does not exist or is not a directory</div><div class="line">2016/06/14 15:40:16.455 +0800 WARN [XmlValidatorManager] [Azkaban] Azkaban properties file does not contain the key project.validators</div><div class="line">2016/06/14 15:40:35.752 +0800 INFO [ProjectManager] [Azkaban] Validating project willjob.zip using the registered validators [Director</div><div class="line">2016/06/14 16:11:45.952 +0800 INFO [XmlValidatorManager] [Azkaban] Validation status of validator Directory Flow is PASS</div><div class="line">2016/06/14 16:56:51.338 +0800 INFO [ProjectManager] [Azkaban] Uploading file to db willjob.zip</div><div class="line">2016/06/14 16:56:51.338 +0800 INFO [JdbcProjectLoader] [Azkaban] Uploading to mytestProject version:1 file:willjob.zip</div><div class="line">2016/06/14 16:56:51.341 +0800 INFO [JdbcProjectLoader] [Azkaban] Creating message digest for upload willjob.zip</div><div class="line">2016/06/14 16:56:51.343 +0800 INFO [JdbcProjectLoader] [Azkaban] Md5 hash created</div><div class="line">2016/06/14 16:56:51.359 +0800 INFO [JdbcProjectLoader] [Azkaban] Read bytes for willjob.zip size:560</div><div class="line">2016/06/14 16:56:51.359 +0800 INFO [JdbcProjectLoader] [Azkaban] Running update for willjob.zip chunk 0</div><div class="line">2016/06/14 16:56:51.360 +0800 INFO [JdbcProjectLoader] [Azkaban] Finished update for willjob.zip chunk 0</div><div class="line">2016/06/14 16:56:51.362 +0800 INFO [JdbcProjectLoader] [Azkaban] Commiting upload willjob.zip</div><div class="line">2016/06/14 16:56:51.363 +0800 INFO [ProjectManager] [Azkaban] Uploading flow to db willjob.zip</div><div class="line">2016/06/14 16:56:51.363 +0800 INFO [JdbcProjectLoader] [Azkaban] Uploading flows</div><div class="line">2016/06/14 16:56:51.418 +0800 INFO [JdbcProjectLoader] [Azkaban] Flow upload will3 is byte size 214</div><div class="line">2016/06/14 16:56:51.432 +0800 INFO [JdbcProjectLoader] [Azkaban] Flow upload will2 is byte size 238</div><div class="line">2016/06/14 16:56:51.434 +0800 INFO [ProjectManager] [Azkaban] Changing project versions willjob.zip</div><div class="line">2016/06/14 16:56:51.436 +0800 INFO [ProjectManager] [Azkaban] Uploading Job properties</div><div class="line">2016/06/14 16:56:51.820 +0800 INFO [ProjectManager] [Azkaban] Uploading Props properties</div><div class="line">2016/06/14 16:56:51.822 +0800 INFO [ProjectManager] [Azkaban] Uploaded project files. Cleaning up temp files.</div><div class="line">2016/06/14 16:56:51.927 +0800 INFO [ProjectManager] [Azkaban] Cleaning up old install files older than -2</div></pre></td></tr></table></figure>
<h4 id="ProjectManager"><a href="#ProjectManager" class="headerlink" title="ProjectManager"></a>ProjectManager</h4><p>白话一下ProjectManager处理上传zip文件的过程：</p>
<ol>
<li>将文件存到/tmp目录并解压</li>
<li>使用DirectoryFlowLoader解析文件，放置到这个loader的状态变量中。这些变量会一直保存在内存里，以供后面使用</li>
<li>遍历loader里的flowMap，把每个flow都加上最新的project_id和version</li>
<li>上传project信息<ul>
<li>4.1 把zip文件弄成字节流上传到mysql的project_files表中</li>
<li>4.2 把最新版本的project信息上传到project_versions表中</li>
</ul>
</li>
<li>上传flow: 把flow逐个序列化成json，再弄成byte字节流，再使用gzip压缩，上传至project_flows表中</li>
<li>更新projects里的相关记录，并修改内存中的project信息【修改时间等、最新版本的flows】</li>
<li>上传job的详细信息到project_properties中，job的详细信息也是json-&gt;byte[]-&gt;gzip的过程</li>
<li>上传props的详细信息到project_properties中，流程同job完全一样【这个debug的时候数据是空的】</li>
<li>将此次操作插入到project_event中，之后删除本地/tmp下的文件</li>
<li>使用project_id和当前version判断依次清除先前版本的project_flows的flow、project_properties、project_files、project_versions中的记录【会有最近版本保留数量设置project.version.retention，默认是3】</li>
<li>完成</li>
</ol>
<h4 id="文件解析"><a href="#文件解析" class="headerlink" title="文件解析"></a>文件解析</h4><p>DirectoryFlowLoader加载文件目录，解析所有的文件，进行解析，将信息存放在自己的状态变量中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Props props;                          <span class="comment">// 环境、配置信息</span></div><div class="line"><span class="keyword">private</span> HashSet&lt;String&gt; rootNodes;            <span class="comment">// 根节点，也就是实际执行的时候的起始节点</span></div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Flow&gt; flowMap;        <span class="comment">// 所有的flow，key是flowId</span></div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Node&gt; nodeMap;        <span class="comment">// 所有的node，key是JobId或者embed的flowId</span></div><div class="line"><span class="comment">// node之间的dependency，key是job名称，value是一系列的相关依赖job，一般是children，然后Edge指定从谁到谁</span></div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Map&lt;String, Edge&gt;&gt; nodeDependencies;  </div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Props&gt; jobPropsMap;   <span class="comment">// 包含job的详细信息</span></div><div class="line"></div><div class="line"><span class="comment">// flow之间的依赖关系【embedeed flow】</span></div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Set&lt;String&gt;&gt; flowDependencies;</div><div class="line"></div><div class="line"><span class="keyword">private</span> ArrayList&lt;FlowProps&gt; flowPropsList;</div><div class="line"><span class="keyword">private</span> ArrayList&lt;Props&gt; propsList;</div><div class="line"><span class="keyword">private</span> Set&lt;String&gt; errors;</div><div class="line"><span class="keyword">private</span> Set&lt;String&gt; duplicateJobs;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 临时解压目录 baseDirectory : temp/46769225</span></div><div class="line"><span class="comment">// 项目信息 project: testPro</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadProjectFlow</span><span class="params">(Project project, File baseDirectory)</span> </span>&#123;</div><div class="line">    propsList = <span class="keyword">new</span> ArrayList&lt;Props&gt;();</div><div class="line">    flowPropsList = <span class="keyword">new</span> ArrayList&lt;FlowProps&gt;();</div><div class="line">    jobPropsMap = <span class="keyword">new</span> HashMap&lt;String, Props&gt;();</div><div class="line">    nodeMap = <span class="keyword">new</span> HashMap&lt;String, Node&gt;();</div><div class="line">    flowMap = <span class="keyword">new</span> HashMap&lt;String, Flow&gt;();</div><div class="line">    errors = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">    duplicateJobs = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">    nodeDependencies = <span class="keyword">new</span> HashMap&lt;String, Map&lt;String, Edge&gt;&gt;();</div><div class="line">    rootNodes = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">    flowDependencies = <span class="keyword">new</span> HashMap&lt;String, Set&lt;String&gt;&gt;();</div><div class="line"></div><div class="line">    <span class="comment">// 加载所有的properties、job文件，创建node对象</span></div><div class="line">    loadProjectFromDir(baseDirectory.getPath(), baseDirectory, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    jobPropertiesCheck(project);</div><div class="line"></div><div class="line">    <span class="comment">// Create edges and find missing dependencies</span></div><div class="line">    resolveDependencies();</div><div class="line"></div><div class="line">    <span class="comment">// 创建flows. 在此之后flowMap里就已经构建好了flow以及job之间的依赖了，node之间通过level来界定先后关系</span></div><div class="line">    buildFlowsFromDependencies();</div><div class="line"></div><div class="line">    <span class="comment">// 处理embedded flows，就是嵌入的flow</span></div><div class="line">    resolveEmbeddedFlows();</div><div class="line"></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h5 id="loadProjectFromDir方法详细"><a href="#loadProjectFromDir方法详细" class="headerlink" title="loadProjectFromDir方法详细"></a>loadProjectFromDir方法详细</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadProjectFromDir</span><span class="params">(String base, File dir, Props parent)</span> </span>&#123;</div><div class="line">  <span class="comment">// 找出所有的properties</span></div><div class="line">  File[] propertyFiles = dir.listFiles(<span class="keyword">new</span> SuffixFilter(PROPERTY_SUFFIX));</div><div class="line">  Arrays.sort(propertyFiles);</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (File file : propertyFiles) &#123;</div><div class="line">      String relative = getRelativeFilePath(base, file.getPath());</div><div class="line">      parent = <span class="keyword">new</span> Props(parent, file);</div><div class="line">      parent.setSource(relative);</div><div class="line">      FlowProps flowProps = <span class="keyword">new</span> FlowProps(parent);</div><div class="line">      flowPropsList.add(flowProps);</div><div class="line">      logger.info(<span class="string">"Adding "</span> + relative);</div><div class="line">      propsList.add(parent);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 加载job文件</span></div><div class="line">  File[] jobFiles = dir.listFiles(<span class="keyword">new</span> SuffixFilter(JOB_SUFFIX));</div><div class="line">  <span class="keyword">for</span> (File file : jobFiles) &#123;</div><div class="line">    String jobName = getNameWithoutExtension(file);</div><div class="line">      <span class="keyword">if</span> (!duplicateJobs.contains(jobName)) &#123;</div><div class="line">        <span class="keyword">if</span> (jobPropsMap.containsKey(jobName)) &#123;</div><div class="line">          <span class="comment">// 是否有重复</span></div><div class="line">          ... </div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          Props prop = <span class="keyword">new</span> Props(parent, file);</div><div class="line">          String relative = getRelativeFilePath(base, file.getPath());</div><div class="line">          prop.setSource(relative);</div><div class="line"></div><div class="line">          Node node = <span class="keyword">new</span> Node(jobName);</div><div class="line">          String type = prop.getString(<span class="string">"type"</span>, <span class="keyword">null</span>);</div><div class="line">          <span class="keyword">if</span> (type == <span class="keyword">null</span>) &#123;</div><div class="line">            errors.add(<span class="string">"Job doesn't have type set '"</span> + jobName + <span class="string">"'."</span>);</div><div class="line">          &#125;</div><div class="line">          node.setType(type); <span class="comment">// job类型</span></div><div class="line">          node.setJobSource(relative);    <span class="comment">// job相对路径</span></div><div class="line">          <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</div><div class="line">            node.setPropsSource(parent.getSource());</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="comment">// Force root node</span></div><div class="line">          <span class="keyword">if</span> (prop.getBoolean(CommonJobProperties.ROOT_NODE, <span class="keyword">false</span>)) &#123;</div><div class="line">            rootNodes.add(jobName);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="comment">// 把properties和node放进loader中的队列中</span></div><div class="line">          jobPropsMap.put(jobName, prop);</div><div class="line">          nodeMap.put(jobName, node);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 检查是否有子目录</span></div><div class="line">  File[] subDirs = dir.listFiles(DIR_FILTER);</div><div class="line">  <span class="keyword">for</span> (File file : subDirs) &#123;</div><div class="line">    loadProjectFromDir(base, file, parent);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="常用的blob处理代码"><a href="#常用的blob处理代码" class="headerlink" title="常用的blob处理代码"></a>常用的blob处理代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">String propertyJSON = PropsUtils.toJSONString(props, <span class="keyword">true</span>);</div><div class="line">   <span class="keyword">byte</span>[] data = propertyJSON.getBytes(<span class="string">"UTF-8"</span>);</div><div class="line">   <span class="keyword">if</span> (defaultEncodingType == EncodingType.GZIP) &#123;</div><div class="line">     data = GZIPUtils.gzipBytes(data);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p><img src="C:\Users\will\Pictures\azkaban上传project时的node结构.png" alt="Node结构"></p>
<p>level表示当前node所在的层次。</p>
<p><img src="C:\Users\will\Pictures\Edge数据结构.png" alt="Edge结构"></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[celery上手]]></title>
      <url>/2016/12/05/celery%E4%B8%8A%E6%89%8B/</url>
      <content type="html"><![CDATA[<p>首先我们需要有一个celery实例，也就是celery app。有了这个实例我们才能创建task、管理worker，只需要把这个实例作为moduel import进来就可以了。</p>
<p>创建实例，并创建task：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</div><div class="line"></div><div class="line">app = Celery(<span class="string">'tasks'</span>, broker=<span class="string">'amqp://guest@localhost//'</span>)</div><div class="line"></div><div class="line"><span class="meta">@app.task</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></div><div class="line">    <span class="keyword">return</span> x + y</div></pre></td></tr></table></figure></p>
<p>启动worker：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">celery -A tasks worker --loglevel=info</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">-------------- celery@halcyon.local v3.1 (Cipater)</div><div class="line">---- **** -----</div><div class="line">--- * ***  * -- [Configuration]</div><div class="line">-- * - **** --- . broker:      amqp://guest@localhost:5672//</div><div class="line">- ** ---------- . app:         __main__:0x1012d8590</div><div class="line">- ** ---------- . concurrency: 8 (processes)</div><div class="line">- ** ---------- . events:      OFF (enable -E to monitor this worker)</div><div class="line">- ** ----------</div><div class="line">- *** --- * --- [Queues]</div><div class="line">-- ******* ---- . celery:      exchange:celery(direct) binding:celery</div><div class="line">--- ***** -----</div><div class="line"></div><div class="line">[2012-06-08 16:23:51,078: WARNING/MainProcess] celery@halcyon.local has started.</div></pre></td></tr></table></figure>
<ul>
<li>concurrency 是worker进程的并发数据，默认是cpu个数。需要视情况而定，cpu密集型的就少一些，IO密集型的就多一些。除了默认的prefork 池，celery还支持eventlet、gevent以及threads。</li>
<li>event。 启用后celery就发送这个worker里的监控event。这可以被celery events、flower使用。</li>
<li>queue。代表这个worker会消费的队列。</li>
</ul>
<p>调用task：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> tasks <span class="keyword">import</span> add</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>add.delay(<span class="number">4</span>, <span class="number">4</span>)</div></pre></td></tr></table></figure></p>
<p>使用delay()方法调用task，它是apply_async()方法的简写。然后我们可以去worker的console观察任务执行了。</p>
<p>调用task放回的对象是AsyncResult实例，它可以用来获取当前task的状态，等待task结束后，获取task的返回值。默认是没有启用的，要使用的话需要给celery配置一个result backend。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app = Celery(<span class="string">'tasks'</span>, backend=<span class="string">'redis://localhost'</span>, broker=<span class="string">'amqp://'</span>)</div></pre></td></tr></table></figure>
<p>这里是使用redis作为task状态和结果的存储介质。再次调用<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>result = add.delay(<span class="number">4</span>, <span class="number">4</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>result.ready()</div><div class="line"><span class="keyword">False</span></div><div class="line"><span class="comment"># 一般并不会直接获取这个结果，这样就把异步调用弄成同步调用一样了</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>result.get(timeout=<span class="number">1</span>)</div><div class="line"><span class="number">8</span></div><div class="line"><span class="comment">## 当出现异常的时候，get方法默认也会抛出这个异常，可以使用propagate来阻止</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>result.get(propagate=<span class="keyword">False</span>)</div><div class="line"><span class="comment">## 获取异常堆栈</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>result.traceback</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>res.failed()</div><div class="line"><span class="keyword">True</span></div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>res.successful()</div><div class="line"><span class="keyword">False</span></div><div class="line"><span class="comment"># 一个task的典型status历程：PENDING -&gt; STARTED -&gt; SUCCESS</span></div><div class="line"><span class="comment"># 重试的task：PENDING -&gt; STARTED -&gt; RETRY -&gt; STARTED -&gt; RETRY -&gt; STARTED -&gt; SUCCESS</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>res.state</div><div class="line"><span class="string">'FAILURE'</span></div></pre></td></tr></table></figure></p>
<p>要使配置马上生效的话，可以调用update方法<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">app.conf.update(</div><div class="line">    CELERY_TASK_SERIALIZER=<span class="string">'json'</span>,</div><div class="line">    CELERY_ACCEPT_CONTENT=[<span class="string">'json'</span>],  <span class="comment"># Ignore other content</span></div><div class="line">    CELERY_RESULT_SERIALIZER=<span class="string">'json'</span>,</div><div class="line">    CELERY_TIMEZONE=<span class="string">'Europe/Oslo'</span>,</div><div class="line">    CELERY_ENABLE_UTC=<span class="keyword">True</span>,</div><div class="line">)</div></pre></td></tr></table></figure></p>
<p>要是大型项目，弄一个特定的配置module比较好。最好不要硬编码周期任务和task路由，把这些放在一个集中的位置，方便控制。比如系统管理员在系统故障的时候做一些简单的微调什么的。</p>
<p>使用<code>app.config_from_object()</code>方法，使celery实例使用一个配置module。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app.config_from_object(<span class="string">'celeryconfig'</span>)</div></pre></td></tr></table></figure></p>
<p>celeryconfig.py:<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">BROKER_URL = <span class="string">'amqp://'</span></div><div class="line">CELERY_RESULT_BACKEND = <span class="string">'rpc://'</span></div><div class="line"></div><div class="line">CELERY_TASK_SERIALIZER = <span class="string">'json'</span></div><div class="line">CELERY_RESULT_SERIALIZER = <span class="string">'json'</span></div><div class="line">CELERY_ACCEPT_CONTENT=[<span class="string">'json'</span>]</div><div class="line">CELERY_TIMEZONE = <span class="string">'Europe/Oslo'</span></div><div class="line">CELERY_ENABLE_UTC = <span class="keyword">True</span></div></pre></td></tr></table></figure></p>
<p>注意，这个module应该可以import到才对。配置文件中可以指定路由、注解等很多东西。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">CELERY_ANNOTATIONS = &#123;</div><div class="line">    <span class="string">'tasks.add'</span>: &#123;<span class="string">'rate_limit'</span>: <span class="string">'10/m'</span>&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">CELERY_ROUTES = &#123;</div><div class="line">    <span class="string">'tasks.add'</span>: <span class="string">'low-priority'</span>,</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>要是使用rabbitMQ或者Redis作为broker的话，还可以直接通过命令进行配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">celery -A tasks control rate_limit tasks.add 10/m</div></pre></td></tr></table></figure></p>
<hr>
<h2 id="实际使用celery"><a href="#实际使用celery" class="headerlink" title="实际使用celery"></a>实际使用celery</h2><p>项目结构：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">proj/__init__.py</div><div class="line">    /celery.py</div><div class="line">    /tasks.py</div></pre></td></tr></table></figure></p>
<p>celery.py文件内容：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</div><div class="line"></div><div class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</div><div class="line"></div><div class="line">app = Celery(<span class="string">'proj'</span>,</div><div class="line">             broker=<span class="string">'amqp://'</span>,</div><div class="line">             backend=<span class="string">'amqp://'</span>,</div><div class="line">             include=[<span class="string">'proj.tasks'</span>])</div><div class="line"></div><div class="line"><span class="comment"># Optional configuration, see the application user guide.</span></div><div class="line">app.conf.update(</div><div class="line">    CELERY_TASK_RESULT_EXPIRES=<span class="number">3600</span>,</div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    app.start()</div></pre></td></tr></table></figure></p>
<p>在celery中可以创建自己的实例，然后在其他地方import这个实例就可以使用了。</p>
<p>注意一下include，应该把自定义的task的module填写进来，这样celery实例启动的时候就会加载这些module。</p>
<p>我们的proj/tasks.py：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</div><div class="line"></div><div class="line"><span class="keyword">from</span> proj.celery <span class="keyword">import</span> app</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@app.task</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></div><div class="line">    <span class="keyword">return</span> x + y</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@app.task</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">mul</span><span class="params">(x, y)</span>:</span></div><div class="line">    <span class="keyword">return</span> x * y</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@app.task</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">xsum</span><span class="params">(numbers)</span>:</span></div><div class="line">    <span class="keyword">return</span> sum(numbers)</div></pre></td></tr></table></figure></p>
<p>启动后要停掉worker的话，只需要直接ctrl + c就可以了。</p>
<p>生产环境中需要以守护进程的形式启动worker，使用<code>celery multi</code>任务就可以了，它可以启动一个或多个worker。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">celery multi start w1 -A proj -l info</div><div class="line">celery multi v3.1.1 (Cipater)</div><div class="line">&gt; Starting nodes...</div><div class="line">    &gt; w1.halcyon.local: OK</div><div class="line"></div><div class="line">$ celery  multi restart w1 -A proj -l info</div><div class="line">celery multi v3.1.1 (Cipater)</div><div class="line">&gt; Stopping nodes...</div><div class="line">    &gt; w1.halcyon.local: TERM -&gt; 64024</div><div class="line">&gt; Waiting for 1 node.....</div><div class="line">    &gt; w1.halcyon.local: OK</div><div class="line">&gt; Restarting node w1.halcyon.local: OK</div><div class="line">celery multi v3.1.1 (Cipater)</div><div class="line">&gt; Stopping nodes...</div><div class="line">    &gt; w1.halcyon.local: TERM -&gt; 64052</div><div class="line">    </div><div class="line">celery multi stop w1 -A proj -l info</div></pre></td></tr></table></figure>
<p>stop命令是异步的，这样就不用hang，等着worker停止了。为了我保证所有的task能够完成，也可以使用stopwait方法。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">celery multi stopwait w1 -A proj -l info</div></pre></td></tr></table></figure></p>
<p>下面是加上指定pid，和log的启动命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ mkdir -p /var/run/celery</div><div class="line">$ mkdir -p /var/log/celery</div><div class="line">$ celery multi start w1 -A proj -l info --pidfile=/var/run/celery/%n.pid \</div><div class="line">                                        --logfile=/var/log/celery/%n%I.log</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">celery multi start 10 -A proj -l info -Q:1-3 images,video -Q:4,5 data \</div><div class="line">   -Q default -L:4,5 debug</div></pre></td></tr></table></figure>
<h4 id="Canvas：工作流"><a href="#Canvas：工作流" class="headerlink" title="Canvas：工作流"></a>Canvas：工作流</h4><p>使用subtask搞定，它封装了单个task的参数，可以传递给后面的方法。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>add.subtask((<span class="number">2</span>, <span class="number">2</span>), countdown=<span class="number">10</span>)</div><div class="line">tasks.add(<span class="number">2</span>, <span class="number">2</span>)</div></pre></td></tr></table></figure>
<p>可以替换为:<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>add.s(<span class="number">2</span>, <span class="number">2</span>)</div><div class="line">tasks.add(<span class="number">2</span>, <span class="number">2</span>)</div></pre></td></tr></table></figure></p>
<p>比较牛逼的地方在于，他竟然可以定义偏函数<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>s1 = add.s(<span class="number">2</span>, <span class="number">2</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>res = s1.delay()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>res.get()</div><div class="line"><span class="number">4</span></div><div class="line"></div><div class="line"><span class="comment"># 空的是前面的参数，后面的是2</span></div><div class="line"><span class="comment"># incomplete partial: add(?, 2)</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>s2 = add.s(<span class="number">2</span>)</div><div class="line"></div><div class="line"><span class="comment"># resolves the partial: add(8, 2)</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>res = s2.delay(<span class="number">8</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>res.get()</div><div class="line"><span class="number">10</span></div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>s3 = add.s(<span class="number">2</span>, <span class="number">2</span>, debug=<span class="keyword">True</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>s3.delay(debug=<span class="keyword">False</span>)   <span class="comment"># debug is now False.</span></div></pre></td></tr></table></figure></p>
<h4 id="primitive"><a href="#primitive" class="headerlink" title="primitive"></a>primitive</h4><ul>
<li>group</li>
<li>map</li>
<li>chain</li>
<li>starmap</li>
<li>chord</li>
<li>chunks<br>这些primitive本身就是subtask，所以它们可以组合成工作流。</li>
</ul>
<h6 id="groups"><a href="#groups" class="headerlink" title="groups"></a>groups</h6><p>group并行调用多个task，返回一串结果。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> celery <span class="keyword">import</span> group</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> proj.tasks <span class="keyword">import</span> add</div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>group(add.s(i, i) <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">10</span>))().get()</div><div class="line">[<span class="number">0</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">12</span>, <span class="number">14</span>, <span class="number">16</span>, <span class="number">18</span>]</div></pre></td></tr></table></figure></p>
<p>结合偏函数使用group：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>g = group(add.s(i) <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">10</span>))</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>g(<span class="number">10</span>).get()</div><div class="line">[<span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>]</div></pre></td></tr></table></figure></p>
<h6 id="chain"><a href="#chain" class="headerlink" title="chain"></a>chain</h6><p>有序调用一系列task<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> celery <span class="keyword">import</span> chain</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> proj.tasks <span class="keyword">import</span> add, mul</div><div class="line"></div><div class="line"><span class="comment"># (4 + 4) * 8</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>chain(add.s(<span class="number">4</span>, <span class="number">4</span>) | mul.s(<span class="number">8</span>))().get()</div><div class="line"><span class="number">64</span></div></pre></td></tr></table></figure></p>
<p>偏函数：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># (? + 4) * 8</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>g = chain(add.s(<span class="number">4</span>) | mul.s(<span class="number">8</span>))</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>g(<span class="number">4</span>).get()</div><div class="line"><span class="number">64</span></div></pre></td></tr></table></figure></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>(add.s(<span class="number">4</span>, <span class="number">4</span>) | mul.s(<span class="number">8</span>))().get()</div><div class="line"><span class="number">64</span></div></pre></td></tr></table></figure>
<h6 id="chord"><a href="#chord" class="headerlink" title="chord"></a>chord</h6><p>带有一个回调函数的一组task。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> celery <span class="keyword">import</span> chord</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> proj.tasks <span class="keyword">import</span> add, xsum</div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>chord((add.s(i, i) <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">10</span>)), xsum.s())().get()</div><div class="line"><span class="number">90</span></div></pre></td></tr></table></figure></p>
<p>被chain到其他task的group自动转为chord：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>(group(add.s(i, i) <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">10</span>)) | xsum.s())().get()</div><div class="line"><span class="number">90</span></div></pre></td></tr></table></figure></p>
<p>结合多种subtask使用：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>upload_document.s(file) | group(apply_filter.s() <span class="keyword">for</span> filter <span class="keyword">in</span> filters)</div></pre></td></tr></table></figure></p>
<h4 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h4><p>主要是针对consumer/worker和producer各自的队列</p>
<h4 id="远程控制"><a href="#远程控制" class="headerlink" title="远程控制"></a>远程控制</h4><p>使用RabbitMQ、或者Redis作为broker的话可以在运行时控制与查看worker的状态。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ celery -A proj inspect active</div></pre></td></tr></table></figure></p>
<p>这是查看当前正在运行的task。</p>
<p>参考：</p>
<ul>
<li><a href="http://docs.celeryproject.org/en/latest/getting-started/first-steps-with-celery.html" target="_blank" rel="external">http://docs.celeryproject.org/en/latest/getting-started/first-steps-with-celery.html</a></li>
<li><a href="http://docs.celeryproject.org/en/latest/getting-started/next-steps.html" target="_blank" rel="external">http://docs.celeryproject.org/en/latest/getting-started/next-steps.html</a> </li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Ember-data-定制化adapter]]></title>
      <url>/2016/12/05/Ember-data-%E5%AE%9A%E5%88%B6%E5%8C%96adapter/</url>
      <content type="html"><![CDATA[<p>adapter在Ember Data中决定数据怎样被持久化到后端数据存储层。比如处理URL格式、REST API的header等。(数据格式决定于<br><a href="../customizing-serializers/">serializer</a>.)Ember Data的默认adapter有一些内置的假设规范，参看：REST API should look。如果你的后端不满足这些规范，就集成默认的adapter，修改一下它的方法。</p>
<p>一些典型的应用场景是在你的urls中使用<br><code>underscores_case</code> , 使用中介而不是直接使用你后端的server，甚至直接使用<br><a href="https://github.com/locks/ember-localstorage-adapter" target="_blank" rel="external">local storage backend</a>.</p>
<p>继承adapter在Ember Data中是很轻松的过程。</p>
<p>如果你的后端你有一致性要求，你可以定义一个<br><code>adapter:application</code>.  <code>adapter:application</code> 的优先级高于所有其他的默认Adapter, 但是低于model内指定的Adapters.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">import JSONAPIAdapter from &apos;ember-data/adapters/json-api&apos;;</div><div class="line"></div><div class="line">export default JSONAPIAdapter.extend(&#123;</div><div class="line">  // Application specific overrides go here</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>如果你有一个model相对于其他的model在与后台沟通的时候需要额外的规则，那么你就可以创建一个Model指定的<br>Adapter：<code>ember generate adapter adapter-name</code>.<br>例如，运行<code>ember generate adapter post</code> 会创建下面的文件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">import JSONAPIAdapter from &apos;ember-data/adapters/json-api&apos;;</div><div class="line"></div><div class="line">export default JSONAPIAdapter.extend(&#123;</div><div class="line">  namespace: &apos;api/v1&apos;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Ember Data默认有几个内置的adapter。</p>
<ul>
<li><p><a href="http://emberjs.com/api/data/classes/DS.Adapter.html" target="_blank" rel="external">Adapter</a> 是最基础的adapter，不好喊任何功能。如果你要创建一个不同于其他的adapter功能的adapter，通常它是要给不错的起点。</p>
</li>
<li><p><a href="http://emberjs.com/api/data/classes/DS.JSONAPIAdapter.html" target="_blank" rel="external">JSONAPIAdapter</a><br><code>JSONAPIAdapter</code>是遵循默认JSON API规范的adapter，负责通过XHR传递JSON与http server沟通。</p>
</li>
<li><p><a href="http://emberjs.com/api/data/classes/DS.RESTAdapter.html" target="_blank" rel="external">RESTAdapter</a><br><code>RESTAdapter</code> 通过XHR传递JSON允许你的store与http server直接沟通。2.0版本之前，这个是默认的adapter。</p>
</li>
</ul>
<h2 id="定制化JSONAPIAdapter"><a href="#定制化JSONAPIAdapter" class="headerlink" title="定制化JSONAPIAdapter"></a>定制化JSONAPIAdapter</h2><p><a href="http://emberjs.com/api/data/classes/DS.JSONAPIAdapter.html" target="_blank" rel="external">JSONAPIAdapter</a><br>有一些很好用的hooks来适应非标准的后台。</p>
<h3 id="URL规范"><a href="#URL规范" class="headerlink" title="URL规范"></a>URL规范</h3><p><code>JSONAPIAdapter</code>可以通过mode的名字来判断 URLs.比如，如果你通过ID查询<code>Post</code>:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">store.findRecord(<span class="string">'post'</span>, <span class="number">1</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">post</span>) </span>&#123;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>JSON API adapter会自动发送一个<code>GET</code> 请求到<code>/posts/1</code>.</p>
<p>JSON API adapter中的操作与url对应如下:</p>
<table><br>  <thead><br>    <tr><th>Action</th><th>HTTP Verb</th><th>URL</th></tr><br>  </thead><br>  <tbody><br>    <tr><th>Find</th><td>GET</td><td>/posts/123</td></tr><br>    <tr><th>Find All</th><td>GET</td><td>/posts</td></tr><br>    <tr><th>Update</th><td>PATCH</td><td>/posts/123</td></tr><br>    <tr><th>Create</th><td>POST</td><td>/posts</td></tr><br>    <tr><th>Delete</th><td>DELETE</td><td>/posts/123</td></tr><br>  </tbody><br></table>

<h4 id="Pluralization-Customization"><a href="#Pluralization-Customization" class="headerlink" title="Pluralization Customization"></a>Pluralization Customization</h4><p>To facilitate pluralizing model names when generating route urls Ember<br>Data comes bundled with<br><a href="https://github.com/stefanpenner/ember-inflector" target="_blank" rel="external">Ember Inflector</a>, a<br>ActiveSupport::Inflector compatible library for inflecting words<br>between plural and singular forms. Irregular or uncountable<br>pluralizations can be specified via <code>Ember.Inflector.inflector</code>.<br>A common way to do this is<br>（上面的没咋看懂，就是url中处理model负数问题的）<br>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// sets up Ember.Inflector</div><div class="line">import &apos;./models/custom-inflector-rules&apos;;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">import Inflector from &apos;ember-inflector&apos;;</div><div class="line"></div><div class="line">const inflector = Inflector.inflector;</div><div class="line"></div><div class="line">inflector.irregular(&apos;formula&apos;, &apos;formulae&apos;);</div><div class="line">inflector.uncountable(&apos;advice&apos;);</div><div class="line"></div><div class="line">// Meet Ember Inspector&apos;s expectation of an export</div><div class="line">export default &#123;&#125;;</div></pre></td></tr></table></figure>
<p>这告诉JSON API adapter对于<code>formula</code>的请求应该去<code>/formulae/1</code> 而不是 <code>/formulas/1</code>, 对于<code>advice</code>的请求应该去 <code>/advice/1</code> 而不是 <code>/advices/1</code>.</p>
<h4 id="Endpoint-Path-Customization"><a href="#Endpoint-Path-Customization" class="headerlink" title="Endpoint Path Customization"></a>Endpoint Path Customization</h4><p><code>namespace</code> 属性可以作为指定url的前缀.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">import JSONAPIAdapter from &apos;ember-data/adapters/json-api&apos;;</div><div class="line"></div><div class="line">export default JSONAPIAdapter.extend(&#123;</div><div class="line">  namespace: &apos;api/1&apos;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>请求<code>person</code> 被指向 <code>http://emberjs.com/api/1/people/1</code>.</p>
<h4 id="Host-Customization"><a href="#Host-Customization" class="headerlink" title="Host Customization"></a>Host Customization</h4><p>默认adapter会向当前域发送请求。如果要指定新的域名需要设置adapter的<code>host</code>属性。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">import JSONAPIAdapter from &apos;ember-data/adapters/json-api&apos;;</div><div class="line"></div><div class="line">export default JSONAPIAdapter.extend(&#123;</div><div class="line">  host: &apos;https://api.example.com&apos;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>请求<code>person</code> 会指向 <code>https://api.example.com/people/1</code>.</p>
<h4 id="Path-Customization"><a href="#Path-Customization" class="headerlink" title="Path Customization"></a>Path Customization</h4><p>默认 <code>JSONAPIAdapter</code>会处理model的名字为复数，生成path。如果这并不适用于你的后台，那就override <code>pathForType</code> 方法.</p>
<p>例如，如果你不想复数化你的model名称，而是要把你的model名字从驼峰转为下滑线，你可以这边写<br><code>pathForType</code> 方法:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">import JSONAPIAdapter from &apos;ember-data/adapters/json-api&apos;;</div><div class="line"></div><div class="line">export default JSONAPIAdapter.extend(&#123;</div><div class="line">  pathForType: function(type) &#123;</div><div class="line">    return Ember.String.underscore(type);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>请求 <code>person</code> 被定向到 <code>/person/1</code>.<br>请求 <code>user-profile</code>定向到 <code>/user_profile/1</code>.</p>
<h4 id="Headers-customization"><a href="#Headers-customization" class="headerlink" title="Headers customization"></a>Headers customization</h4><p>又的API必须要有一些header才行，如果提供一个key。在<code>JSONAPIAdapter</code>的 <code>headers</code>对象中我们可以设置任意的header信息。Ember Data会在发送每个ajax 请求的时候带上它们.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">import JSONAPIAdapter from &apos;ember-data/adapters/json-api&apos;;</div><div class="line"></div><div class="line">export default JSONAPIAdapter.extend(&#123;</div><div class="line">  headers: &#123;</div><div class="line">    &apos;API_KEY&apos;: &apos;secret key&apos;,</div><div class="line">    &apos;ANOTHER_HEADER&apos;: &apos;Some header value&apos;</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><code>headers</code>也可以使用 computed property来支持动态header. 下面例子中是基于<code>session</code>service中的<code>authToken</code>属性的.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">import JSONAPIAdapter from &apos;ember-data/adapters/json-api&apos;;</div><div class="line"></div><div class="line">export default JSONAPIAdapter.extend(&#123;</div><div class="line">  session: Ember.inject.service(&apos;session&apos;),</div><div class="line">  headers: Ember.computed(&apos;session.authToken&apos;, function() &#123;</div><div class="line">    return &#123;</div><div class="line">      &apos;API_KEY&apos;: this.get(&apos;session.authToken&apos;),</div><div class="line">      &apos;ANOTHER_HEADER&apos;: &apos;Some header value&apos;</div><div class="line">    &#125;;</div><div class="line">  &#125;)</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>In some cases, your dynamic headers may require data from some<br>object outside of Ember’s observer system (for example<br><code>document.cookie</code>). You can use the<br><a href="http://emberjs.com/api/classes/Ember.ComputedProperty.html#method_volatile" target="_blank" rel="external">volatile</a><br>function to set the property into a non-cached mode causing the headers to<br>be recomputed with every request.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">import JSONAPIAdapter from &apos;ember-data/adapters/json-api&apos;;</div><div class="line"></div><div class="line">export default JSONAPIAdapter.extend(&#123;</div><div class="line">  headers: Ember.computed(function() &#123;</div><div class="line">    return &#123;</div><div class="line">      &apos;API_KEY&apos;: Ember.get(document.cookie.match(/apiKey\=([^;]*)/), &apos;1&apos;),</div><div class="line">      &apos;ANOTHER_HEADER&apos;: &apos;Some header value&apos;</div><div class="line">    &#125;;</div><div class="line">  &#125;).volatile()</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h4 id="Authoring-Adapters"><a href="#Authoring-Adapters" class="headerlink" title="Authoring Adapters"></a>Authoring Adapters</h4><p><code>defaultSerializer</code> 可以用来指定adapter的serializer. 只有model需要指定的serializer或者么有定义<code>serializer:application</code>的时候才会用到。</p>
<p>在app中, 指定<br><code>serializer:application</code>通常很容易. 但是，如果你是一个社区adapter的作者，记住一定要设置这个属性，以免你的用户忘记没有指定这个属性，Ember就报错了。.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">import JSONAPIAdapter from &apos;ember-data/adapters/json-api&apos;;</div><div class="line"></div><div class="line">export default JSONAPIAdapter.extend(&#123;</div><div class="line">  defaultSerializer: &apos;-default&apos;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="社区的Adapters"><a href="#社区的Adapters" class="headerlink" title="社区的Adapters"></a>社区的Adapters</h2><p>可以从下面的地址中找到社区贡献的adapter，或许有适合你的哦:</p>
<ul>
<li><a href="http://emberobserver.com/categories/data" target="_blank" rel="external">Ember Observer</a></li>
<li><a href="https://github.com/search?q=ember+data+adapter&amp;ref=cmdform" target="_blank" rel="external">GitHub</a></li>
<li><a href="http://bower.io/search/?q=ember-data-" target="_blank" rel="external">Bower</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[jenkins]]></title>
      <url>/2016/12/05/jenkins/</url>
      <content type="html"><![CDATA[<h2 id="安装插件"><a href="#安装插件" class="headerlink" title=" 安装插件"></a> 安装插件</h2><p> <code>问题</code>：每次在线安装插件的时候，Jenkins默认都是使用www.google.com去验证网络是否通畅，如果不通畅下面指定的插件还是会去下载，但是根本就不会安装。(比较让人费解的是，都下了还不安，要么就别下了也)</p>
<p> <code>期望</code>：使用www.baidu.com来验证网络，或者跳过验证。</p>
<p> <code>方案</code>: 修改/var/lib/jenkins/updates/default.json里的connectionCheckUrl，这个文件特别大， 但是这个connectionCheckUrl一般都在最开始的地方。</p>
<h2 id="启用用户验证"><a href="#启用用户验证" class="headerlink" title="启用用户验证"></a>启用用户验证</h2><p>系统管理-&gt; Configure Global Security</p>
<h2 id="maven相关"><a href="#maven相关" class="headerlink" title="maven相关"></a>maven相关</h2><p>安装maven插件</p>
<h4 id="maven仓库"><a href="#maven仓库" class="headerlink" title="maven仓库"></a>maven仓库</h4><p>主要是为了能够让每个maven项目build的时候都使用一个公共的maven地址，而又不想去默认的~/.m2/repository(我们这边/的硬盘不是很大).</p>
<p>安装一个插件：config file provider plugin<br>在系统管理-&gt;Managed files里添加一个maven的settings文件，可以把自己线上的maven配置信息弄过来。</p>
<h4 id="maven构建"><a href="#maven构建" class="headerlink" title="maven构建"></a>maven构建</h4><p>maven项目配置的时候，记得以下几点</p>
<ul>
<li>在goals和options里指定maven构建目标，反正我是二逼的忘掉了。这一条只为二逼的自己</li>
<li>root pom指定相对根目录的pom.xml的位置。</li>
<li>修改config file provider plugin的settings.xml指定的localRepository对于Jenkins用户的可读可写可执行的权限，懒货如我，直接整个repo都777了。</li>
</ul>
<h4 id="发布到tomcat"><a href="#发布到tomcat" class="headerlink" title="发布到tomcat"></a>发布到tomcat</h4><p><code>期望</code>：<br>build成功后直接使用shell将war包发布到tomcat，并重启之，等待一段时间后，测试一系列接口，确认后台正常服务。</p>
<p><code>问题</code>：<br>jenkins的job进程创建的、包括调用脚本创建的进程都会随着Jenkins job进程的退出而退出。</p>
<p>参考：<a href="https://wiki.jenkins-ci.org/display/JENKINS/ProcessTreeKiller" target="_blank" rel="external">ProcessTreeKiller</a></p>
<p><code>方案</code>：<br>下载Deploy to container Plugin，在指定project下配置构建完成后操作，配置好tomcat的相关信息之后，尝试build。</p>
<p>发现报错:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">Deploying /var/lib/jenkins/jobs/metamap/workspace/metamap_java/target/metamap.war to container Tomcat 7.x Remote</div><div class="line">ERROR: Build step failed with exception</div><div class="line">org.codehaus.cargo.container.ContainerException: Failed to redeploy [/var/lib/jenkins/jobs/metamap/workspace/metamap_java/target/metamap.war]</div><div class="line">	at org.codehaus.cargo.container.tomcat.internal.AbstractTomcatManagerDeployer.redeploy(AbstractTomcatManagerDeployer.java:189)</div><div class="line">	at hudson.plugins.deploy.CargoContainerAdapter.deploy(CargoContainerAdapter.java:73)</div><div class="line">	at hudson.plugins.deploy.CargoContainerAdapter$1.invoke(CargoContainerAdapter.java:116)</div><div class="line">	at hudson.plugins.deploy.CargoContainerAdapter$1.invoke(CargoContainerAdapter.java:103)</div><div class="line">	at hudson.FilePath.act(FilePath.java:990)</div><div class="line">	at hudson.FilePath.act(FilePath.java:968)</div><div class="line">	at hudson.plugins.deploy.CargoContainerAdapter.redeploy(CargoContainerAdapter.java:103)</div><div class="line">	at hudson.plugins.deploy.DeployPublisher.perform(DeployPublisher.java:61)</div><div class="line">	at hudson.tasks.BuildStepMonitor$3.perform(BuildStepMonitor.java:45)</div><div class="line">	at hudson.model.AbstractBuild$AbstractBuildExecution.perform(AbstractBuild.java:782)</div><div class="line">	at hudson.model.AbstractBuild$AbstractBuildExecution.performAllBuildSteps(AbstractBuild.java:723)</div><div class="line">	at hudson.maven.MavenModuleSetBuild$MavenModuleSetBuildExecution.post2(MavenModuleSetBuild.java:1037)</div><div class="line">	at hudson.model.AbstractBuild$AbstractBuildExecution.post(AbstractBuild.java:668)</div><div class="line">	at hudson.model.Run.execute(Run.java:1763)</div><div class="line">	at hudson.maven.MavenModuleSetBuild.run(MavenModuleSetBuild.java:529)</div><div class="line">	at hudson.model.ResourceController.execute(ResourceController.java:98)</div><div class="line">	at hudson.model.Executor.run(Executor.java:410)</div><div class="line">Caused by: org.codehaus.cargo.container.tomcat.internal.TomcatManagerException: The username you provided is not allowed to use the text-based Tomcat Manager (error 403)</div><div class="line">	at org.codehaus.cargo.container.tomcat.internal.TomcatManager.invoke(TomcatManager.java:555)</div><div class="line">	at org.codehaus.cargo.container.tomcat.internal.TomcatManager.list(TomcatManager.java:686)</div><div class="line">	at org.codehaus.cargo.container.tomcat.internal.TomcatManager.getStatus(TomcatManager.java:699)</div><div class="line">	at org.codehaus.cargo.container.tomcat.internal.AbstractTomcatManagerDeployer.redeploy(AbstractTomcatManagerDeployer.java:174)</div><div class="line">	... 16 more</div><div class="line">Caused by: java.io.IOException: Server returned HTTP response code: 403 for URL: http://10.0.1.62:8080//manager/text/list</div><div class="line">	at sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1839)</div><div class="line">	at sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1440)</div><div class="line">	at org.codehaus.cargo.container.tomcat.internal.TomcatManager.invoke(TomcatManager.java:544)</div><div class="line">	... 19 more</div><div class="line">org.codehaus.cargo.container.tomcat.internal.TomcatManagerException: The username you provided is not allowed to use the text-based Tomcat Manager (error 403)</div><div class="line">	at org.codehaus.cargo.container.tomcat.internal.TomcatManager.invoke(TomcatManager.java:555)</div><div class="line">	at org.codehaus.cargo.container.tomcat.internal.TomcatManager.list(TomcatManager.java:686)</div><div class="line">	at org.codehaus.cargo.container.tomcat.internal.TomcatManager.getStatus(TomcatManager.java:699)</div><div class="line">	at org.codehaus.cargo.container.tomcat.internal.AbstractTomcatManagerDeployer.redeploy(AbstractTomcatManagerDeployer.java:174)</div><div class="line">	at hudson.plugins.deploy.CargoContainerAdapter.deploy(CargoContainerAdapter.java:73)</div><div class="line">	at hudson.plugins.deploy.CargoContainerAdapter$1.invoke(CargoContainerAdapter.java:116)</div><div class="line">	at hudson.plugins.deploy.CargoContainerAdapter$1.invoke(CargoContainerAdapter.java:103)</div><div class="line">	at hudson.FilePath.act(FilePath.java:990)</div><div class="line">	at hudson.FilePath.act(FilePath.java:968)</div><div class="line">	at hudson.plugins.deploy.CargoContainerAdapter.redeploy(CargoContainerAdapter.java:103)</div><div class="line">	at hudson.plugins.deploy.DeployPublisher.perform(DeployPublisher.java:61)</div><div class="line">	at hudson.tasks.BuildStepMonitor$3.perform(BuildStepMonitor.java:45)</div><div class="line">	at hudson.model.AbstractBuild$AbstractBuildExecution.perform(AbstractBuild.java:782)</div><div class="line">	at hudson.model.AbstractBuild$AbstractBuildExecution.performAllBuildSteps(AbstractBuild.java:723)</div><div class="line">	at hudson.maven.MavenModuleSetBuild$MavenModuleSetBuildExecution.post2(MavenModuleSetBuild.java:1037)</div><div class="line">	at hudson.model.AbstractBuild$AbstractBuildExecution.post(AbstractBuild.java:668)</div><div class="line">	at hudson.model.Run.execute(Run.java:1763)</div><div class="line">	at hudson.maven.MavenModuleSetBuild.run(MavenModuleSetBuild.java:529)</div><div class="line">	at hudson.model.ResourceController.execute(ResourceController.java:98)</div><div class="line">	at hudson.model.Executor.run(Executor.java:410)</div><div class="line">Caused by: java.io.IOException: Server returned HTTP response code: 403 for URL: http://10.0.1.62:8080//manager/text/list</div><div class="line">	at sun.net.www.protocol.http.HttpURLConnection.getInputStream0(HttpURLConnection.java:1839)</div><div class="line">	at sun.net.www.protocol.http.HttpURLConnection.getInputStream(HttpURLConnection.java:1440)</div><div class="line">	at org.codehaus.cargo.container.tomcat.internal.TomcatManager.invoke(TomcatManager.java:544)</div><div class="line">	... 19 more</div><div class="line">Build step &apos;Deploy war/ear to a container&apos; marked build as failure</div></pre></td></tr></table></figure></p>
<p>修改对应tomcat的conf/tomcat-users.xml，添加tomcat-script角色，并赋予给当前的tomcat管理员用户。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">build pom done.....</div><div class="line">Deploying /var/lib/jenkins/jobs/metamap/workspace/metamap_java/target/metamap.war to container Tomcat 7.x Remote</div><div class="line">  Redeploying [/var/lib/jenkins/jobs/metamap/workspace/metamap_java/target/metamap.war]</div><div class="line">  Undeploying [/var/lib/jenkins/jobs/metamap/workspace/metamap_java/target/metamap.war]</div><div class="line">  Deploying [/var/lib/jenkins/jobs/metamap/workspace/metamap_java/target/metamap.war]</div><div class="line">Finished: SUCCESS</div></pre></td></tr></table></figure>
<h2 id="使用root用户"><a href="#使用root用户" class="headerlink" title="使用root用户"></a>使用root用户</h2><p>因为会部署很多任务放在jenkins上，而各个任务都有自己的权限目录，使用jenkins用户执行任务会有些不方便，总是遇到权限问题。</p>
<p>结合我们既有环境考虑，使用root用户执行jenkins任务并不会造成额外的危险。（操作jenksin 的人很有限，而且各自有账户）</p>
<p>具体步骤:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">vim /etc/sysconfig/jenkins</div><div class="line">$JENKINS_USER=&quot;root&quot;</div><div class="line"></div><div class="line">chown -R root:root /var/lib/jenkins</div><div class="line">chown -R root:root /var/cache/jenkins</div><div class="line">chown -R root:root /var/log/jenkins</div><div class="line"></div><div class="line">service jenkins restart</div></pre></td></tr></table></figure></p>
<p>先在jenkins配置文件里指定jenkins系统执行任务的用户，之后修改jenkins既有目录的权限，重启服务。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>python脚本不及时输出，最后一股子出来。<br>在执行python命令前，先添加环境变量：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">export PYTHONUNBUFFERED=1</div></pre></td></tr></table></figure></p>
<ul>
<li><a href="https://stackoverflow.com/questions/11631951/jenkins-console-output-not-in-realtime" target="_blank" rel="external">https://stackoverflow.com/questions/11631951/jenkins-console-output-not-in-realtime</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ember异常记录]]></title>
      <url>/2016/12/05/ember%E5%BC%82%E5%B8%B8%E8%AE%B0%E5%BD%95/</url>
      <content type="html"><![CDATA[<h4 id="ember-mermaid"><a href="#ember-mermaid" class="headerlink" title="ember-mermaid"></a>ember-mermaid</h4><p>要画流程图，对比了一下，决定使用ember-mermaid，但是github里说的安装方式运行的话，会报错：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">root@will-vm:/usr/<span class="built_in">local</span>/metamap/metamap_js<span class="comment"># ember install ember-mermaid</span></div><div class="line">DEPRECATION: Overriding init without calling this._super is deprecated. Please call this._super(), addon: `ember-mermaid`</div><div class="line">    at Function.Addon.lookup (/usr/<span class="built_in">local</span>/metamap/metamap_js/node_modules/ember-cli/lib/models/addon.js:896:27)</div><div class="line">The addon `ember-cli-htmlbars` requires an Ember CLI version of 0.1.2 or above, but you are running null.</div><div class="line">Error: The addon `ember-cli-htmlbars` requires an Ember CLI version of 0.1.2 or above, but you are running null.</div><div class="line">    at Function.deprecatedAssertAbove [as assertAbove] (/usr/<span class="built_in">local</span>/metamap/metamap_js/node_modules/ember-cli-htmlbars/node_modules/ember-cli-version-checker/index.js:143:18)</div><div class="line">    at CoreObject.module.exports.init (/usr/<span class="built_in">local</span>/metamap/metamap_js/node_modules/ember-cli-htmlbars/ember-addon-main.js:13:13)</div><div class="line">    at CoreObject.superWrapper [as init] (/usr/<span class="built_in">local</span>/metamap/metamap_js/node_modules/ember-cli/node_modules/core-object/lib/assign-properties.js:32:18)</div><div class="line">    at CoreObject.Class (/usr/<span class="built_in">local</span>/metamap/metamap_js/node_modules/ember-cli/node_modules/core-object/core-object.js:33:38)</div><div class="line">    at /usr/<span class="built_in">local</span>/metamap/metamap_js/node_modules/ember-cli/lib/models/addons-factory.js:48:21</div><div class="line">    at visit (/usr/<span class="built_in">local</span>/metamap/metamap_js/node_modules/ember-cli/lib/utilities/DAG.js:23:3)</div><div class="line">    at DAG.topsort (/usr/<span class="built_in">local</span>/metamap/metamap_js/node_modules/ember-cli/lib/utilities/DAG.js:82:7)</div><div class="line">    at CoreObject.extend.initializeAddons (/usr/<span class="built_in">local</span>/metamap/metamap_js/node_modules/ember-cli/lib/models/addons-factory.js:44:11)</div><div class="line">    at CoreObject.extend.initializeAddons (/usr/<span class="built_in">local</span>/metamap/metamap_js/node_modules/ember-cli/lib/models/addon.js:226:38)</div><div class="line">    at setupRegistryForEachAddon (/usr/<span class="built_in">local</span>/metamap/metamap_js/node_modules/ember-cli/node_modules/ember-cli-preprocess-registry/preprocessors.js:18:10)</div></pre></td></tr></table></figure></p>
<p>搜了一下没找到相关资料，索性直接暴力解决,修改报错文件里检查版本的部分/usr/local/metamap/metamap_js/node_modules/ember-cli-htmlbars/node_modules/ember-cli-version-checker/index.js:143:18。看到上面是验证版本的地方出了问题<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">if</span> (!dependencyChecker.satisfies(comparison)) &#123;</div><div class="line">  <span class="keyword">var</span> error  = <span class="keyword">new</span> <span class="built_in">Error</span>(message);</div><div class="line"></div><div class="line">  error.suppressStacktrace = <span class="literal">true</span>;</div><div class="line">  <span class="keyword">throw</span> error;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注释掉上面这些代码后成功安装。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">root@will-vm:/usr/local/metamap/metamap_js# ember install ember-mermaid</div><div class="line">DEPRECATION: Overriding init without calling this._super is deprecated. Please call this._super(), addon: `ember-mermaid`</div><div class="line">    at Function.Addon.lookup (/usr/local/metamap/metamap_js/node_modules/ember-cli/lib/models/addon.js:896:27)</div><div class="line">DEPRECATION: Node v0.10.45 is no longer supported by Ember CLI. Please update to a more recent version of Node</div><div class="line">Could not start watchman; falling back to NodeWatcher for file system events.</div><div class="line">Visit http://ember-cli.com/user-guide/#watchman for more info.</div><div class="line">Installed packages for tooling via npm.</div><div class="line">DEPRECATION: Overriding init without calling this._super is deprecated. Please call this._super(), addon: `ember-mermaid`</div><div class="line">    at Function.Addon.lookup (/usr/local/metamap/metamap_js/node_modules/ember-cli/lib/models/addon.js:896:27)</div><div class="line">installing ember-mermaid</div><div class="line">  install bower package mermaid</div><div class="line">  not-cached https://github.com/knsv/mermaid.git#^0.5.8</div><div class="line">  progress 接收对象中:  26% (58/222)</div><div class="line">  progress 接收对象中:  67% (149/222), 1.98 MiB | 166.00 KiB/s</div><div class="line">  progress 接收对象中:  68% (151/222), 1.98 MiB | 166.00 KiB/s</div><div class="line">  resolved https://github.com/knsv/mermaid.git#0.5.8</div><div class="line">  conflict Unable to find suitable version for mermaid</div><div class="line">    1) mermaid ^0.5.8</div><div class="line">    2) mermaid ^6.0.0</div><div class="line">? Answer 2</div><div class="line">Installed browser packages via Bower.</div><div class="line">Installed addon package.</div></pre></td></tr></table></figure></p>
<p>既然成功安装了，为防有其他差错，就把这个检查版本的文件恢复回去了。<br>然后启动ember server又出现了这个问题<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">root@will-vm:/usr/local/metamap/metamap_js# ember serve</div><div class="line">DEPRECATION: Overriding init without calling this._super is deprecated. Please call this._super(), addon: `ember-mermaid`</div><div class="line">    at Function.Addon.lookup (/usr/local/metamap/metamap_js/node_modules/ember-cli/lib/models/addon.js:896:27)</div><div class="line">The addon `ember-cli-htmlbars` requires an Ember CLI version of 0.1.2 or above, but you are running null.</div><div class="line">Error: The addon `ember-cli-htmlbars` requires an Ember CLI version of 0.1.2 or above, but you are running null.</div><div class="line">    at Function.deprecatedAssertAbove [as assertAbove] (/usr/local/metamap/metamap_js/node_modules/ember-cli-htmlbars/node_modules/ember-cli-version-checker/index.js:143:18)</div><div class="line">    at CoreObject.module.exports.init (/usr/local/metamap/metamap_js/node_modules/ember-cli-htmlbars/ember-addon-main.js:13:13)</div><div class="line">    at CoreObject.superWrapper [as init] (/usr/local/metamap/metamap_js/node_modules/ember-cli/node_modules/core-object/lib/assign-properties.js:32:18)</div><div class="line">    at CoreObject.Class (/usr/local/metamap/metamap_js/node_modules/ember-cli/node_modules/core-object/core-object.js:33:38)</div><div class="line">    at /usr/local/metamap/metamap_js/node_modules/ember-cli/lib/models/addons-factory.js:48:21</div><div class="line">    at visit (/usr/local/metamap/metamap_js/node_modules/ember-cli/lib/utilities/DAG.js:23:3)</div><div class="line">    at DAG.topsort (/usr/local/metamap/metamap_js/node_modules/ember-cli/lib/utilities/DAG.js:82:7)</div><div class="line">    at CoreObject.extend.initializeAddons (/usr/local/metamap/metamap_js/node_modules/ember-cli/lib/models/addons-factory.js:44:11)</div><div class="line">    at CoreObject.extend.initializeAddons (/usr/local/metamap/metamap_js/node_modules/ember-cli/lib/models/addon.js:226:38)</div><div class="line">    at setupRegistryForEachAddon (/usr/local/metamap/metamap_js/node_modules/ember-cli/node_modules/ember-cli-preprocess-registry/preprocessors.js:18:10)</div></pre></td></tr></table></figure></p>
<p>仔细看了一下官方github上给出的解释，说是要把ember-font-awesome升级到2.1.1就可以了。查了一下，压根就没有安装这个东西<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">root@will-vm:/usr/local/metamap/metamap_js# find . -name &apos;ember-font-awesome&apos;</div><div class="line">root@will-vm:/usr/local/metamap/metamap_js#</div></pre></td></tr></table></figure></p>
<p>看一下ember-mermaid的官网吧，到ember addon仓库搜索了一把<a href="https://emberobserver.com/addons/ember-mermaid，发现人家的ember-cli的版本是2.4.1，最近支持的是2.5.0.群里很多人都说2.6不稳定，所以一直没有升级。。" target="_blank" rel="external">https://emberobserver.com/addons/ember-mermaid，发现人家的ember-cli的版本是2.4.1，最近支持的是2.5.0.群里很多人都说2.6不稳定，所以一直没有升级。。</a><br>索性我就降级吧。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">npm rm -g ember-cli</div><div class="line">npm install -g ember-cli@2.5</div><div class="line">ember -v</div><div class="line">ember new testPro</div></pre></td></tr></table></figure></p>
<p>上面使用ember 2.5版本生成了一个临时项目，为了把依赖的版本copy到现有的2.6的项目里去，覆盖掉2.6的那些版本依赖。主要针对bower.json和package.json两个文件里与ember-xxx相关的版本配置。</p>
<p>之后就成功启动了，也能够使用mermaid了，再删掉临时项目就可以了。</p>
<p><code>参考</code> ：</p>
<ul>
<li><a href="https://github.com/crodriguez1a/ember-mermaid" target="_blank" rel="external">https://github.com/crodriguez1a/ember-mermaid</a></li>
<li><a href="https://knsv.github.io/mermaid/#usage" target="_blank" rel="external">https://knsv.github.io/mermaid/#usage</a></li>
<li><a href="http://www.jqueryscript.net/chart-graph/Simple-SVG-Flow-Chart-Plugin-with-jQuery-flowSVG.html" target="_blank" rel="external">http://www.jqueryscript.net/chart-graph/Simple-SVG-Flow-Chart-Plugin-with-jQuery-flowSVG.html</a></li>
<li><a href="https://jsplumbtoolkit.com/community/demo/flowchart/index.html" target="_blank" rel="external">https://jsplumbtoolkit.com/community/demo/flowchart/index.html</a></li>
<li><a href="https://www.erp5.com/javascript-10.Flow.Chart" target="_blank" rel="external">https://www.erp5.com/javascript-10.Flow.Chart</a></li>
<li><a href="https://github.com/ember-cli/ember-cli/issues/5973" target="_blank" rel="external">https://github.com/ember-cli/ember-cli/issues/5973</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[mondrian架构]]></title>
      <url>/2016/12/05/mondrian%E6%9E%B6%E6%9E%84/</url>
      <content type="html"><![CDATA[<h2 id="1-mondrain系统的层次"><a href="#1-mondrain系统的层次" class="headerlink" title="1 mondrain系统的层次"></a>1 mondrain系统的层次</h2><ul>
<li>表现层(the presentation layer)</li>
<li>维度层(the dimensional layer)</li>
<li>聚合层(the star layer)</li>
<li>存储层(the storage layer)</li>
</ul>
<h4 id="1-1-表现层-the-presentation-layer"><a href="#1-1-表现层-the-presentation-layer" class="headerlink" title="1.1 表现层(the presentation layer)"></a>1.1 表现层(the presentation layer)</h4><p>表现层决定了最终用户将在他们的显示器上看到什么, 及他们如何同系统产生交互。<br>有许多方法可以用来向用户显示多维数据集, 有 pivot 表 (一种交互式的表), pie, line 和图表(bar charts)。它们可以用Swing 或 JSP来实现。<br>表现层以多维”文法(grammar)(维、度量、单元)”的形式发出查询，然后OLAP服务器返回结果。</p>
<h4 id="1-2-维度层-the-dimensional-layer"><a href="#1-2-维度层-the-dimensional-layer" class="headerlink" title="1.2 维度层(the dimensional layer)"></a>1.2 维度层(the dimensional layer)</h4><p>维度层用来解析、验证和执行MDX查询请求。<br>一个MDX查询要通过几个阶段来完成：首先是计算坐标轴（axes），再者计算坐标轴axes 中cell的值。<br> 为了提高效率，维度层把要求查询的单元成批发送到集合层，查询转换器接受操作现有查询的请求，而不是对每个请求都建立一个MDX 声明。</p>
<h4 id="1-3-聚合层-the-star-layer"><a href="#1-3-聚合层-the-star-layer" class="headerlink" title="1.3 聚合层(the star layer)"></a>1.3 聚合层(the star layer)</h4><p>集合层负责维护和创建聚合缓存，一个聚合是在内存中缓存一组单元值， 这些单元值由一组维的值来确定。<br>维度层对这些单元发出查询请求，如果所查询的单元值不在缓存中，则聚合管理器(aggregation manager)会向存储层发出查询请求</p>
<h4 id="1-4-存储层-the-storage-layer"><a href="#1-4-存储层-the-storage-layer" class="headerlink" title="1.4 存储层(the storage layer)"></a>1.4 存储层(the storage layer)</h4><p>存储层是一个关系型数据库(RDBMS)。它负责创建集合的单元数据，和提供维表的成员。在后面后说一下直接使用RDBMS而不另外开发存储的原因。</p>
<p>这些层次组件可以都在同一个机器上，也可以分布开。第二层和第三层组成mondrian server，他俩必须在一个机器上。</p>
<h2 id="2-存储与聚合策略"><a href="#2-存储与聚合策略" class="headerlink" title="2 存储与聚合策略"></a>2 存储与聚合策略</h2><p>OLAP server通常都基于他们存储数据的方式被归为以下两类：</p>
<ul>
<li>MOLAP（multidimensional OLAP） server。为了便于多维访问，它将所有的数据结构化存储在磁盘上。一般数据都是存储在稠密的数据中，每个cell只需要4或8个字节</li>
<li>ROLAP(relational OLAP) server。直接将数据存在RDBMS中。事实表里的每一行的字段都同时包含了维度和指标。</li>
</ul>
<p>我们需要存储三种数据：事实表数据（事务记录）、聚合数据、维度。</p>
<p>MOLAP数据库是以多维格式存储事实数据的，但是如果维度很多的话，数据就会稀疏，这种存储格式表现就不太好了。 HOLAP (hybrid OLAP)系统的解决了这个问题，它在关系数据库中存储到最细粒度的数据，把聚合结果存在多维格式下。</p>
<p>对于大数据集来说，否则有些查询可能会需要遍历事实表里的所有数据。 MOLAP的聚合表通常是内存数据结构的一个快照，存储在磁盘上。ROLAP 聚合表是存在表里的。在一些 ROLAP 系统中，这些都需要OLAP server详细管理。对其他系统来说，这些表只是物化视图而已，只有在OLAP server被访问到指定查询时才会用到。</p>
<p>最极端的聚合策略就是缓存了，存在内存里。如果缓存里数据集在比较低的聚合level上，还可以上卷。</p>
<p>缓存可能是聚合策略中最重要的部分了，因为他是可以适配的。很难在不适用大量磁盘的前提下，选择聚合维度并预计算。要是维度较多，或者用户提交了某些一些不可预测的查询就更糟糕了。在数据实时变化的系统中，维护预计算聚合几乎是不可实现的。一个缓存的合理大小应该能够允许系统执行一些不可预估的查询，不适用任何聚合。</p>
<p>Mondrian的聚合策略如下：</p>
<ul>
<li>事实数据存在RDBMS中。我们没必要自己再开发一个存储了</li>
<li>通过提交group by查询，将聚合数据读取进入缓存。既然RDBMS有了聚合操作，我们也直接使用</li>
<li>如果RDBMS支持物化视图，数据库管理员为某些聚合创建了物化视图，然后mondrian就可以使用它们咯。理想情况下，mondrian的聚合管理员应该知道这些物化视图是否存在，知道怎样高效计算，甚至能够给数据库管理员一些调优建议。</li>
</ul>
<p>总的原则就是能委托给数据库的就给数据库做。数据库的负载虽然增加了一些，但是数据库的客户端获益很大。多维存储应该减少IO，才能更快。</p>
<p>另外，因为mondrian并不需要什么存储，所以只要把jar文件加入classpath就可以运行它了。没有多余的数据管理，数据加载过程也很简单，mondrian很适合数据实时变化的OLAP。</p>
<h2 id="3-API"><a href="#3-API" class="headerlink" title="3 API"></a>3 API</h2><p>mondrian为app提供了客户端api。</p>
<p>因为对于执行OLAP查询并没有统一规范，所以mondrian也是自己独有的API，但是熟悉jdbc的朋友们都会很容易上手。主要区别在于查询语言是MDX(‘Multi-Dimensional eXpressions’)，而JDBC是使用标准SQL的。</p>
<p>下面的java代码是连接mondrian，执行查询，然后打印结果：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> mondrian.olap.*;</div><div class="line"><span class="keyword">import</span> java.io.PrintWriter;</div><div class="line"></div><div class="line">Connection connection = DriverManager.getConnection(</div><div class="line">    <span class="string">"Provider=mondrian;"</span> +</div><div class="line">    <span class="string">"Jdbc=jdbc:odbc:MondrianFoodMart;"</span> +</div><div class="line">    <span class="string">"Catalog=/WEB-INF/FoodMart.xml;"</span>,</div><div class="line">    <span class="keyword">null</span>,</div><div class="line">    <span class="keyword">false</span>);</div><div class="line">Query query = connection.parseQuery(</div><div class="line">    <span class="string">"SELECT &#123;[Measures].[Unit Sales], [Measures].[Store Sales]&#125; on columns,"</span> +</div><div class="line">    <span class="string">" &#123;[Product].children&#125; on rows "</span> +</div><div class="line">    <span class="string">"FROM [Sales] "</span> +</div><div class="line">    <span class="string">"WHERE ([Time].[1997].[Q1], [Store].[CA].[San Francisco])"</span>);</div><div class="line">Result result = connection.execute(query);</div><div class="line">result.print(<span class="keyword">new</span> PrintWriter(System.out));</div></pre></td></tr></table></figure></p>
<p>使用DriverManger创建Connection。Query对应于jdbc的Statement，通过解析MDX字符串创建。 Result对应于jdbc的ResultSet。既然我们这里处理的是多维数据，这个结果里就包含了坐标轴axes和单元格cell，而不是行row和列column了。还有，OLAP是用于数据探查的，你可以执行一些类似下钻drillDown、排序sort的操作修改parse tree，然后重新执行查询。</p>
<p>还有一些对象： Schema, Cube, Dimension, Hierarchy, Level, Member. 可以看一下mondrian的API了解详情。</p>
<h2 id="4-MDX"><a href="#4-MDX" class="headerlink" title="4 MDX "></a>4 MDX </h2><h4 id="4-1-参数"><a href="#4-1-参数" class="headerlink" title="4.1 参数"></a>4.1 参数</h4><p>参数是在MDX查询中内嵌的一个变量。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Parameter(&lt;name&gt;, &lt;type&gt;, &lt;defaultValue&gt;[, &lt;description&gt;])</div></pre></td></tr></table></figure></p>
<ul>
<li>name ,在query中唯一</li>
<li>type， NUMERIC, STRING或者层次名称之一</li>
<li>defaultValue。 默认值，是一个表达式，应该跟type类型一致，如果是层次，就得是层次的某个成员</li>
<li>desc。 </li>
</ul>
<p>要是想在同一个query中使用某个参数多次，就使用：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ParamRef(&lt;name&gt;)</div></pre></td></tr></table></figure></p>
<p>下面的查询会查出California的前10名品牌，我们可以修改Count参数为前5名，或者修改Region参数为西雅图：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">SELECT &#123;[Measures].[Unit Sales]&#125; on columns,</div><div class="line">   TopCount([Product].[Brand].members,</div><div class="line">     Parameter(&quot;Count&quot;, NUMERIC, 10, &quot;Number of products to show&quot;),</div><div class="line">     (Parameter(&quot;Region&quot;, [Store], [Store].[USA].[CA]),</div><div class="line">     [Measures].[Unit Sales])) on rows</div><div class="line">FROM Sales</div></pre></td></tr></table></figure></p>
<p>可以调用Query.getParameters()来获取某个查询的所有参数，然后调用Query.setParameter(String name, String value)修改参数值。</p>
<h4 id="4-2-内置函数"><a href="#4-2-内置函数" class="headerlink" title="4.2 内置函数"></a>4.2 内置函数</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">StrToSet(&lt;String Expression&gt;[, &lt;Hierarchy&gt;])</div><div class="line">StrToTuple(&lt;String Expression&gt;[, &lt;Hierarchy&gt;])</div></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[antlr简记]]></title>
      <url>/2016/12/05/antlr%E7%AE%80%E8%AE%B0/</url>
      <content type="html"><![CDATA[<h2 id="要素"><a href="#要素" class="headerlink" title="要素"></a>要素</h2><ul>
<li>source code：面向编程人员的语言代码；</li>
<li>Lexical Analyser ：词汇解析。将source code解析成为某个语言能理解的有意义的形式；</li>
<li>Syntax Analyser: 语法解析，检查语言的正确性。</li>
<li>Semantic Analyser: 语义解析；</li>
<li>Generate/Improve Code: 生成机器能够读懂的执行代码。</li>
</ul>
<p><img src="C:\Users\will\Pictures\general_phrases_of_compiler.png" alt=""></p>
<p>参考：<a href="https://www.youtube.com/watch?v=PooQrbFrd_U" target="_blank" rel="external">https://www.youtube.com/watch?v=PooQrbFrd_U</a></p>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h4 id="环境准备-1"><a href="#环境准备-1" class="headerlink" title="环境准备"></a>环境准备</h4><p>使用eclipse进行开发。</p>
<ul>
<li>IDE环境准备：eclipse classic 3.5.0</li>
<li>eclipse 插件<ul>
<li>GEF-ALL-3.8.2</li>
<li>dltk-core-S-3.0.1-201108261011</li>
<li>antlr3. <a href="http://antlrv3ide.sourceforge.net/updates" target="_blank" rel="external">http://antlrv3ide.sourceforge.net/updates</a></li>
</ul>
</li>
</ul>
<h4 id="插件设置"><a href="#插件设置" class="headerlink" title="插件设置"></a>插件设置</h4><p>主要就是preferences里的antlr-&gt;builder里添加一个installed package，只需要一个jar包即可，但是规范是把这个jar包放到某个文件夹里。</p>
<p>我的地址是：E:\tools\antlr3.2。里面放置了antlr-3.2.jar文件。<br><img src="C:\Users\will\Pictures\antlr-install-package-eclipse.png" alt="添加antlr的jar包给插件调用"><br>还可以在code generator配置一下代码产生的位置。<br><img src="C:\Users\will\Pictures\antlr-code-generator-eclipse.png" alt="代码产生位置"></p>
<h4 id="IDE简介"><a href="#IDE简介" class="headerlink" title="IDE简介"></a>IDE简介</h4><h5 id="grammer编辑界面"><a href="#grammer编辑界面" class="headerlink" title="grammer编辑界面"></a>grammer编辑界面</h5><p>有些自动提示啥的，保存后会自动编译，并在前面指定位置生成lexer和parser代码。<br><img src="C:\Users\will\Pictures\antlr-editor-eclipse.png" alt="antlr编辑器"></p>
<h5 id="测试执行界面"><a href="#测试执行界面" class="headerlink" title="测试执行界面"></a>测试执行界面</h5><p>完成gramemr的编辑之后，可以编辑一些测试脚本，验证grammer的正确性。跟测试连接的真紧密啊，貌似antlr想不测试驱动开发都难，哈哈~<br><img src="C:\Users\will\Pictures\antlr-intercepter-eclipse.png" alt="antlr Intercepter"><br><strong>注意</strong> : 有的时候直接点击右上角的执行按钮，并不能成功解析。可以再试一下执行的下来按钮里的Run(java)的方式，它等同于执行以下代码：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">```</div><div class="line"></div><div class="line">##### RailRoad 视图</div><div class="line">展示每个rule的路线图。点击左边的rule，右边就自动呈现出来了。可以形象化的展示我们定义的每个rule。</div><div class="line">![antlr RailRoad界面](C:\Users\will\Pictures\antlr-railroad-eclipse.png)</div><div class="line">  </div><div class="line">  </div><div class="line">  </div><div class="line">  </div><div class="line">#### 创建项目</div><div class="line">创建普通java项目，之后转为antlr项目，.project：</div><div class="line">```xml</div><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line">&lt;projectDescription&gt;</div><div class="line">	&lt;name&gt;anltr-learning&lt;/name&gt;</div><div class="line">	&lt;comment&gt;&lt;/comment&gt;</div><div class="line">	&lt;projects&gt;</div><div class="line">	&lt;/projects&gt;</div><div class="line">	&lt;buildSpec&gt;</div><div class="line">		&lt;buildCommand&gt;</div><div class="line">			&lt;name&gt;org.eclipse.dltk.core.scriptbuilder&lt;/name&gt;</div><div class="line">			&lt;arguments&gt;</div><div class="line">			&lt;/arguments&gt;</div><div class="line">		&lt;/buildCommand&gt;</div><div class="line">		&lt;buildCommand&gt;</div><div class="line">			&lt;name&gt;org.eclipse.jdt.core.javabuilder&lt;/name&gt;</div><div class="line">			&lt;arguments&gt;</div><div class="line">			&lt;/arguments&gt;</div><div class="line">		&lt;/buildCommand&gt;</div><div class="line">	&lt;/buildSpec&gt;</div><div class="line">	&lt;natures&gt;</div><div class="line">		&lt;nature&gt;org.eclipse.jdt.core.javanature&lt;/nature&gt;</div><div class="line">		&lt;nature&gt;org.deved.antlride.core.nature&lt;/nature&gt;</div><div class="line">	&lt;/natures&gt;</div><div class="line">&lt;/projectDescription&gt;</div></pre></td></tr></table></figure></p>
<p>在根目录创建一个lib文件夹，然后把刚才那个install package里的jar包copy到lib里来，加入当前project的build path。</p>
<h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><p>逻辑流程图<br><img src="C:\Users\will\Pictures\antlr-process-concepts.png" alt="逻辑流程"><br>物理流程图<br><img src="C:\Users\will\Pictures\antlr-process-code.png" alt="物理流程"></p>
<ul>
<li>Lexer解析出重要的Token发送给Parser</li>
<li>Parser生成AST Tree，</li>
<li>TreeParser负责结合AST Tree里的context生成代码</li>
</ul>
<h4 id="创建antlr文件"><a href="#创建antlr文件" class="headerlink" title="创建antlr文件"></a>创建antlr文件</h4><p>创建Sample.g文件，开始真正编辑antlr文件。经测试，.g文件并不支持中文注释，会报某种NullPointer的错误。下面的注释只为解释，如果copy的话，自行注意去除。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div></pre></td><td class="code"><pre><div class="line">grammar Sample;// 类似类名似的，必须跟文件同名</div><div class="line"></div><div class="line">options &#123;</div><div class="line">  language = Java;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@header &#123;</div><div class="line">    package com.will;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">@lexer::header &#123;</div><div class="line">    package com.will;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 以下这些在antlr里都是rule了。就是定义一些语法规则。</div><div class="line">// IDENT其实也可以看成rule，只是只包含常量的rule而已。</div><div class="line">// 这个program是最外层的rule了，其实也可以叫pppp，随便。</div><div class="line">program</div><div class="line">    : &apos;program&apos; IDENT &apos;=&apos;</div><div class="line">        (constrant | variable)*</div><div class="line">        &apos;begin&apos;</div><div class="line">        statement*</div><div class="line">        &apos;end&apos; IDENT &apos;.&apos;</div><div class="line">    ;</div><div class="line"></div><div class="line">constrant</div><div class="line">    : &apos;constrant&apos; IDENT &apos;:&apos; type &apos;:=&apos; Integer &apos;;&apos;</div><div class="line">    ;</div><div class="line">    </div><div class="line">type</div><div class="line">    : &apos;Integer&apos;</div><div class="line">    ;</div><div class="line">    </div><div class="line">variable</div><div class="line">    : &apos;var&apos; IDENT (&apos;,&apos; IDENT)* &apos;:&apos; type &apos;;&apos;</div><div class="line">    ;</div><div class="line">    </div><div class="line">    </div><div class="line">// fun time</div><div class="line">// 运算符优先级设计实现，低优先级expression调用高优先级的expression</div><div class="line">term</div><div class="line">    : Integer</div><div class="line">    | &apos;(&apos; expression &apos;)&apos;</div><div class="line">    | IDENT</div><div class="line">    ;</div><div class="line"></div><div class="line">negation</div><div class="line">    : &apos;not&apos;* term</div><div class="line">    ;</div><div class="line">    </div><div class="line">unary</div><div class="line">    : (&apos;+&apos; |&apos;-&apos;)* negation</div><div class="line">    ;</div><div class="line"></div><div class="line">mult</div><div class="line">    : unary ((&apos;*&apos; | &apos;/&apos; | &apos;mode&apos;) unary)*</div><div class="line">    ;</div><div class="line">    </div><div class="line">add</div><div class="line">    : mult ((&apos;+&apos; | &apos;-&apos;) mult)*</div><div class="line">    ;</div><div class="line">    </div><div class="line">relation</div><div class="line">    : add ((&apos;=&apos; | &apos;/=&apos; | &apos;&lt;&apos; | &apos;&lt;=&apos; | &apos;&gt;&apos; | &apos;&gt;=&apos;) add)*</div><div class="line">    ;</div><div class="line"></div><div class="line">expression</div><div class="line">    : relation ((&apos;and&apos; | &apos;or&apos;) relation)*</div><div class="line">    ;</div><div class="line"></div><div class="line">statement</div><div class="line">    : assignmentStatement</div><div class="line">    | ifStatement</div><div class="line">    | loopStatement</div><div class="line">    ;</div><div class="line">exitStatement</div><div class="line">    : &apos;exit&apos; &apos;when&apos; expression</div><div class="line">    ;</div><div class="line"></div><div class="line">assignmentStatement</div><div class="line">    : IDENT &apos;:=&apos; expression &apos;;&apos;</div><div class="line">    ;</div><div class="line">    </div><div class="line">ifStatement</div><div class="line">    : &apos;if&apos; expression &apos;then&apos; statement+</div><div class="line">    (&apos;elif&apos; expression &apos;then&apos; statement+)*</div><div class="line">    (&apos;else&apos; statement+)?</div><div class="line">    &apos;end&apos; &apos;if&apos; &apos;;&apos;</div><div class="line">    ;</div><div class="line">    </div><div class="line">loopStatement</div><div class="line">    : &apos;loop&apos; statement* </div><div class="line">    exitStatement</div><div class="line">    &apos;end&apos; &apos;loop&apos; &apos;;&apos;</div><div class="line">    ;</div><div class="line"> </div><div class="line"></div><div class="line">// 静态常量rule</div><div class="line">Integer: &apos;0&apos;..&apos;9&apos;+;</div><div class="line"></div><div class="line">IDENT  : (&apos;a&apos;..&apos;z&apos; | &apos;A&apos;..&apos;Z&apos; | &apos;0&apos;..&apos;9&apos;)+;</div><div class="line">WS:(&apos; &apos; | &apos;\t&apos; |&apos;\n&apos;|&apos;\r&apos;|&apos;\f&apos;)+ &#123;$channel = HIDDEN;&#125;;</div><div class="line"></div><div class="line">// comment</div><div class="line">COMMENT: &apos;//&apos; .* (&apos;\n&apos; | &apos;\r&apos;) &#123;$channel = HIDDEN;&#125;;</div><div class="line">MUTICOMMENT: &apos;/*&apos; .* &apos;*/&apos; &#123;$channel = HIDDEN;&#125;;</div></pre></td></tr></table></figure></p>
<p>上面的文件中有个要提示的地方，就是优先级设置：<br><img src="C:\Users\will\Pictures\antlr-exec-level.png" alt="优先级定义"><br>直接copy的人家的图，大概就是从上到下优先级递减。在grammer中的实现就是低优先级的expression调用高优先级的expression，这样在调用某个expression的时候，就先执行位于叶子节点的最高优先级的expression了。</p>
<p>对应的测试代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">program XLSample1 = </div><div class="line">constrant one:Integer :=1;</div><div class="line">constrant two:Integer :=2;</div><div class="line">var x, y, z:Integer;</div><div class="line">begin</div><div class="line">x := 30 + 2 * 9 -10;</div><div class="line">y := 10;</div><div class="line">	if x=2 then</div><div class="line">		y:= 9 * 7 -1;</div><div class="line">		if 9 &gt; d then</div><div class="line">			x:= 90;</div><div class="line">		else</div><div class="line">			x:=0;</div><div class="line">		end if;</div><div class="line">	elif x&gt;9 and 8 &lt; 2 then</div><div class="line">//		x:=90;</div><div class="line">		y:=100;</div><div class="line">	else</div><div class="line">		x:= 99;</div><div class="line">		z:=100;</div><div class="line">		y:=100;</div><div class="line">	end if;</div><div class="line"></div><div class="line">loop</div><div class="line">	x:=0;</div><div class="line">	y:=99;</div><div class="line">	exit when x =0</div><div class="line">end loop;</div><div class="line">end XLSample1.</div></pre></td></tr></table></figure></p>
<p>虽然就这么几个简单的句子，但是跑出来的AST简直是太大了，就不截图了，感兴趣自己运行了看吧。</p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>动态的rule使用小写，静态常量rule就只用大写字母。</p>
<h5 id="表达式"><a href="#表达式" class="headerlink" title="表达式"></a>表达式</h5><p>基本跟正则差不太多。<br>表达式 | 解释<br>—|—<br>(a | b)| 就是a和b可以以任意次序出现，不严格限定a先于b,或者b先于a。<br>(a | b)<em> | 两者都可以有0或多个<br>(a | b)+ | 两者至少有一个，多个的话，次序可乱<br>| | 或者<br>‘0’..’9’ | 从’0’至’9’，字母也一样，生成的java代码都是直接使用&gt;  &lt;啥的限定范围的<br>‘not’? term | ‘not’可有可无，但是有的话只能有一个，多个就+或者</em><br>{$channel = HIDDEN;} | 设置当前元素在AST中不可见。应该有待挖掘，可能更多个性化的东西，都可以在这里处理</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[yarn-timeline-server]]></title>
      <url>/2016/12/05/yarn-timeline-server/</url>
      <content type="html"><![CDATA[<blockquote>
<p>timeline server主要是为yarn管理应用的当前运行状态以及历史状态的，以前也叫history server。</p>
</blockquote>
<p>负责管理以下两个事情：</p>
<h4 id="已运行完成的应用基本信息"><a href="#已运行完成的应用基本信息" class="headerlink" title="已运行完成的应用基本信息"></a>已运行完成的应用基本信息</h4><p>这些信息包括ApplicationSubmissionContext中的队列名称、用户信息等。<br>启动一个应用经历过的尝试次数，每次尝试的信息，每次尝试启用的container都有哪些，每个container的基本信息。<br>这些基本信息被ResourceManager春出道了一个history-store(默认是一个文件系统)然后提供给web-UI来展示这些已完成的应用的这些基本信息。</p>
<h4 id="正在运行或者已完成的应用的Per-framework-information"><a href="#正在运行或者已完成的应用的Per-framework-information" class="headerlink" title="正在运行或者已完成的应用的Per-framework information"></a>正在运行或者已完成的应用的Per-framework information</h4><p>Per-framework information是指针一个框架或者应用特有的信息。例如，Hadoop mapreduce框架会包含一些类似map task数量、reduce task数量、counter等信息。开发者可以自己通过TimeLineClient定制这些信息。这些信息可以通过rest api查询，也可以直接提供给某些特定UI进行渲染。</p>
<hr>
<h2 id="1-当前状态"><a href="#1-当前状态" class="headerlink" title="1. 当前状态"></a>1. 当前状态</h2><p>Timeline sever 还正在开发中.基本信息和框架特定信息已经可以满足了基本的存储于查询，但是目前timeline server还不能在secure模式下正常工作。<br>基本信息与框架指定信息是分别进行收集与呈现的，并没有很好的整合在一起。<br>框架指定信息目前只能通过restful api访问，使用json形式，目前还不支持在yarn里安装框架。</p>
<h2 id="2-基本配置Basic-Configuration"><a href="#2-基本配置Basic-Configuration" class="headerlink" title="2. 基本配置Basic Configuration"></a>2. 基本配置Basic Configuration</h2><p>用户必须先配置才能启动，下面是一个简单的示例，在yarn-site.xml里设置timeline server的主机名:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>The hostname of the Timeline service web application.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.timeline-service.hostname<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>0.0.0.0<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="3-高级配置"><a href="#3-高级配置" class="headerlink" title="3. 高级配置"></a>3. 高级配置</h2><p>In addition to the hostname, admins can also configure whether the service is enabled or not, the ports of the RPC and the web interfaces, and the number of RPC handler threads.<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>Address for the Timeline server to start the RPC server.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.timeline-service.address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>$&#123;yarn.timeline-service.hostname&#125;:10200<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>The http address of the Timeline service web application.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.timeline-service.webapp.address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>$&#123;yarn.timeline-service.hostname&#125;:8188<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>The https address of the Timeline service web application.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.timeline-service.webapp.https.address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>$&#123;yarn.timeline-service.hostname&#125;:8190<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>Handler thread count to serve the client RPC requests.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.timeline-service.handler-thread-count<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>10<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="4-基本信息相关的配置"><a href="#4-基本信息相关的配置" class="headerlink" title="4. 基本信息相关的配置"></a>4. 基本信息相关的配置</h2><p>Users can specify whether the generic data collection is enabled or not, and also choose the storage-implementation class for the generic data. There are more configurations related to generic data collection, and users can refer to yarn-default.xml for all of them.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>Indicate to ResourceManager as well as clients whether</div><div class="line">  history-service is enabled or not. If enabled, ResourceManager starts</div><div class="line">  recording historical data that Timelien service can consume. Similarly,</div><div class="line">  clients can redirect to the history service when applications</div><div class="line">  finish if this is enabled.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.timeline-service.generic-application-history.enabled<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>false<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>Store class name for history store, defaulting to file system</div><div class="line">  store<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.timeline-service.generic-application-history.store-class<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.hadoop.yarn.server.applicationhistoryservice.FileSystemApplicationHistoryStore<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="5-框架特有信息的相关配置"><a href="#5-框架特有信息的相关配置" class="headerlink" title="5. 框架特有信息的相关配置"></a>5. 框架特有信息的相关配置</h2><p>Users can specify whether per-framework data service is enabled or not, choose the store implementation for the per-framework data, and tune the retention of the per-framework data. There are more configurations related to per-framework data service, and users can refer to yarn-default.xml for all of them.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>Indicate to clients whether Timeline service is enabled or not.</div><div class="line">  If enabled, the TimelineClient library used by end-users will post entities</div><div class="line">  and events to the Timeline server.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.timeline-service.enabled<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>Store class name for timeline store.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.timeline-service.store-class<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.hadoop.yarn.server.applicationhistoryservice.timeline.LeveldbTimelineStore<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>Enable age off of timeline store data.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.timeline-service.ttl-enable<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>Time to live for timeline store data in milliseconds.<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.timeline-service.ttl-ms<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>604800000<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure>
<h2 id="6-启动timeline-server"><a href="#6-启动timeline-server" class="headerlink" title="6. 启动timeline server"></a>6. 启动timeline server</h2><p>Assuming all the aforementioned configurations are set properly, admins can start the Timeline server/history service with the following command:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ yarn historyserver</div></pre></td></tr></table></figure></p>
<p>Or users can start the Timeline server / history service as a daemon:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ yarn-daemon.sh start historyserver</div></pre></td></tr></table></figure></p>
<p>Accessing generic-data via command-line</p>
<p>Users can access applications’ generic historic data via the command line as below. Note that the same commands are usable to obtain the corresponding information about running applications.<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">$ yarn application -status &lt;Application ID&gt;</div><div class="line">$ yarn applicationattempt -list &lt;Application ID&gt;</div><div class="line">$ yarn applicationattempt -status &lt;Application Attempt ID&gt;</div><div class="line">$ yarn container -list &lt;Application Attempt ID&gt;</div><div class="line">$ yarn container -status &lt;Container ID&gt;</div></pre></td></tr></table></figure></p>
<p>Publishing of per-framework data by applications</p>
<p>Developers can define what information they want to record for their applications by composing TimelineEntity and TimelineEvent objects, and put the entities and events to the Timeline server via TimelineClient. Below is an example:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// Create and start the Timeline client</span></div><div class="line">TimelineClient client = TimelineClient.createTimelineClient();</div><div class="line">client.init(conf);</div><div class="line">client.start();</div><div class="line"></div><div class="line">TimelineEntity entity = <span class="keyword">null</span>;</div><div class="line"><span class="comment">// Compose the entity</span></div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">  TimelinePutResponse response = client.putEntities(entity);</div><div class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">  <span class="comment">// Handle the exception</span></div><div class="line">&#125; <span class="keyword">catch</span> (YarnException e) &#123;</div><div class="line">  <span class="comment">// Handle the exception</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Stop the Timeline client</span></div><div class="line">client.stop();</div></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[JPARepository札记]]></title>
      <url>/2016/12/05/JPARepository%E6%9C%AD%E8%AE%B0/</url>
      <content type="html"><![CDATA[<h2 id="join时报错"><a href="#join时报错" class="headerlink" title="join时报错"></a>join时报错</h2><p>报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">QuerySyntaxException: expecting IDENT, found &apos;*&apos; near line 1</div></pre></td></tr></table></figure></p>
<p>原始sql<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hql:<span class="keyword">select</span> a.* <span class="keyword">from</span> <span class="keyword">Archive</span> a,Employee e,Department d <span class="keyword">where</span> a.contractEndDate = :<span class="built_in">date</span> <span class="keyword">and</span> a.status = <span class="string">'A'</span> <span class="keyword">and</span> a.empId = e.id <span class="keyword">and</span> e.status = <span class="string">'A'</span> <span class="keyword">and</span> e.type = <span class="string">'A'</span></div></pre></td></tr></table></figure></p>
<p>改成<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> a <span class="keyword">from</span> <span class="keyword">Archive</span> a,Employee e,Department d <span class="keyword">where</span> a.contractEndDate = :<span class="built_in">date</span> <span class="keyword">and</span> a.status = <span class="string">'A'</span> <span class="keyword">and</span> a.empId = e.id <span class="keyword">and</span> e.status = <span class="string">'A'</span> <span class="keyword">and</span> e.type = <span class="string">'A'</span></div></pre></td></tr></table></figure></p>
<p>select 后面为对象 a .而非 a.*</p>
<p>参考：<br><a href="http://blog.sina.com.cn/s/blog_4bf2e5550100n2gh.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_4bf2e5550100n2gh.html</a></p>
<h2 id="SQL面向Entity"><a href="#SQL面向Entity" class="headerlink" title="SQL面向Entity"></a>SQL面向Entity</h2><p>指的是在JPARepository的子类中自定义的函数<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TblBloodRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">TblBlood</span>, <span class="title">Integer</span>&gt;</span>&#123;</div><div class="line">    <span class="function">TblBlood <span class="title">findByTblName</span><span class="params">(String tblName)</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@Query</span>(<span class="string">"select a from "</span></div><div class="line">            + <span class="string">"(select blood from TblBlood blood where valid = 1) a"</span></div><div class="line">            + <span class="string">" left outer join "</span></div><div class="line">            + <span class="string">"(select distinct parentTbl from TblBlood where valid = 1) b"</span></div><div class="line">            + <span class="string">" on a.tblName = b.parentTbl"</span></div><div class="line">            + <span class="string">" where b.parentTbl is null"</span>)</div><div class="line">    <span class="function">List&lt;TblBlood&gt; <span class="title">selectAllLeaf</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@Modifying</span></div><div class="line">    <span class="meta">@Query</span>(<span class="string">"update TblBlood set valid = 0 where tblName=:tblName"</span>)</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">makePreviousInvalid</span><span class="params">(@Param(<span class="string">"tblName"</span>)</span>String tblName)</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Query</span>(<span class="string">"select b from"</span></div><div class="line">            + <span class="string">" TblBlood a join TblBlood b"</span></div><div class="line">            + <span class="string">" on a.parentTbl = b.tblName and b.valid = 1"</span></div><div class="line">            + <span class="string">" where a.valid = 1 and a.tblName = :tblName"</span>)</div><div class="line">    <span class="function">List&lt;TblBlood&gt; <span class="title">selectParentByTblName</span><span class="params">(@Param(<span class="string">"tblName"</span>)</span>String tblName)</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Query</span>(<span class="string">"from TblBlood where valid = 1 and parentTbl=:tblName"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;TblBlood&gt; <span class="title">selectByParentTblName</span><span class="params">(@Param(<span class="string">"tblName"</span>)</span>String tblName)</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Query</span>(<span class="string">"from TblBlood where valid = 1 and tblName=:tblName"</span>)</div><div class="line">    <span class="function">List&lt;TblBlood&gt; <span class="title">selectByTblName</span><span class="params">(@Param(<span class="string">"tblName"</span>)</span>String tblName)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>TblBlood就是对象的类名，而不是真正的表名。</p>
<h2 id="自join"><a href="#自join" class="headerlink" title="自join"></a>自join</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Query</span>(<span class="string">"select b from"</span></div><div class="line">            + <span class="string">" TblBlood a join TblBlood b"</span></div><div class="line">            + <span class="string">" on a.parentTbl = b.tblName and b.valid = 1"</span></div><div class="line">            + <span class="string">" where a.valid = 1 and a.tblName = ?1"</span>)</div><div class="line">    <span class="function">List&lt;TblBlood&gt; <span class="title">selectParentByTblName</span><span class="params">(String tblName)</span></span>;</div></pre></td></tr></table></figure>
<p>报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">  Path expected for join!</div><div class="line">	at org.hibernate.hql.internal.ast.HqlSqlWalker.createFromJoinElement(HqlSqlWalker.java:378)</div><div class="line">	at org.hibernate.hql.internal.antlr.HqlSqlBaseWalker.joinElement(HqlSqlBaseWalker.java:3858)</div><div class="line">	at org.hibernate.hql.internal.antlr.HqlSqlBaseWalker.fromElement(HqlSqlBaseWalker.java:3644)</div><div class="line">	at org.hibernate.hql.internal.antlr.HqlSqlBaseWalker.fromElementList(HqlSqlBaseWalker.java:3522)</div><div class="line"> </div><div class="line"> org.springframework.beans.factory.BeanCreationException: Error creating bean with name &apos;tblBloodRepository&apos;: Invocation of init method failed; nested exception is java.lang.IllegalArgumentException: Validation failed for query for method public abstract java.util.List com.will.hivesolver.repositories.TblBloodRepository.selectParentByTblName(java.lang.String)!</div><div class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1574)</div><div class="line">	...</div><div class="line">Caused by: java.lang.IllegalArgumentException: Validation failed for query for method public abstract java.util.List com.will.hivesolver.repositories.TblBloodRepository.selectParentByTblName(java.lang.String)!</div><div class="line">	at org.springframework.data.jpa.repository.query.SimpleJpaQuery.validateQuery(SimpleJpaQuery.java:84)</div><div class="line">	.....</div><div class="line">Caused by: java.lang.IllegalStateException: No data type for node: org.hibernate.hql.internal.ast.tree.IdentNode </div><div class="line"> \-[IDENT] IdentNode: &apos;b&apos; &#123;originalText=b&#125;</div><div class="line"></div><div class="line">	at org.hibernate.hql.internal.ast.tree.SelectClause.initializeExplicitSelectClause(SelectClause.java:174)</div><div class="line">	at org.hibernate.hql.internal.ast.HqlSqlWalker.useSelectClause(HqlSqlWalker.java:923)</div><div class="line">	...</div></pre></td></tr></table></figure></p>
<h2 id="不能更新"><a href="#不能更新" class="headerlink" title="不能更新"></a>不能更新</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">严重: Servlet.service() for servlet [api] in context with path [/metamap] threw exception [Request processing failed; nested exception is org.springframework.dao.InvalidDataAccessApiUsageException: Executing an update/delete query; nested exception is javax.persistence.TransactionRequiredException: Executing an update/delete query] with root cause</div><div class="line">javax.persistence.TransactionRequiredException: Executing an update/delete query</div></pre></td></tr></table></figure>
<p>Spring Data JPA，事务导致的异常</p>
<p>需要在springMVC的xml里添加,这里只扫描Controller所在的位置里的Controller<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.will.hivesolver.controller"</span> <span class="attr">use-default-filters</span>=<span class="string">"false"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">"annotation"</span> <span class="attr">expression</span>=<span class="string">"org.springframework.stereotype.Controller"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">"annotation"</span> <span class="attr">expression</span>=<span class="string">"org.springframework.web.bind.annotation.ControllerAdvice"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>在applicationContext.xml中添加，这里必须不能扫描上面扫描过的Controller：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.will.hivesolver"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">"annotation"</span> <span class="attr">expression</span>=<span class="string">"org.springframework.stereotype.Controller"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">"annotation"</span> <span class="attr">expression</span>=<span class="string">"org.springframework.web.bind.annotation.ControllerAdvice"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>参考：<a href="https://github.com/springside/springside4/wiki/Spring-MVC" target="_blank" rel="external">https://github.com/springside/springside4/wiki/Spring-MVC</a></p>
<h2 id="No-property-jobId-found-for-type-Execution-惨案"><a href="#No-property-jobId-found-for-type-Execution-惨案" class="headerlink" title=" No property jobId found for type Execution!惨案"></a> No property jobId found for type Execution!惨案</h2><p>Could not determine type for  at table</p>
<p>紧接着Could not determine type for: java.util.Set</p>
<p>参考：</p>
<ul>
<li><a href="http://stackoverflow.com/questions/15845030/no-property-u-found-for-type-com-models-entities-orderentity" target="_blank" rel="external">http://stackoverflow.com/questions/15845030/no-property-u-found-for-type-com-models-entities-orderentity</a></li>
<li><a href="http://stackoverflow.com/questions/15849278/org-hibernate-mappingexception-could-not-determine-type-for-java-util-set-at" target="_blank" rel="external">http://stackoverflow.com/questions/15849278/org-hibernate-mappingexception-could-not-determine-type-for-java-util-set-at</a></li>
</ul>
<h2 id="failed-to-lazily-initialize-a-collection-of-role-could-not-initialize-proxy-no-Session"><a href="#failed-to-lazily-initialize-a-collection-of-role-could-not-initialize-proxy-no-Session" class="headerlink" title="failed to lazily initialize a collection of role: , could not initialize proxy - no Session"></a>failed to lazily initialize a collection of role: , could not initialize proxy - no Session</h2><p>著名的延迟加载问题。<br>原因是One加载完之后，session就已经关闭了，此时再去请求many，就么有session了。<br>最终采用的方案是：在web.xml里添加spring的OpenSessionInViewFilter。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span>  </div><div class="line">       <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>OpenSessionInViewFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span>  </div><div class="line">       <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>  </div><div class="line">           org.springframework.orm.hibernate3.support.OpenSessionInViewFilter</div><div class="line">       <span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">init-param</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">param-name</span>&gt;</span>sessionFactoryBeanName<span class="tag">&lt;/<span class="name">param-name</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">param-value</span>&gt;</span>sessionfactory<span class="tag">&lt;/<span class="name">param-value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">init-param</span>&gt;</span> </div><div class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span>  </div><div class="line">       <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>OpenSessionInViewFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span>  </div><div class="line">       <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/*<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span> </div><div class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></div></pre></td></tr></table></figure>
<p>No persistence units parsed from {classpath*:META-INF/persistence.xml</p>
<p>参考：</p>
<ul>
<li><a href="http://blog.csdn.net/elfenliedef/article/details/6011892" target="_blank" rel="external">http://blog.csdn.net/elfenliedef/article/details/6011892</a></li>
<li><a href="http://lazycat0102.blog.51cto.com/8938702/1584779" target="_blank" rel="external">http://lazycat0102.blog.51cto.com/8938702/1584779</a></li>
<li><a href="http://www.cnblogs.com/luxh/archive/2012/05/24/2516282.html" target="_blank" rel="external">http://www.cnblogs.com/luxh/archive/2012/05/24/2516282.html</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hive中的权限-SQL-Standard-Based-Hive-Authorization]]></title>
      <url>/2016/12/05/hive%E4%B8%AD%E7%9A%84%E6%9D%83%E9%99%90-SQL-Standard-Based-Hive-Authorization/</url>
      <content type="html"><![CDATA[<h2 id="hive-0-13之前"><a href="#hive-0-13之前" class="headerlink" title="hive 0.13之前"></a>hive 0.13之前</h2><p>默认hive的权限机制并不是为了防止一些恶意用户访问一些他们不该看的东西的，只是为了防止用户误操作。这套机制很不完善，甚至对于grant这种语句也不会做权限检查。权限检查是在hive query的编译阶段进行的。由于用户能够操作dfs、执行自定义函数、还能操作shell，跳过客户端的安全检查也不是不可能的。</p>
<p>hive还支持存储层的权限验证，主要用来给metastore server api添加权限验证（参考 Storage Based Authorization in the Metastore Server）。0.12版本之后，在client端也可以使用了。这样metastore就被保护起来了，但是对于细粒度访问权限还是控制不了（例如行、列）。</p>
<p>一般通过创建view来解决这个问题，只让用户访问到view层。</p>
<h2 id="0-13之后"><a href="#0-13之后" class="headerlink" title="0.13之后"></a>0.13之后</h2><p>基于sql标准的检查机制,推荐使用此种方式。<br>这种认证方式可以在metastore server上结合storage based authorization一起使用。和目前目前hive的默认认证机制一样也算在hive query的编译阶段进行验证的。为了保证安全性，我们需要确认client端是安全的，让用户通过hiveserver2来访问数据，约束用户代码和非法sql命令。检查是针对提交query给hive server2的用户的，但是实际执行查询的时候使用hive server2用户执行，目录和文件也都只对hive server2的用户开放。对于不需要进行检查约束的用户，则可以直接开放给他们hive命令行执行权限，也就是查询的时候就使用提交的那个用户。</p>
<p>这项工作是尽量像SQL标准看齐的，不过也有一些有差异的地方。出发点一般都是为了让既有用户能够平滑的迁移到认证机制，或者考虑到易用性。</p>
<p>在这种认证机制下，所有可以访问到hive命令行、HDFS命令行、pig命令行、Hadoop jar等的用户都被认为是特权用户。团队中只有做ETL工作的人才能拥有这些权利。这些工具都不通过hive server访问数据，也就是说他们不会被检查认证情况。对于通过hive 客户端、pig、MR等访问hive table的用户可以控制他们启用metastore server的storage based authorization。</p>
<p>类似数据分析等使用sql或者jdbc通过hive server2访问数据的用户可以使用此套认证机制。</p>
<h3 id="hive-命令和语句的限制"><a href="#hive-命令和语句的限制" class="headerlink" title="hive 命令和语句的限制"></a>hive 命令和语句的限制</h3><p>启用此认证机制后</p>
<ul>
<li>dfs\add\delete\compile\reset等命令都不可用。</li>
<li>hive运行时的set的配置参数只有少数能够被设置， hive.security.authorization.sqlstd.confwhitelist 控制这个东西，这里面是可以配置的参数的白名单。</li>
<li>只有admin角色才能添加和删除function和macro。admin角色需要为普通用户添加permanent function，这样其他用户才能使用自定义的一些function。</li>
<li>transform clause不可用</li>
</ul>
<h3 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h3><ul>
<li>select </li>
<li>insert</li>
<li>update</li>
<li>delete</li>
<li>all</li>
</ul>
<h3 id="对象"><a href="#对象" class="headerlink" title="对象"></a>对象</h3><ul>
<li>table和view。不支持database</li>
<li>database所有权只对应部分动作</li>
<li>hive里还有特殊的对象URI。上面的权限对URI不适用，URI是指向系统的某个文件的。认证机制是通过用户的文件权限进行认证的。</li>
</ul>
<h3 id="对象所有权"><a href="#对象所有权" class="headerlink" title="对象所有权"></a>对象所有权</h3><p>针对每个操作，都会检查当前用户对于当前对象是否有权限。创建的人就是owner。对于table和view来说owner有所有权限。某个role也可以是一个database的owner，通过alter database来修改database的owner。</p>
<h3 id="user-和-role"><a href="#user-和-role" class="headerlink" title="user 和 role"></a>user 和 role</h3><p>权限可以给user，也可以给role。一个user可以有一个或多个role。<br>两个特殊的role：public以及admin。所有的user都是public role。You use this role in your grant statement to grant a privilege to all users.</p>
<p>当一个user运行hive命令的时候，就会检查这个用户的role以及它目前拥有的所有权限。使用”show current roles;”命令来查看当前用户的role。除了admin其他用户都可以在current role里查到，而且可以使用”set role xxx”命令来给当前用户设置一个role。</p>
<p>database的管理者应该使用admin role。这些用户可以执行类似”create role””drop role”等命令，也可以访问一切资源。但是，这些用户在成为admin role之前，必须先执行”set role admin”，因为admin默认是不再current roles里的。</p>
<h3 id="role相关命令"><a href="#role相关命令" class="headerlink" title="role相关命令"></a>role相关命令</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- 只有admin角色才能执行的命令</span></div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">ROLE</span> role_name;</div><div class="line"><span class="keyword">DROP</span> <span class="keyword">ROLE</span> role_name;</div><div class="line"><span class="keyword">SHOW</span> <span class="keyword">ROLES</span>;</div><div class="line"><span class="comment">-- Show Principals 查看role的权限</span></div><div class="line"><span class="keyword">SHOW</span> PRINCIPALS role_name;</div><div class="line"></div><div class="line"><span class="keyword">SHOW</span> <span class="keyword">CURRENT</span> <span class="keyword">ROLES</span>;</div><div class="line"><span class="keyword">SET</span> <span class="keyword">ROLE</span> (role_name|ALL|<span class="keyword">NONE</span>);</div><div class="line"><span class="comment">--All 是当有新的role被赋予给当前user的时候，刷新一下current roles</span></div><div class="line"><span class="comment">--None 移除所有的current roles</span></div><div class="line"></div><div class="line"><span class="comment">-- Grant role</span></div><div class="line"><span class="keyword">GRANT</span> role_name [, role_name] ...</div><div class="line"><span class="keyword">TO</span> principal_specification [, principal_specification] ...</div><div class="line">[ <span class="keyword">WITH</span> <span class="keyword">ADMIN</span> <span class="keyword">OPTION</span> ];</div><div class="line"> </div><div class="line">principal_specification</div><div class="line">  : USER user</div><div class="line">  | ROLE role</div><div class="line"></div><div class="line"><span class="comment">-- 如果指定了'with admin option',那么这个用户就也能将这个role赋予其他user/role。如果出现role之间grant循环，就会直接报错。 </span></div><div class="line"></div><div class="line"><span class="comment">-- Revoke Role</span></div><div class="line"><span class="keyword">REVOKE</span> [<span class="keyword">ADMIN</span> <span class="keyword">OPTION</span> <span class="keyword">FOR</span>] role_name [, role_name] ...</div><div class="line"><span class="keyword">FROM</span> principal_specification [, principal_specification] ... ;</div><div class="line"> </div><div class="line">principal_specification</div><div class="line">  : USER user</div><div class="line">  | ROLE role</div><div class="line"></div><div class="line"><span class="comment">-- Show Role Grant 只能查看自己的role的权限</span></div><div class="line"><span class="keyword">SHOW</span> <span class="keyword">ROLE</span> <span class="keyword">GRANT</span> (<span class="keyword">USER</span>|<span class="keyword">ROLE</span>) principal_name;</div></pre></td></tr></table></figure>
<h3 id="管理对象权限"><a href="#管理对象权限" class="headerlink" title="管理对象权限"></a>管理对象权限</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="comment">-- 授予权限</span></div><div class="line"><span class="keyword">GRANT</span></div><div class="line">    priv_type [, priv_type ] ...</div><div class="line">    <span class="keyword">ON</span> table_or_view_name</div><div class="line">    <span class="keyword">TO</span> principal_specification [, principal_specification] ...</div><div class="line">    [<span class="keyword">WITH</span> <span class="keyword">GRANT</span> <span class="keyword">OPTION</span>];</div><div class="line">    </div><div class="line"><span class="comment">-- 收回权限</span></div><div class="line"><span class="keyword">REVOKE</span> [<span class="keyword">GRANT</span> <span class="keyword">OPTION</span> <span class="keyword">FOR</span>]</div><div class="line">    priv_type [, priv_type ] ...</div><div class="line">    <span class="keyword">ON</span> table_or_view_name</div><div class="line">    <span class="keyword">FROM</span> principal_specification [, principal_specification] ... ;</div><div class="line"> </div><div class="line">principal_specification</div><div class="line">  : USER user</div><div class="line">  | ROLE role</div><div class="line"> </div><div class="line">priv_type</div><div class="line">  : <span class="keyword">INSERT</span> | <span class="keyword">SELECT</span> | <span class="keyword">UPDATE</span> | <span class="keyword">DELETE</span> | ALL</div><div class="line">  </div><div class="line"><span class="comment">-- Show Grant</span></div><div class="line"><span class="keyword">SHOW</span> <span class="keyword">GRANT</span> [principal_name] <span class="keyword">ON</span> (ALL| ([<span class="keyword">TABLE</span>] table_or_view_name)</div><div class="line"><span class="keyword">show</span> <span class="keyword">grant</span> <span class="keyword">user</span> hive <span class="keyword">on</span> all</div></pre></td></tr></table></figure>
<p>注意revoke语句不能drop任何有依赖的权限。详见Postgres revoke documentation.</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li>SQL Standards Based Authorization in HiveServer2</li>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/SQL+Standard+Based+Hive+Authorization" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/SQL+Standard+Based+Hive+Authorization</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Authorization#LanguageManualAuthorization-2SQLStandardsBasedAuthorizationinHiveServer2" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Authorization#LanguageManualAuthorization-2SQLStandardsBasedAuthorizationinHiveServer2</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ambari-hive-storage-based-authorization]]></title>
      <url>/2016/12/05/ambari-hive-storage-based-authorization/</url>
      <content type="html"><![CDATA[<h4 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h4><p>hive使用hdfs的文件系统权限来约束用户对database/table/partition的访问权限，可以让用户属于多个group，不同权限的数据属于不同group就可以随意组合用户的权限了。</p>
<h4 id="ambari配置参数"><a href="#ambari配置参数" class="headerlink" title="ambari配置参数"></a>ambari配置参数</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.security.metastore.authorization.manager<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.hadoop.hive.ql.security.authorization.DefaultHiveMetastoreAuthorizationProvider<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>authorization manager class name to be used in the metastore for authorization.</div><div class="line">  The user defined authorization class should implement interface</div><div class="line">  org.apache.hadoop.hive.ql.security.authorization.HiveMetastoreAuthorizationProvider.</div><div class="line">  <span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line"> <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.security.metastore.authenticator.manager<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>org.apache.hadoop.hive.ql.security.HadoopDefaultMetastoreAuthenticator<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>authenticator manager class name to be used in the metastore for authentication.</div><div class="line">  The user defined authenticator should implement interface </div><div class="line">  org.apache.hadoop.hive.ql.security.HiveAuthenticationProvider.</div><div class="line">  <span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>hive.metastore.pre.event.listeners<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span> <span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>pre-event listener classes to be loaded on the metastore side to run code</div><div class="line">  whenever databases, tables, and partitions are created, altered, or dropped.</div><div class="line">  Set to org.apache.hadoop.hive.ql.security.authorization.AuthorizationPreEventListener</div><div class="line">  if metastore-side authorization is desired.</div><div class="line">  <span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure>
<h4 id="测试时间"><a href="#测试时间" class="headerlink" title="测试时间"></a>测试时间</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">hive&gt; create database willtest;</div><div class="line"></div><div class="line">hive&gt; CREATE TABLE `batting`(</div><div class="line">    &gt;   `id` int, </div><div class="line">    &gt;   `dtdontquery` string, </div><div class="line">    &gt;   `name` string)</div><div class="line">    &gt; PARTITIONED BY ( </div><div class="line">    &gt;   `dt` string);</div><div class="line">    </div><div class="line">hive&gt; insert into willtest.batting partition(dt=&apos;20150409&apos;) values(12, &apos;will test string&apos;, &apos;will&apos;);</div></pre></td></tr></table></figure>
<ol>
<li>创建测试库willtest</li>
<li>创建测试表willtest.batting</li>
<li>插入一条测试数据，使用ambari用户maming到hive view查询此表，正常。</li>
<li>观察一下hdfs上的文件.<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[hdfs@data-test02 root]$ hdfs dfs -ls /apps/hive/warehouse</div><div class="line">drwxrwxrwx   - hive hdfs          0 2016-05-27 15:22 /apps/hive/warehouse/willtest.db</div><div class="line"></div><div class="line">[hdfs@data-test02 root]$ hdfs dfs -ls /apps/hive/warehouse/willtest.db</div><div class="line">drwxrwxrwx   - hive hdfs          0 2016-05-27 15:23 /apps/hive/warehouse/willtest.db/batting</div></pre></td></tr></table></figure>
</li>
</ol>
<p>现在这个库和表的权限都是谁都可以随便操作的，而且owner是hive，group是hdfs。</p>
<ol>
<li>修改batting表的权限，期望我们的ambari用户maming不能查询；<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[hdfs@data-test02 root]$ hdfs dfs -chmod -R 770 /apps/hive/warehouse/willtest.db/batting</div><div class="line">[hdfs@data-test02 root]$ hdfs dfs -ls /apps/hive/warehouse/willtest.db</div><div class="line">drwxrwx---   - hive hdfs          0 2016-05-27 15:23 /apps/hive/warehouse/willtest.db/batting</div></pre></td></tr></table></figure>
</li>
</ol>
<p>先把group和all的权限约束一下，这里因为maming本来就不是hdfs group的，所以就暂时不用修改group了。</p>
<ol>
<li><p>再使用ambari用户amming查询willtest.batting，报错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"> org.apache.ambari.view.hive.client.HiveErrorStatusException: H110 Unable to submit statement. Error while compiling statement: FAILED: SemanticException Unable to fetch table batting. java.security.AccessControlException: Permission denied: user=maming, access=READ, inode=&quot;/apps/hive/warehouse/willtest.db/batting&quot;:hive:hdfs:drwxrwx---</div><div class="line">...</div></pre></td></tr></table></figure>
</li>
<li><p>补充一下maming等几个用户的权限</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[hdfs@data-test02 root]$ hdfs groups maming</div><div class="line">maming : maming</div><div class="line">[hdfs@data-test02 root]$ hdfs groups sqoop</div><div class="line">sqoop : hadoop</div><div class="line">[hdfs@data-test02 root]$ hdfs groups hdfs</div><div class="line">hdfs : hadoop hdfs</div></pre></td></tr></table></figure>
</li>
<li><p>将maming暂时加入hdfs这个group之后再试一下，成功</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure>
</li>
</ol>
<p>测试成功。</p>
<h4 id="延伸"><a href="#延伸" class="headerlink" title="延伸"></a>延伸</h4><p>好，基本需求能够实现。那么如果我们为某个group分配了某个db的权限。如果我们新增一个表batting2呢，再看一下文件属性<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[hdfs@data-test02 root]$ hdfs dfs -ls /apps/hive/warehouse/willtest.db</div><div class="line">drwxrwx---   - hive hdfs          0 2016-05-27 15:23 /apps/hive/warehouse/willtest.db/batting</div><div class="line">drwxrwxrwx   - hive hdfs          0 2016-05-27 15:51 /apps/hive/warehouse/willtest.db/batting2</div></pre></td></tr></table></figure></p>
<p>问题出现，我们需要修改创建数据仓库文件的默认权限才行，不然我们就需要每次增加新库都得改一下table文件权限。</p>
<p>找到两个相关参数<br>|参数 |含义 |<br>|—|—|<br>| hive.warehouse.subdir.inherit.perms |true/false 是否 <strong>继承上级文件夹的umask</strong> |<br>| hive.files.umask.value | 0770 解释说是被上面那个参数替换了 |<br>那就设置hive.warehouse.subdir.inherit.perms为true，重启一下hive，再去创建表看一下文件夹的权限。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[hdfs@data-test02 root]$ hdfs dfs -chmod -R 770 /apps/hive/warehouse/</div><div class="line">[hdfs@data-test02 root]$ hdfs dfs -ls /apps/hive/warehouse/</div><div class="line">Found 2 items</div><div class="line">drwxrwx---   - hive hdfs          0 2016-05-27 15:10 /apps/hive/warehouse/batting</div><div class="line">drwxrwx---   - hive hdfs          0 2016-05-27 16:26 /apps/hive/warehouse/willtest.db</div><div class="line">[hdfs@data-test02 root]$ hdfs dfs -ls /apps/hive/warehouse/willtest.db</div><div class="line">Found 4 items</div><div class="line">drwxrwx---   - hive hdfs          0 2016-05-27 15:23 /apps/hive/warehouse/willtest.db/batting</div><div class="line">drwxrwx---   - hive hdfs          0 2016-05-27 15:51 /apps/hive/warehouse/willtest.db/batting2</div><div class="line">drwxrwx---   - hive hdfs          0 2016-05-27 16:27 /apps/hive/warehouse/willtest.db/batting4</div></pre></td></tr></table></figure></p>
<p>先把willtest.db的文件夹权限改成了770，然后在willtest库里创建了一个新的表batting4，可以看到hdfs里的权限已经跟父目录保持一致了。<br>这样我们给指定了某个db的文件夹权限之后，下面的table的新增与变化，权限都会稍微固定一些。</p>
<h4 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h4><p><a href="https://cwiki.apache.org/confluence/display/Hive/Storage+Based+Authorization+in+the+Metastore+Server" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/Storage+Based+Authorization+in+the+Metastore+Server</a><br><a href="https://cwiki.apache.org/confluence/display/Hive/HCatalog+Authorization" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/HCatalog+Authorization</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[django模板语言]]></title>
      <url>/2016/12/05/django%E6%A8%A1%E6%9D%BF%E8%AF%AD%E8%A8%80/</url>
      <content type="html"><![CDATA[<p>本文从技术角度解释一下Django template系统，看一下它是怎样运行的，以及怎样继承它。</p>
<p>希望你已经看了前面的文章。</p>
<h2 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h2><p>在python中使用template系统包含三个步骤：</p>
<ol>
<li>配置一个<a href="https://docs.djangoproject.com/en/1.9/ref/templates/api/#django.template.Engine" target="_blank" rel="external">Engine</a>；</li>
<li>把template代码编译成<a href="https://docs.djangoproject.com/en/1.9/ref/templates/api/#django.template.Template" target="_blank" rel="external">Template</a>；</li>
<li>在<a href="https://docs.djangoproject.com/en/1.9/ref/templates/api/#django.template.Context" target="_blank" rel="external">Context</a>中渲染这个Template</li>
</ol>
<p>Django项目一般都是使用<a href="https://docs.djangoproject.com/en/1.9/topics/templates/#template-engines" target="_blank" rel="external">高级API</a>来实现上面的步骤。</p>
<ol>
<li>对于<a href="https://docs.djangoproject.com/en/1.9/ref/settings/#std:setting-TEMPLATES" target="_blank" rel="external">TEMPLATES</a>配置的每个<a href="https://docs.djangoproject.com/en/1.9/topics/templates/#django.template.backends.django.DjangoTemplates" target="_blank" rel="external"> DjangoTemplates</a>，Django都实例化一个<code>Engine</code>. DjangoTemplates包装了一个<code>Engine</code>，使它能够适配后台的通用模板API。</li>
<li><a href="https://docs.djangoproject.com/en/1.9/topics/templates/#module-django.template.loader" target="_blank" rel="external">django.template.loader</a> moduel有一个<code>get_template()</code>方法用来加载template。返回一个包装了<a href="https://docs.djangoproject.com/en/1.9/ref/templates/api/#django.template.Template" target="_blank" rel="external">django.template.Template</a>的<code>django.template.backends.django.Template</code>.</li>
<li>上一步骤中的<code>Template</code>有一个<code>render()</code>方法，它又包含一个context，有时也包含一个针对<code>Context</code>的request，负责在指定Template进行渲染。</li>
</ol>
<h2 id="配置engine"><a href="#配置engine" class="headerlink" title="配置engine"></a>配置engine</h2><p><strong>class Engine(dirs=None, app_dirs=False, allowed_include_roots=None, context_processors=None, debug=False, loaders=None, string_if_invalid=’’, file_charset=’utf-8’, libraries=None, builtins=None)<a href="https://docs.djangoproject.com/en/1.9/_modules/django/template/engine/#Engine" target="_blank" rel="external">source</a></strong></p>
<ul>
<li><strong>dirs</strong> template文件所在的文件夹们，默认是空</li>
<li><strong>loaders</strong> 多个template loader类。<a href="https://docs.djangoproject.com/en/1.9/ref/templates/api/#template-loaders" target="_blank" rel="external">详见</a></li>
<li><strong>app_dirs</strong> 只在<strong>loaders</strong>里配置了’django.template.loaders.app_directories.Loader’ 才有效果</li>
<li><strong>libraries</strong></li>
</ul>
<h2 id="加载Template"><a href="#加载Template" class="headerlink" title="加载Template"></a>加载Template</h2><p>创建<code>Template</code>的推荐方式是调用<code>Engine</code>的<code>get_template()</code>, <code>select_template()</code>或者<code>from_string()</code>.</p>
<p>在django项目里是只能配置一个Template的，但我们也可以脱离配置直接使用Template。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.template <span class="keyword">import</span> Template</div><div class="line"></div><div class="line">template = Template(<span class="string">"My name is &#123;&#123; my_name &#125;&#125;."</span>)</div></pre></td></tr></table></figure></p>
<h2 id="渲染context"><a href="#渲染context" class="headerlink" title="渲染context"></a>渲染context</h2><p>编译好Template之后，就可以用它来渲染任意的context了。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> django.template <span class="keyword">import</span> Context, Template</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>template = Template(<span class="string">"My name is &#123;&#123; my_name &#125;&#125;."</span>)</div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>context = Context(&#123;<span class="string">"my_name"</span>: <span class="string">"Adrian"</span>&#125;)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>template.render(context)</div><div class="line"><span class="string">"My name is Adrian."</span></div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>context = Context(&#123;<span class="string">"my_name"</span>: <span class="string">"Dolores"</span>&#125;)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>template.render(context)</div><div class="line"><span class="string">"My name is Dolores."</span></div></pre></td></tr></table></figure></p>
<p>调用Template的render方法来渲染context。</p>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p>变量只能是字母、数字、下划线、点。<br>点有个特殊的含义，叫做lookup。每次遇到点的时候，template系统就会按照以下此次序进行lookup：</p>
<ul>
<li>字典lookup。例子：foo[‘sdf’]</li>
<li>属性lookup。例子：foo.bar</li>
<li>数组索引lookup。例子：frr[sdf]<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> django.template <span class="keyword">import</span> Context, Template</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>t = Template(<span class="string">"My name is &#123;&#123; person.first_name &#125;&#125;."</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>d = &#123;<span class="string">"person"</span>: &#123;<span class="string">"first_name"</span>: <span class="string">"Joe"</span>, <span class="string">"last_name"</span>: <span class="string">"Johnson"</span>&#125;&#125;</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>t.render(Context(d))</div><div class="line"><span class="string">"My name is Joe."</span></div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">PersonClass</span>:</span> <span class="keyword">pass</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>p = PersonClass()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>p.first_name = <span class="string">"Ron"</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>p.last_name = <span class="string">"Nasty"</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>t.render(Context(&#123;<span class="string">"person"</span>: p&#125;))</div><div class="line"><span class="string">"My name is Ron."</span></div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>t = Template(<span class="string">"The first stooge in the list is &#123;&#123; stooges.0 &#125;&#125;."</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>c = Context(&#123;<span class="string">"stooges"</span>: [<span class="string">"Larry"</span>, <span class="string">"Curly"</span>, <span class="string">"Moe"</span>]&#125;)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>t.render(c)</div><div class="line"><span class="string">"The first stooge in the list is Larry."</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p>当某个变量可以被调用的时候，都会被尝试调用。例如<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">PersonClass2</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">name</span><span class="params">(self)</span>:</span></div><div class="line"><span class="meta">... </span>        <span class="keyword">return</span> <span class="string">"Samantha"</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>t = Template(<span class="string">"My name is &#123;&#123; person.name &#125;&#125;."</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>t.render(Context(&#123;<span class="string">"person"</span>: PersonClass2&#125;))</div><div class="line"><span class="string">"My name is Samantha."</span></div></pre></td></tr></table></figure></p>
<p>可以被调用的变量比直接查找lookup的变量稍微复杂点儿。记住下面几条</p>
<ul>
<li><p>如果返回异常的话，会被传递上去，除非设置了<code>silent_variable_failure</code>为True，设置这个属性的话，当异常发生时，就会使用engine配置的<code>string_if_invalid</code>选项；</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>t = Template(<span class="string">"My name is &#123;&#123; person.first_name &#125;&#125;."</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">PersonClass3</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">first_name</span><span class="params">(self)</span>:</span></div><div class="line"><span class="meta">... </span>        <span class="keyword">raise</span> AssertionError(<span class="string">"foo"</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>p = PersonClass3()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>t.render(Context(&#123;<span class="string">"person"</span>: p&#125;))</div><div class="line">Traceback (most recent call last):</div><div class="line">...</div><div class="line">AssertionError: foo</div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">SilentAssertionError</span><span class="params">(Exception)</span>:</span></div><div class="line"><span class="meta">... </span>    silent_variable_failure = <span class="keyword">True</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="class"><span class="keyword">class</span> <span class="title">PersonClass4</span>:</span></div><div class="line"><span class="meta">... </span>    <span class="function"><span class="keyword">def</span> <span class="title">first_name</span><span class="params">(self)</span>:</span></div><div class="line"><span class="meta">... </span>        <span class="keyword">raise</span> SilentAssertionError</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>p = PersonClass4()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>t.render(Context(&#123;<span class="string">"person"</span>: p&#125;))</div><div class="line"><span class="string">"My name is ."</span></div></pre></td></tr></table></figure>
</li>
<li><p>只能调用无参函数</p>
</li>
<li>显然如果前端能调用的话，就可能发生side effect，所以要确保措施。比如</li>
</ul>
<p>要解决这个问题，就需要在敏感方法上加上<code>alters_data</code>属性，django默认动态生成的model对象都自动设置了这个属性<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">sensitive_function</span><span class="params">(self)</span>:</span></div><div class="line">    self.database_record.delete()</div><div class="line">sensitive_function.alters_data = <span class="keyword">True</span></div></pre></td></tr></table></figure></p>
<ul>
<li>有时我们想关闭这个属性，那么久告诉template系统不要调用。在这个属性上设置<code>do_not_call_in_templates</code>为True。跟上面的区别是，上面会直接返回<code>string_if_invalid</code>，而这个还是可以访问，但是不能调用，也就是当变量而不是当方法使用。</li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[nodejs学习笔记]]></title>
      <url>/2016/12/05/nodejs%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
      <content type="html"><![CDATA[<p>v8的出现，还有commonjs的规范化使得nodejs提供后台服务成为可能。</p>
<p>两种启动方式：</p>
<ul>
<li>node app.js   不自动更新</li>
<li>supervisor app.js 自动更新，修改后不用重启</li>
</ul>
<hr>
<h2 id="特点"><a href="#特点" class="headerlink" title="特点"></a>特点</h2><ul>
<li><p>默认全部都是异步操作</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">'fs'</span>);</div><div class="line">fs.readFile(<span class="string">'test.file'</span>, <span class="string">'utf-8'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">err, data</span>)</span>&#123;</div><div class="line">    <span class="keyword">if</span> (err) &#123;</div><div class="line">        <span class="built_in">console</span>.log(err);</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">        <span class="built_in">console</span>.log(data);</div><div class="line">    &#125;</div><div class="line">&#125;);</div><div class="line"><span class="built_in">console</span>.log(<span class="string">'end'</span>); <span class="comment">// 这一行会先被打印出来</span></div></pre></td></tr></table></figure>
</li>
<li><p>全部基于事件处理机制，nodejs的所有机制都是围绕事件回调机制完成的。事件的回调函数在执行的过程中，可能会发出IO请求或者emit事件，执行完毕后再返回事件循环</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 声明事件对象</span></div><div class="line"><span class="keyword">var</span> EventEmitter=<span class="built_in">require</span>(<span class="string">'events'</span>).EventEmiiter;</div><div class="line"><span class="keyword">var</span> event = <span class="keyword">new</span> EventEmiiter();</div><div class="line"></div><div class="line"><span class="comment">//注册事件</span></div><div class="line">event.on(<span class="string">'some_event'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">"this is a custom event"</span>);</div><div class="line">&#125;);</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// 3秒钟后触发事件</span></div><div class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    event.emit(<span class="string">'some_event'</span>);</div><div class="line">&#125;, <span class="number">3000</span>);</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="module和package"><a href="#module和package" class="headerlink" title="module和package"></a>module和package</h2><p>nodejs的module可以是js、json或者c++扩展。<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>); <span class="comment">// c++的module</span></div></pre></td></tr></table></figure></p>
<p>exports是模块对外开放的接口<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> name;</div><div class="line">exports.setName = <span class="function"><span class="keyword">function</span>(<span class="params">n</span>)</span>&#123;</div><div class="line">    name = n;</div><div class="line">&#125;</div><div class="line"></div><div class="line">exports.say = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    <span class="built_in">console</span>.log(<span class="string">'name is : '</span> + name);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>require是外部引用模块的接口, 只会引入一次<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> modu1=<span class="built_in">require</span>(<span class="string">'./modu'</span>);</div><div class="line">modu1.setName(<span class="string">'will'</span>);</div><div class="line"><span class="keyword">var</span> modu2=<span class="built_in">require</span>(<span class="string">'./modu'</span>);</div><div class="line">modu2.setName(<span class="string">'william'</span>);</div><div class="line">modu2.say(); <span class="comment">// 会输出william</span></div></pre></td></tr></table></figure></p>
<p>如果我们要每次都弄一个新的对象呢??<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">hello</span>(<span class="params"></span>) </span>&#123;</div><div class="line">    <span class="keyword">var</span> name;</div><div class="line">    <span class="keyword">this</span>.setName = <span class="function"><span class="keyword">function</span>(<span class="params">n</span>)</span>&#123;</div><div class="line">        name = n;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="keyword">this</span>.say = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'name is : '</span> + name);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"><span class="built_in">module</span>.exports = hello;</div></pre></td></tr></table></figure></p>
<p>对应的引入为：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> hello=<span class="built_in">require</span>(<span class="string">'./modu'</span>);</div><div class="line"><span class="keyword">var</span> modu1 = <span class="keyword">new</span> hello();</div><div class="line">modu1.setName(<span class="string">'will'</span>);</div><div class="line"><span class="keyword">var</span> modu2 = <span class="keyword">new</span> hello();</div><div class="line">modu2.setName(<span class="string">'william'</span>);</div><div class="line">modu1.say(); <span class="comment">// 会输出will</span></div><div class="line">modu2.say(); <span class="comment">// 会输出william</span></div></pre></td></tr></table></figure></p>
<h3 id="pacakge"><a href="#pacakge" class="headerlink" title="pacakge"></a>pacakge</h3><p>commonJS规范后，可以发布在npm上</p>
<ul>
<li>package.json在根目录下，没有的话就去找index.js</li>
<li>二进制文件在bin目录下</li>
<li>js代码在lib目录下</li>
<li>测试在test目录</li>
<li>….</li>
</ul>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">// package.json</div><div class="line">&#123;</div><div class="line">    "main" : "./lib/index.js", // 入口</div><div class="line">    "name" : "名",</div><div class="line">    "repositories": "仓库托管地址数据，每个元素要包含type、url、path",</div><div class="line">    "dependencies" : "依赖"</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<hr>
<h2 id="包管理器和代码调试"><a href="#包管理器和代码调试" class="headerlink" title="包管理器和代码调试"></a>包管理器和代码调试</h2><h4 id="包管理器"><a href="#包管理器" class="headerlink" title="包管理器"></a>包管理器</h4><table>
<thead>
<tr>
<th>命令</th>
<th>介绍</th>
</tr>
</thead>
<tbody>
<tr>
<td>npm init</td>
<td>初始化一个package目录，会自动生成规范目录与package.json</td>
</tr>
<tr>
<td>npm install xxx</td>
<td>本地模式安装xxx，将package安装到node_modules目录下</td>
</tr>
<tr>
<td>npm list</td>
<td>查看已经安装的包</td>
</tr>
<tr>
<td>npm help <json></json></td>
<td>查看json的使用</td>
</tr>
<tr>
<td>npm publish</td>
<td>进入到package下执行，发布package到公共库（最好是通过npm init生成的目录规范）</td>
</tr>
<tr>
<td>npm unpublish</td>
<td>取消发布</td>
</tr>
</tbody>
</table>
<p><strong><em>全局安装的包，不能直接require，不会搜索/usr/local/lib/node_modules。只有需要命令行使用的时候才安装全局模式</em></strong></p>
<h4 id="代码调试"><a href="#代码调试" class="headerlink" title="代码调试"></a>代码调试</h4><ol>
<li>node –debug-brk=5858 app.js, 会等待debug连上来</li>
<li>eclipse插件V8 vm里弄一个debug就行了</li>
</ol>
<hr>
<h2 id="全局对象和全局变量"><a href="#全局对象和全局变量" class="headerlink" title="全局对象和全局变量"></a>全局对象和全局变量</h2><p>global是所有全局变量的宿主。</p>
<h4 id="console"><a href="#console" class="headerlink" title="console"></a>console</h4><p>log\error\trace</p>
<h4 id="process"><a href="#process" class="headerlink" title="process"></a>process</h4><p>描述当前进程状态，提供了与os交互的接口。<br>|变量|描述|<br>|—|—|<br>|process.argv|命令行参数，第一个是node，第二是脚本名称，第三个才是参数|<br>|process.stdout|标准输出|<br>|process.stdin|标准输入，需要先process.stdin.resume()|<br>|process.nextTick(callback)|为事件循环设置一个任务|<br>nodejs适合io密集型的应用，而不是计算密集型的应用。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">doSth</span>(<span class="params">args, callback</span>)</span>&#123;</div><div class="line">    sthComplext(args);</div><div class="line">    callback();</div><div class="line">&#125;;</div><div class="line"></div><div class="line">doSth(<span class="string">'123'</span>, <span class="function"><span class="keyword">function</span> <span class="title">onEnd</span>(<span class="params"></span>)</span>&#123;</div><div class="line">    compute();</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>有了process.nextTick后可以写成：<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">doSth</span>(<span class="params">args, callback</span>)</span>&#123;</div><div class="line">    sthComplext(args);</div><div class="line">    process.nextTick(callback); <span class="comment">// 把耗时的两个程序拆成两个事件，提高并行度</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<h2 id="util和EventEmitter"><a href="#util和EventEmitter" class="headerlink" title="util和EventEmitter"></a>util和EventEmitter</h2><h5 id="utilities"><a href="#utilities" class="headerlink" title="utilities"></a>utilities</h5><table>
<thead>
<tr>
<th>api</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>inheris(constructor, superConstructor)</td>
<td>实现对象间原型继承</td>
</tr>
<tr>
<td>inspect()</td>
<td>将任意对象以字符串的形式打印出来</td>
</tr>
</tbody>
</table>
<h5 id="events"><a href="#events" class="headerlink" title="events"></a>events</h5><p>nodejs本身架构就是事件驱动的。<br>EventEmitter的核心就是事件发射与事件监听功能的封装。EventEmitter的每个事件由一个事件或若干个参数组成。对于某个事件，EventEmitter支持若干个事件监听器。事件发生时，事件监听器被依次调用，事件参数作为回调函数的参数传递。<br>|api|描述|<br>|—|—|<br>|EventEmitter.on(event, listener)|为指定事件注册监听器|<br>|EventEmitter.emit()|发射event事件|<br>|EventEmitter.once(event, listener)|监听器只出发一次|<br>|EventEmitter.removeListener(event, listener)|移除监听器|<br>|EventEmitter.removeAllListener(event)|移除所有监听器|</p>
<p>特殊事件error，出错的时候，EventEmitter没有注册相应的监听器，就当做异常，退出程序，打印调用栈。</p>
<p>一般继承EventEmitter来使用它。 </p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[celery笔记]]></title>
      <url>/2016/12/05/celery%E7%AC%94%E8%AE%B0/</url>
      <content type="html"><![CDATA[<p>需求需要异步调用后台执行时间长的任务，而且任务结束后回写一些status到数据库。</p>
<p>开始的时候，在django中使用自己的threadpool：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># !/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding:utf-8 -*-</span></div><div class="line"><span class="string">'''</span></div><div class="line">created by will </div><div class="line">'''</div><div class="line"><span class="keyword">import</span> Queue</div><div class="line"><span class="keyword">import</span> logging</div><div class="line"><span class="keyword">import</span> subprocess</div><div class="line"><span class="keyword">import</span> threading</div><div class="line"><span class="keyword">import</span> time, os</div><div class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone</div><div class="line"><span class="keyword">from</span> subprocess <span class="keyword">import</span> Popen</div><div class="line"></div><div class="line"><span class="keyword">from</span> metamap.models <span class="keyword">import</span> Executions</div><div class="line"></div><div class="line"><span class="keyword">from</span> metamap.utils <span class="keyword">import</span> enums</div><div class="line"></div><div class="line">logger = logging.getLogger(<span class="string">'django'</span>)</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WorkManager</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, work_num=<span class="number">1000</span>, thread_num=<span class="number">2</span>)</span>:</span></div><div class="line">        self.work_queue = Queue.Queue()</div><div class="line">        self.threads = []</div><div class="line">        <span class="comment"># self.__init_work_queue(work_num)</span></div><div class="line">        self.__init_thread_pool(thread_num)</div><div class="line"></div><div class="line">    <span class="string">"""</span></div><div class="line">      初始化线程</div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init_thread_pool</span><span class="params">(self, thread_num)</span>:</span></div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(thread_num):</div><div class="line">            self.threads.append(Work(self.work_queue))</div><div class="line"></div><div class="line">    <span class="string">"""</span></div><div class="line">      初始化工作队列</div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init_work_queue</span><span class="params">(self, jobs_num)</span>:</span></div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(jobs_num):</div><div class="line">            self.add_job(do_job, i)</div><div class="line"></div><div class="line">    <span class="string">"""</span></div><div class="line">      添加一项工作入队</div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">add_job</span><span class="params">(self, func, *args)</span>:</span></div><div class="line">        self.work_queue.put((func, list(args)))  <span class="comment"># 任务入队，Queue内部实现了同步机制</span></div><div class="line"></div><div class="line">    <span class="string">"""</span></div><div class="line">      检查剩余队列任务</div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">check_queue</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">return</span> self.work_queue.qsize()</div><div class="line"></div><div class="line">    <span class="string">"""</span></div><div class="line">      等待所有线程运行完毕</div><div class="line">    """</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">wait_allcomplete</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">for</span> item <span class="keyword">in</span> self.threads:</div><div class="line">            <span class="keyword">if</span> item.isAlive(): item.join()</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Work</span><span class="params">(threading.Thread)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, work_queue)</span>:</span></div><div class="line">        threading.Thread.__init__(self)</div><div class="line">        self.work_queue = work_queue</div><div class="line">        self.start()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment"># 死循环，从而让创建的线程在一定条件下关闭退出</span></div><div class="line">        <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">            location = <span class="string">''</span></div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                do, args = self.work_queue.get_nowait()  <span class="comment"># 任务异步出队，Queue内部实现了同步机制</span></div><div class="line">                logger.info(<span class="string">'%s method '</span> % do)</div><div class="line">                logger.info(<span class="string">'%s find job ....... %s '</span> % (self.getName(), <span class="string">''</span>.join(args[<span class="number">0</span>])))</div><div class="line">                returncode = do(args)</div><div class="line">                self.work_queue.task_done()  <span class="comment"># 通知系统任务完成</span></div><div class="line">                location = <span class="string">''</span>.join(args[<span class="number">1</span>])</div><div class="line">                execution = Executions.objects.get(logLocation=location)</div><div class="line">                execution.end_time = timezone.now()</div><div class="line">                logger.info(<span class="string">'%s return code is %d'</span> % (self.getName(), returncode))</div><div class="line">                <span class="keyword">if</span> returncode == <span class="number">0</span>:</div><div class="line">                    execution.status = enums.EXECUTION_STATUS.DONE</div><div class="line">                <span class="keyword">else</span>:</div><div class="line">                    execution.status = enums.EXECUTION_STATUS.FAILED</div><div class="line">                execution.save()</div><div class="line">            <span class="keyword">except</span> Queue.Empty:</div><div class="line">                time.sleep(<span class="number">3</span>)</div><div class="line">            <span class="keyword">except</span> Executions.DoesNotExist:</div><div class="line">                logger.error(<span class="string">'cannot find execution from db for location %s'</span> % location)</div><div class="line">            <span class="keyword">except</span> Exception, e:</div><div class="line">                logger.error(<span class="string">'got error :%s'</span> % str(e))</div><div class="line">                <span class="keyword">break</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># 具体要做的任务</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">do_job</span><span class="params">(*args)</span>:</span></div><div class="line">    logger.debug(args)</div><div class="line">    log = args[<span class="number">0</span>][<span class="number">1</span>]</div><div class="line">    command = args[<span class="number">0</span>][<span class="number">0</span>]</div><div class="line">    p = Popen([<span class="string">''</span>.join(command)], stdout=open(log, <span class="string">'a'</span>), stderr=subprocess.STDOUT, shell=<span class="keyword">True</span>, universal_newlines=<span class="keyword">True</span>)</div><div class="line">    p.wait()</div><div class="line">    <span class="keyword">return</span> p.returncode</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    start = time.time()</div><div class="line">    <span class="comment"># work_manager = WorkManager(10, 3)</span></div><div class="line">    <span class="comment"># work_manager.add_job(do_job, "sh /usr/local/metamap/test.sh")</span></div><div class="line">    <span class="comment"># work_manager.add_job(do_job, "sh /usr/local/metamap/test.sh")</span></div><div class="line">    <span class="keyword">print</span> <span class="string">"doneeeeeeeeeeeeee"</span></div><div class="line">    end = time.time()</div><div class="line">    <span class="keyword">print</span> <span class="string">"cost all time: %s"</span> % (end - start)</div></pre></td></tr></table></figure></p>
<p>遇到两个问题：</p>
<ul>
<li>django项目的manage.py运行的时候，连接池会随着view代码的加载而初始化运行，导致命令不退出，一直hang着</li>
<li>结合gunicorn使用的时候，即便已经完成了django的一次request和response过程，重定向到了任务的状态页面。但是gunicorn任务此次request并未结束，导致worker自认为请求超时自杀，另起worker。比如后台异步任务在连接池中需要执行400s，而gunicorn的请求超时时间是300s，那么到了300s的时候当前worker的进程就被kill，然后另起一个新的worker。那么后台的线程池里执行的这个任务就也随着worker的退出被中止了。</li>
</ul>
<p>问了一些大神的意见， 推荐给我celery。尝试django-celery未成功，所以就使用了原生的celery，解决了以上问题。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[django中使用视图]]></title>
      <url>/2016/12/05/django%E4%B8%AD%E4%BD%BF%E7%94%A8%E8%A7%86%E5%9B%BE/</url>
      <content type="html"><![CDATA[<p>最近在做数据地图之类的东西，要对hive的meta库进行一些查询与分析之类的。但是hive的字段表、tbls表、dbs表设计的有些鸡肋。中间隔了sds、cds表，所以查询非常费劲，就考虑搞一个视图，然后利用django的models直接进行orm的只读操作。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">OR</span> <span class="keyword">REPLACE</span> <span class="keyword">VIEW</span> col_tbl_db_view <span class="keyword">AS</span> </div><div class="line"><span class="keyword">SELECT</span></div><div class="line">    <span class="number">1</span> <span class="keyword">as</span> <span class="keyword">id</span>,</div><div class="line">    db.DB_ID <span class="keyword">as</span> db_id,</div><div class="line">    db.<span class="string">`NAME`</span> <span class="keyword">as</span> db_name,</div><div class="line">    a.TBL_ID <span class="keyword">as</span> tbl_id,</div><div class="line">    a.TBL_NAME <span class="keyword">as</span> tbl_name,</div><div class="line">    a.TBL_TYPE <span class="keyword">as</span> tbl_type,</div><div class="line">    d.TYPE_NAME <span class="keyword">as</span> col_type_name,</div><div class="line">    d.<span class="string">`COMMENT`</span> <span class="keyword">as</span> col_comment,</div><div class="line">    d.COLUMN_NAME <span class="keyword">as</span> col_name</div><div class="line"><span class="keyword">FROM</span></div><div class="line">    TBLS a</div><div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> SDS b <span class="keyword">ON</span> a.SD_ID = b.SD_ID</div><div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> COLUMNS_V2 d <span class="keyword">ON</span> b.CD_ID = d.CD_ID</div><div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> DBS db <span class="keyword">ON</span> a.DB_ID = db.DB_ID</div></pre></td></tr></table></figure>
<p>model代码<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># !/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*</span></div><div class="line"><span class="string">'''</span></div><div class="line">created by will </div><div class="line">'''</div><div class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</div><div class="line"><span class="keyword">import</span> datetime</div><div class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DB</span><span class="params">(models.Model)</span>:</span></div><div class="line">    db_id = models.BigIntegerField(max_length=<span class="number">20</span>, primary_key=<span class="keyword">True</span>)</div><div class="line">    desc = models.CharField(max_length=<span class="number">4000</span>)</div><div class="line">    db_location_uri = models.CharField(max_length=<span class="number">4000</span>)</div><div class="line">    name = models.CharField(max_length=<span class="number">128</span>)</div><div class="line">    owner_name = models.CharField(max_length=<span class="number">128</span>)</div><div class="line">    owner_type = models.CharField(max_length=<span class="number">10</span>)</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        managed = <span class="keyword">False</span></div><div class="line">        db_table = <span class="string">'DBS'</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TBL</span><span class="params">(models.Model)</span>:</span></div><div class="line">    tbl_id = models.BigIntegerField(max_length=<span class="number">20</span>, primary_key=<span class="keyword">True</span>)</div><div class="line">    create_time = models.DateTimeField</div><div class="line">    owner = models.CharField(max_length=<span class="number">767</span>)</div><div class="line">    tbl_name = models.CharField(max_length=<span class="number">128</span>)</div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        managed = <span class="keyword">False</span></div><div class="line">        db_table = <span class="string">'TBLS'</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ColMeta</span><span class="params">(models.Model)</span>:</span></div><div class="line">    <span class="string">'''</span></div><div class="line">       字段对应meta</div><div class="line">    '''</div><div class="line">    id = models.IntegerField(primary_key=<span class="keyword">True</span>)</div><div class="line">    db = models.ForeignKey(DB, on_delete=models.DO_NOTHING)</div><div class="line">    tbl = models.ForeignKey(TBL, on_delete=models.DO_NOTHING)</div><div class="line">    tbl_type = models.CharField(max_length=<span class="number">30</span>, null=<span class="keyword">True</span>)</div><div class="line">    col_type_name = models.CharField(max_length=<span class="number">300</span>, null=<span class="keyword">True</span>)</div><div class="line">    col_comment = models.CharField(max_length=<span class="number">300</span>, null=<span class="keyword">True</span>)</div><div class="line">    col_name = models.CharField(max_length=<span class="number">300</span>, null=<span class="keyword">True</span>)</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        managed = <span class="keyword">False</span></div><div class="line">        db_table = <span class="string">'col_tbl_db_view'</span></div></pre></td></tr></table></figure></p>
<p>注意几点：</p>
<ul>
<li>由于是只读的model，所以设置了managed=false，这样就不会在migration中对数据库进行任何操作了。</li>
<li>对于hive的meta库我们只做查询不做修改，也是出于上面的原因，我们把这些代码放在read_models.py里面，这个文件里放置的都是对既有数据库的只读操作的model。</li>
<li>使用view的时候注意几点<ul>
<li>django的模板遍历结果的时候会使用到model的主键，当model里面没有指定某个字段是主键的时候，会自动生成一个id字段作为主键。这时，view里并没有id这个字段就会报错了。所以我们需要一个row_number()之类的东西，但是mysql不支持此种东西。所以尝试了一下把所有的id都弄成1，然后在model里面指定primary_key为id，结果成功。以此，推测，django template在遍历context里的变量的时候并不会判断主键是否唯一，也不是以主键为索引去抽取数据。</li>
<li>在foreignkey的地方，一定要加上on_delete=models.DO_NOTHING。防止对表里的数据有任何的级联影响</li>
<li>指定db_table为view的名字</li>
<li>虽然明知会报错，但是不要调用save或者update之类的方法</li>
<li>在运行makemigrations的时候，并不会包含创建视图的sql语句，因为managed=false。我们需要手动加到0001_initial.py里面去。<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">migrations.RunSQL(</div><div class="line">    <span class="string">"""</span></div><div class="line">    CREATE OR REPLACE VIEW col_tbl_db_view AS </div><div class="line">    SELECT</div><div class="line">        1 as id,</div><div class="line">        db.DB_ID as db_id,</div><div class="line">        db.`NAME` as db_name,</div><div class="line">        a.TBL_ID as tbl_id,</div><div class="line">        a.TBL_NAME as tbl_name,</div><div class="line">        a.TBL_TYPE as tbl_type,</div><div class="line">        d.TYPE_NAME as col_type_name,</div><div class="line">        d.`COMMENT` as col_comment,</div><div class="line">        d.COLUMN_NAME as col_name</div><div class="line">    FROM</div><div class="line">        TBLS a</div><div class="line">    LEFT JOIN SDS b ON a.SD_ID = b.SD_ID</div><div class="line">    LEFT JOIN COLUMNS_V2 d ON b.CD_ID = d.CD_ID</div><div class="line">    LEFT JOIN DBS db ON a.DB_ID = db.DB_ID</div><div class="line">    """</div><div class="line">),</div><div class="line">...</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p>参考： <a href="https://blog.rescale.com/using-database-views-in-django-orm/" target="_blank" rel="external">https://blog.rescale.com/using-database-views-in-django-orm/</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[celery数据库事务问题]]></title>
      <url>/2016/12/05/celery%E6%95%B0%E6%8D%AE%E5%BA%93%E4%BA%8B%E5%8A%A1%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<p>我的场景跟官网的例子基本类似，就是单个事务中需要，先创建一个对象，之后执行异步任务，这个异步任务里又要更新这个新建的对象。</p>
<p>理论上，如果任何一步出问题的话，就应该回滚全部。但是官网给的解释，目前不是这样的：</p>
<p>view代码：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django <span class="keyword">import</span> forms</div><div class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponseRedirect</div><div class="line"><span class="keyword">from</span> django.template.context <span class="keyword">import</span> RequestContext</div><div class="line"><span class="keyword">from</span> django.shortcuts <span class="keyword">import</span> get_object_or_404, render_to_response</div><div class="line"></div><div class="line"><span class="keyword">from</span> blog <span class="keyword">import</span> tasks</div><div class="line"><span class="keyword">from</span> blog.models <span class="keyword">import</span> Comment</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">CommentForm</span><span class="params">(forms.ModelForm)</span>:</span></div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        model = Comment</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add_comment</span><span class="params">(request, slug, template_name=<span class="string">'comments/create.html'</span>)</span>:</span></div><div class="line">    post = get_object_or_404(Entry, slug=slug)</div><div class="line">    remote_addr = request.META.get(<span class="string">'REMOTE_ADDR'</span>)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'post'</span>:</div><div class="line">        form = CommentForm(request.POST, request.FILES)</div><div class="line">        <span class="keyword">if</span> form.is_valid():</div><div class="line">            <span class="comment"># 这里创建对象，对DB有了插入操作</span></div><div class="line">            comment = form.save()</div><div class="line">            <span class="comment"># 异步方法的调用</span></div><div class="line">            tasks.spam_filter.delay(comment_id=comment.id,</div><div class="line">                                    remote_addr=remote_addr)</div><div class="line">            <span class="keyword">return</span> HttpResponseRedirect(post.get_absolute_url())</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        form = CommentForm()</div><div class="line"></div><div class="line">    context = RequestContext(request, &#123;<span class="string">'form'</span>: form&#125;)</div><div class="line">    <span class="keyword">return</span> render_to_response(template_name, context_instance=context)</div></pre></td></tr></table></figure></p>
<p>task代码：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</div><div class="line"></div><div class="line"><span class="keyword">from</span> akismet <span class="keyword">import</span> Akismet</div><div class="line"></div><div class="line"><span class="keyword">from</span> django.core.exceptions <span class="keyword">import</span> ImproperlyConfigured</div><div class="line"><span class="keyword">from</span> django.contrib.sites.models <span class="keyword">import</span> Site</div><div class="line"></div><div class="line"><span class="keyword">from</span> blog.models <span class="keyword">import</span> Comment</div><div class="line"></div><div class="line"></div><div class="line">app = Celery(broker=<span class="string">'amqp://'</span>)</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@app.task</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">spam_filter</span><span class="params">(comment_id, remote_addr=None)</span>:</span></div><div class="line">    logger = spam_filter.get_logger()</div><div class="line">    logger.info(<span class="string">'Running spam filter for comment %s'</span>, comment_id)</div><div class="line"></div><div class="line">     <span class="comment"># 可以看到异步方法调用依赖于前面对象的创建</span></div><div class="line">    comment = Comment.objects.get(pk=comment_id)</div><div class="line">    current_domain = Site.objects.get_current().domain</div><div class="line">    akismet = Akismet(settings.AKISMET_KEY,</div><div class="line">                      <span class="string">'http://&#123;0&#125;'</span>.format(current_domain))</div><div class="line">    <span class="keyword">if</span> <span class="keyword">not</span> akismet.verify_key():</div><div class="line">        <span class="keyword">raise</span> ImproperlyConfigured(<span class="string">'Invalid AKISMET_KEY'</span>)</div><div class="line"></div><div class="line"></div><div class="line">    is_spam = akismet.comment_check(user_ip=remote_addr,</div><div class="line">                        comment_content=comment.comment,</div><div class="line">                        comment_author=comment.name,</div><div class="line">                        comment_author_email=comment.email_address)</div><div class="line">    <span class="keyword">if</span> is_spam:</div><div class="line">        comment.is_spam = <span class="keyword">True</span></div><div class="line">        <span class="comment"># 异步方法调用完成后，会基于前面创建的对象，再次操作数据库对象</span></div><div class="line">        comment.save()</div><div class="line"></div><div class="line">    <span class="keyword">return</span> is_spam</div></pre></td></tr></table></figure></p>
<p>这明显是已经破坏了这个事务的原子性的，虽然目前本人的代码也是这样的。</p>
<p>上面还有一段另外的写法：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@transaction.commit_manually</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_article</span><span class="params">(request)</span>:</span></div><div class="line">    <span class="keyword">try</span>:</div><div class="line">        article = Article.objects.create(…)</div><div class="line">    <span class="keyword">except</span>:</div><div class="line">        transaction.rollback()</div><div class="line">        <span class="keyword">raise</span></div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        transaction.commit()</div><div class="line">        expand_abbreviations.delay(article.pk)</div></pre></td></tr></table></figure></p>
<p>为什么要这样呢？为了避免race condition。也就是异步方法调用先于数据库插入操作的话，异步方法里就直接报错了，所以必须在调用异步方法之前就commit当前的事务。针对性的代码示例如下：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> transaction</div><div class="line"></div><div class="line"><span class="meta">@transaction.commit_on_success</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">create_article</span><span class="params">(request)</span>:</span></div><div class="line">    article = Article.objects.create(…)</div><div class="line">    expand_abbreviations.delay(article.pk)</div></pre></td></tr></table></figure></p>
<p>理论上来说，调用异步方法的时候这个article就是还没有创建的，因为是分离在两个进程的代码，所以异步方法中查不到这个article，就出现了race condition问题。</p>
<p>还有一点需要注意的是，在django中调用异步方法的时候，也不要以models里面的对象作为参数。如果需要这些对象，应该每次都去db里去查，否则也有可能面临race condition问题。</p>
<p><strong>但是事务性怎么办！！！</strong></p>
<p>参考：<a href="http://docs.celeryproject.org/en/latest/userguide/tasks.html#database-transactions" target="_blank" rel="external">http://docs.celeryproject.org/en/latest/userguide/tasks.html#database-transactions</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[djcelery定时任务坑记]]></title>
      <url>/2016/12/05/djcelery%E5%AE%9A%E6%97%B6%E4%BB%BB%E5%8A%A1%E5%9D%91%E8%AE%B0/</url>
      <content type="html"><![CDATA[<p>celery实现定时任务，原生是通过后台的配置文件settings里配置添加的。形如：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">CELERYBEAT_SCHEDULE = &#123;</div><div class="line">    <span class="string">'add-every-30-seconds'</span>: &#123;</div><div class="line">        <span class="string">'task'</span>: <span class="string">'tasks.add'</span>,</div><div class="line">        <span class="string">'schedule'</span>: timedelta(seconds=<span class="number">30</span>),</div><div class="line">        <span class="string">'args'</span>: (<span class="number">16</span>, <span class="number">16</span>)</div><div class="line">    &#125;,</div><div class="line">    <span class="string">'add-every-30-seconds'</span>: &#123;</div><div class="line">        <span class="string">'task'</span>: <span class="string">'tasks.add'</span>,</div><div class="line">        <span class="string">'schedule'</span>: timedelta(seconds=<span class="number">30</span>),</div><div class="line">        <span class="string">'args'</span>: (<span class="number">16</span>, <span class="number">16</span>)</div><div class="line">    &#125;,</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>每增加或修改或删除都要重新修改这个文件，并且重启beat才能生效。不友好</p>
<p>djcelery结合mysql，将定时任务的配置放进mysql，然后自己实现了一个beat服务，每次定时扫描mysql里最新的定时任务信息，来调度任务，默认扫描间隔是5s。</p>
<p>挺好，它还提供了一个admin界面来添加定时任务。</p>
<p>我们需要的是一个自由增删改查任务的功能，暴露给编写任务并设定任务执行周期的数据分析人员。所以需要在djcelery的基础之上再稍微加一些自定义的实现：为了与现有任务融合，在periodTask模型上添加了一个我们自定义任务WillTask的外键。</p>
<p>中间遇到问题：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">定义一个定时任务periodTask1，然后修改只修改cron到10分钟以后，结果到了时间竟然没有调度。</div><div class="line"></div><div class="line">到admin界面同样操作了一下，能够触发最新配置的调度。</div></pre></td></tr></table></figure></p>
<p>观察beat的日志，发现它总是查询djcelery_periodictasks里的内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure></p>
<p>然后就注意观察了一下，发现在admin里操作更改任务的cron的时候，djcelery_periodictasks里的last_update字段会更新。而我自己修改的话就不会更新。</p>
<p>修改逻辑，每次对task进行修改都去更新djcelery_periodictasks里的last_update字段为当前时间。 —— 成功。</p>
<p>找网友@周星星对了一下，他是使用的djcelery的master 3.2.0a分支，不存在这个问题。</p>
<p>他的代码：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">target_task = PeriodicTask.objects.get(name=<span class="string">'test_1338'</span>)</div><div class="line">crontab = CrontabSchedule.objects.create(minute=<span class="string">'*/2'</span>)</div><div class="line">crontab.save()</div><div class="line">target_task.crontab = crontab</div><div class="line">target_task.args = <span class="string">'[1, 888888888, "1??99999???"]'</span></div><div class="line">result = target_task.save()</div><div class="line"><span class="keyword">return</span> HttpResponse(result, content_type=<span class="string">'text/json'</span>)</div></pre></td></tr></table></figure></p>
<p>可以看到他是每次都新建的，中间我也尝试了新建cron，但是结果还是同上。鉴于程序严密性，又改回了修改cron。</p>
<p>我当前的代码：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">task = WillDependencyTask.objects.get(pk=pk)</div><div class="line">httputils.post2obj(task, request.POST, <span class="string">'id'</span>)</div><div class="line">task.save()</div><div class="line"></div><div class="line">cron_task = PeriodicTask.objects.get(willtask_id=pk)</div><div class="line">cron_task.name = task.name</div><div class="line">cron_task.save()</div><div class="line"></div><div class="line">cron = DjceleryCrontabschedule.objects.get(pk=cron_task.crontab_id)</div><div class="line">cron.minute, cron.hour, cron.day_of_month, cron.month_of_year, cron.day_of_week = cronhelper.cron_from_str(</div><div class="line">    request.POST[<span class="string">'cronexp'</span>])</div><div class="line">cron.save()</div><div class="line"></div><div class="line"><span class="comment"># 这里是多出来的地方</span></div><div class="line">tasks = DjceleryPeriodictasks.objects.get(ident=<span class="number">1</span>)</div><div class="line">tasks.last_update = timezone.now()</div><div class="line">tasks.save()</div></pre></td></tr></table></figure></p>
<p>所以初步确认为版本问题。我使用的是djcelery3.1.17。</p>
<p>参考：</p>
<ul>
<li><a href="http://docs.celeryproject.org/en/latest/userguide/periodic-tasks.html" target="_blank" rel="external">http://docs.celeryproject.org/en/latest/userguide/periodic-tasks.html</a></li>
<li><a href="https://github.com/celery/django-celery" target="_blank" rel="external">https://github.com/celery/django-celery</a></li>
<li></li>
</ul>
<h2 id="传送长数据串出错"><a href="#传送长数据串出错" class="headerlink" title="传送长数据串出错"></a>传送长数据串出错</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="meta">@transaction.atomic</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">exec_job</span><span class="params">(request, sqoopid)</span>:</span></div><div class="line">    sqoop = SqoopHive2Mysql.objects.get(id=sqoopid)</div><div class="line">    location = AZKABAN_SCRIPT_LOCATION + dateutils.now_datetime() + <span class="string">'-sqoop-'</span> + sqoop.name + <span class="string">'.log'</span></div><div class="line">    command = etlhelper.generate_sqoop_hive2mysql(sqoop)</div><div class="line">    execution = SqoopHive2MysqlExecutions(logLocation=location, job_id=sqoopid, status=<span class="number">0</span>)</div><div class="line">    execution.save()</div><div class="line">    <span class="keyword">from</span> metamap <span class="keyword">import</span> tasks</div><div class="line">    tasks.exec_sqoop.delay(command, location)</div><div class="line">    <span class="keyword">return</span> redirect(<span class="string">'metamap:sqoop_execlog'</span>, execid=execution.id)</div></pre></td></tr></table></figure>
<p>command再这里打印是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sqoop export  --connect jdbc:mysql://120.55.176.18:5306/product?useCursorFetch=true&amp;dontTrackOpenResources=true&amp;defaultFetchSize=2000 --driver com.mysql.jdbc.Driver --username xmanread --password LtLUGkNbr84UWXglBFYe4GuMX8EJXeIG  --input-fields-terminated-by &quot;\t&quot;    --update-key  create_date,period,type,channel_id,bank_name,platform,status_id,return_status,channel_id,bank_name,platform,status_id,return_status,number_order,amount_order  --update-mode  allowinsert  --columns  create_date,end_date,period,type,channel_id,bank_name,platform,status_id,return_status,number_order,amount_order  --export-dir  hdfs://namenode01.will.com:8020/apps/hive/warehouse/dim_payment.db/order_detail/log_type=1/log_period=1/log_create_date=2016-12-06  --table  JLC_ORDER_DETAIL_APP  --verbose</div></pre></td></tr></table></figure></p>
<p>在task执行的时候打印出来是：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">sqoop export  --connect jdbc:mysql://120.55.176.18:5306/product?useCursorFetch=true&amp;dontTrackOpenResources=true&amp;defaultFetchSize=2000 --driver com.my xmanread --password LtLUGkNbr84UWXglBFYe4GuMX8EJXeIG  --input-fields-terminated-by &quot;\t&quot;    --update-key  create_date,period,type,channel_id,bank_name,platform,status_id,return_status,channel_id,bank_name,platform,status_id,return_status,number_order,amount_order  --update-mode  allowinsert  --columns  create_date,end_date,period,type,channel_id,bank_name,platform,status_id,return_status,number_order,amount_order  --export-dir  hdfs://namenode01.will.com:8020/apps/hive/warehouse/dim_payment.db/order_detail/log_type=1/log_period=1/log_create_date=2016-12-06  --table  JLC_ORDER_DETAIL_APP  --verbose , location is /var/azkaban-metamap/20161208062420-sqoop-export_JLC_ORDER_DETAIL_APP.log</div></pre></td></tr></table></figure></p>
<p>driver那里莫名就消失了。</p>
<p>后来发现是由于windows里的换行符导致的。</p>
<h2 id="celery-beat不触发定时任务"><a href="#celery-beat不触发定时任务" class="headerlink" title="celery beat不触发定时任务"></a>celery beat不触发定时任务</h2><p><strong>注意时区，妈蛋！！</strong></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[django-celery坑记]]></title>
      <url>/2016/12/05/django-celery%E5%9D%91%E8%AE%B0/</url>
      <content type="html"><![CDATA[<p>安装django-celery花了好长时间，因为网上一些资料都不是最新版本，缺失一些配置。这里自己再整理一下整体的步骤。</p>
<h4 id="1-安装："><a href="#1-安装：" class="headerlink" title="1.安装："></a>1.安装：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install django-celery</div></pre></td></tr></table></figure>
<h4 id="2-settings文件"><a href="#2-settings文件" class="headerlink" title="2. settings文件"></a>2. settings文件</h4><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">INSTALLED_APPS = [</div><div class="line">    <span class="string">'metamap'</span>,</div><div class="line">    <span class="string">'django.contrib.admin'</span>,</div><div class="line">    <span class="string">'django.contrib.auth'</span>,</div><div class="line">    <span class="string">'django.contrib.contenttypes'</span>,</div><div class="line">    <span class="string">'django.contrib.sessions'</span>,</div><div class="line">    <span class="string">'django.contrib.messages'</span>,</div><div class="line">    <span class="string">'django.contrib.staticfiles'</span>,</div><div class="line">    <span class="string">'djcelery'</span>,</div><div class="line">]</div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">import</span> djcelery</div><div class="line">djcelery.setup_loader()</div><div class="line"></div><div class="line"><span class="comment"># 用于存放task</span></div><div class="line">BROKER_URL = <span class="string">'redis://localhost:6379'</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment"># Celery Beat 设置</span></div><div class="line">CELERYBEAT_SCHEDULER = <span class="string">'djcelery.schedulers.DatabaseScheduler'</span></div></pre></td></tr></table></figure>
<p>注意一下，这里的INSTALLED_APPS，在<a href="https://docs.djangoproject.com/en/1.9/intro/tutorial02/" target="_blank" rel="external">django1.9版本的官方文档</a>中，是说写成<code>metamap.apps.MetamapConfig</code>的。但是写成这种的话，下面自动发现task的时候就会找不到。可以理解成是djcelery暂时还没有追上django版本的脚步，好在django兼容了以前版本，我们写成metamap也不会影响django1.9版本的运行。</p>
<h4 id="3-celery启动"><a href="#3-celery启动" class="headerlink" title="3. celery启动"></a>3. celery启动</h4><p>启动celery的文件，有些博客少了这个主要部分。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># !/usr/bin/env python</span></div><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</div><div class="line"></div><div class="line"><span class="keyword">import</span> os</div><div class="line"></div><div class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</div><div class="line"></div><div class="line"><span class="comment"># set the default Django settings module for the 'celery' program.</span></div><div class="line">os.environ.setdefault(<span class="string">'DJANGO_SETTINGS_MODULE'</span>, <span class="string">'metamap_django.settings'</span>)</div><div class="line"></div><div class="line"><span class="keyword">from</span> django.conf <span class="keyword">import</span> settings</div><div class="line"></div><div class="line">app = Celery(<span class="string">'metamap_django'</span>)</div><div class="line"></div><div class="line"><span class="comment"># Using a string here means the worker will not have to</span></div><div class="line"><span class="comment"># pickle the object when using Windows.</span></div><div class="line"><span class="comment"># 可以发现，这里有一个自动发现task的配置，就是针对settings里的INSTALLED_APPS，这里我们的目标是metamap</span></div><div class="line"><span class="comment"># 找到metamap后，会自动找下面的tasks.py文件，扫描里面的task</span></div><div class="line">app.config_from_object(<span class="string">'django.conf:settings'</span>)</div><div class="line">app.autodiscover_tasks(<span class="keyword">lambda</span>: settings.INSTALLED_APPS) </div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@app.task(bind=True)</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">debug_task</span><span class="params">(self)</span>:</span></div><div class="line">    print(<span class="string">'Request: &#123;0!r&#125;'</span>.format(self.request))</div></pre></td></tr></table></figure></p>
<h4 id="4-启动celery"><a href="#4-启动celery" class="headerlink" title="4. 启动celery"></a>4. 启动celery</h4><p>在metamap/<strong>init</strong>.py里引入celery_app:<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</div><div class="line"></div><div class="line"><span class="comment"># This will make sure the app is always imported when</span></div><div class="line"><span class="comment"># Django starts so that shared_task will use this app.</span></div><div class="line"><span class="keyword">from</span> .celery <span class="keyword">import</span> app <span class="keyword">as</span> celery_app</div></pre></td></tr></table></figure></p>
<h4 id="5-tasks-py"><a href="#5-tasks-py" class="headerlink" title="5. tasks.py"></a>5. tasks.py</h4><p>放到app的根目录下面，我的是metamap/tasks.py：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># !/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*</span></div><div class="line"><span class="string">'''</span></div><div class="line">created by will</div><div class="line">'''</div><div class="line"></div><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</div><div class="line"></div><div class="line"><span class="keyword">import</span> logging</div><div class="line"><span class="keyword">import</span> subprocess</div><div class="line"></div><div class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> shared_task, task</div><div class="line"><span class="keyword">from</span> django.utils <span class="keyword">import</span> timezone</div><div class="line"></div><div class="line"><span class="keyword">from</span> metamap.models <span class="keyword">import</span> ETL, Executions</div><div class="line"><span class="keyword">from</span> metamap.utils <span class="keyword">import</span> enums</div><div class="line"></div><div class="line"><span class="keyword">from</span> celery.utils.log <span class="keyword">import</span> get_task_logger</div><div class="line"></div><div class="line">logger = get_task_logger(__name__)</div><div class="line"></div><div class="line"><span class="meta">@task</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">xx</span><span class="params">()</span>:</span></div><div class="line">    <span class="keyword">return</span> <span class="string">'sdfsdf'</span></div><div class="line"></div><div class="line"><span class="meta">@shared_task</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></div><div class="line">    <span class="keyword">return</span> x + y</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@shared_task</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">mul</span><span class="params">(x, y)</span>:</span></div><div class="line">    <span class="keyword">return</span> x * y</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@shared_task</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">xsum</span><span class="params">(numbers)</span>:</span></div><div class="line">    <span class="keyword">return</span> sum(numbers)</div></pre></td></tr></table></figure></p>
<p>参考：</p>
<ul>
<li><a href="http://www.weiguda.com/blog/73/" target="_blank" rel="external">http://www.weiguda.com/blog/73/</a></li>
<li><a href="https://github.com/hardvic/djcelery_proj" target="_blank" rel="external">https://github.com/hardvic/djcelery_proj</a></li>
<li><a href="https://github.com/celery/django-celery" target="_blank" rel="external">https://github.com/celery/django-celery</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[git--杂记]]></title>
      <url>/2016/12/05/git--%E6%9D%82%E8%AE%B0/</url>
      <content type="html"><![CDATA[<h2 id="配置别名"><a href="#配置别名" class="headerlink" title="配置别名"></a>配置别名</h2><p>编辑~/.gitconfig文件, 添加<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[alias]</div><div class="line">    last = log -1</div><div class="line">    co = checkout</div><div class="line">    ci = commit</div><div class="line">    br = branch</div><div class="line">    st = status</div><div class="line">    lg = log --color --graph --pretty=format:&apos;%Cred%h%Creset -%C(yellow)%d%Creset %s %Cgreen(%cr) %C(bold blue)&lt;%an&gt;%Creset&apos; --abbrev-commit</div></pre></td></tr></table></figure></p>
<h2 id="case"><a href="#case" class="headerlink" title="case"></a>case</h2><p>有时本地修改了，然后直接checkout线上的某个branch:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Your local changes to the following files would be overwritten by checkout:</div><div class="line">   app/models/VO/Request/ServiceSchedulerConfigExt.php</div><div class="line">   app/models/purchase/InvoiceApplyModel.php</div></pre></td></tr></table></figure></p>
<p>两个方案:</p>
<ul>
<li>丢掉本地修改： git reset –hard, 之后重新执行</li>
<li>保留本地修改：git stash ： Stash the changes in a dirty working directory away。之后git pull,之后 git stash pop</li>
</ul>
<p><strong>说明</strong>：git stash是当我们对项目进行了修改，但是想在不丢失当前修改的前提下，到commit的某个版本【HEAD】那儿去。这时候调用这个命令，其实相当于调用了git stash save，它会将当前所有的修改存放到一个stash list里去，可以理解为一个队列。当我们到了【HEAD】那里，然后执行git stash pop，就会从stash list里移除最前面的修改信息，并把这个修改应用到当前情境之中，这个修改必须是前面刚刚git stash save存储的。</p>
<h2 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h2><ul>
<li>取消对文件的修改。还原到最近的版本，废弃本地做的修改。git checkout – <file></file></li>
<li>取消已经暂存的文件。即，撤销先前”git add”的操作git reset HEAD <file>…</file></li>
<li>修改最后一次提交。用于修改上一次的提交信息，或漏提交文件等情况。git commit –amend</li>
<li>回退所有内容到上一个版本git reset HEAD^</li>
<li>回退a.py这个文件的版本到上一个版本  git reset HEAD^ a.py  </li>
<li>向前回退到第3个版本  git reset –soft HEAD~3  </li>
<li>将本地的状态回退到和远程的一样  git reset –hard origin/master  </li>
<li>回退到某个版本  git reset 057d  </li>
<li>回退到上一次提交的状态，按照某一次的commit完全反向的进行一次commit.(代码回滚到上个版本，并提交git)git revert HEAD<br>回复git reset –hard之前的数据</li>
<li><p>使用git reflog查看所有的提交记录，</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">1d2b028 HEAD@&#123;0&#125;: reset: moving to 1d2b02818e8fa</div><div class="line">9510636 HEAD@&#123;1&#125;: commit: update pci driver and add network stuff</div><div class="line">1d2b028 HEAD@&#123;2&#125;: commit: update pci driver</div><div class="line">e4e042b HEAD@&#123;3&#125;: commit: add infrastructure of Linux pci driver</div><div class="line">eb7ac57 HEAD@&#123;4&#125;: commit: update i2c driver - add at24 device</div><div class="line">034034f HEAD@&#123;5&#125;: commit: update i2c linux driver - example of mini2440</div><div class="line">17e0bfb HEAD@&#123;6&#125;: commit: add some diagram for i2c driver</div><div class="line">1f382d7 HEAD@&#123;7&#125;: commit: update i2c driver - overview</div></pre></td></tr></table></figure>
<p>  找到对应版本的commit后进行git reset 1d2b028 </p>
</li>
<li><p>删除远程分支上的提交</p>
  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git reset --hard HEAD~1 // 在本地回退一次git提交，会提示回退到那个commit上了</div><div class="line">git push --force //将本地回退强制推送到远程</div></pre></td></tr></table></figure>
</li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[flask笔记1]]></title>
      <url>/2016/12/05/flask%E7%AC%94%E8%AE%B01/</url>
      <content type="html"><![CDATA[<h2 id="instance文件夹"><a href="#instance文件夹" class="headerlink" title="instance文件夹"></a>instance文件夹</h2><p>有时你需要定义一些不能为人所知的配置变量。为此，你会想要把它们从config.py中的其他变量分离出来，并保持在版本控制之外。 你可能要隐藏类似数据库密码和API密钥的秘密，或定义特定于当前机器的参数。 为了让这更加轻松，Flask提供了一个叫instance文件夹的特性。</p>
<p>instance文件夹是根目录的一个子文件夹，包括了一个特定于当前应用实例的配置文件。我们不要把它提交到版本控制中。</p>
<p>以上是copy的别人的代码，引入instance中特定配置文件的方式是<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">app = Flask(__name__)</div><div class="line">app.config.from_object(<span class="string">'config'</span>)</div><div class="line">app.config.from_pyfile(<span class="string">'instance/config.py'</span>)</div></pre></td></tr></table></figure></p>
<p>这样弄的话，就没有instance的概念了<br>但是至少能找到这个配置文件<br>可是flask本身是内置了又instance的概念的…………</p>
<p>我参考的网站都让我配置一个instance的相对路径<code>instance_relative_config</code>或者绝对路径<code>instance_path</code>.它们配置后的期望代码是<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">app = Flask(__name__, instance_relative_config=<span class="keyword">True</span>)</div><div class="line">app.config.from_object(<span class="string">'config'</span>)</div><div class="line">app.config.from_pyfile(<span class="string">'config.py'</span>)</div></pre></td></tr></table></figure></p>
<p>就是会自己把自己置于instance目录下，取相对的config.py文件。</p>
<p>其实不然，我使用flask版本是0.11.1，看的文档是0.10.1的，不知道是不是版本问题。</p>
<p>借助instance中的配置，我们可以在根路径下创建给config包，然后下面分别放置global.py、prod.py、dev.py、test.py，看名字就知道了，一个是全局的，flask加载的时候一定要弄进配置里。但是对于后面的prod.py、dev.py、test.py要加载哪一个？</p>
<p>参考的资料是自己设置一个环境变量APP_CONFIG_FILE，就是在shell环境里去export.<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># yourapp/__init__.py</span></div><div class="line"></div><div class="line">app = Flask(__name__, instance_relative_config=<span class="keyword">True</span>)</div><div class="line">app.config.from_object(<span class="string">'config.default'</span>)</div><div class="line">app.config.from_pyfile(<span class="string">'instance/config.py'</span>) <span class="comment"># 从instance文件夹中加载配置</span></div><div class="line">app.config.from_envvar(<span class="string">'APP_CONFIG_FILE'</span>)</div></pre></td></tr></table></figure></p>
<p>最后这个<code>app.config.from_envvar</code>是从环境变量所代表的文件里加载配置。<br>然后运行的时候<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">APP_CONFIG_FILE=/var/www/app/config/prod.py</div><div class="line">python run.py</div></pre></td></tr></table></figure></p>
<p>我认为也直接在instance里进行配置了。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">app = Flask(__name__)</div><div class="line">app.config.from_object(<span class="string">'config'</span>)</div><div class="line">app.config.from_pyfile(<span class="string">'instance/config.py'</span>)</div><div class="line">app.config.from_pyfile(app.config[<span class="string">'APP_CONFIG_FILE'</span>])</div></pre></td></tr></table></figure></p>
<p>不错的学习网站：</p>
<ul>
<li><a href="https://spacewander.github.io/explore-flask-zh/5-configuration.html" target="_blank" rel="external">https://spacewander.github.io/explore-flask-zh/5-configuration.html</a></li>
<li><a href="http://docs.jinkan.org/docs/flask" target="_blank" rel="external">http://docs.jinkan.org/docs/flask</a></li>
</ul>
<h2 id="蓝图"><a href="#蓝图" class="headerlink" title="蓝图"></a>蓝图</h2><p>参考：</p>
<ul>
<li><a href="http://docs.jinkan.org/docs/flask/blueprints.html#url" target="_blank" rel="external">http://docs.jinkan.org/docs/flask/blueprints.html#url</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[spring-cloud杂记]]></title>
      <url>/2016/12/05/spring-cloud%E6%9D%82%E8%AE%B0/</url>
      <content type="html"><![CDATA[<h2 id="Eureka"><a href="#Eureka" class="headerlink" title="Eureka"></a>Eureka</h2><p>云应用中，服务通常并不长久运行的。我们也不希望记录每个service的IP和port。它的功能有些类似一个DNS服务。</p>
<ul>
<li>发现与定位service</li>
<li>负载均衡</li>
<li>中间件容错</li>
</ul>
<p>看了一些文章， 跟我以前写的smart agent的master和plugin模式基本雷同，就是想master注册自己，挂掉的时候remove掉，定时发送心跳等等。</p>
<p>类似功能的还有Consul</p>
<p><a href="https://github.com/Netflix/eureka/wiki" target="_blank" rel="external">https://github.com/Netflix/eureka/wiki</a></p>
<h2 id="spring-cloud配置文件"><a href="#spring-cloud配置文件" class="headerlink" title="spring cloud配置文件"></a>spring cloud配置文件</h2><p>默认service都是连接8888端口的configserver，要是想修改的话就需要使用bootstrap.properties外部配置文件。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">spring.cloud.config.uri: http://myconfigserver.com</div></pre></td></tr></table></figure>
<p>bootstrap的优先级高于configserver的application配置。</p>
<p><a href="https://cloud.spring.io/spring-cloud-config/spring-cloud-config.html" target="_blank" rel="external">https://cloud.spring.io/spring-cloud-config/spring-cloud-config.html</a></p>
<h2 id="zuul"><a href="#zuul" class="headerlink" title="zuul"></a>zuul</h2><p>地狱的守门怪兽</p>
<ul>
<li>安全认证</li>
<li>动态路由</li>
<li>监视</li>
<li>压测</li>
<li>降载</li>
<li>静态资源处理</li>
<li>多区域</li>
</ul>
<p><a href="https://github.com/Netflix/zuul/wiki" target="_blank" rel="external">https://github.com/Netflix/zuul/wiki</a></p>
<h2 id="zipkin"><a href="#zipkin" class="headerlink" title="zipkin"></a>zipkin</h2><p>分布式中的神捕，对分布式调度的追踪，分布式追踪系统。可获取各个微服务接口调用的延时。基于Google论文<a href="http://research.google.com/pubs/pub36356.html" target="_blank" rel="external">dapper</a>设计完成。</p>
<p>应用的执行耗时数据会保存在zipkin里。zipkin UI也会呈现出每个服务request之间的依赖关系图。特别便于最终错误或者延时问题。</p>
<p>本质其实跟以前我们在云智慧做的工作一样，在request上打标记。</p>
<p>存储可以选择内存、JDBC、Cassandra、ES。</p>
<p><a href="http://zipkin.io/" target="_blank" rel="external">http://zipkin.io/</a><br><a href="http://zipkin.io/pages/architecture.html" target="_blank" rel="external">http://zipkin.io/pages/architecture.html</a></p>
<h2 id="oauth2"><a href="#oauth2" class="headerlink" title="oauth2"></a>oauth2</h2><p>分布式系统中，client与service是交叉访问的，需要解决一个问题：哪些client有权限访问哪些service？解决的方式就是单点登录：所有的请求某个service都需要一个token，这个token由一个统一的中心认证服务提供。我们这里就使用oauth2来做这个中心认证服务。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>configserver为一切service服务，提供各个服务最新的配置信息。</p>
<p>eureka-service提供服务注册与发现。所有的client都来它这里找service，然后再执行RPC请求。</p>
<p>reservation-service是一个服务，通过configserver找到eureka，注册到eureka，提供服务。</p>
<p>reservation-client是一个客户端，先通过configserver找到eureka，找到要请求的reservation-service，再请求具体路径(整个请求可以通过zuul代理实现)。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[django与gunicorn的关系]]></title>
      <url>/2016/12/05/django%E4%B8%8Egunicorn%E7%9A%84%E5%85%B3%E7%B3%BB/</url>
      <content type="html"><![CDATA[<p>为什么需要有gunicorn呢？</p>
<p>总的来说很简单：你需要一些东西来执行python，但是python并不是对于所有类型的request都很适合。</p>
<p>[说明一下: 我是 Gunicorn 的developer]</p>
<p>稍微复杂点儿解释:<br>不管你用什么样的app server，都会有一些upstream都是你的django app不处理的，比如一些静态资源(images/css/js)</p>
<p>这就出现了经典的’三层架构’，可以Google一下<a href="https://upload.wikimedia.org/wikipedia/commons/thumb/5/51/Overview_of_a_three-tier_application_vectorVersion.svg/2000px-Overview_of_a_three-tier_application_vectorVersion.svg.png" target="_blank" rel="external">‘three tier architecture’</a>。就是webserver(比如nginx)负责处理许多静态资源的request。需要动态处理的request会被发送给app server(比如Gunicorn)。最内层的，也就是第三层就是数据层了。</p>
<p>纵观历史典型应用，每一层都应该在不同的主机上。（前两层或许还会占用多个主机，负载均衡之类，比如：5个web server分发请求到两个app server上，查询一个数据库）</p>
<p>最近来说，各种应用形态已经各有各的特点了。小项目其实并非完全用到这三层架构，或者也不用分别运行在很多机器上。也有些方案会把app server与web server集成起来(apache httpd + mod_wsgi, nginx + mod_uwsgi等)。</p>
<p>对于Gunicorn来说，是从Ruby的Unicorn抽取出来，只利用nginx里的代理功能。如果Gunicorn不会直接从互联网接收request，那么我们就不用担心客户端会比较慢。这意味着Gunicorn的处理模型十分的简单。</p>
<p>Gunicorn与nginx的功能分离也允许Gunicorn在不影响总体性能的前提下，使用纯python重写。</p>
<p>具体到底谁处理了HTTP request呢，就是Gunicorn了。其实是Nginx和Gunicorn一起处理的。Nginx接收request，如果他是一个动态的request，就传递给Gunicorn来处理，然后返回一个response给Nginx，然后Nginx再传递给client。</p>
<p>所以，最好是使用nginx和Gunicorn一起部署django项目。如果你只是想让nginx做代理，那么也可以使用Gunicorn、mod_uwsgi、CherryPy等作为django的依赖server。</p>
<p>参考：</p>
<ul>
<li><a href="http://serverfault.com/questions/331256/why-do-i-need-nginx-and-something-like-gunicorn" target="_blank" rel="external">http://serverfault.com/questions/331256/why-do-i-need-nginx-and-something-like-gunicorn</a></li>
<li><a href="http://www.cnblogs.com/ArtsCrafts/p/gunicorn.html" target="_blank" rel="external">http://www.cnblogs.com/ArtsCrafts/p/gunicorn.html</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hive中的权限]]></title>
      <url>/2016/12/05/hive%E4%B8%AD%E7%9A%84%E6%9D%83%E9%99%90/</url>
      <content type="html"><![CDATA[<h2 id="用例"><a href="#用例" class="headerlink" title="用例"></a>用例</h2><ol>
<li>把hive当做存储工具。使用pig、MR等并行计算工具访问hive，hdfs权限通过文件认证来解决。metadata的访问需要通过hive配置的认证。</li>
<li>把hive作为一个查询引擎。又分为两种：</li>
</ol>
<ul>
<li>a. hive命令行。这些用户可以有hdfs权限，也能看到hive的metastore，有点儿像1。</li>
<li>b. jdbc等通过hiveserver2访问。他们不能访问HDFS。</li>
</ul>
<p>三种认证机制。</p>
<h5 id="Storage-Based-Authorization-in-the-Metastore-Server"><a href="#Storage-Based-Authorization-in-the-Metastore-Server" class="headerlink" title="Storage Based Authorization in the Metastore Server"></a>Storage Based Authorization in the Metastore Server</h5><p>在1和2.a里，用户可以直接访问到数据，hive没有控制这块。hdfs权限验证担当了主要任务。当你访问一个database、table、partition的时候，他会检查你是否有对应目录的权限。为了看到通过hiveserver2访问的用户的真实信息，需要设置hive.server2.enable.doAs为true。</p>
<h5 id="SQL-Standards-Based-AuthorizationSQL-Standards-Based-Authorization-in-HiveServer2"><a href="#SQL-Standards-Based-AuthorizationSQL-Standards-Based-Authorization-in-HiveServer2" class="headerlink" title="SQL Standards Based AuthorizationSQL Standards Based Authorization in HiveServer2"></a>SQL Standards Based AuthorizationSQL Standards Based Authorization in HiveServer2</h5><p>虽然Storage Based Authorization可以控制对database、table、partition的访问，但是他不能很好地控制对字段和view的访问，因为他是基于文件系统权限控制的。好的控制应该是可以控制用户访问的行和列。hiveserver2可以满足这种需求，可以只提供你的sql需要的行和列。</p>
<p>SQL Standards Based Authorization是基于sql标准的，可以使用revoke/grant语句控制权限。但是必须在hiveserver2的配置里设置一下。</p>
<p>注意如果启用了SQL Standards Based Authorization，那么2a这种方式就被禁用了。因为安全起见，不可能使用hive里的访问控制策略来控制hive命令行，用户可以直接访问HDFS，这样就直接绕过了认证机制。</p>
<h5 id="Default-Hive-Authorization-Legacy-Mode"><a href="#Default-Hive-Authorization-Legacy-Mode" class="headerlink" title="Default Hive Authorization (Legacy Mode)"></a>Default Hive Authorization (Legacy Mode)</h5><p>这并不能完全控制好权限，会有很多漏洞。例如，没有统一的分配权限的用户，所有的用户都可以自己grant权限。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/Storage+Based+Authorization+in+the+Metastore+Server" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/Storage+Based+Authorization+in+the+Metastore+Server</a></li>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Authorization" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+Authorization</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[django中模型之间的关系]]></title>
      <url>/2016/12/05/django%E4%B8%AD%E6%A8%A1%E5%9E%8B%E4%B9%8B%E9%97%B4%E7%9A%84%E5%85%B3%E7%B3%BB/</url>
      <content type="html"><![CDATA[<h2 id="Many-to-One"><a href="#Many-to-One" class="headerlink" title="Many-to-One"></a>Many-to-One</h2><p>使用<code>django.db.models.ForeignKey</code>来定义，像其他的字段类型一样，额外需要一个指定model类的位置。</p>
<p>例如，有一个Car model，它的生产厂家是Manufacturer，也就是一个厂家对应多个车，但是每个车只属于一个生产厂家。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Manufacturer</span><span class="params">(models.Model)</span>:</span></div><div class="line">    <span class="comment"># ...</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span><span class="params">(models.Model)</span>:</span></div><div class="line">    manufacturer = models.ForeignKey(Manufacturer, on_delete=models.CASCADE)</div><div class="line">    <span class="comment"># ...</span></div></pre></td></tr></table></figure></p>
<p>除此之外，也可以创建<a href="https://docs.djangoproject.com/en/1.9/ref/models/fields/#recursive-relationships" target="_blank" rel="external">递归关系</a>以及<a href="https://docs.djangoproject.com/en/1.9/ref/models/fields/#lazy-relationships" target="_blank" rel="external">未定义模型的关系</a>。详见<a href="https://docs.djangoproject.com/en/1.9/ref/models/fields/#ref-foreignkey" target="_blank" rel="external">此处</a>。</p>
<p>建议把<code>ForeignKey</code>字段设置成目标model的小写形式，弄成别的也不会出错，但是最好规范一些。</p>
<p>对应数据库里面生成的字段名是<code>manufacturer_id</code>，就是在我们定义的属性的名字后面缀上<code>_id</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Car</span><span class="params">(models.Model)</span>:</span></div><div class="line">    company_that_makes_it = models.ForeignKey(</div><div class="line">        Manufacturer,</div><div class="line">        on_delete=models.CASCADE,</div><div class="line">    )</div><div class="line">    <span class="comment"># ...</span></div></pre></td></tr></table></figure>
<p>更多<a href="https://docs.djangoproject.com/en/1.9/topics/db/examples/many_to_one/" target="_blank" rel="external">实例</a></p>
<h2 id="Many-To-Many"><a href="#Many-To-Many" class="headerlink" title="Many-To-Many"></a>Many-To-Many</h2><p>使用<a href="https://docs.djangoproject.com/en/1.9/ref/models/fields/#django.db.models.ManyToManyField" target="_blank" rel="external"><code>ManyToManyField</code></a>关键字定义多对多关系。</p>
<p>例如，一个Pizza有多个Topping，一个Topping也可以放在多个pizza上。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Topping</span><span class="params">(models.Model)</span>:</span></div><div class="line">    <span class="comment"># ...</span></div><div class="line">    <span class="keyword">pass</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pizza</span><span class="params">(models.Model)</span>:</span></div><div class="line">    <span class="comment"># ...</span></div><div class="line">    toppings = models.ManyToManyField(Topping)</div></pre></td></tr></table></figure>
<p>以上无论哪个对象里放置<code>ManyToManyFiled</code>都可以，但是只能放在其中一个里面，不能都放。</p>
<p>两者的互相访问<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">pizza.toppings</div><div class="line">topping.pizza_set</div></pre></td></tr></table></figure></p>
<p>更多<a href="https://docs.djangoproject.com/en/1.9/topics/db/examples/many_to_many/" target="_blank" rel="external">实例</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[数据挖据DW整理]]></title>
      <url>/2016/12/05/%E6%95%B0%E6%8D%AE%E6%8C%96%E6%8D%AEDW%E6%95%B4%E7%90%86/</url>
      <content type="html"><![CDATA[<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">【金奖】https://github.com/Honlan/ppd-magic-mirror</div><div class="line"></div><div class="line">OMNIRank     https://github.com/wang-haiyang/ppd_model</div><div class="line"></div><div class="line"> 【银奖】https://github.com/palladino1/NiuwaBigData</div><div class="line"></div><div class="line"> 【铜奖】https://github.com/miaofu/WebDataProduct</div><div class="line"></div><div class="line">【铜奖】https://github.com/wepe/PPD_RiskControlCompetition</div><div class="line"></div><div class="line"> 【入围奖】https://github.com/Percyzhou/ppdmojing</div></pre></td></tr></table></figure>
<h2 id="文章列表"><a href="#文章列表" class="headerlink" title="文章列表"></a>文章列表</h2><table>
<thead>
<tr>
<th>标题</th>
<th>链接</th>
<th>是否已阅</th>
</tr>
</thead>
<tbody>
<tr>
<td>如何在一年内成为数据挖掘工程师</td>
<td><a href="https://zhuanlan.zhihu.com/p/20766210" target="_blank" rel="external">https://zhuanlan.zhihu.com/p/20766210</a></td>
</tr>
<tr>
<td>用贝叶斯判别分析再次预测股票涨跌情况</td>
<td><a href="http://shujuren.org/article/164.html" target="_blank" rel="external">http://shujuren.org/article/164.html</a></td>
<td></td>
</tr>
<tr>
<td>自然语言处理实战之微博情感偏向分析</td>
<td><a href="http://blog.csdn.net/baimafujinji/article/details/51153872" target="_blank" rel="external">http://blog.csdn.net/baimafujinji/article/details/51153872</a></td>
<td></td>
</tr>
<tr>
<td>Udacity的Deep Learning，来自Google的讲师（附链接）</td>
<td><a href="http://t.cn/R5wsH9U" target="_blank" rel="external">http://t.cn/R5wsH9U</a>  <br> <a href="http://t.cn/R5JA0oQ" target="_blank" rel="external">http://t.cn/R5JA0oQ</a> <br> <a href="https://classroom.udacity.com/courses/ud730/lessons/6370362152/concepts/63798118150923" target="_blank" rel="external">https://classroom.udacity.com/courses/ud730/lessons/6370362152/concepts/63798118150923</a> <br> <a href="https://github.com/tensorflow/tensorflow/blob/master/tensorflow/examples/udacity/1_notmnist.ipynb" target="_blank" rel="external">https://github.com/tensorflow/tensorflow/blob/master/tensorflow/examples/udacity/1_notmnist.ipynb</a></td>
<td></td>
</tr>
<tr>
<td>用Python对金庸系列武侠小说进行文本挖掘</td>
<td><a href="http://chuansong.me/n/399844947454" target="_blank" rel="external">http://chuansong.me/n/399844947454</a></td>
<td></td>
</tr>
<tr>
<td>视频手把手教你用python做机器学习案例</td>
<td><a href="http://www.duweiwen.com/wechat/11ff99ffdddd88.html" target="_blank" rel="external">http://www.duweiwen.com/wechat/11ff99ffdddd88.html</a></td>
<td></td>
</tr>
<tr>
<td>用贝叶斯判别分析再次预测股票涨跌情况</td>
<td><a href="http://shujuren.org/article/164.html" target="_blank" rel="external">http://shujuren.org/article/164.html</a></td>
<td></td>
</tr>
<tr>
<td>文本挖掘分析《欢乐颂》到底谁和谁堪称好闺蜜、谁和谁又最为般配？</td>
<td><a href="http://mp.weixin.qq.com/s?__biz=MzA3MDg0MjgxNQ==&amp;mid=2652389844&amp;idx=1&amp;sn=39e77ca6ea49f84474bf2a50c92a974f&amp;scene=0#wechat_redirect" target="_blank" rel="external">http://mp.weixin.qq.com/s?__biz=MzA3MDg0MjgxNQ==&amp;mid=2652389844&amp;idx=1&amp;sn=39e77ca6ea49f84474bf2a50c92a974f&amp;scene=0#wechat_redirect</a></td>
<td></td>
</tr>
<tr>
<td>数据挖掘工程师的面试问题与答题思路</td>
<td><a href="http://www.idatacamp.com/2016/06/22/%E6%95%B0%E6%8D%AE%E6%8C%96%E6%8E%98%E5%B7%A5%E7%A8%8B%E5%B8%88%E7%9A%84%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98%E4%B8%8E%E7%AD%94%E9%A2%98%E6%80%9D%E8%B7%AF/" target="_blank" rel="external">http://www.idatacamp.com/2016/06/22/%E6%95%B0%E6%8D%AE%E6%8C%96%E6%8E%98%E5%B7%A5%E7%A8%8B%E5%B8%88%E7%9A%84%E9%9D%A2%E8%AF%95%E9%97%AE%E9%A2%98%E4%B8%8E%E7%AD%94%E9%A2%98%E6%80%9D%E8%B7%AF/</a></td>
<td></td>
</tr>
<tr>
<td>玩转数据系列一：图文教你！如何用机器学习玩转人口普查统计</td>
<td><a href="http://toutiao.com/i6291804057988235778/" target="_blank" rel="external">http://toutiao.com/i6291804057988235778/</a> <br>注意这是系列啊</td>
</tr>
</tbody>
</table>
<h2 id="网站收集"><a href="#网站收集" class="headerlink" title=" 网站收集"></a> 网站收集</h2><p> <a href="http://shujuren.org/" target="_blank" rel="external">http://shujuren.org/</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[NFS+autofs]]></title>
      <url>/2016/12/05/NFS+autofs/</url>
      <content type="html"><![CDATA[<h2 id="server端"><a href="#server端" class="headerlink" title="server端"></a>server端</h2><p>安装服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum -y install nfs-utils rpcbind</div></pre></td></tr></table></figure></p>
<p>设置开机启动，并启动服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">chkconfig nfs on</div><div class="line">chkconfig rpcbind on</div><div class="line"></div><div class="line">/etc/init.d/rpcbind restart</div><div class="line">/etc/init.d/nfs restart</div></pre></td></tr></table></figure></p>
<p>编辑nfs主配置文件/etc/exports，添加挂载目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/server/will *(ro,no_root_squash,sync)</div></pre></td></tr></table></figure></p>
<p>这里挂载了/server/will目录，任何机器远程挂载之后都可以访问此目录，只有普通的只读权限。</p>
<p>重新加载主配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@namenode01 will]# exportfs -arv</div><div class="line">exporting *:/server/will</div></pre></td></tr></table></figure></p>
<h2 id="client端"><a href="#client端" class="headerlink" title="client端"></a>client端</h2><p>安装服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">yum install nfs-utils autofs -y</div></pre></td></tr></table></figure></p>
<p>启动服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">chkconfig nfs on</div><div class="line">chkconfig rpcbind on</div><div class="line"></div><div class="line">/etc/init.d/rpcbind restart</div><div class="line">/etc/init.d/nfs restart</div></pre></td></tr></table></figure></p>
<p>查看是否能成功连接NFS服务<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@schedule ~]# showmount -e 10.0.1.72</div><div class="line">Export list for 10.0.1.72:</div><div class="line">/server/will *</div></pre></td></tr></table></figure></p>
<p>这里可以看到可以成功访问。</p>
<p>配置autofs，在/etc/auto.master最后加入：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/server/will /etc/auto.nfs</div></pre></td></tr></table></figure></p>
<p>编辑/etc/auto.nfs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">script   -fstype=nfs                      10.0.1.72:/server/will</div></pre></td></tr></table></figure></p>
<p>重启nfs<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@schedule ~]# service autofs restart</div><div class="line">Loading autofs4:                                           [  OK  ]</div><div class="line">Starting automount:                                        [  OK  ]</div></pre></td></tr></table></figure></p>
<p>测试<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@datanode01 ~]# df</div><div class="line">Filesystem           1K-blocks      Used Available Use% Mounted on</div><div class="line">/dev/mapper/vg_template-lv_root</div><div class="line">                      16070076   6401092   8852652  42% /</div><div class="line">tmpfs                  8167372         0   8167372   0% /dev/shm</div><div class="line">/dev/sda1               495844     31581    438663   7% /boot</div><div class="line">/dev/mapper/luoji-mail</div><div class="line">                     707004512 423592108 247504948  64% /server</div><div class="line">10.0.1.72:/server/will</div><div class="line">                      51606528   1049600  47935488   3% /server/will/script</div></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[express]]></title>
      <url>/2016/12/05/express/</url>
      <content type="html"><![CDATA[<h2 id="app-set-get"><a href="#app-set-get" class="headerlink" title="app.set/get"></a>app.set/get</h2><p>用来查看或者设置一些配置参数</p>
<h2 id="express里变量的换行出不来"><a href="#express里变量的换行出不来" class="headerlink" title="express里变量的换行出不来"></a>express里变量的换行出不来</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/get_log'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">      worker.exec(<span class="string">"cat "</span> + req.query.location, <span class="function"><span class="keyword">function</span> (<span class="params">error, stdout, stderr</span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'stderr : '</span> + stderr);</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'stdout : '</span> + stdout);</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'error : '</span> + error);</div><div class="line">        res.render(<span class="string">'etls/log'</span>, &#123;<span class="attr">stdout</span> : stdout, <span class="attr">log</span> : req.query.location&#125;);</div><div class="line">      &#125;); </div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<p>后面控制台的输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">stderr : </div><div class="line">stdout : # job for mymeta@my_table</div><div class="line"># author : will</div><div class="line"># create time : 19700118070840</div><div class="line"># pre settings </div><div class="line">delete from default.tbl</div><div class="line">select * from batting</div><div class="line">error : null</div></pre></td></tr></table></figure></p>
<p>模板文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#&#123;stdout&#125;</div></pre></td></tr></table></figure></p>
<p>前端输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># job for mymeta@my_table # author : will # create time : 19700118070840 # pre settings delete from default.tbl select * from batting</div></pre></td></tr></table></figure></p>
<p>控制台的stdout变量是换行的，但是前端就不换行。试了一下res.send()，结果也是这样。</p>
<p>模板修改为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">!&#123;stdout.replace(/\n/g, &apos;&lt;br/&gt;&apos;)&#125;</div></pre></td></tr></table></figure></p>
<p>如果使用res.send()的话，就res.send(stdout.replace(/\n/g, ‘<br>‘))就行了。</p>
<p>这个换行支持起来那么难么？比较low的感觉。</p>
<h2 id="body-parser"><a href="#body-parser" class="headerlink" title="body-parser"></a>body-parser</h2><p>安装了body parser之后就可以方便的在req中使用 <code>req.body</code>来获取form内容，使用<code>req.query</code>来获取querystring里的内容了。</p>
<p>但是一定要注意express的app.use是有前后次序的。<code>踩过坑</code></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[azkaban文档翻译]]></title>
      <url>/2016/12/05/azkaban%E6%96%87%E6%A1%A3%E7%BF%BB%E8%AF%91/</url>
      <content type="html"><![CDATA[<h3 id="mysql的作用"><a href="#mysql的作用" class="headerlink" title="mysql的作用"></a>mysql的作用</h3><p>mysql被用来存储一些状态信息，azkaban的AzkabanWebServer和AzkabanExecutorServer都会访问mysql来获取与更新状态。</p>
<p>AzkabanWebServer使用Mysql做什么？</p>
<ul>
<li>项目管理。管理项目以及相关权限，还有上传的文件；</li>
<li>正在执行的flow的状态。追踪在执行的flow，并且查看那个executor正在执行这个flow。</li>
<li>查看以前的flow或者job。</li>
<li>调度器。保存调度完成的job的状态。</li>
<li>SLA。保存所有的sla规则。</li>
</ul>
<p>AzkabanExecutorServer使用Mysql做什么？</p>
<ul>
<li>访问project。从db里抽取project文件。</li>
<li>执行flow/job。抽取并更新flow的数据。</li>
<li>日志。保存job和flow的执行日志到db里。</li>
<li>interflow的依赖。如果一个flow运行在不同的executor上，则应当把所有的状态存储到db里去。</li>
</ul>
<h3 id="AzkabanWebServer"><a href="#AzkabanWebServer" class="headerlink" title="AzkabanWebServer"></a>AzkabanWebServer</h3><p>用来管理azkaban，管理项目、认证、调度、监控。<br>azkaban使用*.job的kv值文件来定义flow中的task，<em>dependencies</em>用来定义job chain之间的依赖。这个job文件和相关的代码可以打成一个zip包通过web server上传。</p>
<h3 id="AzkabanExecutorServer"><a href="#AzkabanExecutorServer" class="headerlink" title="AzkabanExecutorServer"></a>AzkabanExecutorServer</h3><p>以前web server和executor server是在一起的，分离的原因是：我们预期要能够给executor自由快速扩展的能力。另外如果azkaban升级的话，对我们的用户的影响也更小，因为其实azkaban的发展还是很快的。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[hive杂记]]></title>
      <url>/2016/12/05/hive%E6%9D%82%E8%AE%B0/</url>
      <content type="html"><![CDATA[<h2 id="Execution-failed-with-exit-status-3"><a href="#Execution-failed-with-exit-status-3" class="headerlink" title="Execution failed with exit status: 3"></a>Execution failed with exit status: 3</h2><p>使用mapjoin的时候出现map端内存溢出。通常有两个原因：</p>
<ul>
<li>当面对压缩文件的时候，mapjoin基于的数据大小参数未必准确。或许解压开的数据会大得多。可以降低<code>hive.smalltable.filesize</code>来调整，或者增大<code>hive.mapred.local.mem</code>来让map任务获取更大一些的内存。</li>
<li><code>hive.mapred.local.mem</code>没起作用。参考：<a href="https://issues.apache.org/jira/browse/HADOOP-10245" target="_blank" rel="external">https://issues.apache.org/jira/browse/HADOOP-10245</a></li>
</ul>
<p>MapJoin的过程：</p>
<ul>
<li>本地<ul>
<li>从数据源读取数据</li>
<li>在内存构建hashtable</li>
<li>把hashtable写到本地磁盘</li>
<li>上传hashtable到hdfs</li>
<li>把hashtable添加到DistributeCache</li>
</ul>
</li>
<li>Map任务中<ul>
<li>从DistributeCache读取到内存中</li>
<li>基于内存中的hashtable匹配每条记录的key</li>
<li>join到合适的，写到output中</li>
</ul>
</li>
<li>无reduce任务</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="https://cwiki.apache.org/confluence/display/Hive/LanguageManual+JoinOptimization" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/Hive/LanguageManual+JoinOptimization</a></li>
<li><a href="http://blog.csdn.net/yhao2014/article/details/42675011" target="_blank" rel="external">http://blog.csdn.net/yhao2014/article/details/42675011</a></li>
</ul>
<p>org.apache.hadoop.hive.serde2.lazy.objectinspector.LazyListObjectInspector cannot be cast to org.apache.hadoop.hive.serde2.objectinspector.PrimitiveObjectInspector<br>=<br>load data时确定了data的数据类型，load完成后如果改变hive表中列的类型后select会出错</p>
<p>grouping set 聚合函数多变量问题<br>=</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">select </div><div class="line">nvl(a.loan_day,&apos;-&apos;) loan_day, </div><div class="line">nvl(b.is_newuser, &apos;-&apos;) is_new, </div><div class="line">sum(case when to_date(a.create_time) &lt;=a.dt then a.apply_amount else 0 end) loan_apply_amount_all,	</div><div class="line">count(case when to_date(a.create_time) &lt;=a.dt then a.id else null end) loan_apply_count_all,	</div><div class="line">sum(case when to_date(a.loan_time) &lt;=a.dt then a.apply_amount else 0 end) loan_suc_amount_all,	</div><div class="line">count(case when to_date(a.loan_time) &lt;=a.dt then a.id else null end) loan_suc_count_all,	</div><div class="line">sum(case when to_date(a.create_time) =a.dt then a.apply_amount else 0 end) loan_apply_amount_inc,	</div><div class="line">count(case when to_date(a.create_time) =a.dt then a.id else null end) loan_apply_count_inc,	</div><div class="line">sum(case when to_date(a.loan_time) =a.dt then a.apply_amount else 0 end) loan_suc_amount_inc,	</div><div class="line">count(case when to_date(a.loan_time) =a.dt then a.id else null end) loan_suc_count_inc, </div><div class="line">a.dt statistics_date,	</div><div class="line">&apos;weibo&apos; channel ,</div><div class="line">a.dt dt</div><div class="line">from fact_level.fact_loan_info a </div><div class="line">left join ( </div><div class="line">select id,case when to_date(new_user_date)=dt then &apos;newuser&apos; else &apos;olduser&apos; end is_newuser </div><div class="line">from fact_level.fact_user_info </div><div class="line">where dt between &apos;2017-02-13&apos; and &apos;2017-03-27&apos; and is_new=1 </div><div class="line">)b </div><div class="line">on a.user_id=b.id </div><div class="line">where a.dt between &apos;2017-02-13&apos; and &apos;2017-03-27&apos; and a.loan_unit = &apos;002007001&apos; and to_date(a.create_time)&lt;=a.dt and to_date(a.create_time)&gt;=&apos;2017-02-13&apos; </div><div class="line">group by a.dt,a.loan_day,b.is_newuser </div><div class="line">grouping sets (a.dt,(a.dt,a.loan_day,b.is_newuser),(a.dt,a.loan_day),(a.dt,b.is_newuser))</div></pre></td></tr></table></figure>
<p>报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Error while compiling statement: FAILED: SemanticException [Error 10210]: Grouping sets aggregations (with rollups or cubes) are not allowed if aggregation function parameters overlap with the aggregation functions columns</div></pre></td></tr></table></figure></p>
<p>字面意思上看就是grouping set的聚合函数里不能出现聚合函数的参数超过聚合函数的字段数。 对应上面，就是那些case when里都是传入了两个参数create_time和dt。所以不支持。下面的sql就能够正常运行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">select </div><div class="line">nvl(a.loan_day,&apos;-&apos;) loan_day, </div><div class="line">nvl(b.is_newuser, &apos;-&apos;) is_new, </div><div class="line">sum(case when to_date(a.create_time) &lt;=&apos;2017-03-27&apos; then a.apply_amount else 0 end) loan_apply_amount_all,	</div><div class="line">count(case when to_date(a.create_time) &lt;=&apos;2017-03-27&apos; then a.id else null end) loan_apply_count_all,	</div><div class="line">sum(case when to_date(a.loan_time) &lt;=&apos;2017-03-27&apos; then a.apply_amount else 0 end) loan_suc_amount_all,	</div><div class="line">count(case when to_date(a.loan_time) &lt;=&apos;2017-03-27&apos; then a.id else null end) loan_suc_count_all,	</div><div class="line">sum(case when to_date(a.create_time) =&apos;2017-03-27&apos; then a.apply_amount else 0 end) loan_apply_amount_inc,	</div><div class="line">count(case when to_date(a.create_time) =&apos;2017-03-27&apos; then a.id else null end) loan_apply_count_inc,	</div><div class="line">sum(case when to_date(a.loan_time) =&apos;2017-03-27&apos; then a.apply_amount else 0 end) loan_suc_amount_inc,	</div><div class="line">count(case when to_date(a.loan_time) =&apos;2017-03-27&apos; then a.id else null end) loan_suc_count_inc, </div><div class="line">a.dt statistics_date,	</div><div class="line">&apos;weibo&apos; channel ,</div><div class="line">a.dt dt</div><div class="line">from fact_level.fact_loan_info a </div><div class="line">left join ( </div><div class="line">select id,case when to_date(new_user_date)=dt then &apos;newuser&apos; else &apos;olduser&apos; end is_newuser </div><div class="line">from fact_level.fact_user_info </div><div class="line">where dt between &apos;2017-02-13&apos; and &apos;2017-03-27&apos; and is_new=1 </div><div class="line">)b </div><div class="line">on a.user_id=b.id </div><div class="line">where a.dt between &apos;2017-02-13&apos; and &apos;2017-03-27&apos; and a.loan_unit = &apos;002007001&apos; and to_date(a.create_time)&lt;=a.dt and to_date(a.create_time)&gt;=&apos;2017-02-13&apos; </div><div class="line">group by a.dt,a.loan_day,b.is_newuser </div><div class="line">grouping sets (a.dt,(a.dt,a.loan_day,b.is_newuser),(a.dt,a.loan_day),(a.dt,b.is_newuser))</div></pre></td></tr></table></figure></p>
<p>因为上面这个sql就只有一个参数了<code>create_time</code>或者<code>loan_time</code>。然而我们是不想写死的，我们要的日期是要在where条件里面限制。<br>那就通过嵌套的方式进行实现，只需要绕开grouping set不能支持聚合函数太多参数这个约束就行了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">select</div><div class="line">xx.loan_day, </div><div class="line">xx.is_new, </div><div class="line">sum(xx.loan_apply_amoun) loan_apply_amoun_all,	</div><div class="line">xx.dt</div><div class="line">from </div><div class="line">(</div><div class="line">select </div><div class="line">nvl(a.loan_day,&apos;-&apos;) loan_day, </div><div class="line">nvl(b.is_newuser, &apos;-&apos;) is_new, </div><div class="line">case when to_date(a.create_time) &lt;=a.dt then a.apply_amount else 0 end loan_apply_amoun,	</div><div class="line">a.dt statistics_date,	</div><div class="line">&apos;weibo&apos; channel ,</div><div class="line">a.dt dt</div><div class="line">from fact_level.fact_loan_info a </div><div class="line">left join ( </div><div class="line">select id,case when to_date(new_user_date)=dt then &apos;newuser&apos; else &apos;olduser&apos; end is_newuser </div><div class="line">from fact_level.fact_user_info </div><div class="line">where dt between &apos;2017-02-13&apos; and &apos;2017-03-27&apos; and is_new=1 </div><div class="line">)b </div><div class="line">on a.user_id=b.id </div><div class="line">where a.dt between &apos;2017-02-13&apos; and &apos;2017-03-27&apos; and a.loan_unit = &apos;002007001&apos; and to_date(a.create_time)&lt;=a.dt and to_date(a.create_time)&gt;=&apos;2017-02-13&apos; </div><div class="line">)xx</div><div class="line">group by xx.dt,xx.loan_day,xx.is_new </div><div class="line">grouping sets (xx.dt,(xx.dt,xx.loan_day,xx.is_new),(xx.dt,xx.loan_day),(xx.dt,xx.is_new))</div></pre></td></tr></table></figure>
<p>PS: 并不明白为什么参数不能过多，理论上是可以支持的。有兴趣的同学可以参考一下hive 源码咯。</p>
<p>我写个邮件问问hive用户组的人。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[django使用记录]]></title>
      <url>/2016/12/05/django%E4%BD%BF%E7%94%A8%E8%AE%B0%E5%BD%95/</url>
      <content type="html"><![CDATA[<h4 id="Ubuntu安装失败"><a href="#Ubuntu安装失败" class="headerlink" title="Ubuntu安装失败"></a>Ubuntu安装失败</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">root@will-vm:/usr/local/metamap/metamap_js# pip install Django</div><div class="line">Downloading/unpacking Django</div><div class="line">  Downloading Django-1.9.7-py2.py3-none-any.whl (6.6MB): 6.6MB downloaded</div><div class="line">Cleaning up...</div><div class="line">Exception:</div><div class="line">Traceback (most recent call last):</div><div class="line">  File &quot;/usr/lib/python2.7/dist-packages/pip/basecommand.py&quot;, line 122, in main</div><div class="line">    status = self.run(options, args)</div><div class="line">  File &quot;/usr/lib/python2.7/dist-packages/pip/commands/install.py&quot;, line 278, in run</div><div class="line">    requirement_set.prepare_files(finder, force_root_egg_info=self.bundle, bundle=self.bundle)</div><div class="line">  File &quot;/usr/lib/python2.7/dist-packages/pip/req.py&quot;, line 1259, in prepare_files</div><div class="line">    )[0]</div><div class="line">IndexError: list index out of range</div><div class="line"></div><div class="line">Storing debug log for failure in /root/.pip/pip.log</div></pre></td></tr></table></figure>
<p>查了一下，貌似只有Ubuntu有这个问题，需要先安装distribute<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install --no-use-wheel --upgrade distribute</div></pre></td></tr></table></figure></p>
<p>之后再安装django就解决了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">root@will-vm:/usr/local/metamap/metamap_js# python -c &quot;import django; print(django.get_version())&quot;</div><div class="line">1.9.7</div></pre></td></tr></table></figure></p>
<p>参考：<br><a href="https://www.zhihu.com/question/38484255" target="_blank" rel="external">https://www.zhihu.com/question/38484255</a></p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[时间管理]]></title>
      <url>/2016/12/05/%E6%97%B6%E9%97%B4%E7%AE%A1%E7%90%86/</url>
      <content type="html"><![CDATA[<h2 id="时间管理"><a href="#时间管理" class="headerlink" title="时间管理"></a>时间管理</h2><table>
<thead>
<tr>
<th>编号</th>
<th>简述</th>
<th>备注</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>早起</td>
<td>让光线唤醒自己，而不是冲击的铃声。【个人认为，开始的时候可以用逐渐增强的音乐作为闹铃，因为早起的同时不能有坏情绪，逐渐唤醒我们的大脑】.</td>
</tr>
<tr>
<td>2</td>
<td>晨间日记</td>
<td>推荐的是印象笔记之类的。关注个人的长期目标、中期目标、短期目标。列出当天的作息计划、行动计划。从容地进行昨日总结和今日计划</td>
</tr>
<tr>
<td>3</td>
<td>时间性价比</td>
<td>把有限的精力投入到最重要的事情中，其他的交给别人</td>
</tr>
<tr>
<td>4</td>
<td>做重要不紧急的事情</td>
<td>重要、紧急四象限</td>
</tr>
<tr>
<td>5</td>
<td>事情分情景</td>
<td>有些适合走路做、有些适合在电脑前的时候做、有些适合找一个安静的私密空间做…</td>
</tr>
<tr>
<td>6</td>
<td>TODO-List</td>
<td>大脑擅长的是思考而不是记忆，活在当下，把事情放在硬盘里，专心做当下的事情</td>
</tr>
<tr>
<td>7</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="推荐工具"><a href="#推荐工具" class="headerlink" title="推荐工具"></a>推荐工具</h2><ul>
<li>focus系列</li>
<li>印象笔记或有道云笔记之类</li>
<li></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[HUE维护记录]]></title>
      <url>/2016/12/05/HUE%E7%BB%B4%E6%8A%A4%E8%AE%B0%E5%BD%95/</url>
      <content type="html"><![CDATA[<ol>
<li>应用管理工具<br>tools/app_reg/app_reg.py</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">A tool to manage Hue applications. This does not stop/restart a</div><div class="line">running Hue instance.</div><div class="line"></div><div class="line">Usage:</div><div class="line">    ./tools/app_reg/app_reg.py [flags] --install &lt;path_to_app&gt; [&lt;path_to_app&gt; ...] [--relative-paths]</div><div class="line">        To register and install new application(s).</div><div class="line">        Add &apos;--relative-paths&apos; to the end of the args list to force the app manager to register the new application using its path relative to the hue root.</div><div class="line"></div><div class="line">    ./tools/app_reg/app_reg.py [flags] --remove &lt;application_name&gt;</div><div class="line">        To unregister and remove an installed application.</div><div class="line"></div><div class="line">    ./tools/app_reg/app_reg.py [flags] --list</div><div class="line">        To list all registered applications.</div><div class="line"></div><div class="line">    ./tools/app_reg/app_reg.py [flags] --sync</div><div class="line">        Synchronize all registered applications with the Hue environment.</div><div class="line">        Useful after a `make clean&apos;.</div><div class="line"></div><div class="line">Optional flags:</div><div class="line">    --debug             Turns on debugging output</div></pre></td></tr></table></figure>
<h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><p>clean.sh<br>定时关闭hue的session和查询<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">export HIVE_CONF_DIR=/usr/hdp/2.4.2.0-258/hive/conf/</div><div class="line">cd /server/hue/hue</div><div class="line">build/env/bin/hue close_queries 3</div><div class="line">build/env/bin/hue close_sessions 1</div></pre></td></tr></table></figure></p>
<p>restart_hue.sh<br>定时重启hue<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">num=`ps -ef | grep hue | wc -l`</div><div class="line">if [ $num -lt 2 ];then</div><div class="line">	echo &quot;restart hue at `date +%Y%m%d%H%M`&quot;</div><div class="line">	/server/hue/hue/build/env/bin/supervisor &amp;</div><div class="line">fi</div></pre></td></tr></table></figure></p>
<h2 id="指定yarn队列"><a href="#指定yarn队列" class="headerlink" title="指定yarn队列"></a>指定yarn队列</h2><p>beeline可以这样<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">jdbc:hive2://10.0.1.84:10000?mapreduce.job.queuename=root.default</div></pre></td></tr></table></figure></p>
<p>但是hue没有提供额外设置hiveserver连接参数的地方。看来只能重新指定hive配置目录了。</p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[docker-centos-6.4安装手记]]></title>
      <url>/2016/12/05/docker-centos-6.4%E5%AE%89%E8%A3%85%E6%89%8B%E8%AE%B0/</url>
      <content type="html"><![CDATA[<h2 id="version-Base-not-defined-in-file-libdevmapper-so-1-02-with-link-time-reference"><a href="#version-Base-not-defined-in-file-libdevmapper-so-1-02-with-link-time-reference" class="headerlink" title="version Base not defined in file libdevmapper.so.1.02 with link time reference"></a>version Base not defined in file libdevmapper.so.1.02 with link time reference</h2><p>yum install device-mapper-event-libs -y</p>
<p>参考： <a href="http://qicheng0211.blog.51cto.com/3958621/1582909" target="_blank" rel="external">http://qicheng0211.blog.51cto.com/3958621/1582909</a></p>
<h2 id="can’t-initialize-iptables-table-nat’"><a href="#can’t-initialize-iptables-table-nat’" class="headerlink" title="can’t initialize iptables table `nat’"></a>can’t initialize iptables table `nat’</h2><p>编译内核的时候没有选中iptable_nat module相关的组件。<br>重新到内核文件夹中make </p>
<h2 id="GCC-4-8-or-higher-required"><a href="#GCC-4-8-or-higher-required" class="headerlink" title="GCC 4.8 or higher required"></a>GCC 4.8 or higher required</h2><p>参考：<a href="https://gist.github.com/stephenturner/e3bc5cfacc2dc67eca8b" target="_blank" rel="external">https://gist.github.com/stephenturner/e3bc5cfacc2dc67eca8b</a></p>
<p>参考：</p>
<ul>
<li><a href="http://blog.csdn.net/scaleqiao/article/details/46633011" target="_blank" rel="external">http://blog.csdn.net/scaleqiao/article/details/46633011</a></li>
<li></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[azkaban源码追踪(2)-——-手动触发flow调度]]></title>
      <url>/2016/12/05/azkaban%E6%BA%90%E7%A0%81%E8%BF%BD%E8%B8%AA(2)-%E2%80%94%E2%80%94-%E6%89%8B%E5%8A%A8%E8%A7%A6%E5%8F%91flow%E8%B0%83%E5%BA%A6/</url>
      <content type="html"><![CDATA[<p>对应的操作是进入到某个project中，然后单次执行下面的某个flow。会触发web-server这边与exec-server的远程调用去执行flow。</p>
<h4 id="相关类"><a href="#相关类" class="headerlink" title="相关类"></a>相关类</h4><ul>
<li>Web-server<ul>
<li>ExecutorServlet.doGet</li>
<li>ExecutorManager</li>
</ul>
</li>
<li>exec-server<ul>
<li>ExecutorServlet.doGet</li>
<li>FlowRunnerManager</li>
<li>FlowRunner</li>
<li>ExecutableFlowBase</li>
<li>ExecutableNode</li>
<li>JobRunner</li>
<li>JobTypeManager</li>
<li>Job</li>
<li>AzkabanProcessBuilder</li>
</ul>
</li>
</ul>
<p>#### </p>
]]></content>
      
        
        <tags>
            
            <tag> youdaonote </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[akka in action 读书笔记（8）]]></title>
      <url>/2016/08/19/akka-in-action-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%EF%BC%888%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>系统结构。</p>
<ul>
<li>pipe和filter模型</li>
<li>scatter-gather模型</li>
<li>路由</li>
<li>Recipient list</li>
<li>Aggregator</li>
<li>Become/Unbecome</li>
</ul>
<p>如果有很多工作单元并行运行的话，那么怎样协调它们的工作？有一些可以并行执行，有的任务A需要在前置任务B完成之后才能执行。</p>
<p>通过实现几个经典的Enterprise Integration Pattern，Akka使我们能够充分利用好它的并发功能。</p>
<p>先了解以下最简单的pipe和filter模型，它是基于消息传递的系统的默认模型，经典模型是顺序执行。然后介绍 Scatter-Gather模型，这种模型提供了各种使任务并行的方式。</p>
<h2 id="8-1-pipe-和-filter"><a href="#8-1-pipe-和-filter" class="headerlink" title="8.1 pipe 和 filter"></a>8.1 pipe 和 filter</h2><p>pipe的定义就是，一个进程或者线程把它的结果交给下一个进程或线程作为输入。许多人都是从它的发源地unix了解到pipe模型的。这些pipe组件的组合，被称为pipeline。</p>
<h4 id="8-1-1-Enterprise-integration-pattern-Pipes-and-Filters"><a href="#8-1-1-Enterprise-integration-pattern-Pipes-and-Filters" class="headerlink" title="8.1.1 Enterprise integration pattern Pipes and Filters"></a>8.1.1 Enterprise integration pattern Pipes and Filters</h4>]]></content>
      
        
        <tags>
            
            <tag> akka </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[akka in action 读书笔记（7）]]></title>
      <url>/2016/08/17/akka-in-action-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%EF%BC%887%EF%BC%89/</url>
      <content type="html"><![CDATA[<ul>
<li>配置</li>
<li>日志</li>
<li>单点app</li>
<li>web app</li>
<li>发布</li>
</ul>
<p>只是了解actor和ActorSysten显然是不够的，一个完成的app在发布之前应该要包含其他必备功能。</p>
<h2 id="7-1-配置"><a href="#7-1-配置" class="headerlink" title="7.1 配置"></a>7.1 配置</h2><p>akka使用了Typesafe的配置库。可以定义一些属性，然后直接在代码里引用。还有优雅的方式自动按照时间merge并override多个文件中的多个属性。对于配置还有一个比较重要的就是能够分test, dev, prod环境。</p>
<h4 id="7-1-1-牛刀小试"><a href="#7-1-1-牛刀小试" class="headerlink" title="7.1.1 牛刀小试"></a>7.1.1 牛刀小试</h4><p>首先看一下Typesafe定义配置文件的实例：<br><img src="/imgs/akka/akka_7_config_example.png" alt="配置内容示例"></p>
<p>我们使用ConfigurationFactory来加载配置文件；<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> config = <span class="type">ConfigFactory</span>.load()</div></pre></td></tr></table></figure></p>
<p>它会按照以下顺序找默认的配置文件：</p>
<ul>
<li>application.properties</li>
<li>application.json</li>
<li>application.conf. 这种说明一下是HOCON格式的，基于json，但是可读性更强</li>
</ul>
<p>也可以同时支持以上所有的文件类型：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">hostname=&quot;localhost&quot; </div><div class="line">MyAppl &#123;</div><div class="line">   version = 10</div><div class="line">   description = &quot;My application&quot;</div><div class="line">   database &#123;</div><div class="line">     connect=&quot;jdbc:mysql://localhost/mydata&quot;</div><div class="line">     user=&quot;me&quot;</div><div class="line">   &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>对于大多数app来说，这些配置就已经足够使用了。这种配置可读性强，易于分组管理属性，JDBC就是一个绝佳的例子。对于依赖注入的框架，需要把item写进控制他们的对象中去，这里有一个更简单的方法。</p>
<p>下面看一下怎样使用上面定义的属性：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> applicationVersion = config.getInt(<span class="string">"MyAppl.version"</span>)</div><div class="line"><span class="keyword">val</span> databaseConnectSting = config.getString(<span class="string">"MyAppl.database.connect"</span>)</div></pre></td></tr></table></figure></p>
<p>也可以分开获取连接串<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> databaseCfg = configuration.getConfig(<span class="string">"MyAppl.database"</span>)</div><div class="line"><span class="keyword">val</span> databaseConnectSting = databaseCfg.getString(<span class="string">"connect"</span>)</div></pre></td></tr></table></figure></p>
<p>配置文件中包含的属性一般都是app名称、版本号等，一般会在程序中多次使用它们。</p>
<p>我们还可以使用环境变量来设置变量：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hostname=$&#123;?<span class="type">HOST_NAME</span>&#125;</div></pre></td></tr></table></figure></p>
<p>？代表我们会在系统环境变量中获取该变量的值。因为我们并不能保证有这个环境变量，所以还是先定义一个默认值：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">hostname=&quot;localhost&quot;</div><div class="line">hostname=$&#123;?HOST_NAME&#125;</div></pre></td></tr></table></figure></p>
<h4 id="7-1-2-使用默认值"><a href="#7-1-2-使用默认值" class="headerlink" title="7.1.2 使用默认值"></a>7.1.2 使用默认值</h4><p>还是看JDBC配置。开发环境我们可能配置地址为localhost，但是有人要看demo的话，肯定要改成别的地址。最简单的方法就是复制配置文件，重新命名这个文件，然后让代码读取这个文件的配置内容。问题是这样我们就在两个位置分别有了两个可以相互替代的配置文件。如果还要切换新环境的话，就成了3个了。</p>
<p>配置库包含一个fall-back机制，默认配置会被放进一个对象中，然后这个对象被作为fall-back机制的配置source。见下图：<br><img src="/imgs/akka/akka_7_config_fallback.png" alt="fall-back配置"></p>
<p>注意：这个机制里使用到的属性必须在配置文件中存在默认值，如果找不到的话，就会报错了。</p>
<p>fall-back机制为我们提供默认的配置，那么我们怎样配置默认值呢？应该在jar文件的根目录下的reference.conf配置，每个库都应该包含自己的默认配置。配置库会找到所有的reference.conf文件，整个这些配置到fall-back结构中。这样，某个库所需要的所有的属性都有了默认值。</p>
<p>前面说到配置库是支持多种配置文件的，你可以在一个app中使用多个不同类型的配置文件。每个文件都可以作为下一个文件的fall-back。</p>
<p>下图展示了配置库使用多个文件构建配置tree的优先级：<br><img src="/imgs/akka/akka_7_priority_fallback.png" alt="配置fall-back结构的优先级"></p>
<p>多数app只需要一种配置文件就可以了。但是如果你定了多个，那么默认值之间的覆盖关系就是上图中，上面的覆盖下面的配置。</p>
<p>默认读取文件是 application.{conf,json,properties}。有两种方式自定义配置文件，一种是load的时候指定<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> config = <span class="type">ConfigFactory</span>.load(<span class="string">"myapp"</span>)</div></pre></td></tr></table></figure></p>
<p>这样它就会去找myapp.{conf,json,properties}。</p>
<p>另一种方式是使用系统变量。有时这种使用起来比较方便，我们可以构建bash脚本的时候给app指定(比去jar和war里面找要好一些)。</p>
<ul>
<li>config.resource 此变量指定项目resource中配置文件完整名称，例如： application.conf</li>
<li>config.file  文件系统中配置文件的全名</li>
<li>config.url   </li>
</ul>
<p>当使用load不传参的时候，就会使用系统属性了，使用系统属性指定的配置文件的时候，就不会再去搜索各种文件类型了：conf, json and properties。</p>
<h4 id="7-1-3-akka配置"><a href="#7-1-3-akka配置" class="headerlink" title="7.1.3 akka配置"></a>7.1.3 akka配置</h4><p>上面介绍了怎样配置app的属性，但是如果我们想修改akka本身的一些配置怎么办呢？akka是怎样使用配置库的呢？有可能是有多个ActorSystem，每个Actorsystem都有自己对应的配置。当创建ActorSystem的时候没有指定配置的话，ActorSystem会使用默认值自己创建。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> system = <span class="type">ActorSystem</span>(<span class="string">"mySystem"</span>)</div></pre></td></tr></table></figure>
<p>这里内部调用了<code>ConfigFactory.load()</code>。</p>
<p>我们也可以指定配置文件位置：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> configuration = <span class="type">ConfigFactory</span>.load(<span class="string">"mysystem"</span>)</div><div class="line"><span class="keyword">val</span> systemA = <span class="type">ActorSystem</span>(<span class="string">"mysystem"</span>,configuration)</div></pre></td></tr></table></figure></p>
<p>这个配置就已经存在于这个app了，可以通过如下方式访问；<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> mySystem = <span class="type">ActorSystem</span>(<span class="string">"myAppl"</span>)</div><div class="line"><span class="keyword">val</span> config = mySystem.settings.config</div><div class="line"><span class="keyword">val</span> applicationDescription = config.getString(<span class="string">"myAppl.name"</span>)</div></pre></td></tr></table></figure></p>
<h4 id="7-1-4-多系统"><a href="#7-1-4-多系统" class="headerlink" title="7.1.4 多系统"></a>7.1.4 多系统</h4><p>有时候，在单个实例上我们需要启动多个子系统，每个子系统应该有自己的配置。</p>
<p>假如我们使用了多个JVM，他们基于同一个jar文件。我们就是用系统变量来解决这个问题。每启动一个新的进程，就是用一个不同的配置文件。但是配置里多数都是相同的，只有少数几个配置需要修改。我们使用include来解决这个问题</p>
<p>下面是baseConfig.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">MyAppl &#123;</div><div class="line"> version = 10</div><div class="line"> description = &quot;My application&quot;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>我们使用一个共享变量version，还有不同的变量description。下面是子系统的配置文件subAppl.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">include &quot;baseConfig&quot;</div><div class="line">MyAppl &#123;</div><div class="line"> description = &quot;Sub Application&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>注意include的位置。</p>
<p>如果子系统运行在同一个jvm里呢？那样我们就不能使用系统变量来读取其他的配置文件了。那我们就把两个系统的配置文件合二为一，指定app名称，下面是combined.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">MyAppl &#123;</div><div class="line">   version = 10</div><div class="line">   description = &quot;My application&quot;</div><div class="line">&#125;</div><div class="line">subApplA &#123;</div><div class="line">   MyAppl &#123;</div><div class="line">   description = &quot;Sub application&quot;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里我们使用了subApplA的子树，然后把它放在了configuration chain的上端。This is called lifting a configuration, because the configuration path is shortened.。见下图；<br><img src="/imgs/akka/akka_7_lift_config_part.png" alt="Lifting configuration part"></p>
<p>当我们请求MyAppl.description的时候，返回”Sub application”因为它被设置在配置中的最高层级上，请求MyAppl.version获得10，因为配置的高层级上没有它的定义，所以它使用fall-back机制获取到了10.</p>
<p>下面代码展示了怎样同时使用lift和callback，注意fallback被chain了起来：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> configuration = <span class="type">ConfigFactory</span>.load(<span class="string">"combined"</span>)</div><div class="line"> <span class="keyword">val</span> subApplACfg = configuration.getConfig(<span class="string">"subApplA"</span>)</div><div class="line"> <span class="comment">// 把configuration作为fall-back</span></div><div class="line"> <span class="keyword">val</span> config = subApplACfg.withFallback(configuration)</div></pre></td></tr></table></figure></p>
<p>说的不多，但是这些配置就已经够用了。</p>
<h2 id="7-2-日志"><a href="#7-2-日志" class="headerlink" title="7.2 日志"></a>7.2 日志</h2><p>下一个app必备的功能就是写日志。日志库这个东西众口难调，akka实现了一个日志adapter支持多种日志框架。日志关心两个东西，定义log级别以及定义log内容。</p>
<h4 id="7-2-1-Akka-app中记录日志"><a href="#7-2-1-Akka-app中记录日志" class="headerlink" title="7.2.1 Akka app中记录日志"></a>7.2.1 Akka app中记录日志</h4><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyActor</span> <span class="keyword">extends</span> <span class="title">Actor</span> </span>&#123;</div><div class="line"> <span class="keyword">val</span> log = <span class="type">Logging</span>(context.system, <span class="keyword">this</span>)</div><div class="line"> ...</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>需要注意的是，创建logger的时候需要使用ActorSystem。 logging adapter使用ActorSystem的eventStream发送日志信息给eventhandler。eventStream是Akka中的订阅系统。eventhandler收到日志信息后，使用定义的日志框架记录下来。这样，每个actor都能记录日志，而只有一个eventHandler actor依赖指定的日志框架。另一个好处就是IO，IO在并发环境下会特别慢。在高性能的app里，我们不希望等待打日志的过程。使用eventHandler就不用任何等待。下面列出了默认创建event-handler需要的配置信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">akka &#123;</div><div class="line"> # Event handlers to register at boot time</div><div class="line"> # (Logging$DefaultLogger logs to STDOUT)</div><div class="line"> event-handlers = [&quot;akka.event.Logging$DefaultLogger&quot;]</div><div class="line"> # Options: ERROR, WARNING, INFO, DEBUG</div><div class="line"> loglevel = &quot;DEBUG&quot;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>eventHandler并没有使用任何log框架，而是把log到了标准输出。下面是一个自定义的eventHandler代码：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> akka.event.<span class="type">Logging</span>.<span class="type">InitializeLogger</span></div><div class="line"><span class="keyword">import</span> akka.event.<span class="type">Logging</span>.<span class="type">LoggerInitialized</span></div><div class="line"><span class="keyword">import</span> akka.event.<span class="type">Logging</span>.<span class="type">Error</span></div><div class="line"><span class="keyword">import</span> akka.event.<span class="type">Logging</span>.<span class="type">Warning</span></div><div class="line"><span class="keyword">import</span> akka.event.<span class="type">Logging</span>.<span class="type">Info</span></div><div class="line"><span class="keyword">import</span> akka.event.<span class="type">Logging</span>.<span class="type">Debug</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyEventListener</span> <span class="keyword">extends</span> <span class="title">Actor</span></span></div><div class="line">&#123;</div><div class="line">   <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</div><div class="line">     <span class="keyword">case</span> <span class="type">InitializeLogger</span>(_) =&gt;</div><div class="line">        sender ! <span class="type">LoggerInitialized</span></div><div class="line">     <span class="keyword">case</span> <span class="type">Error</span>(cause, logSource, logClass, message) =&gt;</div><div class="line">        println( <span class="string">"ERROR "</span> + message)</div><div class="line">     <span class="keyword">case</span> <span class="type">Warning</span>(logSource, logClass, message) =&gt;</div><div class="line">        println( <span class="string">"WARN "</span> + message)</div><div class="line">     <span class="keyword">case</span> <span class="type">Info</span>(logSource, logClass, message) =&gt;</div><div class="line">        println( <span class="string">"INFO "</span> + message)</div><div class="line">     <span class="keyword">case</span> <span class="type">Debug</span>(logSource, logClass, message) =&gt;</div><div class="line">        println( <span class="string">"DEBUG "</span> + message)</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这只是一个简单的示例。Akka内置了两个eventHandler的实现，一个是上面的输出到STDOUT的，还有一个就是SLF4J。需要在配置文件中添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">akka &#123;</div><div class="line"> event-handlers =</div><div class="line"> [&quot;akka.event.slf4j.Slf4jEventHandler&quot;]</div><div class="line"> # Options: ERROR,</div><div class="line"> WARNING,</div><div class="line"> INFO, DEBUG</div><div class="line"> loglevel = &quot;DEBUG&quot;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<h4 id="7-2-2-使用日志功能"><a href="#7-2-2-使用日志功能" class="headerlink" title="7.2.2 使用日志功能"></a>7.2.2 使用日志功能</h4><p>重新定义logger：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyActor</span> <span class="keyword">extends</span> <span class="title">Actor</span> </span>&#123;</div><div class="line"> <span class="keyword">val</span> log = <span class="type">Logging</span>(context.system, <span class="keyword">this</span>)</div><div class="line"> ...</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>第二个参数就是日志的source。这里就是这个类的实例。可以mixin ActorLogging trait来简化代码。</p>
<p>打日志过程中还可以使用placeholder<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">log.debug(<span class="string">"two parameters: &#123;&#125;, &#123;&#125;"</span>, <span class="string">"one"</span>,<span class="string">"two"</span>)</div></pre></td></tr></table></figure></p>
<h4 id="7-2-3-控制日志功能"><a href="#7-2-3-控制日志功能" class="headerlink" title="7.2.3 控制日志功能"></a>7.2.3 控制日志功能</h4><p>有时我们想自由控制日志的输出内容，比如查看生产环境的某些信息。看一下这个配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">akka &#123;</div><div class="line">   # logging must be set to DEBUG to use any of the options below</div><div class="line">   loglevel = DEBUG</div><div class="line">   # Log the complete configuration at INFO level when the actor</div><div class="line">   # system is started. This is useful when you are uncertain of</div><div class="line">   # what configuration is used.</div><div class="line">   log-config-on-start = on</div><div class="line">   debug &#123;</div><div class="line">   # logging of all user-level messages that are processed by</div><div class="line">   # Actors that use akka.event.LoggingReceive enable function of</div><div class="line">   # LoggingReceive, which is to log any received message at</div><div class="line">   # DEBUG level</div><div class="line">   # 把所有启用了akka.event.LoggingReceive的收到的user-leve的debug level的日志信息都打印出来</div><div class="line">   receive = on</div><div class="line"></div><div class="line">   # enable DEBUG logging of all AutoReceiveMessages</div><div class="line">   # (Kill, PoisonPill and the like)</div><div class="line">   autoreceive = on</div><div class="line">   # enable DEBUG logging of actor lifecycle changes</div><div class="line">   # (restarts, deaths etc)</div><div class="line">   lifecycle = on</div><div class="line">   # enable DEBUG logging of all LoggingFSMs for events,</div><div class="line">   # transitions and timers</div><div class="line">   fsm = on</div><div class="line">   # enable DEBUG logging of subscription (subscribe/unsubscribe)</div><div class="line">   # changes on the eventStream</div><div class="line">   event-stream = on</div><div class="line">   &#125;</div><div class="line">   remote &#123;</div><div class="line">   # If this is &quot;on&quot;, Akka will log all outbound messages at</div><div class="line">   # DEBUG level, if off then they are not logged</div><div class="line">   log-sent-messages = on</div><div class="line">   # If this is &quot;on,&quot; Akka will log all inbound messages at</div><div class="line">   # DEBUG level, if off then they are not logged</div><div class="line">   log-received-messages = on</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>对应使用logger的代码是：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyActor</span> <span class="keyword">extends</span> <span class="title">Actor</span> <span class="keyword">with</span> <span class="title">ActorLogging</span> </span>&#123;</div><div class="line"> <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= <span class="type">LoggingReceive</span> &#123;</div><div class="line"> <span class="keyword">case</span> ... =&gt; ...</div><div class="line"> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在，只要我们设置属性akka.debug.receive 为on，我们actor收到的所有message就都可以被log出来了。</p>
<p>好了。日志就介绍到这里。</p>
<h2 id="7-3-发布基于Akka的app"><a href="#7-3-发布基于Akka的app" class="headerlink" title="7.3 发布基于Akka的app"></a>7.3 发布基于Akka的app</h2><p>这一节介绍发布应用的两种方式，一种是独立app，另一种是基于play-min的web app。</p>
<h4 id="7-3-1-独立app"><a href="#7-3-1-独立app" class="headerlink" title="7.3.1 独立app"></a>7.3.1 独立app</h4><p>我们使用akka的插件MicroKernel创建独立app。先弄一个HelloWorld Actor，只接收message，恢复hello。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorld</span> <span class="keyword">extends</span> <span class="title">Actor</span></span></div><div class="line">   <span class="keyword">with</span> <span class="type">ActorLogging</span> &#123;</div><div class="line">     <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</div><div class="line">         <span class="keyword">case</span> msg:<span class="type">String</span> =&gt;</div><div class="line">         <span class="keyword">val</span> hello = <span class="string">"Hello %s"</span>.format(msg)</div><div class="line">         sender ! hello</div><div class="line">         log.info(<span class="string">"Sent response &#123;&#125;"</span>,hello)</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>下面我们创建HelloWorldCaller，它负责调用上面的 HelloWorld actor。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">HelloWorldCaller</span>(<span class="params">timer:<span class="type">Duration</span>, actor:<span class="type">ActorRef</span></span>)</span></div><div class="line"> <span class="keyword">extends</span> <span class="type">Actor</span> <span class="keyword">with</span> <span class="type">ActorLogging</span> &#123;</div><div class="line"> </div><div class="line">   <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">TimerTick</span>(<span class="params">msg:<span class="type">String</span></span>)</span></div><div class="line"></div><div class="line">   <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">preStart</span></span>() &#123;</div><div class="line">       <span class="keyword">super</span>.preStart()</div><div class="line">       <span class="comment">// 使用akka scheduler给自己发送message</span></div><div class="line">       context.system.scheduler.schedule(</div><div class="line">         timer, 	<span class="comment">// 首次触发之前的时长</span></div><div class="line">         timer,		<span class="comment">// 周期 </span></div><div class="line">         self,		<span class="comment">// 发往的actor，这里是自己</span></div><div class="line">         <span class="keyword">new</span> <span class="type">TimerTick</span>(<span class="string">"everybody"</span>))	<span class="comment">// 发出的message</span></div><div class="line">   &#125;</div><div class="line">   <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</div><div class="line">       <span class="keyword">case</span> msg: <span class="type">String</span> =&gt; log.info(<span class="string">"received &#123;&#125;"</span>,msg)</div><div class="line">       <span class="keyword">case</span> tick: <span class="type">TimerTick</span> =&gt; actor ! tick.msg</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个actor使用内置的schuduler周期性的生成message。每次收到TimerTick，我们都给构造方法中传进来的actor发送一个这个tick的message。当接收到一个String的message的时候，就用日志记录下来。</p>
<p>下面使用akka内核来差un构建系统，这个内核包含了一个启动接口，我们就是要实现这个接口。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> akka.actor.&#123; <span class="type">Props</span>, <span class="type">ActorSystem</span> &#125;</div><div class="line"><span class="keyword">import</span> akka.kernel.<span class="type">Bootable</span></div><div class="line"><span class="keyword">import</span> scala.concurrent.duration._</div><div class="line"><span class="comment">// 继承Bootable trait，启动app的时候就会被调用</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BootHello</span> <span class="keyword">extends</span> <span class="title">Bootable</span> </span>&#123;</div><div class="line">     </div><div class="line">     <span class="keyword">val</span> system = <span class="type">ActorSystem</span>(<span class="string">"hellokernel"</span>)</div><div class="line"></div><div class="line">     <span class="comment">// 当app启动的时候，会调用这个接口方法</span></div><div class="line">     <span class="function"><span class="keyword">def</span> <span class="title">startup</span> </span>= &#123;</div><div class="line">         <span class="keyword">val</span> actor = system.actorOf(<span class="type">Props</span>[<span class="type">HelloWorld</span>])</div><div class="line">         <span class="keyword">val</span> config = system.settings.config</div><div class="line">         <span class="keyword">val</span> timer = config.getInt(<span class="string">"helloWorld.timer"</span>)</div><div class="line">         system.actorOf(<span class="type">Props</span>(<span class="keyword">new</span> <span class="type">HelloWorldCaller</span>(timer millis, actor)))</div><div class="line">     &#125;</div><div class="line">     </div><div class="line">     <span class="function"><span class="keyword">def</span> <span class="title">shutdown</span> </span>= &#123;</div><div class="line">         system.shutdown()</div><div class="line">     &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在我们已构建好了系统，还需要一些资源让我们的app运行起来。我们先写一下配置文件reference.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">helloWorld &#123;</div><div class="line"> timer=5000</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>我们的默认timer值是5000毫秒。注意reference.conf文件需要放在jar文件的根目录下。下面我们在application.conf里配置logger相关<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">akka &#123;</div><div class="line"> event-handlers =</div><div class="line"> [&quot;akka.event.slf4j.Slf4jEventHandler&quot;]</div><div class="line"> # Options: ERROR,</div><div class="line"> WARNING,</div><div class="line"> INFO, DEBUG</div><div class="line"> loglevel = &quot;DEBUG&quot;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>万事俱备。下面使用 akka-sbt-plugin 来创建依赖配置文件, 编辑plugins.sbt<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">resolvers += &quot;Typesafe Repository&quot;</div><div class="line">  at &quot;http://repo.akka.io/releases/&quot; </div><div class="line"></div><div class="line">  addSbtPlugin(&quot;com.typesafe.akka&quot; % &quot;akka-sbt-plugin&quot; % &quot;2.0.1&quot;)</div></pre></td></tr></table></figure></p>
<p>为不熟悉sbt的同学解释一下。第一行添加了repository的地址。然后是一个空行，这个注意一下，它代表前一行完事儿了。下一行定义了我们需要的插件。</p>
<p>然后创建build文件， HelloKernelBuild.scala<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sbt._</div><div class="line"> <span class="keyword">import</span> <span class="type">Keys</span>._</div><div class="line"> <span class="keyword">import</span> akka.sbt.<span class="type">AkkaKernelPlugin</span></div><div class="line"> <span class="keyword">import</span> akka.sbt.<span class="type">AkkaKernelPlugin</span>.&#123; <span class="type">Dist</span>,</div><div class="line">     outputDirectory,</div><div class="line">     distJvmOptions</div><div class="line"> &#125;</div><div class="line"> <span class="class"><span class="keyword">object</span> <span class="title">HelloKernelBuild</span> <span class="keyword">extends</span> <span class="title">Build</span> </span>&#123;</div><div class="line">     <span class="keyword">lazy</span> <span class="keyword">val</span> <span class="type">HelloKernel</span> = <span class="type">Project</span>(</div><div class="line">         id = <span class="string">"hello-kernel-book"</span>,</div><div class="line">         base = file(<span class="string">"."</span>),</div><div class="line">         settings = defaultSettings</div><div class="line">         	++ <span class="type">AkkaKernelPlugin</span>.distSettings <span class="comment">// 添加akka插件的功能</span></div><div class="line">         	++ <span class="type">Seq</span>(</div><div class="line">			<span class="comment">// 构建需要的依赖</span></div><div class="line">             		libraryDependencies ++= <span class="type">Dependencies</span>.helloKernel,</div><div class="line">             		distJvmOptions in <span class="type">Dist</span> := <span class="string">"-Xms256M -Xmx1024M"</span>,</div><div class="line">			<span class="comment">// dist输出目录</span></div><div class="line">             		outputDirectory in <span class="type">Dist</span> := file(<span class="string">"target/helloDist"</span>)</div><div class="line">         	)</div><div class="line">     )</div><div class="line">     <span class="keyword">lazy</span> <span class="keyword">val</span> buildSettings = <span class="type">Defaults</span>.defaultSettings</div><div class="line">     ++ <span class="type">Seq</span>(</div><div class="line">         organization := <span class="string">"com.manning"</span>,</div><div class="line">         version := <span class="string">"0.1-SNAPSHOT"</span>,</div><div class="line">         scalaVersion := <span class="string">"2.9.1"</span>,</div><div class="line">         crossPaths := <span class="literal">false</span>,</div><div class="line">         organizationName := <span class="string">"Mannings"</span>,</div><div class="line">         organizationHomepage := <span class="type">Some</span>(url(<span class="string">"http://www.mannings.com"</span>))</div><div class="line">     )</div><div class="line">     <span class="keyword">lazy</span> <span class="keyword">val</span> defaultSettings = buildSettings ++ <span class="type">Seq</span>(</div><div class="line">         resolvers += <span class="string">"Typesafe Repo"</span> at  <span class="string">"http://repo.typesafe.com/typesafe/releases/"</span>,</div><div class="line">         <span class="comment">// compile options</span></div><div class="line">         scalacOptions ++= <span class="type">Seq</span>(<span class="string">"-encoding"</span>, <span class="string">"UTF-8"</span>, <span class="string">"-deprecation"</span>,  <span class="string">"-unchecked"</span>),</div><div class="line">         javacOptions ++= <span class="type">Seq</span>(<span class="string">"-Xlint:unchecked"</span>, <span class="string">"-Xlint:deprecation"</span>)</div><div class="line">     )</div><div class="line">&#125;  </div><div class="line"></div><div class="line"> <span class="comment">// Dependencies</span></div><div class="line"> <span class="class"><span class="keyword">object</span> <span class="title">Dependencies</span> </span>&#123;</div><div class="line">   <span class="keyword">import</span> <span class="type">Dependency</span>._</div><div class="line">   <span class="keyword">val</span> helloKernel = <span class="type">Seq</span>(akkaActor, akkaKernel, akkaSlf4j, lf4jApi, slf4jLog4j, <span class="type">Test</span>.junit, <span class="type">Test</span>.scalatest, <span class="type">Test</span>.akkaTestKit)</div><div class="line"> &#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">Dependency</span> </span>&#123;</div><div class="line">     <span class="comment">// Versions</span></div><div class="line">     <span class="class"><span class="keyword">object</span> <span class="title">V</span> </span>&#123;</div><div class="line">       <span class="keyword">val</span> <span class="type">Scalatest</span> = <span class="string">"1.6.1"</span></div><div class="line">       <span class="keyword">val</span> <span class="type">Slf4j</span> = <span class="string">"1.6.4"</span></div><div class="line">       <span class="keyword">val</span> <span class="type">Akka</span> = <span class="string">"2.0"</span></div><div class="line">     &#125;</div><div class="line">     <span class="comment">// Compile</span></div><div class="line">     <span class="keyword">val</span> commonsCodec = <span class="string">"commons-codec"</span> % <span class="string">"commons-codec"</span>% <span class="string">"1.4"</span></div><div class="line">     <span class="keyword">val</span> commonsIo = <span class="string">"commons-io"</span>  % <span class="string">"commons-io"</span> % <span class="string">"2.0.1"</span></div><div class="line">     <span class="keyword">val</span> commonsNet = <span class="string">"commons-net"</span>  % <span class="string">"commons-net"</span> % <span class="string">"3.1"</span></div><div class="line">     <span class="keyword">val</span> slf4jApi = <span class="string">"org.slf4j"</span> % <span class="string">"slf4j-api"</span> % <span class="type">V</span>.<span class="type">Slf4j</span></div><div class="line">     <span class="keyword">val</span> slf4jLog4j = <span class="string">"org.slf4j"</span>  % <span class="string">"slf4j-log4j12"</span>% <span class="type">V</span>.<span class="type">Slf4j</span></div><div class="line">     <span class="keyword">val</span> akkaActor = <span class="string">"com.typesafe.akka"</span> % <span class="string">"akka-actor"</span> % <span class="type">V</span>.<span class="type">Akka</span></div><div class="line">     <span class="keyword">val</span> akkaKernel = <span class="string">"com.typesafe.akka"</span> % <span class="string">"akka-kernel"</span> % <span class="type">V</span>.<span class="type">Akka</span></div><div class="line">     <span class="keyword">val</span> akkaSlf4j = <span class="string">"com.typesafe.akka"</span>  % <span class="string">"akka-slf4j"</span> % <span class="type">V</span>.<span class="type">Akka</span></div><div class="line">     <span class="keyword">val</span> scalatest = <span class="string">"org.scalatest"</span> %% <span class="string">"scalatest"</span> % <span class="type">V</span>.<span class="type">Scalatest</span></div><div class="line">     <span class="class"><span class="keyword">object</span> <span class="title">Test</span> </span>&#123;</div><div class="line">         <span class="keyword">val</span> junit = <span class="string">"junit"</span> % <span class="string">"junit"</span> %  <span class="string">"4.5"</span> % <span class="string">"test"</span></div><div class="line">         <span class="keyword">val</span> scalatest = <span class="string">"org.scalatest"</span> %% <span class="string">"scalatest"</span> % <span class="type">V</span>.<span class="type">Scalatest</span> % <span class="string">"test"</span></div><div class="line">         <span class="keyword">val</span> akkaTestKit =<span class="string">"com.typesafe.akka"</span>  % <span class="string">"akka-testkit"</span> % <span class="type">V</span>.<span class="type">Akka</span> % <span class="string">"test"</span></div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>万事俱备了。进入项目根目录，启动sbt，执行dist命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">sbt</div><div class="line">[info] Loading project</div><div class="line">definition from J:\boek\manningAkka\</div><div class="line">listings\kernel\project</div><div class="line">[info]</div><div class="line">Set current project to hello-kernel-book (in build</div><div class="line"> file:/J:/boek/manningAkka/listings/kernel/)</div><div class="line">&gt; dist</div></pre></td></tr></table></figure></p>
<p>完事儿后，查看 /target/helloDist目录，可看到4个子目录：</p>
<ul>
<li>bin 启动脚本所在的地方，包含linux和window的</li>
<li>config 运行app所需的配置文件</li>
<li>deploy jar文件所在的地方</li>
<li>lib 依赖的jar文件所在的地方</li>
</ul>
<p>使用启动脚本，启动我们的app：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">./start BootHello</div></pre></td></tr></table></figure></p>
<p>观察log文件。</p>
<h4 id="7-3-2-创建web-app"><a href="#7-3-2-创建web-app" class="headerlink" title="7.3.2 创建web app"></a>7.3.2 创建web app</h4><p>相比上面独立app，这里并不多做什么。 Play-mini是基于Play的扩展。我们要做的app只是提供接口，并不提供界面。有其他的工具可以，我们只是觉得 Play-mini来做例子<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">PlayMiniHello</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</div><div class="line"> <span class="keyword">lazy</span> <span class="keyword">val</span> system = <span class="type">ActorSystem</span>(<span class="string">"webhello"</span>)</div><div class="line"> <span class="keyword">lazy</span> <span class="keyword">val</span> actor = system.actorOf(<span class="type">Props</span>[<span class="type">HelloWorld</span>])</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>只要继承Application, 就集成了好多的功能，就像前面的kernel一样。web app中需要创建路由。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">PlayMiniHello</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</div><div class="line"> <span class="function"><span class="keyword">def</span> <span class="title">route</span> </span>= &#123;</div><div class="line"> 	<span class="keyword">case</span> <span class="type">GET</span>(<span class="type">Path</span>(<span class="string">"/test"</span>)) =&gt; <span class="type">Action</span> &#123;</div><div class="line"> 		<span class="type">Ok</span>(<span class="string">"TEST @ %s\n"</span>.format(<span class="type">System</span>.currentTimeMillis))</div><div class="line">	 &#125;</div><div class="line"> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>在面向服务的架构里，整个app甚至就可以仅仅基于几个这样的服务映射。相比上面的kernel方式，这是唯一的区别。下面我们创建hello请求的路由，它接收一个name参数，当没有这个参数的时候就使用我们配置里的默认值。下面是从REST路径里获取参数的方式<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> writeForm = <span class="type">Form</span>(<span class="string">"name"</span> -&gt; text(<span class="number">1</span>,<span class="number">10</span>))</div></pre></td></tr></table></figure></p>
<p>这里使用了Play的From，约束长度只能在1到10之间。如果获取失败的话，就获取配置参数helloWorld.name。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="type">GET</span>(<span class="type">Path</span>(<span class="string">"/hello"</span>)) =&gt; <span class="type">Action</span> &#123;</div><div class="line">  <span class="comment">// 把request定已成implicit类型，方便下面进行变量绑定 </span></div><div class="line">  <span class="keyword">implicit</span> request =&gt;</div><div class="line">       <span class="keyword">val</span> name = <span class="keyword">try</span> &#123;</div><div class="line">	  <span class="comment">// 将request和我们的form进行绑定匹配</span></div><div class="line">          writeForm.bindFromRequest.get</div><div class="line">       &#125; <span class="keyword">catch</span> &#123;</div><div class="line">           <span class="keyword">case</span> ex:<span class="type">Exception</span> =&gt; &#123;</div><div class="line">             log.warning(<span class="string">"no name specified"</span>)</div><div class="line">	     <span class="comment">// 获取默认的配置参数</span></div><div class="line">             system.settings.config.getString(<span class="string">"helloWorld.name"</span>)</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>现在有了name，我们可以发送信息给指定的actor。但是在创建response之前我们必须等着结果，可我们不希望阻塞。所以我们返回AsyncResult，它需要一个promise。promise很像Futrue，只是Futrue是在client端使用的。有了promise，结果就一直等在producer那儿，完成处理后producer会提供这个结果。关于Futrue和Promise的更多细节会在下一章涉及。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="type">AsyncResult</span> &#123;</div><div class="line">   <span class="comment">// 使用ask方法发送request</span></div><div class="line">   <span class="keyword">val</span> resultFuture = actor ? name </div><div class="line">   <span class="comment">// 使用futrue创建一个promise</span></div><div class="line">   <span class="keyword">val</span> promise = resultFuture.asPromise</div><div class="line">   <span class="comment">// 返回结果后，就创建response</span></div><div class="line">   promise.map &#123;</div><div class="line">       <span class="keyword">case</span> res:<span class="type">String</span> =&gt; &#123;</div><div class="line">          <span class="type">Ok</span>(res)</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>要使用 HelloWorld actor的response创建一个response，我们必须使用ask方法。ask方法返回一个Futrue，使用Future创建一个Promise。最后一步就是使用返回的结果填充进Promise。</p>
<p>如果超时没有收到response呢，这样map方法就不会被调用，promise里也不会被填充结果。要解决这个问题，我们继承Future，当失败的时候返回一个字符串。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> resultFuture = actor ? name recover &#123;</div><div class="line">     <span class="keyword">case</span> ex:<span class="type">AskTimeoutException</span></div><div class="line">          =&gt; <span class="string">"Timeout"</span></div><div class="line"></div><div class="line">     <span class="keyword">case</span> ex:<span class="type">Exception</span> =&gt; &#123;</div><div class="line">         log.error(<span class="string">"recover from "</span>+ex.getMessage)</div><div class="line">         <span class="string">"Exception:"</span> + ex.getMessage</div><div class="line">     &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>总结一下变化：</p>
<ul>
<li>从resource文件中加载默认属性</li>
<li>抽取path中的参数</li>
<li>处理请求超时</li>
<li>并发地处理所有问题</li>
</ul>
<p>用下面这个例子来总结一下这一章的所学：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 实现 Application trait</span></div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">PlayMiniHello</span> <span class="keyword">extends</span> <span class="title">Application</span> </span>&#123;</div><div class="line"></div><div class="line">     <span class="keyword">lazy</span> <span class="keyword">val</span> system = <span class="type">ActorSystem</span>(<span class="string">"webhello"</span>)</div><div class="line"></div><div class="line">     <span class="keyword">lazy</span> <span class="keyword">val</span> actor = system.actorOf(<span class="type">Props</span>[<span class="type">HelloWorld</span>])</div><div class="line"></div><div class="line">     <span class="keyword">implicit</span> <span class="keyword">val</span> timeout = <span class="type">Timeout</span>(<span class="number">1000</span> milliseconds)</div><div class="line"></div><div class="line">     <span class="keyword">val</span> log = <span class="type">Logging</span>(system,<span class="type">PlayMiniHello</span>.getClass)</div><div class="line"></div><div class="line">     <span class="function"><span class="keyword">def</span> <span class="title">route</span> </span>= &#123;</div><div class="line">         <span class="keyword">case</span> <span class="type">GET</span>(<span class="type">Path</span>(<span class="string">"/test"</span>)) =&gt; <span class="type">Action</span> &#123;</div><div class="line">             <span class="type">Ok</span>(<span class="string">"TEST @ %sn"</span>.format(<span class="type">System</span>.currentTimeMillis))</div><div class="line">         &#125;</div><div class="line"></div><div class="line">	 <span class="comment">// 使用 helloworld actor 创建一个request</span></div><div class="line">         <span class="keyword">case</span> <span class="type">GET</span>(<span class="type">Path</span>(<span class="string">"/hello"</span>)) =&gt; <span class="type">Action</span> &#123;</div><div class="line">	     <span class="comment">// 设置request为implicit</span></div><div class="line">             <span class="keyword">implicit</span> request =&gt;</div><div class="line">             <span class="keyword">val</span> name = <span class="keyword">try</span> &#123;</div><div class="line">		    <span class="comment">// 获取name参数，具体参考Play文档</span></div><div class="line">                    writeForm.bindFromRequest.get</div><div class="line">               &#125; <span class="keyword">catch</span> &#123;</div><div class="line">                     <span class="keyword">case</span> ex:<span class="type">Exception</span> =&gt; &#123;</div><div class="line">                         log.warning(<span class="string">"no name specified"</span>)</div><div class="line">                         system.settings.config.getString(<span class="string">"helloWorld.name"</span>)</div><div class="line">                     &#125;</div><div class="line">               &#125;</div><div class="line"></div><div class="line">	       <span class="comment">// 由于不想阻塞，我们返回AsyncResult</span></div><div class="line">               <span class="type">AsyncResult</span> &#123;</div><div class="line">		 <span class="comment">// 担心超时，创建一个recover回调函数</span></div><div class="line">                 <span class="keyword">val</span> resultFuture = actor ? name recover &#123;</div><div class="line">                     <span class="keyword">case</span> ex:<span class="type">AskTimeoutException</span> =&gt; <span class="string">"Timeout"</span></div><div class="line">                     <span class="keyword">case</span> ex:<span class="type">Exception</span> =&gt; &#123;</div><div class="line">                         log.error(<span class="string">"recover from "</span>+ex.getMessage)</div><div class="line">                         <span class="string">"Exception:"</span> + ex.getMessage</div><div class="line">                     &#125;</div><div class="line">                 &#125;</div><div class="line"></div><div class="line">                 <span class="keyword">val</span> promise = resultFuture.asPromise</div><div class="line"></div><div class="line">                 promise.map &#123;</div><div class="line">                     <span class="keyword">case</span> res:<span class="type">String</span> =&gt; &#123;</div><div class="line">                         log.info(<span class="string">"result "</span>+res)</div><div class="line">                         <span class="type">Ok</span>(res)</div><div class="line">                     &#125;</div><div class="line">                     <span class="keyword">case</span> ex:<span class="type">Exception</span> =&gt; &#123;</div><div class="line">                         log.error(<span class="string">"Exception "</span>+ex.getMessage)</div><div class="line">                         <span class="type">Ok</span>(ex.getMessage)</div><div class="line">                     &#125;</div><div class="line">                     <span class="keyword">case</span> _ =&gt; &#123;</div><div class="line">                     <span class="type">Ok</span>(<span class="string">"Unexpected message"</span>)</div><div class="line">                     &#125;</div><div class="line">                 &#125;</div><div class="line">             &#125;</div><div class="line">         &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">val</span> writeForm = <span class="type">Form</span>(<span class="string">"name"</span> -&gt; text(<span class="number">1</span>,<span class="number">10</span>))</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>此外我们还要处理一些小事情，指定启动app的类，这里是”PlayMiniHello.”。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">Global</span> <span class="keyword">extends</span> <span class="title">com</span>.<span class="title">typesafe</span>.<span class="title">play</span>.<span class="title">mini</span>.<span class="title">Setup</span>(<span class="params">ch04.<span class="type">PlayMiniHello</span></span>)</span></div></pre></td></tr></table></figure></p>
<p>继承了 play.api.GlobalSettings trait，这样我们就可以使用ActorSystem的onStart和onStop方法了。</p>
<p>编辑配置文件reference.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">helloWorld &#123;</div><div class="line"> name=world</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>编辑application.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">helloWorld &#123;</div><div class="line">    name=&quot;world!!!&quot;</div><div class="line">&#125;</div><div class="line">akka &#123;</div><div class="line">   event-handlers = [&quot;akka.event.slf4j.Slf4jEventHandler&quot;]</div><div class="line">   # Options: ERROR, WARNING, INFO, DEBUG</div><div class="line">   loglevel = &quot;DEBUG&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>编辑项目构建文件Build.scala<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sbt._</div><div class="line"><span class="keyword">import</span> <span class="type">Keys</span>._</div><div class="line"><span class="keyword">import</span> <span class="type">PlayProject</span>._</div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">Build</span> <span class="keyword">extends</span> <span class="title">Build</span> </span>&#123;</div><div class="line">     <span class="keyword">lazy</span> <span class="keyword">val</span> root = <span class="type">Project</span>(id = <span class="string">"playminiHello"</span>,</div><div class="line">     base = file(<span class="string">"."</span>), settings = <span class="type">Project</span>.defaultSettings).settings(</div><div class="line">     resolvers += <span class="string">"Typesafe Repo"</span> at</div><div class="line">     <span class="string">"http://repo.typesafe.com/typesafe/releases/"</span>,</div><div class="line">     resolvers += <span class="string">"Typesafe Snapshot Repo"</span> at</div><div class="line">     <span class="string">"http://repo.typesafe.com/typesafe/snapshots/"</span>,</div><div class="line">     libraryDependencies ++= <span class="type">Dependencies</span>.hello,</div><div class="line">     <span class="comment">// 加上这一行，就可以支持sbt测试webapp了</span></div><div class="line">     mainClass in (<span class="type">Compile</span>, run) := <span class="type">Some</span>(<span class="string">"play.core.server.NettyServer"</span>))</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">Dependencies</span> </span>&#123;</div><div class="line">     <span class="keyword">import</span> <span class="type">Dependency</span>._</div><div class="line">     <span class="keyword">val</span> hello = <span class="type">Seq</span>(akkaActor,</div><div class="line">         akkaSlf4j,</div><div class="line">         <span class="comment">// slf4jLog4j,</span></div><div class="line">         playmini</div><div class="line">     )</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">Dependency</span> </span>&#123;</div><div class="line">     <span class="comment">// Versions</span></div><div class="line">     <span class="class"><span class="keyword">object</span> <span class="title">V</span> </span>&#123;</div><div class="line">         <span class="keyword">val</span> <span class="type">Slf4j</span> = <span class="string">"1.6.4"</span></div><div class="line">         <span class="keyword">val</span> <span class="type">Akka</span> = <span class="string">"2.0"</span></div><div class="line">     &#125;</div><div class="line">     <span class="comment">// Compile</span></div><div class="line">     <span class="keyword">val</span> slf4jLog4j = <span class="string">"org.slf4j"</span> % <span class="string">"slf4j-log4j12"</span>% <span class="type">V</span>.<span class="type">Slf4j</span></div><div class="line">     <span class="keyword">val</span> akkaActor = <span class="string">"com.typesafe.akka"</span> % <span class="string">"akka-actor"</span> % <span class="type">V</span>.<span class="type">Akka</span></div><div class="line">     <span class="keyword">val</span> playmini = <span class="string">"com.typesafe"</span> %% <span class="string">"play-mini"</span> % <span class="string">"2.0-RC3"</span></div><div class="line">     <span class="keyword">val</span> akkaSlf4j = <span class="string">"com.typesafe.akka"</span> % <span class="string">"akka-slf4j"</span> % <span class="type">V</span>.<span class="type">Akka</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>进入sbt，运行run。app会运行在9000端口上，可以使用curl进行测试了。</p>
<h2 id="7-4-总结"><a href="#7-4-总结" class="headerlink" title="7.4 总结"></a>7.4 总结</h2><p>写的太绕口了。。不翻译了。。。。。akka各种牛逼。。。</p>
]]></content>
      
        
        <tags>
            
            <tag> akka </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[akka in action 读书笔记（6）]]></title>
      <url>/2016/08/15/akka-in-action-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%EF%BC%886%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>这一章我们介绍：</p>
<ul>
<li>scale out</li>
<li>分布式的卖票app</li>
<li>远程使用</li>
<li>测试分布式的actor系统</li>
</ul>
<p>这一章中，我们会拿出第二章的例子来进行scale out，也就是在更多的机器上部署同一个app。【回忆一下scale up，在更多的jvm上部署同一个app】</p>
<p>这一章只介绍scale out，下一章介绍集群使用。13章会深入scale out的一些细节。</p>
<h2 id="6-1-scale-out"><a href="#6-1-scale-out" class="headerlink" title="6.1 scale out"></a>6.1 scale out</h2><p>不要指望一下子就能够把任何app扩展到几千台机器，分布式计算是众所周知的难点。akka只是让分布式计算简单一些，让并发编程简单一些，我们这里还是使用 GoTicks.com 项目，把它弄成分布式的。</p>
<p>许多网络技术都使用RPC，这种方式尽量掩饰本地调用与远程调用的不同，主要思想是既然本地调用很简单，那么就让编程人员像调用本地方法一样调用远程方法。这种通信方式对于点对点的server连接是有效的，但是对于大型网络并不是一个好的方案。面向message的中间件可以解决这个问题，但使app理解吸收message系统到app层的代价有些大。akka另辟蹊径，远程协作者相对透明，不用修改akka代码。</p>
<p>进入探讨之前，先看一下网络拓扑的例子和一些通用术语。要是你对这些已经很了解了就直接跳到6.2.</p>
<h4 id="6-1-1-通用网络拓扑"><a href="#6-1-1-通用网络拓扑" class="headerlink" title="6.1.1 通用网络拓扑"></a>6.1.1 通用网络拓扑</h4><p><img src="/imgs/akka/akka_6_common_network_topo.png" alt="通用网络拓扑"></p>
<ul>
<li>Node: 在网络中运行着的一个app，是网络拓扑的一个连接点。一个server上可以有多个node。</li>
<li>Role： 每个node在分布式系统中都有自己指定的Role。它代表着这个node可以执行一些列的特定任务。</li>
<li>transport protocol ： node使用指定的传输协议来互相沟通，比如TCP/IP</li>
<li>membership：当许多node在同一个分布式系统中的时候，他们公用一个group membership。这个membership可以是静态或动态的。静态是指node的数量和角色都是固定不变的。动态的是允许node自由加入或离开网络，也可能在不同时刻担任不同的角色。静态的最简单，也最脆弱。动态的则可以随着node的增多动态调整node之间的关系，可以应对一些错误问题。当有node加入或者离开网络的时候，需要有一种discovery机制。</li>
</ul>
<h4 id="6-1-2-为何要分布式编程模型"><a href="#6-1-2-为何要分布式编程模型" class="headerlink" title="6.1.2 为何要分布式编程模型"></a>6.1.2 为何要分布式编程模型</h4><p>扩展多n多node的第一步是县弄出一个本地的app支持分布逻辑？我们可以只定义抽象的处理逻辑，然某个牛叉的工具去处理这些转化细节么？答案是no。只指出分布式和本地环境的区别是不够的。根据论文 A Note on Distributed Computing所说，在本地编程和分布式编程，有4个重要的区别：延迟、内存访问、部分失败、并发。下面是一个简单的总结：</p>
<ul>
<li>延迟：在协作者之间出现网络意味着每个message都需要更长的时间，可能由于各种网络原因造成延迟</li>
<li>部分失败：当系统的部分功能并不总是可见、有时消失有时又出现，我们很难确定整个系统都能正常工作。</li>
<li>内存访问： 在本地系统中获取一个内存对象的引用基本不会失败，但是对于分布式系统就失败概率就变大了。</li>
<li>并发： no one ‘owner’ of everything</li>
</ul>
<p>由于以上因素，我们不能在分布式环境中使用本地编程模型。akka的切入点恰恰相反，只需要一个分布式编程模型，同时适用于本地系统和分布式系统。前面提到的论文也提到这个观点，但是有些关心会不会把编程难度提高到分布式编程的水平。</p>
<p>时代变了。前面章节我们介绍到了并发编程的易用性。我们已经熟用了异步迭代，部分失败处理，并发之间不共享任何状态，简化了多核编程，我们已经准备好弄一个分布式环境了。</p>
<h2 id="6-2-scale-out-with-remoting"><a href="#6-2-scale-out-with-remoting" class="headerlink" title="6.2 scale out with remoting"></a>6.2 scale out with remoting</h2><p>我们先选区一个最简单的网络拓扑模型：使用两个node组成client-server 静态网络拓扑。两个node一个是前端，一个是后端。REST接口运行在前端node上，BoxOffice和所有的TicketSeller运行在后端node上。node之间互相有一个静态的网络地址引用。如下图：<br><img src="/imgs/akka/akka_6_sigle_to_cli_serv.png" alt="从单个节点到client-&gt;server的变化"></p>
<p>我们需要使用到akka-remote module。</p>
<p>在本地模式中，当有新的Event的时候，BoxOffice Actor就创建TicketSeller actor。在client-server拓扑中也是这样。只是我们可以看到使用akka-remote之后就可以远程创建与发布actor了。前端使用它知道的地址在后端找负责创建TicketSeller的BoxOffice actor。注意还有一个变化就是前端在后端远程部署了一个BoxOffice actor。</p>
<h4 id="6-2-1-动手写程序"><a href="#6-2-1-动手写程序" class="headerlink" title="6.2.1 动手写程序"></a>6.2.1 动手写程序</h4><p>在源码的chapter6文件夹里有一个对chapter2的升级版。</p>
<p>首先我们修改以下sbt文件，添加akka-remote和akka-mutlnode-testkit依赖：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">&quot;com.typesafe.akka&quot;       %%  &quot;akka-remote&quot;                    % akkaVersion,</div><div class="line">&quot;com.typesafe.akka&quot;       %%  &quot;akka-multi-node-testkit&quot;        % akkaVersion   % &quot;test&quot;,</div></pre></td></tr></table></figure></p>
<p>调用sbt update来pull这些依赖。</p>
<h4 id="6-2-2-远程REPL"><a href="#6-2-2-远程REPL" class="headerlink" title="6.2.2 远程REPL"></a>6.2.2 远程REPL</h4><p>akka提供两种方式来获取远程node上的actor引用。一种是通过path，另一种是创建actor，获取它的引用，然后远程发布。先介绍第一种。</p>
<p>REPL控制台是一个很好的交互工具。进入到chapter6目录下，执行sbt console进入REPL，我们需要开启两个session，也就是两个REPL。为了使远程生效，我们需要在src/main/resources下提供一个配置文件application.conf，REPL启动的时候会自动加载它。</p>
<p>在REPL中执行:paste后，贴入以下代码：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">val conf="""</div><div class="line">akka &#123;</div><div class="line">  actor &#123;</div><div class="line">    provider = "akka.remote.RemoteActorRefProvider" // 选择 Remote ActorRef Provider来启动远程</div><div class="line">  &#125;</div><div class="line"> </div><div class="line">  // 远程配置</div><div class="line">  remote &#123; </div><div class="line">    enabled-transports = ["akka.remote.netty.tcp"] // 启用TCP</div><div class="line">    netty.tcp &#123;</div><div class="line">      hostname = "0.0.0.0"</div><div class="line">      port = 2552</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">"""</div></pre></td></tr></table></figure></p>
<p>我们会将这段配置信息加载进ActorSystem。需要注意的是它定义了一个ActorRefProvider来启动akka-remote module。顾名思义，他就是负责远程Actor的ActorRef。</p>
<p>下面代码首先引入必须的配置和actor包，然后把配置加载进了ActorSystem：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">scala&gt; <span class="keyword">import</span> com.typesafe.config._</div><div class="line"> <span class="keyword">import</span> com.typesafe.config._</div><div class="line"></div><div class="line"> scala&gt; <span class="keyword">import</span> akka.actor._</div><div class="line"> <span class="keyword">import</span> akka.actor._</div><div class="line"></div><div class="line"><span class="comment">// 解析字符串配置为对象config</span></div><div class="line"> scala&gt; <span class="keyword">val</span> config = <span class="type">ConfigFactory</span>.parseString(conf)</div><div class="line"> config: com.typesafe.config.<span class="type">Config</span> = ....</div><div class="line"></div><div class="line"><span class="comment">// 使用config对象创建ActorSystem</span></div><div class="line"> scala&gt; <span class="keyword">val</span> backend = <span class="type">ActorSystem</span>(<span class="string">"backend"</span>, config)</div><div class="line"> [<span class="type">Remoting</span>] <span class="type">Starting</span> remoting</div><div class="line"> .....</div><div class="line"> [<span class="type">Remoting</span>] <span class="type">Remoting</span> now listens on addresses:</div><div class="line"> [akka.tcp:<span class="comment">//backend@0.0.0.0:2551]</span></div><div class="line"> backend: akka.actor.<span class="type">ActorSystem</span> = akka:<span class="comment">//backend</span></div></pre></td></tr></table></figure></p>
<p>随着敲完最后一行，我们启动了一个启动了远程的ActorSystem。通过启动远程的config对象，我们启动了后端ActorSystem。如果忘了没有使用这个config，默认akka的application.conf里是不启用远程功能的。下面我们弄一个直接输出输入数据的小的actor：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">scala&gt; :paste</div><div class="line"><span class="comment">// Entering paste mode (ctrl-D to finish)</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Simple</span> <span class="keyword">extends</span> <span class="title">Actor</span> </span>&#123;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</div><div class="line"><span class="keyword">case</span> m =&gt; println(<span class="string">s"received <span class="subst">$m</span>!"</span>)</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">// Exiting paste mode, now interpreting.</span></div><div class="line"><span class="comment">// 使用后端ActorSystem创建这个简单的Actor并命名为simple</span></div><div class="line">scala&gt; backend.actorOf(<span class="type">Props</span>[<span class="type">Simple</span>], <span class="string">"simple"</span>)</div></pre></td></tr></table></figure></p>
<p>这个简单的actor已经运行在后端ActorSystem上了，并且有了名字simple，这样其他的node就可以找到它了。下面我们另起一个终端，开始编写前端：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">val conf = """</div><div class="line">akka &#123;</div><div class="line"></div><div class="line">  actor &#123;</div><div class="line">    provider = "akka.remote.RemoteActorRefProvider"</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  remote &#123;</div><div class="line">    enabled-transports = ["akka.remote.netty.tcp"]</div><div class="line">    netty.tcp &#123;</div><div class="line">      hostname = "0.0.0.0"</div><div class="line">      port = 2551 // 注意端口不同</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">"""</div><div class="line"></div><div class="line"> import com.typesafe.config._</div><div class="line"></div><div class="line"> import akka.actor._</div><div class="line"></div><div class="line"> val config = ConfigFactory.parseString(conf)</div><div class="line"> val frontend= ActorSystem("frontend", config)</div><div class="line"> [Remoting] Starting remoting</div><div class="line"> .....</div><div class="line"> [Remoting] Remoting now listens on addresses:</div><div class="line"> [akka.tcp://backend@0.0.0.0:2552]</div><div class="line"> frontend: akka.actor.ActorSystem = akka://frontend</div></pre></td></tr></table></figure></p>
<p>config同样被加载进了前端的actorSystem。前端actorSystem已经启用了远程，而且启动起来了。下面我们想办法在前端获取Simple Actor的引用。我们首先构建一个actor path。下图是path的组成：<br><img src="/imgs/akka/akka_6_remote_actor_path.png" alt="actor path的组成"></p>
<p>我们可以使用前端actorSystem的actorSelection方法通过path获取到后端ActorSystem的simple ActorRef：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">scala&gt; :paste</div><div class="line"><span class="comment">// Entering paste mode (ctrl-D to finish)</span></div><div class="line"><span class="keyword">val</span> path = <span class="string">"akka.tcp://backend@0.0.0.0:2551/user/simple"</span></div><div class="line"><span class="keyword">val</span> simple = frontend.actorSelection(path)</div><div class="line"><span class="comment">// Exiting paste mode, now interpreting.</span></div><div class="line">path: <span class="type">String</span> = akka.tcp:<span class="comment">//backend@0.0.0.0:2551/user/simple</span></div><div class="line">simple: akka.actor.<span class="type">ActorSelection</span> =</div><div class="line"><span class="type">ActorSelection</span>[<span class="type">Actor</span>[akka.tcp:<span class="comment">//backend@0.0.0.0:2551/]/user/simple]</span></div></pre></td></tr></table></figure></p>
<p>ctorSelection可以用来发送一些message给所有符合条件的actor。下面我们就在前端发送一个信息给后端：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">scala&gt; simple ! <span class="string">"Hello Remote World!"</span></div></pre></td></tr></table></figure></p>
<p>切换到后端的终端上，可以看到，我们收到并打印出了这条message：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">scala&gt; received <span class="type">Hello</span> <span class="type">Remote</span> <span class="type">World</span>!!</div></pre></td></tr></table></figure></p>
<p>过程是message被序列化，发送给一个TCP socket，通过远程module收到，然后反序列化，再交给后端的Simple Actor处理。</p>
<h4 id="6-2-3-远程查找"><a href="#6-2-3-远程查找" class="headerlink" title="6.2.3 远程查找"></a>6.2.3 远程查找</h4><p>我们并不会直接在RestInterface actor中直接创建BoxOffice actor，而是在后端node上找BoxOffice。如下图：<br><img src="/imgs/akka/akka_6_remotelooup_boxoffice_actor.png" alt="远程查找BoxOffice actor"><br>前面版本的RestInterface是直接创建的BoxOffice actor：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> boxOffice = context.actorOf(<span class="type">Props</span>[<span class="type">BoxOffice</span>], <span class="string">"boxOffice"</span>)</div></pre></td></tr></table></figure></p>
<p>这样调用的话二者就是直接的父子关系。为了让app更灵活一些，使之也能适应分布式系统，我们把这段代码放进一个trait，然后后面再mixin。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 这个trait必须被mixin进一个actor才能使用context</span></div><div class="line"><span class="class"><span class="keyword">trait</span> <span class="title">BoxOfficeCreator</span> </span>&#123; <span class="keyword">this</span>: <span class="type">Actor</span> =&gt;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">createBoxOffice</span></span>:<span class="type">ActorRef</span> = context.actorOf(<span class="type">Props</span>[<span class="type">BoxOffice</span>],<span class="string">"boxOffice"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// RestApi trait包含了RestInterface actor的所有逻辑</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestInterface</span> <span class="keyword">extends</span> <span class="title">HttpServiceActor</span></span></div><div class="line">                    <span class="keyword">with</span> <span class="type">RestApi</span> &#123;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= runRoute(routes)</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">trait</span> <span class="title">RestApi</span> <span class="keyword">extends</span> <span class="title">HttpService</span> <span class="keyword">with</span> <span class="title">ActorLogging</span> <span class="keyword">with</span> <span class="title">BoxOfficeCreator</span> </span>&#123; actor: <span class="type">Actor</span> =&gt;</div><div class="line">  <span class="keyword">val</span> boxOffice = createBoxOffice <span class="comment">//使用BoxOfficeCreator trait中定义的方法创建BoxOffice</span></div><div class="line">	......</div><div class="line">	.....</div></pre></td></tr></table></figure></p>
<p>这样我们把创建BoxOffice的代码抽取到了一个trait中，然后在RestInterface把它设置为创建本地boxOffice的默认方法。</p>
<p>下面就定义三个入口方法：SingleNodeMain、FrontendMain、BackendMain。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 单点</span></div><div class="line">  <span class="keyword">val</span> system = <span class="type">ActorSystem</span>(<span class="string">"singlenode"</span>, config)</div><div class="line"></div><div class="line">  <span class="keyword">val</span> restInterface = system.actorOf(<span class="type">Props</span>[<span class="type">RestInterface</span>],</div><div class="line">                                     <span class="string">"restInterface"</span>)</div><div class="line"></div><div class="line"><span class="comment">// FrontendMain</span></div><div class="line">  <span class="keyword">val</span> config = <span class="type">ConfigFactory</span>.load(<span class="string">"frontend"</span>)</div><div class="line">  <span class="keyword">val</span> system = <span class="type">ActorSystem</span>(<span class="string">"frontend"</span>, config)</div><div class="line"></div><div class="line"></div><div class="line">  <span class="comment">// mixin RemoteBoxOfficeCreator trait </span></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">FrontendRestInterface</span> <span class="keyword">extends</span> <span class="title">RestInterface</span></span></div><div class="line">                              <span class="keyword">with</span> <span class="type">RemoteBoxOfficeCreator</span></div><div class="line"></div><div class="line">  <span class="comment">// 使用mixin的RemoteBoxOfficeCreator trait的FrontendRestInterface创建rest接口</span></div><div class="line">  <span class="keyword">val</span> restInterface = system.actorOf(<span class="type">Props</span>[<span class="type">FrontendRestInterface</span>],</div><div class="line">                                     <span class="string">"restInterface"</span>)</div><div class="line"></div><div class="line"><span class="comment">// BackendMain</span></div><div class="line">  <span class="keyword">val</span> config = <span class="type">ConfigFactory</span>.load(<span class="string">"backend"</span>)</div><div class="line">  <span class="keyword">val</span> system = <span class="type">ActorSystem</span>(<span class="string">"backend"</span>, config)</div><div class="line"></div><div class="line">  system.actorOf(<span class="type">Props</span>[<span class="type">BoxOffice</span>], <span class="string">"boxOffice"</span>)</div></pre></td></tr></table></figure>
<p>以上三个入口分别加载的是singlenode.conf, frontend.conf ， backend.conf配置文件里的配置。frontend.conf相对多出一个部分来指定怎样找boxoffice actor。RemoteBoxOfficeCreator负责加载这部分配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">backend &#123;</div><div class="line">  host = &quot;0.0.0.0&quot;</div><div class="line">  port = 2552</div><div class="line">  protocol = &quot;akka.tcp&quot;</div><div class="line">  system = &quot;backend&quot;</div><div class="line">  actor = &quot;user/boxOffice&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>boxoffice actor的路径是从这个配置部分获取并构建的。下面就是像前面REPL一样使用Actor Selection获取远程Actor，一旦确认后端正常，我们就可以尝试发送message了。这次我们希望使用ActorRef而不是单节点那样使用，下面是RemoteBoxOfficeCreator的代码：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">RemoteBoxOfficeCreator</span> </span>&#123;</div><div class="line">  <span class="keyword">val</span> config = <span class="type">ConfigFactory</span>.load(<span class="string">"frontend"</span>).getConfig(<span class="string">"backend"</span>)</div><div class="line">  <span class="keyword">val</span> host = config.getString(<span class="string">"host"</span>)</div><div class="line">  <span class="keyword">val</span> port = config.getInt(<span class="string">"port"</span>)</div><div class="line">  <span class="keyword">val</span> protocol = config.getString(<span class="string">"protocol"</span>)</div><div class="line">  <span class="keyword">val</span> systemName = config.getString(<span class="string">"system"</span>)</div><div class="line">  <span class="keyword">val</span> actorName = config.getString(<span class="string">"actor"</span>)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">trait</span> <span class="title">RemoteBoxOfficeCreator</span> <span class="keyword">extends</span> <span class="title">BoxOfficeCreator</span> </span>&#123; <span class="keyword">this</span>:<span class="type">Actor</span> =&gt;</div><div class="line">  <span class="keyword">import</span> <span class="type">RemoteBoxOfficeCreator</span>._</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">createPath</span></span>:<span class="type">String</span> = &#123;</div><div class="line">    <span class="string">s"<span class="subst">$protocol</span>://<span class="subst">$systemName</span>@<span class="subst">$host</span>:<span class="subst">$port</span>/<span class="subst">$actorName</span>"</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createBoxOffice</span></span>:<span class="type">ActorRef</span> = &#123;</div><div class="line">    <span class="keyword">val</span> path = createPath</div><div class="line">    context.actorOf(<span class="type">Props</span>(classOf[<span class="type">RemoteLookup</span>],path), <span class="string">"lookupBoxOffice"</span>) <span class="comment">// 创建一个负责寻找boxoffice actor的actor，这个actor的参数是远程boxoffice的path</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>RemoteBoxOfficeCreator创建了一个额外的actor RemoteLookup来寻找boxOffice。在前面版本的akka里你可能会使用actorFor方法来直接获取一个远程actor的ActorRef。但是这个方法目前已经过期了，因为如果actor本身挂掉的话，他返回的ActorRef的表现并不完全像本地actor一样。还有就是通过actorFor返回的ActorRef可以指向一个新建的远程actor实例，这对本地context来说绝无可能。再一个原因就是不能像本地actor那样监控它的终结message。所以把这个方法废除了。取而代之的是RemoteLookup actor：</p>
<ul>
<li>后端ActorSystem可能还没有启动，或者暂时挂掉了，正在重启</li>
<li>boxOffice actor本身也可能挂掉重启中</li>
<li>理想状态下我们能先于前端启动后端</li>
</ul>
<p>RemoteLookup负责处理以上这些场景。下路是RemoteLookup在RestInterface和BoxOffice的作用，它主要负责传递message给RestInterface：<br><img src="/imgs/akka/akka_6_remotelooup_actor.png" alt="RestInterface actor"></p>
<p>RemoteLookup actor是一个只包含两种状态的状态机：identify或者active。它使用become方法在这两种状态之间进行切换。当RemoteLookup想要获取一个BoxOffice的ActorRef的时候，如果它暂时还没有，就是在identify状态。不然它就是在active状态，传递所有的message到一个有效的BoxOffice ActorRef。</p>
<p>如果RemoteLookup发现BoxOffice已经被终结了，他会在接收不到message的一段时间后，重新获取一个有效的ActorRef。我们使用RemoteDeath监控这种情况。这东西我们并不陌生，跟普通的actor监控是一样的：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RemoteLookup</span>(<span class="params">path:<span class="type">String</span></span>)</span></div><div class="line">  <span class="keyword">extends</span> <span class="type">Actor</span> <span class="keyword">with</span> <span class="type">ActorLogging</span> &#123;</div><div class="line"></div><div class="line">  <span class="comment">// 若3秒内没有收到任何message，就发送一个ReceiveTimeout消息 </span></div><div class="line">  context.setReceiveTimeout(<span class="number">3</span> seconds)</div><div class="line">  <span class="comment">// 马上请求actor的identify</span></div><div class="line">  sendIdentifyRequest()</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">sendIdentifyRequest</span></span>(): <span class="type">Unit</span> = &#123;</div><div class="line">    <span class="comment">// 使用path获取actor</span></div><div class="line">    <span class="keyword">val</span> selection = context.actorSelection(path)</div><div class="line">    <span class="comment">// 向actorSelection发送一个Identify message</span></div><div class="line">    selection ! <span class="type">Identify</span>(path)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= identify</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">identify</span></span>:<span class="type">Receive</span> = &#123;</div><div class="line">    <span class="keyword">case</span> <span class="type">ActorIdentity</span>(`path`, <span class="type">Some</span>(actor)) =&gt; <span class="comment">// 某个actor已经被确认(identified)了，返回它的ActorRef</span></div><div class="line">      context.setReceiveTimeout(<span class="type">Duration</span>.<span class="type">Undefined</span>) <span class="comment">// 既然当前actor已经是active了，就不用发送ReceiveTimeout了</span></div><div class="line">      log.info(<span class="string">"switching to active state"</span>)</div><div class="line">      context.become(active(actor))	<span class="comment">// 修改状态</span></div><div class="line">      context.watch(actor)		<span class="comment">// 监视</span></div><div class="line"></div><div class="line">    <span class="keyword">case</span> <span class="type">ActorIdentity</span>(`path`, <span class="type">None</span>) =&gt;   <span class="comment">// actor还不可用，后端连不上，或者还没有启动</span></div><div class="line">      log.error(<span class="string">s"Remote actor with path <span class="subst">$path</span> is not available."</span>)</div><div class="line"></div><div class="line">    <span class="keyword">case</span> <span class="type">ReceiveTimeout</span> =&gt; <span class="comment">// 如果还没有收到message，就继续identify远程actor</span></div><div class="line">      sendIdentifyRequest()</div><div class="line"></div><div class="line">    <span class="keyword">case</span> msg:<span class="type">Any</span> =&gt;   	<span class="comment">// 在identify接收状态下，不发送任何message</span></div><div class="line">      log.error(<span class="string">s"Ignoring message <span class="subst">$msg</span>, remote actor is not ready yet."</span>)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">active</span></span>(actor: <span class="type">ActorRef</span>): <span class="type">Receive</span> = &#123;</div><div class="line">    <span class="keyword">case</span> <span class="type">Terminated</span>(actorRef) =&gt;  	<span class="comment">// 如果远程的actor被终结，RemoteLookup应修改它的状态到identify接收状态</span></div><div class="line">      log.info(<span class="string">"Actor $actorRef terminated."</span>)</div><div class="line">      log.info(<span class="string">"switching to identify state"</span>)</div><div class="line">      context.become(identify)</div><div class="line">      context.setReceiveTimeout(<span class="number">3</span> seconds)</div><div class="line">      sendIdentifyRequest()</div><div class="line"></div><div class="line">    <span class="keyword">case</span> msg:<span class="type">Any</span> =&gt; actor forward msg		<span class="comment">// 当远程actor是active的时候，向下传递所有其他message</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>发送Identify message到ActorSelection来获取boxOffice的ActorRef。后端ActorSystem的远程module对应返回一个包含远程actor的ActorRef的 ActorIdentity message。</p>
<p>这样就完成了从一个单节点应用改到前后端node。除了能够远程通信，前端和后端还可以分开启动，前端会去找boxoffice，当boxoffice可用的时候就与之通信，不可用就采取其他措施。</p>
<p>最后就是运行FrontendMain和BackendMain。启动两个终端，分别使用sbt run指定入口类运行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[info] ...</div><div class="line">[info] ... (sbt messages)</div><div class="line">[info] ...</div><div class="line">Multiple main classes detected, select one to run:</div><div class="line">[1] com.goticks.SingleNodeMain</div><div class="line">[2] com.goticks.FrontendMain</div><div class="line">[3] com.goticks.BackendMain</div><div class="line">Enter number:</div></pre></td></tr></table></figure></p>
<p>测试一下如果kill掉后端，再重启。</p>
<p>远程event的生命周期默认是打在日志里的，可以帮主我们更快定位问题。我们还可以使用actorSystem的eventStream方法定于远程生命周期event，后面第十章会提到。考虑到连接管理，再考虑到我们可以像本地actor一样监视远程actor，我们就没必要再针对event做什么额外操作了。</p>
<p>重新看一下修改的地方：</p>
<ul>
<li>抽出 BoxOfficeCreator trait。远程版本中向后端请求查找Boxoffice。</li>
<li>RemoteBoxOfficeCreator在RestInterface和BoxOffice之间添加了一个RemoteLookup actor。它负责传递他收到的所有的消息给boxoffice。它还identifyboxoffice的actorRef，并且远程监视boxoffice的actor。</li>
</ul>
<h4 id="6-2-4-远程发布"><a href="#6-2-4-远程发布" class="headerlink" title="6.2.4 远程发布"></a>6.2.4 远程发布</h4><p>前面说到akka提供了两种方式获取远程actor的ActorRef。下面我们介绍第二种，远程发布。</p>
<p>远程发布可以通过编程或配置实现。我们先弄一下配置方式的远程发布。它的好处就是不需要重新构建app就可以修改集群。标准的 BoxOfficeCreator trait 创建boxOffice，并把后者当做自己的一个子actor：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> boxOffice = context.actorOf(<span class="type">Props</span>[<span class="type">BoxOffice</span>], <span class="string">"boxOffice"</span>)</div></pre></td></tr></table></figure></p>
<p>local path是/restInterface/boxOffice，注意这里没有/user。当我们使用基于配置的远程发布的时候，我们只需要告诉前端actorSystem，创建/restInterface/boxOffice的actor的时候，应该是远程创建。通过如下配置实现：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">actor &#123;</div><div class="line">  provider = &quot;akka.remote.RemoteActorRefProvider&quot;</div><div class="line"></div><div class="line">  deployment &#123;</div><div class="line">    /restInterface/boxOffice &#123;  // 使用这个path的actor都应该被远程发布</div><div class="line">      remote = &quot;akka.tcp://backend@0.0.0.0:2552&quot;   // 远程发布的目标地址，应该就是后端监听的端口</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>基于编程的远程发布相比起来简直就没有存在的必要。大多数情况下我们都使用基于配置的远程发布。但是有时，假如你要通过CNAMES引用不同的node，写代码就方便些。当时用akka-cluster的时候，完全动态远程发布就很有意义了，因为它可以支持动态membership。下面是一个基于编程的远程发布实例：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> uri = <span class="string">"akka.tcp://backend@0.0.0.0:2552"</span></div><div class="line"> <span class="keyword">val</span> backendAddress = <span class="type">AddressFromURIString</span>(uri) <span class="comment">// 从uri创建一个后端地址</span></div><div class="line"> <span class="comment">// 使用远程发布范围创建一个Props</span></div><div class="line"> <span class="keyword">val</span> props = <span class="type">Props</span>[<span class="type">BoxOffice</span>].withDeploy(</div><div class="line">   <span class="type">Deploy</span>(scope = <span class="type">RemoteScope</span>(backendAddress))</div><div class="line"> )</div><div class="line"> context.actorOf(props, <span class="string">"boxOffice"</span>)</div></pre></td></tr></table></figure></p>
<p>上面代码也是在后端远程创建与发布了一个boxOffice。</p>
<p>注意，远程发布并不是akka把实际的BoxOffice的class文件传送给远程server实现，而是远程server本身就有这个actor。如果后端远程ActorSystem挂掉并重启，这个ActorRef并不会自动关联到新的远程actor实例。这个实例是通过远程发布的，所以后端ActorSystem中不能是已经启动了的。基于这两点改变，下面是新的Main方法:<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 前端不再创建boxOffice</span></div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">BackendRemoteDeployMain</span> <span class="keyword">extends</span> <span class="title">App</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">val</span> config = <span class="type">ConfigFactory</span>.load(<span class="string">"backend"</span>)</div><div class="line">  <span class="keyword">val</span> system = <span class="type">ActorSystem</span>(<span class="string">"backend"</span>, config)</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 后端不再mixin一些trait，使用默认的BoxOfficeCreator</span></div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">FrontendRemoteDeployWatchMain</span> <span class="keyword">extends</span> <span class="title">App</span> </span>&#123;</div><div class="line">  <span class="keyword">val</span> config = <span class="type">ConfigFactory</span>.load(<span class="string">"frontend-remote-deploy"</span>)</div><div class="line"></div><div class="line">  <span class="keyword">val</span> host = config.getString(<span class="string">"http.host"</span>)</div><div class="line">  <span class="keyword">val</span> port = config.getInt(<span class="string">"http.port"</span>)</div><div class="line"></div><div class="line">  <span class="keyword">val</span> system = <span class="type">ActorSystem</span>(<span class="string">"frontend"</span>, config)</div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">RestInterfaceWatch</span> <span class="keyword">extends</span> <span class="title">RestInterface</span></span></div><div class="line">                           <span class="keyword">with</span> <span class="type">ConfiguredRemoteBoxOfficeDeployment</span></div><div class="line"></div><div class="line">  <span class="keyword">val</span> restInterface = system.actorOf(<span class="type">Props</span>[<span class="type">RestInterfaceWatch</span>],</div><div class="line">  <span class="string">"restInterface"</span>)</div><div class="line"></div><div class="line">  <span class="type">Http</span>(system).manager ! <span class="type">Bind</span>(listener = restInterface,</div><div class="line">  interface = host,</div><div class="line">  port =port)</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>分别在两个终端下运行这两个main方法，尝试使用httpie创建event，会看到下面的message在前端ActorSystem打印出来：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// very long message, formatted in a couple of lines to fit.</div><div class="line">INFO [RestInterface]: Received new event Event(RHCP,10), sending to</div><div class="line">Actor[akka.tcp://backend@0.0.0.0:2552/remote/akka.tcp/</div><div class="line"> frontend@0.0.0.0:2551/user/restInterface/boxOffice#-1230704641]</div></pre></td></tr></table></figure></p>
<p>这是说前端向后端发送了一个message来远程发布了boxOffice。</p>
<p>目前来说一切都顺利。可是有个问题：如果前端尝试远程发布的时候后端没有启动会咋样，因为还是会获得一个ActorRef。即便后端ActorSystem一会儿启动了，这个ActorRef还是不可用。要解决这个问题，我们还是要对这个ActorRef添加监视。我们需要像前面RemoteLookup actor那样放一个actor在RestInterface和boxOffice之间，这次是RemoteBoxOfficeForwarder。</p>
<p>我们需要稍微修改以下配置文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">actor &#123;</div><div class="line">  provider = &quot;akka.remote.RemoteActorRefProvider&quot;</div><div class="line"></div><div class="line">  deployment &#123;</div><div class="line">    /restInterface/forwarder/boxOffice &#123;</div><div class="line">      remote = &quot;akka.tcp://backend@0.0.0.0:2552&quot;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>下面是ConfiguredRemoteBoxOfficeDeployment和RemoteBoxOfficeForwarder的代码：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">trait</span> <span class="title">ConfiguredRemoteBoxOfficeDeployment</span> <span class="keyword">extends</span> <span class="title">BoxOfficeCreator</span> </span>&#123; <span class="keyword">this</span>:<span class="type">Actor</span> =&gt;</div><div class="line"></div><div class="line">  <span class="comment">// 创建一个forwarder来负责监视和发布远程的BoxOffice</span></div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createBoxOffice</span> </span>= &#123;</div><div class="line">    context.actorOf(<span class="type">Props</span>[<span class="type">RemoteBoxOfficeForwarder</span>],</div><div class="line">                           <span class="string">"forwarder"</span>)</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RemoteBoxOfficeForwarder</span> <span class="keyword">extends</span> <span class="title">Actor</span> <span class="keyword">with</span> <span class="title">ActorLogging</span> </span>&#123;</div><div class="line">  context.setReceiveTimeout(<span class="number">3</span> seconds)</div><div class="line"></div><div class="line">  <span class="comment">// 远程发布并监视BoxOffice</span></div><div class="line">  deployAndWatch()</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">deployAndWatch</span></span>(): <span class="type">Unit</span> = &#123;</div><div class="line">    <span class="keyword">val</span> actor = context.actorOf(<span class="type">Props</span>[<span class="type">BoxOffice</span>], <span class="string">"boxOffice"</span>)</div><div class="line">    context.watch(actor)</div><div class="line">    log.info(<span class="string">"switching to maybe active state"</span>)</div><div class="line">    context.become(maybeActive(actor))</div><div class="line">    context.setReceiveTimeout(<span class="type">Duration</span>.<span class="type">Undefined</span>)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= deploying</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">deploying</span></span>:<span class="type">Receive</span> = &#123;</div><div class="line"></div><div class="line">    <span class="keyword">case</span> <span class="type">ReceiveTimeout</span> =&gt;</div><div class="line">      deployAndWatch()</div><div class="line"></div><div class="line">    <span class="keyword">case</span> msg:<span class="type">Any</span> =&gt;</div><div class="line">      log.error(<span class="string">s"Ignoring message <span class="subst">$msg</span>, remote actor is not ready yet."</span>)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">maybeActive</span></span>(actor:<span class="type">ActorRef</span>): <span class="type">Receive</span> = &#123;</div><div class="line">    <span class="keyword">case</span> <span class="type">Terminated</span>(actorRef) =&gt; 	<span class="comment">// 远程发布的actor被终结，那就重新远程发布一个</span></div><div class="line">      log.info(<span class="string">"Actor $actorRef terminated."</span>)</div><div class="line">      log.info(<span class="string">"switching to deploying state"</span>)</div><div class="line">      context.become(deploying)</div><div class="line">      context.setReceiveTimeout(<span class="number">3</span> seconds)</div><div class="line">      deployAndWatch()</div><div class="line"></div><div class="line">    <span class="keyword">case</span> msg:<span class="type">Any</span> =&gt; actor forward msg</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>RemoteBoxOfficeForwarder和上文的RemoteLookup特别像，都有一个状态机，不过它是 ‘deploying’ 或  ‘maybe active’。没有actor selection，我们不能确认远程actor是否已经真的被发布了。 为RemoteBoxOfficeForwarder添加远程actorSelection的任务就交给读者你了，就是当前’maybe’的状态机。</p>
<p>前端的main类mixin了ConfiguredRemoteBoxOfficeDeployment。看一下FrontendRemoteDeployWatchMain：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestInterfaceWatch</span> <span class="keyword">extends</span> <span class="title">RestInterface</span></span></div><div class="line">                         <span class="keyword">with</span> <span class="type">ConfiguredRemoteBoxOfficeDeployment</span></div><div class="line"></div><div class="line"><span class="keyword">val</span> restInterface = system.actorOf(<span class="type">Props</span>[<span class="type">RestInterfaceWatch</span>],</div><div class="line"><span class="string">"restInterface"</span>)</div></pre></td></tr></table></figure></p>
<p>重新启动前后端的程序，测试一把。</p>
<p>我们把lookup和远程发布两种方式都可以使程序特别有韧性。即便在只有两个node的时候，我们最好也能在最开始就弄的特别有韧性。</p>
<h4 id="6-2-5-Multi-JVM-testing"><a href="#6-2-5-Multi-JVM-testing" class="headerlink" title="6.2.5 Multi-JVM testing"></a>6.2.5 Multi-JVM testing</h4><p>sbt multi-jvm插件可以用来进行跨JVM的测试，这对于分布式系统是很重要的。需要在sbt配置文件中添加：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">addSbtPlugin(&quot;com.typesafe.sbt&quot; % &quot;sbt-multi-jvm&quot; % &quot;0.3.5&quot;)</div></pre></td></tr></table></figure></p>
<p>我们需要额外添加另一个sbt构件文件来使用它。 Multi-JVM插件只支持scala DSL版本的sbt下过目文件，是；uoyi我们需要在chapter6/project文件夹下添加GoTicksBuild.scala文件。Sbt会自动merge build.sbt和GoTicksBuild.scala。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> sbt._</div><div class="line"><span class="keyword">import</span> <span class="type">Keys</span>._</div><div class="line"><span class="keyword">import</span> com.typesafe.sbt.<span class="type">SbtMultiJvm</span></div><div class="line"><span class="keyword">import</span> com.typesafe.sbt.<span class="type">SbtMultiJvm</span>.<span class="type">MultiJvmKeys</span>.&#123; <span class="type">MultiJvm</span> &#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">GoTicksBuild</span> <span class="keyword">extends</span> <span class="title">Build</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">lazy</span> <span class="keyword">val</span> buildSettings = <span class="type">Defaults</span>.defaultSettings ++ multiJvmSettings ++ <span class="type">Seq</span>(</div><div class="line">    crossPaths   := <span class="literal">false</span></div><div class="line">  )</div><div class="line"></div><div class="line">  <span class="keyword">lazy</span> <span class="keyword">val</span> goticks = <span class="type">Project</span>(</div><div class="line">    id = <span class="string">"goticks"</span>,</div><div class="line">    base = file(<span class="string">"."</span>),</div><div class="line">    settings = buildSettings ++ <span class="type">Project</span>.defaultSettings</div><div class="line">  ) configs(<span class="type">MultiJvm</span>)</div><div class="line"></div><div class="line">  <span class="keyword">lazy</span> <span class="keyword">val</span> multiJvmSettings = <span class="type">SbtMultiJvm</span>.multiJvmSettings ++ <span class="type">Seq</span>(</div><div class="line">    <span class="comment">// make sure that MultiJvm test are compiled by the default test compilation</span></div><div class="line">    compile in <span class="type">MultiJvm</span> &lt;&lt;= (compile in <span class="type">MultiJvm</span>) triggeredBy (compile in <span class="type">Test</span>),</div><div class="line">    <span class="comment">// disable parallel tests</span></div><div class="line">    parallelExecution in <span class="type">Test</span> := <span class="literal">false</span>,</div><div class="line">    <span class="comment">// make sure that MultiJvm tests are executed by the default test target</span></div><div class="line">    executeTests in <span class="type">Test</span> &lt;&lt;=</div><div class="line">      ((executeTests in <span class="type">Test</span>), (executeTests in <span class="type">MultiJvm</span>)) map &#123;</div><div class="line">        <span class="keyword">case</span> ((_, testResults), (_, multiJvmResults))  =&gt;</div><div class="line">          <span class="keyword">val</span> results = testResults ++ multiJvmResults</div><div class="line">          (<span class="type">Tests</span>.overall(results.values), results)</div><div class="line">      &#125;</div><div class="line">  )</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果你对sbt不熟，不用担心这个文件的细节。上面基本就是配置了multi-jvm插件，确认multi-jvm测试使用普通单元测试执行。要是想看看sbt的话，可以参考SBT in Action。</p>
<p>多jvm的测试默认是应该写在 src/multi-jvm/scala 文件夹下。既然我们的项目已经正确配置了，那么我们可以开始写代码测试goticks的前端和后端了。</p>
<p>首先定义MultiNodeConfig描述测试的node的角色。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">ClientServerConfig</span> <span class="keyword">extends</span> <span class="title">MultiNodeConfig</span> </span>&#123;</div><div class="line">  <span class="keyword">val</span> frontend = role(<span class="string">"frontend"</span>)</div><div class="line">  <span class="keyword">val</span> backend = role(<span class="string">"backend"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>定义了两个role。role用来确认参与测试的node运行的代码，以便于针对性的测试。在写测试之前我们需要些一些基础设施代码：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">trait</span> <span class="title">STMultiNodeSpec</span> <span class="keyword">extends</span> <span class="title">MultiNodeSpecCallbacks</span></span></div><div class="line"><span class="keyword">with</span> <span class="type">WordSpec</span> <span class="keyword">with</span> <span class="type">MustMatchers</span> <span class="keyword">with</span> <span class="type">BeforeAndAfterAll</span> &#123;</div><div class="line"></div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">beforeAll</span></span>() = multiNodeSpecBeforeAll()</div><div class="line"></div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">afterAll</span></span>() = multiNodeSpecAfterAll()</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>其中继承MultiNodeSpecCallbacks以获取回调函数，然后下面重写了几个回调函数。</p>
<p>下面我们创建MultiNodeSpec，并让他mixin刚刚定义的STMultiNodeSpec。两个版本的ClientServerSpec会运行在不同的两个jvm上。下面是ClientServerSpec：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClientServerSpecMultiJvmFrontend</span> <span class="keyword">extends</span> <span class="title">ClientServerSpec</span></span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClientServerSpecMultiJvmBackend</span> <span class="keyword">extends</span> <span class="title">ClientServerSpec</span></span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClientServerSpec</span> <span class="keyword">extends</span> <span class="title">MultiNodeSpec</span>(<span class="params"><span class="type">ClientServerConfig</span></span>)</span></div><div class="line"><span class="keyword">with</span> <span class="type">STMultiNodeSpec</span> <span class="keyword">with</span> <span class="type">ImplicitSender</span> &#123;</div><div class="line"></div><div class="line">  <span class="comment">// 参加到这次测试的node个数</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">initialParticipants</span> </span>= roles.size</div></pre></td></tr></table></figure></p>
<p>ClientServerSpec使用了STMultiNodeSpec和ImplicitSender。后者设置testActor为所有message的默认sender，这样不用每次都设置了。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// import后我们才可以访问到后端role</span></div><div class="line"><span class="keyword">import</span> <span class="type">ClientServerConfig</span>._</div><div class="line"></div><div class="line"><span class="comment">// 测试中使用TestRemoteBoxOfficeCreator，而不是RemoteBoxOfficeCreator</span></div><div class="line"><span class="class"><span class="keyword">trait</span> <span class="title">TestRemoteBoxOfficeCreator</span> <span class="keyword">extends</span> <span class="title">RemoteBoxOfficeCreator</span> </span>&#123; <span class="keyword">this</span>:<span class="type">Actor</span> =&gt;</div><div class="line"></div><div class="line">  <span class="comment">// 重写方法，返回测试的path</span></div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">createPath</span></span>: <span class="type">String</span> = &#123;</div><div class="line">    <span class="keyword">val</span> actorPath = node(backend) / <span class="string">"user"</span> /<span class="string">"boxOffice"</span>		<span class="comment">//node方法返回后端role node的地址。这个表达式是创建了一个ActorPath</span></div><div class="line">    actorPath.toString</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>前端和后端role node默认是在随机端口上运行。我们使用TestRemoteBoxOfficeCreator替代RemoteBoxOfficeCreator，因为后者是使用的frontend.conf文件中的配置。我们在测试中需要找的是不一样的环境。</p>
<p>看一下测试代码：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="string">"A Client Server configured app"</span> must &#123;</div><div class="line"></div><div class="line">    <span class="string">"wait for all nodes to enter a barrier"</span> in &#123;</div><div class="line">      enterBarrier(<span class="string">"startup"</span>) <span class="comment">// 启动所有的node</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="string">"be able to create an event and sell a ticket"</span> in &#123;</div><div class="line"></div><div class="line">      <span class="comment">// 运行在前端jvm的代码</span></div><div class="line">      runOn(frontend) &#123;</div><div class="line"> 	<span class="comment">// 等待后端发布</span></div><div class="line">        enterBarrier(<span class="string">"deployed"</span>)</div><div class="line">        <span class="comment">// 创建一个RestInterfaceMock</span></div><div class="line">	<span class="keyword">val</span> restInterface = system.actorOf(<span class="type">Props</span>(<span class="keyword">new</span> <span class="type">RestInterfaceMock</span> <span class="keyword">with</span> <span class="type">TestRemoteBoxOfficeCreator</span>))</div><div class="line"></div><div class="line">        <span class="keyword">val</span> path = node(backend) / <span class="string">"user"</span> / <span class="string">"boxOffice"</span></div><div class="line">        </div><div class="line">	<span class="comment">// 获取远程actor的actorSelection</span></div><div class="line">	<span class="keyword">val</span> actorSelection = system.actorSelection(path)</div><div class="line"></div><div class="line"> 	<span class="comment">// 向actorselection发送Identify消息</span></div><div class="line">        actorSelection.tell(<span class="type">Identify</span>(path), testActor)</div><div class="line"></div><div class="line">	<span class="comment">// 等待boxoffice汇报它是否可用。RemoteLookup类会负责获取boxoffice的ActorRef</span></div><div class="line">        <span class="keyword">val</span> actorRef = expectMsgPF() &#123;</div><div class="line">          <span class="keyword">case</span> <span class="type">ActorIdentity</span>(`path`, ref) =&gt; ref</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        restInterface ! <span class="type">Event</span>(<span class="string">"RHCP"</span>, <span class="number">1</span>)</div><div class="line"></div><div class="line">        expectMsg(<span class="type">EventCreated</span>)</div><div class="line"></div><div class="line">        restInterface ! <span class="type">TicketRequest</span>(<span class="string">"RHCP"</span>)</div><div class="line"></div><div class="line">        expectMsg(<span class="type">Ticket</span>(<span class="string">"RHCP"</span>, <span class="number">1</span>))</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 运行在后端JVM上的代码</span></div><div class="line">      runOn(backend) &#123;</div><div class="line">	<span class="comment">// 创建boxOffice，并命名为boxOffice，这样RemoteLookup就可以找到它了</span></div><div class="line">        system.actorOf(<span class="type">Props</span>[<span class="type">BoxOffice</span>], <span class="string">"boxOffice"</span>)</div><div class="line">	<span class="comment">// 发送后端已经部署的信号</span></div><div class="line">        enterBarrier(<span class="string">"deployed"</span>)</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 测试结束</span></div><div class="line">      enterBarrier(<span class="string">"finished"</span>)</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>这段测试可以分为4个部分。第一个是enterBarrier(“startup”)等待所有node启动。实际的测试会面就会指定前端和后端各自运行什么代码。前端会等后端启动成功的信号，然后执行测试。</p>
<p>后段代码只启动boxoffice，提供给前端使用。我们使用了RestInterfaceMock，TestRemoteBoxOfficeCreator。我们还是使用了RemoteLookup来等远程的actor被identify。 在发送message到远程boxoffice之前，我们先期望获得一个ActorIdentify message。</p>
<p>在项目目录下执行multi-jvm:test进行测试。</p>
<p>下图说明了测试的实际流程。<br><img src="/imgs/akka/akka_6_multi_jvm_test_flow.png" alt="Multi-JVM Test Flow"></p>
<p>单节点运行和client server 模式的最大区别就是actorRef的获取与监视。在RestInterface和boxOffice 之间添加一个Remote Lookup，获取更大的灵活性，也能够更好地处理actor挂掉的问题。我们怎样等待远程actorRef可用呢？actorSelection和Identify message机制可以搞定。</p>
<h2 id="6-3-总结"><a href="#6-3-总结" class="headerlink" title="6.3 总结"></a>6.3 总结</h2><p>记得本章开始的时候我们要分布式的理由么？</p>
<p>除了我们要做一些改变之外，还有一些不变的事情：</p>
<ul>
<li>我们使用ActorRef，不用关心它是远程actor还是本地actor</li>
<li>监控actor的API和local模式一样</li>
<li>除了协作者被网络分隔之外，我们通过中间actor，让RestInterface和BoxOffice互相通信。</li>
</ul>
<p>我们学到的新东西：</p>
<ul>
<li>REPL提供了一个简单友好的方式来探索分布式拓扑</li>
<li>multi-node-testkit使得分布式系统的测试特别简单，不管这些分布式系统是基于akka-remote还是 akka-cluster</li>
</ul>
<p>我们还没有处理在RemoteLookup和RemoteBoxOfficeForwarder的message丢失问题。下面的章节会介绍：</p>
<ul>
<li>怎样在合作node之间创建爱你可信赖的proxy</li>
<li>当后端node挂掉的时候处理TicketSellers丢失的问题</li>
<li>状态怎样在集群间复制</li>
</ul>
<p>但是。。在此之前，我们先看一下基于akka-cluster module的动态的node membership。</p>
]]></content>
      
        
        <tags>
            
            <tag> akka </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[akka in action 读书笔记（5）]]></title>
      <url>/2016/08/11/akka-in-action-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%EF%BC%885%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>这一章聊一下akka的Future。Actor提供了一个机制替代了并发object系统，Future提供了一个机制来替代并发function系统。</p>
<h2 id="5-1-Futrue用例"><a href="#5-1-Futrue用例" class="headerlink" title="5.1 Futrue用例"></a>5.1 Futrue用例</h2><p>Actor被用来处理message，获取state，基于收到的不同message执行不同代码。借助于监管和监控，他们成为生命力极强的对象，即便出现错误也可以继续生存。</p>
<p>Future是用来不用object，而使用function就能解决问题的工具。它是一个function结果的占位符，在未来的某一个时刻生效，是一个异步结果。</p>
<p><img src="/imgs/akka/akka_5_placeholder_for_async.png" alt="异步函数结果的占位符"></p>
<p>Future是只读的，而且可以被读多次，不能被外界修改。</p>
<p>注意：Future并不是对java.util.concurrent.Futrue的封装。后者的get方法还是会引起block的。</p>
<p>Future对于pipeline的处理方式很友好，就是经过function1的结果传递给function2使用。</p>
<p>以买票的例子来说，假设我们创建了一个web页面，提供一些额外的信息，比如天气预报、交通状况、出行计划、停车等。下面是event的处理流程：<br><img src="/imgs/akka/akka_5_chain_async_func.png" alt="异步函数链"></p>
<p>图中getEvent和getTraffic都是异步请求web服务的function，顺序执行。getTrafficInfo接收一个Event参数，当Future[Event]获得结果后就会触发getTrafficInfo的执行。这与在并发线程中执行getEvent方法等待返回结果是不同的。我们定义了一个一定会被执行的getTrafficInfo函数，而且不用任何等待。</p>
<p>下图展示了一个简单的例子：<br><img src="/imgs/akka/akka_5_aggr_result_sync_vs_async.png" alt="同步与异步的对比"></p>
<p>可见异步的话只需要花费4和2中的最长时间，而同步就需要2+4。</p>
<p>下图展示了另一个用例，利用异步最快获取天气信息：</p>
<p><img src="/imgs/akka/akka_5_weather_info_async.png" alt="异步最快获取天气信息"></p>
<p>假设X服务出现超时问题的话，就直接不用管它的结果了。</p>
<p>这些场景使用actor并不是不可以，只是直接使用actor的话会特别麻烦。假设使用actor实现上面那个获取天气和交通信息的功能，需要包含以下步骤：</p>
<p><img src="/imgs/akka/akka_5_combine_web_request_actors.png" alt="使用actor组合web请求"></p>
<p>我们需要为天气和交通服务分别创建两个actor，这样他们才能被同时调用。调用方式被定义在TicketInfo Actor中。这里也并不能实现非阻塞。</p>
<p>如果应用包含以下特性，就可以考虑使用future：</p>
<ul>
<li>不要block</li>
<li>调用一次某个function之后，在未来的某个时间点使用调用结果</li>
<li>组合许多一次调用的function结果</li>
<li>调用一些相互竞争的function，只使用其中的一部分结果，比如：最快的天气信息</li>
<li>当function出现错误的时候，需要返回默认值，以便后面的function能够继续调用</li>
<li>pipeline对结果相互依赖的function</li>
</ul>
<h2 id="5-2-Futrue中无阻塞"><a href="#5-2-Futrue中无阻塞" class="headerlink" title="5.2 Futrue中无阻塞"></a>5.2 Futrue中无阻塞</h2><p>是时候写一下TicketInfoService完成上面获取天气和交通信息了。</p>
<p>异步与同步的方法在与程序中的处理流，下面是一个同步的程序：<br><img src="/imgs/akka/akka_5_sync_call_code.png" alt="同步调用代码"></p>
<p>这里既没有使用futrue，也没有使用scala的懒加载，所以每行都需要等返回值才能继续。</p>
<p>再看一下异步的程序：<br><img src="/imgs/akka/akka_5_async_chain_call_code.png" alt="异步调用代码"></p>
<p>callEventService实际上是在另一个线程里调用的，这个线程其实是阻塞的，后面我们会解决这个问题。futrue是将一段代码进行一部执行调用的Futrue.apply的简写。</p>
<p>以上代码其实是一个闭包，把request从main线程传递给一个新的线程去执行某个方法。</p>
<p>下面把交通信息串进来：<br><img src="/imgs/akka/akka_5_async_chain_call_code.png" alt="处理异步结果，继续异步调用"></p>
<p>这段代码块只有在futrueEvent可用的时候才会执行。如果我们也需要这段程序有返回值咋办</p>
<p><img src="/imgs/akka/akka_5_async_chain_call_return_code.png" alt="返回Future[Route]"></p>
<p>也可以直接串起来。</p>
<p><img src="/imgs/akka/akka_5_async_chain_all_code.png" alt="直接串起来"></p>
<p>重构一下getEvent和getRoute方法：<br><img src="/imgs/akka/akka_5_refactor.png" alt="重构之后"></p>
<p>其实要真正的异步的话，callEventService和callTrafficService应该也是异步返回Futrue才对，这个可以借助spray-client，在后面的rest相关章节我们会介绍。</p>
<p>需要注意一个细节，就是钥匙用futrue的话需要引入对ExecutionContext的隐式转换，不然编译不过去。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> scala.concurrent.<span class="type">Implicits</span>.global</div></pre></td></tr></table></figure></p>
<p>ExecutionContext是在某个线程池执行任务的抽象，可以类比java.util.concurrent.Executor。</p>
<p>这里介绍了成功调用的案例，下面说一下怎样从失败中恢复。</p>
<h2 id="5-3-失败"><a href="#5-3-失败" class="headerlink" title="5.3 失败"></a>5.3 失败</h2><p>假如在异步处理的过程中出现了Exception咋办？启动一个scala REPL，执行以下代码<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">scala&gt; :paste</div><div class="line">// Entering paste mode (ctrl-D to finish)</div><div class="line"></div><div class="line">import scala.concurrent._</div><div class="line">import ExecutionContext.Implicits.global</div><div class="line"></div><div class="line">val futureFail = future &#123; throw new Exception(&quot;error!&quot;)&#125;</div><div class="line">futureFail.foreach(value=&gt; println(value))</div><div class="line"></div><div class="line">// Exiting paste mode, now interpreting.</div><div class="line"></div><div class="line">futureFail: scala.concurrent.Future[Nothing] =</div><div class="line">scala.concurrent.impl.Promise$DefaultPromise@193cd8e1</div><div class="line"></div><div class="line">scala&gt;</div></pre></td></tr></table></figure></p>
<p>可以看到并没有打印我们期望的结果，命令行也没有打印方法栈。由于前面没有执行成功，所以foreach代码没有执行。</p>
<p>我们可以使用OnComplete接口<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">scala&gt; :paste</div><div class="line"><span class="comment">// Entering paste mode (ctrl-D to finish)</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> scala.util._</div><div class="line"><span class="keyword">import</span> scala.util.control.<span class="type">NonFatal</span></div><div class="line"><span class="keyword">import</span> scala.concurrent._</div><div class="line"><span class="keyword">import</span> <span class="type">ExecutionContext</span>.<span class="type">Implicits</span>.global</div><div class="line"></div><div class="line"><span class="keyword">val</span> futureFail = future &#123; <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">Exception</span>(<span class="string">"error!"</span>)&#125;</div><div class="line">futureFail.onComplete &#123;</div><div class="line"><span class="keyword">case</span> <span class="type">Success</span>(value) =&gt; println(value)</div><div class="line"><span class="keyword">case</span> <span class="type">Failure</span>(<span class="type">NonFatal</span>(e)) =&gt; println(e)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// Exiting paste mode, now interpreting.</span></div><div class="line"></div><div class="line">java.lang.<span class="type">Exception</span>: error!</div></pre></td></tr></table></figure></p>
<p>OnComplete回调函数总是会被调用，而且返回值是Unit。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">futureFail.onFailure &#123;</div><div class="line"><span class="keyword">case</span> <span class="type">NonFatal</span>(e) =&gt; println(e)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>TicketInfo服务同样也应该保持一些信息，以便出现异常后记录抛出的异常信息。下图是TicketInfo里保存的事件信息：<br><img src="/imgs/akka/akka_5_accumulate_info_tickit_info.png" alt="TicketInfo保存的事件信息"></p>
<p>getEvent和getTraffic改用TicketInfo作为返回值与接收值，这样TicketInfo可以一路积攒信息，TicketInfo是一个case class。</p>
<p>注意：在使用futrue的过程中一定要全程使用不可变数据。</p>
<p>下图说明了GetTraffic调用失败的时候会发生什么：<br><img src="/imgs/akka/akka_5_ignore_failed_resp.png" alt="忽略失败的服务的response"></p>
<p>我们可以定义recover方法，当出现异常的时候就返回这个方法的返回值。下面代码说明了怎样使用：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> futureStep1 = getEvent(ticketNr)<span class="comment">//返回Future[TicketInfo]</span></div><div class="line"><span class="keyword">val</span> futureStep2 = futureStep1.flatMap &#123; ticketInfo =&gt; <span class="comment">// 使用flatMap我们可以直接返回Future[TicketInfo]而不是一个TicketInfo</span></div><div class="line">  getTraffic(ticketInfo).recover &#123; <span class="comment">//返回Future[TicketInfo]</span></div><div class="line">    <span class="keyword">case</span> e:<span class="type">TrafficServiceException</span> =&gt; ticketInfo <span class="comment">//使用一个包含初始TicketInfo的Future来恢复</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>getTraffic啥的都是创建TicketInfo的copy。</p>
<p>还有一个recoverWith用来返回 Future[TicketInfo]而不是TicketInfo。注意上面的recover方法是同步调用的。</p>
<p>上面代码中还有一个问题，如果getEvent就失败了咋办？flatMap根本就不会执行。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> futureStep1 = getEvent(ticketNr)</div><div class="line"><span class="keyword">val</span> futureStep2 = futureStep1.flatMap &#123; ticketInfo =&gt;</div><div class="line">    getTraffic(ticketInfo).recover &#123;</div><div class="line">      <span class="keyword">case</span> e:<span class="type">TrafficServiceException</span> =&gt; ticketInfo</div><div class="line">    &#125;</div><div class="line">&#125;.recover &#123;</div><div class="line">  <span class="keyword">case</span> <span class="type">NonFatal</span>(e) =&gt; <span class="type">TicketInfo</span>(ticketNr)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>如果getEvent失败的话，就直接返回包含ticketNr的空TicketInfo。</p>
<h2 id="5-4-整合Futrue"><a href="#5-4-整合Futrue" class="headerlink" title="5.4 整合Futrue"></a>5.4 整合Futrue</h2><p>下面是买票服务中的所有的case class。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.goticks</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.joda.time.&#123;<span class="type">Duration</span>, <span class="type">DateTime</span>&#125;</div><div class="line"></div><div class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">TicketInfo</span>(<span class="params">ticketNr:<span class="type">String</span>,</span></span></div><div class="line">                      userLocation:<span class="type">Location</span>,</div><div class="line">                      event:<span class="type">Option</span>[<span class="type">Event</span>]=<span class="type">None</span>,</div><div class="line">                      travelAdvice:<span class="type">Option</span>[<span class="type">TravelAdvice</span>]=<span class="type">None</span>,</div><div class="line">                      weather:<span class="type">Option</span>[<span class="type">Weather</span>]=<span class="type">None</span>,</div><div class="line">                      suggestions:<span class="type">Seq</span>[<span class="type">Event</span>]=<span class="type">Seq</span>())</div><div class="line"></div><div class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Event</span>(<span class="params">name:<span class="type">String</span>,location:<span class="type">Location</span>, time:<span class="type">DateTime</span></span>)</span></div><div class="line"></div><div class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Artist</span>(<span class="params">name:<span class="type">String</span>, calendarUri:<span class="type">String</span></span>)</span></div><div class="line"></div><div class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Location</span>(<span class="params">lat:<span class="type">Double</span>, lon:<span class="type">Double</span></span>)</span></div><div class="line"></div><div class="line"><span class="comment">// 简单起见，所有的route都弄成了一个简单的字符串</span></div><div class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">RouteByCar</span>(<span class="params">route:<span class="type">String</span>, timeToLeave:<span class="type">DateTime</span>, origin:<span class="type">Location</span>, destination:<span class="type">Location</span>,</span></span></div><div class="line">                 estimatedDuration:<span class="type">Duration</span>, trafficJamTime:<span class="type">Duration</span>)</div><div class="line"></div><div class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">PublicTransportAdvice</span>(<span class="params">advice:<span class="type">String</span>, timeToLeave:<span class="type">DateTime</span>, origin:<span class="type">Location</span>, destination:<span class="type">Location</span>,</span></span></div><div class="line">                                 estimatedDuration:<span class="type">Duration</span>)</div><div class="line"></div><div class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">TravelAdvice</span>(<span class="params">routeByCar:<span class="type">Option</span>[<span class="type">RouteByCar</span>]=<span class="type">None</span>,</span></span></div><div class="line">                        publicTransportAdvice: <span class="type">Option</span>[<span class="type">PublicTransportAdvice</span>]=<span class="type">None</span>)</div><div class="line"></div><div class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Weather</span>(<span class="params">temperature:<span class="type">Int</span>, precipitation:<span class="type">Boolean</span></span>)</span></div></pre></td></tr></table></figure></p>
<p>下图是TicketInfoService的处理流：<br><img src="/imgs/akka/akka_5_ticket_flow.png" alt="TicketInfoService的处理流"></p>
<p>combinators在图中以菱形表示。所有的future最终都被整合进了Future[TicketInfo]。</p>
<p>我们以最快选取天气信息先开始讲解，下面是这块逻辑使用combinator的地方：<br><img src="/imgs/akka/akka_5_weather_flow.png" alt="天气信息流"></p>
<p>两个天气服务都返回Future[Weather]，然后我们需要的是Future[TicketInfo]。下面是代码：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getWeather</span></span>(ticketInfo:<span class="type">TicketInfo</span>):<span class="type">Future</span>[<span class="type">TicketInfo</span>] = &#123;</div><div class="line"></div><div class="line">  <span class="keyword">val</span> futureWeatherX = callWeatherXService(ticketInfo).recover(withNone) <span class="comment">// 恢复代码封装在withNone里了</span></div><div class="line"></div><div class="line">  <span class="keyword">val</span> futureWeatherY = callWeatherYService(ticketInfo).recover(withNone)</div><div class="line"></div><div class="line">  <span class="type">Future</span>.firstCompletedOf(<span class="type">Seq</span>(futureWeatherX, futureWeatherY)).map&#123; weatherResponse =&gt;</div><div class="line">    ticketInfo.copy(weather = weatherResponse)<span class="comment">// 复制到ticketInfo里</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>firstCompletedOf只返回第一个返回结果的服务的response，成功失败无所谓，也就是说加入先返回的是失败，那么后面即便有成功返回也不会生效了。【可以考虑firstSucceededOf】</p>
<p>下面是公共交通信息和行车路由服务，它们应该并行，然后等两者都结束调用就将结果combine进TravelAdvice。下图展示了这个combinator：<br><img src="/imgs/akka/akka_5_travel_flow.png" alt="旅行路径建议流"></p>
<p>getTraffic和getPublicTransport的Futrue各自返回一种类型数据：RouteByCar以及PublicTransportAdvice。这两个值先被放进一个tuple，然后把这个tuple map放进TravelAdvice里面。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">TravelAdvice</span>(<span class="params">routeByCar:<span class="type">Option</span>[<span class="type">RouteByCar</span>]=<span class="type">None</span>,</span></span></div><div class="line">                        publicTransportAdvice: <span class="type">Option</span>[<span class="type">PublicTransportAdvice</span>]=<span class="type">None</span>)</div></pre></td></tr></table></figure></p>
<p>基于这个信息，用户就可以决定是使用公共交通工具出行，还是自驾游。下面是zip combinator的代码：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">def</span> <span class="title">getTravelAdvice</span></span>(info:<span class="type">TicketInfo</span>, event:<span class="type">Event</span>):<span class="type">Future</span>[<span class="type">TicketInfo</span>] = &#123;</div><div class="line"></div><div class="line">   <span class="keyword">val</span> futureRoute = callTrafficService(info.userLocation, event.location, event.time).recover(withNone)</div><div class="line"></div><div class="line">   <span class="keyword">val</span> futurePublicTransport = callPublicTransportService(info.userLocation, event.location, event.time).recover(withNone)</div><div class="line"></div><div class="line"><span class="comment">// 先把 Future[RouteByCar] 和 Future[PublicTransportAdvice] zip成tuple放入Future[(RouteByCar, PublicTransportAdvice)]</span></div><div class="line"><span class="comment">// 然后再将这两者map放入Future[TicketInfo]</span></div><div class="line">   futureRoute.zip(futurePublicTransport).map &#123; <span class="keyword">case</span>(routeByCar, publicTransportAdvice) =&gt;</div><div class="line">     <span class="keyword">val</span> travelAdvice = <span class="type">TravelAdvice</span>(routeByCar, publicTransportAdvice)</div><div class="line">     info.copy(travelAdvice = <span class="type">Some</span>(travelAdvice))</div><div class="line">   &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>也可以使用for替换map，有时可读性更强一些.<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span>((routeByCar, publicTransportAdvice) &lt;- futureRoute.zip(futurePublicTransport);</div><div class="line">     travelAdvice = <span class="type">TravelAdvice</span>(routeByCar, publicTransportAdvice)</div><div class="line">) <span class="keyword">yield</span> info.copy(travelAdvice = <span class="type">Some</span>(travelAdvice))</div></pre></td></tr></table></figure></p>
<p>下一个部分我们看一下推荐类似活动给用户。我们使用了两个web服务，一个是类似的艺术服务，返回用户感兴趣的类似艺术的信息。使用这个信息来调用一个日历服务，以便计划下一站的去向。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 返回对每种艺术活动的计划列表 Future[Seq[Events]]</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getSuggestions</span></span>(event:<span class="type">Event</span>):<span class="type">Future</span>[<span class="type">Seq</span>[<span class="type">Event</span>]] = &#123;</div><div class="line"></div><div class="line">  <span class="keyword">val</span> futureArtists = callSimilarArtistsService(event).recover(withEmptySeq) <span class="comment">// 返回类似艺术活动的列表：Future[Seq[Events]]</span></div><div class="line"></div><div class="line">  <span class="keyword">for</span>(artists &lt;- futureArtists.recover(withEmptySeq); <span class="comment">// 'artists' evaluates at some point to a Seq[Artist]</span></div><div class="line">      events &lt;- getPlannedEvents(event, artists).recover(withEmptySeq) <span class="comment">// 'events' evaluates at some point to a Seq[Events], a planned event for every called artist.</span></div><div class="line">  ) <span class="keyword">yield</span> events</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>getPlannedEvents使用Future.sequence方法把Seq[Future[Event]]构建成一个Future[Seq[Event]]作为返回值。也就是说把一串futrue放进一个futrue，这个futrue包含一串对象。下面是代码：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getPlannedEvents</span></span>(event:<span class="type">Event</span>, artists:<span class="type">Seq</span>[<span class="type">Artist</span>]) = &#123;</div><div class="line">   <span class="keyword">val</span> events = artists.map(artist=&gt; callArtistCalendarService(artist, event.location)) <span class="comment">// events是一个 Seq[Future[Event]]</span></div><div class="line">   <span class="type">Future</span>.sequence(events) <span class="comment">// 把 Seq[Future[Event]]转为Future[Seq[Event]]。当异步调用callArtistCalendarService都完成后，就可以对futrue取值了</span></div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>与sequence方法相似的还有一个traverse方法。下面是例子：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">getPlannedEventsWithTraverse</span></span>(event:<span class="type">Event</span>, artists:<span class="type">Seq</span>[<span class="type">Artist</span>]) = &#123;</div><div class="line">  <span class="type">Future</span>.traverse(artists) &#123; artist=&gt;  <span class="comment">// traverse方法接受一个方法块返回一个futrue对象。</span></div><div class="line">    callArtistCalendarService(artist, event.location)</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>使用sequence的话，我们必须事先创建一个Seq[Future[Event]]，才能转化出Future[Seq[Event]]。traverse就不用什么中间步骤了。</p>
<p>终于到了TicketInfoService数据流的最后一步了。包含Weather的TicketInfo要和包含TravelAdvice的TicketInfo对象整合起来。我们使用fold方法来自完成：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">val</span> ticketInfos = <span class="type">Seq</span>(infoWithTravelAdvice, infoWithWeather)</div><div class="line"></div><div class="line"><span class="keyword">val</span> infoWithTravelAndWeather = <span class="type">Future</span>.fold(ticketInfos)(info) &#123; (acc, elem) =&gt;</div><div class="line">  <span class="keyword">val</span> (travelAdvice, weather) = (elem.travelAdvice, elem.weather)</div><div class="line"></div><div class="line">  acc.copy(travelAdvice = travelAdvice.orElse(acc.travelAdvice),</div><div class="line">            weather = weather.orElse(acc.weather))</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>fold方法需要一个初始值、一个方法块。集合中的每个元素都要经过这个方法块对初始值产生影响。</p>
<p>整体代码如下：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"> <span class="function"><span class="keyword">def</span> <span class="title">getTicketInfo</span></span>(ticketNr:<span class="type">String</span>, location:<span class="type">Location</span>):<span class="type">Future</span>[<span class="type">TicketInfo</span>] = &#123;</div><div class="line">   <span class="keyword">val</span> emptyTicketInfo = <span class="type">TicketInfo</span>(ticketNr, location)</div><div class="line">   <span class="keyword">val</span> eventInfo = getEvent(ticketNr, location).recover(withPrevious(emptyTicketInfo))</div><div class="line"></div><div class="line">   eventInfo.flatMap &#123; info =&gt;</div><div class="line"></div><div class="line">     <span class="keyword">val</span> infoWithWeather = getWeather(info)</div><div class="line"></div><div class="line">     <span class="keyword">val</span> infoWithTravelAdvice = info.event.map &#123; event =&gt;</div><div class="line">       getTravelAdvice(info, event)</div><div class="line">     &#125;.getOrElse(eventInfo)</div><div class="line"></div><div class="line"></div><div class="line">     <span class="keyword">val</span> suggestedEvents = info.event.map &#123; event =&gt;</div><div class="line">       getSuggestions(event)</div><div class="line">     &#125;.getOrElse(<span class="type">Future</span>.successful(<span class="type">Seq</span>()))</div><div class="line"></div><div class="line">     <span class="keyword">val</span> ticketInfos = <span class="type">Seq</span>(infoWithTravelAdvice, infoWithWeather)</div><div class="line"></div><div class="line">     <span class="keyword">val</span> infoWithTravelAndWeather = <span class="type">Future</span>.fold(ticketInfos)(info) &#123; (acc, elem) =&gt;</div><div class="line">       <span class="keyword">val</span> (travelAdvice, weather) = (elem.travelAdvice, elem.weather)</div><div class="line"></div><div class="line">       acc.copy(travelAdvice = travelAdvice.orElse(acc.travelAdvice),</div><div class="line">                 weather = weather.orElse(acc.weather))</div><div class="line">     &#125;</div><div class="line"></div><div class="line"></div><div class="line">     <span class="keyword">for</span>(info &lt;- infoWithTravelAndWeather;</div><div class="line">       suggestions &lt;- suggestedEvents</div><div class="line">     ) <span class="keyword">yield</span> info.copy(suggestions = suggestions)</div><div class="line">   &#125;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"><span class="comment">// 在TicketInfoService处理流中的错误恢复方法</span></div><div class="line"> <span class="class"><span class="keyword">type</span> <span class="title">Recovery</span>[<span class="type">T</span>] </span>= <span class="type">PartialFunction</span>[<span class="type">Throwable</span>,<span class="type">T</span>]</div><div class="line"></div><div class="line"> <span class="comment">// recover with None</span></div><div class="line"> <span class="function"><span class="keyword">def</span> <span class="title">withNone</span></span>[<span class="type">T</span>]:<span class="type">Recovery</span>[<span class="type">Option</span>[<span class="type">T</span>]] = &#123; <span class="keyword">case</span> <span class="type">NonFatal</span>(e) =&gt; <span class="type">None</span> &#125;</div><div class="line"></div><div class="line"> <span class="comment">// recover with empty sequence</span></div><div class="line"> <span class="function"><span class="keyword">def</span> <span class="title">withEmptySeq</span></span>[<span class="type">T</span>]:<span class="type">Recovery</span>[<span class="type">Seq</span>[<span class="type">T</span>]] = &#123; <span class="keyword">case</span> <span class="type">NonFatal</span>(e) =&gt; <span class="type">Seq</span>() &#125;</div><div class="line"></div><div class="line"> <span class="comment">// recover with the ticketInfo that was built in the previous step</span></div><div class="line"> <span class="function"><span class="keyword">def</span> <span class="title">withPrevious</span></span>(previous:<span class="type">TicketInfo</span>):<span class="type">Recovery</span>[<span class="type">TicketInfo</span>] = &#123;</div><div class="line">   <span class="keyword">case</span> <span class="type">NonFatal</span>(e) =&gt; previous</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>这段代码概括了TicketInfoService使用Futrue的逻辑。没有使用任何阻塞调用。combinator方法使这些异步掉用的结果很方便的整合起来。</p>
<h2 id="5-5-Futrue和Actor"><a href="#5-5-Futrue和Actor" class="headerlink" title="5.5 Futrue和Actor "></a>5.5 Futrue和Actor </h2><p>在前面的Up and Running 章节，我们使用Spray作为REST服务，它是使用Actor来处理HTTP 请求的，ask方法的返回值也是一个Futrue对象。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 引入ask模型，它在ActorRef上添加了ask方法</span></div><div class="line"><span class="keyword">import</span> akka.pattern.ask</div><div class="line"><span class="comment">// context包含了actor的dispatcher定义。</span></div><div class="line"><span class="keyword">import</span> context._</div><div class="line"><span class="comment">// 为ask方法必须定义一个超时</span></div><div class="line"><span class="keyword">implicit</span> <span class="keyword">val</span> timeout = <span class="type">Timeout</span>(<span class="number">5</span> seconds)</div><div class="line"><span class="comment">// 抓获上下文中的sender</span></div><div class="line"><span class="keyword">val</span> capturedSender = sender</div><div class="line"></div><div class="line"><span class="comment">// 向TicketSeller请求GetEvents的本地方法</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">askEvent</span></span>(ticketSeller:<span class="type">ActorRef</span>): <span class="type">Future</span>[<span class="type">Event</span>] = &#123;</div><div class="line">   <span class="comment">// ask方法返回一个Futrue.我们使用mapTo方法将返回的Futrue[Any]转为Future[Int]。</span></div><div class="line">   <span class="keyword">val</span> futureInt = ticketSeller.ask(<span class="type">GetEvents</span>).mapTo[<span class="type">Int</span>] </div><div class="line">   </div><div class="line">   <span class="comment">// 查一下所有的子元素，对于指定event都还剩下多少票</span></div><div class="line">   futureInt.map &#123; nrOfTickets =&gt;</div><div class="line">      <span class="type">Event</span>(ticketSeller.actorRef.path.name, nrOfTickets)</div><div class="line">   &#125;</div><div class="line">&#125;</div><div class="line"><span class="keyword">val</span> futures = context.children.map &#123;</div><div class="line">  ticketSeller =&gt; askEvent(ticketSeller)</div><div class="line">&#125;</div><div class="line"><span class="type">Future</span>.sequence(futures).map &#123;</div><div class="line">  <span class="comment">// 给sender回送消息。这个sender就是发送原始GetEvents请求的sender。</span></div><div class="line">  events =&gt; capturedSender ! <span class="type">Events</span>(events.toList)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这个例子比在第二章中的代码要清楚多了。每个消息的sender都不一样，这里结合闭包使用变量从context中获取当前message的sender，回送消息。</p>
<p>注意以下当在actor中使用futrue的时候，ActorContext会提供一个Actor的当前view。又由于actor是有状态的，所以闭包中的变量对于外部线程应该是不可变的。最容易达成这种效果的方式是使用不可变对象，然后在将这个值close over进futrue之前就获取这个不可变数据结构的引用，也就是上面例子中的capturedSender。</p>
<p>另一种模式是pipeTo：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//引入pipe模型</span></div><div class="line"><span class="keyword">import</span> akka.pattern.pipe</div><div class="line">path(<span class="string">"events"</span>) &#123;</div><div class="line">  get &#123; requestContext =&gt;</div><div class="line">    <span class="comment">// 创建一个actor，为所有的request使用一个response完成HTTP请求</span></div><div class="line">    <span class="keyword">val</span> responder = createResponder(requestContext)</div><div class="line">    <span class="comment">// ask方法的Futrue返回值被pipe到responder actor</span></div><div class="line">    boxOffice.ask(<span class="type">GetEvents</span>).pipeTo(responder)</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Responder</span>(<span class="params">requestContext:<span class="type">RequestContext</span>,</span></span></div><div class="line">	ticketMaster:<span class="type">ActorRef</span>)</div><div class="line"> <span class="keyword">extends</span> <span class="type">Actor</span> <span class="keyword">with</span> <span class="type">ActorLogging</span> &#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</div><div class="line"></div><div class="line">    <span class="keyword">case</span> <span class="type">Events</span>(events) =&gt;</div><div class="line">        requestContext.complete(<span class="type">StatusCodes</span>.<span class="type">OK</span>, events)</div><div class="line">        self ! <span class="type">PoisonPill</span></div><div class="line"></div><div class="line">    <span class="comment">// other messages omitted..</span></div><div class="line"> &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当我们想用一个actor来处理futrue对象，或者某些actor的ask结果还需要进一步处理的时候，就可以使用pipeTo方法了。</p>
<h2 id="5-6-总结"><a href="#5-6-总结" class="headerlink" title="5.6 总结"></a>5.6 总结</h2><p>这一章介绍了一个futrue。使用futrue可以创建一个异步处理流，省去不必要的阻塞和线程等待，最大化资源使用率，最小化无作为延迟。</p>
<p>Futrue是一个function返回值的placeholder。</p>
<p>combinator方法可以方便地把futrue的值整合在一起。function可以并行执行，然后通过combinator变成一个有意义的结果。</p>
<p>futrue包含的对象应该是不可变的。</p>
<p>Futrue可以与Actor结合使用，但是要注意使用时close over的状态变量。sender的引用应该在进入闭包钱就获取。Futrue是ask方法的返回值类型，也是pipeTo方法的返回值类型。</p>
]]></content>
      
        
        <tags>
            
            <tag> akka </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[akka in action 读书笔记（4）]]></title>
      <url>/2016/08/09/akka-in-action-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%EF%BC%884%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>内容提要：</p>
<ul>
<li>自救系统</li>
<li>Let it crash</li>
<li>Actor生命周期</li>
<li>Supervision</li>
<li>错误恢复策略</li>
</ul>
<h2 id="4-1-容错的来源"><a href="#4-1-容错的来源" class="headerlink" title="4.1 容错的来源"></a>4.1 容错的来源</h2><p>我们最理想的世界其实是希望系统一直可用，而且能够保证每个action都能被成功执行。只有两种方法能让这个梦想照进现实：一是使用永远不会失败的组件，二是为每次失败都提供一个完美的补救措施，这个补救措施需要能保证最终能成功完成此次action。在多数架构里，是catch住预期的异常进行处理，但是无论怎样努力都不能阻止预期之外的异常导致失败。</p>
<p>能够容忍错误的系统理论上不错，但是要同时兼顾到高可用、分布式的系统基本是不可能的。主要原因是任何此类系统的大部分我们都不能控制，这部分可能会导致失败。网络是最好的例子，它随时都有可能消失，你的系统再强大也么有用。我们显然不能让一个server从它的灰烬中恢复元气，而且自动修复前面遇到的问题。这就是let it crash 出现的原因，不去想办法回复它，而是提供足够多的可用server。</p>
<p>既然我们不能保证不发生任何失败，那么我们不得不准备一些策略：</p>
<ul>
<li>程序总会有失败。系统必须能够容错，才能继续运行其他服务。可恢复的错误不应该触发或导致灾难性的失败。</li>
<li>在某些条件允许的情况下，虽然系统的某一部分发生了问题，但是并不影响其他大部分的服务，那么我们应该切断这部分坏程序以免它产生一些不正确的结果，影响系统的其他部分正常运行。</li>
<li>一些重要的组件我们需要有备份（可以考虑放在不同的server或者使用不同的resources），当正在运行的失败的时候，能够进行热切换，使系统可用性快速恢复。</li>
<li>系统的一部分出问题不应该影响整个系统垮掉，所以我们需要一个措施来隔离某些特殊的失败，且需要在这些失败发生之后有处理措施。</li>
</ul>
<p>当然，akka并没有容错的银弹。我们还是要处理失败，但是我们可以使用一种cleaner,more application-specifc的方式来处理。下面是Akka关于容错的一些特性：</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>Fault containment or isolation</td>
<td>一个fault应该是系统的一部分，不应导致整体crash</td>
</tr>
<tr>
<td>Structure</td>
<td>隔离某个失败的组件意味着需要某个结构来实施隔离，系统需要一个定义好的Structure，把可以被隔离的部分放进去</td>
</tr>
<tr>
<td>冗余</td>
<td>当一个组件失败之后，应该有备份的替代它</td>
</tr>
<tr>
<td>替代</td>
<td>如果一个失败的组件可以被隔离，我们也可以在Structure中替换掉它。</td>
</tr>
<tr>
<td>重启</td>
<td>如果一个组件出现了不正确的状态，我们应该能够把它重新初始化。不正确的那个state或许就是导致错误的原因</td>
</tr>
<tr>
<td>组件生命周期</td>
<td>一个失败的组件必须被隔离，如果它不能恢复的话，就必须被终结和移除，或者重新处理化它的state。有些必要的周期：start, restart, terminate</td>
</tr>
<tr>
<td>暂停</td>
<td>当一个组件失败了，我们应该在它被修复之前把所有对它的调用都弄成suspended。这些调用应该保留下来，用来分析当前组件失败的原因</td>
</tr>
<tr>
<td>Separation of Concerns 分散关注</td>
<td>如果容错代码能够与普通执行代码分割开就最好了。在普通的流程当中，容错算是横向切入的了。把普通流程与容错恢复流程分离开会简化我们的工作</td>
</tr>
</tbody>
</table>
<p>有人或许会问，用普通的异常捕捉机制就不能搞这套东西么？普通的异常是用来回退一系列操作来保证数据一致性的。但是既然提到了，我们还是用下面的部分来讨论一下。</p>
<h5 id="4-1-1-普通异常方式"><a href="#4-1-1-普通异常方式" class="headerlink" title="4.1.1 普通异常方式"></a>4.1.1 普通异常方式</h5><p>假设有这样一个应用： 多线程，收集log，从文件中分析有兴趣的信息，然后转存为行对象，然后把这些行写入某个数据库。有一些file watcher进程持续盯着增长的文件，然后通知多个线程来处理新的文件。下图是一个概览：</p>
<p><img src="/imgs/akka/akka_4_process_logs_app.png" alt="应用概览"></p>
<p>如果数据库连接断了的话，我们期望切换到另一个数据库继续写数据，而不是回滚。如果连接开始出现问题，我们或许希望马上停掉它，以免app的其他部分使用它。有时我们只要重启这个连接，摆脱这个连接内某些错误的状态就可以了。可以用伪代码看一下潜在的问题区域。先看一下使用标准的异常处理方法直接在同一个数据库上重启一个新的连接。</p>
<p>首先，多线程里都已经准备好了要入库的数据。下图是创建writer：</p>
<p><img src="/imgs/akka/akka_4_create_writer.png" alt="创建DB writer"></p>
<p>writer的依赖是通过构造方法传入的，数据库工厂的配置，都通过创建爱你writer的thread传入。下一步，我们准备log processor。每个processor都有一个writer的引用，用来存储行数据。如下图：</p>
<p><img src="/imgs/akka/akka_4_create_log_processor.png" alt="创建log processor"></p>
<p>方法的调用栈如下图：</p>
<p><img src="/imgs/akka/akka_4_call_stack.png" alt="处理log文件的方法调用栈"></p>
<p>上图流程是被多线程同时调用的。下图战士了当一个DbBrokenConnectionException被跑出的时候的调用栈，这个异常暗示我们需要切换到另一个连接。</p>
<p><img src="/imgs/akka/akka_4_call_stack_log.png" alt="处理log文件的调用栈"></p>
<p>除了直接向上跑出异常之外，我们期望从DbBrokenConnectionException恢复，替换掉不能使用的连接。我们面临的第一个问题是很难在不打破既有设计的前提下添加代码去恢复连接。另外，我们没有足够的信息来重建连接：我们不知道我们已经成功处理到文件的哪一行了，在处理哪一行时出现的异常。</p>
<p>如果让我们执行的行数和连接信息对所有对象都可见的话，就打破了我们的简单性原则，而且违背了一些基本的实践：封装、控制反转、单一职则。我们只是需要把失败的组件替换掉而已。直接在异常处理中添加恢复的代码会混淆执行log文件的功能性。即便我们找到替换连接的方式，我们还不得不着重注意替换连接的时候，其他的线程没有在使用它，不然可能导致某些行数据丢失。</p>
<p>还有，让多线程之间针对某个异常进行沟通本来也不是什么标准特性，你必须要自己实现它。回顾容错的必备特性，想一下这种处理方式有么有可能站住脚：</p>
<ul>
<li>错误隔离。许多线程都可以同时抛出异常，所以隔离相当困难。我们必须得加些锁才行。</li>
<li>Structure。必须自己创建</li>
<li>冗余。 异常不断被抛往上一层。或许会丢失掉一些重要的信息。</li>
<li>替换。 没有默认的策略支持在调用栈中替换一个对象，你必须得自己想个办法。有些依赖注入的框架支持这个特性，但是只是在特别简单的直接引用到旧的实例的时候。还有就是如果你要替换某个对象的时候，最好考虑好多线程问题。</li>
<li>重启。</li>
<li>组件生命周期。</li>
<li>暂停</li>
<li>关注分离。异常处理代码和业务代码混淆在一起，么有独立性。</li>
</ul>
<p>简述以下主要的问题：</p>
<ul>
<li>在first-class中，重新创建对象以及他们的依赖，在app中替换掉他们是不可能的 </li>
<li>直接相互沟通的对象很难隔离</li>
<li>容错代码和功能代码混淆在一起</li>
</ul>
<p>回头看看Akka。 Actor可以有Props对象重建，是actor system的一部分，actor之间通过actorRef进行沟通。下面我们看一下actor怎样把功能代码和容错代码分离，actor的生命周期怎样保证actor的暂停和重启。</p>
<h5 id="4-1-2-Let-it-crash"><a href="#4-1-2-Let-it-crash" class="headerlink" title="4.1.2 Let it crash"></a>4.1.2 Let it crash</h5><p>前面介绍了使用普通对象和异常处理机制来构建一个容错系统有多难，下面我们展示以下Actor的风采。</p>
<p>akka的容错恢复代码与功能代码是分开的。功能流包含处理普通message的actor，恢复流包含监控功能流中actor的actor。这种监控其他actor的actor叫做supervisor，如下图：</p>
<p><img src="/imgs/akka/akka_4_normal_recovery_flows.png" alt="功能流和恢复流"></p>
<p>actor中并不捕获异常，就直接让actor挂掉就性了。actor代码中只包含功能处理，而且没有异常处理逻辑或者恢复逻辑，不参与恢复过程，这样就清晰多了。crashed actor的mailbox在恢复流里的supervisor处理完exception之前都是暂停的。那么一个actor怎样才能变成一个supervisor呢？akka有一个父监管的机制，就是创建actor的actor自动成为被创建actor的supervisor。一个supervisor并不捕获异常，也不修复actor或者actor的状态，只负责判断怎样恢复，然后触发相应的策略。supervisor有4种策略：</p>
<ul>
<li>restart。使用失败actor的Props重建一个actor。这个新的actor重启之后，就继续处理消息。因为app的其他部分都是使用ActorRef来跟actor沟通，新的actor实例可以自动获取到下一条message。</li>
<li>resume。给当前actor新生，假装啥都没发生</li>
<li>stop。终结actor。</li>
<li>escalate。supervisor不知道怎样处理这个问题，抛给它的supervisor。</li>
</ul>
<p>下图是针对log处理系统的一个示例：</p>
<p><img src="/imgs/akka/akka_4_normal_recovery_flows_akka.png" alt="log处理系统中的功能流与恢复流"></p>
<p>上图中给出的容错方案是，当DbBrokenConnectionException发生的时候，使用restart策略，替换一个重建的dbWriter actor。</p>
<p>多数情况下，我们不希望重复执行那条导致失败的信息。比如logprocessor遇到一个损坏的文件，这导致mailbox走火入魔，任何message都不会被处理了，因为这个损坏的文件导致我们一次又一次的失败。鉴于此，如果是akka默认对于restart策略处理的actor，不再把处理失败的message放回mailbox了，如果不想这样，后面我们会说一下怎样做。</p>
<p>下图展示了当supervisor选择restart策略后，一个挂掉的dbWriter actor实例怎样被一个新的实例替换掉：</p>
<p><img src="/imgs/akka/akka_4_restart_handle_exception.png" alt="使用restart处理DbBrokenConnectionException异常"></p>
<p>结合容错性，说一下let it crash的好处：</p>
<ul>
<li>错误隔离。supervisor可以决定是否终结actor。</li>
<li>Structure。 actor system的actorRef层级使得在不影响其他actor的前提下替换actor实例</li>
<li>冗余。一个actor可以被另一个替换掉。在断掉的数据库连接例子中，新的actor实例可以连接到不同的数据库。supervisor也可以决定停掉错误的actor创建另一种类型的actor。另外还可以把message路由给一个负载均衡的actor集群中，后面第八章我们会讲到。</li>
<li>替换。actor总是可以被它的Props重建。supervisor不用了解重建actor的任何细节。</li>
<li>重启。通过restart实现</li>
<li>组件生命周期。actor是一个active component。可以被启动，停止，重启。下一节我们会讨论actor的生命周期。</li>
<li>暂停。当actor挂掉的时候，它的mailbox就暂停了，直到supervisor处理完毕。</li>
<li>关注隔离。负责功能的actor与负责容错的actor已经隔离开了。</li>
</ul>
<h2 id="4-2-Actor生命周期"><a href="#4-2-Actor生命周期" class="headerlink" title="4.2 Actor生命周期"></a>4.2 Actor生命周期</h2><p>actor在创建之后就自动启动了。在被停止之前，actor一直保持在Started state。停止之后的state是Terminated，这时actor就不能处理message了，而且会被GC回收。当state是Started的时候，它既可以被重启也可以设置它的state为其他值。</p>
<p>一个actor的生命周期中有三种类型的event发生：</p>
<ul>
<li>被创建和启动，Start</li>
<li>被重启，Restart</li>
<li>被停止，Stop</li>
</ul>
<p>在Actor trait中有几个hook对应这生命周期的改变。我们可以在这些hook里添加自己的代码，用来为新建的actor指定一些自定义的state，也可以在restart之前处理前面处理失败的message，还可以清空某些资源占用。下面我们看看这三种event，并了解一下hook的重写。</p>
<h4 id="4-2-1-Start事件"><a href="#4-2-1-Start事件" class="headerlink" title="4.2.1 Start事件"></a>4.2.1 Start事件</h4><p>一个普通的actor是通过actorOf方法创建并启动的。顶层actor是被ActorSystem的actorOf方法床架难点。父actor通过自身的ActorContext的actorOf方法创建子actor。</p>
<p><img src="/imgs/akka/akka_4_start_actor.png" alt="启动一个actor"></p>
<p>实例创建好之后，就会被Akka启动。preStart hook是在actor启动之前被调用的。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">preStart</span></span>() &#123;</div><div class="line">	println(<span class="string">"preStart"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>一般这个hook可以用来设置actor的初始状态。</p>
<h4 id="4-2-2-Stop事件"><a href="#4-2-2-Stop事件" class="headerlink" title="4.2.2 Stop事件"></a>4.2.2 Stop事件</h4><p>actor通常通过调用ActorSystem和ActorContext对象的stop方法停止，或者发送一个PosionPill message给它。</p>
<p><img src="/imgs/akka/akka_4_stop_actor.png" alt="停止actor"></p>
<p>postStop hook与preStart对称，在actor被终结之前，state被修改为Terminated之后调用。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">postStop</span></span>()&#123;</div><div class="line">	println(<span class="string">"postStop"</span>)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>一般用来释放资源，或者保存当前actor处理的一些信息到actor外界，以便新的actor实例可以使用。stopped actor和它的ActorRef会断开连接。ActorRef会被重定向到actor system的deadLetters ActorRef，这个ActorRef专门用来接收发送给挂了的actor的message。</p>
<h4 id="4-2-3-Restart事件"><a href="#4-2-3-Restart事件" class="headerlink" title="4.2.3 Restart事件"></a>4.2.3 Restart事件</h4><p><img src="/imgs/akka/akka_4_restart_actor.png" alt="重启actor"></p>
<p>restart发生后，触发挂掉的actor的preRestart方法。在这个hook中挂掉的actor实例可以储存它当前的一些状态信息。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">preRestart</span></span>(reason: <span class="type">Throwable</span>, <span class="comment">// 被当前actor跑出的异常</span></div><div class="line">                         message: <span class="type">Option</span>[<span class="type">Any</span>]) &#123; <span class="comment">//导致错误的message</span></div><div class="line">   println(<span class="string">"preRestart"</span>)</div><div class="line">   <span class="keyword">super</span>.preRestart(reason, message) <span class="comment">//警告：这是调用super的实现</span></div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>重写这个hook的时候需要额外注意。默认的preRestart实现是先停止所有的子actor，然后再调用postStop hook。如果忘记调用super.preRestart方法，刚才提到的默认逻辑就不会执行了。记住actor是由Props创建的。Props对象其实是调用的actor的构造方法。actor可以在它的构造方法中创建子actor。如果挂掉的actor的子actor没有被停掉，那么后面随着父actor的多次restart，会有很多的子actor，就泛滥了。</p>
<p>注意restart和stop停掉actor 的方式是不一样的。在restart中挂掉的actor实例不会产生Terminated message。新的actor实例在restar期间就连接到了原来的ActorRef上。而stoped事件中stopped actor要将message重定向。两者相同的是在挂掉的actor被切离actor system之后都会调用postStop。</p>
<p>保存state的方式：可以给自己的mailbox发一条message，也可以存在类似DB的介质中。</p>
<p>调用完preStart hook之后，一个actor实例就被创建了。在postRestart hook被调用后。。。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">postRestart</span></span>(reason: <span class="type">Throwable</span>) &#123; <span class="comment">//当前actor抛出的异常</span></div><div class="line">  println(<span class="string">"postRestart"</span>)</div><div class="line">  <span class="keyword">super</span>.postRestart(reason) <span class="comment">//警告：调用super实现</span></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这里也有个警告，就是调用父级实现，它会触发preStart方法的执行。如果你确认不需要调用preStart方法，就不用调用这个父级实现了。</p>
<h4 id="4-2-4-把生命周期整合起来"><a href="#4-2-4-把生命周期整合起来" class="headerlink" title="4.2.4 把生命周期整合起来"></a>4.2.4 把生命周期整合起来</h4><p>把上面所有的event结合起来就是actor的整体生命周期了，下图只展示了一个restart：<br><img src="/imgs/akka/akka_4_full_life.png" alt="actor的整体生命周期"></p>
<p>对应整体生命周期的hook代码如下：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> aia.faulttolerance</div><div class="line"></div><div class="line"><span class="keyword">import</span> akka.actor._</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LifeCycleHooks</span> <span class="keyword">extends</span> <span class="title">Actor</span> <span class="keyword">with</span> <span class="title">ActorLogging</span> </span>&#123;</div><div class="line">  println(<span class="string">"Constructor"</span>)</div><div class="line">  <span class="comment">//&lt;start id="ch3-life-start"/&gt;</span></div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">preStart</span></span>() &#123;</div><div class="line">    println(<span class="string">"preStart"</span>) <span class="comment">//&lt;co id="ch3-life-start-1" /&gt;</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">//&lt;end id="ch3-life-start"/&gt;</span></div><div class="line"></div><div class="line">  <span class="comment">//&lt;start id="ch3-life-stop"/&gt;</span></div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">postStop</span></span>() &#123;</div><div class="line">    println(<span class="string">"postStop"</span>) <span class="comment">//&lt;co id="ch3-life-stop-1" /&gt;</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">//&lt;end id="ch3-life-stop"/&gt;</span></div><div class="line"></div><div class="line">  <span class="comment">//&lt;start id="ch3-life-pre-restart"/&gt;</span></div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">preRestart</span></span>(reason: <span class="type">Throwable</span>, <span class="comment">//&lt;co id="ch3-life-pre-restart-1a" /&gt;</span></div><div class="line">                          message: <span class="type">Option</span>[<span class="type">Any</span>]) &#123; <span class="comment">//&lt;co id="ch3-life-pre-restart-1b" /&gt;</span></div><div class="line">    println(<span class="string">"preRestart"</span>)</div><div class="line">    <span class="keyword">super</span>.preRestart(reason, message) <span class="comment">//&lt;co id="ch3-life-pre-restart-2" /&gt;</span></div><div class="line">  &#125;</div><div class="line">  <span class="comment">//&lt;end id="ch3-life-pre-restart"/&gt;</span></div><div class="line"></div><div class="line">  <span class="comment">//&lt;start id="ch3-life-post-restart"/&gt;</span></div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">postRestart</span></span>(reason: <span class="type">Throwable</span>) &#123; <span class="comment">//&lt;co id="ch3-life-post-restart-1" /&gt;</span></div><div class="line">    println(<span class="string">"postRestart"</span>)</div><div class="line">    <span class="keyword">super</span>.postRestart(reason) <span class="comment">//&lt;co id="ch3-life-post-restart-2" /&gt;</span></div><div class="line"></div><div class="line">  &#125;</div><div class="line">  <span class="comment">//&lt;end id="ch3-life-post-restart"/&gt;</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</div><div class="line">    <span class="keyword">case</span> <span class="string">"restart"</span> =&gt;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalStateException</span>(<span class="string">"force restart"</span>)</div><div class="line">    <span class="keyword">case</span> msg: <span class="type">AnyRef</span> =&gt;</div><div class="line">      println(<span class="string">"Receive"</span>)</div><div class="line">      sender() ! msg</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面测试一下：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> aia.faulttolerance</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.scalatest.&#123;<span class="type">WordSpecLike</span>, <span class="type">BeforeAndAfterAll</span>&#125;</div><div class="line"><span class="keyword">import</span> akka.testkit.<span class="type">TestKit</span></div><div class="line"><span class="keyword">import</span> akka.actor._</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LifeCycleHooksTest</span> <span class="keyword">extends</span> <span class="title">TestKit</span>(<span class="params"><span class="type">ActorSystem</span>("<span class="type">LifCycleTest</span>"</span>)) <span class="keyword">with</span> <span class="title">WordSpecLike</span> <span class="keyword">with</span> <span class="title">BeforeAndAfterAll</span> </span>&#123;</div><div class="line"></div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">afterAll</span></span>() &#123;</div><div class="line">    system.terminate()</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="string">"The Child"</span> must &#123;</div><div class="line">    <span class="string">"log lifecycle hooks"</span> in &#123;</div><div class="line">      <span class="comment">//&lt;start id="ch3-life-test"/&gt;</span></div><div class="line">      <span class="keyword">val</span> testActorRef = system.actorOf( <span class="comment">//&lt;co id="ch3-life-test-start" /&gt;</span></div><div class="line">        <span class="type">Props</span>[<span class="type">LifeCycleHooks</span>], <span class="string">"LifeCycleHooks"</span>)</div><div class="line">      testActorRef ! <span class="string">"restart"</span> <span class="comment">//&lt;co id="ch3-life-test-restart" /&gt;</span></div><div class="line">      testActorRef.tell(<span class="string">"msg"</span>, testActor)</div><div class="line">      expectMsg(<span class="string">"msg"</span>)</div><div class="line">      system.stop(testActorRef) <span class="comment">//&lt;co id="ch3-life-test-stop" /&gt;</span></div><div class="line">      <span class="type">Thread</span>.sleep(<span class="number">1000</span>)</div><div class="line">      <span class="comment">//&lt;end id="ch3-life-test"/&gt;</span></div><div class="line"></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="4-2-5-生命周期监控"><a href="#4-2-5-生命周期监控" class="headerlink" title="4.2.5 生命周期监控"></a>4.2.5 生命周期监控</h4><p>ActorContext的watch方法负责监控actor的死亡，unwatch方法反注册某个actor。一旦一个actor调用了某个ActorRef的watch方法，他就被这个ActorRef监控了。当被监控的actor被终结后，监控的actor会收到一个Terminated message，这个message只包含挂掉的actor的ActorRef。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> aia.faulttolerance</div><div class="line"></div><div class="line"><span class="keyword">import</span> akka.actor._</div><div class="line"><span class="keyword">import</span> akka.actor.<span class="type">Terminated</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">DbStrategy2</span> </span>&#123;</div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">DbWatcher</span>(<span class="params">dbWriter: <span class="type">ActorRef</span></span>) <span class="keyword">extends</span> <span class="title">Actor</span> <span class="keyword">with</span> <span class="title">ActorLogging</span> </span>&#123;</div><div class="line">    context.watch(dbWriter) <span class="comment">//watch dbWriter的生命周期</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</div><div class="line">      <span class="keyword">case</span> <span class="type">Terminated</span>(actorRef) =&gt; <span class="comment">//被终结的actor的actorRef被放在Terminated message中传递</span></div><div class="line">        log.warning(<span class="string">"Actor &#123;&#125; terminated"</span>, actorRef) <span class="comment">//监控者打印出dbWriter被终结的消息</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  <span class="comment">//&lt;end id="ch03-termination"/&gt;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>与supervisor只能是父actor对子actor不同，actor之间的监控是没有任何规则的。只要某个actor可以访问到被监控actor的ActorRef，那么它就可以调用context.watch(actorRef)进行监控。监控(monitor)与监管(supervisor)联合起来使用会有特别强大的效果，下一节我们会介绍。</p>
<h2 id="4-3-监管"><a href="#4-3-监管" class="headerlink" title="4.3 监管"></a>4.3 监管</h2><p>这一节我们继续以log处理app为例，深入看一下监管的细节处理。这一节我们关注一下<code>用户空间</code>也就是actor path为/user下的监管层级。这个actor path是所有app的actor的家。/user之外的path我们会在actor system关闭过程中涉及到。首先我们先看一下为某个app定义supervisor的层级的几种方式，对比一下优缺点。然后看一下怎样在supervisor中自定义监管策略。</p>
<h4 id="4-3-1-监管层级"><a href="#4-3-1-监管层级" class="headerlink" title="4.3.1 监管层级"></a>4.3.1 监管层级</h4><p>actor在被创建的时候就注定了由它的创建者actor监管。父actor只有终结它的子actor才能接触这种监管关系。所在在app启动的时候就需要慎重考虑监管策略，尤其是不想整批整批的替换子actor的时候。</p>
<p>actor所处的层级越高，危险性越大。极端情况，顶层actor出现错误的话，整个系统的所有actor都需要重启。</p>
<p>下图展示了supervisor和actor之间的沟通，以及一个新的文件产生到存储入数据库的信息流：</p>
<p><img src="/imgs/akka/akka_4_message_flow_supervisor.png" alt="supervisor分离与信息流"></p>
<p>图中可以看到fileWatcherSupervisor同时创建了fileWatcher和logProcessorsSupervisor。fileWatcher需要一个logProcessor的关联对象，而这个logProcessor是由logProcessorsSupervisor创建的，所以我们不能直接给fileWatcher一个ActorRef。我们不得不添加一些信息，发送给logProcessorsSupervisor，向它请求logProcessor的ActorRef，然后把ActorRef转给fileWatcher。</p>
<p>这种方法的好处是actor之间可以之间沟通，supervisor只负责监管与创建actor实例。缺点是我们之恩那个使用restart策略，否则message就会被发送给deadLetters，丢失掉。父监管模式使得监管从信息流中解耦有些难。logProcessor只能被logProcessorsSupervisor创建，这样就很难传递它的ActorRef给fileWatcher。</p>
<p>下一幅图是另一种实现方式。supervisor不只是创建和监管actor，它们还负责传递消息流给它的子actor。对于被监管的actor来说没有改变什么，因为真正的发送者是透明的。比如logProcessor会认为他的message是从fileWatcher获取的，但是实际上logProcessorSupervisor参与了这个message的转发。</p>
<p><img src="/imgs/akka/akka_4_supervisor_forward_message.png" alt="supervisor转发消息流"></p>
<p>这种方式的好处是间接提供了层级。supervisor可以在其他actor不知情的前提下终结或者扩张它的子actor。相比前面的方式，这种方式不会出现信息流断裂的情况。这种方案更适合父监管模式，因为supervisor可以直接使用Props对象创建它的子actor。比如fileWatcherSupervisor可以直接使用它创建的logProcessingSupervisor的ActorRef去创建fileWatcher。以下是实现代码：</p>
<p><img src="/imgs/akka/akka_4_supervisor_hierarchy_code.png" alt="监管层级实现代码"></p>
<p>Props对象在actor之间来回传递，它包含了创建子actor所需要的依赖信息，这样每个actor在创建子actor的时候就不用关心细节了。最顶层的actor是由<code>system.actorFor</code>方法创建爱你的，因为我们想让系统中其他由supervisor创建的actor都沿着它这条发源地走下去。下一节我们会了解一下创建actor的具体过程：主要就是使用Props对象，调用<code>context.actorOf(props)</code>方法创建一个子actor，然后把当前actor作为每个新生actor的supervisor。</p>
<h4 id="4-3-2-预订义监管策略"><a href="#4-3-2-预订义监管策略" class="headerlink" title="4.3.2 预订义监管策略"></a>4.3.2 预订义监管策略</h4><p>创建app的顶层actor的是/user路径，它被<code>user guardian</code>监管。user guardian的默认监管策略是一旦发生异常，就直接重启它的子actor。actor的默认监管策略可以通过实现supervisorStrategy方法进行重写。在supervisorStrategy中有两个预订义的监管策略：defaultStrategy和stoppingStrategy。顾名思义，前者是所有的actor的默认监管策略，如果不重写的话，就一直使用这个策略：<br><img src="/imgs/akka/akka_4_default_strategy.png" alt="默认监管策略"></p>
<ul>
<li>Decider对异常模式匹配选择一个Directive</li>
<li>Directive包含：Stop, Start, Resume, Escalate这几种</li>
<li>defaultDecider返回OneForOneStrategy</li>
</ul>
<p>有时我们只需要停掉出错的actor，有时一旦有一个子actor出错我们就需要停掉所有的子actor。OneForOneStrategy代表这子actor不会有相同的命运，只有挂掉的子actor会被Decider裁决。还有AllForOneStrategy，他就是只要有一个子actor出问题，所有的子actor就都需要遭受裁决。</p>
<p>下图是stoppingStrategy的代码：<br><img src="/imgs/akka/akka_4_stopping_strategy.png" alt="stoppingStrategy代码"></p>
<p>发生任何异常stoppingStrategy都会停掉所有的子actor。如果不是发生Exception，而是Error呢？任何监管策略处理不了的Throwable都会向上抛给当前actor的父supervisor，抛到最顶层，也就是user guardian那里还处理不了的话就会导致整个actor system挂掉。</p>
<h4 id="4-3-3-自定义策略"><a href="#4-3-3-自定义策略" class="headerlink" title="4.3.3 自定义策略"></a>4.3.3 自定义策略</h4><p>每个app为了容错都需要定义一些自己的策略。前面我们提到一个supervisor对待挂掉的actor有四种处理措施，下面我们还是以log处理app来举例。</p>
<ol>
<li>Resume。 忽略错误，使用现在的actor继续执行message</li>
<li>Restart。 移除挂掉的actor实例，使用新的actor实例替换它</li>
<li>Stop。 永久终结这个actor</li>
<li>Escalate。 把失败报给自己的supervisor，让自己的父actor去处理。</li>
</ol>
<p>首先看一下在log处理app中可能出现的异常。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SerialVersionUID</span>(<span class="number">1</span>L)</div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">DiskError</span>(<span class="params">msg: <span class="type">String</span></span>)</span></div><div class="line">    <span class="keyword">extends</span> <span class="type">Error</span>(msg) <span class="keyword">with</span> <span class="type">Serializable</span> <span class="comment">//当硬盘挂掉导致资源不可用时的一个不可恢复的Error</span></div><div class="line"></div><div class="line">  <span class="meta">@SerialVersionUID</span>(<span class="number">1</span>L)</div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">CorruptedFileException</span>(<span class="params">msg: <span class="type">String</span>, val file: <span class="type">File</span></span>)</span></div><div class="line">    <span class="keyword">extends</span> <span class="type">Exception</span>(msg) <span class="keyword">with</span> <span class="type">Serializable</span> <span class="comment">//日志文件损坏造成的Exception</span></div><div class="line"></div><div class="line">  <span class="meta">@SerialVersionUID</span>(<span class="number">1</span>L)</div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">DbBrokenConnectionException</span>(<span class="params">msg: <span class="type">String</span></span>)</span></div><div class="line">    <span class="keyword">extends</span> <span class="type">Exception</span>(msg) <span class="keyword">with</span> <span class="type">Serializable</span> <span class="comment">//数据库连接断开的Exception</span></div></pre></td></tr></table></figure></p>
<p>actor之间发送的message可以放在一个protocol对象中统一管理。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">  <span class="class"><span class="keyword">object</span> <span class="title">LogProcessingProtocol</span> </span>&#123;</div><div class="line">    <span class="comment">// represents a new log file</span></div><div class="line">    <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">LogFile</span>(<span class="params">file: <span class="type">File</span></span>) <span class="title">//从fileWatcher接收到一个log文件。log</span> <span class="title">processor要处理这个message</span></span></div><div class="line">    <span class="comment">// A line in the log file parsed by the LogProcessor Actor</span></div><div class="line">    <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Line</span>(<span class="params">time: <span class="type">Long</span>, message: <span class="type">String</span>, messageType: <span class="type">String</span></span>) <span class="title">//LogFile里的一行数据。数据库的writer需要将这个数据写到数据库连接里</span></span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>首先从最底层看一下可能出现DbBrokenConnectionException的dbWriter。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DbWriter</span>(<span class="params">databaseUrl: <span class="type">String</span></span>) <span class="keyword">extends</span> <span class="title">Actor</span> </span>&#123;</div><div class="line">    <span class="keyword">val</span> connection = <span class="keyword">new</span> <span class="type">DbCon</span>(databaseUrl)</div><div class="line"></div><div class="line">    <span class="keyword">import</span> <span class="type">LogProcessingProtocol</span>._</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</div><div class="line">      <span class="keyword">case</span> <span class="type">Line</span>(time, message, messageType) =&gt;</div><div class="line">        connection.write(<span class="type">Map</span>(<span class="symbol">'time</span> -&gt; time,</div><div class="line">          <span class="symbol">'message</span> -&gt; message,</div><div class="line">          <span class="symbol">'messageType</span> -&gt; messageType)) <span class="comment">//向数据库写数据就可能引发这个异常</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>DbWriter是由DbSupervisor监管的，前面说到DbSupervisor会把所有的message转发给dbWriter。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DbSupervisor</span>(<span class="params">writerProps: <span class="type">Props</span></span>) <span class="keyword">extends</span> <span class="title">Actor</span> </span>&#123;</div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">supervisorStrategy</span> </span>= <span class="type">OneForOneStrategy</span>() &#123;</div><div class="line">      <span class="keyword">case</span> _: <span class="type">DbBrokenConnectionException</span> =&gt; <span class="type">Restart</span> <span class="comment">//发生DbBrokenConnectionException的时候执行Restart策略</span></div><div class="line">    &#125;</div><div class="line">    <span class="keyword">val</span> writer = context.actorOf(writerProps) <span class="comment">//supervisor使用一个Props对象创建dbWriter</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</div><div class="line">      <span class="keyword">case</span> m =&gt; writer forward (m) <span class="comment">//supervisor把收到的所有的message转发给dbWriter ActorRef</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>再向上一些，就是logProcessor。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogProcessor</span>(<span class="params">dbSupervisor: <span class="type">ActorRef</span></span>)</span></div><div class="line">  <span class="keyword">extends</span> <span class="type">Actor</span> <span class="keyword">with</span> <span class="type">LogParsing</span> &#123;</div><div class="line">  <span class="keyword">import</span> <span class="type">LogProcessingProtocol</span>._</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</div><div class="line">    <span class="keyword">case</span> <span class="type">LogFile</span>(file) =&gt;</div><div class="line">      <span class="keyword">val</span> lines = parse(file) <span class="comment">//读取文件就可能引发异常，导致当前actor挂掉</span></div><div class="line">      lines.foreach(dbSupervisor ! _) <span class="comment">//把文件的每一行都发送给dbSupervisor</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>当出现文件损坏问题的时候，它的supervisor采取措施如下：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogProcSupervisor</span>(<span class="params">dbSupervisorProps: <span class="type">Props</span></span>)</span></div><div class="line">  <span class="keyword">extends</span> <span class="type">Actor</span> &#123;</div><div class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">supervisorStrategy</span> </span>= <span class="type">OneForOneStrategy</span>() &#123;</div><div class="line">    <span class="keyword">case</span> _: <span class="type">CorruptedFileException</span> =&gt; <span class="type">Resume</span> <span class="comment">//出现CorruptedFileException.的时候，跳过损坏的文件，继续执行</span></div><div class="line">  &#125;</div><div class="line">  <span class="keyword">val</span> dbSupervisor = context.actorOf(dbSupervisorProps) <span class="comment">//创建database的supervisor，而且被当前supervisor监管</span></div><div class="line">  <span class="keyword">val</span> logProcProps = <span class="type">Props</span>(<span class="keyword">new</span> <span class="type">LogProcessor</span>(dbSupervisor))</div><div class="line">  <span class="keyword">val</span> logProcessor = context.actorOf(logProcProps) <span class="comment">//通过Props创建logProcessor</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</div><div class="line">    <span class="keyword">case</span> m =&gt; logProcessor forward (m) <span class="comment">//把所有的message都转发给logProcessor ActorRef</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>再向上一个层级，FileWatcher:<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileWatcher</span>(<span class="params">sourceUri: <span class="type">String</span>,</span></span></div><div class="line">                    logProcSupervisor: <span class="type">ActorRef</span>)</div><div class="line">    <span class="keyword">extends</span> <span class="type">Actor</span> <span class="keyword">with</span> <span class="type">FileWatchingAbilities</span> &#123;</div><div class="line">    register(sourceUri) <span class="comment">//使用file的watching API注册监听文件变化</span></div><div class="line">    <span class="keyword">import</span> <span class="type">FileWatcherProtocol</span>._</div><div class="line">    <span class="keyword">import</span> <span class="type">LogProcessingProtocol</span>._</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</div><div class="line">      <span class="keyword">case</span> <span class="type">NewFile</span>(file, _) =&gt; <span class="comment">//利用file watching API，当发现新文件的时候发送出去</span></div><div class="line">        logProcSupervisor ! <span class="type">LogFile</span>(file) <span class="comment">//发送给logProcSupervisor</span></div><div class="line">      <span class="keyword">case</span> <span class="type">SourceAbandoned</span>(uri) <span class="keyword">if</span> uri == sourceUri =&gt;</div><div class="line">        self ! <span class="type">PoisonPill</span> <span class="comment">//如果出现硬盘损坏问题，fileWatcher就自杀</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>fileWatcher这个actor自杀之后，由于DiskError没有被定义处理策略，所以就会自动向上传递。这是一个不可恢复的error，所以FileWatchingSupervisor决定停止所有的actor，使用了AllForOneStrategy：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileWatcherSupervisor</span>(<span class="params">sources: <span class="type">Vector</span>[<span class="type">String</span>],</span></span></div><div class="line">                               logProcSuperProps: <span class="type">Props</span>)</div><div class="line">    <span class="keyword">extends</span> <span class="type">Actor</span> &#123;</div><div class="line"></div><div class="line">    <span class="keyword">var</span> fileWatchers: <span class="type">Vector</span>[<span class="type">ActorRef</span>] = sources.map &#123; source =&gt;</div><div class="line">      <span class="keyword">val</span> logProcSupervisor = context.actorOf(logProcSuperProps)</div><div class="line">      <span class="keyword">val</span> fileWatcher = context.actorOf(<span class="type">Props</span>(</div><div class="line">        <span class="keyword">new</span> <span class="type">FileWatcher</span>(source, logProcSupervisor)))</div><div class="line">      context.watch(fileWatcher) <span class="comment">//对filewatcher实施监控</span></div><div class="line">      fileWatcher</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">supervisorStrategy</span> </span>= <span class="type">AllForOneStrategy</span>() &#123;</div><div class="line">      <span class="keyword">case</span> _: <span class="type">DiskError</span> =&gt; <span class="type">Stop</span> <span class="comment">//如果出现DiskError，就停掉所有的fileWatcher</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</div><div class="line">      <span class="keyword">case</span> <span class="type">Terminated</span>(fileWatcher) =&gt; <span class="comment">//确认这是fileWatcher的Terminated message</span></div><div class="line">        fileWatchers = fileWatchers.filterNot(w =&gt; w == fileWatcher)</div><div class="line">        <span class="keyword">if</span> (fileWatchers.isEmpty) self ! <span class="type">PoisonPill</span> <span class="comment">//所有的fileWatcher都停掉之后，服毒自尽</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>OneForOneStrategy和AllForOneStrategy都提供了maxNrOfRetries和withinTimeRange作为构造参数，分别代表重试几次停止和停止超时时间，按需设置。设置之后，如果重试几次或者超时么有停止，就自动向上传递。下面是一个数据库supervisor的例子：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">DbImpatientSupervisor</span>(<span class="params">writerProps: <span class="type">Props</span></span>) <span class="keyword">extends</span> <span class="title">Actor</span> </span>&#123;</div><div class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">def</span> <span class="title">supervisorStrategy</span> </span>= <span class="type">OneForOneStrategy</span>(</div><div class="line">      maxNrOfRetries = <span class="number">5</span>,</div><div class="line">      withinTimeRange = <span class="number">60</span> seconds) &#123; <span class="comment">//如果5次restart或者60s内没有解决这个问题，就自动上传这个问题给父级supervisor</span></div><div class="line">        <span class="keyword">case</span> _: <span class="type">DbBrokenConnectionException</span> =&gt; <span class="type">Restart</span></div><div class="line">      &#125;</div><div class="line">    <span class="keyword">val</span> writer = context.actorOf(writerProps)</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</div><div class="line">      <span class="keyword">case</span> m =&gt; writer forward (m)</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<h2 id="4-4-总结"><a href="#4-4-总结" class="headerlink" title="4.4 总结"></a>4.4 总结</h2><p>容错是Akka相当给力的一部分，也是这个工具对于并发处理的重要组成。’Let it Crash’的哲学并不是主张把所有可能发生的问题都忽略，它也不能处理掉所有的问题。相反，编程人员是希望有恢复措施的，但是怎样使这措施顺利执行是空前的。这一届中我们使用log处理app讲解了容错：</p>
<ul>
<li>监管意味着我们的恢复代码与功能代码的隔离</li>
<li>基于message的Actor模型意味着即便某个actor挂掉，我们还是能继续工作</li>
<li>我们可以忽略、丢弃、重启：自由选择</li>
<li>我们甚至可以将自己处理不了的错误直接抛给父级supervisor</li>
</ul>
<p>有了akka，容错变得很简单。下一章我们要构建几个不同类型的基于actor的app，看一下怎样提供configuration, logging于发布之类的功能。</p>
]]></content>
      
        
        <tags>
            
            <tag> akka </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[akka in action 读书笔记（3）]]></title>
      <url>/2016/08/01/akka-in-action-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%EF%BC%883%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>这一篇我们一起看一下:使用akka测试驱动开发。</p>
<p>当TDD刚出现的时候，大家都感觉它浪费很长时间。尤其感觉让测试一些组件的协作更花费时间。Actor提供了一个又去的解决方案：</p>
<ul>
<li>actor可以更直接的测试，因为他们本身就代表具体行为。【几乎所有的TDD都有至少一个BDD（Behavior-Driven-Development）】</li>
<li>普通的单元测试只能测试接口，而且只能分别测试</li>
<li><p>Actor是基于消息的。也就是只要发送message就可以很轻松的模拟各种行为了。</p>
<h4 id="3-1-测试Actor"><a href="#3-1-测试Actor" class="headerlink" title="3.1 测试Actor"></a>3.1 测试Actor</h4><p>  我们使用ScalaTest单元测试框架来测试发送与接收message。<br>  看代码以前，我们要了解，测试Actor相比测试不同的对象还是要稍微复杂一点儿的，原因如下：</p>
<ul>
<li>时间。 发送message是一步的，所以不知道多长时间才能去assert返回值</li>
<li>异步。 Actor是在多个线程中并行运行的。多线程测试相比单线程测试要复杂以下，需要处理一些并发原是变量来同步多个actor的结果，比如lock、latch、barrier等。这些正是我们要远离的。仅仅是一个barrier的错用都会导致一个单元测试block住，从而影响整个test suite。</li>
<li>无状态。actor的内部状态是隐藏的，只能通过ActorRef来访问。单元测试的时候要注意这点。</li>
<li>协作/整合。如果要测试几个actor之间的整合，必须在这些actor之间窃听它们之间传递的message是不是期望值。</li>
</ul>
<hr>
<p>  虽然有以上困难，好在Akka也提供了<code>akka-testkit</code> module。这个module包含了几个可以很方便的进行actor测试的工具。这个module覆盖了下面几种不同的测试类型：</p>
<ul>
<li>单线程测试。 一个actor实例通常并不能直接使用。testkit提供了TestActorRef，它允许访问指定的actor实例。这样就能直接调用actor的方法，来测试我们定义的actor，向测试普通对象一样了。</li>
<li>多线程单元测试。<code>TestKit</code>和<code>TestProbe</code>两个类，让我们方便的接收回复，检查message，为特定message设置到达时限。TestKit有专门的方法来assert期望值。Actor在多线程环境中使用一个普通的dispatcher来运行。</li>
<li><p>多jvm测试。测试远程actor system的时候会用到。</p>
<p>TestActorRef继承了LocalActorRef，设置dispatcher为CallingThreadDispatcher, CallingThreadDispatcher只用来测试。（它直接使用调用者的线程，而不是另起一个线程）。</p>
<p>明眼人看的出来，多线程环境基本贴近于生产环境，所以我们接触最多。<br>关于<a href="http://www.scalatest.org/" target="_blank" rel="external">ScalaTest</a></p>
</li>
</ul>
</li>
</ul>
<h5 id="3-1-1-准备测试"><a href="#3-1-1-准备测试" class="headerlink" title="3.1.1 准备测试"></a>3.1.1 准备测试</h5><p>因为有一些通用的逻辑，我们先定义一个Trait，使测试能够在单元测试结束后自动停止测试系统。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> aia.testdriven</div><div class="line"><span class="comment">//&lt;start id="ch02-stopsystem"/&gt;</span></div><div class="line"><span class="keyword">import</span> org.scalatest.&#123; <span class="type">Suite</span>, <span class="type">BeforeAndAfterAll</span> &#125;</div><div class="line"><span class="keyword">import</span> akka.testkit.<span class="type">TestKit</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">trait</span> <span class="title">StopSystemAfterAll</span> <span class="keyword">extends</span> <span class="title">BeforeAndAfterAll</span> </span>&#123; </div><div class="line">		<span class="comment">//继承ScalaTest的基础trait</span></div><div class="line">  <span class="keyword">this</span>: <span class="type">TestKit</span> <span class="keyword">with</span> <span class="type">Suite</span> =&gt; <span class="comment">//这个trait只能与使用TestKit的测试使用</span></div><div class="line">  <span class="keyword">override</span> <span class="keyword">protected</span> <span class="function"><span class="keyword">def</span> <span class="title">afterAll</span></span>() &#123;</div><div class="line">    <span class="keyword">super</span>.afterAll()</div><div class="line">    system.terminate() <span class="comment">//测试完成后关闭测试系统</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>我们写测试的时候就可以mixin这个trait了。TestKit暴露了一个system变量，可以用来访问测试中创建的actor以及其他信息。</p>
<h4 id="3-2-单向消息"><a href="#3-2-单向消息" class="headerlink" title="3.2 单向消息"></a>3.2 单向消息</h4><p>记住，我们已经不再使用那种触发某个动作，等待response的方式了，所以我们的例子都是使用<code>tell</code>来发送单向消息也就顺理成章了。拜这种fire and forget方式所赐，我们不知道message什么时候到达actor，或者即便到了，我们怎么样进行测试呢？我们期望是发送一个message给一个actor，然后这个actor能够正确的处理这条message。如果actor的处理动作对于外界完全不可见，我们只能保证它处理之后没有出现任何错误，我们应该使用TestActorRef来访问actor的状态，确保它完好。下面是我们需要注意的三种actor：</p>
<ul>
<li>SilentActor。这种actor的行为对于外界不可见，但是中间它会创建一些内部状态。只要处理中没有出现任何错误或异常我们就认为测试通过。检测处理中内部状态的变化就可以了。</li>
<li>SendingActor。这种actor处理完收到的message之后会发送message到其他actor。我们把这种actor当做一个黑盒，查看输入与输出的message就行了。</li>
<li><p>SideEffiectingActor。这种actor接收message，与一个普通对象进行一些交互。发送message给这种actor之后，需要确认以下普通对象是否被按照预期修改了。</p>
<p> 下面我们为以上列举的每种actor都写个test。</p>
</li>
</ul>
<h5 id="3-2-1-SilentActor例子"><a href="#3-2-1-SilentActor例子" class="headerlink" title="3.2.1 SilentActor例子"></a>3.2.1 SilentActor例子</h5><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> aia.testdriven</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.scalatest.&#123;<span class="type">WordSpecLike</span>, <span class="type">MustMatchers</span>&#125;</div><div class="line"><span class="keyword">import</span> akka.testkit.<span class="type">TestKit</span></div><div class="line"><span class="keyword">import</span> akka.actor._</div><div class="line"></div><div class="line"><span class="comment">//This test is ignored in the BookBuild, it's added to the defaultExcludedNames</span></div><div class="line"><span class="comment">//&lt;start id="ch02-silentactor-test01"/&gt;</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SilentActor01Test</span> <span class="keyword">extends</span> <span class="title">TestKit</span>(<span class="params"><span class="type">ActorSystem</span>("testsystem"</span>)) </span></div><div class="line">  <span class="keyword">with</span> <span class="type">WordSpecLike</span> <span class="comment">//WordSpecLike提供了一种易读的DSL来测试BDD形式的测试</span></div><div class="line">  <span class="keyword">with</span> <span class="type">MustMatchers</span> <span class="comment">//MustMatchers提供了易读的assertion</span></div><div class="line">  <span class="keyword">with</span> <span class="type">StopSystemAfterAll</span> &#123; <span class="comment">//我们刚刚定义的，完成测试后关闭system</span></div><div class="line"></div><div class="line">  <span class="string">"A Silent Actor"</span> must &#123; <span class="comment">// 写上文本描述</span></div><div class="line">    <span class="string">"change state when it receives a message, single threaded"</span> in &#123; <span class="comment">// 每个in都描述一个指定的测试</span></div><div class="line">      <span class="comment">//Write the test, first fail</span></div><div class="line">      fail(<span class="string">"not implemented yet"</span>)</div><div class="line">    &#125;</div><div class="line">    <span class="string">"change state when it receives a message, multi-threaded"</span> in &#123;</div><div class="line">      <span class="comment">//Write the test, first fail</span></div><div class="line">      fail(<span class="string">"not implemented yet"</span>)</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"><span class="comment">//&lt;end id="ch02-silentactor-test01"/&gt;</span></div><div class="line"></div><div class="line"><span class="comment">//定义一个Actor</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SilentActor</span> <span class="keyword">extends</span> <span class="title">Actor</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</div><div class="line">    <span class="keyword">case</span> msg =&gt;  <span class="comment">// 所有接收到的message都被吞如黑洞</span></div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="comment">//&lt;end id="ch02-silentactor-test01-imp"/&gt;</span></div></pre></td></tr></table></figure>
<p>以上是一个WordSpec形式的测试，可以写多个文本描述。下面我们定义来一个Actor。</p>
<p>我们首先写测试发送message给这个actor，然后观察它内部状态的变化。</p>
<p>SilentActor和SilentActorProtocol都是为了辅助测试的，后者包含了所有前者支持的message类型，可以方便地对message进行分组管理。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> silentactor02 &#123;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SilentActorTest</span> <span class="keyword">extends</span> <span class="title">TestKit</span>(<span class="params"><span class="type">ActorSystem</span>("testsystem"</span>))</span></div><div class="line">    <span class="keyword">with</span> <span class="type">WordSpecLike</span></div><div class="line">    <span class="keyword">with</span> <span class="type">MustMatchers</span></div><div class="line">    <span class="keyword">with</span> <span class="type">StopSystemAfterAll</span> &#123;</div><div class="line"></div><div class="line">    <span class="string">"A Silent Actor"</span> must &#123;</div><div class="line">      <span class="comment">//&lt;start id="ch02-silentactor-test02"/&gt;</span></div><div class="line">      <span class="string">"change internal state when it receives a message, single"</span> in &#123;</div><div class="line">        <span class="keyword">import</span> <span class="type">SilentActor</span>._ <span class="comment">//引入Protocol定义的message类型</span></div><div class="line"></div><div class="line">        <span class="keyword">val</span> silentActor = <span class="type">TestActorRef</span>[<span class="type">SilentActor</span>] <span class="comment">//为单线程测试创建TestActorRef</span></div><div class="line">        silentActor ! <span class="type">SilentMessage</span>(<span class="string">"whisper"</span>)</div><div class="line">        silentActor.underlyingActor.state must (contain(<span class="string">"whisper"</span>)) <span class="comment">//测试刚刚放进的message在目标actor中</span></div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 对应提到的Protocol</span></div><div class="line">  <span class="class"><span class="keyword">object</span> <span class="title">SilentActor</span> </span>&#123; </div><div class="line">    <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">SilentMessage</span>(<span class="params">data: <span class="type">String</span></span>) <span class="title">//SilentActor可以处理的一种message类型</span></span></div><div class="line">    <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">GetState</span>(<span class="params">receiver: <span class="type">ActorRef</span></span>)</span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">SilentActor</span> <span class="keyword">extends</span> <span class="title">Actor</span> </span>&#123;</div><div class="line">    <span class="keyword">import</span> <span class="type">SilentActor</span>._</div><div class="line">    <span class="keyword">var</span> internalState = <span class="type">Vector</span>[<span class="type">String</span>]()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</div><div class="line">      <span class="keyword">case</span> <span class="type">SilentMessage</span>(data) =&gt;</div><div class="line">        internalState = internalState :+ data <span class="comment">//state这里是被存储在一个vector中，每个message都会被加入这个vector</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">state</span> </span>= internalState <span class="comment">//放回当前的所有内部状态</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于返回的状态列表是不可变的，测试并不会影响我们验证期望数据。</p>
<p>下面我们看一下多线程版本的。<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SilentActorTest</span> <span class="keyword">extends</span> <span class="title">TestKit</span>(<span class="params"><span class="type">ActorSystem</span>("testsystem"</span>))</span></div><div class="line">    <span class="keyword">with</span> <span class="type">WordSpecLike</span></div><div class="line">    <span class="keyword">with</span> <span class="type">MustMatchers</span></div><div class="line">    <span class="keyword">with</span> <span class="type">StopSystemAfterAll</span> &#123;</div><div class="line"></div><div class="line">    <span class="string">"A Silent Actor"</span> must &#123;</div><div class="line">     </div><div class="line">      <span class="string">"change internal state when it receives a message, multi"</span> in &#123;</div><div class="line">        <span class="keyword">import</span> <span class="type">SilentActor</span>._ </div><div class="line"></div><div class="line">        <span class="keyword">val</span> silentActor = system.actorOf(<span class="type">Props</span>[<span class="type">SilentActor</span>], <span class="string">"s3"</span>) <span class="comment">//创建actor的方式不同</span></div><div class="line">        silentActor ! <span class="type">SilentMessage</span>(<span class="string">"whisper1"</span>)</div><div class="line">        silentActor ! <span class="type">SilentMessage</span>(<span class="string">"whisper2"</span>)</div><div class="line">        silentActor ! <span class="type">GetState</span>(testActor) <span class="comment">// 添加了一种消息类型，来返回当前的状态</span></div><div class="line">        expectMsg(<span class="type">Vector</span>(<span class="string">"whisper1"</span>, <span class="string">"whisper2"</span>)) <span class="comment">//测试断言</span></div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">object</span> <span class="title">SilentActor</span> </span>&#123;</div><div class="line">    <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">SilentMessage</span>(<span class="params">data: <span class="type">String</span></span>)</span></div><div class="line">    <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">GetState</span>(<span class="params">receiver: <span class="type">ActorRef</span></span>) <span class="title">//添加的消息类型</span></span></div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">class</span> <span class="title">SilentActor</span> <span class="keyword">extends</span> <span class="title">Actor</span> </span>&#123;</div><div class="line">    <span class="keyword">import</span> <span class="type">SilentActor</span>._</div><div class="line">    <span class="keyword">var</span> internalState = <span class="type">Vector</span>[<span class="type">String</span>]()</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</div><div class="line">      <span class="keyword">case</span> <span class="type">SilentMessage</span>(data) =&gt;</div><div class="line">        internalState = internalState :+ data</div><div class="line">      <span class="keyword">case</span> <span class="type">GetState</span>(receiver) =&gt; receiver ! internalState <span class="comment">//返回参数中内部状态给receiver，也就是GetState参数的ActorRef</span></div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>多线程使用TestKit内置的<code>testsystem</code>这个ActorSystem来创建SilentActor。这样我们就不能使用多线程的actor去直接访问actor实例了。这里使用GetState消息封装了一个ActorRef作为参数。TestKit有一个testActor让你用来接收你期望的message。我们在receive里添加的GetState的方法返回了指定actorRef的内部状态。expectMsg方法是期望每个发送到testActor的message都被assert。</p>
<p>这里的internalState依然是不可变的，所以仍然是完全安全的。</p>
<h5 id="3-2-SendingActor例子"><a href="#3-2-SendingActor例子" class="headerlink" title="3.2 SendingActor例子"></a>3.2 SendingActor例子</h5><p>回想以下第一章中的买票的例子，我们需要测试的是党我们买了一个Ticket，那么可以卖的Ticket总数就要减少一个。既然TicketingAgent负责减票并将event继续传递给下一个TicketingAgent，我们只需要创建一个SendingActor，把它作为下一个接收者放到chain里去，然后观察票数变化情况就行了。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> aia.testdriven</div><div class="line"></div><div class="line"><span class="keyword">import</span> akka.testkit.<span class="type">TestKit</span></div><div class="line"><span class="keyword">import</span> akka.actor.&#123; <span class="type">Props</span>, <span class="type">ActorRef</span>, <span class="type">Actor</span>, <span class="type">ActorSystem</span> &#125;</div><div class="line"><span class="keyword">import</span> org.scalatest.&#123;<span class="type">WordSpecLike</span>, <span class="type">MustMatchers</span>&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SendingActor01Test</span> <span class="keyword">extends</span> <span class="title">TestKit</span>(<span class="params"><span class="type">ActorSystem</span>("testsystem"</span>))</span></div><div class="line">  <span class="keyword">with</span> <span class="type">WordSpecLike</span></div><div class="line">  <span class="keyword">with</span> <span class="type">MustMatchers</span></div><div class="line">  <span class="keyword">with</span> <span class="type">StopSystemAfterAll</span> &#123;</div><div class="line"></div><div class="line">  <span class="string">"A Sending Actor"</span> must &#123;</div><div class="line">    <span class="string">"send a message to an actor when it has finished"</span> in &#123;</div><div class="line">      <span class="keyword">import</span> <span class="type">Kiosk01Protocol</span>._</div><div class="line">      <span class="keyword">val</span> props = <span class="type">Props</span>(<span class="keyword">new</span> <span class="type">Kiosk01</span>(testActor)) <span class="comment">// 下一个TicketingAgent通过构造函数传递，这里我们传的是testActor</span></div><div class="line">      <span class="keyword">val</span> sendingActor = system.actorOf(props, <span class="string">"kiosk1"</span>)</div><div class="line">      <span class="keyword">val</span> tickets = <span class="type">Vector</span>(<span class="type">Ticket</span>(<span class="number">1</span>), <span class="type">Ticket</span>(<span class="number">2</span>), <span class="type">Ticket</span>(<span class="number">3</span>))</div><div class="line">      <span class="keyword">val</span> game = <span class="type">Game</span>(<span class="string">"Lakers vs Bulls"</span>, tickets) <span class="comment">// 湖人对公牛的门票库</span></div><div class="line">      sendingActor ! game</div><div class="line"></div><div class="line">      expectMsgPF() &#123;</div><div class="line">        <span class="keyword">case</span> <span class="type">Game</span>(_, tickets) =&gt; <span class="comment">//testAcotr应该接收到了一个event</span></div><div class="line">          tickets.size must be(game.tickets.size - <span class="number">1</span>) <span class="comment">// testActor应该接收到了一个ticket被减少了</span></div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">Kiosk01Protocol</span> </span>&#123;</div><div class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Ticket</span>(<span class="params">seat: <span class="type">Int</span></span>) </span></div><div class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Game</span>(<span class="params">name: <span class="type">String</span>, tickets: <span class="type">Seq</span>[<span class="type">Ticket</span>]</span>) <span class="title">//包含message的event</span></span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Kiosk01</span>(<span class="params">nextKiosk: <span class="type">ActorRef</span></span>) <span class="keyword">extends</span> <span class="title">Actor</span> </span>&#123;</div><div class="line">  <span class="keyword">import</span> <span class="type">Kiosk01Protocol</span>._</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</div><div class="line">    <span class="keyword">case</span> game @ <span class="type">Game</span>(_, tickets) =&gt;</div><div class="line">      nextKiosk ! game.copy(tickets = tickets.tail) <span class="comment">//一个不可变的去掉第一个ticket的副本被发往下一个TicketingAgent</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>下面是一些SendingActor的变种：</p>
<table>
<thead>
<tr>
<th>Actor</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>MutatingCopyActor</td>
<td>这种actor创建一个变种的copy，然后发送副本到下一个actor，上面用到的就属于这种</td>
</tr>
<tr>
<td>ForwardingActor</td>
<td>这种actor不修改收到的message，只是转发出去</td>
</tr>
<tr>
<td>TransformingActor</td>
<td>这种actor会根据收到的message创建一个不同类型的message</td>
</tr>
<tr>
<td>SequencingActor</td>
<td>这种actor基于收到的message创建很多的message，然后按序发送出去</td>
</tr>
</tbody>
</table>
<p>前三种使用相同的方式进行测试。</p>
<p>FilteringActor不同于其他的是它会定位我们传递的message是为什么没有通过测试？SequencingActor跟它类似。那么我们怎样确认我们收到了正确数量的message呢？先给FilteringActor写个测试吧。我们要弄一个可以自动过滤重复message的FilteringActor。它有一个已经收到的所有的message的list，每次来新的message的时候都检查是不是已经有了相同的message。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> aia.testdriven</div><div class="line"></div><div class="line"><span class="keyword">import</span> akka.testkit.<span class="type">TestKit</span></div><div class="line"><span class="keyword">import</span> akka.actor.&#123; <span class="type">Actor</span>, <span class="type">Props</span>, <span class="type">ActorRef</span>, <span class="type">ActorSystem</span> &#125;</div><div class="line"><span class="keyword">import</span> org.scalatest.&#123;<span class="type">MustMatchers</span>, <span class="type">WordSpecLike</span> &#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FilteringActorTest</span> <span class="keyword">extends</span> <span class="title">TestKit</span>(<span class="params"><span class="type">ActorSystem</span>("testsystem"</span>))</span></div><div class="line">  <span class="keyword">with</span> <span class="type">WordSpecLike</span></div><div class="line">  <span class="keyword">with</span> <span class="type">MustMatchers</span></div><div class="line">  <span class="keyword">with</span> <span class="type">StopSystemAfterAll</span> &#123;</div><div class="line">  <span class="string">"A Filtering Actor"</span> must &#123;</div><div class="line">    <span class="string">"filter out particular messages"</span> in &#123;</div><div class="line">      <span class="keyword">import</span> <span class="type">FilteringActor</span>._</div><div class="line">      <span class="keyword">val</span> props = <span class="type">FilteringActor</span>.props(testActor, <span class="number">5</span>)</div><div class="line">      <span class="keyword">val</span> filter = system.actorOf(props, <span class="string">"filter-1"</span>)</div><div class="line">      filter ! <span class="type">Event</span>(<span class="number">1</span>) <span class="comment">// 发送一串message</span></div><div class="line">      filter ! <span class="type">Event</span>(<span class="number">2</span>)</div><div class="line">      filter ! <span class="type">Event</span>(<span class="number">1</span>)</div><div class="line">      filter ! <span class="type">Event</span>(<span class="number">3</span>)</div><div class="line">      filter ! <span class="type">Event</span>(<span class="number">1</span>)</div><div class="line">      filter ! <span class="type">Event</span>(<span class="number">4</span>)</div><div class="line">      filter ! <span class="type">Event</span>(<span class="number">5</span>)</div><div class="line">      filter ! <span class="type">Event</span>(<span class="number">5</span>)</div><div class="line">      filter ! <span class="type">Event</span>(<span class="number">6</span>)</div><div class="line">      <span class="keyword">val</span> eventIds = receiveWhile() &#123; <span class="comment">//收集testActor收到的所有满足case语句的message</span></div><div class="line">        <span class="keyword">case</span> <span class="type">Event</span>(id) <span class="keyword">if</span> id &lt;= <span class="number">5</span> =&gt; id</div><div class="line">      &#125;</div><div class="line">      eventIds must be(<span class="type">List</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)) <span class="comment">//测试没有收入重复的message</span></div><div class="line">      expectMsg(<span class="type">Event</span>(<span class="number">6</span>))</div><div class="line">    &#125;</div><div class="line">    <span class="string">"filter out particular messages using expectNoMsg"</span> in &#123;</div><div class="line">      <span class="keyword">import</span> <span class="type">FilteringActor</span>._</div><div class="line">      <span class="keyword">val</span> props = <span class="type">FilteringActor</span>.props(testActor, <span class="number">5</span>)</div><div class="line">      <span class="keyword">val</span> filter = system.actorOf(props, <span class="string">"filter-2"</span>)</div><div class="line">      filter ! <span class="type">Event</span>(<span class="number">1</span>)</div><div class="line">      filter ! <span class="type">Event</span>(<span class="number">2</span>)</div><div class="line">      expectMsg(<span class="type">Event</span>(<span class="number">1</span>))</div><div class="line">      expectMsg(<span class="type">Event</span>(<span class="number">2</span>))</div><div class="line">      filter ! <span class="type">Event</span>(<span class="number">1</span>)</div><div class="line">      expectNoMsg</div><div class="line">      filter ! <span class="type">Event</span>(<span class="number">3</span>)</div><div class="line">      expectMsg(<span class="type">Event</span>(<span class="number">3</span>))</div><div class="line">      filter ! <span class="type">Event</span>(<span class="number">1</span>)</div><div class="line">      expectNoMsg</div><div class="line">      filter ! <span class="type">Event</span>(<span class="number">4</span>)</div><div class="line">      filter ! <span class="type">Event</span>(<span class="number">5</span>)</div><div class="line">      filter ! <span class="type">Event</span>(<span class="number">5</span>)</div><div class="line">      expectMsg(<span class="type">Event</span>(<span class="number">4</span>))</div><div class="line">      expectMsg(<span class="type">Event</span>(<span class="number">5</span>))</div><div class="line">      expectNoMsg()</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">FilteringActor</span> </span>&#123;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">props</span></span>(nextActor: <span class="type">ActorRef</span>, bufferSize: <span class="type">Int</span>) =</div><div class="line">    <span class="type">Props</span>(<span class="keyword">new</span> <span class="type">FilteringActor</span>(nextActor, bufferSize))</div><div class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Event</span>(<span class="params">id: <span class="type">Long</span></span>)</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">FilteringActor</span>(<span class="params">nextActor: <span class="type">ActorRef</span>,</span></span></div><div class="line">                     bufferSize: <span class="type">Int</span>) <span class="keyword">extends</span> <span class="title">Actor</span> &#123;<span class="comment">// 定义buffer大小 </span></div><div class="line">  <span class="keyword">import</span> <span class="type">FilteringActor</span>._</div><div class="line">  <span class="keyword">var</span> lastMessages = <span class="type">Vector</span>[<span class="type">Event</span>]() <span class="comment">//上一批message的vector</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</div><div class="line">    <span class="keyword">case</span> msg: <span class="type">Event</span> =&gt;</div><div class="line">      <span class="keyword">if</span> (!lastMessages.contains(msg)) &#123;</div><div class="line">        lastMessages = lastMessages :+ msg</div><div class="line">        nextActor ! msg <span class="comment">// 如果buffer中没有event就发送给下个actor</span></div><div class="line">        <span class="keyword">if</span> (lastMessages.size &gt; bufferSize) &#123;</div><div class="line">          <span class="comment">// 当到了最大buffer，最老的message就被忽略了</span></div><div class="line">          lastMessages = lastMessages.tail <span class="comment">//&lt;co id="ch02-filteringactor-discard"/&gt;</span></div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>receiveWhile方法同样也可以用来测试</p>
]]></content>
      
        
        <tags>
            
            <tag> akka </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[django的POST或者GET参数映射到对象]]></title>
      <url>/2016/07/21/django%E7%9A%84POST%E6%88%96%E8%80%85GET%E5%8F%82%E6%95%B0%E6%98%A0%E5%B0%84%E5%88%B0%E5%AF%B9%E8%B1%A1/</url>
      <content type="html"><![CDATA[<p>原理及其简单，就算利用python的自省，有点儿类似java的反射调用。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">etl = ETL()</div><div class="line">        dic = dict(request.POST)</div><div class="line">        <span class="keyword">for</span> k,v <span class="keyword">in</span> dic.iteritems():</div><div class="line">            <span class="keyword">if</span> hasattr(etl, k):</div><div class="line">                setattr(etl, k, v)</div><div class="line">        <span class="keyword">print</span> etl</div></pre></td></tr></table></figure></p>
<p>就这几行代码就可以搞定了。为了公用方便，可以抽出来作为一个module使用。</p>
<p>简单封装了以下<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*</span></div><div class="line"><span class="keyword">import</span> logging</div><div class="line"></div><div class="line"><span class="string">'''</span></div><div class="line">http的一些常用的工具方法</div><div class="line">'''</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">post2obj</span><span class="params">(obj, post, *excludes)</span>:</span></div><div class="line">    <span class="string">'''</span></div><div class="line">    将post里的参数对应copy到obj里，主要是方便http接口直接使用obj进行操作</div><div class="line">    :param obj:</div><div class="line">    :param post:</div><div class="line">    :return:</div><div class="line">    '''</div><div class="line">    dic = dict(post)</div><div class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> dic.iteritems():</div><div class="line">        <span class="keyword">if</span> k <span class="keyword">not</span> <span class="keyword">in</span> excludes:</div><div class="line">            <span class="keyword">if</span> hasattr(obj, k):</div><div class="line">                v = <span class="string">''</span>.join(v)</div><div class="line">                setattr(obj, k, v)</div><div class="line">    logging.info(<span class="string">"post params has been copied to  obj -&gt; %s"</span> % obj)</div><div class="line"></div><div class="line">...</div><div class="line">...</div><div class="line">get 同理</div></pre></td></tr></table></figure></p>
<p><code>注意</code>：上面我们使用了’’.join(v)。因为从dict里遍历出来的所有value都是list类型的。而<code>request.POST[&#39;xxx&#39;]</code>取出来的就是正常的unicode类型。list会在后面的处理中出现很多问题，所以这里转成str再使用。</p>
<p>再想想，其实可以通过python的装饰器【对应java里的注释】实现，但是目前不太确定python是否支持java的泛型类的东西，可以用来自动生成操作对象的实例。</p>
]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[django的奇葩form]]></title>
      <url>/2016/07/21/django%E7%9A%84%E5%A5%87%E8%91%A9form/</url>
      <content type="html"><![CDATA[<p>记录一下遇到的最奇葩的组件：django的form插件。官方文档是：<a href="https://docs.djangoproject.com/ja/1.9/ref/forms/widgets/。" target="_blank" rel="external">https://docs.djangoproject.com/ja/1.9/ref/forms/widgets/。</a></p>
<p>弄这个东西的初衷场景：python里暂时没有找到类似java里类似下面的功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"save"</span>,method = RequestMethod.POST, produces = MediaType.APPLICATION_JSON)</div><div class="line">    <span class="keyword">public</span> <span class="meta">@ResponseBody</span> <span class="function">Object <span class="title">addETL</span><span class="params">(ETL etl)</span> <span class="keyword">throws</span> Exception</span>&#123;</div><div class="line">        etl.setAuthor(<span class="string">"will"</span>);</div><div class="line">        etlService.addETL(etl);</div><div class="line">        <span class="keyword">return</span> <span class="string">"&#123;\"message\" :\"success\"&#125;"</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>调用这个接口的时候，只需要传递ETL的字段就可以了，不管是POST还是GET方法，都会自己序列化进入ETL对象，然后就可以操作client端传送上来的ETL对象了 。<br>但是在python或者django里本人暂时没有找到这种方便的方式，只能通过request.POST[‘name’]之类的方法，挨个从POST对象里面取出来，再自己用这些属性去初始化ETL对象，之后再去执行save或者等等之类的操作….身为一个优秀的程序员，必须将“懒”的特性发回出来。所以就去django官网找能够实现类似功能的例子，所以就找到了django的form组件。</p>
<p>额外发现是，当我们需要编辑一个已经存在的ETL的时候，可以自动把所有字段渲染到前端。</p>
<p>那么满怀期待地开始了恶心的form探索之旅。</p>
<h2 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"etls/add"</span> <span class="attr">method</span>=<span class="string">"POST"</span>&gt;</span></div><div class="line">    &#123;% csrf_token %&#125;</div><div class="line">        &#123;&#123; form.as_p &#125;&#125;</div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div></pre></td></tr></table></figure>
<p>简直是简单的不要不要的。</p>
<p>后端</p>
<h2 id="views文件里定义一个Form。"><a href="#views文件里定义一个Form。" class="headerlink" title="views文件里定义一个Form。"></a>views文件里定义一个Form。</h2><p>自定义一个form<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ETLForm</span><span class="params">(forms.ModelForm)</span>:</span></div><div class="line">    preSql = forms.CharField(widget=forms.Textarea(attrs=&#123;<span class="string">'class'</span>: <span class="string">"form-control"</span>, <span class="string">"size"</span>: <span class="number">10</span>&#125;))</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        model = ETL</div><div class="line">        exclude = [<span class="string">'id'</span>, <span class="string">'ctime'</span>]</div></pre></td></tr></table></figure></p>
<p>上面这段，定义了preSql这个字段的显示类型为form的textarea，然后定义来这个textarea的属性，包括class样式。<br>Meta里定义了model的数据模型，还有要去除不显示的字段。也可以指定fields，就是要显示的字段。 怎么方便怎么来就是了。</p>
<p>其实恶心的东西就是这里写的样式了。好，就算能够接受后端把逻辑和样式一起写了。可是对于不是form的样式怎么办呢，有很多页面就不是form啊，比如列表～会有很多样式必须需要在前端写。那样就是前端有样式，后端也有样式，麻蛋，想想头就大。</p>
<p>其实是有种更方便的做法<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Form = modelform_factory(Author, form=AuthorForm, localized_fields=(<span class="string">"birth_date"</span>,))</div></pre></td></tr></table></figure></p>
<p>鉴于本人对上面这种后端写样式就已经感觉不能接受了，就没有再继续搞这个东西。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@transaction.atomic</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(request, pk)</span>:</span></div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</div><div class="line">        form = ETLForm(request.POST)</div><div class="line">        <span class="keyword">if</span> form.is_valid():</div><div class="line"></div><div class="line"></div><div class="line">            new_etl = form.save()</div><div class="line">            logger.info(<span class="string">'ETL has been created successfully : '</span> + new_etl)</div><div class="line">            <span class="keyword">return</span> HttpResponseRedirect(reverse(<span class="string">'metamap:index'</span>))</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        etl = ETL.objects.get(pk=pk)</div><div class="line">        form = ETLForm(instance=etl)</div><div class="line">        <span class="keyword">return</span> render(request, <span class="string">'etl/edit.html'</span>, &#123;<span class="string">'form'</span>: form&#125;)</div></pre></td></tr></table></figure>
<p>路由配置是<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">url(<span class="string">'etls/(?P&lt;pk&gt;[0-9]+)/$'</span>, etls.edit),</div></pre></td></tr></table></figure></p>
<p><img src="/imgs/django/django-form.png" alt="前端效果图"></p>
<p>记录以下这个奇葩组件，然后使用传统form进行逻辑编写，就算是要到POST里逐个取值，也认了！！！！</p>
<p>widget相关：<a href="https://docs.djangoproject.com/ja/1.9/ref/forms/widgets/" target="_blank" rel="external">https://docs.djangoproject.com/ja/1.9/ref/forms/widgets/</a></p>
]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[JPARepository杂记]]></title>
      <url>/2016/07/16/JPARepository%E6%9D%82%E8%AE%B0/</url>
      <content type="html"><![CDATA[<h2 id="join时报错"><a href="#join时报错" class="headerlink" title="join时报错"></a>join时报错</h2><p>报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">QuerySyntaxException: expecting IDENT, found &apos;*&apos; near line 1</div></pre></td></tr></table></figure></p>
<p>原始sql<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hql:<span class="keyword">select</span> a.* <span class="keyword">from</span> <span class="keyword">Archive</span> a,Employee e,Department d <span class="keyword">where</span> a.contractEndDate = :<span class="built_in">date</span> <span class="keyword">and</span> a.status = <span class="string">'A'</span> <span class="keyword">and</span> a.empId = e.id <span class="keyword">and</span> e.status = <span class="string">'A'</span> <span class="keyword">and</span> e.type = <span class="string">'A'</span></div></pre></td></tr></table></figure></p>
<p>改成<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> a <span class="keyword">from</span> <span class="keyword">Archive</span> a,Employee e,Department d <span class="keyword">where</span> a.contractEndDate = :<span class="built_in">date</span> <span class="keyword">and</span> a.status = <span class="string">'A'</span> <span class="keyword">and</span> a.empId = e.id <span class="keyword">and</span> e.status = <span class="string">'A'</span> <span class="keyword">and</span> e.type = <span class="string">'A'</span></div></pre></td></tr></table></figure></p>
<p>select 后面为对象 a .而非 a.*</p>
<p>参考：<br><a href="http://blog.sina.com.cn/s/blog_4bf2e5550100n2gh.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_4bf2e5550100n2gh.html</a></p>
<h2 id="SQL面向Entity"><a href="#SQL面向Entity" class="headerlink" title="SQL面向Entity"></a>SQL面向Entity</h2><p>指的是在JPARepository的子类中自定义的函数<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TblBloodRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">TblBlood</span>, <span class="title">Integer</span>&gt;</span>&#123;</div><div class="line">    <span class="function">TblBlood <span class="title">findByTblName</span><span class="params">(String tblName)</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@Query</span>(<span class="string">"select a from "</span></div><div class="line">            + <span class="string">"(select blood from TblBlood blood where valid = 1) a"</span></div><div class="line">            + <span class="string">" left outer join "</span></div><div class="line">            + <span class="string">"(select distinct parentTbl from TblBlood where valid = 1) b"</span></div><div class="line">            + <span class="string">" on a.tblName = b.parentTbl"</span></div><div class="line">            + <span class="string">" where b.parentTbl is null"</span>)</div><div class="line">    <span class="function">List&lt;TblBlood&gt; <span class="title">selectAllLeaf</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@Modifying</span></div><div class="line">    <span class="meta">@Query</span>(<span class="string">"update TblBlood set valid = 0 where tblName=:tblName"</span>)</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">makePreviousInvalid</span><span class="params">(@Param(<span class="string">"tblName"</span>)</span>String tblName)</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Query</span>(<span class="string">"select b from"</span></div><div class="line">            + <span class="string">" TblBlood a join TblBlood b"</span></div><div class="line">            + <span class="string">" on a.parentTbl = b.tblName and b.valid = 1"</span></div><div class="line">            + <span class="string">" where a.valid = 1 and a.tblName = :tblName"</span>)</div><div class="line">    <span class="function">List&lt;TblBlood&gt; <span class="title">selectParentByTblName</span><span class="params">(@Param(<span class="string">"tblName"</span>)</span>String tblName)</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Query</span>(<span class="string">"from TblBlood where valid = 1 and parentTbl=:tblName"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;TblBlood&gt; <span class="title">selectByParentTblName</span><span class="params">(@Param(<span class="string">"tblName"</span>)</span>String tblName)</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Query</span>(<span class="string">"from TblBlood where valid = 1 and tblName=:tblName"</span>)</div><div class="line">    <span class="function">List&lt;TblBlood&gt; <span class="title">selectByTblName</span><span class="params">(@Param(<span class="string">"tblName"</span>)</span>String tblName)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>TblBlood就是对象的类名，而不是真正的表名。</p>
<h2 id="自join"><a href="#自join" class="headerlink" title="自join"></a>自join</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Query</span>(<span class="string">"select b from"</span></div><div class="line">            + <span class="string">" TblBlood a join TblBlood b"</span></div><div class="line">            + <span class="string">" on a.parentTbl = b.tblName and b.valid = 1"</span></div><div class="line">            + <span class="string">" where a.valid = 1 and a.tblName = ?1"</span>)</div><div class="line">    <span class="function">List&lt;TblBlood&gt; <span class="title">selectParentByTblName</span><span class="params">(String tblName)</span></span>;</div></pre></td></tr></table></figure>
<p>报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">  Path expected for join!</div><div class="line">	at org.hibernate.hql.internal.ast.HqlSqlWalker.createFromJoinElement(HqlSqlWalker.java:378)</div><div class="line">	at org.hibernate.hql.internal.antlr.HqlSqlBaseWalker.joinElement(HqlSqlBaseWalker.java:3858)</div><div class="line">	at org.hibernate.hql.internal.antlr.HqlSqlBaseWalker.fromElement(HqlSqlBaseWalker.java:3644)</div><div class="line">	at org.hibernate.hql.internal.antlr.HqlSqlBaseWalker.fromElementList(HqlSqlBaseWalker.java:3522)</div><div class="line"> </div><div class="line"> org.springframework.beans.factory.BeanCreationException: Error creating bean with name &apos;tblBloodRepository&apos;: Invocation of init method failed; nested exception is java.lang.IllegalArgumentException: Validation failed for query for method public abstract java.util.List com.will.hivesolver.repositories.TblBloodRepository.selectParentByTblName(java.lang.String)!</div><div class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1574)</div><div class="line">	...</div><div class="line">Caused by: java.lang.IllegalArgumentException: Validation failed for query for method public abstract java.util.List com.will.hivesolver.repositories.TblBloodRepository.selectParentByTblName(java.lang.String)!</div><div class="line">	at org.springframework.data.jpa.repository.query.SimpleJpaQuery.validateQuery(SimpleJpaQuery.java:84)</div><div class="line">	.....</div><div class="line">Caused by: java.lang.IllegalStateException: No data type for node: org.hibernate.hql.internal.ast.tree.IdentNode </div><div class="line"> \-[IDENT] IdentNode: &apos;b&apos; &#123;originalText=b&#125;</div><div class="line"></div><div class="line">	at org.hibernate.hql.internal.ast.tree.SelectClause.initializeExplicitSelectClause(SelectClause.java:174)</div><div class="line">	at org.hibernate.hql.internal.ast.HqlSqlWalker.useSelectClause(HqlSqlWalker.java:923)</div><div class="line">	...</div></pre></td></tr></table></figure></p>
<h2 id="不能更新"><a href="#不能更新" class="headerlink" title="不能更新"></a>不能更新</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">严重: Servlet.service() for servlet [api] in context with path [/metamap] threw exception [Request processing failed; nested exception is org.springframework.dao.InvalidDataAccessApiUsageException: Executing an update/delete query; nested exception is javax.persistence.TransactionRequiredException: Executing an update/delete query] with root cause</div><div class="line">javax.persistence.TransactionRequiredException: Executing an update/delete query</div></pre></td></tr></table></figure>
<p>Spring Data JPA，事务导致的异常</p>
<p>需要在springMVC的xml里添加,这里只扫描Controller所在的位置里的Controller<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.will.hivesolver.controller"</span> <span class="attr">use-default-filters</span>=<span class="string">"false"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">"annotation"</span> <span class="attr">expression</span>=<span class="string">"org.springframework.stereotype.Controller"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">"annotation"</span> <span class="attr">expression</span>=<span class="string">"org.springframework.web.bind.annotation.ControllerAdvice"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>在applicationContext.xml中添加，这里必须不能扫描上面扫描过的Controller：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.will.hivesolver"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">"annotation"</span> <span class="attr">expression</span>=<span class="string">"org.springframework.stereotype.Controller"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">"annotation"</span> <span class="attr">expression</span>=<span class="string">"org.springframework.web.bind.annotation.ControllerAdvice"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>参考：<a href="https://github.com/springside/springside4/wiki/Spring-MVC" target="_blank" rel="external">https://github.com/springside/springside4/wiki/Spring-MVC</a></p>
]]></content>
      
        
        <tags>
            
            <tag> spring </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[express杂记]]></title>
      <url>/2016/07/16/express%E6%9D%82%E8%AE%B0/</url>
      <content type="html"><![CDATA[<h2 id="app-set-get"><a href="#app-set-get" class="headerlink" title="app.set/get"></a>app.set/get</h2><p>用来查看或者设置一些配置参数</p>
<h2 id="express里变量的换行出不来"><a href="#express里变量的换行出不来" class="headerlink" title="express里变量的换行出不来"></a>express里变量的换行出不来</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/get_log'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">      worker.exec(<span class="string">"cat "</span> + req.query.location, <span class="function"><span class="keyword">function</span> (<span class="params">error, stdout, stderr</span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'stderr : '</span> + stderr);</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'stdout : '</span> + stdout);</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'error : '</span> + error);</div><div class="line">        res.render(<span class="string">'etls/log'</span>, &#123;<span class="attr">stdout</span> : stdout, <span class="attr">log</span> : req.query.location&#125;);</div><div class="line">      &#125;); </div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<p>后面控制台的输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">stderr : </div><div class="line">stdout : # job for mymeta@my_table</div><div class="line"># author : will</div><div class="line"># create time : 19700118070840</div><div class="line"># pre settings </div><div class="line">delete from default.tbl</div><div class="line">select * from batting</div><div class="line">error : null</div></pre></td></tr></table></figure></p>
<p>模板文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#&#123;stdout&#125;</div></pre></td></tr></table></figure></p>
<p>前端输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># job for mymeta@my_table # author : will # create time : 19700118070840 # pre settings delete from default.tbl select * from batting</div></pre></td></tr></table></figure></p>
<p>控制台的stdout变量是换行的，但是前端就不换行。试了一下res.send()，结果也是这样。</p>
<p>模板修改为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">!&#123;stdout.replace(/\n/g, &apos;&lt;br/&gt;&apos;)&#125;</div></pre></td></tr></table></figure></p>
<p>如果使用res.send()的话，就res.send(stdout.replace(/\n/g, ‘<br>‘))就行了。</p>
<p>这个换行支持起来那么难么？比较low的感觉。</p>
<h2 id="body-parser"><a href="#body-parser" class="headerlink" title="body-parser"></a>body-parser</h2><p>安装了body parser之后就可以方便的在req中使用 <code>req.body</code>来获取form内容，使用<code>req.query</code>来获取querystring里的内容了。</p>
<p>但是一定要注意express的app.use是有前后次序的。<code>踩过坑</code></p>
]]></content>
      
        
        <tags>
            
            <tag> nodejs </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ember散记]]></title>
      <url>/2016/06/26/ember%E6%95%A3%E8%AE%B0/</url>
      <content type="html"><![CDATA[<p>主要是弄ambari的时候，ambari view使用了emberjs框架，自己按照官网教程走了一遍，此文章只是记录一些散记，不成系统。</p>
<h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><table>
<thead>
<tr>
<th>命令</th>
<th>解释</th>
<th>扩展</th>
</tr>
</thead>
<tbody>
<tr>
<td>ember g route xxx/contact</td>
<td>生成route handler</td>
<td>url里访问的路径xxx/contact会被定位到routes/xxx/contact.js下。生成template文件，route文件，对应的单元测试文件</td>
</tr>
<tr>
<td>ember g component list</td>
<td>生成一个component</td>
<td>位于templates/components文件夹下，可以被其他template以模块的形式引用。对应的js文件在根目录的components下</td>
</tr>
<tr>
<td>ember install ember-cli-tutorial-style</td>
<td>安装插件到当前项目</td>
<td>示例中的这个插件，会自动copy一些css文件到指定目录</td>
</tr>
<tr>
<td>ember g model rental</td>
<td>生成一个ember data model</td>
<td>在models文件夹下生成对应的model文件还有单元测试文件 </td>
</tr>
<tr>
<td>ember g helper rental-property-type</td>
<td>生成一个helper</td>
<td>在helpers文件夹下生成对应的js文件，还有单元测试文件</td>
</tr>
<tr>
<td>ember g controller index</td>
<td>生成一个controller</td>
<td>在controllers文件夹下生成对应js文件，单元测试文件</td>
</tr>
</tbody>
</table>
<h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><p>route handler中添加model方法，可以在template里直接使用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> Ember.Route.extend(&#123;</div><div class="line">  model() &#123;</div><div class="line">    <span class="keyword">return</span> rentals;            </div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>在template中的使用：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[[#each model as |rental|]]    </div><div class="line">  <span class="tag">&lt;<span class="name">article</span> <span class="attr">class</span>=<span class="string">"listing"</span>&gt;</span>    </div><div class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>[[rental.title]]<span class="tag">&lt;/<span class="name">h3</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail owner"</span>&gt;</span> </div><div class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>Owner:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.owner]]</div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail type"</span>&gt;</span>  </div><div class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>Type:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.type]]</div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail location"</span>&gt;</span>   </div><div class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>Location:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.city]]</div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail bedrooms"</span>&gt;</span>   </div><div class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>Number of bedrooms:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.bedrooms]]</div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">article</span>&gt;</span></div><div class="line">[[/each]]</div><div class="line">~</div></pre></td></tr></table></figure>
<h2 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h2><p>随着项目的创建，会在templates下自动生成一个application.js文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;h2&gt;title or slogin&lt;/h2&gt;</div><div class="line"></div><div class="line">[[outlet]]</div></pre></td></tr></table></figure></p>
<p>其中h2标题部分会在所有的模板中出现，[[outlet]]作为url中指定route handler的占位符。</p>
<h2 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h2><p>ember有自己的插件机制，可以自由发布与引用,个人感觉有点儿类似python module的感觉。</p>
<p><a href="https://emberobserver.com/" target="_blank" rel="external">https://emberobserver.com/</a></p>
<h2 id="Ember-data"><a href="#Ember-data" class="headerlink" title="Ember data"></a>Ember data</h2><p>使用ember g model rental生成模板文件models/rental.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Model <span class="keyword">from</span> <span class="string">'ember-data/model'</span>;</div><div class="line"><span class="keyword">import</span> attr <span class="keyword">from</span> <span class="string">'ember-data/attr'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> Model.extend(&#123;</div><div class="line">  <span class="attr">title</span>: attr(),</div><div class="line">  <span class="attr">owner</span>: attr(),</div><div class="line">  <span class="attr">city</span>: attr(),</div><div class="line">  <span class="attr">type</span>: attr(),</div><div class="line">  <span class="attr">image</span>: attr(),</div><div class="line">  <span class="attr">bedrooms</span>: attr()</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>上面就定义好了这个model的各个属性。下面是使用model了，在某个route handler中定义model函数，下面这个示例会使用GET方法调用/rentals<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Ember <span class="keyword">from</span> <span class="string">'ember'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> Ember.Route.extend(&#123;</div><div class="line">  model() &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.store.findAll(<span class="string">'rental'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>详情参考：<a href="https://guides.emberjs.com/v2.6.0/models/" target="_blank" rel="external">https://guides.emberjs.com/v2.6.0/models/</a></p>
<h2 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h2><p>就是component，可以被其他的template直接引用。它包含两部分：template和js。<br>template负责布局，js负责定义一些属性和action。</p>
<p>布局文件:templates/components/rental-listing.hbs<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">article</span> <span class="attr">class</span>=<span class="string">"listing"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">a</span> [[<span class="attr">action</span> '<span class="attr">toggleImageSize</span>']] <span class="attr">class</span>=<span class="string">"image [[if isWide "</span><span class="attr">wide</span>"]]"&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"[[rental.image]]"</span> <span class="attr">alt</span>=<span class="string">""</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">small</span>&gt;</span>View Larger<span class="tag">&lt;/<span class="name">small</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">h3</span>&gt;</span>[[rental.title]]<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail owner"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>Owner:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.owner]]</div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail type"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>Type:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.type]]</div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail location"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>Location:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.city]]</div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail bedrooms"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>Number of bedrooms:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.bedrooms]]</div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">article</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>交互文件：components/rental-listing.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Ember <span class="keyword">from</span> <span class="string">'ember'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> Ember.Component.extend(&#123;</div><div class="line">  <span class="attr">isWide</span>: <span class="literal">false</span>,</div><div class="line">  <span class="attr">actions</span>: &#123;</div><div class="line">    toggleImageSize() &#123;</div><div class="line">      <span class="keyword">this</span>.toggleProperty(<span class="string">'isWide'</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>可以看到isWide和actions属性与模板文件中的[[action ‘toggleImageSize’]]以及isWide变量对应。</p>
<h2 id="Handlebars-Helper"><a href="#Handlebars-Helper" class="headerlink" title="Handlebars Helper"></a>Handlebars Helper</h2><p>有的时候会在render到template之前对一些属性进行公共的处理啥的，就用到这个handlebar，为属性起装饰作用。<br>helpers/xxx.js文件：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Ember <span class="keyword">from</span> <span class="string">'ember'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> communityPropertyTypes = [</div><div class="line">  <span class="string">'Condo'</span>,</div><div class="line">  <span class="string">'Townhouse'</span>,</div><div class="line">  <span class="string">'Apartment'</span></div><div class="line">];</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">rentalPropertyType</span>(<span class="params">[type]<span class="regexp">/*, hash*/</span></span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (communityPropertyTypes.contains(type)) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">'Community'</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="string">'Standalone'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> Ember.Helper.helper(rentalPropertyType);</div></pre></td></tr></table></figure></p>
<p>在template文件中使用上面定义的rentalPropertyType方法。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span>Type:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental-property-type rental.type]] - [[rental.type]]</div></pre></td></tr></table></figure></p>
<p>这样在render模板的时候，就会把rental.type传入rentalPropertyType函数，处理后，返回相应的处理值。</p>
]]></content>
      
        
        <tags>
            
            <tag> ember </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[python debug]]></title>
      <url>/2016/06/23/python-debug/</url>
      <content type="html"><![CDATA[<p>今儿想着快些让hive view的java代码跟远程程序能够一起调试了，想要远程调试就得在远程ambari server启动的地方添加jdwp设置才行。</p>
<p>当我们安装好ambari-server之后，它默认是在/usr/sbin/ambari-server的一个shell文件，start命令导流到/usr/sbin/ambari-server.py脚本中。跟tomcat、jetty啥的不一样，并不提供静态的类似JAVA_OPTS之类的变量。ambari server是作为python脚本的子进程启动的，所以启动的参数都是通过python程序生成后执行的。自己沿着入口找了半天，越找越蒙圈，回头想了一下，还是debug来的更真实。</p>
<p>查下python的debug方式，最快能实施的就是使用<strong>pdb</strong>了。到ambari server的宿主机上开始进行调试。</p>
<h3 id="pdb基础"><a href="#pdb基础" class="headerlink" title="pdb基础"></a>pdb基础</h3><h5 id="设置断点"><a href="#设置断点" class="headerlink" title="设置断点"></a>设置断点</h5><p>在要调试的python文件import pdb，然后在断点代码的上方添加pdb.set_trace()<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> pdb</div><div class="line">....</div><div class="line"></div><div class="line">  options.exit_message = <span class="string">"Ambari Server '%s' completed successfully."</span> % action</div><div class="line">  options.exit_code = <span class="keyword">None</span></div><div class="line"></div><div class="line"></div><div class="line">  pdb.set_trace()</div><div class="line">  <span class="keyword">try</span>:</div><div class="line">    action_obj.execute()</div><div class="line"></div><div class="line">    <span class="keyword">if</span> action_obj.need_restart:</div><div class="line">      pstatus, pid = is_server_runing()</div><div class="line">      <span class="keyword">if</span> pstatus:</div><div class="line">        <span class="keyword">print</span> <span class="string">'NOTE: Restart Ambari Server to apply changes'</span> + \</div><div class="line">              <span class="string">' ("ambari-server restart|stop+start")'</span></div></pre></td></tr></table></figure></p>
<p>到命令行执行此python文件，到pdb.set_trace()的位置就会停下，跳出(pdb) </p>
<h5 id="pdb命令"><a href="#pdb命令" class="headerlink" title="pdb命令"></a>pdb命令</h5><table>
<thead>
<tr>
<th>命令</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>help</td>
<td>显示所有命令</td>
</tr>
<tr>
<td>n</td>
<td>继续执行</td>
</tr>
<tr>
<td>step</td>
<td>进入当前方法的方法块</td>
</tr>
<tr>
<td>c</td>
<td>忽略调试，继续执行</td>
</tr>
<tr>
<td>p</td>
<td>p str 打印某个对象</td>
</tr>
</tbody>
</table>
<p>我就用了以上命令，完成了对于ambari的调试。如果有其他的要求，可以逐个试一下。</p>
<h4 id="ambari调试过程"><a href="#ambari调试过程" class="headerlink" title="ambari调试过程"></a>ambari调试过程</h4><h5 id="设置断点-1"><a href="#设置断点-1" class="headerlink" title="设置断点"></a>设置断点</h5><p> 在ambari-server.py 引入pdb，在main方法上面添加pdb.set_trace()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">mainBody</span><span class="params">()</span>:</span></div><div class="line">  parser = optparse.OptionParser(usage=<span class="string">"usage: %prog [options] action [stack_id os]"</span>,)</div><div class="line">  init_parser_options(parser)</div><div class="line">  (options, args) = parser.parse_args()</div><div class="line"></div><div class="line">  pdb.set_trace()</div><div class="line"></div><div class="line">  <span class="comment"># check if only silent key set</span></div><div class="line">  default_options = parser.get_default_values()</div><div class="line">  silent_options = default_options</div><div class="line">  silent_options.silent = <span class="keyword">True</span></div><div class="line"></div><div class="line">  <span class="keyword">if</span> options == silent_options:</div><div class="line">    options.only_silent = <span class="keyword">True</span></div><div class="line">  <span class="keyword">else</span>:</div><div class="line">    options.only_silent = <span class="keyword">False</span></div><div class="line"></div><div class="line">  <span class="comment"># set verbose</span></div><div class="line">  set_verbose(options.verbose)</div><div class="line">  <span class="keyword">if</span> options.verbose:</div><div class="line">    main(options, args, parser)</div><div class="line"></div><div class="line">...</div></pre></td></tr></table></figure>
<h5 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h5><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div></pre></td><td class="code"><pre><div class="line">[root@data-test01 ~]# ambari-server start</div><div class="line">Using python  /usr/bin/python2</div><div class="line">Starting ambari-server</div><div class="line">&gt; /usr/sbin/ambari-server.py(584)main()</div><div class="line">-&gt; try:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(585)main()</div><div class="line">-&gt; action_obj.execute()</div><div class="line">(Pdb) step</div><div class="line">--Call--</div><div class="line">&gt; /usr/sbin/ambari-server.py(59)execute()</div><div class="line">-&gt; def execute(self):</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(60)execute()</div><div class="line">-&gt; self.fn(*self.args, **self.kwargs)</div><div class="line">(Pdb) p *self.args</div><div class="line">*** SyntaxError: SyntaxError('invalid syntax', ('&lt;string&gt;', 1, 1, '*self.args'))</div><div class="line">(Pdb) p self.args</div><div class="line">(&lt;Values at 0xfbee60: &#123;'only_silent': False, 'jdbc_driver': None, 'verbose': False, 'init_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-CREATE.sql', 'dbms': None, 'silent': False, 'warnings': [], 'exit_code': None, 'cluster_name': None, 'database_username': None, 'drop_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-DROP.sql', 'upgrade_script_file': '/var/lib/ambari-server/resources/upgrade/ddl/Ambari-DDL-Postgres-UPGRADE-1.3.0.sql', 'java_home': None, 'ldap_sync_existing': False, 'force_repo_version': False, 'debug': False, 'ldap_sync_groups': None, 'must_set_database_options': True, 'sqla_server_name': None, 'ldap_sync_users': None, 'database_name': None, 'jdbc_db': None, 'ldap_sync_all': False, 'upgrade_stack_script_file': '/var/lib/ambari-server/resources/upgrade/dml/Ambari-DML-Postgres-UPGRADE_STACK.sql', 'desired_repo_version': None, 'suspend_start': False, 'database_port': None, 'sid_or_sname': 'sname', 'database_password': None, 'exit_message': "Ambari Server 'start' completed successfully.", 'database_host': None, 'postgres_schema': None&#125;&gt;,)</div><div class="line">(Pdb) p self.kwargs</div><div class="line">&#123;&#125;</div><div class="line">(Pdb) step</div><div class="line">--Call--</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(82)thunk()</div><div class="line">-&gt; def thunk(*args, **kwargs):</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(83)thunk()</div><div class="line">-&gt; fn_id_base = func.__module__ + "." + func.__name__</div><div class="line">(Pdb) jn</div><div class="line">*** NameError: name 'jn' is not defined</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(84)thunk()</div><div class="line">-&gt; fn_id = fn_id_base + "." + OSCheck.get_os_family()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(85)thunk()</div><div class="line">-&gt; if fn_id not in self._func_impls:</div><div class="line">(Pdb) p fn_id</div><div class="line">'__main__.start.redhat'</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(86)thunk()</div><div class="line">-&gt; fn_id = fn_id_base + "." + OsFamilyImpl.DEFAULT</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(88)thunk()</div><div class="line">-&gt; fn = self._func_impls[fn_id]</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(89)thunk()</div><div class="line">-&gt; return fn(*args, **kwargs)</div><div class="line">(Pdb) p args</div><div class="line">(&lt;Values at 0xfbee60: &#123;'only_silent': False, 'jdbc_driver': None, 'verbose': False, 'init_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-CREATE.sql', 'dbms': None, 'silent': False, 'warnings': [], 'exit_code': None, 'cluster_name': None, 'database_username': None, 'drop_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-DROP.sql', 'upgrade_script_file': '/var/lib/ambari-server/resources/upgrade/ddl/Ambari-DDL-Postgres-UPGRADE-1.3.0.sql', 'java_home': None, 'ldap_sync_existing': False, 'force_repo_version': False, 'debug': False, 'ldap_sync_groups': None, 'must_set_database_options': True, 'sqla_server_name': None, 'ldap_sync_users': None, 'database_name': None, 'jdbc_db': None, 'ldap_sync_all': False, 'upgrade_stack_script_file': '/var/lib/ambari-server/resources/upgrade/dml/Ambari-DML-Postgres-UPGRADE_STACK.sql', 'desired_repo_version': None, 'suspend_start': False, 'database_port': None, 'sid_or_sname': 'sname', 'database_password': None, 'exit_message': "Ambari Server 'start' completed successfully.", 'database_host': None, 'postgres_schema': None&#125;&gt;,)</div><div class="line">(Pdb) p kwargs</div><div class="line">&#123;&#125;</div><div class="line">(Pdb) step</div><div class="line">--Call--</div><div class="line">&gt; /usr/sbin/ambari-server.py(103)start()</div><div class="line">-&gt; @OsFamilyFuncImpl(OsFamilyImpl.DEFAULT)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(105)start()</div><div class="line">-&gt; status, pid = is_server_runing()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(106)start()</div><div class="line">-&gt; if status:</div><div class="line">(Pdb) p status</div><div class="line">False</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(110)start()</div><div class="line">-&gt; server_process_main(args)</div><div class="line">(Pdb) p args</div><div class="line">&lt;Values at 0xfbee60: &#123;'only_silent': False, 'jdbc_driver': None, 'verbose': False, 'init_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-CREATE.sql', 'dbms': None, 'silent': False, 'warnings': [], 'exit_code': None, 'cluster_name': None, 'database_username': None, 'drop_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-DROP.sql', 'upgrade_script_file': '/var/lib/ambari-server/resources/upgrade/ddl/Ambari-DDL-Postgres-UPGRADE-1.3.0.sql', 'java_home': None, 'ldap_sync_existing': False, 'force_repo_version': False, 'debug': False, 'ldap_sync_groups': None, 'must_set_database_options': True, 'sqla_server_name': None, 'ldap_sync_users': None, 'database_name': None, 'jdbc_db': None, 'ldap_sync_all': False, 'upgrade_stack_script_file': '/var/lib/ambari-server/resources/upgrade/dml/Ambari-DML-Postgres-UPGRADE_STACK.sql', 'desired_repo_version': None, 'suspend_start': False, 'database_port': None, 'sid_or_sname': 'sname', 'database_password': None, 'exit_message': "Ambari Server 'start' completed successfully.", 'database_host': None, 'postgres_schema': None&#125;&gt;</div><div class="line">(Pdb) step</div><div class="line">--Call--</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(204)server_process_main()</div><div class="line">-&gt; def server_process_main(options, scmStatus=None):</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(206)server_process_main()</div><div class="line">-&gt; try:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(207)server_process_main()</div><div class="line">-&gt; set_debug_mode_from_options(options)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(211)server_process_main()</div><div class="line">-&gt; if not check_reverse_lookup():</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(216)server_process_main()</div><div class="line">-&gt; check_database_name_property()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(217)server_process_main()</div><div class="line">-&gt; parse_properties_file(options)</div><div class="line">(Pdb) p options</div><div class="line">&lt;Values at 0xfbee60: &#123;'only_silent': False, 'jdbc_driver': None, 'verbose': False, 'init_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-CREATE.sql', 'dbms': None, 'silent': False, 'warnings': [], 'exit_code': None, 'cluster_name': None, 'database_username': None, 'drop_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-DROP.sql', 'upgrade_script_file': '/var/lib/ambari-server/resources/upgrade/ddl/Ambari-DDL-Postgres-UPGRADE-1.3.0.sql', 'java_home': None, 'ldap_sync_existing': False, 'force_repo_version': False, 'debug': False, 'ldap_sync_groups': None, 'must_set_database_options': True, 'sqla_server_name': None, 'ldap_sync_users': None, 'database_name': None, 'jdbc_db': None, 'ldap_sync_all': False, 'upgrade_stack_script_file': '/var/lib/ambari-server/resources/upgrade/dml/Ambari-DML-Postgres-UPGRADE_STACK.sql', 'desired_repo_version': None, 'suspend_start': False, 'database_port': None, 'sid_or_sname': 'sname', 'database_password': None, 'exit_message': "Ambari Server 'start' completed successfully.", 'database_host': None, 'postgres_schema': None&#125;&gt;</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(219)server_process_main()</div><div class="line">-&gt; ambari_user = read_ambari_user()</div><div class="line">(Pdb) step</div><div class="line">--Call--</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverConfiguration.py(501)read_ambari_user()</div><div class="line">-&gt; def read_ambari_user():</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverConfiguration.py(505)read_ambari_user()</div><div class="line">-&gt; properties = get_ambari_properties()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverConfiguration.py(506)read_ambari_user()</div><div class="line">-&gt; if properties != -1:</div><div class="line">(Pdb) p properties</div><div class="line">&lt;ambari_server.properties.Properties object at 0xfe4910&gt;</div><div class="line">(Pdb) dir(properties)</div><div class="line">['_Properties__parse', '__class__', '__delattr__', '__dict__', '__doc__', '__format__', '__getattr__', '__getattribute__', '__getitem__', '__hash__', '__init__', '__module__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', '__weakref__', '_keymap', '_origprops', '_props', 'bspacere', 'fileName', 'getPropertyDict', 'get_property', 'load', 'othercharre', 'othercharre2', 'process_pair', 'propertyNames', 'removeOldProp', 'removeProp', 'sort_origprops', 'sort_props', 'store', 'store_ordered', 'unescape']</div><div class="line">(Pdb) type(properties)</div><div class="line">&lt;class 'ambari_server.properties.Properties'&gt;</div><div class="line">(Pdb) p properties fileName</div><div class="line">*** SyntaxError: SyntaxError('unexpected EOF while parsing', ('&lt;string&gt;', 1, 19, 'properties fileName'))</div><div class="line">(Pdb) p properties.fileName()</div><div class="line">*** TypeError: TypeError("'str' object is not callable",)</div><div class="line">(Pdb) p properties.fileName</div><div class="line">'/etc/ambari-server/conf/ambari.properties'</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverConfiguration.py(507)read_ambari_user()</div><div class="line">-&gt; user = properties[NR_USER_PROPERTY]</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverConfiguration.py(508)read_ambari_user()</div><div class="line">-&gt; if user:</div><div class="line">(Pdb) p user</div><div class="line">'root'</div><div class="line">(Pdb) p</div><div class="line">*** SyntaxError: SyntaxError('unexpected EOF while parsing', ('&lt;string&gt;', 0, 0, ''))</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverConfiguration.py(509)read_ambari_user()</div><div class="line">-&gt; return user</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverConfiguration.py(509)read_ambari_user()-&gt;'root'</div><div class="line">-&gt; return user</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(220)server_process_main()</div><div class="line">-&gt; current_user = ensure_can_start_under_current_user(ambari_user)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(222)server_process_main()</div><div class="line">-&gt; print_info_msg("Ambari Server is not running...")</div><div class="line">(Pdb) p current_user</div><div class="line">'root'</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(224)server_process_main()</div><div class="line">-&gt; jdk_path = find_jdk()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(225)server_process_main()</div><div class="line">-&gt; if jdk_path is None:</div><div class="line">(Pdb) p jdk_path</div><div class="line">'/server/java/jdk1.8.0_60'</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(231)server_process_main()</div><div class="line">-&gt; properties = get_ambari_properties()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(234)server_process_main()</div><div class="line">-&gt; if is_root():</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(235)server_process_main()</div><div class="line">-&gt; print configDefaults.MESSAGE_SERVER_RUNNING_AS_ROOT</div><div class="line">(Pdb) print configDefaults.MESSAGE_SERVER_RUNNING_AS_ROOT</div><div class="line">Ambari Server running with administrator privileges.</div><div class="line">(Pdb) n</div><div class="line">Ambari Server running with administrator privileges.</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(237)server_process_main()</div><div class="line">-&gt; ensure_jdbc_driver_is_installed(options, properties)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(239)server_process_main()</div><div class="line">-&gt; ensure_dbms_is_running(options, properties, scmStatus)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(241)server_process_main()</div><div class="line">-&gt; if scmStatus is not None:</div><div class="line">(Pdb) p scmStatus</div><div class="line">None</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(244)server_process_main()</div><div class="line">-&gt; refresh_stack_hash(properties)</div><div class="line">(Pdb) p properties</div><div class="line">&lt;ambari_server.properties.Properties object at 0xfe4e50&gt;</div><div class="line">(Pdb) step</div><div class="line">--Call--</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(85)refresh_stack_hash()</div><div class="line">-&gt; def refresh_stack_hash(properties):</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(86)refresh_stack_hash()</div><div class="line">-&gt; resources_location = get_resources_location(properties)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(87)refresh_stack_hash()</div><div class="line">-&gt; stacks_location = get_stack_location(properties)</div><div class="line">(Pdb) p resources_location</div><div class="line">'/var/lib/ambari-server/resources'</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(88)refresh_stack_hash()</div><div class="line">-&gt; resource_files_keeper = ResourceFilesKeeper(resources_location, stacks_location)</div><div class="line">(Pdb) p stacks_location</div><div class="line">'/var/lib/ambari-server/resources/stacks'</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(90)refresh_stack_hash()</div><div class="line">-&gt; try:</div><div class="line">(Pdb) p resource_files_keeper</div><div class="line">&lt;ambari_server.resourceFilesKeeper.ResourceFilesKeeper instance at 0x103c050&gt;</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(91)refresh_stack_hash()</div><div class="line">-&gt; print "Organizing resource files at &#123;0&#125;...".format(resources_location,</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(92)refresh_stack_hash()</div><div class="line">-&gt; verbose=get_verbose())</div><div class="line">(Pdb) n</div><div class="line">Organizing resource files at /var/lib/ambari-server/resources...</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(93)refresh_stack_hash()</div><div class="line">-&gt; resource_files_keeper.perform_housekeeping()</div><div class="line">(Pdb) p verbose</div><div class="line">*** NameError: NameError("name 'verbose' is not defined",)</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(93)refresh_stack_hash()-&gt;None</div><div class="line">-&gt; resource_files_keeper.perform_housekeeping()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(246)server_process_main()</div><div class="line">-&gt; if scmStatus is not None:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(249)server_process_main()</div><div class="line">-&gt; ensure_server_security_is_configured()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(251)server_process_main()</div><div class="line">-&gt; if scmStatus is not None:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(254)server_process_main()</div><div class="line">-&gt; java_exe = get_java_exe_path()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(256)server_process_main()</div><div class="line">-&gt; serverClassPath = ServerClassPath(properties, options)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(258)server_process_main()</div><div class="line">-&gt; debug_mode = get_debug_mode()</div><div class="line">(Pdb) p serverClassPath</div><div class="line">&lt;ambari_server.serverClassPath.ServerClassPath instance at 0x103cfc8&gt;</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(259)server_process_main()</div><div class="line">-&gt; debug_start = (debug_mode &amp; 1) or SERVER_START_DEBUG</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(260)server_process_main()</div><div class="line">-&gt; suspend_start = (debug_mode &amp; 2) or SUSPEND_START_MODE</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(261)server_process_main()</div><div class="line">-&gt; suspend_mode = 'y' if suspend_start else 'n'</div><div class="line">(Pdb) p debug_start</div><div class="line">False</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(263)server_process_main()</div><div class="line">-&gt; param_list = generate_child_process_param_list(ambari_user, java_exe,</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(264)server_process_main()</div><div class="line">-&gt; serverClassPath.get_full_ambari_classpath_escaped_for_shell(), debug_start,</div><div class="line">(Pdb) p param_list</div><div class="line">*** NameError: NameError("name 'param_list' is not defined",)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(265)server_process_main()</div><div class="line">-&gt; suspend_mode)</div><div class="line">(Pdb) p param_list</div><div class="line">*** NameError: NameError("name 'param_list' is not defined",)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(266)server_process_main()</div><div class="line">-&gt; environ = generate_env(options, ambari_user, current_user)</div><div class="line">(Pdb) p param_list</div><div class="line">['/bin/sh', '-c', "ulimit -n 10000 ; /server/java/jdk1.8.0_60/bin/java -server -XX:NewRatio=3 -XX:+UseConcMarkSweepGC -XX:-UseGCOverheadLimit -XX:CMSInitiatingOccupancyFraction=60 -Dsun.zip.disableMemoryMapping=true   -Xms512m -Xmx2048m -Djava.security.auth.login.config=/etc/ambari-server/conf/krb5JAASLogin.conf -Djava.security.krb5.conf=/etc/krb5.conf -Djavax.security.auth.useSubjectCredsOnly=false -cp '/etc/ambari-server/conf:/usr/lib/ambari-server/*:/usr/share/java/mysql-connector-java.jar' org.apache.ambari.server.controller.AmbariServer &gt; /var/log/ambari-server/ambari-server.out 2&gt;&amp;1 || echo $? &gt; /var/run/ambari-server/ambari-server.exitcode &amp;"]</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(268)server_process_main()</div><div class="line">-&gt; if not os.path.exists(configDefaults.PID_DIR):</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(271)server_process_main()</div><div class="line">-&gt; print_info_msg("Running server: " + str(param_list))</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(272)server_process_main()</div><div class="line">-&gt; procJava = subprocess.Popen(param_list, env=environ)</div><div class="line">(Pdb) p str(param_list)</div><div class="line">'[\'/bin/sh\', \'-c\', "ulimit -n 10000 ; /server/java/jdk1.8.0_60/bin/java -server -XX:NewRatio=3 -XX:+UseConcMarkSweepGC -XX:-UseGCOverheadLimit -XX:CMSInitiatingOccupancyFraction=60 -Dsun.zip.disableMemoryMapping=true   -Xms512m -Xmx2048m -Djava.security.auth.login.config=/etc/ambari-server/conf/krb5JAASLogin.conf -Djava.security.krb5.conf=/etc/krb5.conf -Djavax.security.auth.useSubjectCredsOnly=false -cp \'/etc/ambari-server/conf:/usr/lib/ambari-server/*:/usr/share/java/mysql-connector-java.jar\' org.apache.ambari.server.controller.AmbariServer &gt; /var/log/ambari-server/ambari-server.out 2&gt;&amp;1 || echo $? &gt; /var/run/ambari-server/ambari-server.exitcode &amp;"]'</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(274)server_process_main()</div><div class="line">-&gt; pidJava = procJava.pid</div><div class="line">(Pdb) p procJava.pid</div><div class="line">2216</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(275)server_process_main()</div><div class="line">-&gt; if pidJava &lt;= 0:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(288)server_process_main()</div><div class="line">-&gt; try:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(289)server_process_main()</div><div class="line">-&gt; os.setpgid(pidJava, 0)</div><div class="line">(Pdb) n</div><div class="line">OSError: (13, 'Permission denied')</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(289)server_process_main()</div><div class="line">-&gt; os.setpgid(pidJava, 0)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(290)server_process_main()</div><div class="line">-&gt; except OSError, e:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(291)server_process_main()</div><div class="line">-&gt; print_warning_msg('setpgid(&#123;0&#125;, 0) failed - &#123;1&#125;'.format(pidJava, str(e)))</div><div class="line">(Pdb) n</div><div class="line">WARNING: setpgid(2216, 0) failed - [Errno 13] Permission denied</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(292)server_process_main()</div><div class="line">-&gt; pass</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(293)server_process_main()</div><div class="line">-&gt; pidfile = os.path.join(configDefaults.PID_DIR, PID_NAME)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(294)server_process_main()</div><div class="line">-&gt; save_pid(pidJava, pidfile)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(295)server_process_main()</div><div class="line">-&gt; print "Server PID at: "+pidfile</div><div class="line">(Pdb) n</div><div class="line">Server PID at: /var/run/ambari-server/ambari-server.pid</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(296)server_process_main()</div><div class="line">-&gt; print "Server out at: "+configDefaults.SERVER_OUT_FILE</div><div class="line">(Pdb) n</div><div class="line">Server out at: /var/log/ambari-server/ambari-server.out</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(297)server_process_main()</div><div class="line">-&gt; print "Server log at: "+configDefaults.SERVER_LOG_FILE</div><div class="line">(Pdb) n</div><div class="line">Server log at: /var/log/ambari-server/ambari-server.log</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(299)server_process_main()</div><div class="line">-&gt; wait_for_server_start(pidfile, scmStatus)</div><div class="line">(Pdb) n</div><div class="line">Waiting for server start....................</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(301)server_process_main()</div><div class="line">-&gt; if scmStatus is not None:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(304)server_process_main()</div><div class="line">-&gt; return procJava</div><div class="line">(Pdb) p procJava</div><div class="line">&lt;subprocess.Popen object at 0x1038690&gt;</div><div class="line">(Pdb) dir(procJava)</div><div class="line">['__class__', '__del__', '__delattr__', '__dict__', '__doc__', '__format__', '__getattribute__', '__hash__', '__init__', '__module__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', '__weakref__', '_check_timeout', '_child_created', '_close_fds', '_communicate', '_communicate_with_poll', '_communicate_with_select', '_communication_started', '_execute_child', '_get_handles', '_handle_exitstatus', '_input', '_internal_poll', '_remaining_time', '_set_cloexec_flag', '_translate_newlines', 'communicate', 'kill', 'pid', 'poll', 'returncode', 'send_signal', 'stderr', 'stdin', 'stdout', 'terminate', 'universal_newlines', 'wait']</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(304)server_process_main()-&gt;&lt;subproc...x1038690&gt;</div><div class="line">-&gt; return procJava</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/sbin/ambari-server.py(110)start()-&gt;None</div><div class="line">-&gt; server_process_main(args)</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(89)thunk()-&gt;None</div><div class="line">-&gt; return fn(*args, **kwargs)</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/sbin/ambari-server.py(60)execute()-&gt;None</div><div class="line">-&gt; self.fn(*self.args, **self.kwargs)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(587)main()</div><div class="line">-&gt; if action_obj.need_restart:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(593)main()</div><div class="line">-&gt; if options.warnings:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(608)main()</div><div class="line">-&gt; if options.exit_message is not None:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(609)main()</div><div class="line">-&gt; print options.exit_message</div><div class="line">(Pdb) n</div><div class="line">Ambari Server 'start' completed successfully.</div><div class="line">&gt; /usr/sbin/ambari-server.py(611)main()</div><div class="line">-&gt; if options.exit_code is not None:  # not all actions may return a system exit code</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/sbin/ambari-server.py(611)main()-&gt;None</div><div class="line">-&gt; if options.exit_code is not None:  # not all actions may return a system exit code</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/sbin/ambari-server.py(635)mainBody()-&gt;None</div><div class="line">-&gt; main(options, args, parser)</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/sbin/ambari-server.py(644)&lt;module&gt;()-&gt;None</div><div class="line">-&gt; mainBody()</div><div class="line">(Pdb) n</div><div class="line">[root@data-test01 ~]# which ambari-server</div><div class="line">/usr/sbin/ambari-server</div><div class="line">[root@data-test01 ~]# vim /usr/sbin/ambari-server.py </div><div class="line">[root@data-test01 ~]#</div></pre></td></tr></table></figure>
<p>从以上debug堆栈中我们可以看到ambari-server启动过程中python脚本的所有准备工作。其中java进程的参数主要在ambari_server_main.py的server_process_main()的param_list中。</p>
<p>那么param_list来源在哪儿呢？ 是在server_process_main的子方法generate_child_process_param_list()中的command_base变量，SERVER_START_CMD_DEBUG或者SERVER_START_CMD的形式如下。</p>
<blockquote>
<p>{0} -server -XX:NewRatio=3 -XX:+UseConcMarkSweepGC -XX:-UseGCOverheadLimit -XX:CMSInitiatingOccupancyFraction=60 -Dsun.zip.disableMemoryMapping=true {1} {2} -cp {3} org.apache.ambari.server.controller.AmbariServer &gt; {4} 2&gt;&amp;1 || echo $? &gt; {5} &amp; </p>
</blockquote>
<p>可以看到留下了很多占位符。还是看一下generate_child_process_param_list的code吧<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@FamilyFuncImpl(OsFamilyImpl.DEFAULT)                                          </span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_child_process_param_list</span><span class="params">(ambari_user, java_exe, class_path,         </span></span></div><div class="line">                                      debug_start, suspend_mode):                </div><div class="line">  <span class="keyword">from</span> ambari_commons.os_linux <span class="keyword">import</span> ULIMIT_CMD                                 </div><div class="line">                                                                                 </div><div class="line">  properties = get_ambari_properties()                                           </div><div class="line">                                                                                 </div><div class="line">  command_base = SERVER_START_CMD_DEBUG <span class="keyword">if</span> debug_start <span class="keyword">else</span> SERVER_START_CMD     </div><div class="line">                                                                                 </div><div class="line">  ulimit_cmd = <span class="string">"%s %s"</span> % (ULIMIT_CMD, str(get_ulimit_open_files(properties)))    </div><div class="line">  command = command_base.format(java_exe,                                        </div><div class="line">          ambari_provider_module_option,                                         </div><div class="line">          jvm_args,                                                              </div><div class="line">          class_path,                                                            </div><div class="line">          configDefaults.SERVER_OUT_FILE,                                        </div><div class="line">          os.path.join(configDefaults.PID_DIR, EXITCODE_NAME),                   </div><div class="line">          suspend_mode)                                                          </div><div class="line">                                                                                 </div><div class="line">  <span class="comment"># required to start properly server instance                                   </span></div><div class="line">  os.chdir(configDefaults.ROOT_FS_PATH)                                          </div><div class="line">                                                                                 </div><div class="line">  <span class="comment">#For properly daemonization server should be started using shell as parent     </span></div><div class="line">  param_list = [locate_file(<span class="string">'sh'</span>, <span class="string">'/bin'</span>), <span class="string">"-c"</span>]                                 </div><div class="line">  <span class="keyword">if</span> is_root() <span class="keyword">and</span> ambari_user != <span class="string">"root"</span>:                                        </div><div class="line">    <span class="comment"># To inherit exported environment variables (especially AMBARI_PASSPHRASE),  </span></div><div class="line">    <span class="comment"># from subprocess, we have to skip --login option of su command. That's why  </span></div><div class="line">    <span class="comment"># we change dir to / (otherwise subprocess can face with 'permission denied' </span></div><div class="line">    <span class="comment"># errors while trying to list current directory                              </span></div><div class="line">    cmd = <span class="string">"&#123;ulimit_cmd&#125; ; &#123;su&#125; &#123;ambari_user&#125; -s &#123;sh_shell&#125; -c '&#123;command&#125;'"</span>.format(ulimit_cmd=ulimit_cmd, </div><div class="line">                                                                                su=locate_file(<span class="string">'su'</span>, <span class="string">'/bin'</span>), ambari_user=ambari_user,</div><div class="line">                                                                                sh_shell=locate_file(<span class="string">'sh'</span>, <span class="string">'/bin'</span>), command=command)</div><div class="line">  <span class="keyword">else</span>:                                                                          </div><div class="line">    cmd = <span class="string">"&#123;ulimit_cmd&#125; ; &#123;command&#125;"</span>.format(ulimit_cmd=ulimit_cmd, command=command)</div><div class="line">                                                                                 </div><div class="line">  param_list.append(cmd)                                                         </div><div class="line">  <span class="keyword">return</span> param_list</div></pre></td></tr></table></figure></p>
<p>这个方法把java进程的相关的东西全部拼进cmd，之后放进param_list，其中放了一个jvm_args的参数就是jvm参数了。在当前python文件中追溯此数据的来源：jvm_args = os.getenv(‘AMBARI_JVM_ARGS’, ‘-Xms512m -Xmx2048m’) ，所以它是一个环境变量。依赖eclipse的索引，搜一下哪个脚本里设置了这个环境变量：ambari-env.sh。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.ibm.com/developerworks/cn/linux/l-cn-pythondebugger/" target="_blank" rel="external">http://www.ibm.com/developerworks/cn/linux/l-cn-pythondebugger/</a></p>
]]></content>
      
        
        <tags>
            
            <tag> python </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ambari-views中文翻译]]></title>
      <url>/2016/06/20/ambari-view%E4%B8%AD%E6%96%87%E7%BF%BB%E8%AF%91/</url>
      <content type="html"><![CDATA[<h2 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h2><p>ambari views可以在ambari-web中提供插件定制化的可视化、管理、监控等特性。</p>
<p>当用户添加了一个第三方的插件到ambari的时候，我们可以添加一个view来支持这个插件的UI，也就是说可以发布一个应用到ambari container里来。</p>
<p>每个view实例使用name和version来在ambari container里唯一标识自己。</p>
<p>Views in Ambari 是顶级的resource，并不直接跟cluster实例产生直接关联。</p>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p>官网的例子在ambari-views/examples.</p>
<h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><h3 id="View-Instances"><a href="#View-Instances" class="headerlink" title="View Instances"></a>View Instances</h3><p>一个view可以有多个实例，每个实例可能有各自不同的属性。</p>
<h3 id="View-Context"><a href="#View-Context" class="headerlink" title="View Context"></a>View Context</h3><p>view context让view componenets访问ambari container提供的运行时context。这个context会一直伴随这view实例，从出生到死亡。</p>
<p>一个view context可能会被container注入到多个不同的view componenet里去，比如resources, resource provider, servlets等。</p>
<p>context接口提供给view instance以下信息:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the current user name.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the current user name</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Determine whether or not the access specified by the given permission name</div><div class="line"> * is permitted for the given user.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> userName        the user name</div><div class="line"> * <span class="doctag">@param</span> permissionName  the permission name</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> SecurityException if the access specified by the given permission name</div><div class="line"> *         is not permitted</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hasPermission</span><span class="params">(String userName, String permissionName)</span> <span class="keyword">throws</span> SecurityException</span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the view name.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view name</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getViewName</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the view definition associated with this context.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view definition</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> ViewDefinition <span class="title">getViewDefinition</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the view instance name.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view instance name; null if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getInstanceName</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the view instance definition associated with this context.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view instance definition; null if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> ViewInstanceDefinition <span class="title">getViewInstanceDefinition</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the property values specified to create the view instance.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view instance property values; null if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">getProperties</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Save an instance data value for the given key.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key    the key</div><div class="line"> * <span class="doctag">@param</span> value  the value</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> IllegalStateException if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putInstanceData</span><span class="params">(String key, String value)</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the instance data value for the given key.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key  the key</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the instance data value; null if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getInstanceData</span><span class="params">(String key)</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the instance data values.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view instance property values; null if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">getInstanceData</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Remove the instance data value for the given key.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key  the key</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> IllegalStateException if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeInstanceData</span><span class="params">(String key)</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get a property for the given key from the ambari configuration.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key  the property key</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the property value; null indicates that the configuration contains no mapping for the key</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getAmbariProperty</span><span class="params">(String key)</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the view resource provider for the given resource type.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> type  the resource type</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the resource provider; null if no instance is associated</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> ResourceProvider&lt;?&gt; getResourceProvider(String type);</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get a URL stream provider.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> a stream provider</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> URLStreamProvider <span class="title">getURLStreamProvider</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get a data store for view persistence entities.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> a data store; null if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> DataStore <span class="title">getDataStore</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get all of the available view definitions.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view definitions</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;ViewDefinition&gt; <span class="title">getViewDefinitions</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get all of the available view instance definitions.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view instance definitions</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;ViewInstanceDefinition&gt; <span class="title">getViewInstanceDefinitions</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get a view controller associated with this context.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view controller</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> ViewController <span class="title">getController</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the HTTP Impersonator.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the HTTP Impersonator, which internally uses the App Cookie Manager</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> HttpImpersonator <span class="title">getHttpImpersonator</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the default settings for the Impersonator.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the Impersonator settings.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> ImpersonatorSetting <span class="title">getImpersonatorSetting</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure></p>
<h3 id="UI-Components"><a href="#UI-Components" class="headerlink" title="UI Components"></a>UI Components</h3><p>view包里可能包含一些web应用的组件，类似html或者javascript啥的。</p>
<h5 id="WEB-INF-web-xml"><a href="#WEB-INF-web-xml" class="headerlink" title="WEB-INF/web.xml"></a>WEB-INF/web.xml</h5><p>web.xml 是把view发布为一个web app的主要文件。  </p>
<p>例如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>HelloServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.apache.ambari.view.hello.HelloServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>HelloServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/ui<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></div></pre></td></tr></table></figure>
<h5 id="Servlets"><a href="#Servlets" class="headerlink" title="Servlets"></a>Servlets</h5><p>Servlets contained in a view archive will be deployed as part of the view and mapped as described in the web.xml.</p>
<p>在servlet的init方法中，可以view context当做一个servlet context使用。</p>
<p>例如:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">private</span> ViewContext viewContext;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig config)</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line">  <span class="keyword">super</span>.init(config);</div><div class="line"></div><div class="line">  ServletContext context = config.getServletContext();</div><div class="line">  viewContext = (ViewContext) context.getAttribute(ViewContext.CONTEXT_ATTRIBUTE);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>servlet可以使用view conetxt获取ambari container提供的一个信息。例如，在doGet()方法中，我们就可以使用view context instance访问当前的用户和view instance的属性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  response.setContentType(<span class="string">"text/html"</span>);</div><div class="line">  response.setStatus(HttpServletResponse.SC_OK);</div><div class="line"></div><div class="line">  PrintWriter writer = response.getWriter();</div><div class="line"></div><div class="line">  Map&lt;String, String&gt; properties = viewContext.getProperties();</div><div class="line"></div><div class="line">  String name = properties.get(<span class="string">"name"</span>);</div><div class="line">  <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</div><div class="line">    name = viewContext.getUsername();</div><div class="line">  &#125;</div><div class="line">  writer.println(<span class="string">"&lt;h1&gt;Hello "</span> + name + <span class="string">"!&lt;/h1&gt;"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h3><p>Resources一般不会暴露出来。resource都定义在view.xml里面。每个resource都需要指定名称和service class.</p>
<p>每个resource endpoint应该也可以被ambari api访问. <a href="#api">API</a>.</p>
<h5 id="Service-Class"><a href="#Service-Class" class="headerlink" title="Service Class"></a>Service Class</h5><p>service类使用JAX-RS注解来定义resource的endpoint。注意需要注入ViewContext.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Inject</span></div><div class="line">ViewContext context;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@see</span> org.apache.ambari.view.filebrowser.DownloadService</div><div class="line"> * <span class="doctag">@return</span> service</div><div class="line"> */</div><div class="line"><span class="meta">@Path</span>(<span class="string">"/download"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> DownloadService <span class="title">download</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> DownloadService(context);</div><div class="line">&#125;  </div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@see</span> org.apache.ambari.view.filebrowser.FileOperationService</div><div class="line"> * <span class="doctag">@return</span> service</div><div class="line"> */</div><div class="line"><span class="meta">@Path</span>(<span class="string">"/fileops"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> FileOperationService <span class="title">fileOps</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> FileOperationService(context);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Managed-Resources"><a href="#Managed-Resources" class="headerlink" title="Managed Resources"></a>Managed Resources</h4><p>managed resource是由ambari api框架管理的resource。除了name和service class之外，managed resource定义还需要plural name，resource class和provider class。 See <a href="#viewxml">view.xml</a>.</p>
<p>使用managed resource的好处是任何通过rest api访问的查询都可以使用ambari api框架的一些既有的特性，包括partial response, query predicates, pagination, sub-resource queries等。See <a href="#API">API</a>.</p>
<h5 id="Service-Class-1"><a href="#Service-Class-1" class="headerlink" title="Service Class"></a>Service Class</h5><p>service使用JAX-RS注解定义获取resource的action。</p>
<p>下面的例子展示了service class怎样将request代理给api框架处理。注意要注入ViewResourceHandler，我们使用它在api框架中传递control。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Inject</span></div><div class="line">ViewResourceHandler resourceHandler;</div><div class="line"></div><div class="line">…</div><div class="line"><span class="meta">@GET</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"&#123;scriptId&#125;"</span>)</div><div class="line"><span class="meta">@Produces</span>(MediaType.APPLICATION_JSON)</div><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">getScript</span><span class="params">(@Context HttpHeaders headers, @Context UriInfo ui,</span></span></div><div class="line">                          @PathParam(<span class="string">"scriptId"</span>) String scriptId) &#123;</div><div class="line">  <span class="keyword">return</span> resourceHandler.handleRequest(headers, ui, scriptId);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="Resource-Class"><a href="#Resource-Class" class="headerlink" title="Resource Class"></a>Resource Class</h5><p>resource class是一个包含属性和resource的JavaBean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PigScript</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> String id;</div><div class="line">  <span class="keyword">private</span> String title;</div><div class="line">  <span class="keyword">private</span> String pigScript;</div><div class="line">  <span class="keyword">private</span> String pythonScript;</div><div class="line">  <span class="keyword">private</span> String templetonArguments;</div><div class="line">  <span class="keyword">private</span> Date dateCreated;</div><div class="line">  <span class="keyword">private</span> String owner;</div><div class="line">  … </div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> id;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.id = id;</div><div class="line">  &#125;</div><div class="line">  …  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="Resource-Provider-Class"><a href="#Resource-Provider-Class" class="headerlink" title="Resource Provider Class"></a>Resource Provider Class</h5><p>Resource provider class实现ResourceProvider接口. 给ambari api框架提供访问resource的方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScriptResourceProvider</span> <span class="keyword">implements</span> <span class="title">ResourceProvider</span>&lt;<span class="title">PigScript</span>&gt; </span>&#123;</div><div class="line">  <span class="meta">@Inject</span></div><div class="line">  ViewContext viewContext;</div><div class="line"></div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> FileResource <span class="title">getResource</span><span class="params">(String resourceId, Set&lt;String&gt; propertyIds)</span> <span class="keyword">throws</span></span></div><div class="line">      SystemException, NoSuchResourceException, UnsupportedPropertyException &#123;</div><div class="line"></div><div class="line">    Map&lt;String, String&gt; properties = viewContext.getProperties();</div><div class="line"></div><div class="line">    String userScriptsPath = properties.get(<span class="string">"dataworker.userScriptsPath"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">return</span> getResource(resourceId, userScriptsPath, propertyIds);</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(<span class="string">"Can't get resource "</span> + resourceId + <span class="string">"."</span>, e);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  ... </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h3><p>administrator可以在任何view实例上设置VIEW.USE权限。  See <a href="#api">API</a>.</p>
<h3 id="定制权限"><a href="#定制权限" class="headerlink" title="定制权限"></a>定制权限</h3><p>编辑 view.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>RESTRICTED<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">label</span>&gt;</span>The Restricted View<span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>restricted<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">service-class</span>&gt;</span>org.apache.ambari.view.restricted.RestrictedResource<span class="tag">&lt;/<span class="name">service-class</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>unrestricted<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">service-class</span>&gt;</span>org.apache.ambari.view.restricted.UnrestrictedResource<span class="tag">&lt;/<span class="name">service-class</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">permission</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>RESTRICTED<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span></div><div class="line">      Access permission for a restricted view resource.</div><div class="line">    <span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">permission</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">instance</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>INSTANCE_1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">instance</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这个配置文件定义了一个叫做RESTRICTED的view，它有一个实例. 还定义了一个叫做RESTRICTED的权限，两个分别叫做 ‘unrestricted’和 ‘restricted’的resource.<br>administrator可以将RESTRICTED权限分配给任意的RESTRICTED view的实例。</p>
<p>view的实现代码使用了view context来验证我们定义的权限。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Inject</span></div><div class="line">ViewContext context;</div><div class="line"></div><div class="line"><span class="meta">@GET</span></div><div class="line"><span class="meta">@Produces</span>(&#123;<span class="string">"text/html"</span>&#125;)</div><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">getRestricted</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>&#123;</div><div class="line">    </div><div class="line">  String userName = context.getUsername();</div><div class="line">    </div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    context.hasPermission(userName, <span class="string">"RESTRICTED"</span>);</div><div class="line">  &#125; <span class="keyword">catch</span> (org.apache.ambari.view.SecurityException e) &#123;</div><div class="line">    <span class="keyword">return</span> Response.status(<span class="number">401</span>).build();</div><div class="line">  &#125;</div><div class="line">    </div><div class="line">  <span class="keyword">return</span> Response.ok(<span class="string">"&lt;b&gt;You have accessed a restricted resource.&lt;/b&gt;"</span>).type(<span class="string">"text/html"</span>).build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Impersonation"><a href="#Impersonation" class="headerlink" title="Impersonation"></a>Impersonation</h3><p>Views can utilize the viewContext to facilitate calls that require impersonating a user. For example, a service may expose an endpoint that accepts parameters like “doAs=johndoe” to perform some action on behalf of that user.<br>The HttpImpersonator Interface provides a contract for how to perform an HTTP GET request on a URL that supports some type of “doAs” parameter, and the username.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">HttpImpersonator impersonator = viewContext.getHttpImpersonator();</div><div class="line">ImpersonatorSetting impersonatorSetting = viewContext.getImpersonatorSetting();</div><div class="line">String result = impersonator.requestURL(urlToRead, <span class="string">"GET"</span>, impersonatorSetting);</div></pre></td></tr></table></figure></p>
<p>The ImpersonatorSetting class contains the variables that are added to the URL params. Its default constructor sets “doAs” as the default query parameter name, and the currently logged on user as its value; both of these can be changed with the overloaded constructors.</p>
<h3 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h3><p>应用的数据并不像view实例的属性一样，他们或许包含任意字符串，view需要把这些数据持久化，而且还提供更新以及查询。</p>
<p>view context包含从应用数据地图里put或者set数据的方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Save an instance data value for the given key.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key    the key</div><div class="line"> * <span class="doctag">@param</span> value  the value</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putInstanceData</span><span class="params">(String key, String value)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the instance data value for the given key.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key  the key</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the instance data value</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getInstanceData</span><span class="params">(String key)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the instance data values.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view instance property values</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">getInstanceData</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Remove the instance data value for the given key.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key  the key</div><div class="line"> */</div></pre></td></tr></table></figure></p>
<h5 id="DataStore"><a href="#DataStore" class="headerlink" title="DataStore"></a>DataStore</h5><p>data store 允许view instance存储javabean到ambari数据库里。</p>
<p>view组件先通过view context获取一个datastore的实例。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">      <span class="comment">/**</span></div><div class="line">       * Get a data store for view persistence entities.</div><div class="line">       *</div><div class="line">       * <span class="doctag">@return</span> a data store</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> DataStore <span class="title">getDataStore</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">The DataStore object exposes a simple <span class="class"><span class="keyword">interface</span> <span class="title">for</span> <span class="title">persisting</span> <span class="title">view</span> <span class="title">entities</span>.  <span class="title">The</span> <span class="title">basic</span> <span class="title">CRUD</span> <span class="title">operations</span> <span class="title">are</span> <span class="title">supported</span> …  </span></div><div class="line"></div><div class="line">      /**</div><div class="line">       * <span class="title">Save</span> <span class="title">the</span> <span class="title">given</span> <span class="title">entity</span> <span class="title">to</span> <span class="title">persistent</span> <span class="title">storage</span>.  <span class="title">The</span> <span class="title">entity</span> <span class="title">must</span> <span class="title">be</span> <span class="title">declared</span> <span class="title">as</span> <span class="title">an</span></div><div class="line">       * &lt;<span class="title">entity</span>&gt; <span class="title">in</span> <span class="title">the</span> &lt;<span class="title">persistence</span>&gt; <span class="title">element</span> <span class="title">of</span> <span class="title">the</span> <span class="title">view</span>.<span class="title">xml</span>.</div><div class="line">       *</div><div class="line">       * @<span class="title">param</span> <span class="title">entity</span>  <span class="title">the</span> <span class="title">entity</span> <span class="title">to</span> <span class="title">be</span> <span class="title">persisted</span>.</div><div class="line">       *</div><div class="line">       * @<span class="title">throws</span> <span class="title">PersistenceException</span> <span class="title">thrown</span> <span class="title">if</span> <span class="title">the</span> <span class="title">given</span> <span class="title">entity</span> <span class="title">can</span> <span class="title">not</span> <span class="title">be</span> <span class="title">persisted</span></div><div class="line">       */</div><div class="line">      <span class="title">public</span> <span class="title">void</span> <span class="title">store</span>(<span class="title">Object</span> <span class="title">entity</span>) <span class="title">throws</span> <span class="title">PersistenceException</span>;</div><div class="line">    </div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Remove the given entity from persistent storage.</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> entity  the entity to be removed.</div><div class="line">       *</div><div class="line">       * <span class="doctag">@throws</span> PersistenceException thrown if the given entity can not be removed</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(Object entity)</span> <span class="keyword">throws</span> PersistenceException</span>;</div><div class="line">    </div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Find the entity of the given class type that is uniquely identified by the</div><div class="line">       * given primary key.</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> clazz       the entity class</div><div class="line">       * <span class="doctag">@param</span> primaryKey  the primary key</div><div class="line">       * <span class="doctag">@param</span> &lt;T&gt;         the entity type</div><div class="line">       *</div><div class="line">       * <span class="doctag">@return</span> the entity; null if the entity can't be found</div><div class="line">       *</div><div class="line">       * <span class="doctag">@throws</span> PersistenceException thrown if an error occurs trying to find the entity</div><div class="line">       */</div><div class="line">      <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">find</span><span class="params">(Class&lt;T&gt; clazz, Object primaryKey)</span> <span class="keyword">throws</span> PersistenceException</span>;</div><div class="line">    </div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Find all the entities for the given where clause.  Specifying null for the where</div><div class="line">       * clause should return all entities of the given class type.</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> clazz        the entity class</div><div class="line">       * <span class="doctag">@param</span> whereClause  the where clause; may be null</div><div class="line">       * <span class="doctag">@param</span> &lt;T&gt;          the entity type</div><div class="line">       *</div><div class="line">       * <span class="doctag">@return</span> all of the entities for the given where clause; empty collection if no</div><div class="line">       *         entities can be found</div><div class="line">       *</div><div class="line">       * <span class="doctag">@throws</span> PersistenceException</div><div class="line">       */</div><div class="line">      <span class="keyword">public</span> &lt;T&gt; <span class="function">Collection&lt;T&gt; <span class="title">findAll</span><span class="params">(Class&lt;T&gt; clazz, String whereClause)</span> <span class="keyword">throws</span> PersistenceException</span>;</div></pre></td></tr></table></figure></p>
<p>每个entity被持久化之前，都应该已经在view.xml里定义过了。 See <a href="#viewxml">view.xml</a>.   </p>
<h3 id="Events"><a href="#Events" class="headerlink" title="Events"></a>Events</h3><h5 id="View生命周期Events"><a href="#View生命周期Events" class="headerlink" title="View生命周期Events"></a>View生命周期Events</h5><p>实现View接口之后，每个view都可以监控自己的生命周期。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">View</span> </span>&#123;</div><div class="line"></div><div class="line">  ...</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDeploy</span><span class="params">(ViewDefinition definition)</span></span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(ViewInstanceDefinition definition)</span></span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">(ViewInstanceDefinition definition)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>View实现类应该在view.xml文件里声明注册<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>FILES<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">label</span>&gt;</span>Files<span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">  ...</div><div class="line">  <span class="tag">&lt;<span class="name">view-class</span>&gt;</span>org.apache.ambari.view.filebrowser.ViewImpl<span class="tag">&lt;/<span class="name">view-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>View的实现类在注册过之后，它的对应方法会在任何生命周期event发生的时候被触发。</p>
<table>
<thead>
<tr>
<th>Event</th>
<th>描述</th>
<th>参数</th>
</tr>
</thead>
<tbody>
<tr>
<td>Deploy</td>
<td>The view has been successfully deployed.</td>
<td>The deployed view definition.</td>
</tr>
<tr>
<td>Create</td>
<td>An instance of the view has been created.</td>
<td>The new view instance definition.</td>
</tr>
<tr>
<td>Destroy</td>
<td>An instance of the view has been destroyed.</td>
<td>The destroyed view instance definition.</td>
</tr>
</tbody>
</table>
<h5 id="自定义event"><a href="#自定义event" class="headerlink" title="自定义event"></a>自定义event</h5><p>饿哦们也可以定义一些自定义事件。</p>
<h5 id="Listeners"><a href="#Listeners" class="headerlink" title="Listeners"></a>Listeners</h5><p>view需要写一个listener接口的实现，然后注册这个listener到view框架。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Listener</span> </span>&#123;</div><div class="line"></div><div class="line">  ...</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(Event event)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>listener的notify方法会在view发射一个event的时候被触发。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobsListener</span> <span class="keyword">implements</span> <span class="title">Listener</span> </span>&#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(Event event)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (event.getId().equals(<span class="string">"NEW_JOB"</span>)) &#123;</div><div class="line">      ViewInstanceDefinition instance = event.getViewInstanceSubject();         </div><div class="line">      ...</div><div class="line">    &#125;      </div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="ViewController"><a href="#ViewController" class="headerlink" title="ViewController"></a>ViewController</h5><p>ViewController用来注册listener，还有就是发射event。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ViewController</span> </span>&#123;</div><div class="line"></div><div class="line">  ...</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fireEvent</span><span class="params">(String eventId, Map&lt;String, String&gt; eventProperties)</span></span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerListener</span><span class="params">(Listener listener, String viewName)</span></span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregisterListener</span><span class="params">(Listener listener, String viewName)</span></span>;    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>view组件可以访问通过注入的view context来时用view controller。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">    <span class="meta">@Inject</span></div><div class="line">    ViewContext context;</div><div class="line"></div><div class="line">    ...</div><div class="line">    ViewController controller = context.getController();</div><div class="line">```    </div><div class="line"></div><div class="line"></div><div class="line">view component可以注册监听其他view发射的event。</div><div class="line">```java</div><div class="line">    <span class="meta">@Inject</span></div><div class="line">    ViewContext context;</div><div class="line"></div><div class="line">    ...</div><div class="line">    Listener listener = <span class="keyword">new</span> JobsListener();</div><div class="line"></div><div class="line">    ...</div><div class="line">    ViewController controller = context.getController();</div><div class="line">    controller.registerListener(listener, <span class="string">"JOBS"</span>);</div></pre></td></tr></table></figure></p>
<p>view component也可以发射自定义的view通知event.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Inject</span></div><div class="line">ViewContext context;</div><div class="line"></div><div class="line">...</div><div class="line">Map&lt;String, String&gt; jobEventProperties = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</div><div class="line"></div><div class="line">jobEventProperties.put(<span class="string">"JobId"</span>, jobId);</div><div class="line">jobEventProperties.put(<span class="string">"JobOwner"</span>, jobOwner);</div><div class="line"></div><div class="line">...</div><div class="line">ViewController controller = context.getController();</div><div class="line">controller.fireEvent(<span class="string">"NEW_JOB"</span>, jobEventProperties);</div></pre></td></tr></table></figure>
<h2 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h2><p>所有的view都应该打包，包含配置文件和不同的组件，比如resource和resource provider啥的，还有一些 html, JavaSript and servlets.</p>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><p>The view may include dependency classes and jars directly into the archive.  Classes should be included under <strong>WEB-INF/classes</strong>.  Jars should be included under <strong>WEB-INF/lib</strong>.</p>
<h3 id="view-xml"><a href="#view-xml" class="headerlink" title="view.xml"></a>view.xml</h3><table>
<thead>
<tr>
<th>元素</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>The unique view name (required).</td>
</tr>
<tr>
<td>label</td>
<td>The user facing name.</td>
</tr>
<tr>
<td>version</td>
<td>The view version (required).</td>
</tr>
<tr>
<td>description</td>
<td>The description of the view.</td>
</tr>
<tr>
<td>icon64</td>
<td>The 64x64 icon to display for this view. If this property is not set, the 32x32 sized icon will be used.</td>
</tr>
<tr>
<td>icon</td>
<td>The 32x32 icon to display for this view. Suggested size is 32x32 and will be displayed as 8x8 and 16x16 as necessary. If this property is not set, a default view framework icon is used.</td>
</tr>
<tr>
<td>system</td>
<td>Indicates whether or not this is a system view.  Default is false. </td>
</tr>
<tr>
<td>view-class</td>
<td>The View class to receive framework events. </td>
</tr>
<tr>
<td>masker-class</td>
<td>The Masker class for masking view parameters. </td>
</tr>
<tr>
<td>parameter</td>
<td>Defines a configuration parameter that is used to when creating a view instance. </td>
</tr>
<tr>
<td>resource</td>
<td>Describe a resources exposed by the view.</td>
</tr>
<tr>
<td>permission</td>
<td>Defines a custom permission for the view. </td>
</tr>
<tr>
<td>persistence</td>
<td>Describe a view entities for persistence. </td>
</tr>
<tr>
<td>instance</td>
<td>Define an instances of a view.</td>
</tr>
</tbody>
</table>
<h5 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h5><table>
<thead>
<tr>
<th>元素</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>The parameter name.</td>
</tr>
<tr>
<td>description</td>
<td>The parameter description.</td>
</tr>
<tr>
<td>required</td>
<td>Determines whether or not the parameter is required.</td>
</tr>
<tr>
<td>masked</td>
<td>Indicated this parameter value is to be “masked” in the Ambari Web UI (i.e. not shown in the clear). Omitting this element default to not-masked. Otherwise, if true, the parameter value will be “masked” in the Web UI.</td>
</tr>
</tbody>
</table>
<h5 id="resource"><a href="#resource" class="headerlink" title="resource"></a>resource</h5><table>
<thead>
<tr>
<th>元素</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>The resource name (i.e file).</td>
</tr>
<tr>
<td>plural-name</td>
<td>The parameter description (i.e. files). *</td>
</tr>
<tr>
<td>id-property</td>
<td>The id field of the managed resource class. *</td>
</tr>
<tr>
<td>resource-class</td>
<td>The class of the JavaBean that contains the attributes of a managed resource. *</td>
</tr>
<tr>
<td>provider-class</td>
<td>The class of the managed resource provider. *</td>
</tr>
<tr>
<td>service-class</td>
<td>The class of the JAX-RS annotated service resource.</td>
</tr>
<tr>
<td>sub-resource-name</td>
<td>The sub-resource name.</td>
</tr>
</tbody>
</table>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>files<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">service-class</span>&gt;</span>org.apache.ambari.view.filebrowser.FileBrowserService<span class="tag">&lt;/<span class="name">service-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line"></div><div class="line">\* only required for a managed resource.  For example ...</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>script<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">plural-name</span>&gt;</span>scripts<span class="tag">&lt;/<span class="name">plural-name</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">id-property</span>&gt;</span>id<span class="tag">&lt;/<span class="name">id-property</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">resource-class</span>&gt;</span>org.apache.ambari.view.pig.resources.scripts.models.PigScript<span class="tag">&lt;/<span class="name">resource-class</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">provider-class</span>&gt;</span>org.apache.ambari.view.pig.resources.scripts.ScriptResourceProvider<span class="tag">&lt;/<span class="name">provider-class</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">service-class</span>&gt;</span>org.apache.ambari.view.pig.resources.scripts.ScriptService<span class="tag">&lt;/<span class="name">service-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div></pre></td></tr></table></figure>
<h5 id="权限-1"><a href="#权限-1" class="headerlink" title="权限"></a>权限</h5><table>
<thead>
<tr>
<th>Element</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>The permission name.</td>
</tr>
<tr>
<td>description</td>
<td>The permission description.</td>
</tr>
</tbody>
</table>
<h5 id="持久化-1"><a href="#持久化-1" class="headerlink" title="持久化"></a>持久化</h5><table>
<thead>
<tr>
<th>Element</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>entity</td>
<td>An entity that may be persisted through the DataStore.</td>
</tr>
</tbody>
</table>
<h5 id="entity"><a href="#entity" class="headerlink" title="entity"></a>entity</h5><table>
<thead>
<tr>
<th>Element</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>class</td>
<td>The class ot the JavaBean that contains the attributes of an entity.</td>
</tr>
<tr>
<td>id-property</td>
<td>The id field of the entity.</td>
</tr>
</tbody>
</table>
<p>例子<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&lt;persistence&gt;</div><div class="line">  &lt;entity&gt;</div><div class="line">    &lt;<span class="class"><span class="keyword">class</span>&gt;<span class="title">org</span>.<span class="title">apache</span>.<span class="title">ambari</span>.<span class="title">view</span>.<span class="title">employee</span>.<span class="title">EmployeeEntity</span>&lt;/<span class="title">class</span>&gt;</span></div><div class="line">    &lt;<span class="title">id</span>-<span class="title">property</span>&gt;<span class="title">id</span>&lt;/<span class="title">id</span>-<span class="title">property</span>&gt;</div><div class="line">  &lt;/<span class="title">entity</span>&gt;</div><div class="line">  &lt;<span class="title">entity</span>&gt;</div><div class="line">    &lt;<span class="title">class</span>&gt;<span class="title">org</span>.<span class="title">apache</span>.<span class="title">ambari</span>.<span class="title">view</span>.<span class="title">employee</span>.<span class="title">AddressEntity</span>&lt;/<span class="title">class</span>&gt;</div><div class="line">    &lt;<span class="title">id</span>-<span class="title">property</span>&gt;<span class="title">id</span>&lt;/<span class="title">id</span>-<span class="title">property</span>&gt;</div><div class="line">  &lt;/<span class="title">entity</span>&gt;</div><div class="line">  &lt;<span class="title">entity</span>&gt;</div><div class="line">    &lt;<span class="title">class</span>&gt;<span class="title">org</span>.<span class="title">apache</span>.<span class="title">ambari</span>.<span class="title">view</span>.<span class="title">employee</span>.<span class="title">ProjectEntity</span>&lt;/<span class="title">class</span>&gt;</div><div class="line">    &lt;<span class="title">id</span>-<span class="title">property</span>&gt;<span class="title">id</span>&lt;/<span class="title">id</span>-<span class="title">property</span>&gt;</div><div class="line">  &lt;/<span class="title">entity</span>&gt;</div><div class="line">&lt;/<span class="title">persistence</span>&gt;</div></pre></td></tr></table></figure></p>
<h5 id="instance"><a href="#instance" class="headerlink" title="instance"></a>instance</h5><table>
<thead>
<tr>
<th>Element</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>The unique instance name (required).</td>
</tr>
<tr>
<td>label</td>
<td>The display label of the view instance. If not set, the view definition label is used.</td>
</tr>
<tr>
<td>description</td>
<td>The description of the view instance. If not set, the view definition description is used.</td>
</tr>
<tr>
<td>icon64</td>
<td>Overrides the view icon64 for this specific view instance.</td>
</tr>
<tr>
<td>icon</td>
<td>Overrides the view icon for this specific view instance.</td>
</tr>
<tr>
<td>visible</td>
<td>If true, for the view instance to show up in the users view instance list.  The default value is true.</td>
</tr>
<tr>
<td>property</td>
<td>Specifies configuration parameters values for the view instance.</td>
</tr>
</tbody>
</table>
<h5 id="property"><a href="#property" class="headerlink" title="property"></a>property</h5><table>
<thead>
<tr>
<th>Element</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>key</td>
<td>The property key (must match view parameter name).</td>
</tr>
<tr>
<td>value</td>
<td>The property value.</td>
</tr>
</tbody>
</table>
<p>完整的 view.xml例子<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>FILES<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>Files<span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">parameter</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dataworker.defaultFs<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>FileSystem URI<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">required</span>&gt;</span>true<span class="tag">&lt;/<span class="name">required</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parameter</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">parameter</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dataworker.username<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>The username (defaults to ViewContext username)<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">required</span>&gt;</span>false<span class="tag">&lt;/<span class="name">required</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parameter</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>files<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">service-class</span>&gt;</span>org.apache.ambari.view.filebrowser.FileBrowserService<span class="tag">&lt;/<span class="name">service-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">instance</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>FILES_1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>dataworker.defaultFs<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://<span class="tag">&lt;<span class="name">server</span>&gt;</span>:8020<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">instance</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这个例子中配置了一个叫FILES的view，也是有一个实例FILES_1。可以看到这个view有一个required的参数<strong>‘dataworker.defaultFs’</strong>以及一个optional参数<strong>‘dataworker.username’</strong>.  还有一个访问资源的入口<strong>‘files’</strong>. </p>
<h2 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h2><p>要发布一个view，只需要将view的包放到ambari-server的views文件夹下，默认是在</p>
<pre><code>/var/lib/ambari-server/resources/views
</code></pre><h3 id="解压包"><a href="#解压包" class="headerlink" title="解压包"></a>解压包</h3><p>view被发布之后，会自动在views文件夹下解压包。默认位置是:</p>
<pre><code>/var/lib/ambari-server/resources/views/work/:viewName{:viewVersion}
</code></pre><p>例如，上面例子中的files view解压后目录就是：</p>
<pre><code>/var/lib/ambari-server/resources/views/work/FILES{0.1.0}
</code></pre><p>用户可以直接修改解压后的文件，在ambari下次启动的时候就可以生效了。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><h5 id="Get-Views"><a href="#Get-Views" class="headerlink" title="Get Views"></a>Get Views</h5><p>获取所有已经发布的view。注意view是顶级resource，不属于任何其他resource。</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/

{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/&quot;,
  &quot;items&quot; : [
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES&quot;,
      &quot;ViewInfo&quot; : {
        &quot;view_name&quot; : &quot;FILES&quot;
      }
    },
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/HELLO_WORLD&quot;,
      &quot;ViewInfo&quot; : {
        &quot;view_name&quot; : &quot;HELLO_WORLD&quot;
      }
    }
  ]
}
</code></pre><h5 id="Get-View"><a href="#Get-View" class="headerlink" title="Get View"></a>Get View</h5><p>根据名称获取指定view，返回所有版本.</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/FILES/

{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/&quot;,
  &quot;ViewInfo&quot; : {
    &quot;view_name&quot; : &quot;FILES&quot;
  },
  &quot;versions&quot; : [
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0&quot;,
      &quot;ViewVersionInfo&quot; : {
        &quot;version&quot; : &quot;0.1.0&quot;,
        &quot;view_name&quot; : &quot;FILES&quot;
      }
    }
  ]
}
</code></pre><h5 id="Get-Versions"><a href="#Get-Versions" class="headerlink" title="Get Versions"></a>Get Versions</h5><p>获取一个view 的所有版本.</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/FILES/versions/

{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/&quot;,
  &quot;items&quot; : [
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0&quot;,
      &quot;ViewVersionInfo&quot; : {
        &quot;version&quot; : &quot;0.1.0&quot;,
        &quot;view_name&quot; : &quot;FILES&quot;
      }
    }
  ]
}
</code></pre><h5 id="Get-Version"><a href="#Get-Version" class="headerlink" title="Get Version"></a>Get Version</h5><p>获取某view的指定版本以及此版本下的所有实例.</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/

{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/&quot;,
  &quot;ViewVersionInfo&quot; : {
    &quot;archive&quot; : &quot;/var/lib/ambari-server/resources/views/work/FILES{0.1.0}&quot;,
    &quot;label&quot; : &quot;Files&quot;,
    &quot;parameters&quot; : [
      {
        &quot;name&quot; : &quot;dataworker.defaultFs&quot;,
        &quot;description&quot; : &quot;FileSystem URI&quot;,
        &quot;required&quot; : true
      },
      {
        &quot;name&quot; : &quot;dataworker.username&quot;,
        &quot;description&quot; : &quot;The username (defaults to ViewContext username)&quot;,
        &quot;required&quot; : false
      }
    ],
    &quot;version&quot; : &quot;0.1.0&quot;,
    &quot;view_name&quot; : &quot;FILES&quot;
  },
  &quot;instances&quot; : [
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_1&quot;,
      &quot;ViewInstanceInfo&quot; : {
        &quot;instance_name&quot; : &quot;FILES_1&quot;,
        &quot;version&quot; : &quot;0.1.0&quot;,
        &quot;view_name&quot; : &quot;FILES&quot;
      }
    }
  ]
}
</code></pre><h5 id="Get-Instances"><a href="#Get-Instances" class="headerlink" title="Get Instances"></a>Get Instances</h5><p>获取一个view 的所有实例.</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/

{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/&quot;,
  &quot;items&quot; : [
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_1&quot;,
      &quot;ViewInstanceInfo&quot; : {
        &quot;instance_name&quot; : &quot;FILES_1&quot;,
        &quot;version&quot; : &quot;0.1.0&quot;,
        &quot;view_name&quot; : &quot;FILES&quot;
      }
    }
  ]
}
</code></pre><h5 id="获取实例"><a href="#获取实例" class="headerlink" title="获取实例"></a>获取实例</h5><p>根据实例名称获取实例，此实例的所有resource也会被返回。</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_1

{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_1&quot;,
  &quot;ViewInstanceInfo&quot; : {
    &quot;context_path&quot; : &quot;/views/FILES/0.1.0/FILES_1&quot;,
    &quot;instance_name&quot; : &quot;FILES_1&quot;,
    &quot;version&quot; : &quot;0.1.0&quot;,
    &quot;view_name&quot; : &quot;FILES&quot;,
    &quot;instance_data&quot; : { },
    &quot;properties&quot; : {
      &quot;dataworker.defaultFs&quot; : &quot;hdfs://&lt;server&gt;:8020&quot;
    }
  },
  &quot;resources&quot; : [
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_1/resources/files&quot;,
      &quot;instance_name&quot; : &quot;FILES_1&quot;,
      &quot;name&quot; : &quot;files&quot;,
      &quot;version&quot; : &quot;0.1.0&quot;,
      &quot;view_name&quot; : &quot;FILES&quot;
    }
  ]
}
</code></pre><h5 id="创建实例"><a href="#创建实例" class="headerlink" title="创建实例"></a>创建实例</h5><pre><code>POST http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_2
</code></pre><h5 id="更新实例"><a href="#更新实例" class="headerlink" title="更新实例"></a>更新实例</h5><pre><code>PUT http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_2
[{
  &quot;ViewInstanceInfo&quot; : {
      &quot;properties&quot; : {
        &quot;dataworker.defaultFs&quot; : &quot;hdfs://MyServer:8020&quot;
      }
    }
}]
</code></pre><h5 id="删除实例"><a href="#删除实例" class="headerlink" title="删除实例"></a>删除实例</h5><pre><code>DELETE http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_2
</code></pre><h5 id="Resources-1"><a href="#Resources-1" class="headerlink" title="Resources"></a>Resources</h5><p>A view resource may be accessed through the REST API.  The href for each view resource can be found in a request for the parent view instance.  The resource endpoints and behavior depends on the implementation of the JAX-RS annotated service class specified for the resource element in the view.xml. </p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_1/resources/files/fileops/listdir?path=%2F

[{&quot;path&quot;:&quot;/app-logs&quot;,&quot;replication&quot;:0,&quot;isDirectory&quot;:true,&quot;len&quot;:0,&quot;owner&quot;:&quot;yarn&quot;,&quot;group&quot;:&quot;hadoop&quot;,&quot;permission&quot;:&quot;-rwxrwxrwx&quot;,&quot;accessTime&quot;:0,&quot;modificationTime&quot;:1400006792122,&quot;blockSize&quot;:0},{&quot;path&quot;:&quot;/mapred&quot;,&quot;replication&quot;:0,&quot;isDirectory&quot;:true,&quot;len&quot;:0,&quot;owner&quot;:&quot;mapred&quot;,&quot;group&quot;:&quot;hdfs&quot;,&quot;permission&quot;:&quot;-rwxr-xr-x&quot;,&quot;accessTime&quot;:0,&quot;modificationTime&quot;:1400006653817,&quot;blockSize&quot;:0},{&quot;path&quot;:&quot;/mr-history&quot;,&quot;replication&quot;:0,&quot;isDirectory&quot;:true,&quot;len&quot;:0,&quot;owner&quot;:&quot;hdfs&quot;,&quot;group&quot;:&quot;hdfs&quot;,&quot;permission&quot;:&quot;-rwxr-xr-x&quot;,&quot;accessTime&quot;:0,&quot;modificationTime&quot;:1400006653822,&quot;blockSize&quot;:0},{&quot;path&quot;:&quot;/tmp&quot;,&quot;replication&quot;:0,&quot;isDirectory&quot;:true,&quot;len&quot;:0,&quot;owner&quot;:&quot;hdfs&quot;,&quot;group&quot;:&quot;hdfs&quot;,&quot;permission&quot;:&quot;-rwxrwxrwx&quot;,&quot;accessTime&quot;:0,&quot;modificationTime&quot;:1400006720415,&quot;blockSize&quot;:0},{&quot;path&quot;:&quot;/user&quot;,&quot;replication&quot;:0,&quot;isDirectory&quot;:true,&quot;len&quot;:0,&quot;owner&quot;:&quot;hdfs&quot;,&quot;group&quot;:&quot;hdfs&quot;,&quot;permission&quot;:&quot;-rwxr-xr-x&quot;,&quot;accessTime&quot;:0,&quot;modificationTime&quot;:1400006610050,&quot;blockSize&quot;:0}]
</code></pre><h5 id="Managed-Resources-1"><a href="#Managed-Resources-1" class="headerlink" title="Managed Resources"></a>Managed Resources</h5><p>Any managed resources for a view may also be accessed through the REST API.  Note that instances of a managed resource appear as sub-resources of an instance under the plural name specified for the resource in the view.xml.  In this example, a list of managed resources named <strong>‘scripts’</strong> is included in the response for the view instance … </p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/PIG/versions/0.1.0/instances/INSTANCE_1

{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/PIG/versions/0.1.0/instances/INSTANCE_1&quot;,
  &quot;ViewInstanceInfo&quot; : {
    &quot;context_path&quot; : &quot;/views/PIG/0.1.0/INSTANCE_1&quot;,
    &quot;instance_name&quot; : &quot;INSTANCE_1&quot;,
    &quot;version&quot; : &quot;0.1.0&quot;,
    &quot;view_name&quot; : &quot;PIG&quot;,
    &quot;instance_data&quot; : { },
    &quot;properties&quot; : {
      … 
    }
  },
  &quot;resources&quot; : [ ],
  &quot;scripts&quot; : [
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/PIG/versions/0.1.0/instances/INSTANCE_1/scripts/script1&quot;,
      &quot;id&quot; : &quot;script1&quot;,
      &quot;instance_name&quot; : &quot;INSTANCE_1&quot;,
      &quot;version&quot; : &quot;0.1.0&quot;,
      &quot;view_name&quot; : &quot;PIG&quot;
    },
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/INSTANCE_1/scripts/script2&quot;,
      &quot;id&quot; : &quot;script2&quot;,
      &quot;instance_name&quot; : &quot;INSTANCE_1&quot;,
      &quot;version&quot; : &quot;0.1.0&quot;,
      &quot;view_name&quot; : &quot;PIG&quot;
    },
    …
  ]
}
</code></pre><p>获取单个managed resource …</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/PIG/versions/0.1.0/instances/INSTANCE_1/scripts/script1


{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/PIG/versions/0.1.0/instances/INSTANCE_1/scripts/script1&quot;,
  &quot;id&quot; : &quot;script1&quot;,      
  &quot;pigScript&quot; : &quot;… &quot;,
  &quot;pythonScript&quot; : &quot;… &quot;,
  &quot;templetonArguments&quot; : &quot;… &quot;,
  &quot;dateCreated&quot; : … ,
  &quot;owner&quot; : &quot;… &quot;,
  &quot;instance_name&quot; : &quot;INSTANCE_1&quot;,
  &quot;version&quot; : &quot;0.1.0&quot;,
  &quot;view_name&quot; : &quot;PIG&quot;
}
</code></pre><p>由于resource是被ambari api框架管理的，也可以使用partial response和query predicate。</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/PIG/versions/0.1.0/instances/INSTANCE_1/scripts?fields=pythonScript&amp;owner=jsmith
</code></pre><h5 id="设置view权限"><a href="#设置view权限" class="headerlink" title="设置view权限"></a>设置view权限</h5><p>To grant privileges to access the restricted resource we can create a privilege sub-resource for the view instance.  The following API will grant RESTICTED permission to the user ‘bob’ for the view instance ‘INSTANCE_1’ of the ‘RESTRICTED’ view. </p>
<pre><code>POST http://&lt;server&gt;/api/v1/views/RESTRICTED/versions/1.0.0/instances/INSTANCE_1

[
  {
    &quot;PrivilegeInfo&quot; : {
      &quot;permission_name&quot; : &quot;RESTRICTED&quot;,
      &quot;principal_name&quot; : &quot;bob&quot;,
      &quot;principal_type&quot; : &quot;USER&quot;
    }
  }
]
</code></pre><h5 id="查询view权限"><a href="#查询view权限" class="headerlink" title="查询view权限"></a>查询view权限</h5><p>We can see a privilege sub resource for a view instance.</p>
<pre><code>GET  http://&lt;server&gt;/api/v1/views/RESTRICTED/versions/1.0.0/instances/INSTANCE_1/privileges/5


{
  &quot;href&quot; : &quot;http://&lt;server&gt;/api/v1/views/RESTRICTED/versions/1.0.0/instances/INSTANCE_1/privileges/5&quot;,
  &quot;PrivilegeInfo&quot; : {
    &quot;instance_name&quot; : &quot;INSTANCE_1&quot;,
    &quot;permission_name&quot; : &quot;RESTRICTED&quot;,
    &quot;principal_name&quot; : &quot;bob&quot;,
    &quot;principal_type&quot; : &quot;USER&quot;,
    &quot;privilege_id&quot; : 5,
    &quot;version&quot; : &quot;1.0.0&quot;,
    &quot;view_name&quot; : &quot;RESTRICTED&quot;
  }
}
</code></pre><h3 id="View-UI"><a href="#View-UI" class="headerlink" title="View UI"></a>View UI</h3><p>The context root of a view instance is …</p>
<pre><code>/views/:viewName/:viewVersion/:viewInstance/
</code></pre><p>For example, the context root can be found in the response for a view instance … </p>
<p><img src="instance_response.png" alt="image"></p>
<p>So, to access the UI of the above Files view the user would browse to …</p>
<pre><code>http://&lt;server&gt;:8080/views/FILES/0.1.0/FILES_1/  
</code></pre><p><img src="ui.png" alt="image"></p>
]]></content>
      
        
        <tags>
            
            <tag> ambari </tag>
            
            <tag> 源码 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ambari-web解读（一）-请求流程]]></title>
      <url>/2016/06/20/ambari-web%E8%A7%A3%E8%AF%BB%EF%BC%88%E4%B8%80%EF%BC%89-%E8%AF%B7%E6%B1%82%E6%B5%81%E7%A8%8B/</url>
      <content type="html"><![CDATA[<p>最近为公司选型了大数据维护工具ambari，官网:ambari.apache.org。主要是为了运维方便一些。<br>另外对于数据分析人员开放了一个hive view页面，提供提数支持。但是对于原始的hive view，我们有些不满意的地方：</p>
<ol>
<li>table的comment没有展示完全</li>
<li>后台一直在每15秒钟请求一次后台hiveserver。虽然这并不会对和iveserver造成很大压力，但是感觉不友好，产生很多垃圾log。</li>
</ol>
<p>经过差不多一周左右断断续续地探查与学习，基本弄清楚了ambari-web的请求处理脉路。可能对nodejs大神来说这不算啥，但是个人感觉稍微有点儿吃力。学习了一下nodejs的新的工具ember.js。</p>
<h3 id="1"><a href="#1" class="headerlink" title="1."></a>1.</h3><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><table>
<thead>
<tr>
<th>链接</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/emberjs/starter-kit/" target="_blank" rel="external">https://github.com/emberjs/starter-kit/</a></td>
<td>学习ember.js的基础项目</td>
</tr>
<tr>
<td><a href="http://www.html-js.com/article/1685" target="_blank" rel="external">http://www.html-js.com/article/1685</a></td>
<td>Ember.js Application Development How-to的中文翻译</td>
</tr>
<tr>
<td><a href="http://www.ruanyifeng.com/blog/2011/08/a_detailed_explanation_of_jquery_deferred_object.html" target="_blank" rel="external">http://www.ruanyifeng.com/blog/2011/08/a_detailed_explanation_of_jquery_deferred_object.html</a></td>
<td>对于jquery回调工具deferred的解释</td>
</tr>
</tbody>
</table>
]]></content>
      
        
        <tags>
            
            <tag> ambari </tag>
            
            <tag> 源码 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[一步步搞定ETL依赖调度平台（三）-调度优先级思考]]></title>
      <url>/2016/06/17/%E4%B8%80%E6%AD%A5%E6%AD%A5%E6%90%9E%E5%AE%9AETL%E4%BE%9D%E8%B5%96%E8%B0%83%E5%BA%A6%E5%B9%B3%E5%8F%B0%EF%BC%88%E4%B8%89%EF%BC%89-%E8%B0%83%E5%BA%A6%E4%BC%98%E5%85%88%E7%BA%A7%E6%80%9D%E8%80%83/</url>
      <content type="html"><![CDATA[<p>从《azkaban源码追踪（三）-上传zip的坑》可以看到azkaban本身的调度基本是广度优先执行的。</p>
<h3 id="1-猎聘"><a href="#1-猎聘" class="headerlink" title="1.猎聘"></a>1.猎聘</h3><p><img src="/imgs/azkaban/schedule-lp-tree.png" alt="猎聘的调度tree"></p>
<p>优先级生成策略是从叶子节点向上遍历，每个节点的优先级=所有子节点优先级+edge数(也就是子节点数)。其实思想就是谁下面的小弟多，谁的优先级就越大。</p>
<p>但这通常并不完全适用于对于指定的单个叶子节点最优先的需求，极端点儿想的话，可能出现老的ETL有100多个相关成一个flow，可是新增的优先级特别高的需求super_etl在另一个只有1个节点的flow，或者在同一个flow，但是它没有小弟（这种其实蛮常见的）。那么super_etl的默认priority是1，根本没有地位！！！</p>
<blockquote>
<p>LP的人说了：我们可以给它人工指定优先级啊！<br>额。。。。是的，但是其他的tree是在一直生长的，按照你们的策略来看，这个super_etl的优先级要一直改变。<br>LP的人又说了：我们可以动态指定！<br>额。。。。是的，但是后面出现了super_etl01,super_etl02的时候，可能就会特别特别麻烦了。</p>
</blockquote>
<p>再看一下，计划顺序与实际执行顺序的对比。本来C的优先级是比B高的，可猎聘给出的实际执行却是先执行B后执行c，音频中苏总说是并发问题，个人看来稍稍有些含糊其辞了。推测猎聘的实际调度的时候并不完全以priority为指导，而仍然是azkaban广度遍历优先，同一个level之内才是priority优先执行。</p>
<p>参考:<a href="http://mp.weixin.qq.com/s?src=3&amp;timestamp=1466131251&amp;ver=1&amp;signature=YfS7PgVR0SjjLt4KwIQ297t4SDiLrrJu5C7uuMXpkCvuhvjXk-DU*eJGfIBSfjDm-WlVuwaIbGtbfda-k-5rRgUewAlvjSUQBBNY4jnjuvQD1puqdaVzUqIq9ds*x1r-6dUnU6OiSERzBt5UWfjdUkekpmc7hNqTm1pklClkSkE=" target="_blank" rel="external">http://mp.weixin.qq.com/s?src=3&amp;timestamp=1466131251&amp;ver=1&amp;signature=YfS7PgVR0SjjLt4KwIQ297t4SDiLrrJu5C7uuMXpkCvuhvjXk-DU*eJGfIBSfjDm-WlVuwaIbGtbfda-k-5rRgUewAlvjSUQBBNY4jnjuvQD1puqdaVzUqIq9ds*x1r-6dUnU6OiSERzBt5UWfjdUkekpmc7hNqTm1pklClkSkE=</a></p>
<h3 id="2-美团"><a href="#2-美团" class="headerlink" title="2.美团"></a>2.美团</h3><p><img src="/imgs/azkaban/schedule-mt-tree.png" alt="美团的调度tree"></p>
<p>调度策略就不该是递归调度，而应该完全按照优先级别去调度。想来想去，这才是真正的优先级调度。东家靠谱儿！</p>
<p>参考：<a href="http://mp.weixin.qq.com/s?src=3&amp;timestamp=1466131231&amp;ver=1&amp;signature=YfS7PgVR0SjjLt4KwIQ297t4SDiLrrJu5C7uuMXpkCtKEZcZ58gspxJhkgDlgXAkqQvXpI3IbmE4HzkI33W*4PJCOUoKyzSna56Q8uSQgUNnSl7vsxqLcREVfDBU0nPguiAiwnosiXyE9wB7T-edr3QrRn8rKMhB3oxjQDrS1RQ=" target="_blank" rel="external">http://mp.weixin.qq.com/s?src=3&amp;timestamp=1466131231&amp;ver=1&amp;signature=YfS7PgVR0SjjLt4KwIQ297t4SDiLrrJu5C7uuMXpkCtKEZcZ58gspxJhkgDlgXAkqQvXpI3IbmE4HzkI33W*4PJCOUoKyzSna56Q8uSQgUNnSl7vsxqLcREVfDBU0nPguiAiwnosiXyE9wB7T-edr3QrRn8rKMhB3oxjQDrS1RQ=</a></p>
<p>综上：后面本人要开发的调度系统优先级策略会借用美团的思想。</p>
]]></content>
      
        
        <tags>
            
            <tag> ETL </tag>
            
            <tag> 调度平台 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[azkaban源码追踪（三）-上传zip的坑]]></title>
      <url>/2016/06/16/azkaban%E6%BA%90%E7%A0%81%E8%BF%BD%E8%B8%AA%EF%BC%88%E4%B8%89%EF%BC%89-%E4%B8%8A%E4%BC%A0zip%E7%9A%84%E5%9D%91/</url>
      <content type="html"><![CDATA[<p>前面其实已经解析了上传zip文件到azkaban的流程，但是自己都感觉写的实在是太操蛋了。</p>
<h3 id="1-时序图"><a href="#1-时序图" class="headerlink" title="1. 时序图"></a>1. 时序图</h3><p><img src="/imgs/azkaban/azkaban-atash-sequence-diagram.png" alt="上传zip文件的时序图"></p>
<h3 id="2-坑的表现"><a href="#2-坑的表现" class="headerlink" title="2. 坑的表现"></a>2. 坑的表现</h3><p>ETL的依赖关系肯定的多父多子的，所以就上传了一个典型到azkaban上。结果被分成了两个flow</p>
<p><img src="/imgs/azkaban/azkaban-two-wrong-flow.png" alt="拥有相关ETL的flow被分成了两个"></p>
<p><img src="/imgs/azkaban/azkaban-wrong-flow-1.png" alt="第一个错误的flow"></p>
<p><img src="/imgs/azkaban/azkaban-wrong-flow-2.png" alt="第二个错误的flow"></p>
<p>可以看到对于mymeta@my_table_c之上的etl，对于下面的node应该是公用的，像现在这样两个flow都有的话，就会导致这些node被多次执行。</p>
<h3 id="3-源码分析"><a href="#3-源码分析" class="headerlink" title="3.源码分析"></a>3.源码分析</h3><p>根据上面的时序图，我们可以看到问题应该是出在分析依赖或者创建flow的过程中。所以过去剖析对应源码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 就是把每个node的dependency map放进HashMap&lt;String, Map&lt;String, Edge&gt;&gt; nodeDependencies里面，一个对应多个dependencies</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resolveDependencies</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// Add all the in edges and out edges. Catch bad dependencies and self</span></div><div class="line">    <span class="comment">// referrals. Also collect list of nodes who are parents.</span></div><div class="line">    <span class="keyword">for</span> (Node node : nodeMap.values()) &#123;</div><div class="line">      Props props = jobPropsMap.get(node.getId());</div><div class="line"></div><div class="line">      List&lt;String&gt; dependencyList =</div><div class="line">          props.getStringList(CommonJobProperties.DEPENDENCIES,</div><div class="line">              (List&lt;String&gt;) <span class="keyword">null</span>);</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (dependencyList != <span class="keyword">null</span>) &#123;</div><div class="line">        Map&lt;String, Edge&gt; dependencies = nodeDependencies.get(node.getId());</div><div class="line">        <span class="keyword">if</span> (dependencies == <span class="keyword">null</span>) &#123;</div><div class="line">          dependencies = <span class="keyword">new</span> HashMap&lt;String, Edge&gt;();</div><div class="line"></div><div class="line">          <span class="keyword">for</span> (String dependencyName : dependencyList) &#123;</div><div class="line">            dependencyName =</div><div class="line">                dependencyName == <span class="keyword">null</span> ? <span class="keyword">null</span> : dependencyName.trim();</div><div class="line">            <span class="keyword">if</span> (dependencyName == <span class="keyword">null</span> || dependencyName.isEmpty()) &#123;</div><div class="line">              <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Edge edge = <span class="keyword">new</span> Edge(dependencyName, node.getId());</div><div class="line">            Node dependencyNode = nodeMap.get(dependencyName);</div><div class="line">            <span class="keyword">if</span> (dependencyNode == <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="keyword">if</span> (duplicateJobs.contains(dependencyName)) &#123;</div><div class="line">                edge.setError(<span class="string">"Ambiguous Dependency. Duplicates found."</span>);</div><div class="line">                dependencies.put(dependencyName, edge);</div><div class="line">                errors.add(node.getId() + <span class="string">" has ambiguous dependency "</span></div><div class="line">                    + dependencyName);</div><div class="line">              &#125; <span class="keyword">else</span> &#123;</div><div class="line">                edge.setError(<span class="string">"Dependency not found."</span>);</div><div class="line">                dependencies.put(dependencyName, edge);</div><div class="line">                errors.add(node.getId() + <span class="string">" cannot find dependency "</span></div><div class="line">                    + dependencyName);</div><div class="line">              &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dependencyNode == node) &#123;</div><div class="line">              <span class="comment">// We have a self cycle</span></div><div class="line">              edge.setError(<span class="string">"Self cycle found."</span>);</div><div class="line">              dependencies.put(dependencyName, edge);</div><div class="line">              errors.add(node.getId() + <span class="string">" has a self cycle"</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">              dependencies.put(dependencyName, edge);</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">if</span> (!dependencies.isEmpty()) &#123;</div><div class="line">            nodeDependencies.put(node.getId(), dependencies);</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>跟踪源码的时候，没有发现上面代码有任何问题。再看下根据依赖构建flow的过程<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildFlowsFromDependencies</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="comment">// Find all root nodes by finding ones without dependents.</span></div><div class="line">  <span class="comment">/********************注意这里 ***********************/</span></div><div class="line">  HashSet&lt;String&gt; nonRootNodes = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">  <span class="keyword">for</span> (Map&lt;String, Edge&gt; edges : nodeDependencies.values()) &#123;</div><div class="line">    <span class="keyword">for</span> (String sourceId : edges.keySet()) &#123;</div><div class="line">      nonRootNodes.add(sourceId);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Now create flows. Bad flows are marked invalid</span></div><div class="line">  Set&lt;String&gt; visitedNodes = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">  <span class="keyword">for</span> (Node base : nodeMap.values()) &#123;</div><div class="line">    <span class="comment">// Root nodes can be discovered when parsing jobs</span></div><div class="line">    <span class="comment">/********************注意这里 ***********************/</span></div><div class="line">    <span class="keyword">if</span> (rootNodes.contains(base.getId())</div><div class="line">        || !nonRootNodes.contains(base.getId())) &#123;</div><div class="line">      rootNodes.add(base.getId());</div><div class="line">      Flow flow = <span class="keyword">new</span> Flow(base.getId());</div><div class="line">      Props jobProp = jobPropsMap.get(base.getId());</div><div class="line"></div><div class="line">      <span class="comment">// 遍历properties里的各种通知邮件啥的</span></div><div class="line"></div><div class="line">      flow.addFailureEmails(failureEmail);</div><div class="line">      flow.addSuccessEmails(successEmail);</div><div class="line"></div><div class="line">      flow.addAllFlowProperties(flowPropsList);</div><div class="line">      constructFlow(flow, base, visitedNodes);</div><div class="line">      flow.initialize();</div><div class="line">      flowMap.put(base.getId(), flow);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面第一个地方是找到所有非root的node，看代码意思就是所有有dependency的node。第二个注意的地方是找rootNodes里有或者不存在与非rootNode集合的node。这不是叶子节点么，下面紧接着就add进去rootNodes了。也就是说azkaban中这里的node的<strong>root角色其实是指的叶子节点</strong>。第三个是flow是按照叶子节点的id命名的，也就是有多少叶子节点就会有多少flow被生成。<br>解释通了，因为我们的project的zip文件中是有两个叶子节点的job，所以就被分成了两个flow。</p>
<h3 id="4-解决方案"><a href="#4-解决方案" class="headerlink" title="4. 解决方案"></a>4. 解决方案</h3><p>生成最终的zip文件之前，生成一个虚拟end job，把所有的叶子节点都配置成它的dependency，这样就只有一个flow了。</p>
<p><img src="/imgs/azkaban/azkaban-right-flow.png" alt="最终生成的正确的flow图"></p>
<p><img src="/imgs/azkaban/azkaban-right-flow-execution.png" alt="尝试执行以下正确的这个flow"></p>
<p>可以看到，并列在同一个level的node是并发执行的，因为他们两个之间相互没有任何影响。这样使用并发充分利用资源，但是azkaban的并发性能和稳定性需要进一步探查。</p>
<h3 id="5-TODO"><a href="#5-TODO" class="headerlink" title="5.TODO"></a>5.TODO</h3><p>每个任务的Runner稳定性测试与定制开发(希望不需要)</p>
]]></content>
      
        
        <tags>
            
            <tag> 源码 </tag>
            
            <tag> azkaban </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[一步步搞定ETL依赖调度平台（二）-zakaban整合实施]]></title>
      <url>/2016/06/16/%E4%B8%80%E6%AD%A5%E6%AD%A5%E6%90%9E%E5%AE%9AETL%E4%BE%9D%E8%B5%96%E8%B0%83%E5%BA%A6%E5%B9%B3%E5%8F%B0%EF%BC%88%E4%BA%8C%EF%BC%89-%E4%B8%8Eazkaban%E6%95%B4%E5%90%88/</url>
      <content type="html"><![CDATA[<p>再列以下前面提到的步骤：</p>
<ol>
<li>通过azkaban api创建一个project: etl_20160615;</li>
<li>调用java程序根据tbl_blood和etl内容生成azkaban的项目文件20160615.zip;</li>
<li>通过azkaban api上传此文件到etl_20160615的project上</li>
<li>通过azkaban api遍历etl_20160615项目下的所有flow，进行调度。</li>
</ol>
<p>其实（一）里面是第二步的实现。今儿调研了以下azkaban的ajax api，并没有想象中的那么简单，所以就再单独说一下怎样完成其他步骤——重要的难点在于<strong>session-id的获取</strong>。</p>
<h3 id="1-方案与问题"><a href="#1-方案与问题" class="headerlink" title="1. 方案与问题"></a>1. 方案与问题</h3><table>
<thead>
<tr>
<th>方案</th>
<th>问题</th>
<th>解决方案</th>
</tr>
</thead>
<tbody>
<tr>
<td>使用azkaban api</td>
<td>需要session-id进行server端验证</td>
<td>1. 使用phantomjs等模拟实现浏览器，从cookie中获取session-id——费事<br>2. 想办法使一个session-id永不过期(这个实施起来最简单，但是稳定程度有待测试)<br>3.azkaban web server启动了rest.li里的userManagerResource，login是返回session-id的，但是需要研习以下rest.li<br>找了半天，解决了:  curl -k -X POST –data “username=azkaban&amp;password=azkaban&amp;action=login” <a href="http://10.1.5.66:8001" target="_blank" rel="external">http://10.1.5.66:8001</a></td>
</tr>
<tr>
<td>直接操作数据</td>
<td>需要对上传zip文件后生成的mysql表足够了解，包括存储的每个字段的内容与规范</td>
<td>将现有的项目中的内容弄出来验证规范后，开始实施</td>
</tr>
<tr>
<td>抽取操作中用到的azkaban的主要类</td>
<td>准备实例化这些类的成员变量</td>
<td>这些成员变量或许比直接插入mysql内容差不多难搞</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="2-实施"><a href="#2-实施" class="headerlink" title="2. 实施"></a>2. 实施</h3><h4 id="2-1-获取session-id"><a href="#2-1-获取session-id" class="headerlink" title="2.1 获取session-id"></a>2.1 获取session-id</h4><p>鉴于时间因素，获取session-id的方案：</p>
<blockquote>
<p>curl -k -X POST –data “username=azkaban&amp;password=azkaban&amp;action=login” <a href="http://10.1.5.66:8001" target="_blank" rel="external">http://10.1.5.66:8001</a><br>返回值：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"status"</span> : <span class="string">"success"</span>,</div><div class="line">  <span class="attr">"session.id"</span> : <span class="string">"4e3da52b-fa1f-478d-836c-42122ced2341"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>解析session-id的脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">curl -k -X POST --data <span class="string">"username=azkaban&amp;password=azkaban&amp;action=login"</span> http://10.1.5.66:8001 &gt; etl_tmp</div><div class="line">session_id=`cat etl_tmp | grep session | awk -F\<span class="string">" '!/[&#123;&#125;]/&#123;print <span class="variable">$(NF-1)</span>&#125;'`</span></div><div class="line">echo "we got session id : <span class="variable">$session_id</span><span class="string">"</span></div></pre></td></tr></table></figure></p>
<h4 id="2-2-创建project"><a href="#2-2-创建project" class="headerlink" title="2.2  创建project"></a>2.2  创建project</h4><p>这里其实先安装了一个shell的json解析工具JSON.sh：<a href="https://github.com/dominictarr/JSON.sh" target="_blank" rel="external">https://github.com/dominictarr/JSON.sh</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">curl -k -X POST --data <span class="string">"session.id=<span class="variable">$&#123;session_id&#125;</span>&amp;name=<span class="variable">$&#123;project_name&#125;</span>&amp;description=<span class="variable">$&#123;project_desc&#125;</span>"</span> http://<span class="variable">$&#123;host&#125;</span>/manager?action=create &gt; <span class="variable">$&#123;etl_tmp&#125;</span></div><div class="line">status=`cat <span class="variable">$&#123;etl_tmp&#125;</span> | JSON.sh -b| grep status | awk <span class="string">'&#123;print($2)&#125;'</span>`</div><div class="line"><span class="keyword">if</span> [ <span class="variable">$status</span> != <span class="string">'"success"'</span> ]; <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"error happends when creting project <span class="variable">$&#123;project_name&#125;</span>. status is <span class="variable">$&#123;status&#125;</span>"</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"project <span class="variable">$&#123;project_name&#125;</span> has been created successfully."</span></div></pre></td></tr></table></figure></p>
<h4 id="2-3-上传zip文件"><a href="#2-3-上传zip文件" class="headerlink" title="2.3 上传zip文件"></a>2.3 上传zip文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">curl -k -i -H <span class="string">"Content-Type: multipart/mixed"</span> -X POST --form <span class="string">"session.id=<span class="variable">$&#123;session_id&#125;</span>"</span> --form <span class="string">'ajax=upload'</span> --form <span class="string">"file=@<span class="variable">$&#123;project_zip_file&#125;</span>"</span> --form <span class="string">"project=<span class="variable">$&#123;project_name&#125;</span>"</span> http://<span class="variable">$&#123;host&#125;</span>/manager?ajax=upload &gt; <span class="variable">$&#123;etl_tmp&#125;</span></div><div class="line">status=`cat <span class="variable">$&#123;etl_tmp&#125;</span> | awk <span class="string">'&#123;if(index($0,"error") &gt; 0) print("error")&#125;'</span>`</div><div class="line"><span class="keyword">if</span> [ <span class="variable">$status</span> == <span class="string">"error"</span> ]; <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"error happends when uploading project <span class="variable">$&#123;project_name&#125;</span>. status is <span class="variable">$&#123;status&#125;</span>"</span></div><div class="line">        <span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"uploading project <span class="variable">$&#123;project_name&#125;</span> successfully"</span></div></pre></td></tr></table></figure>
<p>ps: 没有继续使用JSON.sh的原因是解析报错…看来还是不健全</p>
<h4 id="2-4-执行flow"><a href="#2-4-执行flow" class="headerlink" title="2.4 执行flow"></a>2.4 执行flow</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">curl -k --get --data <span class="string">"session.id=<span class="variable">$&#123;session_id&#125;</span>&amp;ajax=fetchprojectflows&amp;project=<span class="variable">$&#123;project_name&#125;</span>"</span> http://<span class="variable">$&#123;host&#125;</span>/manager &gt; <span class="variable">$&#123;etl_tmp&#125;</span></div><div class="line"><span class="keyword">for</span> flow <span class="keyword">in</span> `cat <span class="variable">$&#123;etl_tmp&#125;</span> |  JSON.sh -b | grep flowId |  awk <span class="string">'&#123;gsub("\"","",$2);print($2)&#125;'</span>`</div><div class="line"><span class="keyword">do</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"flow is <span class="variable">$flow</span>, ready to execute"</span></div><div class="line">        curl -k --get --data <span class="string">"session.id=<span class="variable">$&#123;session_id&#125;</span>"</span> --data <span class="string">'ajax=executeFlow'</span> --data <span class="string">"project=<span class="variable">$&#123;project_name&#125;</span>"</span> --data <span class="string">"flow=<span class="variable">$&#123;flow&#125;</span>"</span> http://<span class="variable">$&#123;host&#125;</span>/executor &gt;<span class="variable">$&#123;etl_tmp&#125;</span><span class="variable">$&#123;flow&#125;</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$flow</span> execution done"</span></div><div class="line"><span class="keyword">done</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"all flows for project <span class="variable">$&#123;project_name&#125;</span> has been executed"</span></div></pre></td></tr></table></figure>
<h3 id="3-shell全文"><a href="#3-shell全文" class="headerlink" title="3.shell全文"></a>3.shell全文</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line">etl_tmp=/tmp/etl_tmp_log</div><div class="line">host=10.0.1.62:8081</div><div class="line">metamap_host=10.0.1.62:8088</div><div class="line">project_desc=daily_schedule</div><div class="line"></div><div class="line"><span class="comment"># 调用生成job的任务，返回任务名称或者失败信息</span></div><div class="line">curl -X GET http://<span class="variable">$&#123;metamap_host&#125;</span>/metamap/etls/generate_job_dag/ &gt; <span class="variable">$&#123;etl_tmp&#125;</span></div><div class="line">filename=`cat <span class="variable">$&#123;etl_tmp&#125;</span>`</div><div class="line"><span class="keyword">if</span> [ <span class="variable">$filename</span> == <span class="string">"error"</span> -o <span class="variable">$&#123;#filename&#125;</span> <span class="_">-ne</span> 14 ]; <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"error happends when generate Job Scripts. ori_filename is <span class="variable">$&#123;filename&#125;</span>"</span></div><div class="line">	<span class="built_in">echo</span> <span class="string">"length is <span class="variable">$&#123;#filename&#125;</span>"</span></div><div class="line">        <span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line">project_name=etl_<span class="variable">$&#123;filename&#125;</span></div><div class="line">project_zip_file=/tmp/<span class="variable">$&#123;filename&#125;</span>.zip</div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"project_name is <span class="variable">$&#123;project_name&#125;</span>"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"project_zip_file is <span class="variable">$&#123;project_zip_file&#125;</span>"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"azkaban host is <span class="variable">$&#123;host&#125;</span>"</span></div><div class="line"></div><div class="line"><span class="comment"># 获取session id</span></div><div class="line">curl -k -X POST --data <span class="string">"username=azkaban&amp;password=azkaban&amp;action=login"</span> http://<span class="variable">$&#123;host&#125;</span> &gt; <span class="variable">$&#123;etl_tmp&#125;</span></div><div class="line"><span class="built_in">echo</span> result is `cat <span class="variable">$&#123;etl_tmp&#125;</span>`</div><div class="line">session_id=`cat <span class="variable">$&#123;etl_tmp&#125;</span> | grep session | awk -F\<span class="string">" '!/[&#123;&#125;]/&#123;print <span class="variable">$(NF-1)</span>&#125;'`</span></div><div class="line">echo "we got session id : <span class="variable">$session_id</span><span class="string">"</span></div><div class="line"></div><div class="line">### 创建project</div><div class="line">echo "project name is <span class="variable">$&#123;project_name&#125;</span><span class="string">"</span></div><div class="line">curl -k -X POST --data "session.id=<span class="variable">$&#123;session_id&#125;</span>&amp;name=<span class="variable">$&#123;project_name&#125;</span>&amp;description=<span class="variable">$&#123;project_desc&#125;</span><span class="string">" http://<span class="variable">$&#123;host&#125;</span>/manager?action=create &gt; <span class="variable">$&#123;etl_tmp&#125;</span></span></div><div class="line">status=`cat <span class="variable">$&#123;etl_tmp&#125;</span> | JSON.sh -b| grep status | awk '&#123;print(<span class="variable">$2</span>)&#125;'` </div><div class="line">if [ <span class="variable">$status</span> != '"success<span class="string">"' ]; then</span></div><div class="line">        echo "error happends when creting project <span class="variable">$&#123;project_name&#125;</span>. status is <span class="variable">$&#123;status&#125;</span><span class="string">"</span></div><div class="line">	exit 1</div><div class="line">fi</div><div class="line">echo "project <span class="variable">$&#123;project_name&#125;</span> has been created successfully.<span class="string">"</span></div><div class="line"></div><div class="line"># 上传zip文件到指定project</div><div class="line">curl -k -i -H "Content-Type: multipart/mixed<span class="string">" -X POST --form "</span>session.id=<span class="variable">$&#123;session_id&#125;</span><span class="string">" --form 'ajax=upload' --form "</span>file=@<span class="variable">$&#123;project_zip_file&#125;</span><span class="string">" --form "</span>project=<span class="variable">$&#123;project_name&#125;</span><span class="string">" http://<span class="variable">$&#123;host&#125;</span>/manager?ajax=upload &gt; <span class="variable">$&#123;etl_tmp&#125;</span></span></div><div class="line">status=`cat <span class="variable">$&#123;etl_tmp&#125;</span> | awk '&#123;if(index(<span class="variable">$0</span>,"error<span class="string">") &gt; 0) print("</span>error<span class="string">")&#125;'`</span></div><div class="line">if [[ <span class="variable">$status</span> = "error<span class="string">" ]]; then</span></div><div class="line">        echo "error happends when uploading project <span class="variable">$&#123;project_name&#125;</span>. status is <span class="variable">$&#123;status&#125;</span><span class="string">"</span></div><div class="line">        exit 1</div><div class="line">fi</div><div class="line">echo "uploading project <span class="variable">$&#123;project_name&#125;</span> successfully<span class="string">"</span></div><div class="line"></div><div class="line"># </div><div class="line"># 阻塞检察某个execution的进度</div><div class="line">#</div><div class="line">function check_exec_status()&#123;</div><div class="line">	execid=<span class="variable">$1</span></div><div class="line">	sleep 1h</div><div class="line">	#查看前execution的执行状态，完成后退出</div><div class="line">	status=RUNNING</div><div class="line">	until [ <span class="variable">$status</span> == '"SUCCEEDED<span class="string">"' ]</span></div><div class="line">	do</div><div class="line">    		curl -k --get --data "session.id=<span class="variable">$&#123;session_id&#125;</span>&amp;ajax=fetchexecflowupdate&amp;execid=<span class="variable">$&#123;execid&#125;</span>&amp;lastUpdateTime=-1<span class="string">" http://<span class="variable">$&#123;host&#125;</span>/executor &gt; <span class="variable">$&#123;etl_tmp&#125;</span></span></div><div class="line">    		status=`cat <span class="variable">$&#123;etl_tmp&#125;</span> | JSON.sh -b| grep status | grep -v node | awk '&#123;print(<span class="variable">$2</span>)&#125;'`</div><div class="line">		if [ <span class="variable">$status</span> == '"KILLED<span class="string">"' ]; then</span></div><div class="line">			echo "<span class="variable">$&#123;execid&#125;</span> has been killed.<span class="string">"</span></div><div class="line">			break</div><div class="line">		elif [ <span class="variable">$status</span> == '"FAILED<span class="string">"' ]; then</span></div><div class="line">                        echo "<span class="variable">$&#123;execid&#125;</span> has been failed.<span class="string">"</span></div><div class="line">                        break</div><div class="line">		fi</div><div class="line">    		echo "<span class="variable">$&#123;execid&#125;</span> not yet...<span class="string">" `cat <span class="variable">$&#123;etl_tmp&#125;</span>`</span></div><div class="line">		sleep 10m	</div><div class="line">	done</div><div class="line">&#125;</div><div class="line"></div><div class="line"># 遍历执行project下的flow</div><div class="line">curl -k --get --data "session.id=<span class="variable">$&#123;session_id&#125;</span>&amp;ajax=fetchprojectflows&amp;project=<span class="variable">$&#123;project_name&#125;</span><span class="string">" http://<span class="variable">$&#123;host&#125;</span>/manager &gt; <span class="variable">$&#123;etl_tmp&#125;</span></span></div><div class="line">for flow in `cat <span class="variable">$&#123;etl_tmp&#125;</span> |  JSON.sh -b | grep flowId |  awk '&#123;gsub("\<span class="string">""</span>,<span class="string">""</span>,<span class="variable">$2</span>);<span class="built_in">print</span>(<span class="variable">$2</span>)&#125;<span class="string">'`</span></div><div class="line">do</div><div class="line">        echo "flow is $flow, ready to execute"</div><div class="line">        curl -k --get --data "session.id=$&#123;session_id&#125;" --data 'ajax=executeFlow<span class="string">' --data "project=$&#123;project_name&#125;" --data "flow=$&#123;flow&#125;" --data "failureAction=finishPossible" http://$&#123;host&#125;/executor &gt;$&#123;etl_tmp&#125;$&#123;flow&#125;</span></div><div class="line">        execid=`cat $&#123;etl_tmp&#125;$&#123;flow&#125; | JSON.sh -b| grep execid | awk '&#123;<span class="built_in">print</span>(<span class="variable">$2</span>)&#125;<span class="string">'`</span></div><div class="line">	echo "got execid : $&#123;execid&#125;"</div><div class="line">	check_exec_status $&#123;execid&#125;</div><div class="line">echo "$flow execution done"</div><div class="line">done</div><div class="line">echo "all flows for project $&#123;project_name&#125; has been executed"</div></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> ETL </tag>
            
            <tag> 调度平台 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[一步步搞定ETL依赖调度平台（一）]]></title>
      <url>/2016/06/15/%E4%B8%80%E6%AD%A5%E6%AD%A5%E6%90%9E%E5%AE%9AETL%E4%BE%9D%E8%B5%96%E8%B0%83%E5%BA%A6%E5%B9%B3%E5%8F%B0%EF%BC%88%E4%B8%80%EF%BC%89/</url>
      <content type="html"><![CDATA[<h3 id="1-依赖解析"><a href="#1-依赖解析" class="headerlink" title="1. 依赖解析"></a>1. 依赖解析</h3><ul>
<li>sql AST解析。相关工具antlr,这是一个定义与解析特定语言的工具。</li>
<li>hive denpendency： explain dependency select * from a.</li>
<li>其他sql解析工具，功能类似hive dependency</li>
</ul>
<p>鉴于我们的数据仓库使用hive搭建，使用hive dependency的兼容性更有保证。注意两点：1.如果a表不存在与hive中，就会报错找不到table。也就是说ETL开发的时候，它的依赖必须已经存在与hive库里；2. 由于依赖解析功能在ETL开发平台上，所以必须通过hiveserver2进行访问，效率可能不高，但是ETL平台对此要求也不会太高。</p>
<p>需要额外说一下antlr的好处：一是可以深入剖析sql，在这一层做字段级别的权限控制；二是可以做一些sql的分析，反馈给ETL开发者一些优化建议；</p>
<h3 id="2-存库"><a href="#2-存库" class="headerlink" title="2. 存库"></a>2. 存库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">-- ----------------------------</span></div><div class="line"><span class="comment">-- Table structure for etl</span></div><div class="line"><span class="comment">-- ----------------------------</span></div><div class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`etl`</span>;</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`etl`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</div><div class="line">  <span class="string">`query`</span> <span class="built_in">varchar</span>(<span class="number">2000</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'sql语句'</span>,</div><div class="line">  <span class="string">`meta`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'数据库'</span>,</div><div class="line">  <span class="string">`tbl_name`</span> <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'表名'</span>,</div><div class="line">  <span class="string">`author`</span> <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建人'</span>,</div><div class="line">  <span class="string">`pre_sql`</span> <span class="built_in">varchar</span>(<span class="number">2000</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'先执行的sql'</span>,</div><div class="line">  <span class="string">`priority`</span> <span class="built_in">int</span>(<span class="number">5</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'5'</span>,</div><div class="line">  <span class="string">`on_schedule`</span> tinyint(<span class="number">4</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'0 不调度 1 调度中'</span>,</div><div class="line">  <span class="string">`valid`</span> tinyint(<span class="number">4</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`ctime`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`utime`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">19</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">-- ----------------------------</span></div><div class="line"><span class="comment">-- Table structure for tbl_blood</span></div><div class="line"><span class="comment">-- ----------------------------</span></div><div class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`tbl_blood`</span>;</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`tbl_blood`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</div><div class="line">  <span class="string">`tbl_name`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`parent_tbl`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`related_etl_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`valid`</span> tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</div><div class="line">  <span class="string">`ctime`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</div><div class="line">  <span class="string">`utime`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">21</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</div></pre></td></tr></table></figure>
<p>每当新建一个ETL的时候都会分析它的依赖，如果分析失败，就不会插入ETL。</p>
<p>另外补充一个字段和表关系的，从hive meta库查询sql<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span></div><div class="line">	db.DB_ID <span class="keyword">AS</span> db_id,</div><div class="line">	db.<span class="string">`NAME`</span> <span class="keyword">AS</span> db_name,</div><div class="line">	a.TBL_ID <span class="keyword">AS</span> tbl_id,</div><div class="line">	a.TBL_NAME <span class="keyword">AS</span> tbl_name,</div><div class="line">	a.TBL_TYPE <span class="keyword">AS</span> tbl_type,</div><div class="line">	d.TYPE_NAME <span class="keyword">AS</span> col_type_name,</div><div class="line">	d.<span class="string">`COMMENT`</span> <span class="keyword">AS</span> col_comment,</div><div class="line">	d.COLUMN_NAME <span class="keyword">AS</span> column_name</div><div class="line"><span class="keyword">FROM</span></div><div class="line">	TBLS a</div><div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> SDS b <span class="keyword">ON</span> a.SD_ID = b.SD_ID</div><div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> COLUMNS_V2 d <span class="keyword">ON</span> b.CD_ID = d.CD_ID</div><div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> DBS db <span class="keyword">ON</span> a.DB_ID = db.DB_ID</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="3-每日调度"><a href="#3-每日调度" class="headerlink" title="3.每日调度"></a>3.每日调度</h3><p>有了以上两步之后剩下的就是每日调度问题。分以下几个步骤：</p>
<ol>
<li>通过azkaban api创建一个project: etl_20160615;</li>
<li>调用java程序根据tbl_blood和etl内容生成azkaban的项目文件20160615.zip;</li>
<li>通过azkaban api上传此文件到etl_20160615的project上</li>
<li>通过azkaban api遍历etl_20160615项目下的所有flow，进行调度。</li>
</ol>
<p>生成azkaban文件的逻辑：</p>
<ol>
<li>找出没有被任何其他ETL以来的叶子节点</li>
<li>遍历所有叶子节点，找到这个叶子节点的所有有效依赖，放入dependencies里，如果尚未生成该ETL的job文件</li>
<li>向上递归执行，直到没有dependency的节点，也就是最上一层节点就停止。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">generateAzkabanDAG</span><span class="params">()</span> <span class="keyword">throws</span> MetaException, ArchiveException </span>&#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           String serFolder = DateUtil.getTodayDateTime();</div><div class="line">           List&lt;TblBlood&gt; leafBlood = tblBloodDao.selectAllLeaf();</div><div class="line">           Set&lt;String&gt; doneBlood = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">           String serFolderLocation = AZKABAN_BASE_LOCATION + serFolder;</div><div class="line">           <span class="keyword">if</span> (leafBlood.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">               loadLeafBloods(leafBlood, doneBlood, serFolderLocation);</div><div class="line">           &#125;</div><div class="line">           </div><div class="line">           ZipUtils.addFilesToZip(<span class="keyword">new</span> File(serFolderLocation), </div><div class="line">                   <span class="keyword">new</span> File(serFolderLocation + <span class="string">".zip"</span>));</div><div class="line">       &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">           log.error(<span class="string">"error happends when generateAzkabanDAG"</span>);</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> MetaException(<span class="string">"error happends when generateAzkabanDAG"</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   </div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadLeafBloods</span><span class="params">(List&lt;TblBlood&gt; leafBlood, Set&lt;String&gt; doneBlood, String serFolder)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">       <span class="keyword">for</span> (TblBlood leaf : leafBlood) &#123;</div><div class="line">           List&lt;TblBlood&gt; parentNode = tblBloodDao.selectParentByTblName(leaf.getTblName());</div><div class="line">           <span class="keyword">if</span> (!doneBlood.contains(leaf.getTblName())) &#123;</div><div class="line">               generateJobFile(leaf, parentNode, serFolder);</div><div class="line">               doneBlood.add(leaf.getTblName());</div><div class="line">           &#125;</div><div class="line">           loadLeafBloods(parentNode, doneBlood, serFolder);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">generateJobFile</span><span class="params">(TblBlood currentBlood,  List&lt;TblBlood&gt; parentNode, String serFolder)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"></div><div class="line">       String jobName = currentBlood.getTblName();</div><div class="line">       String jobType = <span class="string">"command"</span>;</div><div class="line">       String command = <span class="string">"echo 'I am command for ' "</span> + jobName;</div><div class="line">       String content;</div><div class="line">       Set&lt;String&gt; dependencies = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">       <span class="keyword">for</span> (TblBlood blood : parentNode) &#123;</div><div class="line">           dependencies.add(blood.getTblName());</div><div class="line">       &#125;</div><div class="line">       String jobDependencies = joiner.join(dependencies);</div><div class="line">       content = <span class="string">"# "</span> + jobName + <span class="string">"\n"</span></div><div class="line">               + <span class="string">"type="</span> + jobType +<span class="string">"\n"</span></div><div class="line">                       + <span class="string">"command="</span> + command + <span class="string">"\n"</span>;</div><div class="line">       <span class="keyword">if</span> (StringUtils.isNotBlank(jobDependencies)) &#123;</div><div class="line">           content += <span class="string">"dependencies="</span> + jobDependencies +<span class="string">"\n"</span>;</div><div class="line">       &#125;</div><div class="line">       File file = <span class="keyword">new</span> File(serFolder + <span class="string">"/"</span> + jobName.replace(<span class="string">"@"</span>, <span class="string">"-"</span>) + <span class="string">".job"</span>);</div><div class="line">       FileUtils.write(file, content, <span class="string">"utf8"</span>, <span class="keyword">false</span>);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h3 id="4-参考"><a href="#4-参考" class="headerlink" title="4.参考"></a>4.参考</h3><p><a href="http://azkaban.github.io/azkaban/docs/latest/#ajax-api" target="_blank" rel="external">http://azkaban.github.io/azkaban/docs/latest/#ajax-api</a></p>
<h3 id="5-TODO"><a href="#5-TODO" class="headerlink" title="5. TODO"></a>5. TODO</h3><ul>
<li>flow和job目前都是不支持优先级的，需要探查下azkaban中同一个flow里job执行次序是怎样的。</li>
<li>目前字段解析只能通过部分从hive meta抽，获取到字段与当前表的关系，不能逐个找到字段与字段之间的血统关系。如果使用antlr的话可以分析到每一个as之前是什么，理论上是可以实现字段的血统关系的。</li>
<li>对于每月、每周、每小时的个别ETL的支持策略</li>
<li>支持ETL变量传入和临时调试</li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> ETL </tag>
            
            <tag> 调度平台 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[azkaban源码追踪（二）-单次调度flow]]></title>
      <url>/2016/06/15/azkaban%E6%BA%90%E7%A0%81%E8%BF%BD%E8%B8%AA-%E5%8D%95%E6%AC%A1%E8%B0%83%E5%BA%A6flow/</url>
      <content type="html"><![CDATA[<p>对应的操作是进入到某个project中，然后单次执行下面的某个flow。会触发web-server这边与exec-server的远程调用去执行flow。</p>
<h4 id="相关类"><a href="#相关类" class="headerlink" title="相关类"></a>相关类</h4><ul>
<li>Web-server<ul>
<li>ExecutorServlet.doGet</li>
<li>ExecutorManager</li>
</ul>
</li>
<li>exec-server<ul>
<li>ExecutorServlet.doGet</li>
<li>FlowRunnerManager</li>
<li>FlowRunner</li>
<li>ExecutableFlowBase</li>
<li>ExecutableNode</li>
<li>JobRunner</li>
<li>JobTypeManager</li>
<li>Job</li>
<li>AzkabanProcessBuilder</li>
</ul>
</li>
</ul>
<p>#### </p>
]]></content>
      
        
        <tags>
            
            <tag> 源码 </tag>
            
            <tag> azkaban </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[azkaban源码追踪（一）-uploadProject流程]]></title>
      <url>/2016/06/15/azkaban%E6%BA%90%E7%A0%81%E8%BF%BD%E8%B8%AA%EF%BC%88%E4%B8%80%EF%BC%89-uploadProject%E6%B5%81%E7%A8%8B/</url>
      <content type="html"><![CDATA[<h4 id="1-相关类"><a href="#1-相关类" class="headerlink" title="1. 相关类"></a>1. 相关类</h4><ul>
<li>ProjectMangerServlet</li>
<li>ProjectManager</li>
<li>ValidatorManager</li>
<li>DirectoryFlowLoader</li>
<li>JdbcProjectLoader</li>
</ul>
<h4 id="2-对应的流程log"><a href="#2-对应的流程log" class="headerlink" title="2. 对应的流程log"></a>2. 对应的流程log</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">2016/06/14 15:39:18.537 +0800 INFO [ProjectManagerServlet] [Azkaban] Uploading file willjob.zip</div><div class="line">2016/06/14 15:39:23.861 +0800 INFO [ProjectManager] [Azkaban] Uploading files to mytestProject</div><div class="line">2016/06/14 15:40:16.454 +0800 WARN [XmlValidatorManager] [Azkaban] Validator directory validators does not exist or is not a directory</div><div class="line">2016/06/14 15:40:16.455 +0800 WARN [XmlValidatorManager] [Azkaban] Azkaban properties file does not contain the key project.validators</div><div class="line">2016/06/14 15:40:35.752 +0800 INFO [ProjectManager] [Azkaban] Validating project willjob.zip using the registered validators [Director</div><div class="line">2016/06/14 16:11:45.952 +0800 INFO [XmlValidatorManager] [Azkaban] Validation status of validator Directory Flow is PASS</div><div class="line">2016/06/14 16:56:51.338 +0800 INFO [ProjectManager] [Azkaban] Uploading file to db willjob.zip</div><div class="line">2016/06/14 16:56:51.338 +0800 INFO [JdbcProjectLoader] [Azkaban] Uploading to mytestProject version:1 file:willjob.zip</div><div class="line">2016/06/14 16:56:51.341 +0800 INFO [JdbcProjectLoader] [Azkaban] Creating message digest for upload willjob.zip</div><div class="line">2016/06/14 16:56:51.343 +0800 INFO [JdbcProjectLoader] [Azkaban] Md5 hash created</div><div class="line">2016/06/14 16:56:51.359 +0800 INFO [JdbcProjectLoader] [Azkaban] Read bytes for willjob.zip size:560</div><div class="line">2016/06/14 16:56:51.359 +0800 INFO [JdbcProjectLoader] [Azkaban] Running update for willjob.zip chunk 0</div><div class="line">2016/06/14 16:56:51.360 +0800 INFO [JdbcProjectLoader] [Azkaban] Finished update for willjob.zip chunk 0</div><div class="line">2016/06/14 16:56:51.362 +0800 INFO [JdbcProjectLoader] [Azkaban] Commiting upload willjob.zip</div><div class="line">2016/06/14 16:56:51.363 +0800 INFO [ProjectManager] [Azkaban] Uploading flow to db willjob.zip</div><div class="line">2016/06/14 16:56:51.363 +0800 INFO [JdbcProjectLoader] [Azkaban] Uploading flows</div><div class="line">2016/06/14 16:56:51.418 +0800 INFO [JdbcProjectLoader] [Azkaban] Flow upload will3 is byte size 214</div><div class="line">2016/06/14 16:56:51.432 +0800 INFO [JdbcProjectLoader] [Azkaban] Flow upload will2 is byte size 238</div><div class="line">2016/06/14 16:56:51.434 +0800 INFO [ProjectManager] [Azkaban] Changing project versions willjob.zip</div><div class="line">2016/06/14 16:56:51.436 +0800 INFO [ProjectManager] [Azkaban] Uploading Job properties</div><div class="line">2016/06/14 16:56:51.820 +0800 INFO [ProjectManager] [Azkaban] Uploading Props properties</div><div class="line">2016/06/14 16:56:51.822 +0800 INFO [ProjectManager] [Azkaban] Uploaded project files. Cleaning up temp files.</div><div class="line">2016/06/14 16:56:51.927 +0800 INFO [ProjectManager] [Azkaban] Cleaning up old install files older than -2</div></pre></td></tr></table></figure>
<h4 id="3-ProjectManager"><a href="#3-ProjectManager" class="headerlink" title="3. ProjectManager"></a>3. ProjectManager</h4><p>白话一下ProjectManager处理上传zip文件的过程：</p>
<ol>
<li>将文件存到/tmp目录并解压</li>
<li>使用DirectoryFlowLoader解析文件，放置到这个loader的状态变量中。这些变量会一直保存在内存里，以供后面使用</li>
<li>遍历loader里的flowMap，把每个flow都加上最新的project_id和version</li>
<li>上传project信息<ul>
<li>4.1 把zip文件弄成字节流上传到mysql的project_files表中</li>
<li>4.2 把最新版本的project信息上传到project_versions表中</li>
</ul>
</li>
<li>上传flow: 把flow逐个序列化成json，再弄成byte字节流，再使用gzip压缩，上传至project_flows表中</li>
<li>更新projects里的相关记录，并修改内存中的project信息【修改时间等、最新版本的flows】</li>
<li>上传job的详细信息到project_properties中，job的详细信息也是json-&gt;byte[]-&gt;gzip的过程</li>
<li>上传props的详细信息到project_properties中，流程同job完全一样【这个debug的时候数据是空的】</li>
<li>将此次操作插入到project_event中，之后删除本地/tmp下的文件</li>
<li>使用project_id和当前version判断依次清除先前版本的project_flows的flow、project_properties、project_files、project_versions中的记录【会有最近版本保留数量设置project.version.retention，默认是3】</li>
<li>完成<br><img src="/imgs/azkaban/azkaban-upload-zip-handleflow.png" alt="azkaban上传zip很粗糙的流程图"><h4 id="4-文件解析"><a href="#4-文件解析" class="headerlink" title="4. 文件解析"></a>4. 文件解析</h4>DirectoryFlowLoader加载文件目录，解析所有的文件，进行解析，将信息存放在自己的状态变量中：<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Props props;                          <span class="comment">// 环境、配置信息</span></div><div class="line"><span class="keyword">private</span> HashSet&lt;String&gt; rootNodes;            <span class="comment">// 根节点，也就是实际执行的时候的起始节点</span></div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Flow&gt; flowMap;        <span class="comment">// 所有的flow，key是flowId</span></div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Node&gt; nodeMap;        <span class="comment">// 所有的node，key是JobId或者embed的flowId</span></div><div class="line"><span class="comment">// node之间的dependency，key是job名称，value是一系列的相关依赖job，一般是children，然后Edge指定从谁到谁</span></div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Map&lt;String, Edge&gt;&gt; nodeDependencies;  </div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Props&gt; jobPropsMap;   <span class="comment">// 包含job的详细信息</span></div><div class="line"></div><div class="line"><span class="comment">// flow之间的依赖关系【embedeed flow】</span></div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Set&lt;String&gt;&gt; flowDependencies;</div><div class="line"></div><div class="line"><span class="keyword">private</span> ArrayList&lt;FlowProps&gt; flowPropsList;</div><div class="line"><span class="keyword">private</span> ArrayList&lt;Props&gt; propsList;</div><div class="line"><span class="keyword">private</span> Set&lt;String&gt; errors;</div><div class="line"><span class="keyword">private</span> Set&lt;String&gt; duplicateJobs;</div></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 临时解压目录 baseDirectory : temp/46769225</span></div><div class="line"><span class="comment">// 项目信息 project: testPro</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadProjectFlow</span><span class="params">(Project project, File baseDirectory)</span> </span>&#123;</div><div class="line">    propsList = <span class="keyword">new</span> ArrayList&lt;Props&gt;();</div><div class="line">    flowPropsList = <span class="keyword">new</span> ArrayList&lt;FlowProps&gt;();</div><div class="line">    jobPropsMap = <span class="keyword">new</span> HashMap&lt;String, Props&gt;();</div><div class="line">    nodeMap = <span class="keyword">new</span> HashMap&lt;String, Node&gt;();</div><div class="line">    flowMap = <span class="keyword">new</span> HashMap&lt;String, Flow&gt;();</div><div class="line">    errors = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">    duplicateJobs = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">    nodeDependencies = <span class="keyword">new</span> HashMap&lt;String, Map&lt;String, Edge&gt;&gt;();</div><div class="line">    rootNodes = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">    flowDependencies = <span class="keyword">new</span> HashMap&lt;String, Set&lt;String&gt;&gt;();</div><div class="line"></div><div class="line">    <span class="comment">// 加载所有的properties、job文件，创建node对象</span></div><div class="line">    loadProjectFromDir(baseDirectory.getPath(), baseDirectory, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    jobPropertiesCheck(project);</div><div class="line"></div><div class="line">    <span class="comment">// Create edges and find missing dependencies</span></div><div class="line">    resolveDependencies();</div><div class="line"></div><div class="line">    <span class="comment">// 创建flows. 在此之后flowMap里就已经构建好了flow以及job之间的依赖了，node之间通过level来界定先后关系</span></div><div class="line">    buildFlowsFromDependencies();</div><div class="line"></div><div class="line">    <span class="comment">// 处理embedded flows，就是嵌入的flow</span></div><div class="line">    resolveEmbeddedFlows();</div><div class="line"></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h5 id="loadProjectFromDir方法详细"><a href="#loadProjectFromDir方法详细" class="headerlink" title="loadProjectFromDir方法详细"></a>loadProjectFromDir方法详细</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadProjectFromDir</span><span class="params">(String base, File dir, Props parent)</span> </span>&#123;</div><div class="line">  <span class="comment">// 找出所有的properties</span></div><div class="line">  File[] propertyFiles = dir.listFiles(<span class="keyword">new</span> SuffixFilter(PROPERTY_SUFFIX));</div><div class="line">  Arrays.sort(propertyFiles);</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (File file : propertyFiles) &#123;</div><div class="line">      String relative = getRelativeFilePath(base, file.getPath());</div><div class="line">      parent = <span class="keyword">new</span> Props(parent, file);</div><div class="line">      parent.setSource(relative);</div><div class="line">      FlowProps flowProps = <span class="keyword">new</span> FlowProps(parent);</div><div class="line">      flowPropsList.add(flowProps);</div><div class="line">      logger.info(<span class="string">"Adding "</span> + relative);</div><div class="line">      propsList.add(parent);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 加载job文件</span></div><div class="line">  File[] jobFiles = dir.listFiles(<span class="keyword">new</span> SuffixFilter(JOB_SUFFIX));</div><div class="line">  <span class="keyword">for</span> (File file : jobFiles) &#123;</div><div class="line">    String jobName = getNameWithoutExtension(file);</div><div class="line">      <span class="keyword">if</span> (!duplicateJobs.contains(jobName)) &#123;</div><div class="line">        <span class="keyword">if</span> (jobPropsMap.containsKey(jobName)) &#123;</div><div class="line">          <span class="comment">// 是否有重复</span></div><div class="line">          ... </div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          Props prop = <span class="keyword">new</span> Props(parent, file);</div><div class="line">          String relative = getRelativeFilePath(base, file.getPath());</div><div class="line">          prop.setSource(relative);</div><div class="line"></div><div class="line">          Node node = <span class="keyword">new</span> Node(jobName);</div><div class="line">          String type = prop.getString(<span class="string">"type"</span>, <span class="keyword">null</span>);</div><div class="line">          <span class="keyword">if</span> (type == <span class="keyword">null</span>) &#123;</div><div class="line">            errors.add(<span class="string">"Job doesn't have type set '"</span> + jobName + <span class="string">"'."</span>);</div><div class="line">          &#125;</div><div class="line">          node.setType(type); <span class="comment">// job类型</span></div><div class="line">          node.setJobSource(relative);    <span class="comment">// job相对路径</span></div><div class="line">          <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</div><div class="line">            node.setPropsSource(parent.getSource());</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="comment">// Force root node</span></div><div class="line">          <span class="keyword">if</span> (prop.getBoolean(CommonJobProperties.ROOT_NODE, <span class="keyword">false</span>)) &#123;</div><div class="line">            rootNodes.add(jobName);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="comment">// 把properties和node放进loader中的队列中</span></div><div class="line">          jobPropsMap.put(jobName, prop);</div><div class="line">          nodeMap.put(jobName, node);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 检查是否有子目录</span></div><div class="line">  File[] subDirs = dir.listFiles(DIR_FILTER);</div><div class="line">  <span class="keyword">for</span> (File file : subDirs) &#123;</div><div class="line">    loadProjectFromDir(base, file, parent);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="常用的blob处理代码"><a href="#常用的blob处理代码" class="headerlink" title="常用的blob处理代码"></a>常用的blob处理代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">String propertyJSON = PropsUtils.toJSONString(props, <span class="keyword">true</span>);</div><div class="line">   <span class="keyword">byte</span>[] data = propertyJSON.getBytes(<span class="string">"UTF-8"</span>);</div><div class="line">   <span class="keyword">if</span> (defaultEncodingType == EncodingType.GZIP) &#123;</div><div class="line">     data = GZIPUtils.gzipBytes(data);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h4 id="5-其他"><a href="#5-其他" class="headerlink" title="5.其他"></a>5.其他</h4><p><img src="/imgs/azkaban/azkaban-upload-zip-node.png" alt="azkaban上传zip文件时生成的Node结构"></p>
<p>level表示当前node所在的层次。</p>
<p><img src="/imgs/azkaban/Edge-structure.png" alt="azkaban上传zip后内存中表示node连接的Edge结构"></p>
]]></content>
      
        
        <tags>
            
            <tag> 源码 </tag>
            
            <tag> azkaban </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[spring + quartz集群配置全部资料]]></title>
      <url>/2015/12/10/spring-quartz%E9%9B%86%E7%BE%A4%E9%85%8D%E7%BD%AE%E5%85%A8%E9%83%A8%E8%B5%84%E6%96%99/</url>
      <content type="html"><![CDATA[<p>今天玩儿quartz正玩儿的起劲儿，下午就被否掉了，另一个同事已经被分配了相关的工作，那么我这边的工作就重复了。<br>暂时记下目前了解到的一些配置，方便以后使用。</p>
<h3 id="quartz-xml配置文件"><a href="#quartz-xml配置文件" class="headerlink" title="quartz.xml配置文件"></a>quartz.xml配置文件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span></span></div><div class="line">        <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></div><div class="line">        <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">        <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span> = <span class="string">"willtest"</span> <span class="attr">class</span>=<span class="string">"com.will.quartz.task.WillTask"</span>/&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"abnormalDitail"</span> <span class="attr">class</span>=<span class="string">"org.springframework.scheduling.quartz.JobDetailBean"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobClass"</span> <span class="attr">value</span>=<span class="string">"com.will.quartz.task.WillSpringJob"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobDataAsMap"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">map</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"timeout"</span> <span class="attr">value</span>=<span class="string">"5"</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">map</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"anotherJob"</span> <span class="attr">class</span>=<span class="string">"org.springframework.scheduling.quartz.JobDetailBean"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobClass"</span> <span class="attr">value</span>=<span class="string">"com.will.quartz.task.AnotherSJob"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobDataAsMap"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">map</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"timeout"</span> <span class="attr">value</span>=<span class="string">"5"</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">map</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!--  调度触发器 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"abnormalTigger"</span> <span class="attr">class</span>=<span class="string">"org.springframework.scheduling.quartz.CronTriggerBean"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobDetail"</span> <span class="attr">ref</span>=<span class="string">"abnormalDitail"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cronExpression"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>*/5 * * * * ?<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!--  调度触发器 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"anotherJobTigger"</span> <span class="attr">class</span>=<span class="string">"org.springframework.scheduling.quartz.CronTriggerBean"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobDetail"</span> <span class="attr">ref</span>=<span class="string">"anotherJob"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cronExpression"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>*/8 * * * * ?<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"com.mchange.v2.c3p0.ComboPooledDataSource"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClass"</span> <span class="attr">value</span>=<span class="string">"$&#123;database.driverClassName&#125;"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUrl"</span> <span class="attr">value</span>=<span class="string">"$&#123;database.quartz.url&#125;"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">value</span>=<span class="string">"$&#123;database.quartz.username&#125;"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;database.quartz.password&#125;"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"initialPoolSize"</span> <span class="attr">value</span>=<span class="string">"$&#123;pool.initialPoolSize&#125;"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minPoolSize"</span> <span class="attr">value</span>=<span class="string">"$&#123;pool.minPoolSize&#125;"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxPoolSize"</span> <span class="attr">value</span>=<span class="string">"$&#123;pool.maxPoolSize&#125;"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxIdleTime"</span> <span class="attr">value</span>=<span class="string">"$&#123;pool.maxIdleTime&#125;"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"checkoutTimeout"</span> <span class="attr">value</span>=<span class="string">"12000"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"acquireIncrement"</span> <span class="attr">value</span>=<span class="string">"$&#123;pool.acquireIncrement&#125;"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span>  <span class="attr">id</span>=<span class="string">"quartzExceptionSchedulerListener"</span>  <span class="attr">class</span>=<span class="string">"com.will.quartz.task.QuartzExceptionSchedulerListener"</span>/&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- 调度工厂 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"quartzScheduler"</span></span></div><div class="line">      <span class="attr">class</span>=<span class="string">"org.springframework.scheduling.quartz.SchedulerFactoryBean"</span>&gt;</div><div class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"quartzProperties"</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">props</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.scheduler.instanceName"</span>&gt;</span>scheduler<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">                  <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.scheduler.driverDelegateClass"</span>&gt;</span>org.quartz.impl.jdbcjobstore.StdJDBCDelegate<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">                  <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.scheduler.instanceId"</span>&gt;</span>AUTO<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">                     <span class="comment">&lt;!-- 线程池配置 --&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.threadPool.class"</span>&gt;</span>org.quartz.simpl.SimpleThreadPool<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.threadPool.threadCount"</span>&gt;</span>20<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.threadPool.threadPriority"</span>&gt;</span>5<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">                     <span class="comment">&lt;!-- JobStore 配置 --&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.jobStore.class"</span>&gt;</span>org.quartz.impl.jdbcjobstore.JobStoreTX<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line"></div><div class="line">                     <span class="comment">&lt;!-- 集群配置 --&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.jobStore.isClustered"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.jobStore.clusterCheckinInterval"</span>&gt;</span>15000<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.jobStore.maxMisfiresToHandleAtATime"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line"></div><div class="line">                     <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.jobStore.misfireThreshold"</span>&gt;</span>120000<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line"></div><div class="line">                     <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.jobStore.tablePrefix"</span>&gt;</span>QRTZ_<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">              <span class="tag">&lt;/<span class="name">props</span>&gt;</span></div><div class="line"></div><div class="line">       <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"schedulerName"</span> <span class="attr">value</span>=<span class="string">"CRMscheduler"</span> /&gt;</span></div><div class="line"></div><div class="line">       <span class="comment">&lt;!--必须的，QuartzScheduler 延时启动，应用启动完后 QuartzScheduler 再启动 --&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"startupDelay"</span> <span class="attr">value</span>=<span class="string">"30"</span> /&gt;</span></div><div class="line"></div><div class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"applicationContextSchedulerContextKey"</span> <span class="attr">value</span>=<span class="string">"applicationContextKey"</span> /&gt;</span></div><div class="line"></div><div class="line">       <span class="comment">&lt;!--可选，QuartzScheduler 启动时更新己存在的Job，这样就不用每次修改targetObject后删除qrtz_job_details表对应记录了 --&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"overwriteExistingJobs"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></div><div class="line"></div><div class="line">       <span class="comment">&lt;!-- 设置自动启动 --&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"autoStartup"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">       <span class="comment">&lt;!-- 注册触发器 --&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"triggers"</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"abnormalTigger"</span> /&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"anotherJobTigger"</span> /&gt;</span></div><div class="line">              <span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">       <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line">       <span class="comment">&lt;!-- 注册jobDetail --&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobDetails"</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">              <span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">       <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"schedulerListeners"</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"quartzExceptionSchedulerListener"</span> /&gt;</span></div><div class="line">              <span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">       <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="数据库表准备"><a href="#数据库表准备" class="headerlink" title="数据库表准备"></a>数据库表准备</h3><p>就是准备好集群需要的那些表，昨天找了半天的那个，参见：spring-quartz集群环境搭建遇到的问题。</p>
<h3 id="config-properties"><a href="#config-properties" class="headerlink" title="config.properties"></a>config.properties</h3><p>就是xml里使用的那些变量<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">base.driverClassName=com.mysql.jdbc.Driver</div><div class="line">database.quartz.url=jdbc:mysql:<span class="comment">//192.168.22.235:3306/testdb?useUnicode=true&amp;characterEncoding=utf8</span></div><div class="line">database.quartz.username=root</div><div class="line">database.quartz.password=<span class="number">123</span></div><div class="line"></div><div class="line"></div><div class="line">pool.initialPoolSize=<span class="number">5</span></div><div class="line">pool.minPoolSize=<span class="number">5</span></div><div class="line">pool.maxPoolSize=<span class="number">100</span></div><div class="line">pool.maxIdleTime=<span class="number">3600</span></div><div class="line">pool.acquireIncrement=<span class="number">1</span></div><div class="line">pool.idleConnectionTestPeriod=<span class="number">60</span></div><div class="line">pool.preferredTestQuery=SELECT <span class="number">1</span></div><div class="line">pool.checkoutTimeout=<span class="number">60000</span></div></pre></td></tr></table></figure></p>
<h3 id="JobDetail"><a href="#JobDetail" class="headerlink" title="JobDetail"></a>JobDetail</h3><p>也就是我们需要定时执行的任务。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WillSpringJob</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</div><div class="line">        System.out.println(<span class="string">"sssssssssssssssss"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnotherSJob</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</div><div class="line">        System.out.println(<span class="string">"fun.. I am a jerk."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="SchedulerListener"><a href="#SchedulerListener" class="headerlink" title="SchedulerListener"></a>SchedulerListener</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzExceptionSchedulerListener</span> <span class="keyword">extends</span> <span class="title">SchedulerListenerSupport</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(QuartzExceptionSchedulerListener.class);</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">schedulerError</span><span class="params">(String message, SchedulerException e)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.schedulerError(message, e);</div><div class="line">        logger.error(message, e.getUnderlyingException());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>其实主要的配置都在SchedulerFactoryBean这儿，我们可以看一下这个类里到底有哪些element，也就是xml里在它下面配置的property。其实主要是他的父类SchedulerAccessor，展示一下源码截图：</p>
<p><img src="/imgs/quartz/SchedulerAccessor.png" alt=""></p>
<h3 id="几个小问题"><a href="#几个小问题" class="headerlink" title="几个小问题"></a>几个小问题</h3><ul>
<li><ol>
<li>quartz虽然启动的时候会delay，但是delay的时候会囤积task，到时间会一股脑地将前面delay那段时间的Task全给执行咯；<br>结果是：是的。不可避免</li>
</ol>
</li>
<li><ol>
<li>目前一个trigger里只能写一个job，看了一下cronTrigger里就只有一个JobDetail属性，而不是一个list。对于同一个调度频率的任务一定需要弄多个trigger吗？<br>结果是：很少有这种需求，可以写成一个Job</li>
</ol>
</li>
<li><ol>
<li>SchedulerFactoryBean里的jobDetails如果不配置，只设置trigger的话,JobDetail其实也是会被写入mysql对应的表里的。trigger里的JobDetail和SchedulerFactoryBean里的有什么区别和联系。<br>结果是： ScheduelrAccessor里的注释是Register a list of JobDetail objects with the Scheduler that this FactoryBean creates, to be referenced by Triggers.<br>This is not necessary when a Trigger determines the JobDetail itself: In this case, the JobDetail will be implicitly registered in combination with the Trigger.</li>
</ol>
</li>
</ul>
<p>Done!! </p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://tech.meituan.com/mt-crm-quartz.html" target="_blank" rel="external">http://tech.meituan.com/mt-crm-quartz.html</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/opensource/os-cn-quartz/" target="_blank" rel="external">https://www.ibm.com/developerworks/cn/opensource/os-cn-quartz/</a></li>
<li><a href="http://www.quartz-scheduler.org/generated/2.2.2/html/qtz-all/" target="_blank" rel="external">http://www.quartz-scheduler.org/generated/2.2.2/html/qtz-all/</a></li>
<li><a href="https://github.com/xishuixixia/quartz-monitor" target="_blank" rel="external">https://github.com/xishuixixia/quartz-monitor</a> 【quartz monitor】</li>
<li><a href="http://hot66hot.iteye.com/blog/1726143" target="_blank" rel="external">http://hot66hot.iteye.com/blog/1726143</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> spring </tag>
            
            <tag> quartz </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[spring + quartz集群环境搭建遇到的问题]]></title>
      <url>/2015/12/09/spring-quartz%E9%9B%86%E7%BE%A4%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98/</url>
      <content type="html"><![CDATA[<h2 id="问题1"><a href="#问题1" class="headerlink" title="问题1"></a>问题1</h2><p>总是数据库连接失败<br>解决：dataSource的checkoutTimeout由120修改为12000</p>
<h2 id="问题2"><a href="#问题2" class="headerlink" title="问题2"></a>问题2</h2><p> No row exists in table QRTZ_LOCKS for lock named:  TRIGGER_ACCESS<br> 临时解决方案：<br> <figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> QRTZ_LOCKS <span class="keyword">values</span>(<span class="string">'my sched_name'</span>, <span class="string">'TRIGGER_ACCESS'</span>); </div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> QRTZ_LOCKS <span class="keyword">values</span>(<span class="string">'my sched_name'</span>,<span class="string">'JOB_ACCESS'</span>); </div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> QRTZ_LOCKS <span class="keyword">values</span>(<span class="string">'my sched_name'</span>,<span class="string">'CALENDAR_ACCESS'</span>); </div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> QRTZ_LOCKS <span class="keyword">values</span>(<span class="string">'my sched_name'</span>,<span class="string">'STATE_ACCESS'</span>); </div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> QRTZ_LOCKS <span class="keyword">values</span>(<span class="string">'my sched_name'</span>,<span class="string">'MISFIRE_ACCESS'</span>);</div></pre></td></tr></table></figure></p>
<p>实际的表结构是<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`QRTZ_LOCKS`</span> (</div><div class="line">  <span class="string">`SCHED_NAME`</span> <span class="built_in">varchar</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    <span class="string">`LOCK_NAME`</span> <span class="built_in">varchar</span>(<span class="number">40</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">      PRIMARY <span class="keyword">KEY</span> (<span class="string">`SCHED_NAME`</span>,<span class="string">`LOCK_NAME`</span>)</div><div class="line"></div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8</div></pre></td></tr></table></figure></p>
<p><em>后面我们其实会发现，这个表是因为我copy的2.x版本的sql，所以导致表不兼容,也就是版本对应的话其实不会有这个问题的</em></p>
<p>因为SCHED_NAME其实我们目前并不知道，但是追到代码里有查询这个锁的代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">StdRowLockSemaphore.executeSQL的注释：Execute the SQL select for update that will lock the proper database row.</div></pre></td></tr></table></figure></p>
<h2 id="问题3"><a href="#问题3" class="headerlink" title="问题3"></a>问题3</h2><blockquote>
<p>Uable to serialize JobDataMap for insertion into database because the value of property ‘methodInvoker’ is not serializable: org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean</p>
</blockquote>
<p>原因就是是用的org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean的个别属性不能序列化，所以不能把Job写到mysql的表里去。那就换个方式<br>改用org.springframework.scheduling.quartz.JobDetailBean<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WillSpringJob</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Scheduler scheduler;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</div><div class="line">                System.out.println(<span class="string">"sssssssssssssssss"</span>);</div><div class="line">                    </div><div class="line">        &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>相关任务修改<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"abnormalDitail"</span> <span class="attr">class</span>=<span class="string">"org.springframework.scheduling.quartz.JobDetailBean"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobClass"</span> <span class="attr">value</span>=<span class="string">"com.task.WillSpringJob"</span> /&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobDataAsMap"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">map</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"timeout"</span> <span class="attr">value</span>=<span class="string">"5"</span> /&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">map</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="问题4"><a href="#问题4" class="headerlink" title="问题4"></a>问题4</h2><blockquote>
<p>Error creating bean with name ‘quartzScheduler’ defined in file [/Users/will/work/dolphin/target/classes/task/TestTask.xml]: Invocation of init method failed; nested exception is org.quartz.JobPersistenceException: Couldn’t store job: Unknown column ‘IS_VOLATILE’ in ‘field list’ [See nested exception: com.mysql.jdbc.exceptions.jdbc4.MySQLSyntaxErrorException: Unknown column ‘IS_VOLATILE’ in ‘field list’]:<br>com.mysql.jdbc.exceptions.jdbc4.MySQLSyntaxErrorException: Unknown column ‘IS_VOLATILE’ in ‘field list’</p>
</blockquote>
<p>稍微想一下，验证过没有锁之后，启动spring之后，应该是读取job配置文件，然后就将这些job插入到mysql的表QRTZ_JOB_DETAILS中去，以便于集群共同承担任务调度。所以这个不在field list里的字段就是QRTZ_JOB_DETAILS表里的。看来我找的sql版本与目前用到的quartz版本不一致。。。</p>
<p>为了让自己当前稍微爽一下，先在mysql里直接修改表，添加这个字段。后续又出现了IS_STATEFUL。<br>然后又报错：Field ‘SCHED_NAME’ doesn’t have a default value。<br>fun，找版本，不玩儿了。最终定的版本是1.8.6。</p>
<h2 id="建表语句"><a href="#建表语句" class="headerlink" title="建表语句"></a>建表语句</h2><p>用quartz管理任务计划很方便，但是当使用数据库作为存储介质的时候，必须要先创建表，不然就会报错。1.x和2.x的建表语句不同，以下是两个版本使用MySQL时的建表语句。<br>1.x建表语句为：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div></pre></td><td class="code"><pre><div class="line">#</div><div class="line"># In your Quartz properties file, you'll need to set </div><div class="line"># org.quartz.jobStore.driverDelegateClass = org.quartz.impl.jdbcjobstore.StdJDBCDelegate</div><div class="line">#</div><div class="line">#</div><div class="line"># By: Ron Cordell - roncordell</div><div class="line">#  I didn't see this anywhere, so I thought I'd post it here. This is the script from Quartz to create the tables in a MySQL database, modified to use INNODB instead of MYISAM.</div><div class="line"></div><div class="line">DROP TABLE IF EXISTS QRTZ_JOB_LISTENERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_TRIGGER_LISTENERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_FIRED_TRIGGERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_PAUSED_TRIGGER_GRPS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_SCHEDULER_STATE;</div><div class="line">DROP TABLE IF EXISTS QRTZ_LOCKS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_SIMPLE_TRIGGERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_CRON_TRIGGERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_BLOB_TRIGGERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_TRIGGERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_JOB_DETAILS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_CALENDARS;</div><div class="line">CREATE TABLE QRTZ_JOB_DETAILS(</div><div class="line">JOB_NAME VARCHAR(200) NOT NULL,</div><div class="line">JOB_GROUP VARCHAR(200) NOT NULL,</div><div class="line">DESCRIPTION VARCHAR(250) NULL,</div><div class="line">JOB_CLASS_NAME VARCHAR(250) NOT NULL,</div><div class="line">IS_DURABLE VARCHAR(1) NOT NULL,</div><div class="line">IS_VOLATILE VARCHAR(1) NOT NULL,</div><div class="line">IS_STATEFUL VARCHAR(1) NOT NULL,</div><div class="line">REQUESTS_RECOVERY VARCHAR(1) NOT NULL,</div><div class="line">JOB_DATA BLOB NULL,</div><div class="line">PRIMARY KEY (JOB_NAME,JOB_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_JOB_LISTENERS (</div><div class="line">JOB_NAME VARCHAR(200) NOT NULL,</div><div class="line">JOB_GROUP VARCHAR(200) NOT NULL,</div><div class="line">JOB_LISTENER VARCHAR(200) NOT NULL,</div><div class="line">PRIMARY KEY (JOB_NAME,JOB_GROUP,JOB_LISTENER),</div><div class="line">INDEX (JOB_NAME, JOB_GROUP),</div><div class="line">FOREIGN KEY (JOB_NAME,JOB_GROUP)</div><div class="line">REFERENCES QRTZ_JOB_DETAILS(JOB_NAME,JOB_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_TRIGGERS (</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">JOB_NAME VARCHAR(200) NOT NULL,</div><div class="line">JOB_GROUP VARCHAR(200) NOT NULL,</div><div class="line">IS_VOLATILE VARCHAR(1) NOT NULL,</div><div class="line">DESCRIPTION VARCHAR(250) NULL,</div><div class="line">NEXT_FIRE_TIME BIGINT(13) NULL,</div><div class="line">PREV_FIRE_TIME BIGINT(13) NULL,</div><div class="line">PRIORITY INTEGER NULL,</div><div class="line">TRIGGER_STATE VARCHAR(16) NOT NULL,</div><div class="line">TRIGGER_TYPE VARCHAR(8) NOT NULL,</div><div class="line">START_TIME BIGINT(13) NOT NULL,</div><div class="line">END_TIME BIGINT(13) NULL,</div><div class="line">CALENDAR_NAME VARCHAR(200) NULL,</div><div class="line">MISFIRE_INSTR SMALLINT(2) NULL,</div><div class="line">JOB_DATA BLOB NULL,</div><div class="line">PRIMARY KEY (TRIGGER_NAME,TRIGGER_GROUP),</div><div class="line">INDEX (JOB_NAME, JOB_GROUP),</div><div class="line">FOREIGN KEY (JOB_NAME,JOB_GROUP)</div><div class="line">REFERENCES QRTZ_JOB_DETAILS(JOB_NAME,JOB_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_SIMPLE_TRIGGERS (</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">REPEAT_COUNT BIGINT(7) NOT NULL,</div><div class="line">REPEAT_INTERVAL BIGINT(12) NOT NULL,</div><div class="line">TIMES_TRIGGERED BIGINT(10) NOT NULL,</div><div class="line">PRIMARY KEY (TRIGGER_NAME,TRIGGER_GROUP),</div><div class="line">INDEX (TRIGGER_NAME, TRIGGER_GROUP),</div><div class="line">FOREIGN KEY (TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">REFERENCES QRTZ_TRIGGERS(TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_CRON_TRIGGERS (</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">CRON_EXPRESSION VARCHAR(120) NOT NULL,</div><div class="line">TIME_ZONE_ID VARCHAR(80),</div><div class="line">PRIMARY KEY (TRIGGER_NAME,TRIGGER_GROUP),</div><div class="line">INDEX (TRIGGER_NAME, TRIGGER_GROUP),</div><div class="line">FOREIGN KEY (TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">REFERENCES QRTZ_TRIGGERS(TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_BLOB_TRIGGERS (</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">BLOB_DATA BLOB NULL,</div><div class="line">PRIMARY KEY (TRIGGER_NAME,TRIGGER_GROUP),</div><div class="line">INDEX (TRIGGER_NAME, TRIGGER_GROUP),</div><div class="line">FOREIGN KEY (TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">REFERENCES QRTZ_TRIGGERS(TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_TRIGGER_LISTENERS (</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_LISTENER VARCHAR(200) NOT NULL,</div><div class="line">PRIMARY KEY (TRIGGER_NAME,TRIGGER_GROUP,TRIGGER_LISTENER),</div><div class="line">INDEX (TRIGGER_NAME, TRIGGER_GROUP),</div><div class="line">FOREIGN KEY (TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">REFERENCES QRTZ_TRIGGERS(TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_CALENDARS (</div><div class="line">CALENDAR_NAME VARCHAR(200) NOT NULL,</div><div class="line">CALENDAR BLOB NOT NULL,</div><div class="line">PRIMARY KEY (CALENDAR_NAME)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_PAUSED_TRIGGER_GRPS (</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">PRIMARY KEY (TRIGGER_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_FIRED_TRIGGERS (</div><div class="line">ENTRY_ID VARCHAR(95) NOT NULL,</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">IS_VOLATILE VARCHAR(1) NOT NULL,</div><div class="line">INSTANCE_NAME VARCHAR(200) NOT NULL,</div><div class="line">FIRED_TIME BIGINT(13) NOT NULL,</div><div class="line">PRIORITY INTEGER NOT NULL,</div><div class="line">STATE VARCHAR(16) NOT NULL,</div><div class="line">JOB_NAME VARCHAR(200) NULL,</div><div class="line">JOB_GROUP VARCHAR(200) NULL,</div><div class="line">IS_STATEFUL VARCHAR(1) NULL,</div><div class="line">REQUESTS_RECOVERY VARCHAR(1) NULL,</div><div class="line">PRIMARY KEY (ENTRY_ID)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_SCHEDULER_STATE (</div><div class="line">INSTANCE_NAME VARCHAR(200) NOT NULL,</div><div class="line">LAST_CHECKIN_TIME BIGINT(13) NOT NULL,</div><div class="line">CHECKIN_INTERVAL BIGINT(13) NOT NULL,</div><div class="line">PRIMARY KEY (INSTANCE_NAME)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_LOCKS (</div><div class="line">LOCK_NAME VARCHAR(40) NOT NULL,</div><div class="line">PRIMARY KEY (LOCK_NAME)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">INSERT INTO QRTZ_LOCKS values('TRIGGER_ACCESS');</div><div class="line">INSERT INTO QRTZ_LOCKS values('JOB_ACCESS');</div><div class="line">INSERT INTO QRTZ_LOCKS values('CALENDAR_ACCESS');</div><div class="line">INSERT INTO QRTZ_LOCKS values('STATE_ACCESS');</div><div class="line">INSERT INTO QRTZ_LOCKS values('MISFIRE_ACCESS');</div><div class="line">commit;</div></pre></td></tr></table></figure></p>
<p>2.x版本的建表语句为：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div></pre></td><td class="code"><pre><div class="line">#</div><div class="line"># In your Quartz properties file, you'll need to set </div><div class="line"># org.quartz.jobStore.driverDelegateClass = org.quartz.impl.jdbcjobstore.StdJDBCDelegate</div><div class="line">#</div><div class="line">#</div><div class="line"># By: Ron Cordell - roncordell</div><div class="line">#  I didn't see this anywhere, so I thought I'd post it here. This is the script from Quartz to create the tables in a MySQL database, modified to use INNODB instead of MYISAM.</div><div class="line"></div><div class="line">DROP TABLE IF EXISTS QRTZ_FIRED_TRIGGERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_PAUSED_TRIGGER_GRPS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_SCHEDULER_STATE;</div><div class="line">DROP TABLE IF EXISTS QRTZ_LOCKS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_SIMPLE_TRIGGERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_SIMPROP_TRIGGERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_CRON_TRIGGERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_BLOB_TRIGGERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_TRIGGERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_JOB_DETAILS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_CALENDARS;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_JOB_DETAILS(</div><div class="line">SCHED_NAME VARCHAR(120) NOT NULL,</div><div class="line">JOB_NAME VARCHAR(200) NOT NULL,</div><div class="line">JOB_GROUP VARCHAR(200) NOT NULL,</div><div class="line">DESCRIPTION VARCHAR(250) NULL,</div><div class="line">JOB_CLASS_NAME VARCHAR(250) NOT NULL,</div><div class="line">IS_DURABLE VARCHAR(1) NOT NULL,</div><div class="line">IS_NONCONCURRENT VARCHAR(1) NOT NULL,</div><div class="line">IS_UPDATE_DATA VARCHAR(1) NOT NULL,</div><div class="line">REQUESTS_RECOVERY VARCHAR(1) NOT NULL,</div><div class="line">JOB_DATA BLOB NULL,</div><div class="line">PRIMARY KEY (SCHED_NAME,JOB_NAME,JOB_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_TRIGGERS (</div><div class="line">SCHED_NAME VARCHAR(120) NOT NULL,</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">JOB_NAME VARCHAR(200) NOT NULL,</div><div class="line">JOB_GROUP VARCHAR(200) NOT NULL,</div><div class="line">DESCRIPTION VARCHAR(250) NULL,</div><div class="line">NEXT_FIRE_TIME BIGINT(13) NULL,</div><div class="line">PREV_FIRE_TIME BIGINT(13) NULL,</div><div class="line">PRIORITY INTEGER NULL,</div><div class="line">TRIGGER_STATE VARCHAR(16) NOT NULL,</div><div class="line">TRIGGER_TYPE VARCHAR(8) NOT NULL,</div><div class="line">START_TIME BIGINT(13) NOT NULL,</div><div class="line">END_TIME BIGINT(13) NULL,</div><div class="line">CALENDAR_NAME VARCHAR(200) NULL,</div><div class="line">MISFIRE_INSTR SMALLINT(2) NULL,</div><div class="line">JOB_DATA BLOB NULL,</div><div class="line">PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),</div><div class="line">FOREIGN KEY (SCHED_NAME,JOB_NAME,JOB_GROUP)</div><div class="line">REFERENCES QRTZ_JOB_DETAILS(SCHED_NAME,JOB_NAME,JOB_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_SIMPLE_TRIGGERS (</div><div class="line">SCHED_NAME VARCHAR(120) NOT NULL,</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">REPEAT_COUNT BIGINT(7) NOT NULL,</div><div class="line">REPEAT_INTERVAL BIGINT(12) NOT NULL,</div><div class="line">TIMES_TRIGGERED BIGINT(10) NOT NULL,</div><div class="line">PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),</div><div class="line">FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_CRON_TRIGGERS (</div><div class="line">SCHED_NAME VARCHAR(120) NOT NULL,</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">CRON_EXPRESSION VARCHAR(120) NOT NULL,</div><div class="line">TIME_ZONE_ID VARCHAR(80),</div><div class="line">PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),</div><div class="line">FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_SIMPROP_TRIGGERS</div><div class="line"> (          </div><div class="line">SCHED_NAME VARCHAR(120) NOT NULL,</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">STR_PROP_1 VARCHAR(512) NULL,</div><div class="line">STR_PROP_2 VARCHAR(512) NULL,</div><div class="line">STR_PROP_3 VARCHAR(512) NULL,</div><div class="line">INT_PROP_1 INT NULL,</div><div class="line">INT_PROP_2 INT NULL,</div><div class="line">LONG_PROP_1 BIGINT NULL,</div><div class="line">LONG_PROP_2 BIGINT NULL,</div><div class="line">DEC_PROP_1 NUMERIC(13,4) NULL,</div><div class="line">EC_PROP_2 NUMERIC(13,4) NULL,</div><div class="line">BOOL_PROP_1 VARCHAR(1) NULL,</div><div class="line">OOL_PROP_2 VARCHAR(1) NULL,</div><div class="line">RIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),</div><div class="line">OREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP) </div><div class="line">REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_BLOB_TRIGGERS (</div><div class="line">SCHED_NAME VARCHAR(120) NOT NULL,</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">BLOB_DATA BLOB NULL,</div><div class="line">PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),</div><div class="line">INDEX (SCHED_NAME,TRIGGER_NAME, TRIGGER_GROUP),</div><div class="line">FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_CALENDARS (</div><div class="line">SCHED_NAME VARCHAR(120) NOT NULL,</div><div class="line">CALENDAR_NAME VARCHAR(200) NOT NULL,</div><div class="line">CALENDAR BLOB NOT NULL,</div><div class="line">PRIMARY KEY (SCHED_NAME,CALENDAR_NAME)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_PAUSED_TRIGGER_GRPS (</div><div class="line">SCHED_NAME VARCHAR(120) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">PRIMARY KEY (SCHED_NAME,TRIGGER_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_FIRED_TRIGGERS (</div><div class="line">SCHED_NAME VARCHAR(120) NOT NULL,</div><div class="line">ENTRY_ID VARCHAR(95) NOT NULL,</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">INSTANCE_NAME VARCHAR(200) NOT NULL,</div><div class="line">FIRED_TIME BIGINT(13) NOT NULL,</div><div class="line">SCHED_TIME BIGINT(13) NOT NULL,</div><div class="line">PRIORITY INTEGER NOT NULL,</div><div class="line">STATE VARCHAR(16) NOT NULL,</div><div class="line">JOB_NAME VARCHAR(200) NULL,</div><div class="line">JOB_GROUP VARCHAR(200) NULL,</div><div class="line">IS_NONCONCURRENT VARCHAR(1) NULL,</div><div class="line">REQUESTS_RECOVERY VARCHAR(1) NULL,</div><div class="line">PRIMARY KEY (SCHED_NAME,ENTRY_ID)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_SCHEDULER_STATE (</div><div class="line">SCHED_NAME VARCHAR(120) NOT NULL,</div><div class="line">INSTANCE_NAME VARCHAR(200) NOT NULL,</div><div class="line">LAST_CHECKIN_TIME BIGINT(13) NOT NULL,</div><div class="line">CHECKIN_INTERVAL BIGINT(13) NOT NULL,</div><div class="line">PRIMARY KEY (SCHED_NAME,INSTANCE_NAME)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_LOCKS (</div><div class="line">SCHED_NAME VARCHAR(120) NOT NULL,</div><div class="line">LOCK_NAME VARCHAR(40) NOT NULL,</div><div class="line">PRIMARY KEY (SCHED_NAME,LOCK_NAME)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line">CREATE INDEX IDX_QRTZ_J_REQ_RECOVERY ON QRTZ_JOB_DETAILS(SCHED_NAME,REQUESTS_RECOVERY);</div><div class="line">CREATE INDEX IDX_QRTZ_J_GRP ON QRTZ_JOB_DETAILS(SCHED_NAME,JOB_GROUP);</div><div class="line"></div><div class="line">CREATE INDEX IDX_QRTZ_T_J ON QRTZ_TRIGGERS(SCHED_NAME,JOB_NAME,JOB_GROUP);</div><div class="line">CREATE INDEX IDX_QRTZ_T_JG ON QRTZ_TRIGGERS(SCHED_NAME,JOB_GROUP);</div><div class="line">CREATE INDEX IDX_QRTZ_T_C ON QRTZ_TRIGGERS(SCHED_NAME,CALENDAR_NAME);</div><div class="line">CREATE INDEX IDX_QRTZ_T_G ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_GROUP);</div><div class="line">CREATE INDEX IDX_QRTZ_T_STATE ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_STATE);</div><div class="line">CREATE INDEX IDX_QRTZ_T_N_STATE ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP,TRIGGER_STATE);</div><div class="line">CREATE INDEX IDX_QRTZ_T_N_G_STATE ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_GROUP,TRIGGER_STATE);</div><div class="line">CREATE INDEX IDX_QRTZ_T_NEXT_FIRE_TIME ON QRTZ_TRIGGERS(SCHED_NAME,NEXT_FIRE_TIME);</div><div class="line">CREATE INDEX IDX_QRTZ_T_NFT_ST ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_STATE,NEXT_FIRE_TIME);</div><div class="line">CREATE INDEX IDX_QRTZ_T_NFT_MISFIRE ON QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME);</div><div class="line">CREATE INDEX IDX_QRTZ_T_NFT_ST_MISFIRE ON QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME,TRIGGER_STATE);</div><div class="line">CREATE INDEX IDX_QRTZ_T_NFT_ST_MISFIRE_GRP ON QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME,TRIGGER_GROUP,TRIGGER_STATE);</div><div class="line"></div><div class="line">CREATE INDEX IDX_QRTZ_FT_TRIG_INST_NAME ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,INSTANCE_NAME);</div><div class="line">CREATE INDEX IDX_QRTZ_FT_INST_JOB_REQ_RCVRY ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,INSTANCE_NAME,REQUESTS_RECOVERY);</div><div class="line">CREATE INDEX IDX_QRTZ_FT_J_G ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,JOB_NAME,JOB_GROUP);</div><div class="line">CREATE INDEX IDX_QRTZ_FT_JG ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,JOB_GROUP);</div><div class="line">CREATE INDEX IDX_QRTZ_FT_T_G ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP);</div><div class="line">CREATE INDEX IDX_QRTZ_FT_TG ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,TRIGGER_GROUP);</div><div class="line"></div><div class="line">commit;</div></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> spring </tag>
            
            <tag> quartz </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[springboot坑记1]]></title>
      <url>/2015/12/09/springboot%E5%9D%91%E8%AE%B01/</url>
      <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>业务上需要做一些定时任务的调度，最好还能对这些调度的状态进行记录与监控，可以通过一个友好的界面看到调度的执行情况是最好的。<br>考虑的范围：spring + quartz、dropwizard、spring boot，因为当前公司的项目是使用spring mvc写的，也就是说公司的人力资源方面偏向于spring序列。<br>放弃quartz的原因：</p>
<pre><code>- 只是负责调度，没有看到有对调度进度或者状态有监控的地方
- 对于调度堆叠的处理不是很清楚
</code></pre><p>最终定位到spring boot：</p>
<pre><code>- 计划是使用spring的web来进行调度监控方面的工作
- ApplicationRunner来启动自己写的调度器。
</code></pre>]]></content>
      
        
        <tags>
            
            <tag> spring </tag>
            
            <tag> spring boot </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[mysql新技能-update join]]></title>
      <url>/2015/12/08/mysql%E6%96%B0%E6%8A%80%E8%83%BD-update-join/</url>
      <content type="html"><![CDATA[<p>上面说到了insert overwrite或者insert update的思想。这里说另一种场景，就是我们需要使用a表的直接或者间接数据来更新b表里的数据内容。比如a是所有订单，而b是所有商家订单总金额统计，业务就自然是定时计算a里所有订单的金额汇总，然后udpate到b表里面去。<br><em>这里其实也有insert update的需要，比如判断某商家是否存在，但是我们这里只关注update</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">update</span></div><div class="line">    b </div><div class="line"><span class="keyword">join</span></div><div class="line">(</div><div class="line">	<span class="keyword">select</span> </div><div class="line">		poi_id,</div><div class="line">		<span class="keyword">sum</span>(fee) total_act_cost,</div><div class="line">		<span class="keyword">sum</span>(fee - poi_charge_fee) act_cost</div><div class="line">	<span class="keyword">from</span></div><div class="line">		a</div><div class="line">	<span class="keyword">where</span> </div><div class="line">		ctime <span class="keyword">between</span> #&#123;start_time&#125; <span class="keyword">and</span> #&#123;end_time&#125;</div><div class="line">		<span class="keyword">and</span> valid=<span class="number">1</span></div><div class="line">		<span class="keyword">and</span> <span class="keyword">status</span>=<span class="number">9</span></div><div class="line">	<span class="keyword">group</span> <span class="keyword">by</span> </div><div class="line">		poi_id</div><div class="line">) temp </div><div class="line"><span class="keyword">on</span> </div><div class="line">	a.poi_id = b.poi_id</div><div class="line"><span class="keyword">set</span> </div><div class="line">	b.total_act_cost = temp.total_act_cost,</div><div class="line">	b.act_cost = temp.act_cost,</div><div class="line">	b.act_flag=<span class="number">1</span></div><div class="line"><span class="keyword">where</span> </div><div class="line">	b.order_time <span class="keyword">between</span> #&#123;start_time&#125; <span class="keyword">and</span> #&#123;end_time&#125;</div></pre></td></tr></table></figure>
<p>计算a里的指标结果，然后update到b的对应记录里面。</p>
]]></content>
      
        
        <tags>
            
            <tag> mysql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[mysql新技能-ON DUPLICATE KEY UPDATE]]></title>
      <url>/2015/12/08/mysql%E6%96%B0%E6%8A%80%E8%83%BD-ON-DUPLICATE-KEY-UPDATE/</url>
      <content type="html"><![CDATA[<p>向数据库插入数据的时候，我们会遇到一种情形：如果数据库中没有此条记录，就直接插入；如果已经存在此条记录，就更新其部分的字段值。这里定位“此条记录”是指在数据库中是唯一的，确定某个标识可以在数据库中唯一定位某一条记录。<br>玩儿hive的同学请注意意思，虽R是insert overwrite的大概思想，但是不会覆盖整个分区数据，而仅仅针对“此条记录”。</p>
<p>ON DUPLICATE KEY不会指定具体的唯一key是哪个,因为并没有必要，这个语句要求table里有unique key,或者primary key, 它会自动比较这个key是不是有重复，如果有重复就update，没有的话就直接insert。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">table</span> (a,b,c) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>)</div><div class="line">  <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span> c=c+<span class="number">1</span>;</div><div class="line"></div><div class="line"><span class="keyword">UPDATE</span> <span class="keyword">table</span> <span class="keyword">SET</span> c=c+<span class="number">1</span> <span class="keyword">WHERE</span> a=<span class="number">1</span>;</div></pre></td></tr></table></figure>
<p>如果a=1这条记录存在，而且a是unique key的话，那么这两个句子是等同的。<br>这个句子还支持一下方式，就是可以同时更新多个字段的值，而且可以相互引用：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">table</span> (a,b,c) <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>),(<span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>)</div><div class="line">  <span class="keyword">ON</span> <span class="keyword">DUPLICATE</span> <span class="keyword">KEY</span> <span class="keyword">UPDATE</span> c=<span class="keyword">VALUES</span>(a)+<span class="keyword">VALUES</span>(b), b=<span class="number">2</span>;</div></pre></td></tr></table></figure></p>
]]></content>
      
        
        <tags>
            
            <tag> mysql </tag>
            
            <tag> sql </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[vim-vundle]]></title>
      <url>/2015/12/07/vim-vundle/</url>
      <content type="html"><![CDATA[<p>传说中的vim，今儿哥们儿要强迫自己继续装个B，吼吼~~ 为哥的勇气鼓掌！！</p>
<h3 id="0-安装vundle"><a href="#0-安装vundle" class="headerlink" title="0.安装vundle"></a>0.安装vundle</h3><p>vundle是一个vim的插件管理器，涉猎了一段时间，发现很多人在用，为了更好更快地入门，就先玩儿个最活跃的，预料体验也不会特别差。</p>
<blockquote>
<p>git clone <a href="https://github.com/VundleVim/Vundle.vim.git" target="_blank" rel="external">https://github.com/VundleVim/Vundle.vim.git</a> ~/.vim/bundle/Vundle.vim</p>
</blockquote>
<h3 id="1-配置vundle"><a href="#1-配置vundle" class="headerlink" title="1.配置vundle"></a>1.配置vundle</h3><p>就是下载自己需<br>要的一些插件，其实现在我毛线都不知道，就是网上随便搜了几个比较综合了一下。<br>建议参考：<a href="https://github.com/VundleVim/Vundle.vim，了解最新的配置说明。" target="_blank" rel="external">https://github.com/VundleVim/Vundle.vim，了解最新的配置说明。</a><br>BTW, 牛人参考: <a href="https://github.com/VundleVim/Vundle.vim/wiki/Examples" target="_blank" rel="external">https://github.com/VundleVim/Vundle.vim/wiki/Examples</a></p>
<p>下面是我的~/.vimrc文件内容<br><figure class="highlight vim"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line">et nocompatible                <span class="comment">" be iMproved</span></div><div class="line"><span class="keyword">filetype</span> off                    <span class="comment">" required!</span></div><div class="line"></div><div class="line"><span class="comment">" set the runtime path to include Vundle and initialize</span></div><div class="line"><span class="keyword">set</span> rtp+=~/.<span class="keyword">vim</span>/bundle/vundle/</div><div class="line"><span class="keyword">call</span> vundle#rc()</div><div class="line"></div><div class="line"><span class="comment">" let Vundle manage Vundle</span></div><div class="line"><span class="comment">" 使用vundle来管理</span></div><div class="line">Bundle <span class="string">'gmarik/vundle'</span></div><div class="line"></div><div class="line"><span class="comment">"my Bundle here:</span></div><div class="line"><span class="comment">"</span></div><div class="line"><span class="comment">" original repos on github</span></div><div class="line"><span class="comment">" 相较于Command-T等查找文件的插件，ctrlp.vim最大的好处在于没有依赖，干净利落</span></div><div class="line">Bundle <span class="string">'kien/ctrlp.vim'</span></div><div class="line"></div><div class="line"><span class="string">" 在输入()，"</span><span class="comment">"等需要配对的符号时，自动帮你补全剩余半个</span></div><div class="line">Bundle <span class="string">'AutoClose'</span></div><div class="line"></div><div class="line"><span class="string">" 在()、"</span><span class="comment">"、甚至HTML标签之间快速跳转；</span></div><div class="line">Bundle <span class="string">'matchit.zip'</span></div><div class="line"></div><div class="line"><span class="comment">" 显示行末的空格</span></div><div class="line">Bundle <span class="string">'ShowTrailingWhitespace'</span></div><div class="line"></div><div class="line"><span class="comment">" 用全新的方式在文档中高效的移动光标，革命性的突破</span></div><div class="line">Bundle <span class="string">'EasyMotion'</span></div><div class="line"></div><div class="line"><span class="comment">" 自动识别文件编码；</span></div><div class="line">Bundle <span class="string">'FencView.vim'</span></div><div class="line"><span class="comment">" 必不可少，在VIM的编辑窗口树状显示文件目录</span></div><div class="line">Bundle <span class="string">'The-NERD-tree'</span></div><div class="line"></div><div class="line"><span class="comment">" 解放生产力的神器，简单配置，就可以按照自己的风格快速输入大段代码。</span></div><div class="line">Bundle <span class="string">'UltiSnips'</span></div><div class="line">Bundle <span class="string">'sukima/xmledit'</span></div><div class="line">Bundle <span class="string">'sjl/gundo.vim'</span></div><div class="line">Bundle <span class="string">'jiangmiao/auto-pairs'</span></div><div class="line">Bundle <span class="string">'klen/python-mode'</span></div><div class="line">Bundle <span class="string">'Valloric/ListToggle'</span></div><div class="line"><span class="comment">"Bundle 'SirVer/ultisnips'</span></div><div class="line"></div><div class="line"><span class="comment">" 迄今位置最好的自动VIM自动补全插件了吧</span></div><div class="line">Bundle <span class="string">'Valloric/YouCompleteMe'</span></div><div class="line"></div><div class="line">Bundle <span class="string">'scrooloose/syntastic'</span></div><div class="line">Bundle <span class="string">'t9md/vim-quickhl'</span></div><div class="line"><span class="comment">" Bundle 'Lokaltog/vim-powerline'</span></div><div class="line">Bundle <span class="string">'scrooloose/nerdcommenter'</span></div><div class="line"></div><div class="line">Plugin <span class="string">'godlygeek/tabular'</span></div><div class="line">Plugin <span class="string">'plasticboy/vim-markdown'</span></div><div class="line"></div><div class="line"><span class="comment">"..................................</span></div><div class="line"><span class="comment">" vim-scripts repos</span></div><div class="line">Bundle <span class="string">'YankRing.vim'</span></div><div class="line">Bundle <span class="string">'vcscommand.vim'</span></div><div class="line">Bundle <span class="string">'ShowPairs'</span></div><div class="line">Bundle <span class="string">'SudoEdit.vim'</span></div><div class="line">Bundle <span class="string">'EasyGrep'</span></div><div class="line">Bundle <span class="string">'VOoM'</span></div><div class="line">Bundle <span class="string">'VimIM'</span></div><div class="line"><span class="comment">"..................................</span></div><div class="line"><span class="comment">" non github repos</span></div><div class="line"><span class="comment">" Bundle 'git://git.wincent.com/command-t.git'</span></div><div class="line"><span class="comment">"......................................</span></div><div class="line"><span class="keyword">filetype</span> plugin <span class="built_in">indent</span> <span class="keyword">on</span>	<span class="comment">"这一行就是结束了</span></div><div class="line"></div><div class="line"><span class="comment">" 粘贴错位问题</span></div><div class="line"><span class="keyword">nnoremap</span> <span class="symbol">&lt;F3&gt;</span> :<span class="keyword">set</span> invpaste paste?<span class="symbol">&lt;CR&gt;</span></div><div class="line"><span class="keyword">imap</span> <span class="symbol">&lt;F3&gt;</span> <span class="symbol">&lt;C-O&gt;</span>:<span class="keyword">set</span> invpaste paste?<span class="symbol">&lt;CR&gt;</span></div><div class="line"><span class="keyword">set</span> pastetoggle=<span class="symbol">&lt;F3&gt;</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">" nerdTree设置</span></div><div class="line"><span class="comment">" 在 vim 启动的时候默认开启 NERDTree（autocmd 可以缩写为 au）</span></div><div class="line"><span class="keyword">autocmd</span> VimEnter * NERDTree</div><div class="line"><span class="comment">" 按下 F2 调出/隐藏 NERDTree</span></div><div class="line"><span class="comment">" map  :silent! NERDTreeToggle</span></div><div class="line">silent! <span class="keyword">map</span> <span class="symbol">&lt;F2&gt;</span> :NERDTreeToggle<span class="symbol">&lt;CR&gt;</span></div><div class="line"><span class="keyword">let</span> <span class="variable">g:NERDTreeMapActivateNode</span>=<span class="string">"&lt;F2&gt;"</span></div><div class="line"><span class="comment">" 将 NERDTree 的窗口设置在 vim 窗口的右侧（默认为左侧）</span></div><div class="line"><span class="string">" let NERDTreeWinPos="</span><span class="keyword">right</span><span class="comment">"</span></div><div class="line"><span class="comment">" 当打开 NERDTree 窗口时，自动显示 Bookmarks</span></div><div class="line"><span class="keyword">let</span> NERDTreeShowBookmarks=<span class="number">1</span></div></pre></td></tr></table></figure></p>
<h3 id="2-简单使用"><a href="#2-简单使用" class="headerlink" title="2.简单使用"></a>2.简单使用</h3><p>本人的一贯原则，首先找官方的文档或者手册怎样查找: 在vim中使用:h vundle定位<br><img src="/imgs/vim/help_vundle.png" alt=""></p>
<table>
<thead>
<tr>
<th><em>命令</em></th>
<th style="text-align:left"><em>描述</em></th>
</tr>
</thead>
<tbody>
<tr>
<td>:PluginUpdate</td>
<td style="text-align:left">更新指定的plugin</td>
</tr>
<tr>
<td>:PluginList</td>
<td style="text-align:left">显示已经安装的plugin</td>
</tr>
<tr>
<td>:PluginClean</td>
<td style="text-align:left">清除配置里没有的plugin，针对bundle目录</td>
</tr>
<tr>
<td>:PluginSearch xxx</td>
<td style="text-align:left">搜索是否包含某个plugin</td>
</tr>
</tbody>
</table>
<h3 id="3-do-it-yourself"><a href="#3-do-it-yourself" class="headerlink" title="3. do it yourself"></a>3. do it yourself</h3><p>既然配置好了插件，也学习了vundle的最基础命令，最后就只剩下我们去实际体验了。<br><img src="/imgs/vim/install_vundle_plugin.png" alt="执行:PluginInstall之后的界面"><br>上面的过程其实就是在安装所有.vimrc里声明给vundle要去安装的插件，安装后的目录结构如下图：<br><img src="/imgs/vim/vim_plugins_dir.png" alt=""><br><em>友情提示</em>：安装完这些组件后，发现vundle的命令是可以通过tab进行自动补全的。</p>
<h3 id="4-安装markdown插件"><a href="#4-安装markdown插件" class="headerlink" title="4.安装markdown插件"></a>4.安装markdown插件</h3><p>由于刚刚立志要强迫自己玩儿转vim，所以先安装个markdown插件试试咯。</p>
<ul>
<li>vimrc里添加 <blockquote>
<p>Plugin ‘godlygeek/tabular’<br>Plugin ‘plasticboy/vim-markdown’</p>
</blockquote>
</li>
<li>之后自己写这个*.md文件，发现vim已经识别了这个文件是markdown，表现是能够识别符号，比如-xxx之后换行会自动-等</li>
<li>遗憾是没有发现preview的方法，目前的方式是先启动hexo，然后一边编写另一边进行实际的view</li>
</ul>
<h3 id="5-资源"><a href="#5-资源" class="headerlink" title="5.资源"></a>5.资源</h3><blockquote>
<p><a href="http://vim-scripts.org/vim/scripts.html" target="_blank" rel="external">http://vim-scripts.org/vim/scripts.html</a><br><a href="https://github.com/vim-scripts" target="_blank" rel="external">https://github.com/vim-scripts</a></p>
</blockquote>
]]></content>
      
        
        <tags>
            
            <tag> vim </tag>
            
            <tag> vundle </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[mac使用杂记]]></title>
      <url>/2015/12/04/mac%E4%BD%BF%E7%94%A8%E6%9D%82%E8%AE%B0/</url>
      <content type="html"><![CDATA[<h3 id="1-查看磁盘空间"><a href="#1-查看磁盘空间" class="headerlink" title="1.查看磁盘空间"></a>1.查看磁盘空间</h3><p>开始 -&gt; 关于本机 -&gt; 存储<br><img src="/imgs/mac/磁盘空间" alt=""></p>
<h3 id="2-快捷键"><a href="#2-快捷键" class="headerlink" title="2.快捷键"></a>2.快捷键</h3><table>
<thead>
<tr>
<th><em>键</em></th>
<th style="text-align:left"><em>描述</em></th>
</tr>
</thead>
<tbody>
<tr>
<td>空格</td>
<td style="text-align:left">可以查看各种媒体文件</td>
</tr>
<tr>
<td>command + option + esc</td>
<td style="text-align:left">强杀进程</td>
</tr>
<tr>
<td>F11</td>
<td style="text-align:left">一键显示桌面</td>
</tr>
</tbody>
</table>
<h3 id="3-多jdk环境"><a href="#3-多jdk环境" class="headerlink" title="3. 多jdk环境"></a>3. 多jdk环境</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">➜  ~  cat ~/.bashrc</div><div class="line">export NVM_DIR=~/.nvm</div><div class="line">source $(brew --prefix nvm)/nvm.sh</div><div class="line"></div><div class="line">export JAVA_6_HOME=/Library/Java/JavaVirtualMachines/1.6.0.jdk/Contents/Home</div><div class="line">export JAVA_7_1_HOME=/Library/Java/JavaVirtualMachines/jdk1.7.0_07.jdk/Contents/Home</div><div class="line">export JAVA_7_HOME=/Library/Java/JavaVirtualMachines/jdk1.7.0_80.jdk/Contents/Home</div><div class="line">export JAVA_HOME=$JAVA_7_HOME</div><div class="line"></div><div class="line"># 下面的命令用来切换当前jdk环境</div><div class="line">alias jdk6=&apos;export JAVA_HOME=$JAVA_6_HOME &amp;&amp; export PATH=$JAVA_HOME/bin:$PATH&apos;</div><div class="line">alias jdk71=&apos;export JAVA_HOME=$JAVA_7_1_HOME &amp;&amp; export PATH=$JAVA_HOME/bin:$PATH&apos;</div><div class="line">alias jdk72=&apos;export JAVA_HOME=$JAVA_7_2_HOME &amp;&amp; export PATH=$JAVA_HOME/bin:$PATH&apos;</div><div class="line"></div><div class="line">➜  ~  java -version</div><div class="line">java version &quot;1.7.0_80&quot;</div><div class="line">Java(TM) SE Runtime Environment (build 1.7.0_80-b15)</div><div class="line">Java HotSpot(TM) 64-Bit Server VM (build 24.80-b11, mixed mode)</div><div class="line">➜  ~  jdk6</div><div class="line">➜  ~  java -version</div><div class="line">java version &quot;1.6.0_65&quot;</div><div class="line">Java(TM) SE Runtime Environment (build 1.6.0_65-b14-468-11M4833)</div><div class="line">Java HotSpot(TM) 64-Bit Server VM (build 20.65-b04-468, mixed mode)</div></pre></td></tr></table></figure>
<p>参考自：<a href="http://ningandjiao.iteye.com/blog/2045955" target="_blank" rel="external">http://ningandjiao.iteye.com/blog/2045955</a></p>
]]></content>
      
        
        <tags>
            
            <tag> mac </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[强奸R语言 1]]></title>
      <url>/2015/12/03/%E5%BC%BA%E5%A5%B8R%E8%AF%AD%E8%A8%80-1/</url>
      <content type="html"><![CDATA[<p>就是为了学习一些机器学习的知识，需要用到R语言，但是感觉专门再去研究一门语言有些太繁琐。所以索性直接上手，也就是抄写各种机器学习的R程序。</p>
<p>首先弄的是文本挖掘的小程序：<a href="http://mp.weixin.qq.com/s?__biz=MzA3MDg0MjgxNQ==&amp;mid=400900310&amp;idx=1&amp;sn=4002ae3fc938a46060558480f0583fb2&amp;3rd=MzA3MDU4NTYzMw==&amp;scene=6#rd" target="_blank" rel="external">http://mp.weixin.qq.com/s?__biz=MzA3MDg0MjgxNQ==&amp;mid=400900310&amp;idx=1&amp;sn=4002ae3fc938a46060558480f0583fb2&amp;3rd=MzA3MDU4NTYzMw==&amp;scene=6#rd</a></p>
<p>好，文章里面提示要安装package。<br>搜一下R安装package的方法：<a href="http://www.r-bloggers.com/installing-r-packages/" target="_blank" rel="external">http://www.r-bloggers.com/installing-r-packages/</a></p>
<p>先尝试图形界面，简单。<br>使用R的图形界面找不到Snowball这个分词程序<br><img src="/imgs/r/图形界面找不到Snowball.png" alt=""></p>
<p>再使用命令行：<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">install.packages(<span class="string">"Snowball"</span>)</div><div class="line">Warning message:</div><div class="line">package ‘Snowball’ is not available (<span class="keyword">for</span> R version <span class="number">3.2</span><span class="number">.2</span>)</div></pre></td></tr></table></figure></p>
<p>到Google搜索 r snowball，定位到 <a href="https://cran.r-project.org/src/contrib/Archive/Snowball/" target="_blank" rel="external">https://cran.r-project.org/src/contrib/Archive/Snowball/</a></p>
<blockquote>
<p>wget <a href="https://cran.r-project.org/src/contrib/Archive/Snowball/Snowball_0.0-11.tar.gz" target="_blank" rel="external">https://cran.r-project.org/src/contrib/Archive/Snowball/Snowball_0.0-11.tar.gz</a></p>
</blockquote>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">&gt; getwd()   // 获取当前工作目录</div><div class="line">[<span class="number">1</span>] <span class="string">"/Users/will"</span></div><div class="line">&gt; setwd(<span class="string">'/Users/will/softs/clean'</span>)      //设置工作目录到刚才下载的包那里</div><div class="line">&gt; getwd()</div><div class="line">[<span class="number">1</span>] <span class="string">"/Users/will/softs/clean"</span></div><div class="line">&gt; install.packages(<span class="string">"Snowball_0.0-11.tar.gz"</span>)    // 再次安装</div><div class="line">inferring <span class="string">'repos = NULL'</span> from <span class="string">'pkgs'</span></div><div class="line">ERROR: dependencies ‘RWeka’, ‘rJava’ are not available <span class="keyword">for</span> package ‘Snowball’</div><div class="line">* removing ‘/Library/Frameworks/R.framework/Versions/<span class="number">3.2</span>/Resources/<span class="keyword">library</span>/Snowball’</div><div class="line">Warning message:</div><div class="line">In install.packages(<span class="string">"Snowball_0.0-11.tar.gz"</span>) :</div><div class="line">  安装程序包‘Snowball_0.0-<span class="number">11.</span>tar.gz’时退出狀態的值不是<span class="number">0</span></div></pre></td></tr></table></figure>
<p>可以看到上面报出两个package找不到:RWeka和rJava</p>
<p>尝试一下有么有像maven一样自动下载依赖的方法：<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">&gt; install.packages(<span class="string">"Snowball_0.0-11.tar.gz"</span>, dependencies=<span class="literal">TRUE</span>)</div><div class="line">inferring <span class="string">'repos = NULL'</span> from <span class="string">'pkgs'</span></div><div class="line">* installing *<span class="keyword">source</span>* package ‘Snowball’ <span class="keyword">...</span></div><div class="line">** 成功将‘Snowball’程序包解包并MD5和检查</div><div class="line">** R</div><div class="line">** inst</div><div class="line">** preparing package <span class="keyword">for</span> lazy loading</div><div class="line">Warning message:</div><div class="line">In install.packages(<span class="string">"Snowball_0.0-11.tar.gz"</span>, dependencies = <span class="literal">TRUE</span>) :</div><div class="line">  安装程序包‘Snowball_0.0-<span class="number">11.</span>tar.gz’时退出狀態的值不是<span class="number">0</span></div><div class="line">No Java runtime present, requesting install.</div></pre></td></tr></table></figure></p>
<p>马达, mac提示让安装1.6版本的jdk才行，日了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">java version &quot;1.7.0_80&quot;</div><div class="line">Java(TM) SE Runtime Environment (build 1.7.0_80-b15)</div><div class="line">Java HotSpot(TM) 64-Bit Server VM (build 24.80-b11, mixed mode)</div></pre></td></tr></table></figure></p>
<p>自己手动来<br><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">&gt; install.packages(<span class="string">'RWeka'</span>)</div><div class="line">also installing the dependencies ‘RWekajars’, ‘rJava’</div><div class="line"></div><div class="line">试开URL’https://dirichlet.mat.puc.cl/bin/macosx/mavericks/contrib/<span class="number">3.2</span>/RWekajars_3.7.12-<span class="number">1.</span>tgz<span class="string">'</span></div><div class="line">Content type 'application/x-gzip<span class="string">' length 6473509 bytes (6.2 MB)</span></div><div class="line">==================================================</div><div class="line">downloaded 6.2 MB</div><div class="line"></div><div class="line">试开URL’https://dirichlet.mat.puc.cl/bin/macosx/mavericks/contrib/3.2/rJava_0.9-7.tgz'</div><div class="line">Content type <span class="string">'application/x-gzip'</span> length <span class="number">604271</span> bytes (<span class="number">590</span> KB)</div><div class="line">==================================================</div><div class="line">downloaded <span class="number">590</span> KB</div><div class="line"></div><div class="line">试开URL’https://dirichlet.mat.puc.cl/bin/macosx/mavericks/contrib/<span class="number">3.2</span>/RWeka_0.4-<span class="number">24.</span>tgz<span class="string">'</span></div><div class="line">Content type 'application/x-gzip<span class="string">' length 536260 bytes (523 KB)</span></div><div class="line">==================================================</div><div class="line">downloaded 523 KB</div></pre></td></tr></table></figure></p>
<p>同样的方式，安装其他包(<em>安装的时候需要注意当前目录getwd一下，是不是源package所在的位置</em>)</p>
<blockquote>
<p>wget <a href="http://download.r-forge.r-project.org/src/contrib/Rwordseg_0.2-1.tar.gz" target="_blank" rel="external">http://download.r-forge.r-project.org/src/contrib/Rwordseg_0.2-1.tar.gz</a></p>
</blockquote>
<figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">&gt; install.packages(<span class="string">"Rwordseg_0.2-1.tar.gz"</span>, dependencies=<span class="literal">TRUE</span>)</div><div class="line">inferring <span class="string">'repos = NULL'</span> from <span class="string">'pkgs'</span></div><div class="line">* installing *<span class="keyword">source</span>* package ‘Rwordseg’ <span class="keyword">...</span></div><div class="line">** R</div><div class="line">** demo</div><div class="line">** inst</div><div class="line">** preparing package <span class="keyword">for</span> lazy loading</div><div class="line">** help</div><div class="line">*** installing help indices</div><div class="line">** building package indices</div><div class="line">** testing <span class="keyword">if</span> installed package can be loaded</div><div class="line">* DONE (Rwordseg)</div><div class="line"></div><div class="line">&gt; install.packages(<span class="string">"tm"</span>)</div><div class="line">also installing the dependencies ‘NLP’, ‘slam’</div><div class="line"></div><div class="line">试开URL’https://dirichlet.mat.puc.cl/bin/macosx/mavericks/contrib/<span class="number">3.2</span>/NLP_0.1-<span class="number">8.</span>tgz<span class="string">'</span></div><div class="line">Content type 'application/x-gzip<span class="string">' length 275184 bytes (268 KB)</span></div><div class="line">==================================================</div><div class="line">downloaded 268 KB</div><div class="line"></div><div class="line">试开URL’https://dirichlet.mat.puc.cl/bin/macosx/mavericks/contrib/3.2/slam_0.1-32.tgz'</div><div class="line">Content type <span class="string">'application/x-gzip'</span> length <span class="number">101732</span> bytes (<span class="number">99</span> KB)</div><div class="line">==================================================</div><div class="line">downloaded <span class="number">99</span> KB</div><div class="line"></div><div class="line">试开URL’https://dirichlet.mat.puc.cl/bin/macosx/mavericks/contrib/<span class="number">3.2</span>/tm_0.6-<span class="number">2.</span>tgz<span class="string">'</span></div><div class="line">Content type 'application/x-gzip<span class="string">' length 660405 bytes (644 KB)</span></div><div class="line">==================================================</div><div class="line">downloaded 644 KB</div><div class="line"></div><div class="line"></div><div class="line">下载的二进制程序包在</div><div class="line">    /var/folders/j_/gk6hxy7x705419zqy5sm167w0000gn/T//RtmpXdkdjK/downloaded_packages里</div></pre></td></tr></table></figure>
<h2 id="杂记"><a href="#杂记" class="headerlink" title="杂记"></a>杂记</h2><figure class="highlight r"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">&gt; <span class="keyword">library</span>(<span class="string">"arulesViz"</span>)</div><div class="line">&gt; data(<span class="string">"Groceries"</span>) <span class="comment">#加载指定的数据集</span></div><div class="line">&gt; summary(Groceries)    <span class="comment"># 查看</span></div><div class="line">transactions as itemMatrix <span class="keyword">in</span> sparse format with</div><div class="line"> <span class="number">9835</span> rows (elements/itemsets/transactions) and</div><div class="line"> <span class="number">169</span> columns (items) and a density of <span class="number">0.02609146</span> </div><div class="line"></div><div class="line">most frequent items:</div><div class="line">      whole milk other vegetables       rolls/buns             soda </div><div class="line">            <span class="number">2513</span>             <span class="number">1903</span>             <span class="number">1809</span>             <span class="number">1715</span> </div><div class="line">          yogurt          (Other) </div><div class="line">            <span class="number">1372</span>            <span class="number">34055</span> </div><div class="line"></div><div class="line">element (itemset/transaction) length distribution:</div><div class="line">sizes</div><div class="line">   <span class="number">1</span>    <span class="number">2</span>    <span class="number">3</span>    <span class="number">4</span>    <span class="number">5</span>    <span class="number">6</span>    <span class="number">7</span>    <span class="number">8</span>    <span class="number">9</span>   <span class="number">10</span>   <span class="number">11</span>   <span class="number">12</span>   <span class="number">13</span>   <span class="number">14</span>   <span class="number">15</span> </div><div class="line"><span class="number">2159</span> <span class="number">1643</span> <span class="number">1299</span> <span class="number">1005</span>  <span class="number">855</span>  <span class="number">645</span>  <span class="number">545</span>  <span class="number">438</span>  <span class="number">350</span>  <span class="number">246</span>  <span class="number">182</span>  <span class="number">117</span>   <span class="number">78</span>   <span class="number">77</span>   <span class="number">55</span> </div><div class="line">  <span class="number">16</span>   <span class="number">17</span>   <span class="number">18</span>   <span class="number">19</span>   <span class="number">20</span>   <span class="number">21</span>   <span class="number">22</span>   <span class="number">23</span>   <span class="number">24</span>   <span class="number">26</span>   <span class="number">27</span>   <span class="number">28</span>   <span class="number">29</span>   <span class="number">32</span> </div><div class="line">  <span class="number">46</span>   <span class="number">29</span>   <span class="number">14</span>   <span class="number">14</span>    <span class="number">9</span>   <span class="number">11</span>    <span class="number">4</span>    <span class="number">6</span>    <span class="number">1</span>    <span class="number">1</span>    <span class="number">1</span>    <span class="number">1</span>    <span class="number">3</span>    <span class="number">1</span> </div><div class="line"></div><div class="line">   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </div><div class="line">  <span class="number">1.000</span>   <span class="number">2.000</span>   <span class="number">3.000</span>   <span class="number">4.409</span>   <span class="number">6.000</span>  <span class="number">32.000</span> </div><div class="line"></div><div class="line">includes extended item information - examples:</div><div class="line">       labels  level2           level1</div><div class="line"><span class="number">1</span> frankfurter sausage meet and sausage</div><div class="line"><span class="number">2</span>     sausage sausage meet and sausage</div><div class="line"><span class="number">3</span>  liver loaf sausage meet and sausage</div></pre></td></tr></table></figure>
<p>min: 最小值<br>1st Qu: 一分位数<br>Median: 中位数<br>Mean: 平均值<br>3rd Qu: 三分位数<br>Max： 最大值<br>most frequent items： 最频繁出现的item</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line">&gt; rules &lt;- apriori(Groceries, parameter = list(support = 0.001, confidence = 0.5))</div><div class="line">Apriori</div><div class="line"></div><div class="line">Parameter specification:</div><div class="line"> confidence minval smax arem  aval originalSupport support minlen maxlen</div><div class="line">        0.5    0.1    1 none FALSE            TRUE   0.001      1     10</div><div class="line"> target   ext</div><div class="line">  rules FALSE</div><div class="line"></div><div class="line">Algorithmic control:</div><div class="line"> filter tree heap memopt load sort verbose</div><div class="line">    0.1 TRUE TRUE  FALSE TRUE    2    TRUE</div><div class="line"></div><div class="line">Absolute minimum support count: 9 </div><div class="line"></div><div class="line">set item appearances ...[0 item(s)] done [0.00s].</div><div class="line">set transactions ...[169 item(s), 9835 transaction(s)] done [0.00s].</div><div class="line">sorting and recoding items ... [157 item(s)] done [0.00s].</div><div class="line">creating transaction tree ... done [0.00s].</div><div class="line">checking subsets of size 1 2 3 4 5 6 done [0.01s].</div><div class="line">writing ... [5668 rule(s)] done [0.00s].</div><div class="line">creating S4 object  ... done [0.00s].</div><div class="line">&gt; rules</div><div class="line">set of 5668 rules </div><div class="line">&gt; inspect(head(sort(rules, by = &quot;lift&quot;), 3))</div><div class="line">    lhs                             rhs              support     confidence</div><div class="line">53  &#123;Instant food products,soda&#125; =&gt; &#123;hamburger meat&#125; 0.001220132 0.6315789 </div><div class="line">37  &#123;soda,popcorn&#125;               =&gt; &#123;salty snack&#125;    0.001220132 0.6315789 </div><div class="line">444 &#123;flour,baking powder&#125;        =&gt; &#123;sugar&#125;          0.001016777 0.5555556 </div><div class="line">    lift    </div><div class="line">53  18.99565</div><div class="line">37  16.69779</div><div class="line">444 16.40807</div><div class="line">&gt; inspect(head(sort(rules, by = &quot;lift&quot;), 3))</div><div class="line">    lhs                             rhs              support     confidence lift    </div><div class="line">53  &#123;Instant food products,soda&#125; =&gt; &#123;hamburger meat&#125; 0.001220132 0.6315789  18.99565</div><div class="line">37  &#123;soda,popcorn&#125;               =&gt; &#123;salty snack&#125;    0.001220132 0.6315789  16.69779</div><div class="line">444 &#123;flour,baking powder&#125;        =&gt; &#123;sugar&#125;          0.001016777 0.5555556  16.40807</div><div class="line">&gt; plot(rules)</div><div class="line">&gt; plot(rules)</div><div class="line">&gt;  plot(rules, measure = c(&quot;support&quot;, &quot;lift&quot;), shading = &quot;confidence&quot;)</div></pre></td></tr></table></figure>]]></content>
      
        
        <tags>
            
            <tag> R </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[ElasticSearch kibana Dashboard 定义与使用]]></title>
      <url>/2015/12/03/ElasticSearch-kibana-Dashboard-%E5%AE%9A%E4%B9%89%E4%B8%8E%E4%BD%BF%E7%94%A8/</url>
      <content type="html"><![CDATA[<p>以前在骡迹物流的时候只是玩儿了一下kibana简单的功能，并没有投入使用，当时也基本上玩儿遍了各种可视化，就是么有弄dashboard。<br>在美团这边前两天被拉进elasticsearch的群里，然后收到一个kibana的地址，今儿下午尝试性地玩儿了一下，还蛮爽的，有些惊异。</p>
<p>dashboard是一个画布，然后这个画布上需要放置很多的visualize，也就是说在弄dashboard之前是需要先准备好visualize的，它由visualize和search组成。</p>
<h3 id="1-准备源材料"><a href="#1-准备源材料" class="headerlink" title="1. 准备源材料"></a>1. 准备源材料</h3><p>创建并保存visualization和search</p>
<p><img src="/imgs/es/准备源材料.png" alt=""></p>
<h3 id="2-新建dashboard"><a href="#2-新建dashboard" class="headerlink" title="2. 新建dashboard"></a>2. 新建dashboard</h3><p><img src="/imgs/es/新建dashboard.png" alt=""></p>
<h3 id="3-为dashboard添加元素"><a href="#3-为dashboard添加元素" class="headerlink" title="3. 为dashboard添加元素"></a>3. 为dashboard添加元素</h3><p><img src="/imgs/es/创建dashboard.png" alt=""></p>
<h3 id="4-调整后保存"><a href="#4-调整后保存" class="headerlink" title="4. 调整后保存"></a>4. 调整后保存</h3><p><img src="/imgs/es/保存.png" alt=""></p>
<p>好了，这已经非常好看了，完全可以直接看了。以后再有运营提数据需求，我就直接创建search或者visualization后，生成dashboard。可是问题又来了，咋给他看呢？总不能让所有的运营人员都登陆kibana页面来瞅吧，那样的话还得加权限神马的，比如对个别页面有只读权限，其他页面或者操作没有任何权限才对。静静地思考，kibana和elasticsearch已然有了思路，是不可能倒在权限这个小问题上的，肯定有一种合理的方式去分享给需求端看。fun，找找看~</p>
<h3 id="5-dashboard组件化"><a href="#5-dashboard组件化" class="headerlink" title="5. dashboard组件化"></a>5. dashboard组件化</h3><p>叫我脑残，功能就放在眼前<br><img src="/imgs/es/share.png" alt=""></p>
<p>获取到iframe后，自然就会想到，这个东西是可以嵌入到我们自己的网页中的。如此一来的话，就可以直接将数据存储在elasticsearch中，之后在elasticsearch和kibana之上建立自己的search，visualization，dashboard。然后将最终的dashboard嵌入到应用页面。</p>
<p>还是有些问题，直接在浏览器访问这个dashboard的url的话会发现其实就是kibana那个页面，但是放进iframe之后就成了不可编辑的状态，而且只有组件，上面不会有kibana的head，这个状态比较理想。可是右击查看源代码的话，还是可以看到kibana的页面接口URL，如果直接访问还是可以直接进行编辑。</p>
<p>查了一下权限相关</p>
<ul>
<li><a href="https://github.com/floragunncom/search-guard" target="_blank" rel="external">https://github.com/floragunncom/search-guard</a></li>
<li><a href="http://drops.wooyun.org/tips/8129" target="_blank" rel="external">http://drops.wooyun.org/tips/8129</a></li>
<li><a href="http://3gods.com/2015/09/10/Shield%20Control.html" target="_blank" rel="external">http://3gods.com/2015/09/10/Shield%20Control.html</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> ElasticSearch </tag>
            
            <tag> kibana </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[guava整理 - Basic utilities]]></title>
      <url>/2015/11/19/guava%E6%95%B4%E7%90%86/</url>
      <content type="html"><![CDATA[<p>总是看到guava的身影，今天来大概浏览一下这个Google项目。</p>
<h3 id="1-对于null的思考"><a href="#1-对于null的思考" class="headerlink" title="1. 对于null的思考"></a>1. 对于null的思考</h3><p>null值的特点：</p>
<ul>
<li>不能清晰表达任何业务模型<br> 就是说在很多情况下，我们看到null的时候通常要分析一下context才能知道这里是什么情况</li>
<li>容易被人忽视<br> 很多时候coder会专注于自己正在思考的核心业务场景，编写代码逻辑。容易忘记处理null对象的情况，所以一些nullPointerException通常是由于不可避免的粗心遗漏造成的。</li>
</ul>
<p>Optional<t><br>    当获取某个值的时候，尽量使用Optional<t>, T能够帮助我们理解当前的业务模型，而Optional.get()这一个不是很方便的调用则会时刻提醒我们充分考虑当前场景下，如果主对象为null应当采取的措施。<br>    有异曲同工之妙的还有scala中的Option<t></t></t></t></p>
<p>API概览：<br>    <a href="http://docs.guava-libraries.googlecode.com/git/javadoc/com/google/common/base/Optional.html" target="_blank" rel="external">http://docs.guava-libraries.googlecode.com/git/javadoc/com/google/common/base/Optional.html</a></p>
<h3 id="2-前置条件"><a href="#2-前置条件" class="headerlink" title="2. 前置条件"></a>2. 前置条件</h3><p>就是一些常用的、通用的、简单的条件判断，<br>API:<a href="http://docs.guava-libraries.googlecode.com/git-history/release/javadoc/com/google/common/base/Preconditions.html" target="_blank" rel="external">http://docs.guava-libraries.googlecode.com/git-history/release/javadoc/com/google/common/base/Preconditions.html</a></p>
<p>java7其实也添加了一些方法：<br><a href="http://docs.oracle.com/javase/7/docs/api/java/util/Objects.html#requireNonNull(java.lang.Object,java.lang.String" target="_blank" rel="external">http://docs.oracle.com/javase/7/docs/api/java/util/Objects.html#requireNonNull(java.lang.Object,java.lang.String</a>)</p>
<p>如果不满足这些条件，就会抛出Exception</p>
<h3 id="3-通用对象方法"><a href="#3-通用对象方法" class="headerlink" title="3. 通用对象方法"></a>3. 通用对象方法</h3><p>对于Object默认的toString hashCode等方法提供简单实现<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Objects.equal(&quot;a&quot;, &quot;a&quot;); // returns true</div><div class="line">Objects.equal(null, &quot;a&quot;); // returns false</div><div class="line">Objects.equal(&quot;a&quot;, null); // returns false</div><div class="line">Objects.equal(null, null); // returns true</div></pre></td></tr></table></figure></p>
<p>equals方法给处理了null值情况。</p>
<p>java7也是用了类似guava的<a href="http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/base/Objects.html#hashCode(java.lang.Object...)的" target="_blank" rel="external">http://google.github.io/guava/releases/snapshot/api/docs/com/google/common/base/Objects.html#hashCode(java.lang.Object...)的</a><br><a href="http://docs.oracle.com/javase/7/docs/api/java/util/Objects.html#hash(java.lang.Object" target="_blank" rel="external">http://docs.oracle.com/javase/7/docs/api/java/util/Objects.html#hash(java.lang.Object</a>…)</p>
<p>可读的toString<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">// Returns &quot;ClassName&#123;x=1&#125;&quot;</div><div class="line">   MoreObjects.toStringHelper(this)</div><div class="line">       .add(&quot;x&quot;, 1)</div><div class="line">       .toString();</div><div class="line"></div><div class="line">   // Returns &quot;MyObject&#123;x=1&#125;&quot;</div><div class="line">   MoreObjects.toStringHelper(&quot;MyObject&quot;)</div><div class="line">       .add(&quot;x&quot;, 1)</div><div class="line">       .toString();</div></pre></td></tr></table></figure></p>
<p><a href="http://docs.guava-libraries.googlecode.com/git-history/release/javadoc/com/google/common/base/Objects.html#equal(java.lang.Object" target="_blank" rel="external">http://docs.guava-libraries.googlecode.com/git-history/release/javadoc/com/google/common/base/Objects.html#equal(java.lang.Object</a>, java.lang.Object)</p>
<h3 id="4-ComparisonChain"><a href="#4-ComparisonChain" class="headerlink" title="4. ComparisonChain"></a>4. ComparisonChain</h3><p>任何一个条件返回非0值，就比较结束。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">public int compareTo(Foo that) &#123;</div><div class="line">     return ComparisonChain.start()</div><div class="line">         .compare(this.aString, that.aString)</div><div class="line">         .compare(this.anInt, that.anInt)</div><div class="line">         .compare(this.anEnum, that.anEnum, Ordering.natural().nullsLast())</div><div class="line">         .result();</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h3 id="5-异常传播"><a href="#5-异常传播" class="headerlink" title="5. 异常传播"></a>5. 异常传播</h3><p>简化Throwable的处理<br>有时候我们catch住一个Exception，但是并不想在这个catch块里处理，就会throw出去给下个块。最常见的例子是RuntimeException和Error，本来我们并不想catch它们，但是通常它们又会被catch住。</p>
<p>具体使用没看太明白</p>
<p>集合类使用</p>
<h3 id="1-不可变集合"><a href="#1-不可变集合" class="headerlink" title="1. 不可变集合"></a>1. 不可变集合</h3><ul>
<li>安全</li>
<li>不存在并发问题</li>
<li>空间可预测</li>
</ul>
<p>注：目前guava的不可变集合都不许有null元素，如果要使用带有null的不可变集合，那么选用JDK自带的Collections.unmodifiableXXX</p>
<p>使用不可变集合</p>
<ul>
<li>copyOf：如ImmutableSet.copyOf(set);</li>
<li>of：如ImmutableSet.of(“a”, “b”, “c”)或 ImmutableMap.of(“a”, 1, “b”, 2);</li>
<li>builder：public static final ImmutableSet<color\> GOOGLE_COLORS =<pre><code>ImmutableSet.&lt;Color\&gt;builder()
    .addAll(WEBSAFE_COLORS)
    .add(new Color(0, 191, 255))
    .build();
</code></pre>asList视图</color\></li>
</ul>
<p>所有不可变集合都有一个asList()方法提供ImmutableList视图，来帮助你用列表形式方便地读取集合元素。例如，你可以使用sortedSet.asList().get(k)从ImmutableSortedSet中读取第k个最小元素。</p>
<p>asList()返回的ImmutableList通常是——并不总是——开销稳定的视图实现，而不是简单地把元素拷贝进List。也就是说，asList返回的列表视图通常比一般的列表平均性能更好，比如，在底层集合支持的情况下，它总是使用高效的contains方法。</p>
<h3 id="2-新的集合类型"><a href="#2-新的集合类型" class="headerlink" title="2. 新的集合类型"></a>2. 新的集合类型</h3><p>JDK没有，但是又被非常广泛使用的集合类型。</p>
<ul>
<li><p>MultiSet</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">private void outMuiltSet() &#123;</div><div class="line">   System.out.println(&quot;-------------------&quot;);</div><div class="line">   System.out.println(strs.size());</div><div class="line">   System.out.println(strs.count(new Object())); //count(Object element): 返回给定参数元素的个数</div><div class="line">   System.out.println(strs.count(&quot;sdfsd&quot;)); //count(Object element): 返回给定参数元素的个数</div><div class="line">   System.out.println(strs);</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> public void test3() throws Throwable &#123;</div><div class="line">   strs = TreeMultiset.create();</div><div class="line">   strs.add(&quot;sdfsd&quot;, 2); //add(E element,int occurrences): 向其中添加指定个数的元素</div><div class="line">   strs.add(&quot;sdfsd&quot;);  // add(E element): 向其中添加单个元素</div><div class="line">   strs.add(&quot;dlkjlkj&quot;);</div><div class="line">   System.out.println(strs.elementSet());  // elementSet(): 将不同的元素放入一个Set中</div><div class="line">   Set&lt;Multiset.Entry&lt;Comparable&gt;&gt; entries = strs.entrySet();  //类似与Map.entrySet 返回Set。包含的Entry支持使用getElement()和getCount()</div><div class="line">   for (Multiset.Entry entry: entries) &#123;</div><div class="line">     System.out.println(entry.getElement());</div><div class="line">     System.out.println(entry.getCount());</div><div class="line">   &#125;</div><div class="line">   outMuiltSet();</div><div class="line">   strs.remove(&quot;sdfsd&quot;); // remove(E element): 移除一个元素，其count值 会响应减少</div><div class="line">   outMuiltSet();</div><div class="line">   strs.setCount(&quot;sdfsd&quot;, 10); // 设定某一个元素的重复次数</div><div class="line">   outMuiltSet();</div><div class="line">   strs.remove(&quot;sdfsd&quot;, 2); //remove(E element,int occurrences): 移除相应个数的元素</div><div class="line">   outMuiltSet();</div><div class="line">   strs.setCount(&quot;sdfsd&quot;, 8, 20); //setCount(E element,int oldCount,int newCount): 将符合原有重复个数的元素修改为新的重复次数</div><div class="line">   strs.setCount(&quot;sdfsd&quot;, 8, 20);</div><div class="line">   strs.setCount(&quot;dlkjlkj&quot;, 8, 20);</div><div class="line">   outMuiltSet();</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
</li>
<li><p>SortedMultiset</p>
</li>
</ul>
<p>SortedMultiset是Multiset 接口的变种，它支持高效地获取指定范围的子集。比方说，你可以用 latencies.subMultiset(0,BoundType.CLOSED, 100, BoundType.OPEN).size()来统计你的站点中延迟在100毫秒以内的访问，然后把这个值和latencies.size()相比，以获取这个延迟水平在总体访问中的比例。</p>
<p>TreeMultiset实现SortedMultiset接口。</p>
<ul>
<li>Multimap<br>可以用两种方式思考Multimap的概念:</li>
</ul>
<p>“键-单个值映射”的集合: a-&gt;1, a-&gt;2, a-&gt;4, b-&gt;3, c-&gt;5<br>“键-值集合映射”的映射: a-&gt;[1,2,4], b-&gt;3, c-&gt;5<br>一般情况下都会使用ListMultimap或SetMultimap接口，它们分别把键映射到List或Set。<br>Multimap.get(key)以集合形式返回键所对应的值视图, 即使没有任何对应的值，也会返回空集合。<br>对值视图集合进行的修改最终都会反映到底层的Multimap。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">public void testMap() &#123;</div><div class="line">    ImmutableListMultimap&lt;String, Integer&gt; of = ImmutableListMultimap.of(&quot;a&quot;, 1, &quot;a&quot;, 2, &quot;b&quot;, 1);</div><div class="line">    System.out.println(of.asMap());</div><div class="line">    ListMultimap map = ArrayListMultimap.create(of);</div><div class="line">    map.put(&quot;a&quot;, 234);</div><div class="line">    map.putAll(&quot;c&quot;, ImmutableSet.of(123,3243));</div><div class="line">    System.out.println(map);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<ul>
<li>BiMap<br>实现键值对的双向映射,并保持它们间的同步。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">BiMap&lt;String, Integer&gt; map = HashBiMap.create();</div><div class="line">   map.put(&quot;foo&quot;, 1);</div><div class="line">   map.put(&quot;bar&quot;, 2);</div><div class="line">   map.put(&quot;quux&quot;, 3);</div><div class="line"></div><div class="line">   map.inverse().forcePut(1, &quot;quux&quot;);  // 会导致foo被替换成quux，而quux的value也成了1，就是&#123;bar=2, quux=1&#125;</div><div class="line">   System.out.println(map);</div></pre></td></tr></table></figure>
<ul>
<li>Table</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">String v1 = &quot;a&quot;;</div><div class="line">    String v2 = &quot;b&quot;;</div><div class="line">    String v3 = &quot;c&quot;;</div><div class="line">    Table&lt;String, String, Integer&gt; weightedGraph = HashBasedTable.create();</div><div class="line">    weightedGraph.put(v1, v2, 4);</div><div class="line">    weightedGraph.put(v1, v3, 20);</div><div class="line">    weightedGraph.put(v2, v3, 5);</div><div class="line">    System.out.println(weightedGraph);</div><div class="line"></div><div class="line">    System.out.println(weightedGraph.row(v1) + &quot;........sdfsd&quot;); // 按照rowKey查询</div><div class="line">    System.out.println(weightedGraph.column(v3)); // 按照Columnkey查询</div></pre></td></tr></table></figure>
<ul>
<li>ClassToInstanceMap</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ClassToInstanceMap&lt;Number&gt; numberDefaults=MutableClassToInstanceMap.create();</div><div class="line">    numberDefaults.putInstance(Integer.class, Integer.valueOf(0));</div><div class="line">    numberDefaults.putInstance(Integer.class, Float.valueOf(0)); // 编译报错</div></pre></td></tr></table></figure>
<ul>
<li><p>RangeSet<br>RangeSet描述了一组不相连的、非空的区间。当把一个区间添加到可变的RangeSet时，所有相连的区间会被合并，空区间会被忽略。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">RangeSet&lt;Integer&gt; rangeSet = TreeRangeSet.create();</div><div class="line">    System.out.println(rangeSet);</div><div class="line">    rangeSet.add(Range.closed(1, 10)); // &#123;[1,10]&#125;</div><div class="line">    System.out.println(rangeSet);</div><div class="line">    rangeSet.add(Range.closedOpen(11, 15));//不相连区间:&#123;[1,10], [11,15)&#125;</div><div class="line">    System.out.println(rangeSet);</div><div class="line">    rangeSet.add(Range.closedOpen(15, 20)); //相连区间; &#123;[1,10], [11,20)&#125;</div><div class="line">    System.out.println(rangeSet);</div><div class="line">    rangeSet.add(Range.openClosed(0, 0)); //空区间; &#123;[1,10], [11,20)&#125;</div><div class="line">    System.out.println(rangeSet);</div><div class="line">    rangeSet.remove(Range.open(5, 10)); //分割[1, 10]; &#123;[1,5], [10,10], [11,20)&#125;</div><div class="line">    System.out.println(rangeSet);</div></pre></td></tr></table></figure>
</li>
<li><p>RangeMap<br>RangeMap描述了”不相交的、非空的区间”到特定值的映射。和RangeSet不同，RangeMap不会合并相邻的映射，即便相邻的区间映射到相同的值。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">RangeMap&lt;Integer, String&gt; rangeMap = TreeRangeMap.create();</div><div class="line">    rangeMap.put(Range.closed(1, 10), &quot;foo&quot;); //&#123;[1,10] =&gt; &quot;foo&quot;&#125;</div><div class="line">    System.out.println(rangeMap);</div><div class="line">    rangeMap.put(Range.open(3, 6), &quot;bar&quot;); //&#123;[1,3] =&gt; &quot;foo&quot;, (3,6) =&gt; &quot;bar&quot;, [6,10] =&gt; &quot;foo&quot;&#125;</div><div class="line">    System.out.println(rangeMap);</div><div class="line">    rangeMap.put(Range.open(10, 20), &quot;foo&quot;); //&#123;[1,3] =&gt; &quot;foo&quot;, (3,6) =&gt; &quot;bar&quot;, [6,10] =&gt; &quot;foo&quot;, (10,20) =&gt; &quot;foo&quot;&#125;</div><div class="line">    System.out.println(rangeMap);</div><div class="line">    rangeMap.remove(Range.closed(5, 11)); //&#123;[1,3] =&gt; &quot;foo&quot;, (3,5) =&gt; &quot;bar&quot;, (11,20) =&gt; &quot;foo&quot;&#125;</div><div class="line">    System.out.println(rangeMap);</div></pre></td></tr></table></figure>
</li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> guava </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[node杂记]]></title>
      <url>/2015/10/15/node%E6%9D%82%E8%AE%B0/</url>
      <content type="html"><![CDATA[<p>因为新的项目这边前端是使用的nodejs，精通自己，熟知周边是我一直依赖的坚持。所以现在要对nodejs有个hello world的了解，便于以后自己调试自己的接口以及其他功能代码。</p>
<p>nodejs的依赖管理工具是npm, 有些类似Python的pip + java的maven，既负责安装全局性的依赖，也能处理当前项目的依赖。</p>
<ul>
<li>npm install xxx 是安装依赖到当前目录的node_modules文件夹下，只有当前项目能够使用这些依赖；</li>
<li>npm install xxx -g 安装依赖到npm根目录的node_modules文件夹下，本机所有nodejs项目都可以使用</li>
</ul>
<p>npm主要针对package.json进行，其实npm有啥功能只要看一下package.json有啥配置项就可以了。但是为了完整性，还是列一下:</p>
<table>
<thead>
<tr>
<th><em>命令</em></th>
<th style="text-align:left"><em>描述</em></th>
</tr>
</thead>
<tbody>
<tr>
<td>npm install</td>
<td style="text-align:left">安装package.json里指定的所有依赖</td>
</tr>
<tr>
<td>npm install xxx</td>
<td style="text-align:left">安装xxx,其实这个命令感觉跟当前项目根本没啥关系了</td>
</tr>
<tr>
<td>npm install xxx  –save</td>
<td style="text-align:left">安装xxx,同时将xxx的最新版本加入package.json的dependency里</td>
</tr>
<tr>
<td>npm set init-author-name ‘Your name’</td>
<td style="text-align:left">等于为npm init设置了默认值，以后执行npm init的时候，package.<br>json的作者姓名、邮件、主页、许可证字段就会自动写入预设的值。这些信息会存放在用户主目录的~/.npmrc文件，使得用户不用每个项目都输入。如果某个项目有不同的设置，可以针对该项目运行npm config。</td>
</tr>
<tr>
<td>npm info xxx</td>
<td style="text-align:left">查看模块xxx的具体信息</td>
</tr>
<tr>
<td>npm search xxx</td>
<td style="text-align:left">查找xxx模块是否存在于npm仓库</td>
</tr>
<tr>
<td>npm list</td>
<td style="text-align:left">树形结构列出当前项目安装的所有module</td>
</tr>
<tr>
<td>npm info xxx</td>
<td style="text-align:left">查看模块xxx的具体信息</td>
</tr>
</tbody>
</table>
<p>注： nodejs自身还有版本管理工具，就是nvm了，可以在一个机器上安装多个版本的nodejs.</p>
<blockquote>
<p> git clone <a href="https://github.com/creationix/nvm.git" target="_blank" rel="external">https://github.com/creationix/nvm.git</a> ~/.nvm<br> source ~/.nvm/nvm.sh# </p>
</blockquote>
<p> 安装最新版本</p>
<blockquote>
<p>nvm install node</p>
</blockquote>
<p> 安装指定版本</p>
<blockquote>
<p>nvm install 0.12.1</p>
</blockquote>
<h1 id="使用已安装的最新版本"><a href="#使用已安装的最新版本" class="headerlink" title="使用已安装的最新版本"></a>使用已安装的最新版本</h1><blockquote>
<p>nvm use node</p>
</blockquote>
<h1 id="使用指定版本的node"><a href="#使用指定版本的node" class="headerlink" title="使用指定版本的node"></a>使用指定版本的node</h1><blockquote>
<p>nvm use 0.12</p>
</blockquote>
<h1 id="查看本地安装的所有版本"><a href="#查看本地安装的所有版本" class="headerlink" title="查看本地安装的所有版本"></a>查看本地安装的所有版本</h1><blockquote>
<p> nvm ls</p>
</blockquote>
<h1 id="查看服务器上所有可供安装的版本。"><a href="#查看服务器上所有可供安装的版本。" class="headerlink" title="查看服务器上所有可供安装的版本。"></a>查看服务器上所有可供安装的版本。</h1><blockquote>
<p>nvm ls-remote</p>
</blockquote>
<h1 id="退出已经激活的nvm，使用deactivate命令。"><a href="#退出已经激活的nvm，使用deactivate命令。" class="headerlink" title="退出已经激活的nvm，使用deactivate命令。"></a>退出已经激活的nvm，使用deactivate命令。</h1><blockquote>
<p>nvm deactivate</p>
</blockquote>
<p>nodejs是一种事件驱动的思想：nodejs的event流有些像java web这边的servlet chain，不过他们的servlet叫做middleware，而且很多层次都可以有middleware。</p>
<h3 id="app"><a href="#app" class="headerlink" title="app"></a>app</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">// a middleware sub-stack which handles GET requests to /user/:id</div><div class="line">app.get(&apos;/user/:id&apos;, function (req, res, next) &#123;</div><div class="line">  // if user id is 0, skip to the next route</div><div class="line">  if (req.params.id == 0) next(&apos;route&apos;);</div><div class="line">  // else pass the control to the next middleware in this stack</div><div class="line">  else next(); //</div><div class="line">&#125;, function (req, res, next) &#123;</div><div class="line">  // render a regular page</div><div class="line">  res.render(&apos;regular&apos;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">// handler for /user/:id which renders a special page</div><div class="line">app.get(&apos;/user/:id&apos;, function (req, res, next) &#123;</div><div class="line">  res.render(&apos;special&apos;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="router"><a href="#router" class="headerlink" title="router"></a>router</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">var app = express();</div><div class="line">var router = express.Router();</div><div class="line"></div><div class="line">// a middleware with no mount path, gets executed for every request to the router</div><div class="line">router.use(function (req, res, next) &#123;</div><div class="line">  console.log(&apos;Time:&apos;, Date.now());</div><div class="line">  next();</div><div class="line">&#125;);</div><div class="line"></div><div class="line">// a middleware sub-stack shows request info for any type of HTTP request to /user/:id</div><div class="line">router.use(&apos;/user/:id&apos;, function(req, res, next) &#123;</div><div class="line">  console.log(&apos;Request URL:&apos;, req.originalUrl);</div><div class="line">  next();</div><div class="line">&#125;, function (req, res, next) &#123;</div><div class="line">  console.log(&apos;Request Type:&apos;, req.method);</div><div class="line">  next();</div><div class="line">&#125;);</div><div class="line"></div><div class="line">// a middleware sub-stack which handles GET requests to /user/:id</div><div class="line">router.get(&apos;/user/:id&apos;, function (req, res, next) &#123;</div><div class="line">  // if user id is 0, skip to the next router</div><div class="line">  if (req.params.id == 0) next(&apos;route&apos;);</div><div class="line">  // else pass the control to the next middleware in this stack</div><div class="line">  else next(); //</div><div class="line">&#125;, function (req, res, next) &#123;</div><div class="line">  // render a regular page</div><div class="line">  res.render(&apos;regular&apos;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">// handler for /user/:id which renders a special page</div><div class="line">router.get(&apos;/user/:id&apos;, function (req, res, next) &#123;</div><div class="line">  console.log(req.params.id);</div><div class="line">  res.render(&apos;special&apos;);</div><div class="line">&#125;);</div><div class="line"></div><div class="line">// mount the router on the app</div><div class="line">app.use(&apos;/&apos;, router);</div></pre></td></tr></table></figure>
<h3 id="error-handler"><a href="#error-handler" class="headerlink" title="error handler"></a>error handler</h3><p>四个参数，多一个err。如果完事儿不调用next的话，就需要指定状态码，不然就会向普通的middleware一样报错，并且执行失败。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">app.use(function(err, req, res, next) &#123;</div><div class="line">  console.error(err.stack);</div><div class="line">  res.status(500).send(&apos;Something broke!&apos;);</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<h3 id="built-in"><a href="#built-in" class="headerlink" title="built-in"></a>built-in</h3><p>expresss.static(root, [options]) 一般指定应用的静态资源根目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">var options = &#123;</div><div class="line">  dotfiles: &apos;ignore&apos;,</div><div class="line">  etag: false,</div><div class="line">  extensions: [&apos;htm&apos;, &apos;html&apos;],</div><div class="line">  index: false,</div><div class="line">  maxAge: &apos;1d&apos;,</div><div class="line">  redirect: false,</div><div class="line">  setHeaders: function (res, path, stat) &#123;</div><div class="line">    res.set(&apos;x-timestamp&apos;, Date.now());</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">app.use(express.static(&apos;public&apos;, options));</div></pre></td></tr></table></figure></p>
<p>也可以指定多个目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">app.use(express.static(&apos;public&apos;));</div><div class="line">app.use(express.static(&apos;uploads&apos;));</div><div class="line">app.use(express.static(&apos;files&apos;));</div></pre></td></tr></table></figure></p>
<h3 id="third-party"><a href="#third-party" class="headerlink" title="third-party"></a>third-party</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">var express = require(&apos;express&apos;);</div><div class="line">var app = express();</div><div class="line">var cookieParser = require(&apos;cookie-parser&apos;);</div><div class="line"></div><div class="line">// load the cookie parsing middleware</div><div class="line">app.use(cookieParser());</div></pre></td></tr></table></figure>
<p>node启动express项目：node app.js，如果指定参数-p 8080,就会启动port为8080的server。<br>process.env是指引用系统的环境变量</p>
<p>jade是一种node的模板引擎，将一些关键字映射为html里的元素，使简洁，而且生成的HTML是最小的、确保正确的。</p>
<ul>
<li>使用的时候可以使好多公共的东西模块化，然后include进来</li>
<li>模板之间可以extends，一般extends layout, 然后给里面的一些变量赋值,一般都是处理block<br>详见官网吧。</li>
</ul>
<p>bootstrap + jade，you know…</p>
<p>UI: bootstrap<br>模板引擎：jade<br>css引擎：stylus<br>前端：jquery + socket.io<br>后端：express</p>
]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[mt JIRA+wiki笔记]]></title>
      <url>/2015/10/10/%E5%86%85%E9%83%A8JIRA+wiki%E7%AC%94%E8%AE%B0/</url>
      <content type="html"><![CDATA[<h2 id="1-JIRA"><a href="#1-JIRA" class="headerlink" title="1.JIRA"></a>1.JIRA</h2><p>目前美团用的是JIRA-4，付费买的，然后进行了一些二次开发.</p>
<h3 id="1-1-功能"><a href="#1-1-功能" class="headerlink" title="1.1 功能"></a>1.1 功能</h3><pre><code>追踪bug、task
帮助自己：管理TODO，提高效率
帮助同伴：了解进展、及时通知和讨论
帮助leader：监控
帮助所有人：记录和通知进度、慧谷总结
RSS订阅
小工具： 图表神马的
过滤器：可以写JQL，也可以可视化操作；可以私人拥有，也可以共享给大家
关注其他人的ticket
预期时间
抄送
集成git、用户反馈邮件自动生成ticket
</code></pre><h3 id="1-2-Ticket"><a href="#1-2-Ticket" class="headerlink" title="1.2 Ticket"></a>1.2 Ticket</h3><ul>
<li>状态：open -&gt; in progress -&gt; resolved -&gt; closed</li>
<li>类型：任务、改进、新功能、缺陷、电话问题</li>
<li>优先级：blocker、critical、major、trivial</li>
<li><p>使用原则：</p>
<ul>
<li>自主推动与交付，随时增加注释、更新进度</li>
<li>使用Dashboard来管理自己的TODO</li>
<li>合理安排优先级</li>
<li>任务放进对应的版块</li>
<li></li>
</ul>
</li>
</ul>
<h3 id="1-3-添加备注时机："><a href="#1-3-添加备注时机：" class="headerlink" title="1.3 添加备注时机："></a>1.3 添加备注时机：</h3><ul>
<li>初始目标出现变动</li>
<li>开发和追查的问题有进展和结论</li>
<li>延期或者需要其他依赖条件</li>
<li>分配给其他人、reopen、close的时候</li>
</ul>
<blockquote>
<p>推荐使用google calendar来管理每日计划</p>
</blockquote>
<hr>
<h2 id="2-Wiki"><a href="#2-Wiki" class="headerlink" title="2. Wiki"></a>2. Wiki</h2><p>专业wiki，注重企业知识管理与协调。公司内部是很注重知识的积累的，所以比较重视wiki这块。<br>一般是一些tips，比如一些技巧、或者一些坑、一些心得什么的，可以分享出来供大家参考。</p>
<h3 id="2-1-特点"><a href="#2-1-特点" class="headerlink" title="2.1 特点"></a>2.1 特点</h3><ul>
<li>出色的站点管理</li>
<li>简单而强大的编辑功能</li>
<li>团队成员间的交流</li>
<li>插件扩展</li>
</ul>
<h3 id="2-2-功能"><a href="#2-2-功能" class="headerlink" title="2.2 功能"></a>2.2 功能</h3><ul>
<li>知识管理</li>
<li>社交</li>
<li>分享、积累</li>
<li>文档归档</li>
<li>查找文档</li>
<li>监视文档的每次变化</li>
<li>关注文档</li>
<li>收藏文档</li>
<li>文档归类</li>
</ul>
<h3 id="2-3-查找"><a href="#2-3-查找" class="headerlink" title="2.3 查找"></a>2.3 查找</h3><pre><code>搜索
目录结构
页面链接
收藏夹
添加书签【用于收藏外部资源】
</code></pre><h3 id="2-4-作业"><a href="#2-4-作业" class="headerlink" title="2.4 作业"></a>2.4 作业</h3><p>创建个人空间，添加一个页面，分享或者总结一下。<br>要求：有段落、标题。可选：图片、表格、代码。</p>
]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[akka in action 读书笔记（2）]]></title>
      <url>/2015/08/10/akka-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%EF%BC%882%EF%BC%89/</url>
      <content type="html"><![CDATA[<h3 id="clone"><a href="#clone" class="headerlink" title="clone"></a>clone</h3><blockquote>
<p>git clone <a href="https://github.com/RayRoestenburg/akka-in-action.git" target="_blank" rel="external">https://github.com/RayRoestenburg/akka-in-action.git</a></p>
</blockquote>
<p>先切换到ch02分支上【这个项目的分支有点儿乱 】，找到目录里的chapter2目录，引入idea<br><img src="/imgs/akka/2.1 引入IDE.png" alt="1 引入IDE"></p>
<p>引入过程中IDE应该会自动下载sbt依赖，如果没有的话，到项目根目录下执行：</p>
<blockquote>
<p>sbt assembly</p>
</blockquote>
<p>此项目使用的依赖中除了Spray其他都是scala栈中的成员。当然后面可能会引入更多的其他依赖，比如根据不同的环境进行不同参数的调整。</p>
<p>使用下面命令测试是否构建成功：</p>
<blockquote>
<p>java -jar target/scala-2.10/goticks-server.jar</p>
</blockquote>
<pre><code>Slf4jEventHandler started
akka://com-goticks-Main/user/io-bridge started
akka://com-goticks-Main/user/http-server started on /0.0.0.0:5000
</code></pre><h3 id="sbt"><a href="#sbt" class="headerlink" title="sbt"></a>sbt</h3><p>sbt的配置文件就是项目根目录下的build.sbt文件。</p>
<pre><code>import AssemblyKeys._
import com.typesafe.sbt.SbtStartScript

// 有两个jar需要用到上面两个import。一个类似maven里的shade，将项目打成一个大jar；另一个则是用来部署项目到Heroku上。

name := &quot;goticks&quot;

version := &quot;0.1-SNAPSHOT&quot;

organization := &quot;com.goticks&quot;

scalaVersion := &quot;2.11.2&quot;

resolvers ++= Seq(&quot;Typesafe Repository&quot; at &quot;http://repo.typesafe.com/typesafe/releases/&quot;,
              &quot;Spray Repository&quot;    at &quot;http://repo.spray.io&quot;)
// 指定repositories

libraryDependencies ++= {
  val akkaVersion       = &quot;2.3.9&quot;
  val sprayVersion      = &quot;1.3.2&quot;
  Seq(
    &quot;com.typesafe.akka&quot; %% &quot;akka-actor&quot;      % akkaVersion,
    &quot;io.spray&quot;          %% &quot;spray-can&quot;       % sprayVersion,
    &quot;io.spray&quot;          %% &quot;spray-routing&quot;   % sprayVersion,
    &quot;io.spray&quot;          %% &quot;spray-json&quot;      % &quot;1.3.1&quot;,
    &quot;com.typesafe.akka&quot; %% &quot;akka-slf4j&quot;      % akkaVersion,
    &quot;ch.qos.logback&quot;    %  &quot;logback-classic&quot; % &quot;1.1.2&quot;,
    &quot;com.typesafe.akka&quot; %% &quot;akka-testkit&quot;    % akkaVersion   % &quot;test&quot;,
    &quot;org.scalatest&quot;     %% &quot;scalatest&quot;       % &quot;2.2.0&quot;       % &quot;test&quot;
  )
}

// Assembly settings
mainClass in Global := Some(&quot;com.goticks.Main&quot;)

jarName in assembly := &quot;goticks-server.jar&quot;

assemblySettings

// StartScript settings
seq(SbtStartScript.startScriptForClassesSettings: _*)
</code></pre><h3 id="REST-server"><a href="#REST-server" class="headerlink" title="REST server"></a>REST server</h3><p>到根目录下启动server</p>
<blockquote>
<p>sbt run</p>
</blockquote>
<p><img src="/imgs/akka/2.2 REST规范.png" alt="2 REST规范"><br>存取[为方便测试，请事先安装Linux工具httpie]:</p>
<pre><code>root@ubuntu:~/gitLearning/akka-in-action/chapter2# http PUT localhost:5000/events event=RHCP nrOfTickets:=10
HTTP/1.1 200 OK
Content-Length: 2
Content-Type: text/plain; charset=UTF-8
Date: Mon, 10 Aug 2015 06:28:08 GMT
Server: GoTicks.com REST API

OK

root@ubuntu:~/gitLearning/akka-in-action/chapter2# http PUT localhost:5000/events event=DjMadlib nrOfTickets:=15
HTTP/1.1 200 OK
Content-Length: 2
Content-Type: text/plain; charset=UTF-8
Date: Mon, 10 Aug 2015 06:28:45 GMT
Server: GoTicks.com REST API

OK

root@ubuntu:~/gitLearning/akka-in-action/chapter2# http GET localhost:5000/events
HTTP/1.1 200 OK
Content-Length: 92
Content-Type: application/json; charset=UTF-8
Date: Mon, 10 Aug 2015 06:28:52 GMT
Server: GoTicks.com REST API

[
    {
    &quot;event&quot;: &quot;DjMadlib&quot;, 
    &quot;nrOfTickets&quot;: 15
    }, 
    {
    &quot;event&quot;: &quot;RHCP&quot;, 
    &quot;nrOfTickets&quot;: 10
    }
]

root@ubuntu:~/gitLearning/akka-in-action/chapter2# http GET localhost:5000/ticket/RHCP
HTTP/1.1 200 OK
Content-Length: 32
Content-Type: application/json; charset=UTF-8
Date: Mon, 10 Aug 2015 06:29:32 GMT
Server: GoTicks.com REST API

{
    &quot;event&quot;: &quot;RHCP&quot;, 
    &quot;nr&quot;: 1
}

root@ubuntu:~/gitLearning/akka-in-action/chapter2# http GET localhost:5000/events
HTTP/1.1 200 OK
Content-Length: 91
Content-Type: application/json; charset=UTF-8
Date: Mon, 10 Aug 2015 06:29:46 GMT
Server: GoTicks.com REST API

[
    {
    &quot;event&quot;: &quot;DjMadlib&quot;, 
    &quot;nrOfTickets&quot;: 15
    }, 
    {
    &quot;event&quot;: &quot;RHCP&quot;, 
    &quot;nrOfTickets&quot;: 9
    }
]
</code></pre><p>以上已经包含了CRUD操作，当然这并不全面。我们没有考虑如果一个Event被卖出去了，那么它的状态应该马上变为不可卖，后面我们会再详细谈论此类问题。</p>
<h3 id="Actors"><a href="#Actors" class="headerlink" title="Actors"></a>Actors</h3><p>你可以尝试跟着github上搞下来的源码自己一步步构建项目试试。现在我们已经知道了，actor可以有四种操作：create, send\receive, become, supervise。这里我们会接触到前两个。<br>先看看actor之间怎样相互作用传递信息: 创建event、改票、完成event。</p>
<p>例子中的app只包含三个Actor类。首先，我们是创建这些Actor的容器ActorSystem, 之后Actor再去创建它的子Actor。下图是次序：</p>
<p><img src="/imgs/akka/2.3 Actor Creation Sequence Triggered by REST Request.png" alt="3. Actor Creation Sequence Triggered by REST Request"></p>
<p>RestInterface Actor负责处理HTTP request，其实就是一个HTTP请求的adapter。TicketSeller则负责一些tickets，所有关于票务买卖的event它都管。下图解释了一个request怎样通过actor system创建一个event：</p>
<p><img src="/imgs/akka/2.4 Create an Event from the received JSON request.png" alt="4 Create an Event from the received JSON request"><br>注意：我看的版本里不是TicketMaster而是BoxOffice</p>
<p><img src="/imgs/akka/2.5 Buy a Ticket.png" alt="5 Buy a Ticket"></p>
<p>以上就是这个小APP里主要的业务流了，主要就是让customer能够跟可用的票之间能够建立连接，进行交互。</p>
<p>下面让我们退回去看一下代码，首先是入口Main类</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.goticks</div><div class="line"></div><div class="line"><span class="keyword">import</span> scala.concurrent.duration._</div><div class="line"></div><div class="line"><span class="keyword">import</span> akka.actor._</div><div class="line"><span class="keyword">import</span> akka.io.<span class="type">IO</span></div><div class="line"><span class="keyword">import</span> akka.pattern.ask</div><div class="line"><span class="keyword">import</span> akka.util.<span class="type">Timeout</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> spray.can.<span class="type">Http</span></div><div class="line"><span class="keyword">import</span> spray.can.<span class="type">Http</span>.<span class="type">Bound</span></div><div class="line"></div><div class="line"><span class="keyword">import</span> com.typesafe.config.<span class="type">ConfigFactory</span></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">Main</span> <span class="keyword">extends</span> <span class="title">App</span> </span>&#123;</div><div class="line">  <span class="keyword">val</span> config = <span class="type">ConfigFactory</span>.load() 	<span class="comment">// 加载配置文件</span></div><div class="line">  <span class="keyword">val</span> host = config.getString(<span class="string">"http.host"</span>)</div><div class="line">  <span class="keyword">val</span> port = config.getInt(<span class="string">"http.port"</span>)</div><div class="line"></div><div class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> system = <span class="type">ActorSystem</span>(<span class="string">"goticks"</span>)</div><div class="line"></div><div class="line">  <span class="keyword">val</span> api = system.actorOf(<span class="type">Props</span>(<span class="keyword">new</span> <span class="type">RestInterface</span>()), <span class="string">"httpInterface"</span>) <span class="comment">// 创建最高层的actor</span></div><div class="line"> </div><div class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> executionContext = system.dispatcher</div><div class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> timeout = <span class="type">Timeout</span>(<span class="number">10</span> seconds)</div><div class="line"></div><div class="line">  <span class="comment">// 启动Spray HTTP Server</span></div><div class="line">  <span class="type">IO</span>(<span class="type">Http</span>).ask(<span class="type">Http</span>.<span class="type">Bind</span>(listener = api, interface = host, port = port))</div><div class="line">    .mapTo[<span class="type">Http</span>.<span class="type">Event</span>]</div><div class="line">    .map &#123;</div><div class="line">      <span class="keyword">case</span> <span class="type">Http</span>.<span class="type">Bound</span>(address) =&gt;</div><div class="line">        println(<span class="string">s"REST interface bound to <span class="subst">$address</span>"</span>)</div><div class="line">      <span class="keyword">case</span> <span class="type">Http</span>.<span class="type">CommandFailed</span>(cmd) =&gt;</div><div class="line">        println(<span class="string">"REST interface could not bind to "</span> +</div><div class="line">          <span class="string">s"<span class="subst">$host</span>:<span class="subst">$port</span>, <span class="subst">$&#123;cmd.failureMessage&#125;</span>"</span>)</div><div class="line">        system.shutdown()</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这个App内部沟通的消息类型都定义在TicketProtocol中：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">object</span> <span class="title">TicketProtocol</span> </span>&#123;</div><div class="line">  <span class="keyword">import</span> spray.json._</div><div class="line"></div><div class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Event</span>(<span class="params">event:<span class="type">String</span>, nrOfTickets:<span class="type">Int</span></span>)</span></div><div class="line"></div><div class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">object</span> <span class="title">GetEvents</span></span></div><div class="line"></div><div class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Events</span>(<span class="params">events:<span class="type">List</span>[<span class="type">Event</span>]</span>)</span></div><div class="line"></div><div class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">object</span> <span class="title">EventCreated</span></span></div><div class="line"></div><div class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">TicketRequest</span>(<span class="params">event:<span class="type">String</span></span>)</span></div><div class="line"></div><div class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">object</span> <span class="title">SoldOut</span></span></div><div class="line"></div><div class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Tickets</span>(<span class="params">tickets:<span class="type">List</span>[<span class="type">Ticket</span>]</span>)</span></div><div class="line"></div><div class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">object</span> <span class="title">BuyTicket</span></span></div><div class="line"></div><div class="line">  <span class="keyword">case</span> <span class="class"><span class="keyword">class</span> <span class="title">Ticket</span>(<span class="params">event:<span class="type">String</span>, nr:<span class="type">Int</span></span>)</span></div><div class="line"></div><div class="line">  <span class="comment">//----------------------------------------------</span></div><div class="line">  <span class="comment">// JSON</span></div><div class="line">  <span class="comment">//----------------------------------------------</span></div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">object</span> <span class="title">Event</span> <span class="keyword">extends</span> <span class="title">DefaultJsonProtocol</span> </span>&#123;</div><div class="line">    <span class="keyword">implicit</span> <span class="keyword">val</span> format = jsonFormat2(<span class="type">Event</span>.apply)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">object</span> <span class="title">TicketRequest</span> <span class="keyword">extends</span> <span class="title">DefaultJsonProtocol</span> </span>&#123;</div><div class="line">    <span class="keyword">implicit</span> <span class="keyword">val</span> format = jsonFormat1(<span class="type">TicketRequest</span>.apply)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="class"><span class="keyword">object</span> <span class="title">Ticket</span> <span class="keyword">extends</span> <span class="title">DefaultJsonProtocol</span> </span>&#123;</div><div class="line">    <span class="keyword">implicit</span> <span class="keyword">val</span> format = jsonFormat2(<span class="type">Ticket</span>.apply)</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>作为一个典型的APP，我们有一个接口来解决围绕Event主体和Ticket整个生命周期的所有问题。记住，Akka会使用immutable message将这些部分链接起来，所以actor应该知道它需要的所有的信息。</p>
<h4 id="TicketSeller"><a href="#TicketSeller" class="headerlink" title="TicketSeller"></a>TicketSeller</h4><p>TicketSeller是由BoxOffice创建的, 主要负责处理订单的，自己维护了一些ticket。每次有买票的请求，它就从自己的ticket list里拿出第一张来：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">TicketSeller</span> <span class="keyword">extends</span> <span class="title">Actor</span> </span>&#123;</div><div class="line">  <span class="keyword">import</span> <span class="type">TicketProtocol</span>._</div><div class="line"></div><div class="line">  <span class="keyword">var</span> tickets = <span class="type">Vector</span>[<span class="type">Ticket</span>]()	<span class="comment">// 票</span></div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</div><div class="line"></div><div class="line">    <span class="keyword">case</span> <span class="type">GetEvents</span> =&gt; sender ! tickets.size	<span class="comment">// 返回当前票数</span></div><div class="line"></div><div class="line">    <span class="keyword">case</span> <span class="type">Tickets</span>(newTickets) =&gt; tickets = tickets ++ newTickets <span class="comment">//添加新票</span></div><div class="line"></div><div class="line">    <span class="keyword">case</span> <span class="type">BuyTicket</span> =&gt;	<span class="comment">// 有请求买票</span></div><div class="line">      <span class="keyword">if</span> (tickets.isEmpty) &#123;</div><div class="line">        sender ! <span class="type">SoldOut</span></div><div class="line">        self ! <span class="type">PoisonPill</span>	<span class="comment">// 如果卖光了就服毒自杀，这会导致当前actor被清理</span></div><div class="line">      &#125;</div><div class="line"></div><div class="line">      tickets.headOption.foreach &#123; ticket =&gt;</div><div class="line">        tickets = tickets.tail</div><div class="line">        sender ! ticket</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h4 id="BoxOffice"><a href="#BoxOffice" class="headerlink" title="BoxOffice"></a>BoxOffice</h4><p>BoxOffice 需要为每个event都创建TicketSeller，并把买票请求代理给他们。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">BoxOffice</span> <span class="keyword">extends</span> <span class="title">Actor</span> <span class="keyword">with</span> <span class="title">CreateTicketSellers</span> <span class="keyword">with</span> <span class="title">ActorLogging</span> </span>&#123;</div><div class="line">  <span class="keyword">import</span> <span class="type">TicketProtocol</span>._</div><div class="line">  <span class="keyword">import</span> context._</div><div class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> timeout = <span class="type">Timeout</span>(<span class="number">5</span> seconds)</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</div><div class="line"></div><div class="line">    <span class="keyword">case</span> <span class="type">Event</span>(name, nrOfTickets) =&gt;</div><div class="line">      log.info(<span class="string">s"Creating new event <span class="subst">$&#123;name&#125;</span> with <span class="subst">$&#123;nrOfTickets&#125;</span> tickets."</span>)</div><div class="line"></div><div class="line">      <span class="keyword">if</span>(context.child(name).isEmpty) &#123;	<span class="comment">// 如果这个name的TicketSeller还没有的话</span></div><div class="line">        <span class="keyword">val</span> ticketSeller = createTicketSeller(name)</div><div class="line"></div><div class="line">        <span class="comment">// 塞进初始数量的票</span></div><div class="line">        <span class="keyword">val</span> tickets = <span class="type">Tickets</span>((<span class="number">1</span> to nrOfTickets).map(nr=&gt; <span class="type">Ticket</span>(name, nr)).toList)</div><div class="line">        ticketSeller ! tickets</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      sender ! <span class="type">EventCreated</span></div><div class="line"></div><div class="line">    <span class="keyword">case</span> <span class="type">TicketRequest</span>(name) =&gt;</div><div class="line">      log.info(<span class="string">s"Getting a ticket for the <span class="subst">$&#123;name&#125;</span> event."</span>)</div><div class="line"></div><div class="line">      <span class="comment">// 将BuyTicket message传递给TicketSeller</span></div><div class="line">      context.child(name) <span class="keyword">match</span> &#123;</div><div class="line">        <span class="keyword">case</span> <span class="type">Some</span>(ticketSeller) =&gt; ticketSeller.forward(<span class="type">BuyTicket</span>)</div><div class="line">        <span class="keyword">case</span> <span class="type">None</span>               =&gt; sender ! <span class="type">SoldOut</span> <span class="comment">// 如果找不到对应的ticketSeller，就返回SoldOut message给sender，也就是RestInterface</span></div><div class="line">      &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">// 向所有的ticketSeller收集当前票数，然后弄成一个list。ask是一个异步操作，因为我们不希望BoxOffice阻塞，而停止处理其他request。</span></div><div class="line">    <span class="keyword">case</span> <span class="type">GetEvents</span> =&gt;</div><div class="line">      <span class="keyword">import</span> akka.pattern.ask</div><div class="line"></div><div class="line">      <span class="keyword">val</span> capturedSender = sender</div><div class="line"></div><div class="line">      <span class="comment">// 向TicketSeller传递GetEvents message的本地方法</span></div><div class="line">      <span class="function"><span class="keyword">def</span> <span class="title">askAndMapToEvent</span></span>(ticketSeller:<span class="type">ActorRef</span>) =  &#123;</div><div class="line">      	<span class="comment">// 不阻塞的获取每个name下的票数，futureInt会在执行完后获取到应得的value</span></div><div class="line">        <span class="keyword">val</span> futureInt = ticketSeller.ask(<span class="type">GetEvents</span>).mapTo[<span class="type">Int</span>]</div><div class="line"></div><div class="line">        futureInt.map(nrOfTickets =&gt;</div><div class="line">          <span class="comment">// 将future的值转化为Event</span></div><div class="line">          <span class="type">Event</span>(ticketSeller.actorRef.path.name, nrOfTickets))</div><div class="line">      &#125;</div><div class="line"></div><div class="line">  	  <span class="comment">// 遍历所有的ticketSeller</span></div><div class="line">      <span class="keyword">val</span> futures = context.children.map(ticketSeller =&gt;</div><div class="line">        askAndMapToEvent(ticketSeller))</div><div class="line"></div><div class="line">      <span class="comment">// 所有future都得到值后，发送信息。</span></div><div class="line">      <span class="type">Future</span>.sequence(futures).map &#123; events =&gt;</div><div class="line">        capturedSender ! <span class="type">Events</span>(events.toList)</div><div class="line">      &#125;</div><div class="line"></div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 注意是使用context创建的actor：谁创建的，谁就是这个新actor的supervisor</span></div><div class="line"><span class="class"><span class="keyword">trait</span> <span class="title">CreateTicketSellers</span> </span>&#123; self:<span class="type">Actor</span> =&gt;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">createTicketSeller</span></span>(name:<span class="type">String</span>) =  context.actorOf(<span class="type">Props</span>[<span class="type">TicketSeller</span>], name)</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上例中我们使用ask返回的是一个Future对象，这个东西是在未来某个时间点才会有值的。获取一个future引用，定义当这个值<strong>可用后</strong>要做的操作，而不是阻塞等待执行完毕，也不要直接使用这个future。第七章我们会深入探索Future的特性，弄清楚这些非阻塞的异步请求的运作原理。</p>
<h4 id="RestInterface"><a href="#RestInterface" class="headerlink" title="RestInterface"></a>RestInterface</h4><p>RestInterface使用了Spray routing DSL，后面第九章会详解：当service越来越大，复杂的路由也越来越多。我们这个例子里倒是很少，因为只是卖票而已。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.goticks</div><div class="line"></div><div class="line"><span class="keyword">import</span> akka.actor._</div><div class="line"></div><div class="line"><span class="keyword">import</span> spray.routing._</div><div class="line"><span class="keyword">import</span> spray.http.<span class="type">StatusCodes</span></div><div class="line"><span class="keyword">import</span> spray.httpx.<span class="type">SprayJsonSupport</span>._</div><div class="line"><span class="keyword">import</span> spray.routing.<span class="type">RequestContext</span></div><div class="line"><span class="keyword">import</span> akka.util.<span class="type">Timeout</span></div><div class="line"><span class="keyword">import</span> scala.concurrent.duration._</div><div class="line"><span class="keyword">import</span> scala.language.postfixOps</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">RestInterface</span> <span class="keyword">extends</span> <span class="title">HttpServiceActor</span></span></div><div class="line">  <span class="keyword">with</span> <span class="type">RestApi</span> &#123;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= runRoute(routes)</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">trait</span> <span class="title">RestApi</span> <span class="keyword">extends</span> <span class="title">HttpService</span> <span class="keyword">with</span> <span class="title">ActorLogging</span> </span>&#123; actor: <span class="type">Actor</span> =&gt;</div><div class="line">  <span class="keyword">import</span> context.dispatcher</div><div class="line">  <span class="keyword">import</span> com.goticks.<span class="type">TicketProtocol</span>._</div><div class="line"></div><div class="line">  <span class="keyword">implicit</span> <span class="keyword">val</span> timeout = <span class="type">Timeout</span>(<span class="number">10</span> seconds)</div><div class="line">  <span class="keyword">import</span> akka.pattern.ask</div><div class="line">  <span class="keyword">import</span> akka.pattern.pipe</div><div class="line"></div><div class="line">  <span class="comment">// 初始化就创建一个BoxOffice</span></div><div class="line">  <span class="keyword">val</span> boxOffice = context.actorOf(<span class="type">Props</span>[<span class="type">BoxOffice</span>])</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">routes</span></span>: <span class="type">Route</span> =</div><div class="line"></div><div class="line">    path(<span class="string">"events"</span>) &#123;</div><div class="line">      put &#123;</div><div class="line">        entity(as[<span class="type">Event</span>]) &#123; event =&gt; requestContext =&gt;</div><div class="line">          <span class="keyword">val</span> responder = createResponder(requestContext)</div><div class="line">          boxOffice.ask(event).pipeTo(responder)</div><div class="line">        &#125;</div><div class="line">      &#125; ~</div><div class="line">      get &#123; requestContext =&gt;</div><div class="line">        <span class="keyword">val</span> responder = createResponder(requestContext)</div><div class="line">        boxOffice.ask(<span class="type">GetEvents</span>).pipeTo(responder)</div><div class="line">      &#125;</div><div class="line">    &#125; ~</div><div class="line">    path(<span class="string">"ticket"</span>) &#123;</div><div class="line">      <span class="comment">/**</span></div><div class="line">      entity方法把request直接解析成一个TicketRequest对象，不用我们自己再去编写代码来映射到对象。</div><div class="line">      response被pipe到一个使用pipe模型的responder。</div><div class="line">      */</div><div class="line">      get &#123;</div><div class="line">        entity(as[<span class="type">TicketRequest</span>]) &#123; ticketRequest =&gt; requestContext =&gt;</div><div class="line">          <span class="keyword">val</span> responder = createResponder(requestContext)</div><div class="line">          boxOffice.ask(ticketRequest).pipeTo(responder)</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125; ~</div><div class="line">    path(<span class="string">"ticket"</span> / <span class="type">Segment</span>) &#123; eventName =&gt; requestContext =&gt;</div><div class="line">      <span class="keyword">val</span> req = <span class="type">TicketRequest</span>(eventName)</div><div class="line">      <span class="keyword">val</span> responder = createResponder(requestContext)</div><div class="line">      boxOffice.ask(req).pipeTo(responder)</div><div class="line">    &#125;</div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">createResponder</span></span>(requestContext:<span class="type">RequestContext</span>) = &#123;</div><div class="line">    context.actorOf(<span class="type">Props</span>(<span class="keyword">new</span> <span class="type">Responder</span>(requestContext)))</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">// 围绕一个HTTP request生命周期的Responder，发送消息给BoxOffice，同时也处理来自TicketSeller和BoxOffice的response。</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Responder</span>(<span class="params">requestContext:<span class="type">RequestContext</span></span>) <span class="keyword">extends</span> <span class="title">Actor</span> <span class="keyword">with</span> <span class="title">ActorLogging</span> </span>&#123;</div><div class="line">  <span class="keyword">import</span> <span class="type">TicketProtocol</span>._</div><div class="line">  <span class="keyword">import</span> spray.httpx.<span class="type">SprayJsonSupport</span>._</div><div class="line"></div><div class="line">  <span class="comment">// responder接收到TicketSeller返回的以下四类消息后就算完成了HTTP request。之后自杀。</span></div><div class="line">  <span class="function"><span class="keyword">def</span> <span class="title">receive</span> </span>= &#123;</div><div class="line"></div><div class="line">    <span class="keyword">case</span> ticket:<span class="type">Ticket</span> =&gt;</div><div class="line">      requestContext.complete(<span class="type">StatusCodes</span>.<span class="type">OK</span>, ticket)</div><div class="line">      self ! <span class="type">PoisonPill</span></div><div class="line"></div><div class="line">    <span class="keyword">case</span> <span class="type">EventCreated</span> =&gt;</div><div class="line">      requestContext.complete(<span class="type">StatusCodes</span>.<span class="type">OK</span>)</div><div class="line">      self ! <span class="type">PoisonPill</span></div><div class="line"></div><div class="line">    <span class="keyword">case</span> <span class="type">SoldOut</span> =&gt;</div><div class="line">      requestContext.complete(<span class="type">StatusCodes</span>.<span class="type">NotFound</span>)</div><div class="line">      self ! <span class="type">PoisonPill</span></div><div class="line"></div><div class="line">    <span class="keyword">case</span> <span class="type">Events</span>(events) =&gt;</div><div class="line">      requestContext.complete(<span class="type">StatusCodes</span>.<span class="type">OK</span>, events)</div><div class="line">      self ! <span class="type">PoisonPill</span></div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> akka </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[solr上手（四）]]></title>
      <url>/2015/08/06/solr%E4%B8%8A%E6%89%8B-4/</url>
      <content type="html"><![CDATA[<p>走马观花过完了solr官方的入门文档，我们下一个目的就是搞清楚Collection的CURD, 以及弄清楚schema在哪里配置或者生成的。</p>
<p>找到官方wiki跟做.</p>
<h3 id="创建Collection"><a href="#创建Collection" class="headerlink" title="创建Collection"></a>创建Collection</h3><blockquote>
<p>localhost:8983/admin/collections?action=CREATE&amp;name=willCollection&amp;numShards=2&amp;replicationFactor=1</p>
</blockquote>
<p><img src="/imgs/solr/4.1 solrCloud创建collection.png" alt="1 solrCloud创建collection"><br><img src="/imgs/solr/4.2 创建collection后即可在core看到信息.png" alt="2 创建collection后即可在core看到信息"></p>
<p>其他操作其实就参考<a href="https://cwiki.apache.org/confluence/display/solr/Collections+API就可以了，没什么好抄袭的感觉。" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/solr/Collections+API就可以了，没什么好抄袭的感觉。</a></p>
<h3 id="schema相关"><a href="#schema相关" class="headerlink" title="schema相关"></a>schema相关</h3><p>一直纳闷儿solr里是不是像ES那样的数据结构： index -&gt; type -&gt; field？经过各种纠结的实验后，总结出：No！！<br>配置有两种情况，当运行solr单例的时候，5.2.1版本配置文件是放置在server/configsets/basic_configs/conf/schema.xml的，这里面记录了所有field的schema，没错整个示例都用同一个schema！不分什么type，大家在一起！</p>
<p><img src="/imgs/solr/4.3 schema配置文件.png" alt="3 schema配置文件"></p>
<p>但是我怎么也找不到例子cloud里的那些字段所在的schema文件，到example和solr目录下都么有。。。功夫不负有心人，想到了zookeeper，连接上去查看一下，果然看到了预期的结果。<br><img src="/imgs/solr/4.4 solr的zookeeper存储.png" alt="4 solr的zookeeper存储"></p>
<p>贼不走空，我更不闲看到的信息多，顺便就也看了一下其他的数据节点。</p>
<p>另外，其实solr的schema在restful API也是可查的，这个可参考：<a href="https://cwiki.apache.org/confluence/display/solr/Schema+API" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/solr/Schema+API</a></p>
<p><img src="/imgs/solr/4.5solr的线上schema查询.png" alt="5 solr的线上schema查询"></p>
]]></content>
      
        
        <tags>
            
            <tag> solr </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[solr上手（三）]]></title>
      <url>/2015/08/06/solr%E4%B8%8A%E6%89%8B-3/</url>
      <content type="html"><![CDATA[<p>前面说了一些简单的查询，这一章我们介绍一些稍微复杂些的 —— faceting，可以理解是切片，它是solr最牛逼的特性之一。就是针对查到的数据再进行一些聚合处理。看例子，明白的快些。</p>
<h2 id="facet-分组查询"><a href="#facet-分组查询" class="headerlink" title="facet[分组查询]"></a>facet[分组查询]</h2><h3 id="field-facets"><a href="#field-facets" class="headerlink" title="field facets"></a>field facets</h3><p>除了查询返回的信息，还会包括根据facet.field进行分组的count数.</p>
<p><img src="/imgs/solr/3.1 field facet实例.png" alt="1 field facet实例"></p>
<h3 id="range-facets"><a href="#range-facets" class="headerlink" title="range facets"></a>range facets</h3><blockquote>
<p><a href="http://localhost:8983/solr/gettingstarted/select?q=*:*&amp;wt=json&amp;indent=on&amp;rows=0&amp;facet=true%20&amp;facet.range=price&amp;f.price.facet.range.start=0&amp;f.price.facet.range.end=600%20&amp;f.price.facet.range.gap=50&amp;facet.range.other=after" target="_blank" rel="external">http://localhost:8983/solr/gettingstarted/select?q=*:*&amp;wt=json&amp;indent=on&amp;rows=0&amp;facet=true%20&amp;facet.range=price&amp;f.price.facet.range.start=0&amp;f.price.facet.range.end=600%20&amp;f.price.facet.range.gap=50&amp;facet.range.other=after</a></p>
</blockquote>
<p><img src="/imgs/solr/3.2 range facet实例.png" alt="2 range facet实例"></p>
<p>看到，这个例子是针对某个字段进行一些区间划分，然后计算每个区间的count数。</p>
<h3 id="Pivot-facets"><a href="#Pivot-facets" class="headerlink" title="Pivot facets"></a>Pivot facets</h3><p>不太好理解，可以里结果多维分组count。</p>
<blockquote>
<p><a href="http://localhost:8983/solr/gettingstarted/select?q=*:*&amp;rows=0&amp;wt=json&amp;indent=on&amp;facet=on&amp;facet.pivot=cat,inStock" target="_blank" rel="external">http://localhost:8983/solr/gettingstarted/select?q=*:*&amp;rows=0&amp;wt=json&amp;indent=on&amp;facet=on&amp;facet.pivot=cat,inStock</a></p>
</blockquote>
<p><img src="/imgs/solr/3.3 povit facet实例.png" alt="3 povit facet实例"></p>
<p>此例是先对cat字段分组，之后基于此，再对inStock进行分组计数。 </p>
<p>参考：<a href="http://www.cnblogs.com/ontheroad_lee/p/3526385.html" target="_blank" rel="external">http://www.cnblogs.com/ontheroad_lee/p/3526385.html</a><br><a href="http://hongweiyi.com/2013/03/apache-solr-facet-introduction/" target="_blank" rel="external">http://hongweiyi.com/2013/03/apache-solr-facet-introduction/</a><br><a href="https://cwiki.apache.org/confluence/display/solr/Faceting" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/solr/Faceting</a></p>
<h2 id="spatial-空间查询"><a href="#spatial-空间查询" class="headerlink" title="spatial[空间查询]"></a>spatial[空间查询]</h2><p>solr是支持复杂的空间查询的，例如某个位置点的某个距离的圆的范围，按照距离排序等。我们可以到example/exampledocs/*.xml看一些示例数据，用这些数据来展示solr牛逼的空间能力。</p>
<p>启动测试solr</p>
<blockquote>
<p>bin/solr start -e techproducts</p>
</blockquote>
<p>把数据导入进本地solr里</p>
<blockquote>
<p>bin/post -c techproducts example/exampledocs/*.xml</p>
</blockquote>
<p><img src="/imgs/solr/3.4 空间实例数据.png" alt="4 空间实例数据"></p>
<p>空间查询和其他类型的查询也是可以结合在一起进行的，例如查距离San Francisco十公里内的ipod。</p>
<blockquote>
<p><a href="http://localhost:8983/solr/techproducts/browse?q=ipod&amp;pt=37.7752,-122.4232&amp;d=10&amp;sfield=store&amp;fq={!bbox}&amp;queryOpts=spatial&amp;queryOpts=spatial" target="_blank" rel="external">http://localhost:8983/solr/techproducts/browse?q=ipod&amp;pt=37.7752,-122.4232&amp;d=10&amp;sfield=store&amp;fq={!bbox}&amp;queryOpts=spatial&amp;queryOpts=spatial</a></p>
</blockquote>
<p><img src="/imgs/solr/3.5 空间查询.png" alt="5 空间查询"></p>
<p>这里我们使用了/browse界面进行查询【奇怪的是cloud和techproducts的/browse界面是不一样的】</p>
<p>详见<a href="https://cwiki.apache.org/confluence/display/solr/Spatial+Search" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/solr/Spatial+Search</a></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>目前位置我们玩儿了：</p>
<ul>
<li>以SolrCloud方式启动solr，两个节点，每个core两个shard，两个备份</li>
<li>向solr里批量导入数据</li>
<li>使用Solr admin UI进行一些查询</li>
<li>使用/browse接口的一些功能</li>
</ul>
<p>其实有个脚本。。。我擦擦擦擦！才他么说！！！！<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">date ;</div><div class="line">bin/solr start -e cloud -noprompt ;</div><div class="line">  open http://localhost:8983/solr ;</div><div class="line">  bin/post -c gettingstarted docs/ ;</div><div class="line">  open http://localhost:8983/solr/gettingstarted/browse ;</div><div class="line">  bin/post -c gettingstarted example/exampledocs/*.xml ;</div><div class="line">  bin/post -c gettingstarted example/exampledocs/books.json ;</div><div class="line">  bin/post -c gettingstarted example/exampledocs/books.csv ;</div><div class="line">  bin/post -c gettingstarted -d &quot;&lt;delete&gt;&lt;id&gt;SP2514N&lt;/id&gt;&lt;/delete&gt;&quot; ;</div><div class="line">  bin/solr healthcheck -c gettingstarted ;</div><div class="line">date ;</div></pre></td></tr></table></figure></p>
<h2 id="清理工作"><a href="#清理工作" class="headerlink" title="清理工作"></a>清理工作</h2><blockquote>
<p>bin/solr stop -all ; rm -Rf example/cloud/</p>
</blockquote>
]]></content>
      
        
        <tags>
            
            <tag> solr </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[Morphlines: 集成Hadoop ETL app的利器]]></title>
      <url>/2015/08/05/Morphlines-%E9%9B%86%E6%88%90Hadoop-ETL-app%E7%9A%84%E5%88%A9%E5%99%A8/</url>
      <content type="html"><![CDATA[<blockquote>
<p><strong> Morphlines replaces Java programming with simple configuration steps, reducing the cost and effort of doing custom ETL </strong> .</p>
</blockquote>
<hr>
<p>使用Morphlines我们可以不用进行实际的繁琐编程而进行ETL工作，不用了解MR技术。一个morphline是指的一个配置文件，通过这个配置文件，我们可以从任意的数据源消费数据，然后通过一个的transformation chain，最终将处理结果送进某个Hadoop组件中去。相比编程java而言，我们只需要配置一下就可以了 。</p>
<p>Morphlines是一个可嵌入的java工具包，一个morphline是transformation command的一个内置container。command是morphline的Plugin，也就是加载数据、解析数据、转化数据或者其他针对某record进行某些操作。这里说的record是指的内存中的name-values对，它也可以有一些blob附件或者pojo附件。这个框架已经以一种直接而简单的方式将现有的功能与一些第三方系统进行了集成，而且扩展性较好。</p>
<p>Morphlines是服务于cloudera search的。它致力于flume和MR的ETL，前者是实时流，后者是批处理。</p>
<p>这篇文章，我们会通过一个例子讲明如果使用Morphlines怎样收集syslog的输出，并使之能在solr中进行查询。但是在此之前，我们还是先认识一下Morphlines的数据模型和数据处理模型。</p>
<h3 id="数据处理模型"><a href="#数据处理模型" class="headerlink" title="数据处理模型"></a>数据处理模型</h3><p>Morphlines可以说是Unix pipeline的进化，它将要处理的数据泛化。一个morphline负责的工作：消费record(可以是flume events, HDFS文件，RDBMS 表，或者Apache avro 对象等)，将消费的record转为流，将这些流以管道的形式通过一些列的配置好的transformation，最后进入目的地，例如本例中的solr。<br><img src="/imgs/morphlines/morphline-1.1 处理流程.png" alt="1 处理流程"></p>
<p>如上图所示，Flume Source读取syslog后将event弄到Morphlines Sink里去，然后Morphlines Sink把flume的event转为一个record，交给后面的一连串command进行处理。第一个command readLine抽取log行，第二个command grok使用正则抽取log行里的一部分关键信息。第三个command loadSolr就把上个command输出的结构化的信息索引进入solr了。在这个过程中，原始数据或者半结构化数据根据app的模型需求通过一些列转化成为结构化数据被存储。</p>
<p>Morphlines已经有了一些常用的转化和IO操作功能，但是我们仍然可以通过Plugin system加入一些新的转化和IO操作类型，也可以集成其他的第三方框架。</p>
<p>使用Morphlines可以很简单地实现ETL应用间的ETL逻辑的重用。</p>
<p>SDK是在运行时编译的。所有的command都在同一个线程内执行，也就是说pipline是通过某个方法调用另一个方法实现的。不存在队列，不存在线程间对象传递，不存在context切换，不存在command之间的序列化问题。</p>
<h3 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h3><p>Morphlines操作海量数据。一个command可能对一个record进行transformation之后会产生零个或多个record。数据模型如下：一个record包含一些列的name-value对，所有record包含的filed应该是一样的(可以理解成command的产出是有一定的schema的)，而一个name可以对应多个value，一个value可以是任何java对象。这个灵活的数据模型其实和Lucene/solr的数据模型很像。</p>
<p><img src="/imgs/morphlines/morphline-1.2 record数据模型.png" alt="2. record数据模型与实例"></p>
<p>一个morphline可以处理结构化数据和二进制数据。还有一些可选的附件属性，这些附件属性可以结合Email那些东西进行理解。</p>
<p>这种通用的数据模型可以支持很多应用。典型应用就是Apache flume Morphlines Solr Sink。它把flume event的body放进了morphline record的_attachment_body字段中，event的header信息全部写成record的name-value对。另一个例子就是MapReduceIndexerTool的Mapper，将当前正在处理的HDFS文件的InputStream写入morphline record的_attachment_body字段中，把HDFS文件的元数据信息写成了record的name-value对。</p>
<h3 id="用例"><a href="#用例" class="headerlink" title="用例"></a>用例</h3><p>command可以操作record的所有字段，包括解析、添加、删除、重命名、分割，甚至还能删除整个record。command有一个返回值来指示处理结果成功或失败。</p>
<p>例如一个多行的输入可以被一个command把每行切分为一个record输出，也就是产生多个record输出，然后另一个command在针对每一行使用正则切分为单词或短语(根据业务需求)，产生更多的record输出。</p>
<p>command可以对record做的操作包括：抽取、清理、转化、join、integrate、enrich、以各种方式装饰record。例如，可以使record与外部数据(RDBMS, KVDB,本地文件等)join。</p>
<p>command还可以消费record，然后把它们传送给某个外部系统。</p>
<h3 id="嵌入host系统"><a href="#嵌入host系统" class="headerlink" title="嵌入host系统"></a>嵌入host系统</h3><p>一个Morphline没有任何的持久化、分布式计算、可靠性、节点失败恢复等概念——它只是一个当前线程中的transformation chain而已。morphline没必要管理多线程、多节点，因为这些已经有MR,Flume，Storm等去做了。但是morphline还是会给command子树传递一些通知消息：BEGIN_TRANSACTION, COMMIT_TRANSACTION, ROLLBACK_TRANSACTION, SHUTDOWN.</p>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><p>配置文件使用HOCON格式，参考<a href="http://github.com/typesafehub/config/blob/master/HOCON.md" target="_blank" rel="external">http://github.com/typesafehub/config/blob/master/HOCON.md</a></p>
<h3 id="目前可用command"><a href="#目前可用command" class="headerlink" title="目前可用command"></a>目前可用command</h3><p>详见<a href="http://kitesdk.org/docs/current/kite-morphlines/morphlinesReferenceGuide.html" target="_blank" rel="external">http://kitesdk.org/docs/current/kite-morphlines/morphlinesReferenceGuide.html</a></p>
<h3 id="syslog案例"><a href="#syslog案例" class="headerlink" title="syslog案例"></a>syslog案例</h3><p><strong>需求</strong>：抽取syslog的内容，并索引到solr里。</p>
<blockquote>
<p>Feb  4 10:46:14 syslog sshd[607]: listening on 0.0.0.0 port 22.</p>
</blockquote>
<p>以上为log示例. 我们需要抽取的record如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">priority : 164</div><div class="line">timestamp : Feb  4 10:46:14</div><div class="line">hostname : syslog</div><div class="line">program : sshd</div><div class="line">pid : 607</div><div class="line">msg : listening on 0.0.0.0 port 22.</div><div class="line">message : Feb  4 10:46:14 syslog sshd[607]: listening on 0.0.0.0 port 22.</div></pre></td></tr></table></figure>
<p>morphline配置 morphline.conf内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line">morphlines : [</div><div class="line">  &#123;</div><div class="line">    # Name used to identify a morphline. E.g. used if there are multiple</div><div class="line">    # morphlines in a morphline config file</div><div class="line">    id : morphline1</div><div class="line"> </div><div class="line">    # Import all morphline commands in these java packages and their</div><div class="line">    # subpackages. Other commands that may be present on the classpath are</div><div class="line">    # not visible to this morphline.</div><div class="line">    importCommands : [&quot;com.cloudera.**&quot;, &quot;org.apache.solr.**&quot;]</div><div class="line"> </div><div class="line">    commands : [</div><div class="line">      &#123;</div><div class="line">        # Parse input attachment and emit a record for each input line               </div><div class="line">        readLine &#123;</div><div class="line">          charset : UTF-8</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"> </div><div class="line">      &#123;</div><div class="line">        grok &#123;</div><div class="line">          # Consume the output record of the previous command and pipe another</div><div class="line">          # record downstream.</div><div class="line">          #</div><div class="line">          # A grok-dictionary is a config file that contains prefabricated</div><div class="line">          # regular expressions that can be referred to by name. grok patterns</div><div class="line">          # specify such a regex name, plus an optional output field name.</div><div class="line">          # The syntax is %&#123;REGEX_NAME:OUTPUT_FIELD_NAME&#125;</div><div class="line">          # The input line is expected in the &quot;message&quot; input field.</div><div class="line">          dictionaryFiles : [src/test/resources/grok-dictionaries]</div><div class="line">          expressions : &#123;</div><div class="line">            message : &quot;&quot;&quot;%&#123;SYSLOGTIMESTAMP:timestamp&#125; %&#123;SYSLOGHOST:hostname&#125; %&#123;DATA:program&#125;(?:\[%&#123;POSINT:pid&#125;\])?: %&#123;GREEDYDATA:msg&#125;&quot;&quot;&quot;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"> </div><div class="line">      # Consume the output record of the previous command, convert</div><div class="line">      # the timestamp, and pipe another record downstream.</div><div class="line">      #</div><div class="line">      # convert timestamp field to native Solr timestamp format</div><div class="line">      # e.g. 2012-09-06T07:14:34Z to 2012-09-06T07:14:34.000Z</div><div class="line">      &#123;</div><div class="line">        convertTimestamp &#123;</div><div class="line">          field : timestamp</div><div class="line">          inputFormats : [&quot;yyyy-MM-dd&apos;T&apos;HH:mm:ss.SSS&apos;Z&apos;&quot;, &quot;&quot;MMM d HH:mm:ss&quot;]</div><div class="line">          inputTimezone : America/Los_Angeles</div><div class="line">          outputFormat : &quot;yyyy-MM-dd&apos;T&apos;HH:mm:ss.SSS&apos;Z&apos;&quot;</div><div class="line">          outputTimezone : UTC</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"> </div><div class="line">      # Consume the output record of the previous command, transform it</div><div class="line">      # and pipe the record downstream.</div><div class="line">      #</div><div class="line">      # This command deletes record fields that are unknown to Solr</div><div class="line">      # schema.xml. Recall that Solr throws an exception on any attempt to</div><div class="line">      # load a document that contains a field that isn&apos;t specified in</div><div class="line">      # schema.xml.</div><div class="line">      &#123;</div><div class="line">        sanitizeUnknownSolrFields &#123;</div><div class="line">          # Location from which to fetch Solr schema</div><div class="line">          solrLocator : &#123;           </div><div class="line">            collection : collection1       # Name of solr collection</div><div class="line">            zkHost : &quot;127.0.0.1:2181/solr&quot; # ZooKeeper ensemble</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"> </div><div class="line">      # log the record at INFO level to SLF4J</div><div class="line">      &#123; logInfo &#123; format : &quot;output record: &#123;&#125;&quot;, args : [&quot;@&#123;&#125;&quot;] &#125; &#125;</div><div class="line"> </div><div class="line">      # load the record into a Solr server or MapReduce Reducer</div><div class="line">      &#123;</div><div class="line">        loadSolr &#123;</div><div class="line">          solrLocator : &#123;           </div><div class="line">            collection : collection1       # Name of solr collection</div><div class="line">            zkHost : &quot;127.0.0.1:2181/solr&quot; # ZooKeeper ensemble</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    ]</div><div class="line">  &#125;</div><div class="line">]</div></pre></td></tr></table></figure>
<p>想要看到每个command处理的record的内容的话，可以配置log4j.properties：</p>
<blockquote>
<p>log4j.logger.com.cloudera.cdk.morphline=TRACE</p>
</blockquote>
<h3 id="其他文档"><a href="#其他文档" class="headerlink" title="其他文档"></a>其他文档</h3><ul>
<li><a href="http://www.cloudera.com/content/cloudera/en/documentation/cloudera-search/v1-latest/Cloudera-Search-User-Guide/csug_morphline_example.html" target="_blank" rel="external">http://www.cloudera.com/content/cloudera/en/documentation/cloudera-search/v1-latest/Cloudera-Search-User-Guide/csug_morphline_example.html</a></li>
<li><a href="http://www.slideshare.net/cloudera/using-morphlines-for-onthefly-etl" target="_blank" rel="external">http://www.slideshare.net/cloudera/using-morphlines-for-onthefly-etl</a></li>
<li><a href="https://flume.apache.org/FlumeUserGuide.html#morphlinesolrsink" target="_blank" rel="external">https://flume.apache.org/FlumeUserGuide.html#morphlinesolrsink</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> Morphlines </tag>
            
            <tag> ETL </tag>
            
            <tag> Flume </tag>
            
            <tag> Solr </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[solr上手（二）]]></title>
      <url>/2015/08/04/solr%E4%B8%8A%E6%89%8B-2/</url>
      <content type="html"><![CDATA[<p>前面是提到了solr是支持很多中其他交流方式的。这章我们使用solr的REST API进行查询工作。</p>
<h3 id="简单查询"><a href="#简单查询" class="headerlink" title="简单查询"></a>简单查询</h3><p>首先在主界面选择我们要查询的core，然后点击query，默认查询的条件是<em>:</em>，也就是任何字段任何值都是可以接收的，也就是全量数据了。</p>
<p><img src="/imgs/solr/2.1 solr的web端查询.png" alt="2.1 solr的web端查询.png"></p>
<p>单击请求的实际URL部分，可以跳入这个请求：<a href="http://localhost:8983/solr/willCollection_shard1_replica1/select?q=*%3A*&amp;wt=json&amp;indent=true" target="_blank" rel="external">http://localhost:8983/solr/willCollection_shard1_replica1/select?q=*%3A*&amp;wt=json&amp;indent=true</a></p>
<h3 id="基本查询"><a href="#基本查询" class="headerlink" title="基本查询"></a>基本查询</h3><blockquote>
<p>curl “<a href="http://localhost:8983/solr/gettingstarted/select?wt=json&amp;indent=true&amp;q=foundation&amp;fl=id" target="_blank" rel="external">http://localhost:8983/solr/gettingstarted/select?wt=json&amp;indent=true&amp;q=foundation&amp;fl=id</a>“</p>
</blockquote>
<p>把×换成了foundation，也就是包含这个foundation关键字的doc，然后后面的fl指定了我们要的字段，所以结果如下图：<br><img src="/imgs/solr/2.2 solr简单查询-指定字段.png" alt="2.2 solr简单查询-全文匹配 -取指定字段.png"></p>
<blockquote>
<p>curl “<a href="http://localhost:8983/solr/gettingstarted/select?wt=json&amp;indent=true&amp;q=cat:book" target="_blank" rel="external">http://localhost:8983/solr/gettingstarted/select?wt=json&amp;indent=true&amp;q=cat:book</a>“</p>
</blockquote>
<p>上面这个查询q后面成了cat:book，其实q可以是key:value的方式来查询满足条件的doc。<br><img src="/imgs/solr/2.3 solr简单查询-字段匹配.png" alt="2.3 solr简单查询-字段匹配 -取指定字段.png"></p>
<h3 id="短语查询"><a href="#短语查询" class="headerlink" title="短语查询"></a>短语查询</h3><p>如果要匹配多个单词组合起来的短语，就需要使用双引号：q=”multiple terms here”,而且在URL中需要把空格替换为+加号,如下所示：</p>
<blockquote>
<p>curl “<a href="http://localhost:8983/solr/gettingstarted/select?wt=json&amp;indent=true&amp;q=\&quot;CAS+latency\" target="_blank" rel="external">http://localhost:8983/solr/gettingstarted/select?wt=json&amp;indent=true&amp;q=\&quot;CAS+latency\</a>“”</p>
</blockquote>
<p><img src="/imgs/solr/2.4 solr短语查询.png" alt="2.4 solr短语查询.png"></p>
<h3 id="组合查询"><a href="#组合查询" class="headerlink" title="组合查询"></a>组合查询</h3><p>有时我们需要在一个查询中匹配多个单词或短语，有时也需要除去一些不需要的，这时就用到了组合查询。当我们想要某个匹配项的时候就使用+，不想要就使用-</p>
<p><img src="/imgs/solr/2.5 solr组合查询.png" alt="2.5 solr组合查询.png"></p>
]]></content>
      
        
        <tags>
            
            <tag> solr </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[solr上手（一）]]></title>
      <url>/2015/08/03/solr%E4%B8%8A%E6%89%8B-1/</url>
      <content type="html"><![CDATA[<h3 id="首发"><a href="#首发" class="headerlink" title="首发"></a>首发</h3><p><img src="/imgs/solr/1.0 solr组件关系图.jpg" alt="solr组件关系图"></p>
<h3 id="1-先下载咯"><a href="#1-先下载咯" class="headerlink" title="1. 先下载咯"></a>1. 先下载咯</h3><h3 id="2-解压，执行命令"><a href="#2-解压，执行命令" class="headerlink" title="2. 解压，执行命令"></a>2. 解压，执行命令</h3><blockquote>
<p>solr start -e cloud -noprompt<br>解释一下这个命令的意思，启动就是启动咯。<br>-e 其实是example的简写，也就是指定启动solr官网的某个例子，然后cloud，你懂得。。。<br>后面那个暂时还不太清楚，目测是不需要交互神马的</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:/opt/softwares/solr-5.2.1# ./bin/solr start -e cloud -noprompt</div><div class="line"></div><div class="line">Welcome to the SolrCloud example!</div><div class="line"></div><div class="line"></div><div class="line">Starting up 2 Solr nodes for your example SolrCloud cluster.</div><div class="line">Creating Solr home directory /opt/softwares/solr-5.2.1/example/cloud/node1/solr</div><div class="line">Cloning Solr home directory /opt/softwares/solr-5.2.1/example/cloud/node1 into /opt/softwares/solr-5.2.1/example/cloud/node2</div><div class="line"></div><div class="line">Starting up SolrCloud node1 on port 8983 using command:</div><div class="line"></div><div class="line">solr start -cloud -s example/cloud/node1/solr -p 8983  -m 512m </div><div class="line"></div><div class="line"></div><div class="line">Waiting to see Solr listening on port 8983 [-]  </div><div class="line">Started Solr server on port 8983 (pid=7677). Happy searching!</div><div class="line"></div><div class="line">    </div><div class="line"></div><div class="line">Starting node2 on port 7574 using command:</div><div class="line"></div><div class="line">solr start -cloud -s example/cloud/node2/solr -p 7574 -z localhost:9983 -m 512m  </div><div class="line"></div><div class="line"></div><div class="line">Waiting to see Solr listening on port 7574 [|]  </div><div class="line">Started Solr server on port 7574 (pid=7932). Happy searching!</div><div class="line"></div><div class="line">Connecting to ZooKeeper at localhost:9983</div><div class="line">Uploading /opt/softwares/solr-5.2.1/server/solr/configsets/data_driven_schema_configs/conf for config gettingstarted to ZooKeeper at localhost:9983</div></pre></td></tr></table></figure>
<p>打开页面 <a href="http://localhost:8983/solr，看到solr管理的主界面，可以通过点击Cloud标签看到：包含两个shard,每个shard有一个备份。" target="_blank" rel="external">http://localhost:8983/solr，看到solr管理的主界面，可以通过点击Cloud标签看到：包含两个shard,每个shard有一个备份。</a><br><img src="/imgs/solr/1.1 solr Cloud视图.png" alt="1. solr Cloud 视图"></p>
<h3 id="3-使用docs文件夹索引数据"><a href="#3-使用docs文件夹索引数据" class="headerlink" title="3. 使用docs文件夹索引数据"></a>3. 使用docs文件夹索引数据</h3><p>现在solr虽然已经运行起来了，但是没有任何数据。为了测试方便，官网给带了一个快速插入数据的脚本bin/post，运行一下</p>
<blockquote>
<p>bin/post -c gettingstarted docs/ </p>
</blockquote>
<p>注意目前只支持shell，如果是window的话，需要运行【java  -jar example/exampledocs/post.jar -h】</p>
<p>命令行参数的解释：</p>
<ul>
<li>-c gettingstarted:  要把index创建到哪个collection下</li>
<li>docs/:  一个基于solr安装路径下docs目录的相对路径</li>
</ul>
<h3 id="4-使用xml-json-csv创建索引"><a href="#4-使用xml-json-csv创建索引" class="headerlink" title="4. 使用xml/json/csv创建索引"></a>4. 使用xml/json/csv创建索引</h3><h3 id="5-更新"><a href="#5-更新" class="headerlink" title="5. 更新"></a>5. 更新</h3><p>细心的你一定发现即便重复插入同样的数据，我们查询的时候还是不会出现多个，这是因为例子中的schema.xml中指定了主键uniqueKey为id.当我们向solr插入一个已经存在的uniqueKey的时候，会××自动替换××掉原来的记录。我们可以实验一下，一直插入同样一条文档，观察一下solr实例的状况，Num Docs一直不变。<br><img src="/imgs/solr/1.2 solr 实例查看.png" alt="2. solr 实例查看"><br>Max Docs除了包含所有的doc，还包含已经逻辑删除，但是还没有物理删除的doc。</p>
<h3 id="6-删除"><a href="#6-删除" class="headerlink" title="6. 删除"></a>6. 删除</h3><p>可以指定文档的uniqueKey来删除指定文档，也可以找到满足某个条件的所有文档进行删除，只要向solr的更新URL发送一个删除命令就可以了。</p>
<blockquote>
<p>bin/post -c gettingstarted -d “<delete><id>SP2514N</id></delete>“</p>
</blockquote>
<h3 id="7-搜索"><a href="#7-搜索" class="headerlink" title="7. 搜索"></a>7. 搜索</h3><p>我们可以通过REST client，curl，wget，Postman以及本地的solr客户端进行solr查询。<br>这章使用的命令行在实际程序里使用还是很少的。下一章我们会介绍使用REST对solr进行查询操作。</p>
<h3 id="异常"><a href="#异常" class="headerlink" title="异常"></a>异常</h3><p>Expected mime type application/octet-stream but got text/html.<br>针对不存在的索引插入数据时引发。</p>
]]></content>
      
        
        <tags>
            
            <tag> solr </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[matlib 安装与卸载]]></title>
      <url>/2015/08/03/matlib-%E5%AE%89%E8%A3%85%E4%B8%8E%E5%8D%B8%E8%BD%BD/</url>
      <content type="html"><![CDATA[<p>2004版本的那个主要就是兼容性问题，在win7下需要调整程序的<strong>兼容性</strong>，启动时候调整到Vista，卸载时调整到win 2000.</p>
<p>以下是2015a版本的安装，这个没有发现与win7的兼容性问题。转自<a href="http://tieba.baidu.com/p/3660998181?pn=1" target="_blank" rel="external">http://tieba.baidu.com/p/3660998181?pn=1</a></p>
<p>这个文件是分压缩卷，解压其中一个压缩包就行了，解压到你想解压到的地方，解压出来是一个镜像文件（即ISO格式的），然后用虚拟机加载，（可以下个“软碟通”进行加载），加载后，在我的电脑（计算机）中，硬盘分区下面的可移动储存设备中找到CD驱动器，双击进去.进去后进行下面的操作：</p>
<p>1.用管理员权限运行里面的setup.exe，然后等一会，他需要安装某些东西。</p>
<p>2.选择不联网安装，我有密钥，下一步，选择我有密钥（即第一个），然后把 <strong> 58691-35070-25550-28046-23042 </strong>这串数字复制粘贴进去，点下一步。</p>
<p>3.选择你想安装的东西，在前面打钩（他都给你打好了），不想装的把勾去掉，然后下一步，让他安装，这个安装比较漫长，等吧，可以干其他的事情去.</p>
<p>4.安装完成</p>
<p>5.这是时我们找到刚才计算机里硬盘分区下面的可移动储存设备中找到CD驱动器，进去后，找到crack这个文件夹，进去后复制</p>
<p><strong>bin,java,toolbox</strong>这三个文件夹，然后找到我们刚才安装这个软件的<strong>安装目录</strong>，把这三个文件夹粘贴进去，后面会弹出是否覆盖替换，选择覆盖替换，全部都覆盖替换。</p>
<p>6.由于这个软件没有创建桌面快捷方式，开始菜单里也没有，所以我们去这个软件的安装目录，找到你刚才安装这个软件的地方，这个软件的</p>
<p>安装目录下找到bin这个文件夹，双击进去把matlab.exe执行文件发送到桌面快捷方式（右键，发送，桌面快捷方式）。</p>
<p>6.在桌面上双击这个matlab.exe图标，因为这是第一次打开，等一会，会弹出一个激活框，选择“不连接Internet激活”，下一步，选择“输入许可证文件的完整路径”，点击“浏览”找到刚才计算机里硬盘分区下面的可移动储存设备中找到CD驱动器，双击进去找到crack这个文件夹，找到<strong>lic_standalone.dat</strong>，选择这个文件，然后点下<br>一步，激活成功！</p>
<p>7.完成！！！</p>
<p>尽情享受吧！！！</p>
<p>别忘了把刚才那个计算机里硬盘分区下面的可移动储存设备中找到CD驱动器弹出！（右键，弹出）</p>
<p>养成用最高管理员运行软件的好习惯！！！</p>
<p>下载地址：<a href="http://pan.baidu.com/s/1sjI603b" target="_blank" rel="external">http://pan.baidu.com/s/1sjI603b</a></p>
<p>密码：zxd0</p>
]]></content>
      
        
        <tags>
            
            <tag> matlib </tag>
            
            <tag> 2015a </tag>
            
            <tag> 2004 </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[akka in action 读书笔记（1）]]></title>
      <url>/2015/07/16/akka-%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89/</url>
      <content type="html"><![CDATA[<h2 id="什么是AKKA"><a href="#什么是AKKA" class="headerlink" title="什么是AKKA"></a>什么是AKKA</h2><p>akka：</p>
<ul>
<li>并行处理请求</li>
<li>和service与client进行并发交互</li>
<li>异步响应</li>
<li>事件驱动编程模型</li>
</ul>
<p>akka是被设计为一个工具而不是一个框架。框架是一个栈的某个独立的元素【比如UI层、web层等】，而akka可以用于这个栈中的任何部分，也可以为这些部分之间提供连接。<br>akka的每个module是由jar包组成的，已经尽量较少了各个jar之间的耦合，甚至akka-actor除了scala标准包没有任何其他依赖。另外akka还提供了一些集成其他组件(例如camel, zeromq等)的module。下图是akka技术栈的主要组件，也解释了client如果省去一些细节麻烦：<br><img src="/imgs/akka/akka1.1.png" alt="Figure 1.1 The Akka Stack"></p>
<p>akka自身提供运行时环境，有一个很小的叫做play mini的内核，可以做的事情简直让你叹为观止。akka应用主要是由actor组成，基于actor编程模型，借鉴自函数式编程语言ERLANG和Fanton。</p>
<hr>
<h3 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h3><p>问题：<br>考虑一个卖票的程序，如果一百万人同时向100个售票处买票，但是只有一个地方打印票。<br><img src="/imgs/akka/akka1.2.png" alt="Figure 1.2 Buying Tickets"></p>
<p><img src="/imgs/akka/akka1.3.png" alt="Figure 1.3 买票人、售票处、打印中心的关系"></p>
<p>面对以上问题，好多TicketingAgents都互相竞争，抢用打印机资源。解决方案有两个。对于一个基于线程的程序来说，最简单的实现就是为每个request直接fork一个线程，这简直就是灾难性的。就算是线程池的话，也可能每个请求都花比较长的时间而造成timeout，客户端还是会失败。另外，如果几个线程互相争抢并修改公用的资源同样会造成不良后果。</p>
<h5 id="方案1：共享状态"><a href="#方案1：共享状态" class="headerlink" title="方案1：共享状态"></a>方案1：共享状态</h5><p>看下图：</p>
<p><img src="/imgs/akka/akka1.4.png" alt="Figure 1.4 Buying sequence 买票人排队等待"><br>TicketingAgent取走一张票，然后告诉printing office打印。如果不能打印的话，就到3c，也就是卖完了。</p>
<p>这样，我们不必费力地控制Agent之间对Ticket的竞争。You can see, we didn’t have to go to great lengths to keep the Agents from blocking each other’s access to Tickets, and the result is also a bit clearer than what we would probably end up with if someone came in later and rewrote the selling sequence to make it concurrent.</p>
<p>使用线程的话有三个原因可能导致灾难性失败：</p>
<ul>
<li>thread starvation 当所有的线程都很忙或者都死锁了，无暇顾及新request的时候，都可能导致server关闭</li>
<li>race conditions 当某个共享资源被多个线程同时修改，可能会产生混乱，产生意想不到的结果</li>
<li>deadlock</li>
</ul>
<p>即便你避免了以上所有问题，就这些避免的措施也够让人头疼的。锁控制的边界不是太大就是太小。使用过多的锁，其实实际上的并发就会少了特别特别多。使用的锁不够多，就可能遇到各种各样的bug。掌握一个好的平衡点是很困难的事情。</p>
<p>TicketAgent们都得互相等待，这些TicketAgent的客户就也得等待。TicketAgent A的客户需要等着TicketAgent B的某个客户，听上去有点儿奇怪，有些等待的时间并没有那么必要。</p>
<h5 id="方案2：消息驱动"><a href="#方案2：消息驱动" class="headerlink" title="方案2：消息驱动"></a>方案2：消息驱动</h5><p>我们使用AKKA使得事情变简单的根源在于我们<code>避免使用共享状态</code>。我们必须改变以下三个方面：</p>
<ul>
<li>event和ticket在售票处和打印室中间以不可变的消息状态传递</li>
<li>售票处的打印请求被打印室异步放入队列，不用等待打印方法完成或者接受确认</li>
<li><p>售票处和打印室相互之间不是直接使用相互的引用，而是记录联系对方的地址，他们之间通过相互传递message来进行通讯，这些message暂时被放置于一个mailbox中，后面会被按照放入的次序被处理掉。</p>
<p>当然，有些新的问题也会出现：TicketAgents在卖光自己的票以后需要有一种方式获取更多的票供给。这很重要，我们使用传递不可变message的方式完成了这项工作，我们不必担心app是否能够承担住激增的请求。下图是修改后的顺序图：</p>
<p><img src="/imgs/akka/akka1.5.png" alt="Figure 1.5 TicketingAgent sequence 售票处排队等待"> </p>
</li>
</ul>
<p>那么售票处具体怎么拿到票呢？打印室会给每个售票处发送取票信息，每个Event都会包含N多票和这个Event的状态信息。有很多种方式发送message给所有的售票处，这里我们使用的是让售票处之间相互传递的方式。售票处们也都知道各自的位置，会传达给目标(我们会在akka中常常见到chain的形式，从简单的传递工作状态到分布式的基于actor的责任链设计模式)<br><img src="/imgs/akka/akka1.6.png" alt="Figure 1.6 Distributing tickets"><br>如果一个售票处取了event中的属于自己的票后还有剩余的，就继续传递下去，代表还有其他售票处没有拿到应得的票。如果所有的售票处都看过这个event了，一段时间后仍然没人认领，那就让这些票过期。</p>
<p>基于消息传递的模式有两个好处，一个是不用管任何锁，另外售票处也不用干等着response，也就是打印的票完成，再去处理下一个，现在打印室打印完了会通知售票处取票。即便打印室器材坏了，售票处仍然可以继续卖票，只要把新的打印室的地址标成原来打印室的地址即可。</p>
<p>这种方式其实就是典型的AKKA实现。TicketingAgent和打印室都可以通过AKKA Actor实现。Actor之间不共享状态，只能通过不可变的message进行通信，通过actorRef来进行交流，就像上面提到的地址。这种模型满足了我们上面提到的三处改变。那么它简单到了哪里呢？</p>
<ul>
<li>不用管理锁，不用为保护共享状态殚精竭虑</li>
<li><p>不用担心死锁、race condition、或者thread starvation。</p>
<p> 那么akka中就永远不会面临锁了么？当然不是的，只是你不用直接面对它而已。归根到底所有东西都是运行在线程和低级并发原始变量上的。Akka使用java的concurrent库来协调处理message，尽少地使用锁。</p>
</li>
</ul>
<hr>
<h3 id="容灾"><a href="#容灾" class="headerlink" title="容灾"></a>容灾</h3><p>基于message的方式可以允许在系统部分失灵的情况下保证系统继续有效运行。原因之一就是独立性，<strong>每个actor并不直接进行相互之间的交互</strong>。message是被发送到mailbox里的，爱谁处理谁处理，爱咋处理咋处理，sender发完就完事儿了。同样的事儿对于调用对象方法就行不通了。</p>
<p><img src="/imgs/akka/akka1.7.png" alt="Figure 1.7 Message Passing vs. Function Calling 消息传递与方法调用流程对比"></p>
<p>独立性还带来了另外的好处。如果某个actor挂了，他的地址被另一个actor所替代，会怎样呢？只要原来的actor被新的actor正确替换了，那么所有这个地址上的message都会被归到新actor名下。错误会被包含在处理不恰当的老的actor中，而新actor只要处理之后产生的message就可以了。（在这种方式下，出错的老actor在抛出异常后就不能继续处理message了，它要<strong>自杀然后魂飞魄散</strong>）。类似Sping的这些框架在container/bean级别做了这些处理，而akka是在运行时提供的可替代性(这就是actor的let it crash思想):<strong>我们事先就做好了准备，一旦某个handler会因为某些莫须有的理由处理不好他们的任务，这时就把它的任务交给别人来避免灾难性的失败</strong>。</p>
<p>需要注意的是：这是双向的。即便是上层失败了，那么下层可以继续工作直到新的领导人来接替工作。<strong>不会有断裂的chain</strong>，开发者不用关心任何chain可能会断裂的可能性，当然也不用针对每个可能性采取相应措施。一个失败的actor被替换的过程不会影响到任何其他的合作者，见下图</p>
<p><img src="/imgs/akka/akka1.8.png" alt="Figure 1.8 Replacing a crashed printing office"><br>以上这种方案是akka中对于容错的一种方案<strong>Restart</strong> strategies,其他方案包括：<strong>Resume</strong>, <strong>Stop</strong>以及<strong>Escalate</strong>.Akka提供了选择容错方案的方法。akka控制所有的actors处理message的方式，它知道所有actor的地址，如果有异常发生，就检查一下针对这种异常应该采取怎样的容错策略并执行之。</p>
<p>容错并不意味着对所有的错误全部都完全恢复。<strong>容错系统只是保证系统在部分失灵的情况下能够依然运行</strong>。不同的错误有不同的处理策略，有的错误需要重启部分系统，有的错误或许在检查点不能处理需要上级帮忙….后面我们可以关注一下Akka怎样通过Supervision来处理这些案例。</p>
<p>拿个简单的异常处理来说，一般的程序遇到异常肯定要停下正在处理的工作，处理这个异常或者抛给上级。对于线程组之间肯定是不能共享某个异常的，除非你自己写一个这样的底层机制。异常不会被传 到产生它的线程的线程组之外，也就是说我们必须找到在不同线程组之间交流异常的其他方式。一般来说如果一个线程遇到异常基本都是忽视继续执行或者直接停止。或许你可以在log里找到一些证据证明某个thread挂掉或者停止了，但是让系统的其他部分知道这些却是比较难了。当这些线程再分不到不同的机器上的时候，事情变得更加棘手。Akka提供了一种模型来处理错误，不管actor分布在多少机器。<strong>Akka不仅仅可以很好的处理并发，对于容错同样也很在行!</strong></p>
<hr>
<h3 id="scale-up-and-out"><a href="#scale-up-and-out" class="headerlink" title="scale up and out"></a>scale up and out</h3><p>scale up :在一个server上运行更多的TicketingAgent<br>scale out : 在更多的server上运行TicketingAgent</p>
<h4 id="scale-out"><a href="#scale-out" class="headerlink" title="scale out"></a>scale out</h4><p>我们前面都是在一个JVM上运行的agent的例子。我们这次来看看怎样在多台机器上运行。<br>message的传递是通过地址来进行的，我们只需要改变地址链接actor的方式就可以了。</p>
<p><img src="/imgs/akka/akka1.9.png" alt="Figure 1.9 Transparent Remote Actors (through Proxies)"></p>
<p>akka可以给一个位于remote server上的remote actor发送message，然后再通过网络把处理结果传递回来。TicketingAgent并不知道它在命令一个远程的打印室。其实在同一个jvm运行的内存实例也是基本一致的。唯一不一样的地方就是怎样找到remote actor reference，这<strong>只要通过配置文件</strong>就可以了。也就是说，<strong>不用改变任何代码</strong>我们就可以吧scale out切换为scale up。在akka中灵活改变actor地址是非常常见的。remote actor, 集群化甚至测试工具，都会用到。</p>
<p>同样的情况，对于共享可变状态的情形可就惨了，最常见的方案就是把JVM里的状态都push到一个db里去。最大的威胁是在不得不更多地联系控制的需求下，这个db会变得越来越牛逼，而中间层就鸡肋了：所有的class都是DTO或者无状态无实际操作的东西。最让人头痛的就是当需要更多复杂的处理的时候，db同样也要面临这些改变，这将是灾难性的。还有，系统的透明度也很重要。我们希望能够很容易地追踪flow的执行进度，而不是使用精心制作的控制机制处理一片片交织在一起的复杂行为。</p>
<p>好了，贬低完了共享可变状态的不好，来看看我们牛逼的akka，你可以使用精心制作的控制系统来将错综复杂的处理逻辑不定转化为操作流。在某些架构中，message queue和web service会组合起来防止这些，但其实就是一种类似akka的模型。Akka帮我们省去了很多共享可变资源的麻烦，基于message模式，而且还可以基于同一段代码同时实现scale up和scale out。</p>
<h4 id="scale-up"><a href="#scale-up" class="headerlink" title="scale up"></a>scale up</h4><p>如果我们只想在一个机器上提升性能并scale up呢？假设我为机器新增加了几个cpu核数。在共享可变资源的情况下就是添加线程数了。但是我们都知道，锁会导致资源争夺，就是说工作的线程数总是少于总数，因为有些线程不得不相互等待。尽量少共享就是说尽量少玩儿锁，这就是message机制的目的。使用message机制可以使用更少的线程，只要优化一下处理流程和message分发，性能还胜过使用锁。<strong>每个线程都有一个用来存储运行时数据的栈</strong>。不同的操作系统的栈的大小是不一样的，比如Linux 64位的一般是256K。<strong>栈的大小是影响同时运行在某个server上线程数量的因素之一</strong>。在Linux 64系统上大约4096个线程会用掉1G的内存。</p>
<p>actor运行在一个叫做dispatcher的抽象概念上，dispatcher关注使用哪个线程模型，还有处理mailbox里的message。跟线程池处理方式很像，只是线程池只管调度，而Akka的dispatcher/mailbox结合体处理并传递message。我们可以通过配置层指定dispatch策略，<strong>不用修改任何代码</strong>。</p>
<p>actor是轻量的，因为他们运行于dispatcher之上，actor的数量不一定要跟线程数量成正比。actor比thread占用的空间要小得多，1G内存大约可以有270万个actor。针对不用的需求，有多种类型的dispatcher可选。actor之间可以共享同一个dispatcher，也可以自己有自己的。在调整性能的时候，可以通过配置灵活进行。</p>
<p>既然我们已经了解了基于message实现的并发、容错、扩展。是时候看一下akka里的具体组件了，还要了解这些组件是如果协同工作的。</p>
<h2 id="Akka-Actor-和-AkkaSystem"><a href="#Akka-Actor-和-AkkaSystem" class="headerlink" title="Akka Actor 和 AkkaSystem"></a>Akka Actor 和 AkkaSystem</h2><p>前面已经讨论了几个akka的主要概念：</p>
<ul>
<li>actor的地址是提供一个方向</li>
<li>mailbox用来临时保存message和actor自身</li>
</ul>
<p>我们下面讨论一下这些组件是怎样有机结合起来，解释一下akka底层的线程机制，并且解释一下akka怎样运行在这样的一套机制之下。Actor只是ActorSystem的一部分，ActorSystem负责提供一些组件，而且能够让actor之间相互能够找到彼此。</p>
<p>akka系统中需要保证：</p>
<ul>
<li>不存在可变共享资源</li>
<li>传递的message不可变</li>
<li>异步发送message</li>
</ul>
<p>当我们使用某个工具包或者框架的时候，这个东西肯定为我们提供了方便的直接可用的东西。像下图1.10中展示的一样，一个actor就是我们可以向他发送message的对象，我们并不关心message被怎样传递，谁来接收这些message。我们的代码只负责在接收到message之后进行对应的处理即可。还可以通过某个协议与其他人进行协作。</p>
<p>现在我们接触了actor，mailbox，address。akka是使用scala原生api构建的actor。scala API提供了actor trait给人继承来构建自己的actor。售票处就可以继承akka的Actor了，因为akka的Actor已经继承了scala的Actor trait，并且还有一些状态信息，还有一个内部队列用来存放票。address就是我们前面提到的ActorRef，也就是Actor reference的简写。这个售票处的ActorRef是给打印室发送message给售票处用的。在akka中，ActorRef有多种形式，只是不会显露出来而已。对于用户而言，只需要使用ActorRef的API就可以了。</p>
<p>下面我们通过图1.10走一个小小的例子，讲述一些我们的代码要做什么，ActorSystem会为我们做什么。<br><img src="/imgs/akka/akka1.10.png" alt="Figure 1.10 Actor Request Cycle in Action "><br>如你所见：我们向售票处actor要一个ActorRef，获取之后，就用它来发送请求，也就是买票(1至5步)。ActorSystem没有向我们暴露任何细节：怎样处理的这个request，mailbox在哪儿，message是否已经被传递了等等。</p>
<p>当然，前面我们提到的好处依然存在：我们并没有阻塞，干巴巴等待request被处理完毕；request中不包含任何共享的状态信息；实际的消息处理过程也没有对任何公共资源使用锁；我们不必搭理任何并发问题。</p>
<p>那么我们怎样从ActorSystem中获取一个ActorRef呢？ActorPath！<br><img src="/imgs/akka/akka1.11.png" alt="Figure 1.11 ActorPath URI syntax "><br>在上面的例子中，’poffice1’可以被换成’TicketingAgent2’。然后通过’TicketingAgent2’的ActorRef使用’../TicketingAgent3’还可以拿到它的兄弟节点actor的ActorRef。但是守卫actor只能是’user’。</p>
<p>akka中的<strong>监督机制</strong>就来源于这种层级制度。每个actor都自动是它的子节点的supervisor。当一个child挂了，parent就需要操心使用什么样的策略进行弥补。错误也可以被逐级向上抛出，直到上面的某个supervisor对这类错误感兴趣，处理掉。</p>
<p>akka<strong>不推荐直接通过constructor来创建actor</strong>，因为这样会破坏actor的层级。直接通过constructor创建的actor可以被直接访问并调用其方法，这也破坏了message传递过程中的并发保护。ActorSystem可以创建ActorRef，提供通用的方式来获取某个ActorRef，提供root actor来创建actor层级，并且把运行时其他组件与actor整合起来。</p>
<p>Actor的操作：</p>
<ul>
<li>CREATE<br>每个actor都可以创建自己的子actor，actor的拓扑结构是动态的。</li>
<li>SEND<br>actor之间可以异步相互发送message到彼此的mailbox里。</li>
<li>BECOME<br>actor的行为是可以动态改变的。每收到一条message，actor都可以以不同的方式处理下一条message，也就是切换它的行为，后面章节我们会遇到。</li>
<li>SUPERVISE<br>actor监控自己的子actor，并且为这些孩子擦屁股。在第三章中，我们会见识到处理message和处理error的明确不同。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我们接触了ActorSystem和Actor实现的理论与实践，见识到了akka强大的能力。下一章你会发现这么厉害的能力竟然只需消耗一点点儿能量：你可以很快的运行akka。消息管理及并发的复杂性交给akka来搞定。<br>综上：</p>
<ul>
<li>基于消息传递让并发更加简单</li>
<li>并发的同时，我们还可以很简单地scale up 和scale out</li>
<li>我们可以任意扩展应用里的request和消息处理的组件</li>
<li>基于消息传递同样解决了容错</li>
<li>监管机制提供了一个并发并且容错的模型</li>
<li>akka让我们的代码不用特别复杂，但是拥有强大的力量</li>
</ul>
<p>下一章我们会启动运行我们的第一个akka应用。</p>
]]></content>
      
        
        <tags>
            
            <tag> akka </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[heroku上部署自己的akka项目]]></title>
      <url>/2015/07/16/heroku%E4%B8%8A%E9%83%A8%E7%BD%B2%E8%87%AA%E5%B7%B1%E7%9A%84akka%E9%A1%B9%E7%9B%AE/</url>
      <content type="html"><![CDATA[<p>heroku这个东西貌似是可以在云端发布scala项目的，我是在akka-in-action这本书遇到。既然玩儿了，就顺便记录一下。</p>
<h2 id="1-注册"><a href="#1-注册" class="headerlink" title="1. 注册"></a>1. 注册</h2><p>到heroku.com使用邮箱注册一个免费用户【注意：163邮箱被屏蔽了，我用的阿里的】</p>
<h2 id="2-安装工具"><a href="#2-安装工具" class="headerlink" title="2. 安装工具"></a>2. 安装工具</h2><p>在本地Ubuntu上安装heroku toolbelt, 可参考<a href="https://toolbelt.heroku.com/debian" target="_blank" rel="external">https://toolbelt.heroku.com/debian</a></p>
<blockquote>
<p>wget -O- <a href="https://toolbelt.heroku.com/install-ubuntu.sh" target="_blank" rel="external">https://toolbelt.heroku.com/install-ubuntu.sh</a> | sh</p>
</blockquote>
<h2 id="3-本地登录heroku："><a href="#3-本地登录heroku：" class="headerlink" title="3. 本地登录heroku："></a>3. 本地登录heroku：</h2><blockquote>
<p>heroku login</p>
</blockquote>
<h2 id="4-在heroku上建立一个app"><a href="#4-在heroku上建立一个app" class="headerlink" title="4. 在heroku上建立一个app"></a>4. 在heroku上建立一个app</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action/chapter2# heroku create</div><div class="line">Creating floating-woodland-3032... done, stack is cedar-14</div><div class="line">https://floating-woodland-3032.herokuapp.com/ | https://git.heroku.com/floating-woodland-3032.git</div><div class="line">Git remote heroku added</div></pre></td></tr></table></figure>
<p>上面执行的heroku create命令会同时在本地git配置里以heroku为名添加一个git remote。</p>
<h2 id="5-修改参数"><a href="#5-修改参数" class="headerlink" title="5. 修改参数"></a>5. 修改参数</h2><p>我们需要修改几个参数，这样heroku才知道怎样构建我们的项目。</p>
<ul>
<li>project/build.properties 【经验证，这个可以不用改】<blockquote>
<p>sbt.version=0.12.2</p>
</blockquote>
</li>
<li>project/plugins.sbt【经验证，这个可以不用改】<blockquote>
<p>resolvers += Classpaths.typesafeResolver<br>addSbtPlugin(“com.eed3si9n” % “sbt-assembly” % “0.8.7”)<br>addSbtPlugin(<br>“com.typesafe.startscript” % “xsbt-start-script-plugin” % “0.5.3”<br>)</p>
</blockquote>
</li>
</ul>
<p>以上包含了我们目前使用的所有的Plugin【貌似上面提到两个文件只是为了说明我们需要这几个依赖，但是并不严格需要弄成上面的那种】。startscript是为我们在Heroku上运行项目创建一个启动脚本用的。我们还需要项目根目录下的<strong>Procfile</strong>文件，这个文件会告诉Heroku我们的app应该运行在一个Web Dyno上。<br>可以看一下这个文件里的内容：</p>
<blockquote>
<p>web: target/start com.goticks.Main<br>这是指定了Heroku应该在启动脚本上添加的主类参数。</p>
</blockquote>
<h2 id="6-本地项目运行测试"><a href="#6-本地项目运行测试" class="headerlink" title="6. 本地项目运行测试"></a>6. 本地项目运行测试</h2><blockquote>
<p>sbt clean compile stage</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action/chapter2# sbt clean compile stage</div><div class="line">[info] Loading project definition from /root/gitLearning/akka-in-action/chapter2/project</div><div class="line">[info] Set current project to goticks (in build file:/root/gitLearning/akka-in-action/chapter2/)</div><div class="line">[success] Total time: 1 s, completed Jul 15, 2015 1:15:05 AM</div><div class="line">[info] Updating &#123;file:/root/gitLearning/akka-in-action/chapter2/&#125;chapter2...</div><div class="line">[info] Resolving jline#jline;2.12 ...</div><div class="line">[info] Done updating.</div><div class="line">[warn] Scala version was updated by one of library dependencies:</div><div class="line">[warn] 	* org.scala-lang:scala-library:(2.11.2, 2.11.1, 2.11.0) -&gt; 2.11.5</div><div class="line">[warn] To force scalaVersion, add the following:</div><div class="line">[warn] 	ivyScala := ivyScala.value map &#123; _.copy(overrideScalaVersion = true) &#125;</div><div class="line">[warn] Run &apos;evicted&apos; to see detailed eviction warnings</div><div class="line">[info] Compiling 4 Scala sources to /root/gitLearning/akka-in-action/chapter2/target/scala-2.11/classes...</div><div class="line">[warn] there was one feature warning; re-run with -feature for details</div><div class="line">[warn] one warning found</div><div class="line">[success] Total time: 41 s, completed Jul 15, 2015 1:15:47 AM</div><div class="line">[info] Wrote start script for mainClass := Some(com.goticks.Main) to /root/gitLearning/akka-in-action/chapter2/target/start</div><div class="line">[success] Total time: 1 s, completed Jul 15, 2015 1:15:47 AM</div></pre></td></tr></table></figure>
<p>这个命令是后面再heroku上会运行的，它会编译项目并创建target/start启动脚本。然后可以使用heroku的命令本地运行Procfile文件：</p>
<h2 id="7-本地启动并测试"><a href="#7-本地启动并测试" class="headerlink" title="7. 本地启动并测试"></a>7. 本地启动并测试</h2><p>使用heroku的工具foreman启动一下项目</p>
<blockquote>
<p>foreman start</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action/chapter2# foreman start</div><div class="line">01:20:02 web.1  | started with pid 7030</div><div class="line">01:20:10 web.1  | REST interface bound to /0:0:0:0:0:0:0:0:5000</div><div class="line">01:20:10 web.1  | [INFO] [07/15/2015 01:20:10.437] [goticks-akka.actor.default-dispatcher-3] [akka://goticks/user/IO-HTTP/listener-0] Bound to /0.0.0.0:5000</div></pre></td></tr></table></figure>
<p>到另一个session里测试：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~# http GET localhost:5000/events</div><div class="line">HTTP/1.1 200 OK</div><div class="line">Content-Length: 2</div><div class="line">Content-Type: application/json; charset=UTF-8</div><div class="line">Date: Wed, 15 Jul 2015 08:20:20 GMT</div><div class="line">Server: GoTicks.com REST API</div><div class="line"></div><div class="line">[]</div></pre></td></tr></table></figure></p>
<h2 id="8-部署到heroku"><a href="#8-部署到heroku" class="headerlink" title="8. 部署到heroku"></a>8. 部署到heroku</h2><blockquote>
<p>git push keroku master</p>
</blockquote>
<p>在提交了所有的本地变化后将本地项目push到git仓库的master分支，heroku会hook到这个git进程的执行，并且认出这是一个scala app。它会在云端下载所有依赖，编译代码，之后启动这个app。输出如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action/chapter2# git push keroku master</div><div class="line">fatal: &apos;keroku&apos; does not appear to be a git repository</div><div class="line">fatal: Could not read from remote repository.</div><div class="line"></div><div class="line">Please make sure you have the correct access rights</div><div class="line">and the repository exists.</div><div class="line">root@ubuntu:~/gitLearning/akka-in-action/chapter2# git remote</div><div class="line">heroku</div><div class="line">origin</div></pre></td></tr></table></figure></p>
<p>…..报错了。查看remote，发现已经有了heroku这个remote了。参考<a href="https://devcenter.heroku.com/articles/git，执行下列命令：" target="_blank" rel="external">https://devcenter.heroku.com/articles/git，执行下列命令：</a><br>使用 git remote -v, 查看当前项目下的remote url，确定我们的项目名称<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action/chapter2# git remote -v</div><div class="line">heroku	https://git.heroku.com/floating-woodland-3032.git (fetch)</div><div class="line">heroku	https://git.heroku.com/floating-woodland-3032.git (push)</div><div class="line">origin	https://github.com/RayRoestenburg/akka-in-action.git (fetch)</div><div class="line">origin	https://github.com/RayRoestenburg/akka-in-action.git (push)</div></pre></td></tr></table></figure></p>
<blockquote>
<p>heroku git:remote -a floating-woodland-3032</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action/chapter2# heroku git:remote -a floating-woodland-3032</div><div class="line">Installing plugin heroku-git... done</div><div class="line">set git remote heroku to https://git.heroku.com/floating-woodland-3032.git</div></pre></td></tr></table></figure>
<p>添加remote参考自: <a href="https://devcenter.heroku.com/articles/git【经后面证实，如果不**重命名**，可以不管这个，因为git" target="_blank" rel="external">https://devcenter.heroku.com/articles/git【经后面证实，如果不**重命名**，可以不管这个，因为git</a> remote -v 里已经有了。重命名使用-r other_remote_name】<br>然后再次执行push: git push heroku master<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">Counting objects: 1776, done.</div><div class="line">Delta compression using up to 2 threads.</div><div class="line">Compressing objects: 100% (791/791), done.</div><div class="line">Writing objects: 100% (1776/1776), 298.54 KiB | 0 bytes/s, done.</div><div class="line">Total 1776 (delta 564), reused 1768 (delta 561)</div><div class="line">remote: Compressing source files... done.</div><div class="line">remote: Building source:</div><div class="line">remote: </div><div class="line">remote: -----&gt; Play! app detected</div><div class="line">remote: -----&gt; Installing OpenJDK 1.6... done</div><div class="line">remote: -----&gt; WARNING: Play! version not specified in dependencies.yml. Default version: 1.3.1 being used....</div><div class="line">remote: -----&gt; Installing Play! 1.3.1.....</div><div class="line">remote: -----&gt; done</div><div class="line">remote: -----&gt; Building Play! application...</div><div class="line">remote:        ~        _            _ </div><div class="line">remote:        ~  _ __ | | __ _ _  _| |</div><div class="line">remote:        ~ | &apos;_ \| |/ _&apos; | || |_|</div><div class="line">remote:        ~ |  __/|_|\____|\__ (_)</div><div class="line">remote:        ~ |_|            |__/   </div><div class="line">remote:        ~</div><div class="line">remote:        ~ play! 1.3.1, https://www.playframework.com</div><div class="line">remote:        ~</div><div class="line">remote:        1.3.1</div><div class="line">remote:        Building Play! application at directory ./</div><div class="line">remote:        Resolving dependencies: .play/play dependencies ./ --forProd --forceCopy --silent -Duser.home=/tmp/build_4bb492e51a64b714c9d6757c67b0ccf2 2&gt;&amp;1</div><div class="line">remote:        ~ !! /tmp/build_4bb492e51a64b714c9d6757c67b0ccf2/conf/dependencies.yml does not exist</div><div class="line">remote:  !     Failed to build Play! application</div><div class="line">remote:  !     Cleared Play! framework from cache</div><div class="line">remote: </div><div class="line">remote:  !     Push rejected, failed to compile Play! app</div><div class="line">remote: </div><div class="line">remote: Verifying deploy....</div><div class="line">remote: </div><div class="line">remote: !	Push rejected to floating-woodland-3032.</div><div class="line">remote: </div><div class="line">To https://git.heroku.com/floating-woodland-3032.git</div><div class="line"> ! [remote rejected] master -&gt; master (pre-receive hook declined)</div><div class="line">error: failed to push some refs to &apos;https://git.heroku.com/floating-woodland-3032.git&apos;</div></pre></td></tr></table></figure></p>
<p>主要在于这个远程的hook拒绝了我的提交。我擦，简直不能忍！！！Google~~~因为没有成功build play，原因是没有找到play的依赖配置文件。<br>看了几个解说的，貌似是因为<strong>当前目录是一个git repository的子目录</strong>。</p>
<ul>
<li><p>下载安装一个git插件</p>
<ul>
<li>git clone <a href="https://github.com/apenwarr/git-subtree.git" target="_blank" rel="external">https://github.com/apenwarr/git-subtree.git</a></li>
<li>切换到最近的分支，执行 sh install.sh</li>
</ul>
</li>
<li><p>到git repository目录，也就是本地的git主目录下，我的机器上就是~/gitLearning/akka-in-action，执行：</p>
<blockquote>
<p>git subtree push –prefix “chapter2” heroku master</p>
</blockquote>
</li>
</ul>
<p>这个prefix是我们要push的项目相对git repository的路径。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">git push using:  heroku master</div><div class="line">Counting objects: 201, done.</div><div class="line">Delta compression using up to 2 threads.</div><div class="line">Compressing objects: 100% (119/119), done.</div><div class="line">Writing objects: 100% (201/201), 22.30 KiB | 0 bytes/s, done.</div><div class="line">Total 201 (delta 54), reused 155 (delta 38)</div><div class="line">remote: Compressing source files... done.</div><div class="line">remote: Building source:</div><div class="line">remote: </div><div class="line">remote: -----&gt; Scala app detected</div><div class="line">remote: -----&gt; Installing OpenJDK 1.8... done</div><div class="line">remote: -----&gt; Running: sbt compile stage</div><div class="line">remote:        Downloading sbt launcher for 0.13.8:</div><div class="line">remote:          From  http://repo.typesafe.com/typesafe/ivy-releases/org.scala-sbt/sbt-launch/0.13.8/sbt-launch.jar</div><div class="line">remote:            To  /tmp/scala_buildpack_build_dir/.sbt_home/launchers/0.13.8/sbt-launch.jar</div><div class="line">remote:        Getting org.scala-sbt sbt 0.13.8 ...</div><div class="line">remote:        downloading https://repo.typesafe.com/typesafe/ivy-releases/org.scala-sbt/sbt/0.13.8/jars/sbt.jar ...</div><div class="line">remote:        	[SUCCESSFUL ] org.scala-sbt#sbt;0.13.8!sbt.jar (321ms)</div><div class="line">remote:        downloading https://repo1.maven.org/maven2/org/scala-lang/scala-library/2.10.4/scala-library-2.10.4.jar ...</div><div class="line">remote:        	[SUCCESSFUL ] org.scala-lang#scala-library;2.10.4!scala-library.jar (2957ms)</div><div class="line">remote:        downloading https://repo.typesafe.com/typesafe/ivy-releases/org.scala-sbt/main/0.13.8/jars/main.jar ...</div><div class="line">.......</div><div class="line">......</div><div class="line">remote:        	[SUCCESSFUL ] org.scala-lang#jline;2.10.4!jline.jar (73ms)</div><div class="line">remote:        downloading https://repo1.maven.org/maven2/org/fusesource/jansi/jansi/1.4/jansi-1.4.jar ...</div><div class="line">remote:        	[SUCCESSFUL ] org.fusesource.jansi#jansi;1.4!jansi.jar (49ms)</div><div class="line">remote:        :: retrieving :: org.scala-sbt#boot-scala</div><div class="line">remote:        	confs: [default]</div><div class="line">remote:        	5 artifacts copied, 0 already retrieved (24459kB/42ms)</div><div class="line">remote:        [info] Loading global plugins from /tmp/scala_buildpack_build_dir/.sbt_home/plugins</div><div class="line">remote:        [info] Updating &#123;file:/tmp/scala_buildpack_build_dir/.sbt_home/plugins/&#125;global-plugins...</div><div class="line">remote:        [info] Resolving org.scala-lang#scala-library;2.10.4 ...</div><div class="line">.......</div><div class="line">.......</div><div class="line">remote:        [info] Resolving org.fusesource.jansi#jansi;1.4 ...</div><div class="line">remote:        [info] Done updating.</div><div class="line">remote:        [info] Compiling 1 Scala source to /tmp/scala_buildpack_build_dir/.sbt_home/plugins/target/scala-2.10/sbt-0.13/classes...</div><div class="line">remote:        [error] [/tmp/scala_buildpack_build_dir/project/plugins.sbt]:3: &apos;;&apos; expected but &apos;#&apos; found.</div><div class="line">remote:        [error] [/tmp/scala_buildpack_build_dir/project/plugins.sbt]:11: &apos;;&apos; expected but &apos;#&apos; found.</div><div class="line">remote:        Project loading failed: (r)etry, (q)uit, (l)ast, or (i)gnore? </div><div class="line">remote:  !     ERROR: Failed to run sbt!</div><div class="line">remote:        We&apos;re sorry this build is failing! If you can&apos;t find the issue in application</div><div class="line">remote:        code, please submit a ticket so we can help: https://help.heroku.com</div><div class="line">remote:        You can also try reverting to the previous version of the buildpack by running:</div><div class="line">remote:        $ heroku buildpacks:set https://github.com/heroku/heroku-buildpack-scala#previous-version</div><div class="line">remote:        </div><div class="line">remote:        Thanks,</div><div class="line">remote:        Heroku</div><div class="line">remote: </div><div class="line">remote: </div><div class="line">remote:  !     Push rejected, failed to compile Scala app</div><div class="line">remote: </div><div class="line">remote: Verifying deploy....</div><div class="line">remote: </div><div class="line">remote: !	Push rejected to floating-woodland-3032.</div><div class="line">remote: </div><div class="line">To https://git.heroku.com/floating-woodland-3032.git</div><div class="line"> ! [remote rejected] 9bfe06799b9975c15c426ab17618967b7b8e65b0 -&gt; master (pre-receive hook declined)</div><div class="line">error: failed to push some refs to &apos;https://git.heroku.com/floating-woodland-3032.git&apos;</div></pre></td></tr></table></figure></p>
<p>可以看到已经成功进行项目的build了，但还是报错了。。。。从输出来看原因是project/plugins.sbt里的#应该被替换成;，好吧，我是sbt新手。。。修改后重新push<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action# git subtree push --prefix &quot;chapter2&quot; heroku master</div><div class="line">git push using:  heroku master</div><div class="line">Counting objects: 205, done.</div><div class="line">Delta compression using up to 2 threads.</div><div class="line">Compressing objects: 100% (123/123), done.</div><div class="line">Writing objects: 100% (205/205), 22.61 KiB | 0 bytes/s, done.</div><div class="line">Total 205 (delta 56), reused 155 (delta 38)</div><div class="line">remote: Compressing source files... done.</div><div class="line">remote: Building source:</div><div class="line">remote: </div><div class="line">remote: -----&gt; Scala app detected</div><div class="line">remote: -----&gt; Installing OpenJDK 1.8... done</div><div class="line">remote: -----&gt; Running: sbt compile stage</div><div class="line">remote:        Downloading sbt launcher for 0.13.8:</div><div class="line">remote:          From  http://repo.typesafe.com/typesafe/ivy-releases/org.scala-sbt/sbt-launch/0.13.8/sbt-launch.jar</div><div class="line">remote:            To  /tmp/scala_buildpack_build_dir/.sbt_home/launchers/0.13.8/sbt-launch.jar</div><div class="line">remote:        Getting org.scala-sbt sbt 0.13.8 ...</div><div class="line">remote:        downloading https://repo.typesafe.com/typesafe/ivy-releases/org.scala-sbt/sbt/0.13.8/jars/sbt.jar ...</div><div class="line">.....</div><div class="line">.....</div><div class="line">remote:        [info] downloading https://repo1.maven.org/maven2/org/scala-lang/modules/scala-parser-combinators_2.11/1.0.2/scala-parser-combinators_2.11-1.0.2.jar ...</div><div class="line">remote:        [info] 	[SUCCESSFUL ] org.scala-lang.modules#scala-parser-combinators_2.11;1.0.2!scala-parser-combinators_2.11.jar(bundle) (185ms)</div><div class="line">remote:        [info] downloading https://repo1.maven.org/maven2/jline/jline/2.12/jline-2.12.jar ...</div><div class="line">remote:        [info] 	[SUCCESSFUL ] jline#jline;2.12!jline.jar (99ms)</div><div class="line">remote:        [info] Done updating.</div><div class="line">remote:        [warn] Scala version was updated by one of library dependencies:</div><div class="line">remote:        [warn] 	* org.scala-lang:scala-library:(2.11.2, 2.11.1, 2.11.0) -&gt; 2.11.5</div><div class="line">remote:        [warn] To force scalaVersion, add the following:</div><div class="line">remote:        [warn] 	ivyScala := ivyScala.value map &#123; _.copy(overrideScalaVersion = true) &#125;</div><div class="line">remote:        [warn] Run &apos;evicted&apos; to see detailed eviction warnings</div><div class="line">remote:        [info] Compiling 4 Scala sources to /tmp/scala_buildpack_build_dir/target/scala-2.11/classes...</div><div class="line">remote:        [info] &apos;compiler-interface&apos; not yet compiled for Scala 2.11.2. Compiling...</div><div class="line">remote:        [info]   Compilation completed in 33.95 s</div><div class="line">remote:        [warn] there was one feature warning; re-run with -feature for details</div><div class="line">remote:        [warn] one warning found</div><div class="line">remote:        [success] Total time: 87 s, completed Jul 15, 2015 10:04:22 AM</div><div class="line">remote:        [info] Wrote start script for mainClass := Some(com.goticks.Main) to /tmp/scala_buildpack_build_dir/target/start</div><div class="line">remote:        [success] Total time: 1 s, completed Jul 15, 2015 10:04:22 AM</div><div class="line">remote: -----&gt; Discovering process types</div><div class="line">remote:        Procfile declares types -&gt; web</div><div class="line">remote: </div><div class="line">remote: -----&gt; Compressing... done, 165.8MB</div><div class="line">remote: -----&gt; Launching... done, v5</div><div class="line">remote:        https://floating-woodland-3032.herokuapp.com/ deployed to Heroku</div><div class="line">remote: </div><div class="line">remote: Verifying deploy.... done.</div><div class="line">To https://git.heroku.com/floating-woodland-3032.git</div><div class="line"> * [new branch]      75151c92e9b25df8462fc0422b0345cf280f01ce -&gt; master</div></pre></td></tr></table></figure></p>
<p>嘻嘻~~ 大功告成！！！现在我们的项目已经发布到<a href="https://floating-woodland-3032.herokuapp.com。" target="_blank" rel="external">https://floating-woodland-3032.herokuapp.com。</a></p>
<h2 id="9-测试"><a href="#9-测试" class="headerlink" title="9. 测试"></a>9. 测试</h2><p>我们可以使用httpie或者浏览器来测试一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~# http PUT https://floating-woodland-3032.herokuapp.com/events event=RHCP nrOfTickets:=10</div><div class="line">HTTP/1.1 200 OK</div><div class="line">Connection: keep-alive</div><div class="line">Content-Length: 2</div><div class="line">Content-Type: text/plain; charset=UTF-8</div><div class="line">Date: Wed, 15 Jul 2015 10:09:06 GMT</div><div class="line">Server: GoTicks.com REST API</div><div class="line">Via: 1.1 vegur</div><div class="line"></div><div class="line">OK</div><div class="line"></div><div class="line">root@ubuntu:~# http GET https://floating-woodland-3032.herokuapp.com/events event=RHCP nrOfTickets:=10</div><div class="line">HTTP/1.1 200 OK</div><div class="line">Connection: keep-alive</div><div class="line">Content-Length: 44</div><div class="line">Content-Type: application/json; charset=UTF-8</div><div class="line">Date: Wed, 15 Jul 2015 10:09:21 GMT</div><div class="line">Server: GoTicks.com REST API</div><div class="line">Via: 1.1 vegur</div><div class="line"></div><div class="line">[</div><div class="line">    &#123;</div><div class="line">        &quot;event&quot;: &quot;RHCP&quot;, </div><div class="line">        &quot;nrOfTickets&quot;: 10</div><div class="line">    &#125;</div><div class="line">]</div></pre></td></tr></table></figure></p>
<h2 id="Plus-二次提交测试"><a href="#Plus-二次提交测试" class="headerlink" title="Plus : 二次提交测试"></a>Plus : 二次提交测试</h2><p>因为还不是很熟悉heroku，自己很纳闷，如果我们远程的APP在运行状态，能否直接提交新的commit，它会自己重启吗？<br>稍微修改一下项目后，重新push上去报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action# git subtree push --prefix &quot;chapter2&quot; heroku master</div><div class="line">git push using:  heroku master</div><div class="line">To https://git.heroku.com/floating-woodland-3032.git</div><div class="line"> ! [rejected]        855562ff41e936b6769cdf808d0f798f1dbf371b -&gt; master (non-fast-forward)</div><div class="line">error: failed to push some refs to &apos;https://git.heroku.com/floating-woodland-3032.git&apos;</div><div class="line">hint: Updates were rejected because a pushed branch tip is behind its remote</div><div class="line">hint: counterpart. Check out this branch and integrate the remote changes</div><div class="line">hint: (e.g. &apos;git pull ...&apos;) before pushing again.</div><div class="line">hint: See the &apos;Note about fast-forwards&apos; in &apos;git push --help&apos; for details.</div></pre></td></tr></table></figure></p>
<p>原来是因为我刚才修改之前reset了一次，造成了commit滞后。那就先pull下来，解决冲突之后，commit再push。结果还是报同样的错误。。。。无奈，git reflog后再reset到线上的commit，重新修改后commit + push。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action# git subtree push --prefix &quot;chapter2&quot; heroku master</div><div class="line">git push using:  heroku master</div><div class="line">Everything up-to-date</div></pre></td></tr></table></figure></p>
<p>heroku这个东西是完全免费的吗？怎样关闭这个东西？它引起了我的好奇心~~~简单看了一下help，有点儿类似docker的感觉。</p>
<h2 id="PlusPlus-项目关闭"><a href="#PlusPlus-项目关闭" class="headerlink" title="PlusPlus: 项目关闭"></a>PlusPlus: 项目关闭</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action# heroku ps:stop web.1</div><div class="line">Stopping web.1 dyno... done</div><div class="line">root@ubuntu:~/gitLearning/akka-in-action# heroku ps</div><div class="line">=== web (Free): `target/start com.goticks.Main`</div><div class="line">web.1: idle 2015/07/15 03:46:31 (~ 8s ago)</div></pre></td></tr></table></figure>
<p>关闭了自己又起来了<del>~</del>靠~！！！！<br>退出登录，同样失败。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action# heroku auth:logout</div><div class="line">Local credentials cleared.</div></pre></td></tr></table></figure></p>
<p>解决方案：<br>把web节点扩展到0个。。。。。竟然是这种方式，我真是醉了。。。这时再次访问就是503了。heroku ps没有任何进程。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action# heroku ps:scale web=0</div><div class="line">Scaling dynos... done, now running web at 0:Free.</div></pre></td></tr></table></figure></p>
<hr>
<p>对于git子目录提交的解决，参考自：</p>
<ul>
<li><a href="https://gitlab.com/gitlab-com/support-forum/issues/40" target="_blank" rel="external">https://gitlab.com/gitlab-com/support-forum/issues/40</a></li>
<li><a href="http://stackoverflow.com/questions/14286266/deploy-play-app-on-heroku-from-a-subdirectory-of-git-repo" target="_blank" rel="external">http://stackoverflow.com/questions/14286266/deploy-play-app-on-heroku-from-a-subdirectory-of-git-repo</a></li>
<li><a href="http://stackoverflow.com/questions/17148784/play-1-2-5-application-deployment-on-heroku-oops-conf-routes-or-conf-applicati" target="_blank" rel="external">http://stackoverflow.com/questions/17148784/play-1-2-5-application-deployment-on-heroku-oops-conf-routes-or-conf-applicati</a></li>
</ul>
]]></content>
      
        
        <tags>
            
            <tag> akka </tag>
            
            <tag> heroku </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[flume 源码阅读笔记（5）]]></title>
      <url>/2015/07/12/flume-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%885%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>前面分析了source的运行机制与过程，其实sink和source是很像的。</p>
<h2 id="1-入口"><a href="#1-入口" class="headerlink" title="1. 入口"></a>1. 入口</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (Entry&lt;String, SinkRunner&gt; entry : materializedConfiguration.getSinkRunners()</div><div class="line">    .entrySet()) &#123;</div><div class="line">  <span class="keyword">try</span>&#123;</div><div class="line">    supervisor.supervise(entry.getValue(),</div><div class="line">      <span class="keyword">new</span> SupervisorPolicy.AlwaysRestartPolicy(), LifecycleState.START);</div><div class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">    logger.error(<span class="string">"Error while starting &#123;&#125;"</span>, entry.getValue(), e);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>哈哈，经过上一节的流程，你是不是跟我一样信心满满啊~~ 嘻嘻—— SinkRunner</p>
<h2 id="2-SinkRunner"><a href="#2-SinkRunner" class="headerlink" title="2. SinkRunner"></a>2. SinkRunner</h2><p>同SourceRunner的身份地位是一样滴，可以理解为驱动器加管理者的角色，当channel里有event的时候就尝试消费之。不同于source的是，sink都是类似于PollableSource的这种，也就是需要自己对channel里的event进行抽取消费，因为channel里的东西不会自己sink，也不知道要sink到何处去。</p>
<ul>
<li>runner : <strong>PollingRunner</strong>    //我还需要说什么吗</li>
<li>runnerThread : Thread</li>
<li>lifecycleState : LifecycleState</li>
<li>policy : SinkProcessor</li>
</ul>
<p>入口方法start()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">	SinkProcessor policy = getPolicy();</div><div class="line"></div><div class="line">	policy.start();</div><div class="line"></div><div class="line">	runner = <span class="keyword">new</span> PollingRunner();</div><div class="line"></div><div class="line">	runner.policy = policy;</div><div class="line">	runner.counterGroup = counterGroup;</div><div class="line">	runner.shouldStop = <span class="keyword">new</span> AtomicBoolean();</div><div class="line"></div><div class="line">	runnerThread = <span class="keyword">new</span> Thread(runner);</div><div class="line">	runnerThread.setName(<span class="string">"SinkRunner-PollingRunner-"</span> +</div><div class="line">	    policy.getClass().getSimpleName());</div><div class="line">	runnerThread.start();</div><div class="line"></div><div class="line">	lifecycleState = LifecycleState.START;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>好熟悉，完全就是PollableSourceRunner的同样思路。虽然猜到了结果，但还是要求证一下。上这个内部类PollingRunner：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">	....</div><div class="line">  <span class="keyword">while</span> (!shouldStop.get()) &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">if</span> (policy.process().equals(Sink.Status.BACKOFF)) &#123;	<span class="comment">//</span></div><div class="line">        ....</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        counterGroup.set(<span class="string">"runner.backoffs.consecutive"</span>, <span class="number">0L</span>);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">      .....</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>好吧，还是稍微有一点点区别，我列举一下这两个PollingRunner的成员。<br>PollableSourceRunner：</p>
<ul>
<li>source : <strong>PollableSource</strong>    //内置getProcessor()接口</li>
<li>shouldStop : AtomicBoolean</li>
<li>counterGroup : CounterGroup</li>
</ul>
<p>SinkRunner:</p>
<ul>
<li>policy : <strong>SinkProcessor</strong></li>
<li>shouldStop : AtomicBoolean</li>
<li>counterGroup : CounterGroup</li>
</ul>
<p>差别就在policy和source上了，而这两者又有同样的接口API process方法来对channel里的event进行各自的处理。前面我们也分析过了source是通过channelProcessor进行实际的针对channel的操作的。</p>
<hr>
<p>这一节营养实在太少。顺便说一声CounterGroup吧，内置一个HashMap<string, atomiclong="">，做各种计数与指标统计的工作，主要当然是针对event和各个组件。</string,></p>
]]></content>
      
        
        <tags>
            
            <tag> 源码 </tag>
            
            <tag> flume </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[sbt使用遇到的问题(一)——repository]]></title>
      <url>/2015/07/12/sbt%E4%BD%BF%E7%94%A8%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98-%E4%B8%80-%E2%80%94%E2%80%94repository/</url>
      <content type="html"><![CDATA[<p>你懂得，由于当前国内的网络环境，前面使用了oschina的镜像作为sbt的repository。</p>
<blockquote>
<p>[repositories]<br>local<br>osc: <a href="http://maven.oschina.net/content/groups/public/" target="_blank" rel="external">http://maven.oschina.net/content/groups/public/</a><br>oschina-ivy: <a href="http://maven.oschina.net/content/groups/public/" target="_blank" rel="external">http://maven.oschina.net/content/groups/public/</a>, [organization]/[module]/(scala<em>[scalaVersion]/)(sbt</em>[sbtVersion]/)[revision]/[type]s/<a href="-[classifier]">artifact</a>.[ext]<br>typesafe: <a href="http://repo.typesafe.com/typesafe/ivy-releases/" target="_blank" rel="external">http://repo.typesafe.com/typesafe/ivy-releases/</a>, [organization]/[module]/(scala<em>[scalaVersion]/)(sbt</em>[sbtVersion]/)[revision]/[type]s/<a href="-[classifier]">artifact</a>.[ext], bootOnly<br>#sonatype-oss-releases<br>#maven-central<br>#sonatype-oss-snapshots</p>
</blockquote>
<p>配置了以上文件repositories后，把它放到~/.sbt/下就可以了。也可以自己制定配置文件的地址。具体可参考：<a href="http://www.scala-sbt.org/0.13/docs/Proxy-Repositories.html" target="_blank" rel="external">http://www.scala-sbt.org/0.13/docs/Proxy-Repositories.html</a></p>
<p>但是最近一段时间貌似oschina不再提供maven镜像库的服务了，而最近自己又想学习akka，尝试了好多次都是下面的输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line">compile</div><div class="line">[info] Updating &#123;file:/root/gitLearning/akka-in-action/chapter-channels/&#125;channels...</div><div class="line">[info] Resolving org.scala-lang#scala-library;2.11.6 ...</div><div class="line">[warn] 	module not found: org.scala-lang#scala-library;2.11.6</div><div class="line">[warn] ==== local: tried</div><div class="line">[warn]   /root/.ivy2/local/org.scala-lang/scala-library/2.11.6/ivys/ivy.xml</div><div class="line">[info] Resolving com.typesafe.akka#akka-actor_2.11;2.3.10 ...</div><div class="line">[warn] 	module not found: com.typesafe.akka#akka-actor_2.11;2.3.10</div><div class="line">[warn] ==== local: tried</div><div class="line">[warn]   /root/.ivy2/local/com.typesafe.akka/akka-actor_2.11/2.3.10/ivys/ivy.xml</div><div class="line">[info] Resolving com.typesafe.akka#akka-slf4j_2.11;2.3.10 ...</div><div class="line">[warn] 	module not found: com.typesafe.akka#akka-slf4j_2.11;2.3.10</div><div class="line">[warn] ==== local: tried</div><div class="line">[warn]   /root/.ivy2/local/com.typesafe.akka/akka-slf4j_2.11/2.3.10/ivys/ivy.xml</div><div class="line">[info] Resolving com.typesafe.akka#akka-remote_2.11;2.3.10 ...</div><div class="line">[warn] 	module not found: com.typesafe.akka#akka-remote_2.11;2.3.10</div><div class="line">[warn] ==== local: tried</div><div class="line">[warn]   /root/.ivy2/local/com.typesafe.akka/akka-remote_2.11/2.3.10/ivys/ivy.xml</div><div class="line">[info] Resolving com.typesafe.akka#akka-multi-node-testkit_2.11;2.3.10 ...</div><div class="line">[warn] 	module not found: com.typesafe.akka#akka-multi-node-testkit_2.11;2.3.10</div><div class="line">[warn] ==== local: tried</div><div class="line">[warn]   /root/.ivy2/local/com.typesafe.akka/akka-multi-node-testkit_2.11/2.3.10/ivys/ivy.xml</div><div class="line">[info] Resolving com.typesafe.akka#akka-contrib_2.11;2.3.10 ...</div><div class="line">[warn] 	module not found: com.typesafe.akka#akka-contrib_2.11;2.3.10</div><div class="line">[warn] ==== local: tried</div><div class="line">[warn]   /root/.ivy2/local/com.typesafe.akka/akka-contrib_2.11/2.3.10/ivys/ivy.xml</div><div class="line">[info] Resolving com.typesafe.akka#akka-remote-tests_2.11;2.3.10 ...</div><div class="line">[warn] 	module not found: com.typesafe.akka#akka-remote-tests_2.11;2.3.10</div><div class="line">[warn] ==== local: tried</div><div class="line">[warn]   /root/.ivy2/local/com.typesafe.akka/akka-remote-tests_2.11/2.3.10/ivys/ivy.xml</div><div class="line">[info] Resolving com.typesafe.akka#akka-testkit_2.11;2.3.10 ...</div><div class="line">[warn] 	module not found: com.typesafe.akka#akka-testkit_2.11;2.3.10</div><div class="line">[warn] ==== local: tried</div><div class="line">[warn]   /root/.ivy2/local/com.typesafe.akka/akka-testkit_2.11/2.3.10/ivys/ivy.xml</div><div class="line">[info] Resolving org.scalatest#scalatest_2.11;2.2.0 ...</div><div class="line">[warn] 	module not found: org.scalatest#scalatest_2.11;2.2.0</div><div class="line">[warn] ==== local: tried</div><div class="line">[warn]   /root/.ivy2/local/org.scalatest/scalatest_2.11/2.2.0/ivys/ivy.xml</div><div class="line">[info] Resolving org.scala-lang#scala-compiler;2.11.6 ...</div><div class="line">[warn] 	module not found: org.scala-lang#scala-compiler;2.11.6</div><div class="line">[warn] ==== local: tried</div><div class="line">[warn]   /root/.ivy2/local/org.scala-lang/scala-compiler/2.11.6/ivys/ivy.xml</div><div class="line">[warn] 	::::::::::::::::::::::::::::::::::::::::::::::</div><div class="line">[warn] 	::          UNRESOLVED DEPENDENCIES         ::</div><div class="line">[warn] 	::::::::::::::::::::::::::::::::::::::::::::::</div><div class="line">[warn] 	:: org.scala-lang#scala-library;2.11.6: not found</div><div class="line">[warn] 	:: com.typesafe.akka#akka-actor_2.11;2.3.10: not found</div><div class="line">[warn] 	:: com.typesafe.akka#akka-slf4j_2.11;2.3.10: not found</div><div class="line">[warn] 	:: com.typesafe.akka#akka-remote_2.11;2.3.10: not found</div><div class="line">[warn] 	:: com.typesafe.akka#akka-multi-node-testkit_2.11;2.3.10: not found</div><div class="line">[warn] 	:: com.typesafe.akka#akka-contrib_2.11;2.3.10: not found</div><div class="line">[warn] 	:: com.typesafe.akka#akka-remote-tests_2.11;2.3.10: not found</div><div class="line">[warn] 	:: com.typesafe.akka#akka-testkit_2.11;2.3.10: not found</div><div class="line">[warn] 	:: org.scalatest#scalatest_2.11;2.2.0: not found</div><div class="line">[warn] 	:: org.scala-lang#scala-compiler;2.11.6: not found</div><div class="line">[warn] 	::::::::::::::::::::::::::::::::::::::::::::::</div><div class="line">[warn] </div><div class="line">[warn] 	Note: Unresolved dependencies path:</div><div class="line">[warn] 		com.typesafe.akka:akka-contrib_2.11:2.3.10 (/root/gitLearning/akka-in-action/chapter-channels/build.sbt#L14)</div><div class="line">[warn] 		  +- manning:akka-sample-multi-node-scala_2.11:0.1-SNAPSHOT</div><div class="line">[warn] 		com.typesafe.akka:akka-remote-tests_2.11:2.3.10 (/root/gitLearning/akka-in-action/chapter-channels/build.sbt#L14)</div><div class="line">[warn] 		  +- manning:akka-sample-multi-node-scala_2.11:0.1-SNAPSHOT</div><div class="line">[warn] 		com.typesafe.akka:akka-remote_2.11:2.3.10 (/root/gitLearning/akka-in-action/chapter-channels/build.sbt#L14)</div><div class="line">[warn] 		  +- manning:akka-sample-multi-node-scala_2.11:0.1-SNAPSHOT</div><div class="line">[warn] 		com.typesafe.akka:akka-actor_2.11:2.3.10 (/root/gitLearning/akka-in-action/chapter-channels/build.sbt#L14)</div><div class="line">[warn] 		  +- manning:akka-sample-multi-node-scala_2.11:0.1-SNAPSHOT</div><div class="line">[warn] 		com.typesafe.akka:akka-testkit_2.11:2.3.10 (/root/gitLearning/akka-in-action/chapter-channels/build.sbt#L14)</div><div class="line">[warn] 		  +- manning:akka-sample-multi-node-scala_2.11:0.1-SNAPSHOT</div><div class="line">[warn] 		org.scala-lang:scala-library:2.11.6 ((sbt.Classpaths) Defaults.scala#L1203)</div><div class="line">[warn] 		  +- manning:akka-sample-multi-node-scala_2.11:0.1-SNAPSHOT</div><div class="line">[warn] 		com.typesafe.akka:akka-slf4j_2.11:2.3.10 (/root/gitLearning/akka-in-action/chapter-channels/build.sbt#L14)</div><div class="line">[warn] 		  +- manning:akka-sample-multi-node-scala_2.11:0.1-SNAPSHOT</div><div class="line">[warn] 		com.typesafe.akka:akka-multi-node-testkit_2.11:2.3.10 (/root/gitLearning/akka-in-action/chapter-channels/build.sbt#L14)</div><div class="line">[warn] 		  +- manning:akka-sample-multi-node-scala_2.11:0.1-SNAPSHOT</div><div class="line">[warn] 		org.scalatest:scalatest_2.11:2.2.0 (/root/gitLearning/akka-in-action/chapter-channels/build.sbt#L14)</div><div class="line">[warn] 		  +- manning:akka-sample-multi-node-scala_2.11:0.1-SNAPSHOT</div><div class="line">[warn] 		org.scala-lang:scala-compiler:2.11.6</div><div class="line">[warn] 		  +- manning:akka-sample-multi-node-scala_2.11:0.1-SNAPSHOT</div><div class="line">[trace] Stack trace suppressed: run last *:update for the full output.</div><div class="line">[error] (*:update) sbt.ResolveException: unresolved dependency: org.scala-lang#scala-library;2.11.6: not found</div><div class="line">[error] unresolved dependency: com.typesafe.akka#akka-actor_2.11;2.3.10: not found</div><div class="line">[error] unresolved dependency: com.typesafe.akka#akka-slf4j_2.11;2.3.10: not found</div><div class="line">[error] unresolved dependency: com.typesafe.akka#akka-remote_2.11;2.3.10: not found</div><div class="line">[error] unresolved dependency: com.typesafe.akka#akka-multi-node-testkit_2.11;2.3.10: not found</div><div class="line">[error] unresolved dependency: com.typesafe.akka#akka-contrib_2.11;2.3.10: not found</div><div class="line">[error] unresolved dependency: com.typesafe.akka#akka-remote-tests_2.11;2.3.10: not found</div><div class="line">[error] unresolved dependency: com.typesafe.akka#akka-testkit_2.11;2.3.10: not found</div><div class="line">[error] unresolved dependency: org.scalatest#scalatest_2.11;2.2.0: not found</div><div class="line">[error] unresolved dependency: org.scala-lang#scala-compiler;2.11.6: not found</div><div class="line">[error] Total time: 0 s, completed Jul 11, 2015 5:13:57 PM</div></pre></td></tr></table></figure></p>
<p>今儿灵机一动，想到了会不会是oschina镜像库的问题(尼玛，都忘记了以前自己跟sbt配置过oschina的镜像了)。打开配置文件~~~ 果然如此。。。这里感觉sbt稍微有点儿不好了，看日志也没看到它去哪个网址下载库的，maven库路径是没有输出的，如果没有经验的人看这些东西压根儿看不出啥来。</p>
<p>解决方式： 把原来配置的repositories文件重命名bak一下，重新到项目路径下启动sbt，再次compile：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">compile</div><div class="line">[info] Updating &#123;file:/root/gitLearning/akka-in-action/chapter-channels/&#125;channels...</div><div class="line">[info] Resolving org.sonatype.oss#oss-parent;7 ...</div><div class="line">[info] downloading https://repo1.maven.org/maven2/org/scala-lang/scala-library/2.11.6/scala-library-2.11.6.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] org.scala-lang#scala-library;2.11.6!scala-library.jar (142453ms)</div><div class="line">[info] downloading https://repo1.maven.org/maven2/com/typesafe/akka/akka-actor_2.11/2.3.10/akka-actor_2.11-2.3.10.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] com.typesafe.akka#akka-actor_2.11;2.3.10!akka-actor_2.11.jar (67998ms)</div><div class="line">[info] downloading https://repo1.maven.org/maven2/com/typesafe/akka/akka-slf4j_2.11/2.3.10/akka-slf4j_2.11-2.3.10.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] com.typesafe.akka#akka-slf4j_2.11;2.3.10!akka-slf4j_2.11.jar (1201ms)</div><div class="line">[info] downloading https://repo1.maven.org/maven2/com/typesafe/akka/akka-remote_2.11/2.3.10/akka-remote_2.11-2.3.10.jar ...</div><div class="line">....</div><div class="line">[info] Done updating.</div><div class="line">[info] Compiling 3 Scala sources to /root/gitLearning/akka-in-action/chapter-channels/target/scala-2.11/classes...</div><div class="line">[info] &apos;compiler-interface&apos; not yet compiled for Scala 2.11.6. Compiling...</div><div class="line">[info]   Compilation completed in 20.627 s</div><div class="line">[success] Total time: 1518 s, completed Jul 11, 2015 5:41:41 PM</div></pre></td></tr></table></figure></p>
<p>额，好吧。成功的时候才会显示地址~<br>成功了再看这个有毛线作用啊~</p>
]]></content>
      
        
        <tags>
            
            <tag> scala </tag>
            
            <tag> sbt </tag>
            
            <tag> repository </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[flume-源码阅读笔记（4）]]></title>
      <url>/2015/07/10/flume-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%884%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>这一章详细分析一下source的运行方式</p>
<h2 id="1-入口"><a href="#1-入口" class="headerlink" title="1. 入口"></a>1. 入口</h2><p>前面我们提到了source的启动入口为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (Entry&lt;String, SourceRunner&gt; entry : materializedConfiguration</div><div class="line">        .getSourceRunners().entrySet()) &#123;</div><div class="line">      <span class="keyword">try</span>&#123;</div><div class="line">        logger.info(<span class="string">"Starting Source "</span> + entry.getKey());</div><div class="line">        <span class="comment">// 下面这行就会以每3秒一次的频率调用SourceRunner</span></div><div class="line">        supervisor.supervise(entry.getValue(),</div><div class="line">          <span class="keyword">new</span> SupervisorPolicy.AlwaysRestartPolicy(), LifecycleState.START);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logger.error(<span class="string">"Error while starting &#123;&#125;"</span>, entry.getValue(), e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>注意，上面的value不是Source，而是SourceRunner，那么我们的中心就围绕它展开了。</p>
<h2 id="2-SourceRunner"><a href="#2-SourceRunner" class="headerlink" title="2. SourceRunner"></a>2. SourceRunner</h2><p>简而言之就是source的驱动器和控制器，对source进行了一层包裹。根据source的不同分为PollableSourceRunner和EventDrivenSourceRunner。</p>
<p>先看一下SourceRunner的元素：</p>
<ul>
<li>source : Source</li>
<li>forSource(Source)<br> 静态工厂方法，根据传入的source的类型实例化SourceRunner的实例，也就是上面提到的两种</li>
</ul>
<p>PollableSourceRunner管理的是<strong>PollableSource</strong>，这种source是需要外界来抽取event的，例如KafkaSource，需要去消费。</p>
<p>EventDrivenSourceRunner管理的是<strong>EventDrivenSource</strong>，这种source自己就满足消息机制，可以向channel产生event，不需要外界来抽取。 很容易看出来，这种是稍微省心点儿的~~~</p>
<p>SourceRunner里的元素比较少，还是分析它的两个子类吧。为方便对比，先看稍微简单一些的</p>
<p>###　EventDrivenSourceRunner<br>元素只有一个lifecycleState : LifecycleState<br>启动代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">    Source source = getSource();</div><div class="line">    ChannelProcessor cp = source.getChannelProcessor();</div><div class="line">    cp.initialize();	<span class="comment">// 初始化interceptorChain</span></div><div class="line">    source.start();		<span class="comment">// 启动source</span></div><div class="line">    lifecycleState = LifecycleState.START;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>上面可见，source是在这里启动的。我们来参照一个具体实现ExecSource：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">   executor = Executors.newSingleThreadExecutor();</div><div class="line"></div><div class="line">   <span class="comment">// 好，我们发现了一个Runnable</span></div><div class="line">   runner = <span class="keyword">new</span> ExecRunnable(shell, command, getChannelProcessor(), sourceCounter,</div><div class="line">       restart, restartThrottle, logStderr, bufferCount, batchTimeout, charset);</div><div class="line"></div><div class="line">   <span class="comment">// <span class="doctag">FIXME:</span> Use a callback-like executor / future to signal us upon failure.</span></div><div class="line">   runnerFuture = executor.submit(runner);</div><div class="line"></div><div class="line">   <span class="comment">/*</span></div><div class="line">    * NB: This comes at the end rather than the beginning of the method because</div><div class="line">    * it sets our state to running. We want to make sure the executor is alive</div><div class="line">    * and well first.</div><div class="line">    */</div><div class="line">   sourceCounter.start();</div><div class="line">   <span class="keyword">super</span>.start();</div><div class="line"></div><div class="line">   logger.debug(<span class="string">"Exec source started"</span>);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>看一下上面代码里的runnable：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">do</span> &#123;</div><div class="line">        .......</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          <span class="comment">// fork进程，执行shell</span></div><div class="line">          <span class="keyword">if</span>(shell != <span class="keyword">null</span>) &#123;</div><div class="line">            String[] commandArgs = formulateShellCommand(shell, command);</div><div class="line">            process = Runtime.getRuntime().exec(commandArgs);</div><div class="line">          &#125;  <span class="keyword">else</span> &#123;</div><div class="line">            String[] commandArgs = command.split(<span class="string">"\\s+"</span>);</div><div class="line">            process = <span class="keyword">new</span> ProcessBuilder(commandArgs).start();</div><div class="line">          &#125;</div><div class="line">          ....</div><div class="line"></div><div class="line">          <span class="comment">// 首先如果当前eventList不为空，先处理</span></div><div class="line">          future = timedFlushService.scheduleWithFixedDelay(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">              <span class="meta">@Override</span></div><div class="line">              <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                  <span class="keyword">synchronized</span> (eventList) &#123;</div><div class="line">                    <span class="keyword">if</span>(!eventList.isEmpty() &amp;&amp; timeout()) &#123;</div><div class="line">                      flushEventBatch(eventList); <span class="comment">// 批处理咯</span></div><div class="line">                    &#125;</div><div class="line">                  &#125;</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                  ...</div><div class="line">                &#125;</div><div class="line">              &#125;</div><div class="line">          &#125;,</div><div class="line">          batchTimeout, batchTimeout, TimeUnit.MILLISECONDS);</div><div class="line"></div><div class="line">          <span class="comment">// 读取shell进程输出	</span></div><div class="line">          <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (eventList) &#123;</div><div class="line">              sourceCounter.incrementEventReceivedCount();</div><div class="line">              eventList.add(EventBuilder.withBody(line.getBytes(charset)));</div><div class="line">              <span class="keyword">if</span>(eventList.size() &gt;= bufferCount || timeout()) &#123;</div><div class="line">                flushEventBatch(eventList); <span class="comment">// 批处理咯</span></div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">         .....</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">          ....</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">         ....</div><div class="line">        &#125;</div><div class="line">        ......</div><div class="line">      &#125; <span class="keyword">while</span>(restart);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>前面总是看到ChannelProcessor，还被迷惑地以为这个东西是给channel用的，后来自己才想明白，<strong>channel只是个容器</strong>。主动方应该是Source和Sink才对。。。果然，ChannelProcessor是给Source用的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">flushEventBatch</span><span class="params">(List&lt;Event&gt; eventList)</span></span>&#123;</div><div class="line">      channelProcessor.processEventBatch(eventList);</div><div class="line">      sourceCounter.addToEventAcceptedCount(eventList.size());</div><div class="line">      eventList.clear();</div><div class="line">      lastPushToChannel = systemClock.currentTimeMillis();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ChannelProcessor提供的元素如下：</p>
<ul>
<li>interceptorChain : InterceptorChain</li>
<li>selector : ChannelSelector</li>
<li>processEventBatch(List<event>)</event></li>
<li>processEvent(Event)</li>
</ul>
<p>PS: 猛然发现，前面其实我们已经通过channelProcessor的initialize方法初始化了<strong>interceptorChain</strong>，没错，interceptor就是交给它管理的。因为ChannelProcessor是处理event的实际作用点，所以对于event的过滤与处理也应该是在这里。</p>
<p><strong>event处理流程</strong>：</p>
<ul>
<li>通过interceptor</li>
<li>分类到各个channel -&gt; 通过channelSelector找到对应关系</li>
<li>遍历channel，调用对应的transaction及其方法，进行put操作，关闭事务</li>
</ul>
<p>展示一下事务这部分，以便联想起前面总结的事务部分内容，也可以串起来：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processEvent</span><span class="params">(Event event)</span> </span>&#123;</div><div class="line">	...</div><div class="line">	<span class="comment">// Process required channels</span></div><div class="line">    List&lt;Channel&gt; requiredChannels = selector.getRequiredChannels(event);</div><div class="line">    <span class="keyword">for</span> (Channel reqChannel : requiredChannels) &#123;</div><div class="line">      Transaction tx = reqChannel.getTransaction();</div><div class="line">      Preconditions.checkNotNull(tx, <span class="string">"Transaction object must not be null"</span>);</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        tx.begin(); <span class="comment">// 开始</span></div><div class="line"></div><div class="line">        <span class="comment">// 这里就是调用前面提到BasicTransactionSemantics的API了</span></div><div class="line">        reqChannel.put(event); </div><div class="line"></div><div class="line">        tx.commit();	<span class="comment">//提交</span></div><div class="line">      &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">        tx.rollback();	<span class="comment">// 回滚</span></div><div class="line">        ....</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="keyword">if</span> (tx != <span class="keyword">null</span>) &#123;</div><div class="line">          tx.close();	<span class="comment">// 关闭</span></div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="PollableSourceRunner"><a href="#PollableSourceRunner" class="headerlink" title="PollableSourceRunner"></a>PollableSourceRunner</h3><p>元素：</p>
<ul>
<li>runner : <strong>PollingRunner</strong>   // 关键就在这上面了</li>
<li>runnerThread : Thread</li>
<li>lifecycleState : LifecycleState</li>
<li>shouldStop : AtomicBoolean</li>
</ul>
<p>看一下它实现的start方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">PollableSource source = (PollableSource) getSource();</div><div class="line">   ChannelProcessor cp = source.getChannelProcessor();</div><div class="line">   cp.initialize();</div><div class="line">   source.start();</div><div class="line"></div><div class="line">   <span class="comment">// 至此前面与EventDrivenSourceRunner的处理是一模一样的</span></div><div class="line"></div><div class="line">   runner = <span class="keyword">new</span> PollingRunner();</div><div class="line"></div><div class="line">   runner.source = source;</div><div class="line">   runner.counterGroup = counterGroup;</div><div class="line">   runner.shouldStop = shouldStop;</div><div class="line"></div><div class="line">   runnerThread = <span class="keyword">new</span> Thread(runner);</div><div class="line">   runnerThread.setName(getClass().getSimpleName() + <span class="string">"-"</span> + </div><div class="line">       source.getClass().getSimpleName() + <span class="string">"-"</span> + source.getName());</div><div class="line">   runnerThread.start();</div><div class="line"></div><div class="line">   lifecycleState = LifecycleState.START;</div></pre></td></tr></table></figure></p>
<p>可以看到，后面起了一个线程，runnable就是PollingRunner。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		....</div><div class="line">      <span class="keyword">while</span> (!shouldStop.get()) &#123;</div><div class="line">        ......</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          <span class="keyword">if</span> (source.process().equals(PollableSource.Status.BACKOFF)) &#123; <span class="comment">//只有一行关键</span></div><div class="line">            ...</div><div class="line">          &#125; <span class="keyword">else</span> &#123;</div><div class="line">            counterGroup.set(<span class="string">"runner.backoffs.consecutive"</span>, <span class="number">0L</span>);</div><div class="line">          &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">          ......</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>明白了哈？就是执行了一下PollableSource里的process方法。前面提到了，这个接口的子类并非自身就是消息驱动的那种，<strong>需要别人来抽取event</strong>。所以前面的东西只是做准备，而PollingRunner来负责event的抽取以及将event放入channel的工作。</p>
<p>再次找个实现类，KafkaSource<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Status <span class="title">process</span><span class="params">()</span> <span class="keyword">throws</span> EventDeliveryException </span>&#123;</div><div class="line">	....</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">while</span> (eventList.size() &lt; batchUpperLimit &amp;&amp;</div><div class="line">              System.currentTimeMillis() &lt; batchEndTime) &#123;</div><div class="line">        iterStatus = hasNext();</div><div class="line">        <span class="keyword">if</span> (iterStatus) &#123;</div><div class="line">          <span class="comment">// get next message</span></div><div class="line">          MessageAndMetadata&lt;<span class="keyword">byte</span>[], <span class="keyword">byte</span>[]&gt; messageAndMetadata = it.next();</div><div class="line">          kafkaMessage = messageAndMetadata.message();</div><div class="line">          kafkaKey = messageAndMetadata.key();</div><div class="line"></div><div class="line">          <span class="comment">// Add headers to event (topic, timestamp, and key)</span></div><div class="line">          headers = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</div><div class="line">          headers.put(KafkaSourceConstants.TIMESTAMP,</div><div class="line">                  String.valueOf(System.currentTimeMillis()));</div><div class="line">          headers.put(KafkaSourceConstants.TOPIC, topic);</div><div class="line">          <span class="keyword">if</span> (kafkaKey != <span class="keyword">null</span>) &#123;</div><div class="line">            headers.put(KafkaSourceConstants.KEY, <span class="keyword">new</span> String(kafkaKey));</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">            log.debug(<span class="string">"Message: &#123;&#125;"</span>, <span class="keyword">new</span> String(kafkaMessage));</div><div class="line">          &#125;</div><div class="line">          event = EventBuilder.withBody(kafkaMessage, headers);</div><div class="line">          eventList.add(event);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      .....</div><div class="line">      <span class="keyword">if</span> (eventList.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">        getChannelProcessor().processEventBatch(eventList);</div><div class="line">        counter.addToEventAcceptedCount(eventList.size());</div><div class="line">        eventList.clear();</div><div class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">          log.debug(<span class="string">"Wrote &#123;&#125; events to channel"</span>, eventList.size());</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!kafkaAutoCommitEnabled) &#123;</div><div class="line">          <span class="comment">// commit the read transactions to Kafka to avoid duplicates</span></div><div class="line">          <span class="keyword">long</span> commitStartTime = System.nanoTime();</div><div class="line">          consumer.commitOffsets();</div><div class="line">          <span class="keyword">long</span> commitEndTime = System.nanoTime();</div><div class="line">          counter.addToKafkaCommitTimer((commitEndTime-commitStartTime)/(<span class="number">1000</span>*<span class="number">1000</span>));</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      ......</div><div class="line">      <span class="keyword">return</span> Status.READY;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      ......</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>看了这段代码后，可确定kafka的event就是由PollingRunner搞的。另外发现一个事儿，就是<strong>ChannelProcessor专门负责处理event后，放入channel</strong>。</p>
]]></content>
      
        
        <tags>
            
            <tag> 源码 </tag>
            
            <tag> flume </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[flume源码阅读笔记 （3）]]></title>
      <url>/2015/07/10/flume-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%883%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>前面介绍了几个关键组件以及相互的关系，这次我们来看看flume里对于事务的封装与处理。</p>
<h2 id="Transaction"><a href="#Transaction" class="headerlink" title="Transaction"></a>Transaction</h2><h3 id="BasicTransactionSemantics"><a href="#BasicTransactionSemantics" class="headerlink" title="BasicTransactionSemantics"></a>BasicTransactionSemantics</h3><ul>
<li>state : State //NEW, OPEN, COMPLETED, CLOSED</li>
<li>initialThreadId : long //记录创建它的ThreadId</li>
<li>begin()</li>
<li>commit()</li>
<li>rollback()</li>
<li>close()</li>
<li>put(Event)</li>
<li>take()<br>An implementation of basic Transaction semantics designed to work in concert with <strong>BasicChannelSemantics</strong> to simplify creation of robust Channel implementations. This class ensures that each transaction implementation method is called <strong>only while the transaction is in the correct state for that method, and only by the thread that created the transaction</strong>. Nested calls to begin() and close() are supported as long as they are balanced. </li>
</ul>
<p>是基本Transaction的实现，与<strong>BasicChannelSemantics</strong>配合。这个类保证transaction实现方法<strong>只在当前transaction适当的状态下触发，而且只能被创建当前transaction的线程触发</strong>。</p>
<p>Subclasses need only implement <strong>doPut, doTake, doCommit</strong>, and <strong>doRollback</strong>, and the developer can rest assured that those methods are called only after transaction state preconditions have been properly met. <strong>doBegin</strong> and <strong>doClose</strong> may also be implemented if there is work to be done at those points. </p>
<p>子类只需要实现<strong>doPut, doTake, doCommit</strong>以及<strong>doRollback</strong>方法，同时开发人员还需要保证只有在transaction的state被正确的修改后，才能触发这些方法。如果有必要的话，也可以实现<strong>doBegin</strong>和<strong>doClose</strong>方法。</p>
<p>All InterruptedException exceptions thrown from the implementations of the doXXX methods are automatically wrapped to become ChannelExceptions, but only after restoring the interrupted status of the thread so that any subsequent blocking method calls will themselves throw InterruptedException rather than blocking. The exception to this rule is doTake, which simply returns null instead of wrapping and propagating the InterruptedException, though it still first restores the interrupted status of the thread.<br>当doXXX方法发生异常的时候，首先把当前线程的状态修改为interrupted，然后把所有的InterruptedException转化为ChannelException抛出，这样后面的方法就不会阻塞住。doTake就遵循这样的规则，首先把线程状态改为interrupted，然后不包装以及传递InterruptedException，而是返回null。</p>
<hr>
<h2 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h2><h3 id="BasicChannelSemantics"><a href="#BasicChannelSemantics" class="headerlink" title="BasicChannelSemantics"></a>BasicChannelSemantics</h3><ul>
<li>currentTransaction : <strong>ThreadLocal</strong>&lt;BasicTransactionSemantics&gt;</li>
<li>put(Event)</li>
<li>take()</li>
<li>getTransaction()</li>
</ul>
<hr>
<h2 id="实现类MemoryTransaction在MemoryChannel里的使用"><a href="#实现类MemoryTransaction在MemoryChannel里的使用" class="headerlink" title="实现类MemoryTransaction在MemoryChannel里的使用"></a>实现类MemoryTransaction在MemoryChannel里的使用</h2><h3 id="MemoryTransaction"><a href="#MemoryTransaction" class="headerlink" title="MemoryTransaction"></a>MemoryTransaction</h3><ul>
<li>takeList : LinkedBlockingDeque<event> // 消费者的队列</event></li>
<li>putList : LinkedBlockingDeque<event>  // 生产者的队列</event></li>
<li>putByteCounter : int</li>
<li>takeByteCounter : int</li>
<li>channelCounter : ChannelCounter</li>
</ul>
<p>event放入channel<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPut</span><span class="params">(Event event)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">      channelCounter.incrementEventPutAttemptCount();</div><div class="line">      <span class="keyword">int</span> eventByteSize = (<span class="keyword">int</span>)Math.ceil(estimateEventSize(event)/byteCapacitySlotSize);</div><div class="line">      <span class="keyword">if</span> (!putList.offer(event)) &#123;    <span class="comment">// 放入生产者队列</span></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ChannelException(</div><div class="line">          <span class="string">"Put queue for MemoryTransaction of capacity "</span> +</div><div class="line">            putList.size() + <span class="string">" full, consider committing more frequently, "</span> +</div><div class="line">            <span class="string">"increasing capacity or increasing thread count"</span>);</div><div class="line">      &#125;</div><div class="line">      putByteCounter += eventByteSize;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>消费channel里的event<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> Event <span class="title">doTake</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">      channelCounter.incrementEventTakeAttemptCount();</div><div class="line">      <span class="keyword">if</span>(takeList.remainingCapacity() == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ChannelException(<span class="string">"Take list for MemoryTransaction, capacity "</span> +</div><div class="line">            takeList.size() + <span class="string">" full, consider committing more frequently, "</span> +</div><div class="line">            <span class="string">"increasing capacity, or increasing thread count"</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span>(!queueStored.tryAcquire(keepAlive, TimeUnit.SECONDS)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">      &#125;</div><div class="line">      Event event;</div><div class="line">      <span class="keyword">synchronized</span>(queueLock) &#123;</div><div class="line">        event = queue.poll(); <span class="comment">// 从channel中消费一条数据</span></div><div class="line">      &#125;</div><div class="line">      Preconditions.checkNotNull(event, <span class="string">"Queue.poll returned NULL despite semaphore "</span> +</div><div class="line">          <span class="string">"signalling existence of entry"</span>);</div><div class="line">      takeList.put(event);    <span class="comment">// 放入Transaction的消费者队列</span></div><div class="line"></div><div class="line">      <span class="keyword">int</span> eventByteSize = (<span class="keyword">int</span>)Math.ceil(estimateEventSize(event)/byteCapacitySlotSize);</div><div class="line">      takeByteCounter += eventByteSize;</div><div class="line"></div><div class="line">      <span class="keyword">return</span> event;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>提交事务：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doCommit</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">      ...</div><div class="line">        <span class="keyword">if</span>(!queueRemaining.tryAcquire(-remainingChange, keepAlive, TimeUnit.SECONDS)) &#123;</div><div class="line">          bytesRemaining.release(putByteCounter);</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> ChannelFullException(<span class="string">"Space for commit to queue couldn't be acquired."</span> +</div><div class="line">              <span class="string">" Sinks are likely not keeping up with sources, or the buffer size is too tight"</span>);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">int</span> puts = putList.size();</div><div class="line">      <span class="keyword">int</span> takes = takeList.size();</div><div class="line">      <span class="keyword">synchronized</span>(queueLock) &#123;</div><div class="line">        <span class="keyword">if</span>(puts &gt; <span class="number">0</span> ) &#123;</div><div class="line">          <span class="keyword">while</span>(!putList.isEmpty()) &#123;</div><div class="line">           <span class="comment">//这里的queue是MemoryChannel的Event队列，也就是将这段时间put的event放进channel的意思了</span></div><div class="line">            <span class="keyword">if</span>(!queue.offer(putList.removeFirst())) &#123;</div><div class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Queue add failed, this shouldn't be able to happen"</span>);</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">        putList.clear();</div><div class="line">        takeList.clear();</div><div class="line">      &#125;</div><div class="line">      bytesRemaining.release(takeByteCounter);</div><div class="line">      takeByteCounter = <span class="number">0</span>;</div><div class="line">      putByteCounter = <span class="number">0</span>;</div><div class="line"></div><div class="line">      queueStored.release(puts);</div><div class="line">      <span class="keyword">if</span>(remainingChange &gt; <span class="number">0</span>) &#123;</div><div class="line">        queueRemaining.release(remainingChange);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (puts &gt; <span class="number">0</span>) &#123;</div><div class="line">        channelCounter.addToEventPutSuccessCount(puts);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (takes &gt; <span class="number">0</span>) &#123;</div><div class="line">        channelCounter.addToEventTakeSuccessCount(takes);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      channelCounter.setChannelSize(queue.size());</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>回滚代码, 可想而知，肯定是回复channel之前的状态，将刚刚消费出来的东西塞回去，塞进去的东西拿出来：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRollback</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">int</span> takes = takeList.size();</div><div class="line">      <span class="keyword">synchronized</span>(queueLock) &#123;</div><div class="line">        <span class="comment">// 检查还能不能塞回去了</span></div><div class="line">        Preconditions.checkState(queue.remainingCapacity() &gt;= takeList.size(), <span class="string">"Not enough space in memory channel "</span> +</div><div class="line">            <span class="string">"queue to rollback takes. This should never happen, please report"</span>);</div><div class="line">        <span class="keyword">while</span>(!takeList.isEmpty()) &#123;</div><div class="line">          queue.addFirst(takeList.removeLast()); <span class="comment">//消费的event塞回去</span></div><div class="line">        &#125;</div><div class="line">        putList.clear();<span class="comment">//这是要塞进去的event清空</span></div><div class="line">      &#125;</div><div class="line">      bytesRemaining.release(putByteCounter);</div><div class="line">      putByteCounter = <span class="number">0</span>;</div><div class="line">      takeByteCounter = <span class="number">0</span>;</div><div class="line"></div><div class="line">      queueStored.release(takes);</div><div class="line">      channelCounter.setChannelSize(queue.size());</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>这里比较容易看到的是，<strong>如果塞了一半报错，会出现一些rollback差错</strong>，因为已经放进去的，并没有拿出来。如果需要实现的话，其实应该在放的时候起一个<strong>计数器</strong>，然后rollback的时候按照数量先往外拿，然后再把前面拿出来的放回去~~~~嘿嘿,是不是可以提交到社区 ^ _ ^</p>
]]></content>
      
        
        <tags>
            
            <tag> 源码 </tag>
            
            <tag> flume </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[搭建Kafka源码调试环境]]></title>
      <url>/2015/07/09/%E6%90%AD%E5%BB%BAKafka%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83/</url>
      <content type="html"><![CDATA[<h1 id="简单流程"><a href="#简单流程" class="headerlink" title="简单流程"></a>简单流程</h1><ol>
<li>git clone <a href="https://github.com/apache/kafka.git" target="_blank" rel="external">https://github.com/apache/kafka.git</a></li>
<li>git tag -l 瞅准0.8.2.1</li>
<li>git checkout 0.8.2.1 -b will0821</li>
<li><a href="http://gradle.org/下载安装gradle，也为自己的IDE安装gradle插件【对gradle不是特别了解，所以多用插件】。我下载的是gradle2.5，解压后需要在IDE里指定GRADLE_HOME变量。" target="_blank" rel="external">http://gradle.org/下载安装gradle，也为自己的IDE安装gradle插件【对gradle不是特别了解，所以多用插件】。我下载的是gradle2.5，解压后需要在IDE里指定GRADLE_HOME变量。</a><br>Eclipse是通过gradle EnIDE的配置窗口指定的。其他请自行解决。<br><img src="/imgs/eclipse_ide_gradle.png" alt="Figure  - eclipse截图"></li>
<li>build，尝试运行</li>
</ol>
<hr>
<h1 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h1><ul>
<li>我用的是eclipse，报错<strong>“找不到或无法加载主类”</strong>，按照这个思路去Google，没有找到实际能解决的办法。此时注意到eclipse的下方Maker里有一条错误提示<strong>“scalatest_2.10-1.9.1.jar of core build path is cross-compiled with an incompatible version of Scala (2.10.0)”</strong>，找到官方JIRA提供的解决方案 <a href="https://issues.apache.org/jira/browse/KAFKA-1873。将kafka下的**gradle.properties**里scalaVersion从2.10.4修改到2.11.5即可。猜测这个文件应该是类似于maven里的build配置项。" target="_blank" rel="external">https://issues.apache.org/jira/browse/KAFKA-1873。将kafka下的**gradle.properties**里scalaVersion从2.10.4修改到2.11.5即可。猜测这个文件应该是类似于maven里的build配置项。</a><br>重新build一把，再次执行入口类Kafka即可。</li>
</ul>
]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[flume 源码阅读笔记（1）]]></title>
      <url>/2015/07/08/flume-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%881%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>#1 . 启动脚本<br>最开始肯定是从启动脚本flume-ng下手了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">FLUME_AGENT_CLASS=&quot;org.apache.flume.node.Application&quot; # 这个是主要入口</div><div class="line">FLUME_AVRO_CLIENT_CLASS=&quot;org.apache.flume.client.avro.AvroCLIClient&quot;</div><div class="line">FLUME_VERSION_CLASS=&quot;org.apache.flume.tools.VersionInfo&quot;</div><div class="line">FLUME_TOOLS_CLASS=&quot;org.apache.flume.tools.FlumeToolsMain&quot;</div></pre></td></tr></table></figure></p>
<hr>
<p>#2. 主程序入口Application<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line">Options options = <span class="keyword">new</span> Options();</div><div class="line">..... <span class="comment">//一大堆命令行参数</span></div><div class="line"></div><div class="line"> CommandLineParser parser = <span class="keyword">new</span> GnuParser();</div><div class="line"> CommandLine commandLine = parser.parse(options, args);</div><div class="line"> <span class="comment">// 以上两行，对命令行参数解析完毕</span></div><div class="line"></div><div class="line"> <span class="comment">// 打印帮助信息</span></div><div class="line"> <span class="keyword">if</span> (commandLine.hasOption(<span class="string">'h'</span>)) &#123;</div><div class="line">   <span class="keyword">new</span> HelpFormatter().printHelp(<span class="string">"flume-ng agent"</span>, options, <span class="keyword">true</span>);</div><div class="line">   <span class="keyword">return</span>;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> String agentName = commandLine.getOptionValue(<span class="string">'n'</span>);</div><div class="line"> <span class="keyword">boolean</span> reload = !commandLine.hasOption(<span class="string">"no-reload-conf"</span>);</div><div class="line"></div><div class="line"> <span class="comment">// 是否有zookeeper的相关配置</span></div><div class="line"> <span class="keyword">if</span> (commandLine.hasOption(<span class="string">'z'</span>) || commandLine.hasOption(<span class="string">"zkConnString"</span>)) &#123;</div><div class="line">   isZkConfigured = <span class="keyword">true</span>;</div><div class="line"> &#125;</div><div class="line"> </div><div class="line"> <span class="comment">// 主角登场</span></div><div class="line"> Application application = <span class="keyword">null</span>;</div><div class="line"> <span class="keyword">if</span> (isZkConfigured) &#123;</div><div class="line">   <span class="comment">// get options</span></div><div class="line">   String zkConnectionStr = commandLine.getOptionValue(<span class="string">'z'</span>);</div><div class="line">   String baseZkPath = commandLine.getOptionValue(<span class="string">'p'</span>);</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (reload) &#123;</div><div class="line">     EventBus eventBus = <span class="keyword">new</span> EventBus(agentName + <span class="string">"-event-bus"</span>);</div><div class="line">     List&lt;LifecycleAware&gt; components = Lists.newArrayList();</div><div class="line">     PollingZooKeeperConfigurationProvider zookeeperConfigurationProvider =</div><div class="line">       <span class="keyword">new</span> PollingZooKeeperConfigurationProvider(</div><div class="line">         agentName, zkConnectionStr, baseZkPath, eventBus);</div><div class="line">     components.add(zookeeperConfigurationProvider);</div><div class="line">     application = <span class="keyword">new</span> Application(components);</div><div class="line">     eventBus.register(application);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">     StaticZooKeeperConfigurationProvider zookeeperConfigurationProvider =</div><div class="line">       <span class="keyword">new</span> StaticZooKeeperConfigurationProvider(</div><div class="line">         agentName, zkConnectionStr, baseZkPath);</div><div class="line">     application = <span class="keyword">new</span> Application();</div><div class="line">     application.handleConfigurationEvent(zookeeperConfigurationProvider</div><div class="line">       .getConfiguration());</div><div class="line">   &#125;</div><div class="line"> &#125; <span class="keyword">else</span> &#123;</div><div class="line">   File configurationFile = <span class="keyword">new</span> File(commandLine.getOptionValue(<span class="string">'f'</span>));</div><div class="line">   <span class="comment">/*</span></div><div class="line">    * 如果配置文件不存在，就直接报错</div><div class="line">    */</div><div class="line">   <span class="keyword">if</span> (!configurationFile.exists()) &#123;</div><div class="line">     ...</div><div class="line">   &#125;</div><div class="line">   List&lt;LifecycleAware&gt; components = Lists.newArrayList();</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (reload) &#123;</div><div class="line">     EventBus eventBus = <span class="keyword">new</span> EventBus(agentName + <span class="string">"-event-bus"</span>);</div><div class="line">     PollingPropertiesFileConfigurationProvider configurationProvider =</div><div class="line">       <span class="keyword">new</span> PollingPropertiesFileConfigurationProvider(</div><div class="line">         agentName, configurationFile, eventBus, <span class="number">30</span>);</div><div class="line">     components.add(configurationProvider);</div><div class="line">     application = <span class="keyword">new</span> Application(components);</div><div class="line">     eventBus.register(application);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">     PropertiesFileConfigurationProvider configurationProvider =</div><div class="line">       <span class="keyword">new</span> PropertiesFileConfigurationProvider(</div><div class="line">         agentName, configurationFile);</div><div class="line">     <span class="comment">// 下面为典型启动过程</span></div><div class="line">     application = <span class="keyword">new</span> Application();</div><div class="line">     application.handleConfigurationEvent(configurationProvider</div><div class="line">       .getConfiguration());</div><div class="line">   &#125;</div><div class="line"> &#125;</div><div class="line"> application.start(); <span class="comment">// 程序启动</span></div><div class="line"></div><div class="line"> <span class="comment">// 后面是shutdown hook，作清理工作</span></div></pre></td></tr></table></figure></p>
<p>综上来看，有营养的代码很少，就是读个配置文件，然后直接就启动程序了。那么application的初始化和start方法里都有些什么操作呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">// 1. 构造方法里只是注册一个LifecycleSupervisor，也就是管理生命周期的</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Application</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>(<span class="keyword">new</span> ArrayList&lt;LifecycleAware&gt;(<span class="number">0</span>));</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Application</span><span class="params">(List&lt;LifecycleAware&gt; components)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.components = components;</div><div class="line">   supervisor = <span class="keyword">new</span> LifecycleSupervisor();</div><div class="line"> &#125;</div><div class="line"></div><div class="line"><span class="comment">// 2. 根据conf重启所有components</span></div><div class="line"> <span class="meta">@Subscribe</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">handleConfigurationEvent</span><span class="params">(MaterializedConfiguration conf)</span> </span>&#123;</div><div class="line">   stopAllComponents();</div><div class="line">   startAllComponents(conf); <span class="comment">// 这个conf来自于配置文件，你懂得，这些component肯定就是source channel sink 之类的了</span></div><div class="line"> &#125;</div><div class="line"> </div><div class="line"> <span class="comment">// 3. 使用1中初始化的supervisor对所有component进行监管</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span>(LifecycleAware component : components) &#123;</div><div class="line">     supervisor.supervise(component,</div><div class="line">         <span class="keyword">new</span> SupervisorPolicy.AlwaysRestartPolicy(), LifecycleState.START);</div><div class="line">   &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>好，启动component的入口也明晰了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startAllComponents</span><span class="params">(MaterializedConfiguration materializedConfiguration)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (Entry&lt;String, Channel&gt; entry :</div><div class="line">      materializedConfiguration.getChannels().entrySet()) &#123;</div><div class="line">      <span class="keyword">try</span>&#123;</div><div class="line">        logger.info(<span class="string">"Starting Channel "</span> + entry.getKey());</div><div class="line">        <span class="comment">// 1. 将channel交给supervisor来进行生命周期管理，这里是启动</span></div><div class="line">        supervisor.supervise(entry.getValue(),</div><div class="line">            <span class="keyword">new</span> SupervisorPolicy.AlwaysRestartPolicy(), LifecycleState.START);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e)&#123;</div><div class="line">        logger.error(<span class="string">"Error while starting &#123;&#125;"</span>, entry.getValue(), e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 2. 启动sink 和 souce之前，确保所有的channel无误地启动完毕</span></div><div class="line">    <span class="keyword">for</span>(Channel ch: materializedConfiguration.getChannels().values())&#123;</div><div class="line">      <span class="keyword">while</span>(ch.getLifecycleState() != LifecycleState.START</div><div class="line">          &amp;&amp; !supervisor.isComponentInErrorState(ch))&#123;</div><div class="line">          logger.info(<span class="string">"Waiting for channel: "</span> + ch.getName() +</div><div class="line">              <span class="string">" to start. Sleeping for 500 ms"</span>);</div><div class="line">          Thread.sleep(<span class="number">500</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 3. 同上方式，启动sink</span></div><div class="line">    </div><div class="line">    <span class="comment">// 4. 同上方式，启动source</span></div><div class="line"></div><div class="line">    <span class="comment">// 监控： 目前支持ganlia和http jetty两种，需要在命令行指定type</span></div><div class="line">    <span class="comment">// $ bin/flume-ng agent --conf-file example.conf --name a1 -Dflume.monitoring.type=ganglia -Dflume.monitoring.hosts=com.example:1234,com.example2:5455</span></div><div class="line">    <span class="keyword">this</span>.loadMonitoring();</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>至此启动流程就完毕了。太简单了也~~~</p>
]]></content>
      
        
        <tags>
            
            <tag> 源码 </tag>
            
            <tag> flume </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[flume 源码阅读笔记（2）]]></title>
      <url>/2015/07/08/flume-%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB%E7%AC%94%E8%AE%B0%EF%BC%882%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>通过寻找LifecycleAware的子类就可以发现，所有flume的component都继承了这个接口。下面是几个主要的</p>
<hr>
<h1 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h1><p>连接source和sink，可以看做是MQ或者buffer，保证自身线程安全。<br>实在是懒得翻译，直接copy文档<br>A channel <strong>connects</strong> a Source to a Sink. The source acts as producer while the sink acts as a consumer of events. The channel itself is the <strong>buffer</strong> between the two.<br>A channel exposes a <strong>Transaction</strong> interface that can be used by its clients to ensure <strong>atomic</strong> put and take semantics. This is necessary to guarantee single hop reliability between agents. For instance, a source will successfully produce an event if and only if that event can be committed to the source’s associated channel. Similarly, a sink will consume an event if and only if its respective endpoint can accept the event. The extent of transaction support varies for different channel implementations ranging from strong to best-effort semantics.<br>Channels are associated with <strong>unique names</strong> that can be used for separating configuration and working namespaces.<br>Channels must be <strong>thread safe</strong>, protecting any internal invariants as no guarantees are given as to when and by how many sources/sinks they may be simultaneously accessed by. </p>
<pre><code>*  Transaction getTransaction()
*  put(Event event)
*  Event take() 
</code></pre><hr>
<h1 id="Sink"><a href="#Sink" class="headerlink" title="Sink"></a>Sink</h1><p>连接channel，然后消费channel里的内容，根据sink类型的不同，把这些message发往不同的目的地。<br>可以根据不同的行为使用<strong>SinkGroup</strong>和<strong>SinkProcessor</strong>来为Sink分组。<strong>SinkRunner</strong>通过processor定期轮询他们。</p>
<pre><code>*  Status process() 
    在某个transaction范围内消费channel里的message，如果transaction成功，就提交。若没成功，需要**回滚**这个transaction。
要确保这个方法只有一个线程调用
*   Channel getChannel()
*  setChannel(Channel channel)
</code></pre><hr>
<h1 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h1><p>A source generates {@plainlink Event <strong>events</strong>} and calls methods on the configured <strong>ChannelProcessor</strong> to persist those events into the configured channels.<br>Sources are associated with <strong>unique names</strong> that can be used for separating configuration and working namespaces.<br>不用搭理线程安全。</p>
<pre><code>* ChannelProcessor getChannelProcessor()
* setChannelProcessor(ChannelProcessor channelProcessor)
</code></pre><hr>
<h1 id="SinkProcessor"><a href="#SinkProcessor" class="headerlink" title="SinkProcessor"></a>SinkProcessor</h1><p>Interface for a device that allows abstraction of the behavior of multiple sinks, always assigned to a SinkRunner 。<br>A sink processors <strong>SinkProcessor.process()</strong> method will only be accessed by a <strong>single</strong> runner thread. However configuration methods such as Configurable.configure may be concurrently accessed.</p>
<pre><code>*  Status process() 
    Handle a request to **poll the owned sinks**.The processor is expected to call **Sink.process()** on whatever sink(s) appropriate, handling failures as appropriate and throwing EventDeliveryException when there is a failure to deliver any events according to the delivery policy defined by the sink processor implementation. See specific implementations of this interface for delivery behavior and policies.
*  setSinks(List&lt;Sink&gt; sinks)
</code></pre><p>看起来这个processor有些像wrapper + manager的意思。</p>
<hr>
<h1 id="SinkSelector"><a href="#SinkSelector" class="headerlink" title="SinkSelector"></a>SinkSelector</h1><p>An interface that allows the <strong>LoadBalancingSinkProcessor</strong> to use a load-balancing strategy such as round-robin, random distribution etc. Implementations of this class can be plugged into the system via <strong>processor configuration</strong> and are used to select a sink on every invocation.<br>An instance of the configured sink selector is create during the processor configuration, its setSinks(List) method is invoked following which it is configured via a subcontext. Once configured, <strong>the lifecycle of this selector is tied to the lifecycle of the sink processor</strong>.<br>At runtime, the processor invokes the createSinkIterator() method for every process call to create  <strong>an iteration order over the available sinks</strong>. The processor then loops through this iteration order until one of the sinks succeeds in processing the event. If the iterator is exhausted and none of the sinks succeed, the processor will raise an EventDeliveryException. </p>
<pre><code>*  setSinks(List&lt;Sink&gt; sinks)
*  Iterator&lt;Sink&gt; createSinkIterator()
*  void informSinkFailed(Sink failedSink)
</code></pre><hr>
<h1 id="SourceRunner"><a href="#SourceRunner" class="headerlink" title="SourceRunner"></a>SourceRunner</h1><p>A source runner controls <strong>how a source is driven</strong>. This is an abstract class used for instantiating derived classes.</p>
<pre><code>*  Source source
*  SourceRunner forSource(Source source)  
    根据source类型实例化SourceRunner实现类的静态工厂方法
</code></pre><hr>
<h1 id="SinkRunner"><a href="#SinkRunner" class="headerlink" title="SinkRunner"></a>SinkRunner</h1><p>A <strong>driver</strong> for sinks that polls them, attempting to process events if any are available in the Channel.<br>Note that, unlike sources, all sinks are polled.</p>
<pre><code>*  Thread runnerThread
*  LifecycleState lifecycleState
*  **SinkProcessor** policy
*  CounterGroup counterGroup
*  PollingRunner runner
</code></pre><p>轮询调用sink的驱动器，如果channel里有任何可用的event，都会尝试执行。与source不同，所有的sink都会被涉及。Runner像是Processor的Wrapper。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">    SinkProcessor policy = getPolicy();</div><div class="line">    policy.start();</div><div class="line">    runner = <span class="keyword">new</span> PollingRunner(); <span class="comment">//封装shouldStop决定是否运行</span></div><div class="line">    runner.policy = policy;</div><div class="line">    runner.counterGroup = counterGroup;</div><div class="line">    runner.shouldStop = <span class="keyword">new</span> AtomicBoolean();</div><div class="line">    runnerThread = <span class="keyword">new</span> Thread(runner);</div><div class="line">    runnerThread.setName(<span class="string">"SinkRunner-PollingRunner-"</span> +</div><div class="line">        policy.getClass().getSimpleName());</div><div class="line">    runnerThread.start();</div><div class="line">    lifecycleState = LifecycleState.START;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
]]></content>
      
        
        <tags>
            
            <tag> 源码 </tag>
            
            <tag> flume </tag>
            
        </tags>
        
    </entry>
    
    <entry>
      <title><![CDATA[在pycharm中开发pySpark程序]]></title>
      <url>/2015/05/08/%E5%9C%A8pycharm%E4%B8%AD%E5%BC%80%E5%8F%91pySpark%E7%A8%8B%E5%BA%8F/</url>
      <content type="html"><![CDATA[<p>Apache spark是一个用来分析和处理大数据的有力工具。<br>虽然知道怎样运行pySpark shell，但是开发的时候我们总会喜欢常用的IDE。<br><img src="/imgs/pyspark-reference.png" alt="Figure1 - PySpark Reference"><br>开始我尝试使用pycharm 的preference setting，添加pySpark module到external library(Figure 1).。但是编辑器里还是不能找到引用的对象(Figure 2)。最后，只能在python的运行脚本里添加相应引用了。</p>
<p><img src="/imgs/reference-problem.png" alt="Figure 2 - Reference Problem"></p>
<p>通过下面的代码，添加适当的SPARK HOME目录和PYSPARK目录来引入Apache spark module<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os</div><div class="line"><span class="keyword">import</span> sys</div><div class="line"><span class="comment"># Path for spark source folder</span></div><div class="line">os.environ[<span class="string">'SPARK_HOME'</span>]=<span class="string">"your_spark_home_folder"</span></div><div class="line"><span class="comment"># Append pyspark  to Python Path</span></div><div class="line">sys.path.append(<span class="string">"your_pyspark_folder "</span>)</div><div class="line"><span class="keyword">try</span>:</div><div class="line">    <span class="keyword">from</span> pyspark <span class="keyword">import</span> SparkContext</div><div class="line">    <span class="keyword">from</span> pyspark <span class="keyword">import</span> SparkConf</div><div class="line">    print(<span class="string">"Successfully imported Spark Modules"</span>)</div><div class="line"><span class="keyword">except</span> ImportError <span class="keyword">as</span> e:</div><div class="line">    print(<span class="string">"Can not import Spark Modules"</span>,e)</div><div class="line">    sys.exit(<span class="number">1</span>)</div></pre></td></tr></table></figure></p>
<p>成功引入后会打印：“Successfully imported Spark Modules” (Figure 3).<br><img src="/imgs/succ-import-pyspark.png" alt="Figure 3 - Successfully import pyspark"><br>再来写个小程序验证PySpark是否能够正常工作. 引入pySpark module后，添加以下代码 (Figure 4).<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># Initialize SparkContext</span></div><div class="line">sc=SparkContext(<span class="string">'local'</span>)</div><div class="line">words=sc.parallelize([<span class="string">"scala"</span>,<span class="string">"java"</span>,<span class="string">"hadoop"</span>,<span class="string">"spark"</span>,<span class="string">"akka"</span>])</div><div class="line">printwords.count()</div></pre></td></tr></table></figure></p>
<p><img src="/imgs/run-pyspark.png" alt="Figure 4 - Test pyspark"></p>
<p>转自：<a href="http://renien.github.io/blog/accessing-pyspark-pycharm" target="_blank" rel="external">http://renien.github.io/blog/accessing-pyspark-pycharm</a></p>
]]></content>
      
        
    </entry>
    
    <entry>
      <title><![CDATA[Flume 测试笔记（8）]]></title>
      <url>/2015/05/06/Flume-%E6%B5%8B%E8%AF%95%E7%AC%94%E8%AE%B0%EF%BC%888%EF%BC%89/</url>
      <content type="html"><![CDATA[<p>已经打通了经脉，还需要考虑负载均衡以及容灾问题。鉴于现在log的数据压力不是很大，而且投入的机器也不是很多，暂时只考虑容<br>灾，暂时不考虑负载均衡。</p>
<h2 id="1-flume代码逻辑"><a href="#1-flume代码逻辑" class="headerlink" title="1.flume代码逻辑"></a>1.flume代码逻辑</h2><p>flume里原生一个Failover Sink Processor，维护failedSinks和liveSinks两个东西来进行工作。首先会测试配置的所有sink，&gt;工作时只取liveSink里的一个作为activeSink，进行实质性的工作。</p>
<p>FailoverSinkProcessor中的逻辑如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line">@Override</div><div class="line">  public Status process() throws EventDeliveryException &#123;</div><div class="line">    // Retry any failed sinks that have gone through their &quot;cooldown&quot; period</div><div class="line">    Long now = System.currentTimeMillis();</div><div class="line">    while(!failedSinks.isEmpty() &amp;&amp; failedSinks.peek().getRefresh() &lt; now) &#123;</div><div class="line">      FailedSink cur = failedSinks.poll();</div><div class="line">      Status s;</div><div class="line">      try &#123;</div><div class="line">        s = cur.getSink().process();</div><div class="line">        if (s  == Status.READY) &#123;</div><div class="line">          liveSinks.put(cur.getPriority(), cur.getSink());</div><div class="line">          activeSink = liveSinks.get(liveSinks.lastKey());</div><div class="line">          logger.debug(&quot;Sink &#123;&#125; was recovered from the fail list&quot;,</div><div class="line">                  cur.getSink().getName());</div><div class="line">        &#125; else &#123;</div><div class="line">          // if it&apos;s a backoff it needn&apos;t be penalized.</div><div class="line">          failedSinks.add(cur);</div><div class="line">        &#125;</div><div class="line">        return s;</div><div class="line">      &#125; catch (Exception e) &#123;</div><div class="line">        cur.incFails();</div><div class="line">        failedSinks.add(cur);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Status ret = null;</div><div class="line">    while(activeSink != null) &#123;</div><div class="line">      try &#123;</div><div class="line">        ret = activeSink.process();</div><div class="line">        return ret;</div><div class="line">      &#125; catch (Exception e) &#123;</div><div class="line">        logger.warn(&quot;Sink &#123;&#125; failed and has been sent to failover list&quot;,</div><div class="line">                activeSink.getName(), e);</div><div class="line">        activeSink = moveActiveToDeadAndGetNext();</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    throw new EventDeliveryException(&quot;All sinks failed to process, &quot; +</div><div class="line">        &quot;nothing left to failover to&quot;);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>分析一下执行逻辑，在初始化的时候，failedSink是空的【可以参见configure方法】。在执行第二个while循环的时候，当有activeSink处理失败，就会把这个sink加到failedSinks里去，然后获取liveSinks里的下一个sink作为activeSink。但是这个process方法并没有返回执行的逻辑，那么就应该被重复调用，才可能执行到上面的第一个while循环。<br>SinkRunner中的逻辑：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">      logger.debug(<span class="string">"Polling sink runner starting"</span>);</div><div class="line"></div><div class="line">      <span class="keyword">while</span> (!shouldStop.get()) &#123; <span class="comment">//只要shouldStop为false便会一次次的执行</span></div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          <span class="keyword">if</span> (policy.process().equals(Sink.Status.BACKOFF)) &#123; <span class="comment">//这里的policy就是SinkProcessor</span></div><div class="line">            counterGroup.incrementAndGet(<span class="string">"runner.backoffs"</span>);</div><div class="line"></div><div class="line">            Thread.sleep(Math.min(</div><div class="line">                counterGroup.incrementAndGet(<span class="string">"runner.backoffs.consecutive"</span>)</div><div class="line">                * backoffSleepIncrement, maxBackoffSleep));</div><div class="line">          &#125; <span class="keyword">else</span> &#123;</div><div class="line">            counterGroup.set(<span class="string">"runner.backoffs.consecutive"</span>, <span class="number">0L</span>);</div><div class="line">          &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">          logger.debug(<span class="string">"Interrupted while processing an event. Exiting."</span>);</div><div class="line">          counterGroup.incrementAndGet(<span class="string">"runner.interruptions"</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">          logger.error(<span class="string">"Unable to deliver event. Exception follows."</span>, e);</div><div class="line">          <span class="keyword">if</span> (e <span class="keyword">instanceof</span> EventDeliveryException) &#123;</div><div class="line">            counterGroup.incrementAndGet(<span class="string">"runner.deliveryErrors"</span>);</div><div class="line">          &#125; <span class="keyword">else</span> &#123;</div><div class="line">            counterGroup.incrementAndGet(<span class="string">"runner.errors"</span>);</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">try</span> &#123;</div><div class="line">            Thread.sleep(maxBackoffSleep);</div><div class="line">          &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</div><div class="line">            Thread.currentThread().interrupt();</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      logger.debug(<span class="string">"Polling runner exiting. Metrics:&#123;&#125;"</span>, counterGroup);</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>这样看来，其实flume的FailoverSinkProcessor也是会自动发现恢复了的Sink的。</p>
<h2 id="2-flume官网文档"><a href="#2-flume官网文档" class="headerlink" title="2. flume官网文档"></a>2. flume官网文档</h2><blockquote>
<p>Failover Sink Processor maintains <strong>a prioritized list of sinks</strong>, guaranteeing that so long as one is available events will be processed (delivered).The failover mechanism works by relegating failed sinks to a pool where they are assigned a cool down period, increasing with sequential failures before they are retried. Once a sink successfully sends an event, it is restored to the live pool.</p>
<p>To configure, set a <strong>sink groups</strong> processor to failover and set priorities for all individual sinks. All specified priorities must be <strong>unique</strong>. Furthermore, upper limit to failover time can be set (in milliseconds) using maxpenalty property.</p>
<p>Example for agent named a1:<br>a1.sinkgroups = g1<br>a1.sinkgroups.g1.sinks = k1 k2<br>a1.sinkgroups.g1.processor.type = failover<br>a1.sinkgroups.g1.processor.priority.k1 = 5<br>a1.sinkgroups.g1.processor.priority.k2 = 10<br>a1.sinkgroups.g1.processor.maxpenalty = 10000</p>
</blockquote>
<p>我们看到，这里又涉及到了sink group这个东西，其实主要是为了做负载均衡和容灾时更加方便一些，也很好理解，就是把sink分个组而已，然后负载均衡和容灾可以指定一个组就可以了，也就针对这个组里的sink进行对应的策略实施。找了一个比较好的例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"># channels</div><div class="line">agent.channels = mem_channel</div><div class="line">agent.channels.mem_channel.type = memory</div><div class="line"></div><div class="line"># sources</div><div class="line">agent.sources = event_source</div><div class="line">agent.sources.event_source.type = avro</div><div class="line">agent.sources.event_source.bind = 127.0.0.1</div><div class="line">agent.sources.event_source.port = 10000</div><div class="line">agent.sources.event_source.channels = mem_channel</div><div class="line"></div><div class="line"># sinks</div><div class="line">agent.sinks = main_sink backup_sink</div><div class="line"></div><div class="line">agent.sinks.main_sink.type = avro</div><div class="line">agent.sinks.main_sink.hostname = 127.0.0.1</div><div class="line">agent.sinks.main_sink.port = 10001</div><div class="line">agent.sinks.main_sink.channel = mem_channel</div><div class="line"></div><div class="line">agent.sinks.backup_sink.type = avro</div><div class="line">agent.sinks.backup_sink.hostname = 127.0.0.1</div><div class="line">agent.sinks.backup_sink.port = 10002</div><div class="line">agent.sinks.backup_sink.channel = mem_channel</div><div class="line"></div><div class="line"># sink groups    </div><div class="line">agent.sinkgroups = failover_group</div><div class="line">agent.sinkgroups.failover_group.sinks = main_sink backup_sink</div><div class="line">agent.sinkgroups.failover_group.processor.type = failover</div><div class="line">agent.sinkgroups.failover_group.processor.priority.main_sink = 10</div><div class="line">agent.sinkgroups.failover_group.processor.priority.backup_sink = 5</div></pre></td></tr></table></figure></p>
]]></content>
      
        
    </entry>
    
  
  
</search>
