
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <script type="text/javascript">
    (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
    })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
    
    _st('install','yNiKTKaAnwd1uuxVMfiE','2.0.0');
  </script>
  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?5b99dfd487346155d274c0c49c3fb869";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
  </script>

  
    <title>Will&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Will Chen">
    

    
    <meta name="description" content="左右水色 右手天光">
<meta property="og:type" content="website">
<meta property="og:title" content="Will's Blog">
<meta property="og:url" content="https://runningdata.github.io/page/15/index.html">
<meta property="og:site_name" content="Will's Blog">
<meta property="og:description" content="左右水色 右手天光">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Will's Blog">
<meta name="twitter:description" content="左右水色 右手天光">

    
    <link rel="alternative" href="/atom.xml" title="Will&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Will&#39;s Blog" title="Will&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Will&#39;s Blog">Will&#39;s Blog</a></h1>
				<h2 class="blog-motto">简易 变易 不易</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
                                                <form class="search" action="/search/index.html" method="get" accept-charset="utf-8" target="_blank">
                                                        <label>搜索</label>
                                                <input name="s" type="hidden" value= null ><input type="text" class="st-default-search-input" name="q" size="30" placeholder="搜索"><br>
                                                </form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/01/09/R/" title="R" itemprop="url">R</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2017-01-09T02:35:22.000Z" itemprop="datePublished"> 发表于 2017-01-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">library(SparkR)</div><div class="line">library(tseries)</div><div class="line">library(forecast)</div><div class="line">library(magrittr)</div><div class="line"></div><div class="line">sc&lt;-sparkR.init()</div><div class="line">hivecontext&lt;-sparkRHive.init(sc)</div><div class="line">sqlcontext&lt;-sparkRSQL.init(sc)</div><div class="line"></div><div class="line">dateline&lt;-seq.Date(from = as.Date(&quot;2015-05-01&quot;),to=as.Date(&quot;2017-01-04&quot;),by=&quot;day&quot;)%&gt;%data.frame(.)</div><div class="line">colnames(dateline)&lt;-&quot;log_day&quot;</div><div class="line">dateline&lt;-createDataFrame(sqlContext=sqlcontext,data=dateline)</div><div class="line">registerTempTable(dateline,&quot;premium_date&quot;)</div><div class="line">  </div><div class="line"></div><div class="line">#  Query the premium log of the users who are still remained for 30d and not labeled as brush.</div><div class="line">z0&lt;-&quot;select	a.userid,</div><div class="line">		          from_unixtime(unix_timestamp(c.log_day,&apos;yyyyMMdd&apos;),&apos;yyyy-MM-dd&apos;) as log_day,</div><div class="line">              c.premium_final</div><div class="line">from dim_jlc.dim_user_info a</div><div class="line">left join app_jlc.brush_user b on a.userid=b.userid and b.log_day=&apos;2017-01-04&apos;</div><div class="line">left join fact_jlc.premium_record c on a.userid=c.userid</div><div class="line">where b.userid is null and datediff(&apos;2017-01-04&apos;,to_date(a.invest1st_time))&gt;30&quot;</div><div class="line"></div><div class="line">z1&lt;-&quot;select	a.userid,</div><div class="line">		to_date(a.invest1st_time) as invest1st_day</div><div class="line">from dim_jlc.dim_user_info a</div><div class="line">left join app_jlc.brush_user b on a.userid=b.userid</div><div class="line">where b.userid is null and datediff(&apos;2017-01-04&apos;,to_date(a.invest1st_time))&gt;30&quot;</div><div class="line"></div><div class="line">result&lt;-sql(hivecontext,z0)</div><div class="line">userinfo&lt;-sql(hivecontext,z1)</div><div class="line">colnames(result)&lt;-c(&quot;userid&quot;,&quot;log_day&quot;,&quot;premium&quot;)</div><div class="line">cache(result)</div><div class="line">cache(userinfo)</div><div class="line"></div><div class="line">user_num&lt;-dim(userinfo)[1]</div><div class="line">for(i in 1:user_num)&#123;</div><div class="line">  userid&lt;-</div><div class="line">  start_day&lt;-select(userinfo,&quot;invest1st_day&quot;)</div><div class="line">  dateline&lt;-seq()</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">#rawdata&lt;-fread(&quot;raw0104.csv&quot;)</div><div class="line">#rawdata_df&lt;-tbl_df(rawdata)</div><div class="line">#colnames(rawdata_df)&lt;-c(&quot;userid&quot;,&quot;log_day&quot;,&quot;premium&quot;)</div><div class="line"></div><div class="line">userinfo_df&lt;-collect(userinfo)</div><div class="line">userinfo_df&lt;-tbl_df(userinfo_df)</div></pre></td></tr></table></figure>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/01/02/rancher上手与问题/" title="rancher上手与问题" itemprop="url">rancher上手与问题</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2017-01-02T07:26:07.000Z" itemprop="datePublished"> 发表于 2017-01-02</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ol>
<li>rancher里的host能不能同时属于env1和env2，测试了一下，貌似一个host上只能启动一个agent。</li>
</ol>
<p>先把host1和host2添加到env1后，添加了wordpress的service stack，之后将所有服务都停掉，并deactivate两个hosts。</p>
<p>新建env2，将host1、host2同样的方法添加到env2中，布置mesos集群。</p>
<p>此时切回env1，再去激活host，发现已经不行了，host上提示disconnected。查看下面的container里，是有rancher agent的。有可能这个agent是在env2的那个把，所以不能连接到env1。</p>
<p>那：就是不能同时属于两个env咯？</p>
<ol>
<li>遇到get ip timeout问题，一般升级这个组件的版本就可以了</li>
<li>如果我们升级了某个组件的版本，再去调整这个组件的scale，它竟然会先自动降级，然后再调整scale。然后版本就<strong>又恢复成低版本</strong>的了。 Orz….</li>
<li></li>
</ol>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/30/saltstack自动化运维实施（二）/" title="saltstack自动化运维实施（二）" itemprop="url">saltstack自动化运维实施（二）</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-12-30T11:02:36.000Z" itemprop="datePublished"> 发表于 2016-12-30</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>我们安装saltstack的痛点在于文件同步，与分布式命令执行。</p>
<p>这一章我们弄一下文件同步的事情.<br>编辑master的配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">file_recv: True</div></pre></td></tr></table></figure></p>
<p>重启master。</p>
<p>从一个minion向master推送一个文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure></p>
<p>参考： </p>
<ul>
<li><a href="http://docs.saltstack.cn/ref/file_server/all/index.html" target="_blank" rel="external">http://docs.saltstack.cn/ref/file_server/all/index.html</a></li>
<li><a href="http://docs.saltstack.cn/ref/file_server/all/salt.fileserver.minionfs.html#module-salt.fileserver.minionfs" target="_blank" rel="external">http://docs.saltstack.cn/ref/file_server/all/salt.fileserver.minionfs.html#module-salt.fileserver.minionfs</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/30/saltstack自动化运维实施（一）/" title="saltstack自动化运维实施（一）" itemprop="url">saltstack自动化运维实施（一）</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-12-30T10:09:41.000Z" itemprop="datePublished"> 发表于 2016-12-30</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install salt</div></pre></td></tr></table></figure>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><h6 id="master"><a href="#master" class="headerlink" title="master"></a>master</h6><p>配置文件/etc/salt/master, 打开注释<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">autosign_file: /etc/salt/autosign.conf</div></pre></td></tr></table></figure></p>
<p>更多参考： <a href="https://docs.saltstack.com/en/latest/ref/configuration/master.html" target="_blank" rel="external">https://docs.saltstack.com/en/latest/ref/configuration/master.html</a></p>
<h6 id="minion"><a href="#minion" class="headerlink" title="minion"></a>minion</h6><p>一个是/etc/salt/minion_id, 一般可以取为hostname</p>
<p>还有/etc/salt/minion, 指定master的host<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">master: 10.0.1.110</div></pre></td></tr></table></figure></p>
<p>更多参考： <a href="https://docs.saltstack.com/en/latest/ref/configuration/minion.html" target="_blank" rel="external">https://docs.saltstack.com/en/latest/ref/configuration/minion.html</a></p>
<h2 id="启动"><a href="#启动" class="headerlink" title="启动"></a>启动</h2><h6 id="master-1"><a href="#master-1" class="headerlink" title="master"></a>master</h6><p>salt-master restart</p>
<h6 id="minion-1"><a href="#minion-1" class="headerlink" title="minion"></a>minion</h6><p>salt-minion restart</p>
<h2 id="认证"><a href="#认证" class="headerlink" title="认证"></a>认证</h2><h6 id="手动认证"><a href="#手动认证" class="headerlink" title="手动认证"></a>手动认证</h6><p>默认是没有开启自动认证的，需要人工手动判断哪些id是允许的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">[root@datanode21 ~]# salt-key -L    # 列出所有id</div><div class="line">Accepted Keys:</div><div class="line">datanode19</div><div class="line">datanode20</div><div class="line">datanode21</div><div class="line">Denied Keys:</div><div class="line">Unaccepted Keys:</div><div class="line">Rejected Keys:</div><div class="line">[root@datanode21 ~]# salt-key -A # 通过所有认证</div><div class="line">[root@datanode21 ~]# salt-key -d datanode21  # 删除指定id</div><div class="line">The following keys are going to be deleteed:</div><div class="line">Accepted Keys:</div><div class="line">datanode21</div><div class="line">Proceed? [N/y] y</div><div class="line">Key for minion datanode21 deleteed.</div></pre></td></tr></table></figure></p>
<p>官网有说把master.pub放到minion里，但是我使用的时候并没有发现什么卵用~~~</p>
<h6 id="自动认证"><a href="#自动认证" class="headerlink" title="自动认证"></a>自动认证</h6><p>我弄了一种并不是很安全，但是相对比较安全的方式，使用hostname来自动认证.<br>编辑/etc/salt/master文件, 打开注释<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">autosign_file: /etc/salt/autosign.conf</div></pre></td></tr></table></figure></p>
<p>之后编辑/etc/salt/autosign.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">datanode??.will.com</div></pre></td></tr></table></figure></p>
<p>这里是正则匹配id的，如果minion的id能满足这里的正则表达式，就可以自动通过认证。</p>
<p>因为修改了/etc/salt/master文件，所以需要重启一下，如果只修改匹配规则文件是不需要重启的。</p>
<p>参考：<a href="http://www.it610.com/article/3325439.htm" target="_blank" rel="external">http://www.it610.com/article/3325439.htm</a></p>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>在master的机器上执行<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@datanode21 ~]# salt &apos;*&apos; test.ping</div><div class="line">datanode21.will.com:</div><div class="line">    True</div><div class="line">datanode19.will.com:</div><div class="line">    True</div><div class="line">datanode20.will.com:</div><div class="line">    True</div></pre></td></tr></table></figure></p>
<h2 id="分发脚本"><a href="#分发脚本" class="headerlink" title="分发脚本"></a>分发脚本</h2><p>先安装<a href="http://fabric-chs.readthedocs.io/zh_CN/chs/tutorial.html" target="_blank" rel="external"><strong>Fabric</strong></a>.</p>
<p>编辑fabfile.py：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment">#!/usr/bin/env python</span></div><div class="line"><span class="comment"># encoding: utf-8</span></div><div class="line"></div><div class="line"><span class="comment">#from fabric.api import local,cd,run,env,put</span></div><div class="line"><span class="keyword">from</span> fabric.api <span class="keyword">import</span> *</div><div class="line"></div><div class="line">env.hosts=[<span class="string">'172.16.4.74'</span>]</div><div class="line">env.password = <span class="string">'Yinker.com'</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@parallel</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">salt_install</span><span class="params">()</span>:</span></div><div class="line"><span class="comment">#    run('/etc/init.d/iptables stop')  #远程操作用run</span></div><div class="line"><span class="comment">#    run('mkdir /server')</span></div><div class="line">    run(<span class="string">'yum -y install openssh-clients'</span>)  <span class="comment">#远程操作用run</span></div><div class="line">    run(<span class="string">'yum -y install https://repo.saltstack.com/yum/redhat/salt-repo-latest-1.el6.noarch.rpm'</span>)  <span class="comment">#远程操作用run</span></div><div class="line">    run(<span class="string">'yum -y install python-devel'</span>)  <span class="comment">#远程操作用run</span></div><div class="line">    run(<span class="string">'yum -y install salt-minion'</span>)  <span class="comment">#远程操作用run</span></div><div class="line">    run(<span class="string">'test -f /etc/salt/minion &amp;&amp; rm -rf /etc/salt/minion'</span>)  <span class="comment">#远程操作用run</span></div><div class="line">    put(<span class="string">'/root/qian/minion'</span>,<span class="string">'/etc/salt/minion'</span>)</div><div class="line">    run(<span class="string">'echo `hostname` &gt;/etc/salt/minion_id'</span>)</div><div class="line">    put(<span class="string">'/root/qian/selinux'</span>,<span class="string">'/etc/sysconfig/selinux'</span>)</div><div class="line">    run(<span class="string">'setenforce 0'</span>)</div><div class="line">    run(<span class="string">'/etc/init.d/salt-minion restart'</span>)</div></pre></td></tr></table></figure></p>
<p>调用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/local/bin/fab -f fabfile.py salt_install</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/28/单点登出问题/" title="单点登出问题" itemprop="url">单点登出问题</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-12-28T06:37:32.000Z" itemprop="datePublished"> 发表于 2016-12-28</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h4 id="表现"><a href="#表现" class="headerlink" title="表现"></a>表现</h4><p>登陆后短时间内刷新页面，就会提示重新登陆。</p>
<p>后台对应的log：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">2016-12-28 14:32:53,094 INFO [org.jasig.inspektr.audit.support.Slf4jLoggingAuditTrailManager] - Audit trail record BEGIN</div><div class="line">=============================================================</div><div class="line">WHO: audit:unknown</div><div class="line">WHAT: TGT-************************************************OgnMZDqjiE-cas01.example.org</div><div class="line">ACTION: TICKET_GRANTING_TICKET_CREATED</div><div class="line">APPLICATION: CAS</div><div class="line">WHEN: Wed Dec 28 14:32:53 CST 2016</div><div class="line">CLIENT IP ADDRESS: 10.1.5.83</div><div class="line">SERVER IP ADDRESS: 10.0.1.62</div><div class="line">=============================================================</div></pre></td></tr></table></figure></p>
<p>正常的登陆log:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">2016-12-28 14:32:53,093 INFO [org.jasig.inspektr.audit.support.Slf4jLoggingAuditTrailManager] - Audit trail record BEGIN</div><div class="line">=============================================================</div><div class="line">WHO: admin</div><div class="line">WHAT: Supplied credentials: [admin]</div><div class="line">ACTION: AUTHENTICATION_SUCCESS</div><div class="line">APPLICATION: CAS</div><div class="line">WHEN: Wed Dec 28 14:32:53 CST 2016</div><div class="line">CLIENT IP ADDRESS: 10.1.5.83</div><div class="line">SERVER IP ADDRESS: 10.0.1.62</div><div class="line">=============================================================</div></pre></td></tr></table></figure></p>
<p>参考：</p>
<ul>
<li></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/23/hdfs-rebalance引发的问题/" title="hdfs-rebalance引发的问题" itemprop="url">hdfs-rebalance引发的问题</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-12-23T10:08:23.000Z" itemprop="datePublished"> 发表于 2016-12-23</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>原来的集群节点是8台datanode…….HDFS的使用总量已经到了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Slow waitForAckedSeqno took 179279ms (threshold=30000ms)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Bad response ERROR for block BP-1029563541-10.0.1.72-1463106887558:blk_1077490973_3758370 from datanode DatanodeInfoWithStorage[10.0.1.98:50010,DS-a387140d-7</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Got error, status message , ack with firstBadLink as 10.0.1.101:50010</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">java.io.IOException: Bad response ERROR for block BP-1029563541-10.0.1.72-1463106887558:blk_1077490815_3758189 from datanode DatanodeInfoWithStorage[10.0.1.101:50010,DS-8786adb7-d8ae-4b29-a8af-4cb73a8a5e72,DISK]</div><div class="line">	at org.apache.hadoop.hdfs.DFSOutputStream$DataStreamer$ResponseProcessor.run(DFSOutputStream.java:785)</div></pre></td></tr></table></figure>
<p>map失败log信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">2016-12-24 22:19:01,865 WARN [main] org.apache.hadoop.metrics2.impl.MetricsConfig: Cannot locate configuration: tried hadoop-metrics2-maptask.properties,hadoop-metrics2.properties</div><div class="line">2016-12-24 22:19:05,431 INFO [main] org.apache.hadoop.metrics2.impl.MetricsSystemImpl: Scheduled snapshot period at 10 second(s).</div><div class="line">2016-12-24 22:19:05,431 INFO [main] org.apache.hadoop.metrics2.impl.MetricsSystemImpl: MapTask metrics system started</div><div class="line">2016-12-24 22:19:05,442 INFO [main] org.apache.hadoop.mapred.YarnChild: Executing with tokens:</div><div class="line">2016-12-24 22:19:05,442 INFO [main] org.apache.hadoop.mapred.YarnChild: Kind: mapreduce.job, Service: job_1482504625052_0529, Ident: (org.apache.hadoop.mapreduce.security.token.JobTokenIdentifier@57a78e3)</div><div class="line">2016-12-24 22:20:33,408 INFO [main] org.apache.hadoop.mapred.YarnChild: Sleeping for 0ms before retrying again. Got null now.</div><div class="line">2016-12-24 22:20:46,112 INFO [main] org.apache.hadoop.metrics2.impl.MetricsSystemImpl: Stopping MapTask metrics system...</div><div class="line">2016-12-24 22:20:46,119 INFO [main] org.apache.hadoop.metrics2.impl.MetricsSystemImpl: MapTask metrics system stopped.</div><div class="line">2016-12-24 22:20:46,119 INFO [main] org.apache.hadoop.metrics2.impl.MetricsSystemImpl: MapTask metrics system shutdown complete.</div></pre></td></tr></table></figure></p>
<p>MR任务之间有一段空白期<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">2016-12-24 21:29:50,046 Stage-1 map = 100%, reduce = 99%, Cumulative CPU 4516.43 sec</div><div class="line">2016-12-24 21:30:04,499 Stage-1 map = 100%, reduce = 100%, Cumulative CPU 4528.6 sec</div><div class="line">MapReduce Total cumulative CPU time: 0 days 1 hours 15 minutes 28 seconds 600 msec</div><div class="line">Ended Job = job_1482504625052_0527</div><div class="line">Launching Job 2 out of 3</div><div class="line">Number of reduce tasks not specified. Defaulting to jobconf value of: 30</div><div class="line">In order to change the average load for a reducer (in bytes):</div><div class="line">set hive.exec.reducers.bytes.per.reducer=</div><div class="line">In order to limit the maximum number of reducers:</div><div class="line">set hive.exec.reducers.max=</div><div class="line">In order to set a constant number of reducers:</div><div class="line">set mapreduce.job.reduces=</div><div class="line">Starting Job = job_1482504625052_0528, Tracking URL = http://datanode02.will.com:8088/proxy/application_1482504625052_0528/</div><div class="line">Kill Command = /usr/hdp/2.4.2.0-258/hadoop/bin/hadoop job -kill job_1482504625052_0528</div><div class="line">Hadoop job information for Stage-5: number of mappers: 7; number of reducers: 30</div><div class="line">2016-12-24 21:54:09,652 Stage-5 map = 0%, reduce = 0%</div><div class="line">2016-12-24 21:54:19,037 Stage-5 map = 14%, reduce = 0%, Cumulative CPU 7.53 sec</div><div class="line">2016-12-24 21:54:20,077 Stage-5 map = 29%, reduce = 0%, Cumulative CPU 15.38 sec</div><div class="line">2016-12-24 21:54:36,677 Stage-5 map = 39%, reduce = 0%, Cumulative CPU 44.43 sec</div><div class="line">2016-12-24 21:54:37,759 Stage-5 map = 71%, reduce = 0%, Cumulative CPU 52.41 sec</div><div class="line">2016-12-24 21:54:48,153 Stage-5 map = 71%, reduce = 1%, Cumulative CPU 53.96 sec</div><div class="line">2016-12-24 21:54:49,186 Stage-5 map = 71%, reduce = 2%, Cumulative CPU 56.57 sec</div></pre></td></tr></table></figure></p>
<p>21:30到21:54,这段时间namenode的log里的一些内容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">2016-12-24 21:49:01,939 INFO  hdfs.StateChange (FSNamesystem.java:completeFile(3545)) - DIR* completeFile: /apps/hbase/data/data/default/KYLIN_U1V82JA44K/8c474006d2f4332bdaaee58105bb465a/.tmp/79460c3b99ba48f8b67cfadba06d277e is closed by DFSClient_NONMAPREDUCE_-90235743_1</div><div class="line">2016-12-24 21:49:02,045 INFO  hdfs.StateChange (FSNamesystem.java:logAllocatedBlock(3652)) - BLOCK* allocate blk_1077490355_3757707, replicas=10.0.1.86:50010, 10.0.1.95:50010, 10.0.1.84:50010 for /apps/hbase/data/data/default/KYLIN_U1V82JA44K/9674d0c2aec6aa86cb092088d9461163/.tmp/7d5802bddb694c25a84cdd2263bcca42</div><div class="line"></div><div class="line"></div><div class="line">2016-12-24 21:42:49,930 INFO  hdfs.StateChange (FSNamesystem.java:completeFile(3545)) - DIR* completeFile: /apps/hbase/data/data/default/KYLIN_V5P8H4CZJF/2c1b15e259130ca37d1c4808aade03e6/.tmp/d702471e4c784abba520d494c29b03f2 is closed by DFSClient_NONMAPREDUCE_434452785_1</div><div class="line"></div><div class="line"></div><div class="line">namenode.FSNamesystem (FSNamesystem.java:updatePipeline(6535)) - updatePipeline(blk_1077490302_3757650, newGS=3757651, newLength=114137522, newNodes=[10.0.1.96:50010, 10.0.1.83:50010], client=DFSClient_NONMAPREDUCE_829342269_1)</div><div class="line">2016-12-24 21:42:49,567 INFO  namenode.FSNamesystem (FSNamesystem.java:updatePipeline(6554)) - updatePipeline(blk_1077490302_3757650 =&gt; blk_1077490302_3757651) success</div><div class="line"></div><div class="line"></div><div class="line">chooseUnderReplicatedBlocks selected 1 blocks at priority level 2;  Total=1 Reset bookmarks? true</div><div class="line"></div><div class="line">namenode.FSEditLog (FSEditLog.java:printStatistics(699)) - Number of transactions: 106401 Total time fo</div><div class="line">r transactions(ms): 961 Number of transactions batched in Syncs: 3666 Number of syncs: 87634 SyncTimes(ms): 239376</div></pre></td></tr></table></figure></p>
<p>failed的reducer的提示note：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">AttemptID:attempt_1482504625052_0537_r_000003_0 Timed out after 300 secs Container killed by the ApplicationMaster. Container killed on request. Exit code is 143 Container exited with a non-zero exit code 143</div></pre></td></tr></table></figure></p>
<p>balance完成之后，运行了几天，每天的任务从2小时、1个小时40分钟、1小时30分钟、1小时20分钟递减~~也很少出现这种问题了……诡异</p>
<p>参考下面的资料，基本思想就是timeout的时间内，没有完成某个任务，所以把timeout延长就可以了。还没有实践测试….就好了</p>
<p>还是看一下这附近的源码比较好一些~</p>
<p>参考：</p>
<ul>
<li><a href="http://www.superwu.cn/2014/11/13/1334/" target="_blank" rel="external">http://www.superwu.cn/2014/11/13/1334/</a></li>
<li><a href="http://blog.sina.com.cn/s/blog_72827fb1010198j7.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_72827fb1010198j7.html</a></li>
<li><a href="http://blog.163.com/zhengjiu_520/blog/static/3559830620130743644473/" target="_blank" rel="external">http://blog.163.com/zhengjiu_520/blog/static/3559830620130743644473/</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/22/mesos的docker化安装部署/" title="mesos的docker化安装部署" itemprop="url">mesos的docker化安装部署</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-12-22T09:38:06.000Z" itemprop="datePublished"> 发表于 2016-12-22</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>首先，还是从源头说起，用阿里云的yum源，下载安装都会快一些。<br>zookeeper<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -d  --net=&quot;host&quot;   -e SERVER_ID=3 -e ADDITIONAL_ZOOKEEPER_1=server.1=10.1.5.129:2888:3888 -e ADDITIONAL_ZOOKEEPER_2=server.2=10.1.5.180:2888:3888 -e ADDITIONAL_ZOOKEEPER_3=server.3=10.1.5.190:2888:3888 --name zk garland/zookeeper</div></pre></td></tr></table></figure></p>
<p>master<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">docker run --net=&quot;host&quot; \</div><div class="line">   -p 5050:5050 \</div><div class="line">   -e &quot;MESOS_HOSTNAME=10.1.5.129&quot; \</div><div class="line">  -e &quot;MESOS_IP=10.1.5.129&quot; \</div><div class="line">  -e &quot;MESOS_ZK=zk://10.1.5.129:2181,10.1.5.180:2181,10.1.5.190:2181/mesos&quot; \</div><div class="line">  -e &quot;MESOS_PORT=5050&quot; \</div><div class="line">   -e &quot;MESOS_LOG_DIR=/var/log/mesos&quot; \</div><div class="line">   -e &quot;MESOS_QUORUM=1&quot; \</div><div class="line">   -e &quot;MESOS_REGISTRY=in_memory&quot; \</div><div class="line">   -e &quot;MESOS_WORK_DIR=/var/lib/mesos&quot; \</div><div class="line">   -d --name mesos-master garland/mesosphere-docker-mesos-master</div><div class="line">   </div><div class="line">docker run --net=&quot;host&quot; \</div><div class="line">   -p 5050:5050 \</div><div class="line">   -e &quot;MESOS_HOSTNAME=10.1.5.180&quot; \</div><div class="line">  -e &quot;MESOS_IP=10.1.5.180&quot; \</div><div class="line">  -e &quot;MESOS_ZK=zk://10.1.5.129:2181,10.1.5.180:2181,10.1.5.190:2181/mesos&quot; \</div><div class="line">  -e &quot;MESOS_PORT=5050&quot; \</div><div class="line">   -e &quot;MESOS_LOG_DIR=/var/log/mesos&quot; \</div><div class="line">   -e &quot;MESOS_QUORUM=1&quot; \</div><div class="line">   -e &quot;MESOS_REGISTRY=in_memory&quot; \</div><div class="line">   -e &quot;MESOS_WORK_DIR=/var/lib/mesos&quot; \</div><div class="line">   -d --name mesos-master garland/mesosphere-docker-mesos-master</div><div class="line">   </div><div class="line">   </div><div class="line"> docker run --net=&quot;host&quot; \</div><div class="line">   -p 5050:5050 \</div><div class="line">   -e &quot;MESOS_HOSTNAME=10.1.5.190&quot; \</div><div class="line">  -e &quot;MESOS_IP=10.1.5.190&quot; \</div><div class="line">  -e &quot;MESOS_ZK=zk://10.1.5.129:2181,10.1.5.180:2181,10.1.5.190:2181/mesos&quot; \</div><div class="line">  -e &quot;MESOS_PORT=5050&quot; \</div><div class="line">   -e &quot;MESOS_LOG_DIR=/var/log/mesos&quot; \</div><div class="line">   -e &quot;MESOS_QUORUM=1&quot; \</div><div class="line">   -e &quot;MESOS_REGISTRY=in_memory&quot; \</div><div class="line">   -e &quot;MESOS_WORK_DIR=/var/lib/mesos&quot; \</div><div class="line">   -d --name mesos-master garland/mesosphere-docker-mesos-master</div></pre></td></tr></table></figure></p>
<p>marathon<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">docker run \</div><div class="line"> -d \</div><div class="line"> -p 8080:8080 \</div><div class="line"> garland/mesosphere-docker-marathon --master zk://10.1.5.129:2181,10.1.5.180:2181,10.1.5.190:2181/mesos --zk zk://10.1.5.129:2181,10.1.5.180:2181,10.1.5.190:2181/marathon</div></pre></td></tr></table></figure></p>
<p>slave<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">docker run -d \</div><div class="line"> --entrypoint=&quot;mesos-slave&quot; \</div><div class="line"> -e &quot;MESOS_MASTER=zk://10.1.5.129:2181,10.1.5.180:2181,10.1.5.190:2181/mesos&quot; \</div><div class="line"> -e &quot;MESOS_LOG_DIR=/var/log/mesos&quot; \</div><div class="line"> -e &quot;MESOS_LOGGING_LEVEL=INFO&quot; \</div><div class="line"> garland/mesosphere-docker-mesos-master:latest</div></pre></td></tr></table></figure></p>
<p>参考：</p>
<ul>
<li><a href="http://www.cnblogs.com/ee900222/p/docker_2.html" target="_blank" rel="external">http://www.cnblogs.com/ee900222/p/docker_2.html</a></li>
<li><a href="https://mesosphere.com/blog/2014/07/17/mesosphere-package-repositories/#" target="_blank" rel="external">https://mesosphere.com/blog/2014/07/17/mesosphere-package-repositories/#</a></li>
<li><a href="http://www.jingyuyun.com/article/8062.html" target="_blank" rel="external">http://www.jingyuyun.com/article/8062.html</a></li>
<li><a href="http://dockone.io/article/493" target="_blank" rel="external">http://dockone.io/article/493</a></li>
<li><a href="http://www.mesoscn.cn/document/runing-Mesos/Configuration.html" target="_blank" rel="external">http://www.mesoscn.cn/document/runing-Mesos/Configuration.html</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/09/一致性协议zab与raft/" title="一致性协议zab与raft" itemprop="url">一致性协议zab与raft</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-12-09T06:56:21.000Z" itemprop="datePublished"> 发表于 2016-12-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>zookeeper的zab1.0协议<br>raft协议<br>重视看来一下zookeeper的选举过程，并不是原来说的大家都排队拿一个号，谁小谁当。而是依次比较epoch(选举轮数)、zxid(处理的事务id)、serverid(my.ini里的server.id)，可能最后的server.id是原来那样说的原因吧。<br>zookeeper的实现是通过一个MessageSender和一个MessageReceiver来实现</p>
<p>raft算法中，follower跟leader不一致的地方会被leader覆盖掉。zookeeper同样也是这样，TRUNC类型的message的处理。</p>
<p>raft不同于zookeeper的地方：<br>选举的时候serverid的地方并不一样，是通过随机选举超时时间，防止瓜分选票</p>
<p>有一个难点，假设一共5个server，如果某个leader在将所有的logid/zxid同步到了大多数机器，也就是3台，term或者epoch为2。此时挂掉，选举了一个新的leader，它对于这三台机器中的新的log/zxid的处理方式。<br>raft会判断是否多数已经同步，如果是，就接受并发送出去，同步给其他server。zookeeper并没有提及 —— TODO 源码确认</p>
<p>####<br>参考：</p>
<ul>
<li><a href="https://cwiki.apache.org/confluence/display/ZOOKEEPER/Zab1.0" target="_blank" rel="external">https://cwiki.apache.org/confluence/display/ZOOKEEPER/Zab1.0</a></li>
<li><a href="http://www.tuicool.com/articles/IfQR3u3" target="_blank" rel="external">http://www.tuicool.com/articles/IfQR3u3</a></li>
<li><a href="https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md" target="_blank" rel="external">https://github.com/maemual/raft-zh_cn/blob/master/raft-zh_cn.md</a><br>-<a href="http://www.cnblogs.com/yuyijq/p/4116365.html" target="_blank" rel="external">http://www.cnblogs.com/yuyijq/p/4116365.html</a><br>-<a href="http://iwinit.iteye.com/blog/1773531" target="_blank" rel="external">http://iwinit.iteye.com/blog/1773531</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/05/微服务（翻译）/" title="微服务（翻译）" itemprop="url">微服务（翻译）</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-12-05T09:12:13.000Z" itemprop="datePublished"> 发表于 2016-12-05</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="新架构角度的定义"><a href="#新架构角度的定义" class="headerlink" title="新架构角度的定义"></a>新架构角度的定义</h2><p>微服务这个名词最近几年比较火，它代表一套独立部署的应用服务的软件设计。然而对于这种架构方式并没有精确的定义，微观组织的业务能力有几个共同的特征：自动化部署、智能终端、语言和数据的分散控制。</p>
<p>微服务是众多软件架构中的一种。以前我们只是轻蔑的瞥一眼，最近几年来微服务的使用效果让我们见证到了它的威力。而且有些学校已经把它当做企业编程系统模式来教学。可悲的是，并没有人明确指出应该怎样构建一个微服务架构~</p>
<p>简单来说，微服务就是提供一套服务来开发一个应用，其中每个服务都运行在自己的进程里，它们之间使用轻量级的协议进行沟通，多数是http。这些服务是围绕业务构建的，而且各自独立地被自动化部署。最低限度地集中管理这些服务，因为这些服务可能是各种编程语言写的，也有可能使用各自不同的存储技术。</p>
<p>下面对比整体编程架构来介绍一下微服务架构。一般的应用由三部分构成：前端、数据库、后端服务。后端服务负责处理http请求，执行业务逻辑，接收并更新数据到数据库，选择适当的视图返回给客户端。这样的后端服务就是一个整体编程架构。任何修改都要重新发布整个后端服务。</p>
<p>上面提到的整体架构是构建系统的一个很自然的方式。处理请求的所有的业务逻辑都在一个单一的进程里，你可以使用语言特性讲不通的功能分配给不同的类、函数、命名空间。对于个别关心的东西，你可以在开发人员的笔记本上运行测试。使用一个发布pipeline来保证改变的东西已经被测试过了，然后发布到生产环境。你可以在负载均衡后面运行多个app实例来横向扩展。</p>
<p>整体架构其实比较成功，只是人们慢慢感觉到有些受挫，尤其是越来越多的应用被发布到云中。修改环节紧紧联系在一起，对应用的一小部分进行修改，就需要整体应用都重新构建与发布。随着时间推移，要想保持一个很好的模块化架构变得特别困难。扩展的话也必须扩展整体应用，而不能紧紧扩展指定的一些模块，这样就耗费了很多资源。</p>
<p><img src="http://martinfowler.com/articles/microservices/images/sketch.png" alt="整体架构 与 微服务"></p>
<p>这些困难催生了微服务架构：把app当做服务组来构建。每个服务不但独立部署和扩展，他们还提供严格的模块边界，甚至不同的服务还可以使用不同的编程语言来实现，也可以由不同的团队负责开发与管理。</p>
<p>我们并不是说微服务是创新的，至少它回归到了Unix的设计原则。我们就是认为使用微服务架构思想编程的人还比较少，其实使用它会让我们的软件开发更好。</p>
<h2 id="微服务架构的特点"><a href="#微服务架构的特点" class="headerlink" title="微服务架构的特点"></a>微服务架构的特点</h2><p> While we authors have been active members of this rather loose community, our intention is to attempt a description of what we see in our own work and in similar efforts by teams we know of. In particular we are not laying down some definition to conform to.</p>
<p>我们并不能对微服务下一个官方定义，但是我们可以尝试描述一下微服务的几个共同特点。并不是所有的微服务架构都有这些特点，但是我们希望多数的微服务都展示出了这些特点的大部分。</p>
<h4 id="组件化服务"><a href="#组件化服务" class="headerlink" title="组件化服务"></a>组件化服务</h4><p>软件工业中我们一般把系统设计成可以将component组装起来的架构，多数是使用公用的libraries实现。</p>
<p>提到component，我们看一下它的定义，component是软件的一个单元，独立、可替换、可升级。</p>
<p>Microservice architectures will use libraries, but their primary way of componentizing their own software is by breaking down into services. We define libraries as components that are linked into a program and called using in-memory function calls, while services are out-of-process components who communicate with a mechanism such as a web service request, or remote procedure call. (This is a different concept to that of a service object in many OO programs [3].)</p>
<p>微服务架构把软件打散成不同的服务，也是用libraries。libraries是被链接到程序中，在内存中调用函数的component，而服务是进程之外的component，使用类似web service request进行沟通，或者RPC。</p>
<p>One main reason for using services as components (rather than libraries) is that services are independently deployable. If you have an application [4] that consists of a multiple libraries in a single process, a change to any single component results in having to redeploy the entire application. But if that application is decomposed into multiple services, you can expect many single service changes to only require that service to be redeployed. That’s not an absolute, some changes will change service interfaces resulting in some coordination, but the aim of a good microservice architecture is to minimize these through cohesive service boundaries and evolution mechanisms in the service contracts.</p>
<p>把服务组件化的一个主要理由就是服务可以独立部署。如果你有一个单进程中包含多个libraries的应用，修改任何一个component都需要重新部署整个应用。但是如果你的应用解耦成为多个服务，你可以只重新部署修改到的地方。当然这并不是绝对的，如果修改了服务接口，肯定也要重新修改部署协作的服务，但是微服务的目标就是通过黏着的服务边界和服务规范的进化机制最小化这个修改范围。</p>
<p>Another consequence of using services as components is a more explicit component interface. Most languages do not have a good mechanism for defining an explicit Published Interface. Often it’s only documentation and discipline that prevents clients breaking a component’s encapsulation, leading to overly-tight coupling between components. Services make it easier to avoid this by using explicit remote call mechanisms.</p>
<p>另一个服务组件化的结果就是更灵活的component接口。大多数语言都不能定义一个明确详实的公共接口。通常只能通过文档和规范来约束客户端遵循component的封装，导致组件之间过度依赖。组件化服务可以使用明确的远程调用机制避免这些。</p>
<p>Using services like this does have downsides. Remote calls are more expensive than in-process calls, and thus remote APIs need to be coarser-grained, which is often more awkward to use. If you need to change the allocation of responsibilities between components, such movements of behavior are harder to do when you’re crossing process boundaries.</p>
<p>使用这样的服务也是有缺点的。远程多用通常比进程内调用代价昂贵，因此远程API需要是粗粒度的。如果你必须修改component之间的职责分配，这样的行为移动非常难弄，尤其是跨进程边界的时候。</p>
<p>At a first approximation, we can observe that services map to runtime processes, but that is only a first approximation. A service may consist of multiple processes that will always be developed and deployed together, such as an application process and a database that’s only used by that service.</p>
<p>第一印象，我们可以把这样的服务看做是运行时进程。注意，这只是为了好理解一些，事实上一个service可以包含多个进程，比如一个应用进程和这个进程使用的数据库进程。</p>
<h4 id="业务管理"><a href="#业务管理" class="headerlink" title="业务管理"></a>业务管理</h4><p>When looking to split a large application into parts, often management focuses on the technology layer, leading to UI teams, server-side logic teams, and database teams. When teams are separated along these lines, even simple changes can lead to a cross-team project taking time and budgetary approval. A smart team will optimise around this and plump for the lesser of two evils - just force the logic into whichever application they have access to. Logic everywhere in other words. This is an example of Conway’s Law[5] in action.</p>
<p>当把一个大的应用切分成多个部分的时候，通常管理就集中在技术层面，出现UI团队，后端逻辑团队，数据库团队。当各个团队分成这些战线之后，即便是特别小的改变也是一个跨团队项目，需要时间和预算。一个牛逼的团队会优化这些东西，取这两个恶魔中比较少的那个。强制把业务逻辑放到一个必须存在的地方。换句话说导出都写逻辑。这是Conway’s Law in action的一个实例。</p>
<blockquote>
<p>Any organization that designs a system (defined broadly) will produce a design whose structure is a copy of the organization’s communication structure.<br>– Melvyn Conway, 1967</p>
<p>任何组织的系统都是组织结构沟通结构的复制。</p>
</blockquote>
<p><img src="http://martinfowler.com/articles/microservices/images/conways-law.png" alt="Conway&#39;s Law in action"></p>
<p>The microservice approach to division is different, splitting up into services organized around business capability. Such services take a broad-stack implementation of software for that business area, including user-interface, persistant storage, and any external collaborations. Consequently the teams are cross-functional, including the full range of skills required for the development: user-experience, database, and project management.</p>
<p>微服务的切分不同，它是围绕业务切分服务。这样的服务包含特定业务领域系统的所有技术栈的实现，包含UI、持久存储、外部协作。结果这样的团队就跨功能，包含开发所需的所有的技术：UI、数据库、项目管理。</p>
<p><img src="http://martinfowler.com/articles/microservices/images/PreferFunctionalStaffOrganization.png" alt="Service boundaries reinforced by team boundaries"></p>
<p>One company organised in this way is www.comparethemarket.com. Cross functional teams are responsible for building and operating each product and each product is split out into a number of individual services communicating via a message bus.</p>
<p>www.comparethemarket.com就是这样组织的一个公司。跨功能团队负责构建和操作每个产品，每个产品也都被切分成几个单独的服务，这些服务之间通过message bus沟通。</p>
<p>Large monolithic applications can always be modularized around business capabilities too, although that’s not the common case. Certainly we would urge a large team building a monolithic application to divide itself along business lines. The main issue we have seen here, is that they tend to be organised around too many contexts. If the monolith spans many of these modular boundaries it can be difficult for individual members of a team to fit them into their short-term memory. Additionally we see that the modular lines require a great deal of discipline to enforce. The necessarily more explicit separation required by service components makes it easier to keep the team boundaries clear.</p>
<p>大的整体应用通常也可以围绕业务进行模块化，尽管还不是通用案例。当然我们需要推动一个大的团队构建一个整体应用根据业务线进行切割。我们在这里遇到的主要的问题是，需要这里面的组织会包含太多的context。如果这个整体应用贯穿了所有模块边界，那么就很难让团队里的个人成员把他们短期记忆住。另外我们知道模块线需要一个准则。 服务组价需要一定更明确的分离，这样能够让团队边界也更清晰。</p>
<h4 id="产品而不是项目"><a href="#产品而不是项目" class="headerlink" title="产品而不是项目"></a>产品而不是项目</h4><p>Most application development efforts that we see use a project model: where the aim is to deliver some piece of software which is then considered to be completed. On completion the software is handed over to a maintenance organization and the project team that built it is disbanded.</p>
<p>我们见的多数的应用开发都是使用项目模型：目标就是交付软件的某些片段。完成后，软件就转交给运维，然后项目团队就解散了。</p>
<p>Microservice proponents tend to avoid this model, preferring instead the notion that a team should own a product over its full lifetime. A common inspiration for this is Amazon’s notion of “you build, you run it” where a development team takes full responsibility for the software in production. This brings developers into day-to-day contact with how their software behaves in production and increases contact with their users, as they have to take on at least some of the support burden.</p>
<p>微服务支持者要避免这种情况，一个团队应该负责产品的整个生命周期。亚马逊的口号：谁构建，谁运行。一个开发团队对于生产线上的软件要全权负责。这样开发者每天都会考虑他的软件在生成环境运行的情况咋样，也多跟他的用户沟通，他们必须多少承担一些事情。</p>
<p>The product mentality, ties in with the linkage to business capabilities. Rather than looking at the software as a set of functionality to be completed, there is an on-going relationship where the question is how can software assist its users to enhance the business capability.</p>
<p>产品是与业务线贴合的。除了把软件当做一组完成的功能，还有一个持续的关系，就是软件怎样辅助它的用户来加强业务能力。</p>
<h4 id="Smart-endpoints-and-dumb-pipes"><a href="#Smart-endpoints-and-dumb-pipes" class="headerlink" title="Smart endpoints and dumb pipes"></a>Smart endpoints and dumb pipes</h4><p>When building communication structures between different processes, we’ve seen many products and approaches that stress putting significant smarts into the communication mechanism itself. A good example of this is the Enterprise Service Bus (ESB), where ESB products often include sophisticated facilities for message routing, choreography, transformation, and applying business rules.</p>
<p>当为不同的进程构建沟通结构的时候，我们见过很多产品都强调吧关键的smart放进沟通机制本身中。一个例子就是ESB。ESB产品通常都包含复杂的设备来支持消息路由、编排、转化、应用业务规则。</p>
<p>The microservice community favours an alternative approach: smart endpoints and dumb pipes. Applications built from microservices aim to be as decoupled and as cohesive as possible - they own their own domain logic and act more as filters in the classical Unix sense - receiving a request, applying logic as appropriate and producing a response. These are choreographed using simple RESTish protocols rather than complex protocols such as WS-Choreography or BPEL or orchestration by a central tool.</p>
<p>微服务组织最喜欢另一种方式：smart endpoints and dumb pipes. 使用微服务构建的应用旨在尽可能解耦，边界尽可能清洗-他们都有自己的逻辑，表现的像个经典Unix派感觉的filter - 接收一个请求，应用业务逻辑，然后产生一个response。他们被使用简单的REST系列协议编排，而不是类似WS-Choreography或者BPRL啥的复杂的协议。</p>
<p>The two protocols used most commonly are HTTP request-response with resource API’s and lightweight messaging[6]. The best expression of the first is</p>
<p>两个最常用的协议是带有resource API的HTTP request-reponse，还有轻量级消息协议。前者最好的表达是：</p>
<blockquote>
<p>Be of the web, not behind the web<br>– Ian Robinson</p>
</blockquote>
<p>Microservice teams use the principles and protocols that the world wide web (and to a large extent, Unix) is built on. Often used resources can be cached with very little effort on the part of developers or operations folk.</p>
<p>不会翻译。</p>
<p>The second approach in common use is messaging over a lightweight message bus. The infrastructure chosen is typically dumb (dumb as in acts as a message router only) - simple implementations such as RabbitMQ or ZeroMQ don’t do much more than provide a reliable asynchronous fabric - the smarts still live in the end points that are producing and consuming messages; in the services.</p>
<p>后者通常通过一个轻量级的message bug来使用。基础设施通常选用dumb，简单的实现例如RabbitMQ、ZeroMQ，并没有为一个可靠的异步fabric多做了些什么 - smart还是在生成和消费message的终端上。</p>
<p>In a monolith, the components are executing in-process and communication between them is via either method invocation or function call. The biggest issue in changing a monolith into microservices lies in changing the communication pattern. A naive conversion from in-memory method calls to RPC leads to chatty communications which don’t perform well. Instead you need to replace the fine-grained communication with a coarser -grained approach.</p>
<p>在一个整体应用中，component是运行在同一个进程内的，可以通过方法触发或函数调用来相互沟通。切分成为微服务后，一个比较大的问题就是沟通模型。从内存中的方法调用到RPC导致了啰嗦的沟通机制。除此之外，你必须使用细粒度沟通替换为粗粒度的。</p>
<h4 id="Decentralized-Governance-（分权治理-去中心化）"><a href="#Decentralized-Governance-（分权治理-去中心化）" class="headerlink" title="Decentralized Governance （分权治理/去中心化）"></a>Decentralized Governance （分权治理/去中心化）</h4><p>One of the consequences of centralised governance is the tendency to standardise on single technology platforms. Experience shows that this approach is constricting - not every problem is a nail and not every solution a hammer. We prefer using the right tool for the job and while monolithic applications can take advantage of different languages to a certain extent, it isn’t that common.</p>
<p>中心化治理的结果是标准趋向于单一技术平台。经验表明这种方式是不太好的，通常不是一个方案就能解决掉所有问题。我们更愿意使用合适的工具来做对应的工作，整体应用可以利用不同语言解决某个特定的范围，但是这并不常见。</p>
<p>Splitting the monolith’s components out into services we have a choice when building each of them. You want to use Node.js to standup a simple reports page? Go for it. C++ for a particularly gnarly near-real-time component? Fine. You want to swap in a different flavour of database that better suits the read behaviour of one component? We have the technology to rebuild him.</p>
<p>把整体应用切分成组件化服务的话，我们可以选择啥时候构建每个组件。想用nodejs创建一个简单的表单页？做呗。想用c++弄一个实时处理组件？好啊。你想在不同的数据库支持之间切换，来适应个别组件的读取？我们可以重新构建它。</p>
<p>Of course, just because you can do something, doesn’t mean you should - but partitioning your system in this way means you have the option.</p>
<p>当然，并不是你可以做，你就应该做。只是把你当系统以这种方式拆分后，你可以选择做或者不做。</p>
<p>Teams building microservices prefer a different approach to standards too. Rather than use a set of defined standards written down somewhere on paper they prefer the idea of producing useful tools that other developers can use to solve similar problems to the ones they are facing. These tools are usually harvested from implementations and shared with a wider group, sometimes, but not exclusively using an internal open source model. Now that git and github have become the de facto version control system of choice, open source practices are becoming more and more common in-house .</p>
<p>各个团队构建微服务的方式也不尽相同。他们会设计对生产有用的工具，供其他开发者重用，解决类似的问题，而不是使用一系列定义好的标准写在纸上。这些工具通常从一些实现或者在一个共享组里获得的。现在git和github都成为了版本控制系统，开源的练习也越来越多见。</p>
<p>Netflix is a good example of an organisation that follows this philosophy. Sharing useful and, above all, battle-tested code as libraries encourages other developers to solve similar problems in similar ways yet leaves the door open to picking a different approach if required. Shared libraries tend to be focused on common problems of data storage, inter-process communication and as we discuss further below, infrastructure automation.</p>
<p>netflix是追随这个哲学的代表组织。分享有用的精炼的代码，作为libraries提供给其他的开发者使用，解决类似的问题。共享的libraries会慢慢在数据存储、进程内沟通、基础设置自动化问题上被注意到。</p>
<p>For the microservice community, overheads are particularly unattractive. That isn’t to say that the community doesn’t value service contracts. Quite the opposite, since there tend to be many more of them. It’s just that they are looking at different ways of managing those contracts. Patterns like Tolerant Reader and Consumer-Driven Contracts are often applied to microservices. These aid service contracts in evolving independently. Executing consumer driven contracts as part of your build increases confidence and provides fast feedback on whether your services are functioning. Indeed we know of a team in Australia who drive the build of new services with consumer driven contracts. They use simple tools that allow them to define the contract for a service. This becomes part of the automated build before code for the new service is even written. The service is then built out only to the point where it satisfies the contract - an elegant approach to avoid the ‘YAGNI’[9] dilemma when building new software. These techniques and the tooling growing up around them, limit the need for central contract management by decreasing the temporal coupling between services.</p>
<p>对于微服务社区，一般费用是不太惹人注意的。不是说社区不重视服务规范。正相反，很重视服务规范。只是在各种方式来管理这些规范。诸如 Tolerant Reader和Consumer-Driven的规范模型经常被应用于微服务。这帮助服务规范独立展开。</p>
<p>Perhaps the apogee of decentralised governance is the build it / run it ethos popularised by Amazon. Teams are responsible for all aspects of the software they build including operating the software 24/7. Devolution of this level of responsibility is definitely not the norm but we do see more and more companies pushing responsibility to the development teams. Netflix is another organisation that has adopted this ethos[11]. Being woken up at 3am every night by your pager is certainly a powerful incentive to focus on quality when writing your code. These ideas are about as far away from the traditional centralized governance model as it is possible to be.</p>
<p>获取去中心化治理的至高点是Amazon号召的构建/运行。各种团队也24/7的负责了软件的不同方面。责任的转义肯定不是规范，但是我们看到了越来越多的公司把责任推给了开发团队。netflix是融合了这种号召的另一类组织。你的手机每天教你半夜3点起来肯定一个很牛逼的动力，让你专注于写代码的质量。</p>
<h4 id="Decentralized-Data-Management（数据管理去中心化）"><a href="#Decentralized-Data-Management（数据管理去中心化）" class="headerlink" title="Decentralized Data Management（数据管理去中心化）"></a>Decentralized Data Management（数据管理去中心化）</h4><p>Decentralization of data management presents in a number of different ways. At the most abstract level, it means that the conceptual model of the world will differ between systems. This is a common issue when integrating across a large enterprise, the sales view of a customer will differ from the support view. Some things that are called customers in the sales view may not appear at all in the support view. Those that do may have different attributes and (worse) common attributes with subtly different semantics.</p>
<p>数据管理的去中心化代表着几种不同的方式。最抽象的层次上讲，它表示概念模型在系统之间是不同的。在整个大公司的系统的时候这个问题很常见，销售视图不同于支持视图。有一些customer在销售视图里，而在支持视图没有。还有有不同的属性和相同的属性，但是有不同的语义。</p>
<p>This issue is common between applications, but can also occur within applications, particular when that application is divided into separate components. A useful way of thinking about this is the Domain-Driven Design notion of Bounded Context. DDD divides a complex domain up into multiple bounded contexts and maps out the relationships between them. This process is useful for both monolithic and microservice architectures, but there is a natural correlation between service and context boundaries that helps clarify, and as we describe in the section on business capabilities, reinforce the separations.</p>
<p>这个问题在应用之间是很常见的，在app内部也会发生，尤其是应用拆分成多个component之后。考虑这个一个很好的方式是把它看做bounded contexts的Domain-Driven设计概念。DDD气氛一个复杂的domain到多个bounded contexts，然后映射这些关系。这个过程对整体应用和微服务架构都有用，但是在service和context边界之间有一层自然的关联，这层关联帮助清晰化、加强了分离界限。</p>
<p>As well as decentralizing decisions about conceptual models, microservices also decentralize data storage decisions. While monolithic applications prefer a single logical database for persistant data, enterprises often prefer a single database across a range of applications - many of these decisions driven through vendor’s commercial models around licensing. Microservices prefer letting each service manage its own database, either different instances of the same database technology, or entirely different database systems - an approach called Polyglot Persistence. You can use polyglot persistence in a monolith, but it appears more frequently with microservices.</p>
<p>像概念模型的去中心化一样，微服务也对数据存储方案去中心化。整体应用通常是一个逻辑数据库来持久化数据，企业通常使用一个单独的数据库给多个应用。微服务更原因让每个服务管理自己的数据库，甚至整个数据库系统-Polyglot Persistence。你可以在整体应用中使用Polyglot Persistence，但是它更常见与微服务架构中。</p>
<p><img src="http://martinfowler.com/articles/microservices/images/decentralised-data.png" alt=""></p>
<p>参考：<a href="http://martinfowler.com/articles/microservices.html" target="_blank" rel="external">http://martinfowler.com/articles/microservices.html</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/05/ambari故障记录/" title="ambari故障记录" itemprop="url">ambari故障记录</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-12-05T09:11:36.000Z" itemprop="datePublished"> 发表于 2016-12-05</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><ul>
<li>ambari的metric界面上全都load不出来</li>
<li>hive命令行进不去，通过beeline连接成功，但是执行命令卡住</li>
</ul>
<h5 id="观察ambari-server-log里："><a href="#观察ambari-server-log里：" class="headerlink" title="观察ambari-server.log里："></a>观察ambari-server.log里：</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div></pre></td><td class="code"><pre><div class="line">27 May 2016 06:00:16,468  WARN [C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|229f66ed]-AdminTaskTimer] ThreadPoolAsynchronousRunner:220 - Task com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask@13d18137 (in deadlocked PoolThread) failed to complete in maximum time 60000ms. Trying interrupt().</div><div class="line">27 May 2016 06:00:16,481  WARN [C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|229f66ed]-AdminTaskTimer] ThreadPoolAsynchronousRunner:220 - Task com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask@28fdf8 (in deadlocked PoolThread) failed to complete in maximum time 60000ms. Trying interrupt().</div><div class="line">27 May 2016 06:00:16,481  WARN [C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|229f66ed]-AdminTaskTimer] ThreadPoolAsynchronousRunner:220 - Task com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask@7a7239f6 (in deadlocked PoolThread) failed to complete in maximum time 60000ms. Trying interrupt().</div><div class="line">27 May 2016 06:32:26,157  WARN [C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|74e262f6]-AdminTaskTimer] ThreadPoolAsynchronousRunner:220 - com.mchange.v2.async.ThreadPoolAsynchronousRunner$DeadlockDetector@40bbff68 -- APPARENT DEADLOCK!!! Creating emergency threads for unassigned pending tasks!</div><div class="line">27 May 2016 06:32:26,171  WARN [C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|74e262f6]-AdminTaskTimer] ThreadPoolAsynchronousRunner:220 - com.mchange.v2.async.ThreadPoolAsynchronousRunner$DeadlockDetector@40bbff68 -- APPARENT DEADLOCK!!! Complete Status: </div><div class="line">	Managed Threads: 3</div><div class="line">	Active Threads: 3</div><div class="line">	Active Tasks: </div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask@5383aba6</div><div class="line">			on thread: C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|74e262f6]-HelperThread-#2</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask@38f907f5</div><div class="line">			on thread: C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|74e262f6]-HelperThread-#1</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask@204f2da</div><div class="line">			on thread: C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|74e262f6]-HelperThread-#0</div><div class="line">	Pending Tasks: </div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask@1ddb0d4d</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask@534b5bcb</div><div class="line">Pool thread stack traces:</div><div class="line">	Thread[C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|74e262f6]-HelperThread-#2,5,main]</div><div class="line">		java.net.SocketInputStream.socketRead0(Native Method)</div><div class="line">		java.net.SocketInputStream.socketRead(SocketInputStream.java:116)</div><div class="line">		java.net.SocketInputStream.read(SocketInputStream.java:170)</div><div class="line">		java.net.SocketInputStream.read(SocketInputStream.java:141)</div><div class="line">		com.mysql.jdbc.util.ReadAheadInputStream.fill(ReadAheadInputStream.java:100)</div><div class="line">		com.mysql.jdbc.util.ReadAheadInputStream.readFromUnderlyingStreamIfNecessary(ReadAheadInputStream.java:143)</div><div class="line">		com.mysql.jdbc.util.ReadAheadInputStream.read(ReadAheadInputStream.java:173)</div><div class="line">		com.mysql.jdbc.MysqlIO.readFully(MysqlIO.java:2911)</div><div class="line">		com.mysql.jdbc.MysqlIO.readPacket(MysqlIO.java:559)</div><div class="line">		com.mysql.jdbc.MysqlIO.doHandshake(MysqlIO.java:1013)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.coreConnect(ConnectionImpl.java:2239)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.connectOneTryOnly(ConnectionImpl.java:2270)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.createNewIO(ConnectionImpl.java:2069)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.&lt;init&gt;(ConnectionImpl.java:794)</div><div class="line">		com.mysql.jdbc.JDBC4Connection.&lt;init&gt;(JDBC4Connection.java:44)</div><div class="line">		sun.reflect.GeneratedConstructorAccessor186.newInstance(Unknown Source)</div><div class="line">		sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</div><div class="line">		java.lang.reflect.Constructor.newInstance(Constructor.java:422)</div><div class="line">		com.mysql.jdbc.Util.handleNewInstance(Util.java:389)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.getInstance(ConnectionImpl.java:399)</div><div class="line">		com.mysql.jdbc.NonRegisteringDriver.connect(NonRegisteringDriver.java:325)</div><div class="line">		com.mchange.v2.c3p0.DriverManagerDataSource.getConnection(DriverManagerDataSource.java:175)</div><div class="line">		com.mchange.v2.c3p0.WrapperConnectionPoolDataSource.getPooledConnection(WrapperConnectionPoolDataSource.java:220)</div><div class="line">		com.mchange.v2.c3p0.WrapperConnectionPoolDataSource.getPooledConnection(WrapperConnectionPoolDataSource.java:206)</div><div class="line">		com.mchange.v2.c3p0.impl.C3P0PooledConnectionPool$1PooledConnectionResourcePoolManager.acquireResource(C3P0PooledConnectionPool.java:203)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool.doAcquire(BasicResourcePool.java:1138)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool.doAcquireAndDecrementPendingAcquiresWithinLockOnSuccess(BasicResourcePool.java:1125)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool.access$700(BasicResourcePool.java:44)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask.run(BasicResourcePool.java:1870)</div><div class="line">		com.mchange.v2.async.ThreadPoolAsynchronousRunner$PoolThread.run(ThreadPoolAsynchronousRunner.java:696)</div><div class="line">	Thread[C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|74e262f6]-HelperThread-#1,5,main]</div><div class="line">		java.net.SocketInputStream.socketRead0(Native Method)</div><div class="line">		java.net.SocketInputStream.socketRead(SocketInputStream.java:116)</div><div class="line">		java.net.SocketInputStream.read(SocketInputStream.java:170)</div><div class="line">		java.net.SocketInputStream.read(SocketInputStream.java:141)</div><div class="line">		com.mysql.jdbc.util.ReadAheadInputStream.fill(ReadAheadInputStream.java:100)</div><div class="line">		com.mysql.jdbc.util.ReadAheadInputStream.readFromUnderlyingStreamIfNecessary(ReadAheadInputStream.java:143)</div><div class="line">		com.mysql.jdbc.util.ReadAheadInputStream.read(ReadAheadInputStream.java:173)</div><div class="line">		com.mysql.jdbc.MysqlIO.readFully(MysqlIO.java:2911)</div><div class="line">		com.mysql.jdbc.MysqlIO.readPacket(MysqlIO.java:559)</div><div class="line">		com.mysql.jdbc.MysqlIO.doHandshake(MysqlIO.java:1013)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.coreConnect(ConnectionImpl.java:2239)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.connectOneTryOnly(ConnectionImpl.java:2270)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.createNewIO(ConnectionImpl.java:2069)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.&lt;init&gt;(ConnectionImpl.java:794)</div><div class="line">		com.mysql.jdbc.JDBC4Connection.&lt;init&gt;(JDBC4Connection.java:44)</div><div class="line">		sun.reflect.GeneratedConstructorAccessor186.newInstance(Unknown Source)</div><div class="line">		sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</div><div class="line">		java.lang.reflect.Constructor.newInstance(Constructor.java:422)</div><div class="line">		com.mysql.jdbc.Util.handleNewInstance(Util.java:389)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.getInstance(ConnectionImpl.java:399)</div><div class="line">		com.mysql.jdbc.NonRegisteringDriver.connect(NonRegisteringDriver.java:325)</div><div class="line">		com.mchange.v2.c3p0.DriverManagerDataSource.getConnection(DriverManagerDataSource.java:175)</div><div class="line">		com.mchange.v2.c3p0.WrapperConnectionPoolDataSource.getPooledConnection(WrapperConnectionPoolDataSource.java:220)</div><div class="line">		com.mchange.v2.c3p0.WrapperConnectionPoolDataSource.getPooledConnection(WrapperConnectionPoolDataSource.java:206)</div><div class="line">		com.mchange.v2.c3p0.impl.C3P0PooledConnectionPool$1PooledConnectionResourcePoolManager.acquireResource(C3P0PooledConnectionPool.java:203)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool.doAcquire(BasicResourcePool.java:1138)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool.doAcquireAndDecrementPendingAcquiresWithinLockOnSuccess(BasicResourcePool.java:1125)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool.access$700(BasicResourcePool.java:44)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask.run(BasicResourcePool.java:1870)</div><div class="line">		com.mchange.v2.async.ThreadPoolAsynchronousRunner$PoolThread.run(ThreadPoolAsynchronousRunner.java:696)</div><div class="line">	Thread[C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|74e262f6]-HelperThread-#0,5,main]</div><div class="line">		java.net.SocketInputStream.socketRead0(Native Method)</div><div class="line">		java.net.SocketInputStream.socketRead(SocketInputStream.java:116)</div><div class="line">		java.net.SocketInputStream.read(SocketInputStream.java:170)</div><div class="line">		java.net.SocketInputStream.read(SocketInputStream.java:141)</div><div class="line">		com.mysql.jdbc.util.ReadAheadInputStream.fill(ReadAheadInputStream.java:100)</div><div class="line">		com.mysql.jdbc.util.ReadAheadInputStream.readFromUnderlyingStreamIfNecessary(ReadAheadInputStream.java:143)</div><div class="line">		com.mysql.jdbc.util.ReadAheadInputStream.read(ReadAheadInputStream.java:173)</div><div class="line">		com.mysql.jdbc.MysqlIO.readFully(MysqlIO.java:2911)</div><div class="line">		com.mysql.jdbc.MysqlIO.readPacket(MysqlIO.java:559)</div><div class="line">		com.mysql.jdbc.MysqlIO.doHandshake(MysqlIO.java:1013)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.coreConnect(ConnectionImpl.java:2239)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.connectOneTryOnly(ConnectionImpl.java:2270)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.createNewIO(ConnectionImpl.java:2069)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.&lt;init&gt;(ConnectionImpl.java:794)</div><div class="line">		com.mysql.jdbc.JDBC4Connection.&lt;init&gt;(JDBC4Connection.java:44)</div><div class="line">		sun.reflect.GeneratedConstructorAccessor186.newInstance(Unknown Source)</div><div class="line">		sun.reflect.DelegatingConstructorAccessorImpl.newInstance(DelegatingConstructorAccessorImpl.java:45)</div><div class="line">		java.lang.reflect.Constructor.newInstance(Constructor.java:422)</div><div class="line">		com.mysql.jdbc.Util.handleNewInstance(Util.java:389)</div><div class="line">		com.mysql.jdbc.ConnectionImpl.getInstance(ConnectionImpl.java:399)</div><div class="line">		com.mysql.jdbc.NonRegisteringDriver.connect(NonRegisteringDriver.java:325)</div><div class="line">		com.mchange.v2.c3p0.DriverManagerDataSource.getConnection(DriverManagerDataSource.java:175)</div><div class="line">		com.mchange.v2.c3p0.WrapperConnectionPoolDataSource.getPooledConnection(WrapperConnectionPoolDataSource.java:220)</div><div class="line">		com.mchange.v2.c3p0.WrapperConnectionPoolDataSource.getPooledConnection(WrapperConnectionPoolDataSource.java:206)</div><div class="line">		com.mchange.v2.c3p0.impl.C3P0PooledConnectionPool$1PooledConnectionResourcePoolManager.acquireResource(C3P0PooledConnectionPool.java:203)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool.doAcquire(BasicResourcePool.java:1138)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool.doAcquireAndDecrementPendingAcquiresWithinLockOnSuccess(BasicResourcePool.java:1125)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool.access$700(BasicResourcePool.java:44)</div><div class="line">		com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask.run(BasicResourcePool.java:1870)</div><div class="line">		com.mchange.v2.async.ThreadPoolAsynchronousRunner$PoolThread.run(ThreadPoolAsynchronousRunner.java:696)</div><div class="line">		27 May 2016 06:33:26,173  WARN [C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|74e262f6]-AdminTaskTimer] ThreadPoolAsynchronousRunner:220 - Task com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask@5383aba6 (in deadlocked PoolThread) failed to complete in maximum time 60000ms. Trying interrupt().</div><div class="line">27 May 2016 06:33:26,173  WARN [C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|74e262f6]-AdminTaskTimer] ThreadPoolAsynchronousRunner:220 - Task com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask@38f907f5 (in deadlocked PoolThread) failed to complete in maximum time 60000ms. Trying interrupt().</div><div class="line">27 May 2016 06:33:26,174  WARN [C3P0PooledConnectionPoolManager[identityToken-&gt;2rvy2w9g1rvd7t51qlbfjd|74e262f6]-AdminTaskTimer] ThreadPoolAsynchronousRunner:220 - Task com.mchange.v2.resourcepool.BasicResourcePool$ScatteredAcquireTask@204f2da (in deadlocked PoolThread) failed to complete in maximum time 60000ms. Trying interrupt().</div></pre></td></tr></table></figure>
<p>尝试重启后，log如下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">27 May 2016 10:24:07,167  INFO [main] Configuration:791 - Reading password from existing file</div><div class="line">27 May 2016 10:24:07,197  INFO [main] Configuration:1128 - Hosts Mapping File null</div><div class="line">27 May 2016 10:24:07,197  INFO [main] HostsMap:60 - Using hostsmap file null</div><div class="line">27 May 2016 10:24:08,493  INFO [main] ControllerModule:195 - Detected MYSQL as the database type from the JDBC URL</div><div class="line">27 May 2016 10:24:08,522  INFO [main] ControllerModule:237 - Using c3p0 ComboPooledDataSource as the EclipsLink DataSource</div><div class="line">27 May 2016 10:24:08,582  INFO [MLog-Init-Reporter] MLog:212 - MLog clients using slf4j logging.</div><div class="line">27 May 2016 10:24:08,963  INFO [main] C3P0Registry:212 - Initializing c3p0-0.9.5.2 [built 08-December-2015 22:06:04 -0800; debug? true; trace: 10]</div><div class="line">27 May 2016 10:24:11,656  INFO [main] ControllerModule:596 - Binding and registering notification dispatcher class org.apache.ambari.server.notifications.dispatchers.SNMPDispatcher</div><div class="line">27 May 2016 10:24:11,665  INFO [main] ControllerModule:596 - Binding and registering notification dispatcher class org.apache.ambari.server.notifications.dispatchers.AlertScriptDispatcher</div></pre></td></tr></table></figure></p>
<p>想了一下会不会是mysql的问题，然后就尝试连接一下mysql —— 端口通，但是连接不上。找运维看了一下，mysql所在的机器的cpu爆满，有一个线程给打满了。</p>
<p>运维重启了，昨天集群跑任务的时候也是资源没有变，但是cpu被打满，以往同样的资源根本不会耗时那么多。个人怀疑是被人攻击了。</p>
<p>hive meta库重启之后，通过beeline是可以成功连接hive并查询的。但是hive命令行还是进不去，卡在:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[hive@datanode01 root]$ hive</div><div class="line">WARNING: Use &quot;yarn jar&quot; to launch YARN applications.</div><div class="line"></div><div class="line">Logging initialized using configuration in file:/etc/hive/2.4.2.0-258/0/hive-log4j.properties</div></pre></td></tr></table></figure></p>
<p>查看hive的log:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">2016-05-27 11:33:14,153 INFO  [main]: SessionState (SessionState.java:printInfo(953)) - </div><div class="line">Logging initialized using configuration in file:/etc/hive/2.4.2.0-258/0/hive-log4j.properties</div><div class="line">2016-05-27 11:33:14,653 INFO  [main]: hive.metastore (HiveMetaStoreClient.java:open(382)) - Trying to connect to metastore with URI thrift://datanode03.will.com:9083</div><div class="line">2016-05-27 11:33:14,736 INFO  [main]: hive.metastore (HiveMetaStoreClient.java:open(478)) - Connected to metastore.</div></pre></td></tr></table></figure></p>
<p>正常命令行log：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">2016-05-19 10:40:59,299 INFO  [main]: SessionState (SessionState.java:printInfo(953)) -</div><div class="line">Logging initialized using configuration in file:/etc/hive/2.4.2.0-258/0/hive-log4j.properties</div><div class="line">2016-05-19 10:41:00,519 INFO  [main]: hive.metastore (HiveMetaStoreClient.java:open(382)) - Trying to connect to metastore with URI thrift://datanode03.will.com:9083</div><div class="line">2016-05-19 10:41:01,125 INFO  [main]: hive.metastore (HiveMetaStoreClient.java:open(478)) - Connected to metastore.</div><div class="line">2016-05-19 10:41:04,652 INFO  [main]: session.SessionState (SessionState.java:createPath(633)) - Created local directory: /tmp/1d1a2120-6339-40c1-b63b-5dbd4dc71074_resources</div><div class="line">2016-05-19 10:41:04,664 INFO  [main]: session.SessionState (SessionState.java:createPath(633)) - Created HDFS directory: /tmp/hive/hive/1d1a2120-6339-40c1-b63b-5dbd4dc71074</div><div class="line">2016-05-19 10:41:04,666 INFO  [main]: session.SessionState (SessionState.java:createPath(633)) - Created local directory: /tmp/hive/1d1a2120-6339-40c1-b63b-5dbd4dc71074</div><div class="line">2016-05-19 10:41:04,669 INFO  [main]: session.SessionState (SessionState.java:createPath(633)) - Created HDFS directory: /tmp/hive/hive/1d1a2120-6339-40c1-b63b-5dbd4dc71074/_tmp_space.db</div><div class="line">2016-05-19 10:41:04,717 INFO  [main]: sqlstd.SQLStdHiveAccessController (SQLStdHiveAccessController.java:&lt;init&gt;(95)) - Created SQLStdHiveAccessController for session context : HiveAuthzSessionContext [sessionString=1d1a2120-6339-40c1-b63b-5dbd4dc71074, clientType=HIVECLI]</div><div class="line">2016-05-19 10:41:04,720 INFO  [main]: hive.metastore (HiveMetaStoreClient.java:isCompatibleWith(296)) - Mestastore configuration hive.metastore.filter.hook changed from org.apache.hadoop.hive.metastore.DefaultMetaStoreFilterHookImpl to org.apache.hadoop.hive.ql.security.authorization.plugin.AuthorizationMetaStoreFilterHook</div><div class="line">2016-05-19 11:21:13,947 INFO  [main]: hive.metastore (HiveMetaStoreClient.java:open(382)) - Trying to connect to metastore with URI thrift://datanode03.will.com:9083</div><div class="line">2016-05-19 11:21:13,951 INFO  [main]: hive.metastore (HiveMetaStoreClient.java:open(478)) - Connected to metastore.</div><div class="line">2016-05-19 11:21:14,674 INFO  [main]: SessionState (SessionState.java:printInfo(953)) - Added [/server/app/hive/will_hive_udf.jar] to class path</div><div class="line">2016-05-19 11:21:14,674 INFO  [main]: SessionState (SessionState.java:printInfo(953)) - Added resources: [/server/app/hive/will_hive_udf.jar]</div><div class="line">2016-05-19 11:21:14,858 INFO  [main]: log.PerfLogger (PerfLogger.java:PerfLogBegin(135)) - &lt;PERFLOG method=Driver.run from=org.apache.hadoop.hive.ql.Driver&gt;</div><div class="line">2016-05-19 11:21:14,858 INFO  [main]: log.PerfLogger (PerfLogger.java:PerfLogBegin(135)) - &lt;PERFLOG method=TimeToSubmit from=org.apache.hadoop.hive.ql.Driver&gt;</div><div class="line">2016-05-19 11:21:14,858 INFO  [main]: log.PerfLogger (PerfLogger.java:PerfLogBegin(135)) - &lt;PERFLOG method=compile from=org.apache.hadoop.hive.ql.Driver&gt;</div><div class="line">2016-05-19 11:21:14,923 INFO  [main]: ql.Driver (Driver.java:compile(420)) - We are setting the hadoop caller context from  to hive_20160519112114_e4649b5a-c094-40ff-a9b1-aa6ab595c967</div><div class="line">2016-05-19 11:21:14,928 INFO  [main]: log.PerfLogger (PerfLogger.java:PerfLogBegin(135)) - &lt;PERFLOG method=parse from=org.apache.hadoop.hive.ql.Driver&gt;</div><div class="line">2016-05-19 11:21:14,937 INFO  [main]: parse.ParseDriver (ParseDriver.java:parse(185)) - Parsing command: </div><div class="line">create temporary function  strstart as &apos;com.will.common.hive.StrStart&apos;</div><div class="line">2016-05-19 11:21:16,408 INFO  [main]: parse.ParseDriver (ParseDriver.java:parse(209)) - Parse Completed</div><div class="line">2016-05-19 11:21:16,411 INFO  [main]: log.PerfLogger (PerfLogger.java:PerfLogEnd(162)) - &lt;/PERFLOG method=parse start=1463628074928 end=1463628076411 duration=1483 from=org.apache.hadoop.hi</div><div class="line">ve.ql.Driver&gt;</div><div class="line">2016-05-19 11:21:16,412 INFO  [main]: log.PerfLogger (PerfLogger.java:PerfLogBegin(135)) - &lt;PERFLOG method=semanticAnalyze from=org.apache.hadoop.hive.ql.Driver&gt;</div><div class="line">2016-05-19 11:21:17,249 INFO  [main]: parse.FunctionSemanticAnalyzer (FunctionSemanticAnalyzer.java:analyzeInternal(66)) - analyze done</div><div class="line">2016-05-19 11:21:17,249 INFO  [main]: ql.Driver (Driver.java:compile(471)) - Semantic Analysis Completed</div></pre></td></tr></table></figure></p>
<p>可以看到是createPath那卡住了，建立临时会话相关文件。同事那边要得急，就直接把hive metastore重启了，就恢复正常了。<br>这样看来如果hive metastore和mysql meta库失去连接的话，即便mysql恢复正常，启动hive命令行的时候，HiveMetaStoreClient也会有问题。</p>
<p><strong>这个可以修复一下，然后commit给hive官网。。。</strong></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/14/"><span></span>Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/13/">13</a><a class="page-number" href="/page/14/">14</a><span class="page-number current">15</span><a class="page-number" href="/page/16/">16</a><a class="page-number" href="/page/17/">17</a><span class="space">&hellip;</span><a class="page-number" href="/page/25/">25</a><a class="extend next" rel="next" href="/page/16/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  

  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/youdaonote/" title="youdaonote">youdaonote<sup>187</sup></a></li>
			
		
			
				<li><a href="/tags/源码/" title="源码">源码<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/akka/" title="akka">akka<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/flume/" title="flume">flume<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/ETL/" title="ETL">ETL<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/solr/" title="solr">solr<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/spring/" title="spring">spring<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/调度平台/" title="调度平台">调度平台<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/azkaban/" title="azkaban">azkaban<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/mysql/" title="mysql">mysql<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/scala/" title="scala">scala<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/ambari/" title="ambari">ambari<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/quartz/" title="quartz">quartz<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/django/" title="django">django<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/架构/" title="架构">架构<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/架构，jaeger/" title="架构，jaeger">架构，jaeger<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ember/" title="ember">ember<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/nodejs/" title="nodejs">nodejs<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/R/" title="R">R<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/guava/" title="guava">guava<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://github.com/willcup" target="_blank" title=" 我自己的github">github</a>
            
          </li>
        
          <li>
            
            	<a href="http://thisding.com" target="_blank" title="朋友的主页">Steven&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Will Chen in MeiTuan. <br/>
			元 亨 利 贞.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:chenxin15@meituan.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2018 
		
		<a href="/about" target="_blank" title="Will Chen">Will Chen</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fe6d1f421bbc9962127a50488f9ed37d1' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
