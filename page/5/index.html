
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <script type="text/javascript">
    (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
    })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
    
    _st('install','yNiKTKaAnwd1uuxVMfiE','2.0.0');
  </script>
  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?5b99dfd487346155d274c0c49c3fb869";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
  </script>

  
    <title>Will&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Will Chen">
    

    
    <meta name="description" content="左右水色 右手天光">
<meta property="og:type" content="website">
<meta property="og:title" content="Will's Blog">
<meta property="og:url" content="https://runningdata.github.io/page/5/index.html">
<meta property="og:site_name" content="Will's Blog">
<meta property="og:description" content="左右水色 右手天光">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Will's Blog">
<meta name="twitter:description" content="左右水色 右手天光">

    
    <link rel="alternative" href="/atom.xml" title="Will&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Will&#39;s Blog" title="Will&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Will&#39;s Blog">Will&#39;s Blog</a></h1>
				<h2 class="blog-motto">简易 变易 不易</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
                                                <form class="search" action="/search/index.html" method="get" accept-charset="utf-8" target="_blank">
                                                        <label>搜索</label>
                                                <input name="s" type="hidden" value= null ><input type="text" class="st-default-search-input" name="q" size="30" placeholder="搜索"><br>
                                                </form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/11/06/iptables端口转发/" title="iptables端口转发" itemprop="url">iptables端口转发</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2017-11-06T09:25:53.000Z" itemprop="datePublished"> 发表于 2017-11-06</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>先放一张iptables的处理流程图</p>
<p><img src="http://xstarcd.github.io/wiki/img/iptables_netfilter_chains.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"># 在PREROUTING中添加转发规则:把从eth0网卡进来的1234端口的访问，定向到10.103.27.171:2224。</div><div class="line">iptables -t nat -A PREROUTING -p tcp -i eth0 --dport 1234 -j DNAT --to 10.103.27.171:2224</div><div class="line"></div><div class="line"></div><div class="line"># j后面是操作，masquerade的意思是伪装</div><div class="line">iptables -t nat -A POSTROUTING -j MASQUERADE</div><div class="line"></div><div class="line"># 保存并重启</div><div class="line">service iptables save</div><div class="line">service iptables restart</div></pre></td></tr></table></figure>
<p>查看iptables的nat表相关配置<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">[root@node83 nginxserver_new]# iptables -t nat -L -vn</div><div class="line">Chain PREROUTING (policy ACCEPT 12 packets, 650 bytes)</div><div class="line"> pkts bytes target     prot opt in     out     source               destination         </div><div class="line">    0     0 DNAT       tcp  --  *      *       0.0.0.0/0            60.1.1.1            tcp dpt:80 to:10.103.70.27:2224 </div><div class="line">   16  2578 DNAT       tcp  --  *      *       0.0.0.0/0            10.103.27.171       tcp dpt:80 to:10.103.70.27:2224 </div><div class="line">   10   520 DNAT       tcp  --  *      *       0.0.0.0/0            10.103.27.171       tcp dpt:1234 to:10.103.70.27:2224 </div><div class="line">    0     0 DNAT       tcp  --  eth0   *       0.0.0.0/0            0.0.0.0/0           tcp dpt:1234 to:10.103.27.171:2224 </div><div class="line"></div><div class="line">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt in     out     source               destination         </div><div class="line">   69  5738 MASQUERADE  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT 43 packets, 2640 bytes)</div><div class="line"> pkts bytes target     prot opt in     out     source               destination</div><div class="line"></div><div class="line"># 删除nat表第4个规则</div><div class="line">[root@node83 nginxserver_new]# iptables -t nat -D PREROUTING 4</div><div class="line"># 再看一下规则</div><div class="line">[root@node83 nginxserver_new]# iptables -t nat -L -vn</div><div class="line">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt in     out     source               destination         </div><div class="line">    0     0 DNAT       tcp  --  *      *       0.0.0.0/0            60.1.1.1            tcp dpt:80 to:10.103.70.27:2224 </div><div class="line">  130  8506 DNAT       tcp  --  *      *       0.0.0.0/0            10.103.27.171       tcp dpt:80 to:10.103.70.27:2224 </div><div class="line">   10   520 DNAT       tcp  --  *      *       0.0.0.0/0            10.103.27.171       tcp dpt:1234 to:10.103.70.27:2224 </div><div class="line"></div><div class="line">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt in     out     source               destination         </div><div class="line">  394 24326 MASQUERADE  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT 2 packets, 120 bytes)</div><div class="line"> pkts bytes target     prot opt in     out     source               destination         </div><div class="line"># 清空NAT表中PREROUTTING的规则</div><div class="line">[root@node83 nginxserver_new]# iptables -t nat -F PREROUTING </div><div class="line"># 再看一下规则</div><div class="line">[root@node83 nginxserver_new]# iptables -t nat -L -vn</div><div class="line">Chain PREROUTING (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt in     out     source               destination         </div><div class="line"></div><div class="line">Chain POSTROUTING (policy ACCEPT 0 packets, 0 bytes)</div><div class="line"> pkts bytes target     prot opt in     out     source               destination         </div><div class="line">  420 25806 MASQUERADE  all  --  *      *       0.0.0.0/0            0.0.0.0/0           </div><div class="line"></div><div class="line">Chain OUTPUT (policy ACCEPT 2 packets, 120 bytes)</div><div class="line"> pkts bytes target     prot opt in     out     source               destination</div></pre></td></tr></table></figure></p>
<p>参考：</p>
<ul>
<li><a href="http://xstarcd.github.io/wiki/Linux/iptables_forward_internetshare.html" target="_blank" rel="external">http://xstarcd.github.io/wiki/Linux/iptables_forward_internetshare.html</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/11/02/kudu简介/" title="kudu简介" itemprop="url">kudu简介</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2017-11-02T07:54:09.000Z" itemprop="datePublished"> 发表于 2017-11-02</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>为apache hadoop平台开发的列式存储管理器。kudo拥有hadoop生态的很多特性：廉价硬件、水平扩展、高可用。</p>
<h5 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h5><ul>
<li>HDFS可以快速追加和查询，尤其是顺序扫描，如果能和parquet结合就可以有更好的表现。</li>
<li>hbase擅长处理易变的数据，快速查询和写单条数据。</li>
</ul>
<p>kudu介于两者之间。</p>
<p>kudu结合了parquet和hbase的特性，创建了一个本地列式存储的系统。</p>
<p>kudu特性:</p>
<ul>
<li>动态管理分区，动态创建明天的分区，删除100天前的分区</li>
<li>删除指定range的数据</li>
<li>支持kerberos认证，内部的task也使用kerberos给的token进行内部验证</li>
<li>server之间、server和client之间TLS加密处理，不影响框架处理速度。如果都在本机，就不用走这个</li>
<li>三种访问角色：client、admin、service[给daemon使用的]。也有白名单之类</li>
<li>ksck工具链接到master查看整体状态</li>
<li>rack aware</li>
</ul>
<ul>
<li>严格结构化数据，不支持blob</li>
<li>多语言API</li>
<li>与spark和impala整合好的API</li>
<li>所有table都被分区，每个分区叫做tablet，每个tablet有多个备份，使用raft达成最终一致，<strong>都存在本地磁盘</strong>，并不基于HDFS。HDFS的机制不能支持分布式存储，不能快速处理failover，还有内存部分快速访问的设计，这里有些像kafka的思想。</li>
<li>metadata，把所有的metadata放在内存中，以便快速访问或处理</li>
<li>spark、impala、MR、flume、drill整合</li>
</ul>
<h2 id="给spark带来啥"><a href="#给spark带来啥" class="headerlink" title="给spark带来啥"></a>给spark带来啥</h2><ul>
<li>像parquet的性能，而且insert和update都无延迟</li>
<li>pushdown predicate filter，更快更高效的扫描</li>
<li>相比parquet还有主键索引</li>
<li>在master中metadata的查找，精准找到目标partition</li>
</ul>
<h5 id="针对spark的优化"><a href="#针对spark的优化" class="headerlink" title="针对spark的优化"></a>针对spark的优化</h5><ul>
<li>只读取有关的字段</li>
<li>自动将where转化为kudu predicate</li>
<li>kudu predicate自动转化为主键扫描等</li>
</ul>
<h5 id="最佳实践"><a href="#最佳实践" class="headerlink" title="最佳实践"></a>最佳实践</h5><p>可以在spark中注册临时表，然后针对临时表执行kudu查询的操作。</p>
<h5 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h5><p>如果查询的数据在内存，那么kudu比parquet快，否则差不多会比parquet慢一倍。单条数据处理，虽然比较快了，但还是会比phenix慢很多。</p>
<h5 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h5><ul>
<li>顺序或随机的读写</li>
<li><p>最小化数据延迟</p>
</li>
<li><p>时间序列数据</p>
</li>
<li>实时报表/实时数据仓库(ODS)</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=NEg1nn9UyBY" target="_blank" rel="external">https://www.youtube.com/watch?v=NEg1nn9UyBY</a></li>
<li><a href="https://www.youtube.com/watch?v=CLP6jHs2z14" target="_blank" rel="external">https://www.youtube.com/watch?v=CLP6jHs2z14</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/11/02/ambari源码解析-告警问题/" title="ambari源码解析-告警问题" itemprop="url">ambari源码解析-告警问题</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2017-11-02T03:34:39.000Z" itemprop="datePublished"> 发表于 2017-11-02</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>按照官网部署了一个简单的notice target脚本，就是把所有的脚本参数都输出到一个临时文件，然后发现虽然ambari server的web页面中有一大堆alert，但是实际触发alert_notice的很少，而且与web页面中看到的alert定义的check interval严重不符。到ambari-server的log里也没有找到heartbeat的连续信息之类。。。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">echo $* &gt;&gt; /tmp/ambari_alerts</div></pre></td></tr></table></figure></p>
<p>回顾一下上面的代码: 只有接收到AlertStateChangeEvent才会触发持久化到alert_notice表，也就是说只针对alert有状态变更才发送notice。尼玛，那如果报了一次之后，后面一直没有收到新的相关notice的话，就默认它是原状？？？ 细想好像这样也对，可以省掉最新。可是并不符合我们最初设想的持续告警。</p>
<p>另外还有一个问题，就是脚本参数里并不包含对应的host信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">datanode_heap_usage DataNode Heap Usage HDFS WARNING Used Heap:[81%, 1633.3276 MB], Max Heap: 2028.0 MB</div><div class="line">datanode_heap_usage DataNode Heap Usage HDFS OK Used Heap:[78%, 1587.691 MB], Max Heap: 2028.0 MB</div><div class="line">datanode_heap_usage DataNode Heap Usage HDFS WARNING Used Heap:[80%, 1623.7538 MB], Max Heap: 2028.0 MB</div><div class="line">datanode_heap_usage DataNode Heap Usage HDFS OK Used Heap:[78%, 1584.6304 MB], Max Heap: 2028.0 MB</div><div class="line">datanode_heap_usage DataNode Heap Usage HDFS OK Used Heap:[78%, 1577.2762 MB], Max Heap: 2028.0 MB</div><div class="line">datanode_heap_usage DataNode Heap Usage HDFS WARNING Used Heap:[81%, 1650.835 MB], Max Heap: 2028.0 MB</div></pre></td></tr></table></figure></p>
<p>看来需要一系列的代码改造才能完全满足我们的需求，就是每次收到heartbeat中的alert信息之后，根据优先级进行过滤，这个优先级最好是读取配置文件的。然后把所有的alert都持久化到alert_notice表中。如果要兼容官网原生的话，就在AlertReceivedListener的onAlertEvent的修改中加入一个option，比如1代表使用官网的notice，2代表使用自定义的notice，这个option可以是全局的，也可以是附属在alert_definition里的【后者需要修改alert_definition, 动作偏大，而且一般环境中只有一种告警方式就够了】。</p>
<p>写点儿伪代码，体会一下，先修改AlertReceivedListener.onAlertEvent。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">....</div><div class="line"><span class="keyword">for</span> (Map.Entry&lt;Alert, AlertCurrentEntity&gt; entry : toCreateHistoryAndMerge.entrySet()) &#123;</div><div class="line">  Alert alert = entry.getKey();</div><div class="line">  AlertCurrentEntity entity = entry.getValue();</div><div class="line">  Long clusterId = getClusterIdByName(alert.getCluster());</div><div class="line"></div><div class="line">  <span class="keyword">boolean</span> fire = <span class="keyword">false</span>;</div><div class="line">  <span class="keyword">if</span>(m_configuration.getCustom_alert() &amp;&amp; alert.getState() == AlertState.CRITICAL) &#123;</div><div class="line">    fire = <span class="keyword">true</span>;</div><div class="line">  &#125; <span class="keyword">else</span> &#123;</div><div class="line">    <span class="keyword">if</span> (clusterId == <span class="keyword">null</span>) &#123;</div><div class="line">      <span class="comment">//super rare case, cluster was removed after isValid() check</span></div><div class="line">      LOG.error(<span class="string">"Unable to process alert &#123;&#125; for an invalid cluster named &#123;&#125;"</span>,</div><div class="line">              alert.getName(), alert.getCluster());</div><div class="line">      <span class="keyword">continue</span>;</div><div class="line">    &#125;</div><div class="line">    fire = <span class="keyword">true</span>;</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">if</span> (fire) &#123;</div><div class="line">    AlertStateChangeEvent alertChangedEvent = <span class="keyword">new</span> AlertStateChangeEvent(clusterId, alert, entity,</div><div class="line">            oldStates.get(alert));</div><div class="line"></div><div class="line">    m_alertEventPublisher.publish(alertChangedEvent);</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>其实按照编程命名规范，如果是所有的alert都要按照级别过滤后发送的话，最好自定义一种类型的event，然后再添加一个对应的eventListener。</p>
<p>鉴于上面提到的没有host信息，也要host加到dispatcher的参数中。我们整一下AlertScriptDispatcher, 发现他的接口参数AlertNotification中是包含hostname的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">ProcessBuilder getProcessBuilder(String script, AlertNotification notification) &#123;</div><div class="line">    final String shellCommand;</div><div class="line">    final String shellCommandOption;</div><div class="line">    if (SystemUtils.IS_OS_WINDOWS) &#123;</div><div class="line">      shellCommand = &quot;cmd&quot;;</div><div class="line">      shellCommandOption = &quot;/c&quot;;</div><div class="line">    &#125; else &#123;</div><div class="line">      shellCommand = &quot;sh&quot;;</div><div class="line">      shellCommandOption = &quot;-c&quot;;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    AlertInfo alertInfo = notification.getAlertInfo();</div><div class="line">    AlertDefinitionEntity definition = alertInfo.getAlertDefinition();</div><div class="line">    String definitionName = definition.getDefinitionName();</div><div class="line">    AlertState alertState = alertInfo.getAlertState();</div><div class="line">    String serviceName = alertInfo.getServiceName();</div><div class="line">    // 这里</div><div class="line">    String hostname = alertInfo.getHostName();</div><div class="line"></div><div class="line">    // these could have spaces in them, so quote them so they don&apos;t mess up the</div><div class="line">    // command line</div><div class="line">    String alertLabel = &quot;\&quot;&quot; + SHELL_ESCAPE.escape(definition.getLabel()) + &quot;\&quot;&quot;;</div><div class="line">    String alertText = &quot;\&quot;&quot; + SHELL_ESCAPE.escape(alertInfo.getAlertText()) + &quot;\&quot;&quot;;</div><div class="line"></div><div class="line">    // 构建的参数里也加上</div><div class="line">    Object[] params = new Object[] &#123; script, definitionName, alertLabel, serviceName, hostname,</div><div class="line">        alertState.name(), alertText &#125;;</div><div class="line"></div><div class="line">    String foo = StringUtils.join(params, &quot; &quot;);</div><div class="line"></div><div class="line">    // sh -c &apos;/foo/sys_logger.py ambari_server_agent_heartbeat &quot;Agent Heartbeat&quot;</div><div class="line">    // AMBARI CRITICAL &quot;Something went wrong with the host&quot;&apos;</div><div class="line">    return new ProcessBuilder(shellCommand, shellCommandOption, foo);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>至此，改造完成。构建完成后，发布到ambari-server的对应位置，重启就可以了。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/10/31/ambari源码解析-告警流程/" title="ambari源码解析-告警流程" itemprop="url">ambari源码解析-告警流程</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2017-10-31T11:23:25.000Z" itemprop="datePublished"> 发表于 2017-10-31</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>从ambari的包找起，找到一个alert的package，下面有一个类StaleAlertRunnable，看一下注释：。那么谁调用它呢？AmbariServerAlertService，与它在同一个目录的还有一个名字很显眼的类AlertNoticeDispatchService。</p>
<p>它是用来扫描表<code>alert_notice</code>中状态为pending的记录，并调用各种dispatcher执行告警分发的。那么谁把notice放进这个表里的呢？没有追踪到。</p>
<p>不过我们发现它继承自guava的<code>AbstractScheduledService</code>类，那么就搜一下这个类的使用，发现在ControllerModule里出现，而ControllerModule是出现在AmbariServer.main之中的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Injector injector = Guice.createInjector(<span class="keyword">new</span> ControllerModule());</div></pre></td></tr></table></figure>
<p>使用工具guice执行了ControllerModule中的依赖注入工作。我们知道Guice.createInjector接收<code>AbstractModule</code>接口的类，一般我们需要实现<code>AbstractModule</code>接口的<code>configure</code>方法。然后在<code>configure</code>方法中将依赖的接口与其具体实现进行绑定，也就是执行<code>bind(xxx.class).to(xxx.class)</code>等工作。下面我们就看一下ControllerModule()做了哪些依赖注入声明的工作。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div></pre></td><td class="code"><pre><div class="line">protected void configure() &#123;</div><div class="line">    // 各种工厂接口与其实现类的绑定</div><div class="line">    installFactories();</div><div class="line"></div><div class="line"></div><div class="line">    // 绑定session相关manager到具体实例</div><div class="line">    final SessionIdManager sessionIdManager = new HashSessionIdManager();</div><div class="line">    final SessionManager sessionManager = new HashSessionManager();</div><div class="line">    sessionManager.getSessionCookieConfig().setPath(&quot;/&quot;);</div><div class="line">    sessionManager.setSessionIdManager(sessionIdManager);</div><div class="line">    bind(SessionManager.class).toInstance(sessionManager);</div><div class="line">    bind(SessionIdManager.class).toInstance(sessionIdManager);</div><div class="line"></div><div class="line">    // kerberos相关</div><div class="line">    bind(KerberosOperationHandlerFactory.class);</div><div class="line">    bind(KerberosDescriptorFactory.class);</div><div class="line">    bind(KerberosServiceDescriptorFactory.class);</div><div class="line">    bind(KerberosHelper.class).to(KerberosHelperImpl.class);</div><div class="line"></div><div class="line">    bind(CredentialStoreService.class).to(CredentialStoreServiceImpl.class);</div><div class="line"></div><div class="line">    bind(Configuration.class).toInstance(configuration);</div><div class="line">    bind(OsFamily.class).toInstance(os_family);</div><div class="line">    bind(HostsMap.class).toInstance(hostsMap);</div><div class="line">    bind(PasswordEncoder.class).toInstance(new StandardPasswordEncoder());</div><div class="line">    bind(DelegatingFilterProxy.class).toInstance(new DelegatingFilterProxy() &#123;</div><div class="line">      &#123;</div><div class="line">        setTargetBeanName(&quot;springSecurityFilterChain&quot;);</div><div class="line">      &#125;</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    bind(Gson.class).annotatedWith(Names.named(&quot;prettyGson&quot;)).toInstance(prettyGson);</div><div class="line">    </div><div class="line">    // jpa持久化相关</div><div class="line">    install(buildJpaPersistModule());</div><div class="line"></div><div class="line">    bind(Gson.class).in(Scopes.SINGLETON);</div><div class="line">    bind(SecureRandom.class).in(Scopes.SINGLETON);</div><div class="line"></div><div class="line">    bind(Clusters.class).to(ClustersImpl.class);</div><div class="line">    bind(AmbariCustomCommandExecutionHelper.class);</div><div class="line">    bind(ActionDBAccessor.class).to(ActionDBAccessorImpl.class);</div><div class="line">    bindConstant().annotatedWith(Names.named(&quot;schedulerSleeptime&quot;)).to(</div><div class="line">      configuration.getExecutionSchedulerWait());</div><div class="line"></div><div class="line">    // This time is added to summary timeout time of all tasks in stage</div><div class="line">    // So it&apos;s an &quot;additional time&quot;, given to stage to finish execution before</div><div class="line">    // it is considered as timed out</div><div class="line">    bindConstant().annotatedWith(Names.named(&quot;actionTimeout&quot;)).to(600000L);</div><div class="line"></div><div class="line">    bindConstant().annotatedWith(Names.named(&quot;dbInitNeeded&quot;)).to(dbInitNeeded);</div><div class="line">    bindConstant().annotatedWith(Names.named(&quot;statusCheckInterval&quot;)).to(5000L);</div><div class="line"></div><div class="line">    //ExecutionCommands cache size</div><div class="line"></div><div class="line">    bindConstant().annotatedWith(Names.named(&quot;executionCommandCacheSize&quot;)).</div><div class="line">        to(configuration.getExecutionCommandsCacheSize());</div><div class="line"></div><div class="line"></div><div class="line">    // Host role commands status summary max cache enable/disable</div><div class="line">    bindConstant().annotatedWith(Names.named(HostRoleCommandDAO.HRC_STATUS_SUMMARY_CACHE_ENABLED)).</div><div class="line">      to(configuration.getHostRoleCommandStatusSummaryCacheEnabled());</div><div class="line"></div><div class="line">    // Host role commands status summary max cache size</div><div class="line">    bindConstant().annotatedWith(Names.named(HostRoleCommandDAO.HRC_STATUS_SUMMARY_CACHE_SIZE)).</div><div class="line">      to(configuration.getHostRoleCommandStatusSummaryCacheSize());</div><div class="line">    // Host role command status summary cache expiry duration in minutes</div><div class="line">    bindConstant().annotatedWith(Names.named(HostRoleCommandDAO.HRC_STATUS_SUMMARY_CACHE_EXPIRY_DURATION_MINUTES)).</div><div class="line">      to(configuration.getHostRoleCommandStatusSummaryCacheExpiryDuration());</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">    bind(AmbariManagementController.class).to(</div><div class="line">      AmbariManagementControllerImpl.class);</div><div class="line">    bind(AbstractRootServiceResponseFactory.class).to(RootServiceResponseFactory.class);</div><div class="line">    bind(ExecutionScheduler.class).to(ExecutionSchedulerImpl.class);</div><div class="line">    bind(DBAccessor.class).to(DBAccessorImpl.class);</div><div class="line">    bind(ViewInstanceHandlerList.class).to(AmbariHandlerList.class);</div><div class="line">    bind(TimelineMetricCacheProvider.class);</div><div class="line">    bind(TimelineMetricCacheEntryFactory.class);</div><div class="line">    bind(SecurityConfigurationFactory.class).in(Scopes.SINGLETON);</div><div class="line"></div><div class="line">    bind(PersistedState.class).to(PersistedStateImpl.class);</div><div class="line"></div><div class="line">    requestStaticInjection(ExecutionCommandWrapper.class);</div><div class="line">    requestStaticInjection(DatabaseChecker.class);</div><div class="line">    requestStaticInjection(KerberosChecker.class);</div><div class="line">    </div><div class="line">    // 这里是ControllerModule自定义的一个方法，根据注解执行绑定工作</div><div class="line">    bindByAnnotation(null);</div><div class="line">    </div><div class="line">    // 这里是我们关心的dispatcher相关绑定</div><div class="line">    bindNotificationDispatchers();</div><div class="line">    registerUpgradeChecks();</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>我们发现serviceManager就在这个类中出现。它的说明是为需要注入的带有某种注解的接口提供初始化工作。典型应用一：是用来处理一些没有入口的单例，换种表达方式，就是那些没有被任何接口依赖注入，但是仍然被整体的guice框架需要的类。典型应用二：某些类需要注入静态static成员的时候。传入的参数beanDefinitions为空的时候，会默认扫描带有注解<code>EagerSingleton</code>,<code>StaticallyInject</code>,<code>AmbariService</code>的类。这三个注解都是ambari自定义的。我们看到上面调用这个方法的时候传入参数是null。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> Set&lt;BeanDefinition&gt; <span class="title">bindByAnnotation</span><span class="params">(Set&lt;BeanDefinition&gt; beanDefinitions)</span> </span>&#123;</div><div class="line">    List&lt;Class&lt;? extends Annotation&gt;&gt; classes = Arrays.asList(</div><div class="line">        EagerSingleton.class, StaticallyInject.class, AmbariService.class);</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == beanDefinitions || beanDefinitions.size() == <span class="number">0</span>) &#123;</div><div class="line">      ClassPathScanningCandidateComponentProvider scanner =</div><div class="line">          <span class="keyword">new</span> ClassPathScanningCandidateComponentProvider(<span class="keyword">false</span>);</div><div class="line"></div><div class="line">      <span class="comment">// match only singletons that are eager listeners</span></div><div class="line">      <span class="comment">// 为scanner加入目标注解过滤器</span></div><div class="line">      <span class="keyword">for</span> (Class&lt;? extends Annotation&gt; cls : classes) &#123;</div><div class="line">        scanner.addIncludeFilter(<span class="keyword">new</span> AnnotationTypeFilter(cls));</div><div class="line">      &#125;</div><div class="line">      <span class="comment">// 找出所有的带有注解的类</span></div><div class="line">      beanDefinitions = scanner.findCandidateComponents(AMBARI_PACKAGE);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == beanDefinitions || beanDefinitions.size() == <span class="number">0</span>) &#123;</div><div class="line">      LOG.warn(<span class="string">"No instances of &#123;&#125; found to register"</span>, classes);</div><div class="line">      <span class="keyword">return</span> beanDefinitions;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    Set&lt;com.google.common.util.concurrent.Service&gt; services =</div><div class="line">        <span class="keyword">new</span> HashSet&lt;com.google.common.util.concurrent.Service&gt;();</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (BeanDefinition beanDefinition : beanDefinitions) &#123;</div><div class="line">      String className = beanDefinition.getBeanClassName();</div><div class="line">      Class&lt;?&gt; clazz = ClassUtils.resolveClassName(className,</div><div class="line">          ClassUtils.getDefaultClassLoader());</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> != clazz.getAnnotation(EagerSingleton.class)) &#123;</div><div class="line">        bind(clazz).asEagerSingleton();</div><div class="line">        LOG.debug(<span class="string">"Binding singleton &#123;&#125; eagerly"</span>, clazz);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> != clazz.getAnnotation(StaticallyInject.class)) &#123;</div><div class="line">        requestStaticInjection(clazz);</div><div class="line">        LOG.debug(<span class="string">"Statically injecting &#123;&#125; "</span>, clazz);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// Ambari services are registered with Guava</span></div><div class="line">      <span class="comment">// 使用Guava的AmbariService注解类</span></div><div class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> != clazz.getAnnotation(AmbariService.class)) &#123;</div><div class="line">        <span class="comment">// 看看是不是一个Guava service</span></div><div class="line">        <span class="keyword">if</span> (!AbstractScheduledService.class.isAssignableFrom(clazz)) &#123;</div><div class="line">          String message = MessageFormat.format(</div><div class="line">              <span class="string">"Unable to register service &#123;0&#125; because it is not an AbstractScheduledService"</span>,</div><div class="line">              clazz);</div><div class="line"></div><div class="line">          LOG.warn(message);</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(message);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 实例化，并作为单例注入到guice中，然后再添加到services中</span></div><div class="line">        AbstractScheduledService service = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          service = (AbstractScheduledService) clazz.newInstance();</div><div class="line">          bind((Class&lt;AbstractScheduledService&gt;) clazz).toInstance(service);</div><div class="line">          services.add(service);</div><div class="line">          LOG.debug(<span class="string">"Registering service &#123;&#125; "</span>, clazz);</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception exception) &#123;</div><div class="line">          LOG.error(<span class="string">"Unable to register &#123;&#125; as a service"</span>, clazz, exception);</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(exception);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="comment">// 使用上面扫描完获取到的所有services，实例化serviceManager，并单例化注入guice</span></div><div class="line">    ServiceManager manager = <span class="keyword">new</span> ServiceManager(services);</div><div class="line">    bind(ServiceManager.class).toInstance(manager);</div><div class="line"></div><div class="line">    <span class="keyword">return</span> beanDefinitions;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>ServiceManager作为AmbariServer的依赖项被注入，然后在run方法中被调用其startAsync方法，我们看到其实是遍历调用了services中的service的startAsync方法：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">public ServiceManager startAsync() &#123;</div><div class="line">  for (Service service : services) &#123;</div><div class="line">    State state = service.state();</div><div class="line">    checkState(state == NEW, &quot;Service %s is %s, cannot start it.&quot;, service, state);</div><div class="line">  &#125;</div><div class="line">  for (Service service : services) &#123;</div><div class="line">    try &#123;</div><div class="line">      service.startAsync();</div><div class="line">    &#125; catch (IllegalStateException e) &#123;</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  return this;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>参考：<a href="https://github.com/google/guice/wiki/GettingStarted" target="_blank" rel="external">https://github.com/google/guice/wiki/GettingStarted</a></p>
<p>看了这么多，但是实际alert来源呢？一般都是agent在本地执行检查，符合告警规则的才发送给server端。那么是怎样发送到server的呢？首先想到的是rest api里的AlertNoticeService，可是这个类只有get方法，没有POST接口。那么下一个嫌疑就是HeartBeat信息了。看下HeartBeat的定义<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">private long responseId = -1;</div><div class="line">private long timestamp;</div><div class="line">private String hostname;</div><div class="line">List&lt;CommandReport&gt; reports = new ArrayList&lt;CommandReport&gt;();</div><div class="line">List&lt;ComponentStatus&gt; componentStatus = new ArrayList&lt;ComponentStatus&gt;();</div><div class="line">private List&lt;DiskInfo&gt; mounts = new ArrayList&lt;DiskInfo&gt;();</div><div class="line">HostStatus nodeStatus;</div><div class="line">private AgentEnv agentEnv = null;</div><div class="line">private List&lt;Alert&gt; alerts = null;</div><div class="line">private RecoveryReport recoveryReport;</div></pre></td></tr></table></figure></p>
<p>果然，那么我们就也能找到HeartBeat相关的resource了：AgentResource。HeartBeatHandler处理过程中会把heartbeat放进HeartbeatProcessor的队列里，做异步处理，告警部分的持久化就在这个异步处理的代码里了。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Path</span>(<span class="string">"heartbeat/&#123;hostName&#125;"</span>)</div><div class="line">  <span class="meta">@POST</span></div><div class="line">  <span class="meta">@Consumes</span>(MediaType.APPLICATION_JSON)</div><div class="line">  <span class="meta">@Produces</span>(&#123;MediaType.APPLICATION_JSON&#125;)</div><div class="line">  <span class="function"><span class="keyword">public</span> HeartBeatResponse <span class="title">heartbeat</span><span class="params">(HeartBeat message)</span></span></div><div class="line">      <span class="keyword">throws</span> WebApplicationException &#123;</div><div class="line">    <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</div><div class="line">      LOG.debug(<span class="string">"Received Heartbeat message "</span> + message);</div><div class="line">    &#125;</div><div class="line">    HeartBeatResponse heartBeatResponse;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">    <span class="comment">// hh是一个单例的HeartBeatHandler</span></div><div class="line">      heartBeatResponse = hh.handleHeartBeat(message);</div><div class="line">      <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</div><div class="line">        LOG.debug(<span class="string">"Sending heartbeat response with response id "</span> + heartBeatResponse.getResponseId());</div><div class="line">        LOG.debug(<span class="string">"Response details "</span> + heartBeatResponse);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      LOG.warn(<span class="string">"Error in HeartBeat"</span>, e);</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> WebApplicationException(<span class="number">500</span>);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> heartBeatResponse;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>中间经过guava的eventbus的多次事件中转后，在AlertStateChangedListener中被完全持久化进入数据库中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">public void onAlertEvent(AlertStateChangeEvent event) &#123;</div><div class="line">    ...</div><div class="line">    ...</div><div class="line">    for (AlertGroupEntity group : groups) &#123;</div><div class="line">      Set&lt;AlertTargetEntity&gt; targets = group.getAlertTargets();</div><div class="line">      if (null == targets || targets.size() == 0) &#123;</div><div class="line">        continue;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      for (AlertTargetEntity target : targets) &#123;</div><div class="line">        if (!isAlertTargetInterested(target, history)) &#123;</div><div class="line">          continue;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        AlertNoticeEntity notice = new AlertNoticeEntity();</div><div class="line">        notice.setUuid(UUID.randomUUID().toString());</div><div class="line">        notice.setAlertTarget(target);</div><div class="line">        notice.setAlertHistory(event.getNewHistoricalEntry());</div><div class="line">        notice.setNotifyState(NotificationState.PENDING);</div><div class="line">        notices.add(notice);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    m_alertsDispatchDao.createNotices(notices);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>启动HeartBeatHandler的地方出现在AmbariServer.run的代码中<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">....</div><div class="line">AgentResource.statHeartBeatHandler();</div><div class="line">....</div></pre></td></tr></table></figure></p>
<p>至于agent那边具体实现，我们暂时不太关心，因为暂时不需要自定义alert。</p>
<p>综上，对于告警渠道的添加，我们需要自己实现guava的<code>AbstractScheduledService</code>抽象类接口，依照既有的SNNP或者EMAIL等写Dispatcher，然后把它们放置到<code>ServiceManager.AMBARI_PACKAGE</code>的位置。然后，最好是通过ambari提供的REST API添加alert_target，因为要处理跟alert_group相关的事情，自己直接操作数据库比较复杂一些，基本上要复制一遍代码里的所有操作。</p>
<p>大功告成！</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/10/31/ambari源码解析-资源状态监听/" title="ambari源码解析-资源状态监听" itemprop="url">ambari源码解析-资源状态监听</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2017-10-31T09:33:00.000Z" itemprop="datePublished"> 发表于 2017-10-31</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>AmbariServie.run()入口处找到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">...</div><div class="line">LOG.info(&quot;********* Reconciling Alert Definitions **********&quot;);</div><div class="line">ambariMetaInfo.reconcileAlertDefinitions(clusters);</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>调用了AmbariMetaInfo.reconcileAlertDefinitions(Clusters clusters)方法，这个方法主要负责比较stack中定义的alert和数据库中的alert有没有什么变化。它会首先确认一下alert定义所在的service是不是已经被安装了，没有安装的就没有必要关心了。</p>
<p>这个方法还会监测agent定义的alert，这些应该在agent host上运行。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reconcileAlertDefinitions</span><span class="params">(Clusters clusters)</span></span></div><div class="line">      <span class="keyword">throws</span> AmbariException &#123;</div><div class="line"></div><div class="line">    Map&lt;String, Cluster&gt; clusterMap = clusters.getClusters();</div><div class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == clusterMap || clusterMap.size() == <span class="number">0</span>) &#123;</div><div class="line">      <span class="keyword">return</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 遍历cluster</span></div><div class="line">    <span class="keyword">for</span> (Cluster cluster : clusterMap.values()) &#123;</div><div class="line">      <span class="keyword">long</span> clusterId = cluster.getClusterId();</div><div class="line">      StackId stackId = cluster.getDesiredStackVersion();</div><div class="line">      StackInfo stackInfo = getStack(stackId.getStackName(),</div><div class="line">          stackId.getStackVersion());</div><div class="line"></div><div class="line">      <span class="comment">// 创建service/conponent和名字的映射，方便查找</span></div><div class="line">      Collection&lt;ServiceInfo&gt; stackServices = stackInfo.getServices();</div><div class="line">      Map&lt;String, ServiceInfo&gt; stackServiceMap = <span class="keyword">new</span> HashMap&lt;String, ServiceInfo&gt;();</div><div class="line">      Map&lt;String, ComponentInfo&gt; stackComponentMap = <span class="keyword">new</span> HashMap&lt;String, ComponentInfo&gt;();</div><div class="line">      <span class="keyword">for</span> (ServiceInfo stackService : stackServices) &#123;</div><div class="line">        stackServiceMap.put(stackService.getName(), stackService);</div><div class="line"></div><div class="line">        List&lt;ComponentInfo&gt; components = stackService.getComponents();</div><div class="line">        <span class="keyword">for</span> (ComponentInfo component : components) &#123;</div><div class="line">          stackComponentMap.put(component.getName(), component);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      Map&lt;String, Service&gt; clusterServiceMap = cluster.getServices();</div><div class="line">      Set&lt;String&gt; clusterServiceNames = clusterServiceMap.keySet();</div><div class="line"></div><div class="line">      <span class="comment">// 对于当前cluster上已经安装的所有service，获取其metainfo和alert定义， 添加到stackDefinitions</span></div><div class="line">      List&lt;AlertDefinition&gt; stackDefinitions = <span class="keyword">new</span> ArrayList&lt;AlertDefinition&gt;(<span class="number">50</span>);</div><div class="line">      <span class="keyword">for</span> (String clusterServiceName : clusterServiceNames) &#123;</div><div class="line">        ServiceInfo stackService = stackServiceMap.get(clusterServiceName);</div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == stackService) &#123;</div><div class="line">          <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        Set&lt;AlertDefinition&gt; serviceDefinitions = getAlertDefinitions(stackService);</div><div class="line">        stackDefinitions.addAll(serviceDefinitions);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 抽取数据库中所有的alert定义，把list转化为以alert定义名字为key的map</span></div><div class="line">      List&lt;AlertDefinitionEntity&gt; persist = <span class="keyword">new</span> ArrayList&lt;AlertDefinitionEntity&gt;();</div><div class="line">      List&lt;AlertDefinitionEntity&gt; entities = alertDefinitionDao.findAll(clusterId);</div><div class="line"></div><div class="line">      Map&lt;String, AlertDefinitionEntity&gt; mappedEntities = <span class="keyword">new</span> HashMap&lt;String, AlertDefinitionEntity&gt;(<span class="number">100</span>);</div><div class="line">      <span class="keyword">for</span> (AlertDefinitionEntity entity : entities) &#123;</div><div class="line">        mappedEntities.put(entity.getDefinitionName(), entity);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 对每个stack definition，查看是否存在，如果存在，就详细比较一下变化</span></div><div class="line">      <span class="keyword">for</span>( AlertDefinition stackDefinition : stackDefinitions )&#123;</div><div class="line">        AlertDefinitionEntity entity = mappedEntities.get(stackDefinition.getName());</div><div class="line"></div><div class="line">        <span class="comment">// 如果是null，就代表是新的</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == entity) &#123;</div><div class="line">          entity = alertDefinitionFactory.coerce(clusterId, stackDefinition);</div><div class="line">          persist.add(entity);</div><div class="line">          <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 修改过的stack中的定义不会被覆盖，需要使用REST API来修改</span></div><div class="line">        AlertDefinition databaseDefinition = alertDefinitionFactory.coerce(entity);</div><div class="line">        </div><div class="line">        <span class="comment">// 如果stackfinition与数据库中不相等....暂时没有处理任何东西，只是打了个log</span></div><div class="line">        <span class="keyword">if</span> (!stackDefinition.deeplyEquals(databaseDefinition)) &#123;</div><div class="line">          <span class="comment">// this is the code that would normally merge the stack definition</span></div><div class="line">          <span class="comment">// into the database; this is not the behavior we want today</span></div><div class="line"></div><div class="line">          <span class="comment">// entity = alertDefinitionFactory.merge(stackDefinition, entity);</span></div><div class="line">          <span class="comment">// persist.add(entity);</span></div><div class="line"></div><div class="line">          LOG.debug(</div><div class="line">              <span class="string">"The alert named &#123;&#125; has been modified from the stack definition and will not be merged"</span>,</div><div class="line">              stackDefinition.getName());</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 把ambari agent主机上的alert定义添加到持久化列表里</span></div><div class="line">      List&lt;AlertDefinition&gt; agentDefinitions = ambariServiceAlertDefinitions.getAgentDefinitions();</div><div class="line">      <span class="keyword">for</span> (AlertDefinition agentDefinition : agentDefinitions) &#123;</div><div class="line">        AlertDefinitionEntity entity = mappedEntities.get(agentDefinition.getName());</div><div class="line"></div><div class="line">        <span class="comment">// no entity means this is new; create a new entity</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == entity) &#123;</div><div class="line">          entity = alertDefinitionFactory.coerce(clusterId, agentDefinition);</div><div class="line">          persist.add(entity);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 把ambari server 的alert定义添加到持久化列表里</span></div><div class="line">      List&lt;AlertDefinition&gt; serverDefinitions = ambariServiceAlertDefinitions.getServerDefinitions();</div><div class="line">      <span class="keyword">for</span> (AlertDefinition serverDefinition : serverDefinitions) &#123;</div><div class="line">        AlertDefinitionEntity entity = mappedEntities.get(serverDefinition.getName());</div><div class="line"></div><div class="line">        <span class="comment">// no entity means this is new; create a new entity</span></div><div class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == entity) &#123;</div><div class="line">          entity = alertDefinitionFactory.coerce(clusterId, serverDefinition);</div><div class="line">          persist.add(entity);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// 持久化新的，或者需要更新的alert定义</span></div><div class="line">      <span class="keyword">for</span> (AlertDefinitionEntity entity : persist) &#123;</div><div class="line">        <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</div><div class="line">          LOG.info(<span class="string">"Merging Alert Definition &#123;&#125; into the database"</span>,</div><div class="line">              entity.getDefinitionName());</div><div class="line">        &#125;</div><div class="line">        alertDefinitionDao.createOrUpdate(entity);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// all definition resolved; publish their registration</span></div><div class="line">      <span class="comment">// 所有的定义都处理完成后，发布它们的注册event也就是AlertDefinitionRegistrationEvent到eventPublisher</span></div><div class="line">      <span class="keyword">for</span> (AlertDefinitionEntity def : alertDefinitionDao.findAll(cluster.getClusterId())) &#123;</div><div class="line">        AlertDefinition realDef = alertDefinitionFactory.coerce(def);</div><div class="line"></div><div class="line">        AlertDefinitionRegistrationEvent event = <span class="keyword">new</span> AlertDefinitionRegistrationEvent(</div><div class="line">            cluster.getClusterId(), realDef);</div><div class="line"></div><div class="line">        eventPublisher.publish(event);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// for every definition, determine if the service and the component are</span></div><div class="line">      <span class="comment">// still valid; if they are not, disable them - this covers the case</span></div><div class="line">      <span class="comment">// with STORM/REST_API where that component was removed from the</span></div><div class="line">      <span class="comment">// stack but still exists in the database - we disable the alert to</span></div><div class="line">      <span class="comment">// preserve historical references</span></div><div class="line">      List&lt;AlertDefinitionEntity&gt; definitions = alertDefinitionDao.findAllEnabled(clusterId);</div><div class="line">      List&lt;AlertDefinitionEntity&gt; definitionsToDisable = <span class="keyword">new</span> ArrayList&lt;AlertDefinitionEntity&gt;();</div><div class="line"></div><div class="line">      <span class="keyword">for</span> (AlertDefinitionEntity definition : definitions) &#123;</div><div class="line">        String serviceName = definition.getServiceName();</div><div class="line">        String componentName = definition.getComponentName();</div><div class="line"></div><div class="line">        <span class="comment">// the AMBARI service is special, skip it here</span></div><div class="line">        <span class="keyword">if</span> (Services.AMBARI.name().equals(serviceName)) &#123;</div><div class="line">          <span class="keyword">continue</span>;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (!stackServiceMap.containsKey(serviceName)) &#123;</div><div class="line">          LOG.info(</div><div class="line">              <span class="string">"The &#123;&#125; service has been marked as deleted for stack &#123;&#125;, disabling alert &#123;&#125;"</span>,</div><div class="line">              serviceName, stackId, definition.getDefinitionName());</div><div class="line"></div><div class="line">          definitionsToDisable.add(definition);</div><div class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">null</span> != componentName</div><div class="line">            &amp;&amp; !stackComponentMap.containsKey(componentName)) &#123;</div><div class="line">          LOG.info(</div><div class="line">              <span class="string">"The &#123;&#125; component &#123;&#125; has been marked as deleted for stack &#123;&#125;, disabling alert &#123;&#125;"</span>,</div><div class="line">              serviceName, componentName, stackId,</div><div class="line">              definition.getDefinitionName());</div><div class="line"></div><div class="line">          definitionsToDisable.add(definition);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      <span class="comment">// disable definitions and fire the event</span></div><div class="line">      <span class="comment">// 将alert定义diable掉，并发送这个event到eventPublisher</span></div><div class="line">      <span class="keyword">for</span> (AlertDefinitionEntity definition : definitionsToDisable) &#123;</div><div class="line">        definition.setEnabled(<span class="keyword">false</span>);</div><div class="line">        alertDefinitionDao.merge(definition);</div><div class="line"></div><div class="line">        AlertDefinitionDisabledEvent event = <span class="keyword">new</span> AlertDefinitionDisabledEvent(</div><div class="line">            clusterId, definition.getDefinitionId());</div><div class="line"></div><div class="line">        eventPublisher.publish(event);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>好了，上面看到所有的alert定义都处理完后，会发送一个AlertDefinitionRegistrationEvent事件到AmbariEventPublisher。那么我们看下有谁监听了AmbariEventPublisher的AlertDefinitionRegistrationEvent事件就可以了吧。然后就定位到了AlertLifecycleListener。</p>
<p>尼玛，这好像不是具体执行alert的地方。。。。而是管理ambari中各种资源的变化情况的地方。具体可以看下AmbariEvent的实现类列表~~~基本都是维护ambari中各种概念的状态变化的。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/10/31/ambari源码解析-REST解析/" title="ambari源码解析-REST解析" itemprop="url">ambari源码解析-REST解析</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2017-10-31T08:32:24.000Z" itemprop="datePublished"> 发表于 2017-10-31</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>先看下入口的地方, ambariServer.run()：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">ServletHolder sh = <span class="keyword">new</span> ServletHolder(ServletContainer.class);</div><div class="line">sh.setInitParameter(<span class="string">"com.sun.jersey.config.property.resourceConfigClass"</span>,</div><div class="line">  <span class="string">"com.sun.jersey.api.core.PackagesResourceConfig"</span>);</div><div class="line"></div><div class="line">sh.setInitParameter(<span class="string">"com.sun.jersey.config.property.packages"</span>,</div><div class="line"><span class="string">"org.apache.ambari.server.api.rest;"</span> +</div><div class="line">  <span class="string">"org.apache.ambari.server.api.services;"</span> +</div><div class="line">  <span class="string">"org.apache.ambari.eventdb.webservice;"</span> +</div><div class="line">  <span class="string">"org.apache.ambari.server.api"</span>);</div><div class="line"></div><div class="line">sh.setInitParameter(<span class="string">"com.sun.jersey.api.json.POJOMappingFeature"</span>, <span class="string">"true"</span>);</div><div class="line">root.addServlet(sh, <span class="string">"/api/v1/*"</span>);</div><div class="line">sh.setInitOrder(<span class="number">2</span>);</div></pre></td></tr></table></figure></p>
<p>就是<code>ServletHolder.setInitParameter</code>里<code>com.sun.jersey.config.property.packages</code>对应所有的包路径下的类都被jettyserver看作rest资源，然后所有的带有jersey的REST注解的方法，就都是对应一个path的了。</p>
<p>然后看下ambari自己定制的东西，拿我关注的alert_targets接口来看,对应类为AlertTargetService，看POST方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@POST</span></div><div class="line"><span class="meta">@Produces</span>(<span class="string">"text/plain"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">createTarget</span><span class="params">(String body, @Context HttpHeaders headers,</span></span></div><div class="line">    @Context UriInfo ui) &#123;</div><div class="line">  <span class="keyword">return</span> handleRequest(headers, body, ui, Request.Type.POST,</div><div class="line">      createAlertTargetResource(<span class="keyword">null</span>));</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">private</span> ResourceInstance <span class="title">createAlertTargetResource</span><span class="params">(Long targetId)</span> </span>&#123;</div><div class="line">  Map&lt;Resource.Type, String&gt; mapIds = <span class="keyword">new</span> HashMap&lt;Resource.Type, String&gt;();</div><div class="line"></div><div class="line">  mapIds.put(Resource.Type.AlertTarget,</div><div class="line">      <span class="keyword">null</span> == targetId ? <span class="keyword">null</span> : targetId.toString());</div><div class="line"></div><div class="line">  <span class="keyword">return</span> createResource(Resource.Type.AlertTarget, mapIds);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>ambari中所有的Service都继承自BaseService，上面的<code>createAlertTargetResource</code>调用的<code>createResource</code>以及<code>handleRequest</code>都是继承自BaseService的。</p>
<p>BaseService的<code>createResource</code>方法实现，下面的type应该是Resource.Type.AlertTarget，是一个枚举值。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">public ResourceInstance createResource(Resource.Type type, Map&lt;Resource.Type, String&gt; mapIds) &#123;</div><div class="line"></div><div class="line">   /**</div><div class="line">    * 找到type对应的ResourceDefinition， 这里返回的是AlertTargetResourceDefinition</div><div class="line">    */</div><div class="line">   ResourceDefinition resourceDefinition = getResourceDefinition(type, mapIds);</div><div class="line">   </div><div class="line">   // 使用AlertTargetResourceDefinition构建QueryImpl并返回，mapIds为null</div><div class="line">   return new QueryImpl(mapIds, resourceDefinition, ClusterControllerHelper.getClusterController());</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>再看下BaseService的<code>handleRequest</code>方法, 通过这个方法可以让所有的请求处理都通过一个公用逻辑。它会创建一个request实例，然后触发它的process方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">protected</span> Response <span class="title">handleRequest</span><span class="params">(HttpHeaders headers, String body,</span></span></div><div class="line">                                   UriInfo uriInfo, Request.Type requestType,</div><div class="line">                                   MediaType mediaType, ResourceInstance resource) &#123;</div><div class="line">    <span class="comment">// 结果</span></div><div class="line">    Result result = <span class="keyword">new</span> ResultImpl(<span class="keyword">new</span> ResultStatus(ResultStatus.STATUS.OK));</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="comment">// 解析请求内容，使用JsonRequestBodyParser执行解析，其实就是解析成一系列kv</span></div><div class="line">      Set&lt;RequestBody&gt; requestBodySet = getBodyParser().parse(body);</div><div class="line"></div><div class="line">      Iterator&lt;RequestBody&gt; iterator = requestBodySet.iterator();</div><div class="line">      <span class="keyword">while</span> (iterator.hasNext() &amp;&amp; result.getStatus().getStatus().equals(ResultStatus.STATUS.OK)) &#123;</div><div class="line">        RequestBody requestBody = iterator.next();</div><div class="line">        </div><div class="line">        <span class="comment">// 使用RequestFactory创建request，我们会调用createPostRequest方法</span></div><div class="line">        Request request = getRequestFactory().createRequest(</div><div class="line">            headers, requestBody, uriInfo, requestType, resource);</div><div class="line">        <span class="comment">// 执行request</span></div><div class="line">        result  = request.process();</div><div class="line">      &#125;</div><div class="line">    &#125; </div><div class="line"></div><div class="line">   ....</div><div class="line">   ....</div><div class="line">   </div><div class="line">    <span class="keyword">return</span> builder.build();</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>创建request的代码部分：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> Request <span class="title">createPostRequest</span><span class="params">(HttpHeaders headers, RequestBody body, UriInfo uriInfo, ResourceInstance resource)</span> </span>&#123;</div><div class="line">    <span class="keyword">boolean</span> batchCreate = !applyDirectives(Request.Type.POST, body, uriInfo, resource);;</div><div class="line">    </div><div class="line">    <span class="comment">// 如果是批处理，就返回QueryPostRequest, 否则返回PostRequest，我们这里返回的是PostRequest</span></div><div class="line">    <span class="comment">// PostRequest会与一个CreateHandler一一对应，作为它的handler存在</span></div><div class="line">    <span class="keyword">return</span> (batchCreate) ?</div><div class="line">        <span class="keyword">new</span> QueryPostRequest(headers, body, uriInfo, resource) :</div><div class="line">        <span class="keyword">new</span> PostRequest(headers, body, uriInfo, resource);</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>request的process部分，那么就看PostRequest的实现，发现它继承了BaseRequest，实际调用的是BaseRequest的process方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Result result;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">  parseRenderer();</div><div class="line">  parseQueryPredicate();</div><div class="line">  result = getRequestHandler().handleRequest(<span class="keyword">this</span>);</div><div class="line">&#125; <span class="keyword">catch</span> (InvalidQueryException e) &#123;</div><div class="line">  result =  <span class="keyword">new</span> ResultImpl(<span class="keyword">new</span> ResultStatus(ResultStatus.STATUS.BAD_REQUEST,</div><div class="line">      <span class="string">"Unable to compile query predicate: "</span> + e.getMessage()));</div><div class="line">&#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</div><div class="line">  result =  <span class="keyword">new</span> ResultImpl(<span class="keyword">new</span> ResultStatus(ResultStatus.STATUS.BAD_REQUEST,</div><div class="line">      <span class="string">"Invalid Request: "</span> + e.getMessage()));</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">if</span> (! result.getStatus().isErrorState()) &#123;</div><div class="line">  getResultPostProcessor().process(result);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>BaseManagementHandler中又调用了persist方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> Result <span class="title">handleRequest</span><span class="params">(Request request)</span> </span>&#123;</div><div class="line">  Query query = request.getResource().getQuery();</div><div class="line">  Predicate queryPredicate = request.getQueryPredicate();</div><div class="line"></div><div class="line">  query.setRenderer(request.getRenderer());</div><div class="line">  <span class="keyword">if</span> (queryPredicate != <span class="keyword">null</span>) &#123;</div><div class="line">    query.setUserPredicate(queryPredicate);</div><div class="line">  &#125;</div><div class="line">  <span class="keyword">return</span> persist(request.getResource(), request.getBody());</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p><code>persist(ResourceInstance resource, RequestBody body)</code>方法在CreateHandler中有实现, 代码中的PersistenceManager只有一个实现PersistenceManagerImpl。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">RequestStatus status = getPersistenceManager().create(resource, body);</div><div class="line">result = createResult(status);</div></pre></td></tr></table></figure></p>
<p>PersistenceManagerImpl的<code>create(ResourceInstance resource, RequestBody requestBody)</code>相关部分。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">// 获取resource对应的主键、外键</div><div class="line">Map&lt;Resource.Type, String&gt; mapResourceIds = resource.getKeyValueMap();</div><div class="line">Resource.Type type = resource.getResourceDefinition().getType();</div><div class="line">Schema schema = m_controller.getSchema(type);</div><div class="line"></div><div class="line">// 获取body中解析的各种键值</div><div class="line">Set&lt;NamedPropertySet&gt; setProperties = requestBody.getNamedPropertySets();</div><div class="line">if (setProperties.isEmpty()) &#123;</div><div class="line">requestBody.addPropertySet(new NamedPropertySet(&quot;&quot;, new HashMap&lt;String, Object&gt;()));</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 遍历body中的键值</div><div class="line">for (NamedPropertySet propertySet : setProperties) &#123;</div><div class="line">for (Map.Entry&lt;Resource.Type, String&gt; entry : mapResourceIds.entrySet()) &#123;</div><div class="line">  Map&lt;String, Object&gt; mapProperties = propertySet.getProperties();</div><div class="line">  // schema中组合了ResourceProvider，这里就是AlertTargetResourceProvider，getKeyPropertyId方法是调用AlertTargetResourceProvider获取可以唯一确认一条记录的唯一键</div><div class="line">  // AlertTarget中定义的唯一键是&quot;AlertTarget/id&quot;和&quot;AlertTarget/name&quot;</div><div class="line">  String property = schema.getKeyPropertyId(entry.getKey());</div><div class="line">  // 如果不包含唯一键，就添加进入mapProperties</div><div class="line">  if (!mapProperties.containsKey(property)) &#123;</div><div class="line">    mapProperties.put(property, entry.getValue());</div><div class="line">  &#125;</div><div class="line">&#125;</div><div class="line">&#125;</div><div class="line">// 创建resource</div><div class="line">return m_controller.createResources(type, createControllerRequest(requestBody));</div></pre></td></tr></table></figure></p>
<p>最后一步就是调用了<code>ClusterControllerImpl</code>的<code>createResources(Type type, Request request)</code>方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> RequestStatus <span class="title">createResources</span><span class="params">(Type type, Request request)</span></span>&#123;</div><div class="line">    <span class="comment">// 获取对应的ResrouceProvider，如果找不到就用DefaultProviderModule通过type去createResourceProvider对应的ResrouceProvider，我们这里对应的是上面提到的AlertTargetResourceProvider</span></div><div class="line">    ResourceProvider provider = ensureResourceProvider(type);</div><div class="line">    <span class="keyword">if</span> (provider != <span class="keyword">null</span>) &#123;</div><div class="line">    </div><div class="line">      checkProperties(type, request, <span class="keyword">null</span>);</div><div class="line">    </div><div class="line">      <span class="keyword">return</span> provider.createResources(request);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>最后一步AlertTargetResourceProvider, 然后会调用到AlertDispatchDAO的<code>create(AlertTargetEntity alertTarget)</code>方法，就入库了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">public RequestStatus createResources(final Request request)</div><div class="line">    throws SystemException,</div><div class="line">    UnsupportedPropertyException, ResourceAlreadyExistsException,</div><div class="line">    NoSuchParentResourceException &#123;</div><div class="line"></div><div class="line">  createResources(new Command&lt;Void&gt;() &#123;</div><div class="line">    @Override</div><div class="line">    public Void invoke() throws AmbariException &#123;</div><div class="line">      createAlertTargets(request.getProperties(), request.getRequestInfoProperties());</div><div class="line">      return null;</div><div class="line">    &#125;</div><div class="line">  &#125;);</div><div class="line"></div><div class="line">  notifyCreate(Resource.Type.AlertTarget, request);</div><div class="line">  return getRequestStatus(null);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>细看一下，是个事务接口<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">public void create(AlertTargetEntity alertTarget) &#123;</div><div class="line">  // 持久化target到数据库</div><div class="line">  entityManagerProvider.get().persist(alertTarget);</div><div class="line">  </div><div class="line">  // 如果这个target是global的，就遍历所有的group，与这个target关联起来</div><div class="line">  // 就是更新数据库中的关联关系</div><div class="line">  if (alertTarget.isGlobal()) &#123;</div><div class="line">    List&lt;AlertGroupEntity&gt; groups = findAllGroups();</div><div class="line">    for (AlertGroupEntity group : groups) &#123;</div><div class="line">      group.addAlertTarget(alertTarget);</div><div class="line">      merge(group);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="感想"><a href="#感想" class="headerlink" title="感想"></a>感想</h2><p>没有看到什么特别的好处，整个处理过程特别绕…如果只是为了统一处理请求的话，使用spring的filter之类的不能搞定么？为什么要弄一个handleRequest的抽象方法呢？</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/10/31/ambari源码解析-自定义告警/" title="ambari源码解析-自定义告警" itemprop="url">ambari源码解析-自定义告警</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2017-10-31T07:35:50.000Z" itemprop="datePublished"> 发表于 2017-10-31</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>ambari原生支持两种告警手段：邮件告警、SNMP告警。</p>
<p>个人主要是研发，对SNMP一直不太了解，试着搜了一些资料，稍显麻烦，而且目前我们的数据集群运维工作中并没有使用到SNMP相关的工具，所以暂时并不认为必要。</p>
<p>我们期望的告警方式是短信告警，具有最高的时效性，已经具有了短信告警接口。所以下一步就是在ambari这边找到调用此接口，并传送有效告警信息的方式。</p>
<p>翻阅文档，发现amabri也是支持<a href="https://cwiki.apache.org/confluence/display/AMBARI/Creating+a+Script-based+Alert+Dispatcher" target="_blank" rel="external">脚本告警</a>的。单独看文档稍微有些懵逼，还是看下对应源码吧。</p>
<p>关键字dispatcher，找到对应的类AlertScriptDispatcher。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">/**</div><div class="line">  * 在amabri.properties中配置执行告警的脚本的配置项</div><div class="line">  */</div><div class="line"> public static final String SCRIPT_CONFIG_DEFAULT_KEY = &quot;notification.dispatch.alert.script&quot;;</div><div class="line"></div><div class="line"> /**</div><div class="line">  * 在amabri.properties中配置以毫秒为单位的执行告警超时的脚本的配置项，默认是5000，也就是5s</div><div class="line">  */</div><div class="line"> public static final String SCRIPT_CONFIG_TIMEOUT_KEY = &quot;notification.dispatch.alert.script.timeout&quot;;</div><div class="line"></div><div class="line"> /**</div><div class="line">  * 用来定义指定执行告警脚本的配置项的关键字，如果没有配置的话，就默认是SCRIPT_CONFIG_DEFAULT_KEY[也就是notification.dispatch.alert.script]</div><div class="line">  */</div><div class="line"> public static final String DISPATCH_PROPERTY_SCRIPT_CONFIG_KEY = &quot;ambari.dispatch-property.script&quot;;</div></pre></td></tr></table></figure>
<p>调用逻辑<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(Notification notification)</span> </span>&#123;</div><div class="line">    String scriptKey = getScriptConfigurationKey(notification);</div><div class="line">    String script = m_configuration.getProperty(scriptKey);</div><div class="line">    .....</div><div class="line">    .....</div><div class="line"></div><div class="line">    <span class="comment">// execute the script asynchronously</span></div><div class="line">    <span class="keyword">long</span> timeout = getScriptConfigurationTimeout();</div><div class="line">    TimeUnit timeUnit = TimeUnit.MILLISECONDS;</div><div class="line">    AlertNotification alertNotification = (AlertNotification) notification;</div><div class="line">    ProcessBuilder processBuilder = getProcessBuilder(script, alertNotification);</div><div class="line"></div><div class="line">    AlertScriptRunnable runnable = <span class="keyword">new</span> AlertScriptRunnable(alertNotification, script,</div><div class="line">        processBuilder,</div><div class="line">        timeout, timeUnit);</div><div class="line"></div><div class="line">    m_executor.execute(runnable);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>脚步组装<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function">ProcessBuilder <span class="title">getProcessBuilder</span><span class="params">(String script, AlertNotification notification)</span> </span>&#123;</div><div class="line">    <span class="keyword">final</span> String shellCommand;</div><div class="line">    <span class="keyword">final</span> String shellCommandOption;</div><div class="line">    <span class="keyword">if</span> (SystemUtils.IS_OS_WINDOWS) &#123;</div><div class="line">      shellCommand = <span class="string">"cmd"</span>;</div><div class="line">      shellCommandOption = <span class="string">"/c"</span>;</div><div class="line">    &#125; <span class="keyword">else</span> &#123;</div><div class="line">      shellCommand = <span class="string">"sh"</span>;</div><div class="line">      shellCommandOption = <span class="string">"-c"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    AlertInfo alertInfo = notification.getAlertInfo();</div><div class="line">    AlertDefinitionEntity definition = alertInfo.getAlertDefinition();</div><div class="line">    String definitionName = definition.getDefinitionName();</div><div class="line">    AlertState alertState = alertInfo.getAlertState();</div><div class="line">    String serviceName = alertInfo.getServiceName();</div><div class="line"></div><div class="line">    ....</div><div class="line">    ....</div><div class="line">    </div><div class="line">    Object[] params = <span class="keyword">new</span> Object[] &#123; script, definitionName, alertLabel, serviceName,</div><div class="line">        alertState.name(), alertText &#125;;</div><div class="line"></div><div class="line">    String foo = StringUtils.join(params, <span class="string">" "</span>);</div><div class="line">    </div><div class="line">    <span class="comment">// 示例</span></div><div class="line">    <span class="comment">// sh -c '/foo/sys_logger.py ambari_server_agent_heartbeat "Agent Heartbeat"</span></div><div class="line">    <span class="comment">// AMBARI CRITICAL "Something went wrong with the host"'</span></div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ProcessBuilder(shellCommand, shellCommandOption, foo);</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>对应了文档中<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"># :param definitionName: alert的唯一名字</div><div class="line"># :param definitionLabel: 可读性强的alert标签</div><div class="line"># :param serviceName: 告警对应的service名称</div><div class="line"># :param alertState: 告警状态 (OK, WARNING, etc)</div><div class="line"># :param alertText: 告警内容</div><div class="line"> </div><div class="line">def main():</div><div class="line">    definitionName = sys.argv[1]</div><div class="line">    definitionLabel = sys.argv[2]</div><div class="line">    serviceName = sys.argv[3]</div><div class="line">    alertState = sys.argv[4]</div><div class="line">    alertText = sys.argv[5]</div></pre></td></tr></table></figure></p>
<p>负责告警触发的类是AlertNoticeDispatchService。它会扫描数据表<code>alert_notice</code>中的pending状态的告警实例，通过告警分发系统处理这些告警实例。然后分发系统会回调<code>AlertNoticeDispatchCallback</code>处理告警实例的状态更新。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/10/27/mysql从库crash/" title="mysql从库crash" itemprop="url">mysql从库crash</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2017-10-27T09:25:14.000Z" itemprop="datePublished"> 发表于 2017-10-27</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p> mysql主从架构，从库crash掉。恢复以后，出现主从同步错误问题。</p>
 <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"> 2017-10-27 16:23:38 2098 [ERROR] /server/mysql/bin/mysqld: Table &apos;./mysql/proc&apos; is marked as crashed and should be repaired</div><div class="line">2017-10-27 16:23:38 2098 [Warning] Checking table:   &apos;./mysql/proc&apos;</div><div class="line">2017-10-27 16:23:47 2098 [Warning] Access denied for user &apos;root&apos;@&apos;localhost&apos; (using password: NO)</div><div class="line">2017-10-27 16:30:03 2098 [Warning] Access denied for user &apos;root&apos;@&apos;localhost&apos; (using password: NO)</div><div class="line">2017-10-27 16:31:06 2098 [Warning] Slave SQL: If a crash happens this configuration does not guarantee that the relay log info will b</div><div class="line">e consistent, Error_code: 0</div><div class="line">2017-10-27 16:31:06 2098 [Note] Slave SQL thread initialized, starting replication in log &apos;mysql-bin.004001&apos; at position 1000175864, </div><div class="line">relay log &apos;./prd-mysql03-relay-bin.000994&apos; position: 4145</div><div class="line">2017-10-27 16:31:06 2098 [ERROR] Slave SQL: Could not execute Write_rows event on table YKX_DW.JLC_APP_MARKPOINT_REALTIME; Duplicate </div><div class="line">entry &apos;212630&apos; for key &apos;PRIMARY&apos;, Error_code: 1062; handler error HA_ERR_FOUND_DUPP_KEY; the event&apos;s master log mysql-bin.004001, end</div><div class="line">_log_pos 1000176163, Error_code: 1062</div><div class="line">2017-10-27 16:31:06 2098 [Warning] Slave: Duplicate entry &apos;212630&apos; for key &apos;PRIMARY&apos; Error_code: 1062</div><div class="line">2017-10-27 16:31:06 2098 [ERROR] Error running query, slave SQL thread aborted. Fix the problem, and restart the slave SQL thread wit</div><div class="line">h &quot;SLAVE START&quot;. We stopped at log &apos;mysql-bin.004001&apos; position 1000175864</div></pre></td></tr></table></figure>
<p>之后<code>show slave status</code><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">Slave_IO_Running: Yes  </div><div class="line">Slave_SQL_Running: No</div></pre></td></tr></table></figure></p>
<p>先stop slave，然后执行了一下提示的语句，就是把重复的主键记录删除，<br>再SET GLOBAL SQL_SLAVE_SKIP_COUNTER=1; START SLAVE;</p>
<p>参考：<a href="http://www.linuxidc.com/Linux/2017-02/141056.htm" target="_blank" rel="external">http://www.linuxidc.com/Linux/2017-02/141056.htm</a></p>
<p><a href="http://blog.csdn.net/donghaixiaolongwang/article/details/74923971" target="_blank" rel="external">http://blog.csdn.net/donghaixiaolongwang/article/details/74923971</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/10/26/对于spark-streaming通过runningdata运行的简单规划/" title="对于spark-streaming通过runningdata运行的简单规划" itemprop="url">对于spark-streaming通过runningdata运行的简单规划</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2017-10-26T10:41:07.000Z" itemprop="datePublished"> 发表于 2017-10-26</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h4 id="提交流程"><a href="#提交流程" class="headerlink" title="提交流程"></a>提交流程</h4><ol>
<li>添加spark jar</li>
<li>添加参数</li>
<li>配置调度</li>
</ol>
<h4 id="后台流程"><a href="#后台流程" class="headerlink" title="后台流程"></a>后台流程</h4><ol>
<li>扫描updatetime，检测新更新的spark streaming程序</li>
<li>检查jar包修改，将修改后的jar包重新上传到HDFS/mesos集群公共访问部分</li>
<li>创建/修改marathon app配置</li>
<li>重启/启动marathon app</li>
</ol>
<h4 id="日志检查"><a href="#日志检查" class="headerlink" title="日志检查"></a>日志检查</h4><p>这方面其实marathon已经做得很好了。可以直接拼接marathon的日志API搞定。</p>
<p>marathon api<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://10.2.19.125:5051/files/download?path=/server/mesos/agent/slaves/5fc969e7-c2da-4435-a0cb-278240c52f25-S2/frameworks/d2f4a97d-de35-4d1b-bf6d-07b8f2ad7666-0000/executors/willsparkstreamingtest01.cfcd8dde-ba34-11e7-9beb-3e15ac098cb2/runs/1128e325-ad92-4266-8348-04f43cfaa4c4/stderr</div></pre></td></tr></table></figure></p>
<p>mesos api<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://10.2.19.124:5050/#/agents/5fc969e7-c2da-4435-a0cb-278240c52f25-S2/browse?path=/server/mesos/agent/slaves/5fc969e7-c2da-4435-a0cb-278240c52f25-S2/frameworks/d2f4a97d-de35-4d1b-bf6d-07b8f2ad7666-0000/executors/willsparkstreamingtest01.cfcd8dde-ba34-11e7-9beb-3e15ac098cb2/runs/latest</div></pre></td></tr></table></figure></p>
<p>mesos 增量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://10.2.19.125:5051/files/read?path=/server/mesos/agent/slaves/5fc969e7-c2da-4435-a0cb-278240c52f25-S2/frameworks/d2f4a97d-de35-4d1b-bf6d-07b8f2ad7666-0000/executors/willsparkstreamingtest01.cfcd8dde-ba34-11e7-9beb-3e15ac098cb2/runs/latest/stdout&amp;offset=115771&amp;length=50000&amp;jsonp=jQuery17109253805122640539_1509014182353&amp;_=1509014197811</div></pre></td></tr></table></figure>
<p>mesos 下载<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">http://10.2.19.125:5051/files/download?path=/server/mesos/agent/slaves/5fc969e7-c2da-4435-a0cb-278240c52f25-S2/frameworks/d2f4a97d-de35-4d1b-bf6d-07b8f2ad7666-0000/executors/willsparkstreamingtest01.cfcd8dde-ba34-11e7-9beb-3e15ac098cb2/runs/latest/stdout</div></pre></td></tr></table></figure></p>
<p>因为有增量，所以我们会优先考虑过滤改造mesos的API。</p>
<p>对于上面所有的路径信息，<br>主要就是framework的id，mesos salve的id，task的id。</p>
<p>slaveid, taskid可以通过marathon的task接口获取到。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">curl http://10.2.19.124:8080/v2/apps/willsparkstreamingtest01</div></pre></td></tr></table></figure></p>
<p>framework的ID可以去<a href="http://mesos.apache.org/documentation/latest/endpoints/master/frameworks/" target="_blank" rel="external">mesos的api</a>里找到。其实后面这个就包含了上面的所有信息了。</p>
<p>另外，考虑到可能出现程序错误，导致app在marathon上不停部署，那么此时我们是需要获取前面失败的log的。失败log其实也是一次部署的log，所以路径上没有什么区别，但是可能taskid会有所变化，仔细观察上面的数据里其实是有lastTaskFailure的信息的，可以找到上个失败task的id，进而找到失败的log。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/10/26/ambari添加异构OS/" title="ambari添加异构OS" itemprop="url">ambari添加异构OS</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2017-10-26T07:35:13.000Z" itemprop="datePublished"> 发表于 2017-10-26</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>首先声明，HDFS集群中肯定是最好不要有异构机器存在的，会造成很多兼容性问题。</p>
<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><table>
<thead>
<tr>
<th>系统</th>
<th>作用</th>
<th>数量</th>
</tr>
</thead>
<tbody>
<tr>
<td>centos6</td>
<td>yarn/HDFS等服务的选定集群，主要用来运行日常任务</td>
<td>50</td>
</tr>
<tr>
<td>centos7</td>
<td>marathon/docker所在的小集群，预想用来调度任务</td>
<td>5</td>
</tr>
</tbody>
</table>
<p>其实我们已经基于centos6.8 final有了一个比较稳定的集群，上面通过ambari安装并稳健运行着HDFS、MR、Yarn、Spark、HBase等大数据服务。但是我们想要将spark streaming、hive等ETL工作的客户端放置在mesos上运行，因为当这些工作比较多的时候，也同样需要资源管理工作。鉴于mesos的资源管理相对yarn来说更加可定制化、而且已经有很多开源且稳定的framework可用，我们就选用mesos来做这个客户端集群的工作。对于long time的spark streaming，我们期望使用marathon来管理。一段时间的hive ETL任务，可以使用docker或者chronos来执行。</p>
<p>鉴于以上计划，我们需要在mesos的agent机器上安装spark、hive等客户端配置文件。考虑到易操作性和软件的版本统一兼容问题，决定继续使用ambari在mesos agent上安装这些软件的client端，然后就可以直接调用了。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>在添加新host的过程中，ambari会比较智能的告诉我们，新的OS与既有的集群OS可能存在不兼容的问题，并阻止我们进一步执行。</p>
<h2 id="处理"><a href="#处理" class="headerlink" title="处理"></a>处理</h2><p>考虑到我们只是使用客户端，而且我们的程序客户端是基于java的，具有可移植性。所以我就去找到ambari-server在新增机器的时候，对于OS的检测脚本，暂时注释掉，添加完新的host之后，再放开。</p>
<p>2.2.2.0的脚本位置:<code>/usr/lib/python2.6/site-packages/ambari_server/bootstrap.py</code>：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">def run(self):</div><div class="line">    &quot;&quot;&quot; Copy files and run commands on remote host &quot;&quot;&quot;</div><div class="line">    self.status[&quot;start_time&quot;] = time.time()</div><div class="line">    # Population of action queue</div><div class="line">    action_queue = [self.createTargetDir,</div><div class="line">                    self.copyCommonFunctions,</div><div class="line">                    self.copyOsCheckScript,</div><div class="line">                    self.runOsCheckScript,</div><div class="line">                    self.checkSudoPackage</div><div class="line">    ]</div><div class="line">    if self.hasPassword():</div><div class="line">      action_queue.extend([self.copyPasswordFile,</div><div class="line">                           self.changePasswordFileModeOnHost])</div><div class="line">    action_queue.extend([</div><div class="line">      self.copyNeededFiles,</div><div class="line">      self.runSetupAgent,</div><div class="line">    ])</div><div class="line">    ....</div></pre></td></tr></table></figure></p>
<p>把action_queue里的OSCheck相关的暂时注释掉就可以了。然后去添加host的界面上点击retry failed。只要注册成功就可以了。</p>
<p>install过程跳过去了，但是注册的时候出现了问题。</p>
<p>报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">INFO 2017-10-26 16:14:42,747 NetUtil.py:60 - Connecting to https://namenode01.will.com:8440/ca</div><div class="line">ERROR 2017-10-26 16:14:42,848 NetUtil.py:84 - [SSL: CERTIFICATE_VERIFY_FAILED] certificate verify failed (_ssl.c:579)</div><div class="line">ERROR 2017-10-26 16:14:42,848 NetUtil.py:85 - SSLError: Failed to connect. Please check openssl library versions. </div><div class="line">Refer to: https://bugzilla.redhat.com/show_bug.cgi?id=1022468 for more details.</div><div class="line">WARNING 2017-10-26 16:14:42,850 NetUtil.py:112 - Server at https://namenode01.will.com:8440 is not reachable, sleeping for 10 seconds...</div><div class="line">&apos;, None)</div></pre></td></tr></table></figure></p>
<p>在新的host上找到ambari-agent相关代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">def checkURL(self, url):</div><div class="line">  &quot;&quot;&quot;Try to connect to a given url. Result is True if url returns HTTP code 200, in any other case</div><div class="line">  (like unreachable server or wrong HTTP code) result will be False.</div><div class="line"></div><div class="line">     Additionally returns body of request, if available</div><div class="line">  &quot;&quot;&quot;</div><div class="line">  logger.info(&quot;Connecting to &quot; + url)</div><div class="line">  responseBody = &quot;&quot;</div><div class="line"></div><div class="line">  try:</div><div class="line">    parsedurl = urlparse(url)</div><div class="line"></div><div class="line">    if sys.version_info &gt;= (2,7,9):</div><div class="line">        import ssl</div><div class="line">        ca_connection = httplib.HTTPSConnection(parsedurl[1], context=ssl._create_unverified_context())</div><div class="line">    else:</div><div class="line">        ca_connection = httplib.HTTPSConnection(parsedurl[1])</div><div class="line">    ...</div><div class="line">  except SSLError as slerror:</div><div class="line">    logger.error(str(slerror))</div><div class="line">    logger.error(ERROR_SSL_WRONG_VERSION)</div><div class="line">    return False, responseBody</div><div class="line"></div><div class="line">  except Exception, e:</div><div class="line">    logger.warning(&quot;Failed to connect to &quot; + str(url) + &quot; due to &quot; + str(e) + &quot;  &quot;)</div><div class="line">    return False, responseBody</div></pre></td></tr></table></figure></p>
<p>从报错来看，是出现了SSLError，好像是SSL的兼容问题。对比看一下ssl的版本：</p>
<ul>
<li>centos7 openssl-1.0.2k-8.el7.x86_64</li>
<li>centos6 openssl-1.0.1e-57.el6.x86_64</li>
</ul>
<p>考虑到既有集群的稳定性，失败告终。配置同步问题转由rsync、nfs之类的方案解决吧。</p>
<p>参考：</p>
<ul>
<li><a href="https://community.hortonworks.com/questions/4324/hdp-support-for-mix-of-os-releases-within-a-cluste.html" target="_blank" rel="external">https://community.hortonworks.com/questions/4324/hdp-support-for-mix-of-os-releases-within-a-cluste.html</a></li>
<li><a href="https://community.hortonworks.com/questions/18479/how-to-register-host-with-different-os-to-ambari.html" target="_blank" rel="external">https://community.hortonworks.com/questions/18479/how-to-register-host-with-different-os-to-ambari.html</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/4/"><span></span>Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><a class="page-number" href="/page/7/">7</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" href="/page/6/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  

  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/youdaonote/" title="youdaonote">youdaonote<sup>187</sup></a></li>
			
		
			
				<li><a href="/tags/源码/" title="源码">源码<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/akka/" title="akka">akka<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/flume/" title="flume">flume<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/ETL/" title="ETL">ETL<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/solr/" title="solr">solr<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/spring/" title="spring">spring<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/调度平台/" title="调度平台">调度平台<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/azkaban/" title="azkaban">azkaban<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/mysql/" title="mysql">mysql<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/scala/" title="scala">scala<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/ambari/" title="ambari">ambari<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/quartz/" title="quartz">quartz<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/nodejs/" title="nodejs">nodejs<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Solr/" title="Solr">Solr<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/guava/" title="guava">guava<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/heroku/" title="heroku">heroku<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/hdfs/" title="hdfs">hdfs<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/hue/" title="hue">hue<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ElasticSearch/" title="ElasticSearch">ElasticSearch<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://github.com/willcup" target="_blank" title=" 我自己的github">github</a>
            
          </li>
        
          <li>
            
            	<a href="http://thisding.com" target="_blank" title="朋友的主页">Steven&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Will Chen in MeiTuan. <br/>
			元 亨 利 贞.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:chenxin15@meituan.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2017 
		
		<a href="/about" target="_blank" title="Will Chen">Will Chen</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fe6d1f421bbc9962127a50488f9ed37d1' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
