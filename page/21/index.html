
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <script type="text/javascript">
    (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
    })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
    
    _st('install','yNiKTKaAnwd1uuxVMfiE','2.0.0');
  </script>
  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?5b99dfd487346155d274c0c49c3fb869";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
  </script>

  
    <title>Will&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Will Chen">
    

    
    <meta name="description" content="左右水色 右手天光">
<meta property="og:type" content="website">
<meta property="og:title" content="Will's Blog">
<meta property="og:url" content="https://runningdata.github.io/page/21/index.html">
<meta property="og:site_name" content="Will's Blog">
<meta property="og:description" content="左右水色 右手天光">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Will's Blog">
<meta name="twitter:description" content="左右水色 右手天光">

    
    <link rel="alternative" href="/atom.xml" title="Will&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Will&#39;s Blog" title="Will&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Will&#39;s Blog">Will&#39;s Blog</a></h1>
				<h2 class="blog-motto">简易 变易 不易</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
                                                <form class="search" action="/search/index.html" method="get" accept-charset="utf-8" target="_blank">
                                                        <label>搜索</label>
                                                <input name="s" type="hidden" value= null ><input type="text" class="st-default-search-input" name="q" size="30" placeholder="搜索"><br>
                                                </form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/26/ember散记/" title="ember散记" itemprop="url">ember散记</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-06-26T01:44:57.000Z" itemprop="datePublished"> 发表于 2016-06-26</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>主要是弄ambari的时候，ambari view使用了emberjs框架，自己按照官网教程走了一遍，此文章只是记录一些散记，不成系统。</p>
<h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><table>
<thead>
<tr>
<th>命令</th>
<th>解释</th>
<th>扩展</th>
</tr>
</thead>
<tbody>
<tr>
<td>ember g route xxx/contact</td>
<td>生成route handler</td>
<td>url里访问的路径xxx/contact会被定位到routes/xxx/contact.js下。生成template文件，route文件，对应的单元测试文件</td>
</tr>
<tr>
<td>ember g component list</td>
<td>生成一个component</td>
<td>位于templates/components文件夹下，可以被其他template以模块的形式引用。对应的js文件在根目录的components下</td>
</tr>
<tr>
<td>ember install ember-cli-tutorial-style</td>
<td>安装插件到当前项目</td>
<td>示例中的这个插件，会自动copy一些css文件到指定目录</td>
</tr>
<tr>
<td>ember g model rental</td>
<td>生成一个ember data model</td>
<td>在models文件夹下生成对应的model文件还有单元测试文件 </td>
</tr>
<tr>
<td>ember g helper rental-property-type</td>
<td>生成一个helper</td>
<td>在helpers文件夹下生成对应的js文件，还有单元测试文件</td>
</tr>
<tr>
<td>ember g controller index</td>
<td>生成一个controller</td>
<td>在controllers文件夹下生成对应js文件，单元测试文件</td>
</tr>
</tbody>
</table>
<h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><p>route handler中添加model方法，可以在template里直接使用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> Ember.Route.extend(&#123;</div><div class="line">  model() &#123;</div><div class="line">    <span class="keyword">return</span> rentals;            </div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>在template中的使用：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[[#each model as |rental|]]    </div><div class="line">  <span class="tag">&lt;<span class="name">article</span> <span class="attr">class</span>=<span class="string">"listing"</span>&gt;</span>    </div><div class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>[[rental.title]]<span class="tag">&lt;/<span class="name">h3</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail owner"</span>&gt;</span> </div><div class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>Owner:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.owner]]</div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail type"</span>&gt;</span>  </div><div class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>Type:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.type]]</div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail location"</span>&gt;</span>   </div><div class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>Location:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.city]]</div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail bedrooms"</span>&gt;</span>   </div><div class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>Number of bedrooms:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.bedrooms]]</div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">article</span>&gt;</span></div><div class="line">[[/each]]</div><div class="line">~</div></pre></td></tr></table></figure>
<h2 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h2><p>随着项目的创建，会在templates下自动生成一个application.js文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;h2&gt;title or slogin&lt;/h2&gt;</div><div class="line"></div><div class="line">[[outlet]]</div></pre></td></tr></table></figure></p>
<p>其中h2标题部分会在所有的模板中出现，[[outlet]]作为url中指定route handler的占位符。</p>
<h2 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h2><p>ember有自己的插件机制，可以自由发布与引用,个人感觉有点儿类似python module的感觉。</p>
<p><a href="https://emberobserver.com/" target="_blank" rel="external">https://emberobserver.com/</a></p>
<h2 id="Ember-data"><a href="#Ember-data" class="headerlink" title="Ember data"></a>Ember data</h2><p>使用ember g model rental生成模板文件models/rental.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Model <span class="keyword">from</span> <span class="string">'ember-data/model'</span>;</div><div class="line"><span class="keyword">import</span> attr <span class="keyword">from</span> <span class="string">'ember-data/attr'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> Model.extend(&#123;</div><div class="line">  <span class="attr">title</span>: attr(),</div><div class="line">  <span class="attr">owner</span>: attr(),</div><div class="line">  <span class="attr">city</span>: attr(),</div><div class="line">  <span class="attr">type</span>: attr(),</div><div class="line">  <span class="attr">image</span>: attr(),</div><div class="line">  <span class="attr">bedrooms</span>: attr()</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>上面就定义好了这个model的各个属性。下面是使用model了，在某个route handler中定义model函数，下面这个示例会使用GET方法调用/rentals<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Ember <span class="keyword">from</span> <span class="string">'ember'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> Ember.Route.extend(&#123;</div><div class="line">  model() &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.store.findAll(<span class="string">'rental'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>详情参考：<a href="https://guides.emberjs.com/v2.6.0/models/" target="_blank" rel="external">https://guides.emberjs.com/v2.6.0/models/</a></p>
<h2 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h2><p>就是component，可以被其他的template直接引用。它包含两部分：template和js。<br>template负责布局，js负责定义一些属性和action。</p>
<p>布局文件:templates/components/rental-listing.hbs<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">article</span> <span class="attr">class</span>=<span class="string">"listing"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">a</span> [[<span class="attr">action</span> '<span class="attr">toggleImageSize</span>']] <span class="attr">class</span>=<span class="string">"image [[if isWide "</span><span class="attr">wide</span>"]]"&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"[[rental.image]]"</span> <span class="attr">alt</span>=<span class="string">""</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">small</span>&gt;</span>View Larger<span class="tag">&lt;/<span class="name">small</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">h3</span>&gt;</span>[[rental.title]]<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail owner"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>Owner:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.owner]]</div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail type"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>Type:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.type]]</div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail location"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>Location:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.city]]</div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail bedrooms"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>Number of bedrooms:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.bedrooms]]</div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">article</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>交互文件：components/rental-listing.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Ember <span class="keyword">from</span> <span class="string">'ember'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> Ember.Component.extend(&#123;</div><div class="line">  <span class="attr">isWide</span>: <span class="literal">false</span>,</div><div class="line">  <span class="attr">actions</span>: &#123;</div><div class="line">    toggleImageSize() &#123;</div><div class="line">      <span class="keyword">this</span>.toggleProperty(<span class="string">'isWide'</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>可以看到isWide和actions属性与模板文件中的[[action ‘toggleImageSize’]]以及isWide变量对应。</p>
<h2 id="Handlebars-Helper"><a href="#Handlebars-Helper" class="headerlink" title="Handlebars Helper"></a>Handlebars Helper</h2><p>有的时候会在render到template之前对一些属性进行公共的处理啥的，就用到这个handlebar，为属性起装饰作用。<br>helpers/xxx.js文件：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Ember <span class="keyword">from</span> <span class="string">'ember'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> communityPropertyTypes = [</div><div class="line">  <span class="string">'Condo'</span>,</div><div class="line">  <span class="string">'Townhouse'</span>,</div><div class="line">  <span class="string">'Apartment'</span></div><div class="line">];</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">rentalPropertyType</span>(<span class="params">[type]<span class="regexp">/*, hash*/</span></span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (communityPropertyTypes.contains(type)) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">'Community'</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="string">'Standalone'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> Ember.Helper.helper(rentalPropertyType);</div></pre></td></tr></table></figure></p>
<p>在template文件中使用上面定义的rentalPropertyType方法。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span>Type:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental-property-type rental.type]] - [[rental.type]]</div></pre></td></tr></table></figure></p>
<p>这样在render模板的时候，就会把rental.type传入rentalPropertyType函数，处理后，返回相应的处理值。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/ember/">ember</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/23/python-debug/" title="python debug" itemprop="url">python debug</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-06-23T11:24:52.000Z" itemprop="datePublished"> 发表于 2016-06-23</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>今儿想着快些让hive view的java代码跟远程程序能够一起调试了，想要远程调试就得在远程ambari server启动的地方添加jdwp设置才行。</p>
<p>当我们安装好ambari-server之后，它默认是在/usr/sbin/ambari-server的一个shell文件，start命令导流到/usr/sbin/ambari-server.py脚本中。跟tomcat、jetty啥的不一样，并不提供静态的类似JAVA_OPTS之类的变量。ambari server是作为python脚本的子进程启动的，所以启动的参数都是通过python程序生成后执行的。自己沿着入口找了半天，越找越蒙圈，回头想了一下，还是debug来的更真实。</p>
<p>查下python的debug方式，最快能实施的就是使用<strong>pdb</strong>了。到ambari server的宿主机上开始进行调试。</p>
<h3 id="pdb基础"><a href="#pdb基础" class="headerlink" title="pdb基础"></a>pdb基础</h3><h5 id="设置断点"><a href="#设置断点" class="headerlink" title="设置断点"></a>设置断点</h5><p>在要调试的python文件import pdb，然后在断点代码的上方添加pdb.set_trace()<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> pdb</div><div class="line">....</div><div class="line"></div><div class="line">  options.exit_message = <span class="string">"Ambari Server '%s' completed successfully."</span> % action</div><div class="line">  options.exit_code = <span class="keyword">None</span></div><div class="line"></div><div class="line"></div><div class="line">  pdb.set_trace()</div><div class="line">  <span class="keyword">try</span>:</div><div class="line">    action_obj.execute()</div><div class="line"></div><div class="line">    <span class="keyword">if</span> action_obj.need_restart:</div><div class="line">      pstatus, pid = is_server_runing()</div><div class="line">      <span class="keyword">if</span> pstatus:</div><div class="line">        <span class="keyword">print</span> <span class="string">'NOTE: Restart Ambari Server to apply changes'</span> + \</div><div class="line">              <span class="string">' ("ambari-server restart|stop+start")'</span></div></pre></td></tr></table></figure></p>
<p>到命令行执行此python文件，到pdb.set_trace()的位置就会停下，跳出(pdb) </p>
<h5 id="pdb命令"><a href="#pdb命令" class="headerlink" title="pdb命令"></a>pdb命令</h5><table>
<thead>
<tr>
<th>命令</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>help</td>
<td>显示所有命令</td>
</tr>
<tr>
<td>n</td>
<td>继续执行</td>
</tr>
<tr>
<td>step</td>
<td>进入当前方法的方法块</td>
</tr>
<tr>
<td>c</td>
<td>忽略调试，继续执行</td>
</tr>
<tr>
<td>p</td>
<td>p str 打印某个对象</td>
</tr>
</tbody>
</table>
<p>我就用了以上命令，完成了对于ambari的调试。如果有其他的要求，可以逐个试一下。</p>
<h4 id="ambari调试过程"><a href="#ambari调试过程" class="headerlink" title="ambari调试过程"></a>ambari调试过程</h4><h5 id="设置断点-1"><a href="#设置断点-1" class="headerlink" title="设置断点"></a>设置断点</h5><p> 在ambari-server.py 引入pdb，在main方法上面添加pdb.set_trace()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">mainBody</span><span class="params">()</span>:</span></div><div class="line">  parser = optparse.OptionParser(usage=<span class="string">"usage: %prog [options] action [stack_id os]"</span>,)</div><div class="line">  init_parser_options(parser)</div><div class="line">  (options, args) = parser.parse_args()</div><div class="line"></div><div class="line">  pdb.set_trace()</div><div class="line"></div><div class="line">  <span class="comment"># check if only silent key set</span></div><div class="line">  default_options = parser.get_default_values()</div><div class="line">  silent_options = default_options</div><div class="line">  silent_options.silent = <span class="keyword">True</span></div><div class="line"></div><div class="line">  <span class="keyword">if</span> options == silent_options:</div><div class="line">    options.only_silent = <span class="keyword">True</span></div><div class="line">  <span class="keyword">else</span>:</div><div class="line">    options.only_silent = <span class="keyword">False</span></div><div class="line"></div><div class="line">  <span class="comment"># set verbose</span></div><div class="line">  set_verbose(options.verbose)</div><div class="line">  <span class="keyword">if</span> options.verbose:</div><div class="line">    main(options, args, parser)</div><div class="line"></div><div class="line">...</div></pre></td></tr></table></figure>
<h5 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h5><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div></pre></td><td class="code"><pre><div class="line">[root@data-test01 ~]# ambari-server start</div><div class="line">Using python  /usr/bin/python2</div><div class="line">Starting ambari-server</div><div class="line">&gt; /usr/sbin/ambari-server.py(584)main()</div><div class="line">-&gt; try:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(585)main()</div><div class="line">-&gt; action_obj.execute()</div><div class="line">(Pdb) step</div><div class="line">--Call--</div><div class="line">&gt; /usr/sbin/ambari-server.py(59)execute()</div><div class="line">-&gt; def execute(self):</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(60)execute()</div><div class="line">-&gt; self.fn(*self.args, **self.kwargs)</div><div class="line">(Pdb) p *self.args</div><div class="line">*** SyntaxError: SyntaxError('invalid syntax', ('&lt;string&gt;', 1, 1, '*self.args'))</div><div class="line">(Pdb) p self.args</div><div class="line">(&lt;Values at 0xfbee60: &#123;'only_silent': False, 'jdbc_driver': None, 'verbose': False, 'init_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-CREATE.sql', 'dbms': None, 'silent': False, 'warnings': [], 'exit_code': None, 'cluster_name': None, 'database_username': None, 'drop_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-DROP.sql', 'upgrade_script_file': '/var/lib/ambari-server/resources/upgrade/ddl/Ambari-DDL-Postgres-UPGRADE-1.3.0.sql', 'java_home': None, 'ldap_sync_existing': False, 'force_repo_version': False, 'debug': False, 'ldap_sync_groups': None, 'must_set_database_options': True, 'sqla_server_name': None, 'ldap_sync_users': None, 'database_name': None, 'jdbc_db': None, 'ldap_sync_all': False, 'upgrade_stack_script_file': '/var/lib/ambari-server/resources/upgrade/dml/Ambari-DML-Postgres-UPGRADE_STACK.sql', 'desired_repo_version': None, 'suspend_start': False, 'database_port': None, 'sid_or_sname': 'sname', 'database_password': None, 'exit_message': "Ambari Server 'start' completed successfully.", 'database_host': None, 'postgres_schema': None&#125;&gt;,)</div><div class="line">(Pdb) p self.kwargs</div><div class="line">&#123;&#125;</div><div class="line">(Pdb) step</div><div class="line">--Call--</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(82)thunk()</div><div class="line">-&gt; def thunk(*args, **kwargs):</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(83)thunk()</div><div class="line">-&gt; fn_id_base = func.__module__ + "." + func.__name__</div><div class="line">(Pdb) jn</div><div class="line">*** NameError: name 'jn' is not defined</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(84)thunk()</div><div class="line">-&gt; fn_id = fn_id_base + "." + OSCheck.get_os_family()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(85)thunk()</div><div class="line">-&gt; if fn_id not in self._func_impls:</div><div class="line">(Pdb) p fn_id</div><div class="line">'__main__.start.redhat'</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(86)thunk()</div><div class="line">-&gt; fn_id = fn_id_base + "." + OsFamilyImpl.DEFAULT</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(88)thunk()</div><div class="line">-&gt; fn = self._func_impls[fn_id]</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(89)thunk()</div><div class="line">-&gt; return fn(*args, **kwargs)</div><div class="line">(Pdb) p args</div><div class="line">(&lt;Values at 0xfbee60: &#123;'only_silent': False, 'jdbc_driver': None, 'verbose': False, 'init_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-CREATE.sql', 'dbms': None, 'silent': False, 'warnings': [], 'exit_code': None, 'cluster_name': None, 'database_username': None, 'drop_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-DROP.sql', 'upgrade_script_file': '/var/lib/ambari-server/resources/upgrade/ddl/Ambari-DDL-Postgres-UPGRADE-1.3.0.sql', 'java_home': None, 'ldap_sync_existing': False, 'force_repo_version': False, 'debug': False, 'ldap_sync_groups': None, 'must_set_database_options': True, 'sqla_server_name': None, 'ldap_sync_users': None, 'database_name': None, 'jdbc_db': None, 'ldap_sync_all': False, 'upgrade_stack_script_file': '/var/lib/ambari-server/resources/upgrade/dml/Ambari-DML-Postgres-UPGRADE_STACK.sql', 'desired_repo_version': None, 'suspend_start': False, 'database_port': None, 'sid_or_sname': 'sname', 'database_password': None, 'exit_message': "Ambari Server 'start' completed successfully.", 'database_host': None, 'postgres_schema': None&#125;&gt;,)</div><div class="line">(Pdb) p kwargs</div><div class="line">&#123;&#125;</div><div class="line">(Pdb) step</div><div class="line">--Call--</div><div class="line">&gt; /usr/sbin/ambari-server.py(103)start()</div><div class="line">-&gt; @OsFamilyFuncImpl(OsFamilyImpl.DEFAULT)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(105)start()</div><div class="line">-&gt; status, pid = is_server_runing()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(106)start()</div><div class="line">-&gt; if status:</div><div class="line">(Pdb) p status</div><div class="line">False</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(110)start()</div><div class="line">-&gt; server_process_main(args)</div><div class="line">(Pdb) p args</div><div class="line">&lt;Values at 0xfbee60: &#123;'only_silent': False, 'jdbc_driver': None, 'verbose': False, 'init_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-CREATE.sql', 'dbms': None, 'silent': False, 'warnings': [], 'exit_code': None, 'cluster_name': None, 'database_username': None, 'drop_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-DROP.sql', 'upgrade_script_file': '/var/lib/ambari-server/resources/upgrade/ddl/Ambari-DDL-Postgres-UPGRADE-1.3.0.sql', 'java_home': None, 'ldap_sync_existing': False, 'force_repo_version': False, 'debug': False, 'ldap_sync_groups': None, 'must_set_database_options': True, 'sqla_server_name': None, 'ldap_sync_users': None, 'database_name': None, 'jdbc_db': None, 'ldap_sync_all': False, 'upgrade_stack_script_file': '/var/lib/ambari-server/resources/upgrade/dml/Ambari-DML-Postgres-UPGRADE_STACK.sql', 'desired_repo_version': None, 'suspend_start': False, 'database_port': None, 'sid_or_sname': 'sname', 'database_password': None, 'exit_message': "Ambari Server 'start' completed successfully.", 'database_host': None, 'postgres_schema': None&#125;&gt;</div><div class="line">(Pdb) step</div><div class="line">--Call--</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(204)server_process_main()</div><div class="line">-&gt; def server_process_main(options, scmStatus=None):</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(206)server_process_main()</div><div class="line">-&gt; try:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(207)server_process_main()</div><div class="line">-&gt; set_debug_mode_from_options(options)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(211)server_process_main()</div><div class="line">-&gt; if not check_reverse_lookup():</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(216)server_process_main()</div><div class="line">-&gt; check_database_name_property()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(217)server_process_main()</div><div class="line">-&gt; parse_properties_file(options)</div><div class="line">(Pdb) p options</div><div class="line">&lt;Values at 0xfbee60: &#123;'only_silent': False, 'jdbc_driver': None, 'verbose': False, 'init_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-CREATE.sql', 'dbms': None, 'silent': False, 'warnings': [], 'exit_code': None, 'cluster_name': None, 'database_username': None, 'drop_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-DROP.sql', 'upgrade_script_file': '/var/lib/ambari-server/resources/upgrade/ddl/Ambari-DDL-Postgres-UPGRADE-1.3.0.sql', 'java_home': None, 'ldap_sync_existing': False, 'force_repo_version': False, 'debug': False, 'ldap_sync_groups': None, 'must_set_database_options': True, 'sqla_server_name': None, 'ldap_sync_users': None, 'database_name': None, 'jdbc_db': None, 'ldap_sync_all': False, 'upgrade_stack_script_file': '/var/lib/ambari-server/resources/upgrade/dml/Ambari-DML-Postgres-UPGRADE_STACK.sql', 'desired_repo_version': None, 'suspend_start': False, 'database_port': None, 'sid_or_sname': 'sname', 'database_password': None, 'exit_message': "Ambari Server 'start' completed successfully.", 'database_host': None, 'postgres_schema': None&#125;&gt;</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(219)server_process_main()</div><div class="line">-&gt; ambari_user = read_ambari_user()</div><div class="line">(Pdb) step</div><div class="line">--Call--</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverConfiguration.py(501)read_ambari_user()</div><div class="line">-&gt; def read_ambari_user():</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverConfiguration.py(505)read_ambari_user()</div><div class="line">-&gt; properties = get_ambari_properties()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverConfiguration.py(506)read_ambari_user()</div><div class="line">-&gt; if properties != -1:</div><div class="line">(Pdb) p properties</div><div class="line">&lt;ambari_server.properties.Properties object at 0xfe4910&gt;</div><div class="line">(Pdb) dir(properties)</div><div class="line">['_Properties__parse', '__class__', '__delattr__', '__dict__', '__doc__', '__format__', '__getattr__', '__getattribute__', '__getitem__', '__hash__', '__init__', '__module__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', '__weakref__', '_keymap', '_origprops', '_props', 'bspacere', 'fileName', 'getPropertyDict', 'get_property', 'load', 'othercharre', 'othercharre2', 'process_pair', 'propertyNames', 'removeOldProp', 'removeProp', 'sort_origprops', 'sort_props', 'store', 'store_ordered', 'unescape']</div><div class="line">(Pdb) type(properties)</div><div class="line">&lt;class 'ambari_server.properties.Properties'&gt;</div><div class="line">(Pdb) p properties fileName</div><div class="line">*** SyntaxError: SyntaxError('unexpected EOF while parsing', ('&lt;string&gt;', 1, 19, 'properties fileName'))</div><div class="line">(Pdb) p properties.fileName()</div><div class="line">*** TypeError: TypeError("'str' object is not callable",)</div><div class="line">(Pdb) p properties.fileName</div><div class="line">'/etc/ambari-server/conf/ambari.properties'</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverConfiguration.py(507)read_ambari_user()</div><div class="line">-&gt; user = properties[NR_USER_PROPERTY]</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverConfiguration.py(508)read_ambari_user()</div><div class="line">-&gt; if user:</div><div class="line">(Pdb) p user</div><div class="line">'root'</div><div class="line">(Pdb) p</div><div class="line">*** SyntaxError: SyntaxError('unexpected EOF while parsing', ('&lt;string&gt;', 0, 0, ''))</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverConfiguration.py(509)read_ambari_user()</div><div class="line">-&gt; return user</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverConfiguration.py(509)read_ambari_user()-&gt;'root'</div><div class="line">-&gt; return user</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(220)server_process_main()</div><div class="line">-&gt; current_user = ensure_can_start_under_current_user(ambari_user)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(222)server_process_main()</div><div class="line">-&gt; print_info_msg("Ambari Server is not running...")</div><div class="line">(Pdb) p current_user</div><div class="line">'root'</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(224)server_process_main()</div><div class="line">-&gt; jdk_path = find_jdk()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(225)server_process_main()</div><div class="line">-&gt; if jdk_path is None:</div><div class="line">(Pdb) p jdk_path</div><div class="line">'/server/java/jdk1.8.0_60'</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(231)server_process_main()</div><div class="line">-&gt; properties = get_ambari_properties()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(234)server_process_main()</div><div class="line">-&gt; if is_root():</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(235)server_process_main()</div><div class="line">-&gt; print configDefaults.MESSAGE_SERVER_RUNNING_AS_ROOT</div><div class="line">(Pdb) print configDefaults.MESSAGE_SERVER_RUNNING_AS_ROOT</div><div class="line">Ambari Server running with administrator privileges.</div><div class="line">(Pdb) n</div><div class="line">Ambari Server running with administrator privileges.</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(237)server_process_main()</div><div class="line">-&gt; ensure_jdbc_driver_is_installed(options, properties)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(239)server_process_main()</div><div class="line">-&gt; ensure_dbms_is_running(options, properties, scmStatus)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(241)server_process_main()</div><div class="line">-&gt; if scmStatus is not None:</div><div class="line">(Pdb) p scmStatus</div><div class="line">None</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(244)server_process_main()</div><div class="line">-&gt; refresh_stack_hash(properties)</div><div class="line">(Pdb) p properties</div><div class="line">&lt;ambari_server.properties.Properties object at 0xfe4e50&gt;</div><div class="line">(Pdb) step</div><div class="line">--Call--</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(85)refresh_stack_hash()</div><div class="line">-&gt; def refresh_stack_hash(properties):</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(86)refresh_stack_hash()</div><div class="line">-&gt; resources_location = get_resources_location(properties)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(87)refresh_stack_hash()</div><div class="line">-&gt; stacks_location = get_stack_location(properties)</div><div class="line">(Pdb) p resources_location</div><div class="line">'/var/lib/ambari-server/resources'</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(88)refresh_stack_hash()</div><div class="line">-&gt; resource_files_keeper = ResourceFilesKeeper(resources_location, stacks_location)</div><div class="line">(Pdb) p stacks_location</div><div class="line">'/var/lib/ambari-server/resources/stacks'</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(90)refresh_stack_hash()</div><div class="line">-&gt; try:</div><div class="line">(Pdb) p resource_files_keeper</div><div class="line">&lt;ambari_server.resourceFilesKeeper.ResourceFilesKeeper instance at 0x103c050&gt;</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(91)refresh_stack_hash()</div><div class="line">-&gt; print "Organizing resource files at &#123;0&#125;...".format(resources_location,</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(92)refresh_stack_hash()</div><div class="line">-&gt; verbose=get_verbose())</div><div class="line">(Pdb) n</div><div class="line">Organizing resource files at /var/lib/ambari-server/resources...</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(93)refresh_stack_hash()</div><div class="line">-&gt; resource_files_keeper.perform_housekeeping()</div><div class="line">(Pdb) p verbose</div><div class="line">*** NameError: NameError("name 'verbose' is not defined",)</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(93)refresh_stack_hash()-&gt;None</div><div class="line">-&gt; resource_files_keeper.perform_housekeeping()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(246)server_process_main()</div><div class="line">-&gt; if scmStatus is not None:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(249)server_process_main()</div><div class="line">-&gt; ensure_server_security_is_configured()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(251)server_process_main()</div><div class="line">-&gt; if scmStatus is not None:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(254)server_process_main()</div><div class="line">-&gt; java_exe = get_java_exe_path()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(256)server_process_main()</div><div class="line">-&gt; serverClassPath = ServerClassPath(properties, options)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(258)server_process_main()</div><div class="line">-&gt; debug_mode = get_debug_mode()</div><div class="line">(Pdb) p serverClassPath</div><div class="line">&lt;ambari_server.serverClassPath.ServerClassPath instance at 0x103cfc8&gt;</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(259)server_process_main()</div><div class="line">-&gt; debug_start = (debug_mode &amp; 1) or SERVER_START_DEBUG</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(260)server_process_main()</div><div class="line">-&gt; suspend_start = (debug_mode &amp; 2) or SUSPEND_START_MODE</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(261)server_process_main()</div><div class="line">-&gt; suspend_mode = 'y' if suspend_start else 'n'</div><div class="line">(Pdb) p debug_start</div><div class="line">False</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(263)server_process_main()</div><div class="line">-&gt; param_list = generate_child_process_param_list(ambari_user, java_exe,</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(264)server_process_main()</div><div class="line">-&gt; serverClassPath.get_full_ambari_classpath_escaped_for_shell(), debug_start,</div><div class="line">(Pdb) p param_list</div><div class="line">*** NameError: NameError("name 'param_list' is not defined",)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(265)server_process_main()</div><div class="line">-&gt; suspend_mode)</div><div class="line">(Pdb) p param_list</div><div class="line">*** NameError: NameError("name 'param_list' is not defined",)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(266)server_process_main()</div><div class="line">-&gt; environ = generate_env(options, ambari_user, current_user)</div><div class="line">(Pdb) p param_list</div><div class="line">['/bin/sh', '-c', "ulimit -n 10000 ; /server/java/jdk1.8.0_60/bin/java -server -XX:NewRatio=3 -XX:+UseConcMarkSweepGC -XX:-UseGCOverheadLimit -XX:CMSInitiatingOccupancyFraction=60 -Dsun.zip.disableMemoryMapping=true   -Xms512m -Xmx2048m -Djava.security.auth.login.config=/etc/ambari-server/conf/krb5JAASLogin.conf -Djava.security.krb5.conf=/etc/krb5.conf -Djavax.security.auth.useSubjectCredsOnly=false -cp '/etc/ambari-server/conf:/usr/lib/ambari-server/*:/usr/share/java/mysql-connector-java.jar' org.apache.ambari.server.controller.AmbariServer &gt; /var/log/ambari-server/ambari-server.out 2&gt;&amp;1 || echo $? &gt; /var/run/ambari-server/ambari-server.exitcode &amp;"]</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(268)server_process_main()</div><div class="line">-&gt; if not os.path.exists(configDefaults.PID_DIR):</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(271)server_process_main()</div><div class="line">-&gt; print_info_msg("Running server: " + str(param_list))</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(272)server_process_main()</div><div class="line">-&gt; procJava = subprocess.Popen(param_list, env=environ)</div><div class="line">(Pdb) p str(param_list)</div><div class="line">'[\'/bin/sh\', \'-c\', "ulimit -n 10000 ; /server/java/jdk1.8.0_60/bin/java -server -XX:NewRatio=3 -XX:+UseConcMarkSweepGC -XX:-UseGCOverheadLimit -XX:CMSInitiatingOccupancyFraction=60 -Dsun.zip.disableMemoryMapping=true   -Xms512m -Xmx2048m -Djava.security.auth.login.config=/etc/ambari-server/conf/krb5JAASLogin.conf -Djava.security.krb5.conf=/etc/krb5.conf -Djavax.security.auth.useSubjectCredsOnly=false -cp \'/etc/ambari-server/conf:/usr/lib/ambari-server/*:/usr/share/java/mysql-connector-java.jar\' org.apache.ambari.server.controller.AmbariServer &gt; /var/log/ambari-server/ambari-server.out 2&gt;&amp;1 || echo $? &gt; /var/run/ambari-server/ambari-server.exitcode &amp;"]'</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(274)server_process_main()</div><div class="line">-&gt; pidJava = procJava.pid</div><div class="line">(Pdb) p procJava.pid</div><div class="line">2216</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(275)server_process_main()</div><div class="line">-&gt; if pidJava &lt;= 0:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(288)server_process_main()</div><div class="line">-&gt; try:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(289)server_process_main()</div><div class="line">-&gt; os.setpgid(pidJava, 0)</div><div class="line">(Pdb) n</div><div class="line">OSError: (13, 'Permission denied')</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(289)server_process_main()</div><div class="line">-&gt; os.setpgid(pidJava, 0)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(290)server_process_main()</div><div class="line">-&gt; except OSError, e:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(291)server_process_main()</div><div class="line">-&gt; print_warning_msg('setpgid(&#123;0&#125;, 0) failed - &#123;1&#125;'.format(pidJava, str(e)))</div><div class="line">(Pdb) n</div><div class="line">WARNING: setpgid(2216, 0) failed - [Errno 13] Permission denied</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(292)server_process_main()</div><div class="line">-&gt; pass</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(293)server_process_main()</div><div class="line">-&gt; pidfile = os.path.join(configDefaults.PID_DIR, PID_NAME)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(294)server_process_main()</div><div class="line">-&gt; save_pid(pidJava, pidfile)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(295)server_process_main()</div><div class="line">-&gt; print "Server PID at: "+pidfile</div><div class="line">(Pdb) n</div><div class="line">Server PID at: /var/run/ambari-server/ambari-server.pid</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(296)server_process_main()</div><div class="line">-&gt; print "Server out at: "+configDefaults.SERVER_OUT_FILE</div><div class="line">(Pdb) n</div><div class="line">Server out at: /var/log/ambari-server/ambari-server.out</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(297)server_process_main()</div><div class="line">-&gt; print "Server log at: "+configDefaults.SERVER_LOG_FILE</div><div class="line">(Pdb) n</div><div class="line">Server log at: /var/log/ambari-server/ambari-server.log</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(299)server_process_main()</div><div class="line">-&gt; wait_for_server_start(pidfile, scmStatus)</div><div class="line">(Pdb) n</div><div class="line">Waiting for server start....................</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(301)server_process_main()</div><div class="line">-&gt; if scmStatus is not None:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(304)server_process_main()</div><div class="line">-&gt; return procJava</div><div class="line">(Pdb) p procJava</div><div class="line">&lt;subprocess.Popen object at 0x1038690&gt;</div><div class="line">(Pdb) dir(procJava)</div><div class="line">['__class__', '__del__', '__delattr__', '__dict__', '__doc__', '__format__', '__getattribute__', '__hash__', '__init__', '__module__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', '__weakref__', '_check_timeout', '_child_created', '_close_fds', '_communicate', '_communicate_with_poll', '_communicate_with_select', '_communication_started', '_execute_child', '_get_handles', '_handle_exitstatus', '_input', '_internal_poll', '_remaining_time', '_set_cloexec_flag', '_translate_newlines', 'communicate', 'kill', 'pid', 'poll', 'returncode', 'send_signal', 'stderr', 'stdin', 'stdout', 'terminate', 'universal_newlines', 'wait']</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(304)server_process_main()-&gt;&lt;subproc...x1038690&gt;</div><div class="line">-&gt; return procJava</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/sbin/ambari-server.py(110)start()-&gt;None</div><div class="line">-&gt; server_process_main(args)</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(89)thunk()-&gt;None</div><div class="line">-&gt; return fn(*args, **kwargs)</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/sbin/ambari-server.py(60)execute()-&gt;None</div><div class="line">-&gt; self.fn(*self.args, **self.kwargs)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(587)main()</div><div class="line">-&gt; if action_obj.need_restart:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(593)main()</div><div class="line">-&gt; if options.warnings:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(608)main()</div><div class="line">-&gt; if options.exit_message is not None:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(609)main()</div><div class="line">-&gt; print options.exit_message</div><div class="line">(Pdb) n</div><div class="line">Ambari Server 'start' completed successfully.</div><div class="line">&gt; /usr/sbin/ambari-server.py(611)main()</div><div class="line">-&gt; if options.exit_code is not None:  # not all actions may return a system exit code</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/sbin/ambari-server.py(611)main()-&gt;None</div><div class="line">-&gt; if options.exit_code is not None:  # not all actions may return a system exit code</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/sbin/ambari-server.py(635)mainBody()-&gt;None</div><div class="line">-&gt; main(options, args, parser)</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/sbin/ambari-server.py(644)&lt;module&gt;()-&gt;None</div><div class="line">-&gt; mainBody()</div><div class="line">(Pdb) n</div><div class="line">[root@data-test01 ~]# which ambari-server</div><div class="line">/usr/sbin/ambari-server</div><div class="line">[root@data-test01 ~]# vim /usr/sbin/ambari-server.py </div><div class="line">[root@data-test01 ~]#</div></pre></td></tr></table></figure>
<p>从以上debug堆栈中我们可以看到ambari-server启动过程中python脚本的所有准备工作。其中java进程的参数主要在ambari_server_main.py的server_process_main()的param_list中。</p>
<p>那么param_list来源在哪儿呢？ 是在server_process_main的子方法generate_child_process_param_list()中的command_base变量，SERVER_START_CMD_DEBUG或者SERVER_START_CMD的形式如下。</p>
<blockquote>
<p>{0} -server -XX:NewRatio=3 -XX:+UseConcMarkSweepGC -XX:-UseGCOverheadLimit -XX:CMSInitiatingOccupancyFraction=60 -Dsun.zip.disableMemoryMapping=true {1} {2} -cp {3} org.apache.ambari.server.controller.AmbariServer &gt; {4} 2&gt;&amp;1 || echo $? &gt; {5} &amp; </p>
</blockquote>
<p>可以看到留下了很多占位符。还是看一下generate_child_process_param_list的code吧<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@FamilyFuncImpl(OsFamilyImpl.DEFAULT)                                          </span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_child_process_param_list</span><span class="params">(ambari_user, java_exe, class_path,         </span></span></div><div class="line">                                      debug_start, suspend_mode):                </div><div class="line">  <span class="keyword">from</span> ambari_commons.os_linux <span class="keyword">import</span> ULIMIT_CMD                                 </div><div class="line">                                                                                 </div><div class="line">  properties = get_ambari_properties()                                           </div><div class="line">                                                                                 </div><div class="line">  command_base = SERVER_START_CMD_DEBUG <span class="keyword">if</span> debug_start <span class="keyword">else</span> SERVER_START_CMD     </div><div class="line">                                                                                 </div><div class="line">  ulimit_cmd = <span class="string">"%s %s"</span> % (ULIMIT_CMD, str(get_ulimit_open_files(properties)))    </div><div class="line">  command = command_base.format(java_exe,                                        </div><div class="line">          ambari_provider_module_option,                                         </div><div class="line">          jvm_args,                                                              </div><div class="line">          class_path,                                                            </div><div class="line">          configDefaults.SERVER_OUT_FILE,                                        </div><div class="line">          os.path.join(configDefaults.PID_DIR, EXITCODE_NAME),                   </div><div class="line">          suspend_mode)                                                          </div><div class="line">                                                                                 </div><div class="line">  <span class="comment"># required to start properly server instance                                   </span></div><div class="line">  os.chdir(configDefaults.ROOT_FS_PATH)                                          </div><div class="line">                                                                                 </div><div class="line">  <span class="comment">#For properly daemonization server should be started using shell as parent     </span></div><div class="line">  param_list = [locate_file(<span class="string">'sh'</span>, <span class="string">'/bin'</span>), <span class="string">"-c"</span>]                                 </div><div class="line">  <span class="keyword">if</span> is_root() <span class="keyword">and</span> ambari_user != <span class="string">"root"</span>:                                        </div><div class="line">    <span class="comment"># To inherit exported environment variables (especially AMBARI_PASSPHRASE),  </span></div><div class="line">    <span class="comment"># from subprocess, we have to skip --login option of su command. That's why  </span></div><div class="line">    <span class="comment"># we change dir to / (otherwise subprocess can face with 'permission denied' </span></div><div class="line">    <span class="comment"># errors while trying to list current directory                              </span></div><div class="line">    cmd = <span class="string">"&#123;ulimit_cmd&#125; ; &#123;su&#125; &#123;ambari_user&#125; -s &#123;sh_shell&#125; -c '&#123;command&#125;'"</span>.format(ulimit_cmd=ulimit_cmd, </div><div class="line">                                                                                su=locate_file(<span class="string">'su'</span>, <span class="string">'/bin'</span>), ambari_user=ambari_user,</div><div class="line">                                                                                sh_shell=locate_file(<span class="string">'sh'</span>, <span class="string">'/bin'</span>), command=command)</div><div class="line">  <span class="keyword">else</span>:                                                                          </div><div class="line">    cmd = <span class="string">"&#123;ulimit_cmd&#125; ; &#123;command&#125;"</span>.format(ulimit_cmd=ulimit_cmd, command=command)</div><div class="line">                                                                                 </div><div class="line">  param_list.append(cmd)                                                         </div><div class="line">  <span class="keyword">return</span> param_list</div></pre></td></tr></table></figure></p>
<p>这个方法把java进程的相关的东西全部拼进cmd，之后放进param_list，其中放了一个jvm_args的参数就是jvm参数了。在当前python文件中追溯此数据的来源：jvm_args = os.getenv(‘AMBARI_JVM_ARGS’, ‘-Xms512m -Xmx2048m’) ，所以它是一个环境变量。依赖eclipse的索引，搜一下哪个脚本里设置了这个环境变量：ambari-env.sh。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.ibm.com/developerworks/cn/linux/l-cn-pythondebugger/" target="_blank" rel="external">http://www.ibm.com/developerworks/cn/linux/l-cn-pythondebugger/</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/python/">python</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/20/ambari-view中文翻译/" title="ambari-views中文翻译" itemprop="url">ambari-views中文翻译</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-06-20T07:26:42.000Z" itemprop="datePublished"> 发表于 2016-06-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h2><p>ambari views可以在ambari-web中提供插件定制化的可视化、管理、监控等特性。</p>
<p>当用户添加了一个第三方的插件到ambari的时候，我们可以添加一个view来支持这个插件的UI，也就是说可以发布一个应用到ambari container里来。</p>
<p>每个view实例使用name和version来在ambari container里唯一标识自己。</p>
<p>Views in Ambari 是顶级的resource，并不直接跟cluster实例产生直接关联。</p>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p>官网的例子在ambari-views/examples.</p>
<h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><h3 id="View-Instances"><a href="#View-Instances" class="headerlink" title="View Instances"></a>View Instances</h3><p>一个view可以有多个实例，每个实例可能有各自不同的属性。</p>
<h3 id="View-Context"><a href="#View-Context" class="headerlink" title="View Context"></a>View Context</h3><p>view context让view componenets访问ambari container提供的运行时context。这个context会一直伴随这view实例，从出生到死亡。</p>
<p>一个view context可能会被container注入到多个不同的view componenet里去，比如resources, resource provider, servlets等。</p>
<p>context接口提供给view instance以下信息:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the current user name.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the current user name</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Determine whether or not the access specified by the given permission name</div><div class="line"> * is permitted for the given user.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> userName        the user name</div><div class="line"> * <span class="doctag">@param</span> permissionName  the permission name</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> SecurityException if the access specified by the given permission name</div><div class="line"> *         is not permitted</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hasPermission</span><span class="params">(String userName, String permissionName)</span> <span class="keyword">throws</span> SecurityException</span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the view name.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view name</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getViewName</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the view definition associated with this context.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view definition</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> ViewDefinition <span class="title">getViewDefinition</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the view instance name.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view instance name; null if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getInstanceName</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the view instance definition associated with this context.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view instance definition; null if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> ViewInstanceDefinition <span class="title">getViewInstanceDefinition</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the property values specified to create the view instance.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view instance property values; null if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">getProperties</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Save an instance data value for the given key.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key    the key</div><div class="line"> * <span class="doctag">@param</span> value  the value</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> IllegalStateException if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putInstanceData</span><span class="params">(String key, String value)</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the instance data value for the given key.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key  the key</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the instance data value; null if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getInstanceData</span><span class="params">(String key)</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the instance data values.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view instance property values; null if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">getInstanceData</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Remove the instance data value for the given key.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key  the key</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> IllegalStateException if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeInstanceData</span><span class="params">(String key)</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get a property for the given key from the ambari configuration.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key  the property key</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the property value; null indicates that the configuration contains no mapping for the key</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getAmbariProperty</span><span class="params">(String key)</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the view resource provider for the given resource type.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> type  the resource type</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the resource provider; null if no instance is associated</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> ResourceProvider&lt;?&gt; getResourceProvider(String type);</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get a URL stream provider.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> a stream provider</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> URLStreamProvider <span class="title">getURLStreamProvider</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get a data store for view persistence entities.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> a data store; null if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> DataStore <span class="title">getDataStore</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get all of the available view definitions.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view definitions</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;ViewDefinition&gt; <span class="title">getViewDefinitions</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get all of the available view instance definitions.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view instance definitions</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;ViewInstanceDefinition&gt; <span class="title">getViewInstanceDefinitions</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get a view controller associated with this context.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view controller</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> ViewController <span class="title">getController</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the HTTP Impersonator.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the HTTP Impersonator, which internally uses the App Cookie Manager</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> HttpImpersonator <span class="title">getHttpImpersonator</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the default settings for the Impersonator.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the Impersonator settings.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> ImpersonatorSetting <span class="title">getImpersonatorSetting</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure></p>
<h3 id="UI-Components"><a href="#UI-Components" class="headerlink" title="UI Components"></a>UI Components</h3><p>view包里可能包含一些web应用的组件，类似html或者javascript啥的。</p>
<h5 id="WEB-INF-web-xml"><a href="#WEB-INF-web-xml" class="headerlink" title="WEB-INF/web.xml"></a>WEB-INF/web.xml</h5><p>web.xml 是把view发布为一个web app的主要文件。  </p>
<p>例如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>HelloServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.apache.ambari.view.hello.HelloServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>HelloServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/ui<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></div></pre></td></tr></table></figure>
<h5 id="Servlets"><a href="#Servlets" class="headerlink" title="Servlets"></a>Servlets</h5><p>Servlets contained in a view archive will be deployed as part of the view and mapped as described in the web.xml.</p>
<p>在servlet的init方法中，可以view context当做一个servlet context使用。</p>
<p>例如:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">private</span> ViewContext viewContext;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig config)</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line">  <span class="keyword">super</span>.init(config);</div><div class="line"></div><div class="line">  ServletContext context = config.getServletContext();</div><div class="line">  viewContext = (ViewContext) context.getAttribute(ViewContext.CONTEXT_ATTRIBUTE);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>servlet可以使用view conetxt获取ambari container提供的一个信息。例如，在doGet()方法中，我们就可以使用view context instance访问当前的用户和view instance的属性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  response.setContentType(<span class="string">"text/html"</span>);</div><div class="line">  response.setStatus(HttpServletResponse.SC_OK);</div><div class="line"></div><div class="line">  PrintWriter writer = response.getWriter();</div><div class="line"></div><div class="line">  Map&lt;String, String&gt; properties = viewContext.getProperties();</div><div class="line"></div><div class="line">  String name = properties.get(<span class="string">"name"</span>);</div><div class="line">  <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</div><div class="line">    name = viewContext.getUsername();</div><div class="line">  &#125;</div><div class="line">  writer.println(<span class="string">"&lt;h1&gt;Hello "</span> + name + <span class="string">"!&lt;/h1&gt;"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h3><p>Resources一般不会暴露出来。resource都定义在view.xml里面。每个resource都需要指定名称和service class.</p>
<p>每个resource endpoint应该也可以被ambari api访问. <a href="#api">API</a>.</p>
<h5 id="Service-Class"><a href="#Service-Class" class="headerlink" title="Service Class"></a>Service Class</h5><p>service类使用JAX-RS注解来定义resource的endpoint。注意需要注入ViewContext.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Inject</span></div><div class="line">ViewContext context;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@see</span> org.apache.ambari.view.filebrowser.DownloadService</div><div class="line"> * <span class="doctag">@return</span> service</div><div class="line"> */</div><div class="line"><span class="meta">@Path</span>(<span class="string">"/download"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> DownloadService <span class="title">download</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> DownloadService(context);</div><div class="line">&#125;  </div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@see</span> org.apache.ambari.view.filebrowser.FileOperationService</div><div class="line"> * <span class="doctag">@return</span> service</div><div class="line"> */</div><div class="line"><span class="meta">@Path</span>(<span class="string">"/fileops"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> FileOperationService <span class="title">fileOps</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> FileOperationService(context);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Managed-Resources"><a href="#Managed-Resources" class="headerlink" title="Managed Resources"></a>Managed Resources</h4><p>managed resource是由ambari api框架管理的resource。除了name和service class之外，managed resource定义还需要plural name，resource class和provider class。 See <a href="#viewxml">view.xml</a>.</p>
<p>使用managed resource的好处是任何通过rest api访问的查询都可以使用ambari api框架的一些既有的特性，包括partial response, query predicates, pagination, sub-resource queries等。See <a href="#API">API</a>.</p>
<h5 id="Service-Class-1"><a href="#Service-Class-1" class="headerlink" title="Service Class"></a>Service Class</h5><p>service使用JAX-RS注解定义获取resource的action。</p>
<p>下面的例子展示了service class怎样将request代理给api框架处理。注意要注入ViewResourceHandler，我们使用它在api框架中传递control。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Inject</span></div><div class="line">ViewResourceHandler resourceHandler;</div><div class="line"></div><div class="line">…</div><div class="line"><span class="meta">@GET</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"&#123;scriptId&#125;"</span>)</div><div class="line"><span class="meta">@Produces</span>(MediaType.APPLICATION_JSON)</div><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">getScript</span><span class="params">(@Context HttpHeaders headers, @Context UriInfo ui,</span></span></div><div class="line">                          @PathParam(<span class="string">"scriptId"</span>) String scriptId) &#123;</div><div class="line">  <span class="keyword">return</span> resourceHandler.handleRequest(headers, ui, scriptId);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="Resource-Class"><a href="#Resource-Class" class="headerlink" title="Resource Class"></a>Resource Class</h5><p>resource class是一个包含属性和resource的JavaBean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PigScript</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> String id;</div><div class="line">  <span class="keyword">private</span> String title;</div><div class="line">  <span class="keyword">private</span> String pigScript;</div><div class="line">  <span class="keyword">private</span> String pythonScript;</div><div class="line">  <span class="keyword">private</span> String templetonArguments;</div><div class="line">  <span class="keyword">private</span> Date dateCreated;</div><div class="line">  <span class="keyword">private</span> String owner;</div><div class="line">  … </div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> id;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.id = id;</div><div class="line">  &#125;</div><div class="line">  …  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="Resource-Provider-Class"><a href="#Resource-Provider-Class" class="headerlink" title="Resource Provider Class"></a>Resource Provider Class</h5><p>Resource provider class实现ResourceProvider接口. 给ambari api框架提供访问resource的方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScriptResourceProvider</span> <span class="keyword">implements</span> <span class="title">ResourceProvider</span>&lt;<span class="title">PigScript</span>&gt; </span>&#123;</div><div class="line">  <span class="meta">@Inject</span></div><div class="line">  ViewContext viewContext;</div><div class="line"></div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> FileResource <span class="title">getResource</span><span class="params">(String resourceId, Set&lt;String&gt; propertyIds)</span> <span class="keyword">throws</span></span></div><div class="line">      SystemException, NoSuchResourceException, UnsupportedPropertyException &#123;</div><div class="line"></div><div class="line">    Map&lt;String, String&gt; properties = viewContext.getProperties();</div><div class="line"></div><div class="line">    String userScriptsPath = properties.get(<span class="string">"dataworker.userScriptsPath"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">return</span> getResource(resourceId, userScriptsPath, propertyIds);</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(<span class="string">"Can't get resource "</span> + resourceId + <span class="string">"."</span>, e);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  ... </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h3><p>administrator可以在任何view实例上设置VIEW.USE权限。  See <a href="#api">API</a>.</p>
<h3 id="定制权限"><a href="#定制权限" class="headerlink" title="定制权限"></a>定制权限</h3><p>编辑 view.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>RESTRICTED<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">label</span>&gt;</span>The Restricted View<span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>restricted<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">service-class</span>&gt;</span>org.apache.ambari.view.restricted.RestrictedResource<span class="tag">&lt;/<span class="name">service-class</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>unrestricted<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">service-class</span>&gt;</span>org.apache.ambari.view.restricted.UnrestrictedResource<span class="tag">&lt;/<span class="name">service-class</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">permission</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>RESTRICTED<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span></div><div class="line">      Access permission for a restricted view resource.</div><div class="line">    <span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">permission</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">instance</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>INSTANCE_1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">instance</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这个配置文件定义了一个叫做RESTRICTED的view，它有一个实例. 还定义了一个叫做RESTRICTED的权限，两个分别叫做 ‘unrestricted’和 ‘restricted’的resource.<br>administrator可以将RESTRICTED权限分配给任意的RESTRICTED view的实例。</p>
<p>view的实现代码使用了view context来验证我们定义的权限。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Inject</span></div><div class="line">ViewContext context;</div><div class="line"></div><div class="line"><span class="meta">@GET</span></div><div class="line"><span class="meta">@Produces</span>(&#123;<span class="string">"text/html"</span>&#125;)</div><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">getRestricted</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>&#123;</div><div class="line">    </div><div class="line">  String userName = context.getUsername();</div><div class="line">    </div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    context.hasPermission(userName, <span class="string">"RESTRICTED"</span>);</div><div class="line">  &#125; <span class="keyword">catch</span> (org.apache.ambari.view.SecurityException e) &#123;</div><div class="line">    <span class="keyword">return</span> Response.status(<span class="number">401</span>).build();</div><div class="line">  &#125;</div><div class="line">    </div><div class="line">  <span class="keyword">return</span> Response.ok(<span class="string">"&lt;b&gt;You have accessed a restricted resource.&lt;/b&gt;"</span>).type(<span class="string">"text/html"</span>).build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Impersonation"><a href="#Impersonation" class="headerlink" title="Impersonation"></a>Impersonation</h3><p>Views can utilize the viewContext to facilitate calls that require impersonating a user. For example, a service may expose an endpoint that accepts parameters like “doAs=johndoe” to perform some action on behalf of that user.<br>The HttpImpersonator Interface provides a contract for how to perform an HTTP GET request on a URL that supports some type of “doAs” parameter, and the username.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">HttpImpersonator impersonator = viewContext.getHttpImpersonator();</div><div class="line">ImpersonatorSetting impersonatorSetting = viewContext.getImpersonatorSetting();</div><div class="line">String result = impersonator.requestURL(urlToRead, <span class="string">"GET"</span>, impersonatorSetting);</div></pre></td></tr></table></figure></p>
<p>The ImpersonatorSetting class contains the variables that are added to the URL params. Its default constructor sets “doAs” as the default query parameter name, and the currently logged on user as its value; both of these can be changed with the overloaded constructors.</p>
<h3 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h3><p>应用的数据并不像view实例的属性一样，他们或许包含任意字符串，view需要把这些数据持久化，而且还提供更新以及查询。</p>
<p>view context包含从应用数据地图里put或者set数据的方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Save an instance data value for the given key.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key    the key</div><div class="line"> * <span class="doctag">@param</span> value  the value</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putInstanceData</span><span class="params">(String key, String value)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the instance data value for the given key.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key  the key</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the instance data value</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getInstanceData</span><span class="params">(String key)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the instance data values.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view instance property values</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">getInstanceData</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Remove the instance data value for the given key.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key  the key</div><div class="line"> */</div></pre></td></tr></table></figure></p>
<h5 id="DataStore"><a href="#DataStore" class="headerlink" title="DataStore"></a>DataStore</h5><p>data store 允许view instance存储javabean到ambari数据库里。</p>
<p>view组件先通过view context获取一个datastore的实例。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">      <span class="comment">/**</span></div><div class="line">       * Get a data store for view persistence entities.</div><div class="line">       *</div><div class="line">       * <span class="doctag">@return</span> a data store</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> DataStore <span class="title">getDataStore</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">The DataStore object exposes a simple <span class="class"><span class="keyword">interface</span> <span class="title">for</span> <span class="title">persisting</span> <span class="title">view</span> <span class="title">entities</span>.  <span class="title">The</span> <span class="title">basic</span> <span class="title">CRUD</span> <span class="title">operations</span> <span class="title">are</span> <span class="title">supported</span> …  </span></div><div class="line"></div><div class="line">      /**</div><div class="line">       * <span class="title">Save</span> <span class="title">the</span> <span class="title">given</span> <span class="title">entity</span> <span class="title">to</span> <span class="title">persistent</span> <span class="title">storage</span>.  <span class="title">The</span> <span class="title">entity</span> <span class="title">must</span> <span class="title">be</span> <span class="title">declared</span> <span class="title">as</span> <span class="title">an</span></div><div class="line">       * &lt;<span class="title">entity</span>&gt; <span class="title">in</span> <span class="title">the</span> &lt;<span class="title">persistence</span>&gt; <span class="title">element</span> <span class="title">of</span> <span class="title">the</span> <span class="title">view</span>.<span class="title">xml</span>.</div><div class="line">       *</div><div class="line">       * @<span class="title">param</span> <span class="title">entity</span>  <span class="title">the</span> <span class="title">entity</span> <span class="title">to</span> <span class="title">be</span> <span class="title">persisted</span>.</div><div class="line">       *</div><div class="line">       * @<span class="title">throws</span> <span class="title">PersistenceException</span> <span class="title">thrown</span> <span class="title">if</span> <span class="title">the</span> <span class="title">given</span> <span class="title">entity</span> <span class="title">can</span> <span class="title">not</span> <span class="title">be</span> <span class="title">persisted</span></div><div class="line">       */</div><div class="line">      <span class="title">public</span> <span class="title">void</span> <span class="title">store</span>(<span class="title">Object</span> <span class="title">entity</span>) <span class="title">throws</span> <span class="title">PersistenceException</span>;</div><div class="line">    </div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Remove the given entity from persistent storage.</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> entity  the entity to be removed.</div><div class="line">       *</div><div class="line">       * <span class="doctag">@throws</span> PersistenceException thrown if the given entity can not be removed</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(Object entity)</span> <span class="keyword">throws</span> PersistenceException</span>;</div><div class="line">    </div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Find the entity of the given class type that is uniquely identified by the</div><div class="line">       * given primary key.</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> clazz       the entity class</div><div class="line">       * <span class="doctag">@param</span> primaryKey  the primary key</div><div class="line">       * <span class="doctag">@param</span> &lt;T&gt;         the entity type</div><div class="line">       *</div><div class="line">       * <span class="doctag">@return</span> the entity; null if the entity can't be found</div><div class="line">       *</div><div class="line">       * <span class="doctag">@throws</span> PersistenceException thrown if an error occurs trying to find the entity</div><div class="line">       */</div><div class="line">      <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">find</span><span class="params">(Class&lt;T&gt; clazz, Object primaryKey)</span> <span class="keyword">throws</span> PersistenceException</span>;</div><div class="line">    </div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Find all the entities for the given where clause.  Specifying null for the where</div><div class="line">       * clause should return all entities of the given class type.</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> clazz        the entity class</div><div class="line">       * <span class="doctag">@param</span> whereClause  the where clause; may be null</div><div class="line">       * <span class="doctag">@param</span> &lt;T&gt;          the entity type</div><div class="line">       *</div><div class="line">       * <span class="doctag">@return</span> all of the entities for the given where clause; empty collection if no</div><div class="line">       *         entities can be found</div><div class="line">       *</div><div class="line">       * <span class="doctag">@throws</span> PersistenceException</div><div class="line">       */</div><div class="line">      <span class="keyword">public</span> &lt;T&gt; <span class="function">Collection&lt;T&gt; <span class="title">findAll</span><span class="params">(Class&lt;T&gt; clazz, String whereClause)</span> <span class="keyword">throws</span> PersistenceException</span>;</div></pre></td></tr></table></figure></p>
<p>每个entity被持久化之前，都应该已经在view.xml里定义过了。 See <a href="#viewxml">view.xml</a>.   </p>
<h3 id="Events"><a href="#Events" class="headerlink" title="Events"></a>Events</h3><h5 id="View生命周期Events"><a href="#View生命周期Events" class="headerlink" title="View生命周期Events"></a>View生命周期Events</h5><p>实现View接口之后，每个view都可以监控自己的生命周期。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">View</span> </span>&#123;</div><div class="line"></div><div class="line">  ...</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDeploy</span><span class="params">(ViewDefinition definition)</span></span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(ViewInstanceDefinition definition)</span></span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">(ViewInstanceDefinition definition)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>View实现类应该在view.xml文件里声明注册<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>FILES<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">label</span>&gt;</span>Files<span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">  ...</div><div class="line">  <span class="tag">&lt;<span class="name">view-class</span>&gt;</span>org.apache.ambari.view.filebrowser.ViewImpl<span class="tag">&lt;/<span class="name">view-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>View的实现类在注册过之后，它的对应方法会在任何生命周期event发生的时候被触发。</p>
<table>
<thead>
<tr>
<th>Event</th>
<th>描述</th>
<th>参数</th>
</tr>
</thead>
<tbody>
<tr>
<td>Deploy</td>
<td>The view has been successfully deployed.</td>
<td>The deployed view definition.</td>
</tr>
<tr>
<td>Create</td>
<td>An instance of the view has been created.</td>
<td>The new view instance definition.</td>
</tr>
<tr>
<td>Destroy</td>
<td>An instance of the view has been destroyed.</td>
<td>The destroyed view instance definition.</td>
</tr>
</tbody>
</table>
<h5 id="自定义event"><a href="#自定义event" class="headerlink" title="自定义event"></a>自定义event</h5><p>饿哦们也可以定义一些自定义事件。</p>
<h5 id="Listeners"><a href="#Listeners" class="headerlink" title="Listeners"></a>Listeners</h5><p>view需要写一个listener接口的实现，然后注册这个listener到view框架。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Listener</span> </span>&#123;</div><div class="line"></div><div class="line">  ...</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(Event event)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>listener的notify方法会在view发射一个event的时候被触发。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobsListener</span> <span class="keyword">implements</span> <span class="title">Listener</span> </span>&#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(Event event)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (event.getId().equals(<span class="string">"NEW_JOB"</span>)) &#123;</div><div class="line">      ViewInstanceDefinition instance = event.getViewInstanceSubject();         </div><div class="line">      ...</div><div class="line">    &#125;      </div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="ViewController"><a href="#ViewController" class="headerlink" title="ViewController"></a>ViewController</h5><p>ViewController用来注册listener，还有就是发射event。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ViewController</span> </span>&#123;</div><div class="line"></div><div class="line">  ...</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fireEvent</span><span class="params">(String eventId, Map&lt;String, String&gt; eventProperties)</span></span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerListener</span><span class="params">(Listener listener, String viewName)</span></span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregisterListener</span><span class="params">(Listener listener, String viewName)</span></span>;    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>view组件可以访问通过注入的view context来时用view controller。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">    <span class="meta">@Inject</span></div><div class="line">    ViewContext context;</div><div class="line"></div><div class="line">    ...</div><div class="line">    ViewController controller = context.getController();</div><div class="line">```    </div><div class="line"></div><div class="line"></div><div class="line">view component可以注册监听其他view发射的event。</div><div class="line">```java</div><div class="line">    <span class="meta">@Inject</span></div><div class="line">    ViewContext context;</div><div class="line"></div><div class="line">    ...</div><div class="line">    Listener listener = <span class="keyword">new</span> JobsListener();</div><div class="line"></div><div class="line">    ...</div><div class="line">    ViewController controller = context.getController();</div><div class="line">    controller.registerListener(listener, <span class="string">"JOBS"</span>);</div></pre></td></tr></table></figure></p>
<p>view component也可以发射自定义的view通知event.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Inject</span></div><div class="line">ViewContext context;</div><div class="line"></div><div class="line">...</div><div class="line">Map&lt;String, String&gt; jobEventProperties = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</div><div class="line"></div><div class="line">jobEventProperties.put(<span class="string">"JobId"</span>, jobId);</div><div class="line">jobEventProperties.put(<span class="string">"JobOwner"</span>, jobOwner);</div><div class="line"></div><div class="line">...</div><div class="line">ViewController controller = context.getController();</div><div class="line">controller.fireEvent(<span class="string">"NEW_JOB"</span>, jobEventProperties);</div></pre></td></tr></table></figure>
<h2 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h2><p>所有的view都应该打包，包含配置文件和不同的组件，比如resource和resource provider啥的，还有一些 html, JavaSript and servlets.</p>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><p>The view may include dependency classes and jars directly into the archive.  Classes should be included under <strong>WEB-INF/classes</strong>.  Jars should be included under <strong>WEB-INF/lib</strong>.</p>
<h3 id="view-xml"><a href="#view-xml" class="headerlink" title="view.xml"></a>view.xml</h3><table>
<thead>
<tr>
<th>元素</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>The unique view name (required).</td>
</tr>
<tr>
<td>label</td>
<td>The user facing name.</td>
</tr>
<tr>
<td>version</td>
<td>The view version (required).</td>
</tr>
<tr>
<td>description</td>
<td>The description of the view.</td>
</tr>
<tr>
<td>icon64</td>
<td>The 64x64 icon to display for this view. If this property is not set, the 32x32 sized icon will be used.</td>
</tr>
<tr>
<td>icon</td>
<td>The 32x32 icon to display for this view. Suggested size is 32x32 and will be displayed as 8x8 and 16x16 as necessary. If this property is not set, a default view framework icon is used.</td>
</tr>
<tr>
<td>system</td>
<td>Indicates whether or not this is a system view.  Default is false. </td>
</tr>
<tr>
<td>view-class</td>
<td>The View class to receive framework events. </td>
</tr>
<tr>
<td>masker-class</td>
<td>The Masker class for masking view parameters. </td>
</tr>
<tr>
<td>parameter</td>
<td>Defines a configuration parameter that is used to when creating a view instance. </td>
</tr>
<tr>
<td>resource</td>
<td>Describe a resources exposed by the view.</td>
</tr>
<tr>
<td>permission</td>
<td>Defines a custom permission for the view. </td>
</tr>
<tr>
<td>persistence</td>
<td>Describe a view entities for persistence. </td>
</tr>
<tr>
<td>instance</td>
<td>Define an instances of a view.</td>
</tr>
</tbody>
</table>
<h5 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h5><table>
<thead>
<tr>
<th>元素</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>The parameter name.</td>
</tr>
<tr>
<td>description</td>
<td>The parameter description.</td>
</tr>
<tr>
<td>required</td>
<td>Determines whether or not the parameter is required.</td>
</tr>
<tr>
<td>masked</td>
<td>Indicated this parameter value is to be “masked” in the Ambari Web UI (i.e. not shown in the clear). Omitting this element default to not-masked. Otherwise, if true, the parameter value will be “masked” in the Web UI.</td>
</tr>
</tbody>
</table>
<h5 id="resource"><a href="#resource" class="headerlink" title="resource"></a>resource</h5><table>
<thead>
<tr>
<th>元素</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>The resource name (i.e file).</td>
</tr>
<tr>
<td>plural-name</td>
<td>The parameter description (i.e. files). *</td>
</tr>
<tr>
<td>id-property</td>
<td>The id field of the managed resource class. *</td>
</tr>
<tr>
<td>resource-class</td>
<td>The class of the JavaBean that contains the attributes of a managed resource. *</td>
</tr>
<tr>
<td>provider-class</td>
<td>The class of the managed resource provider. *</td>
</tr>
<tr>
<td>service-class</td>
<td>The class of the JAX-RS annotated service resource.</td>
</tr>
<tr>
<td>sub-resource-name</td>
<td>The sub-resource name.</td>
</tr>
</tbody>
</table>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>files<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">service-class</span>&gt;</span>org.apache.ambari.view.filebrowser.FileBrowserService<span class="tag">&lt;/<span class="name">service-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line"></div><div class="line">\* only required for a managed resource.  For example ...</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>script<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">plural-name</span>&gt;</span>scripts<span class="tag">&lt;/<span class="name">plural-name</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">id-property</span>&gt;</span>id<span class="tag">&lt;/<span class="name">id-property</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">resource-class</span>&gt;</span>org.apache.ambari.view.pig.resources.scripts.models.PigScript<span class="tag">&lt;/<span class="name">resource-class</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">provider-class</span>&gt;</span>org.apache.ambari.view.pig.resources.scripts.ScriptResourceProvider<span class="tag">&lt;/<span class="name">provider-class</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">service-class</span>&gt;</span>org.apache.ambari.view.pig.resources.scripts.ScriptService<span class="tag">&lt;/<span class="name">service-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div></pre></td></tr></table></figure>
<h5 id="权限-1"><a href="#权限-1" class="headerlink" title="权限"></a>权限</h5><table>
<thead>
<tr>
<th>Element</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>The permission name.</td>
</tr>
<tr>
<td>description</td>
<td>The permission description.</td>
</tr>
</tbody>
</table>
<h5 id="持久化-1"><a href="#持久化-1" class="headerlink" title="持久化"></a>持久化</h5><table>
<thead>
<tr>
<th>Element</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>entity</td>
<td>An entity that may be persisted through the DataStore.</td>
</tr>
</tbody>
</table>
<h5 id="entity"><a href="#entity" class="headerlink" title="entity"></a>entity</h5><table>
<thead>
<tr>
<th>Element</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>class</td>
<td>The class ot the JavaBean that contains the attributes of an entity.</td>
</tr>
<tr>
<td>id-property</td>
<td>The id field of the entity.</td>
</tr>
</tbody>
</table>
<p>例子<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&lt;persistence&gt;</div><div class="line">  &lt;entity&gt;</div><div class="line">    &lt;<span class="class"><span class="keyword">class</span>&gt;<span class="title">org</span>.<span class="title">apache</span>.<span class="title">ambari</span>.<span class="title">view</span>.<span class="title">employee</span>.<span class="title">EmployeeEntity</span>&lt;/<span class="title">class</span>&gt;</span></div><div class="line">    &lt;<span class="title">id</span>-<span class="title">property</span>&gt;<span class="title">id</span>&lt;/<span class="title">id</span>-<span class="title">property</span>&gt;</div><div class="line">  &lt;/<span class="title">entity</span>&gt;</div><div class="line">  &lt;<span class="title">entity</span>&gt;</div><div class="line">    &lt;<span class="title">class</span>&gt;<span class="title">org</span>.<span class="title">apache</span>.<span class="title">ambari</span>.<span class="title">view</span>.<span class="title">employee</span>.<span class="title">AddressEntity</span>&lt;/<span class="title">class</span>&gt;</div><div class="line">    &lt;<span class="title">id</span>-<span class="title">property</span>&gt;<span class="title">id</span>&lt;/<span class="title">id</span>-<span class="title">property</span>&gt;</div><div class="line">  &lt;/<span class="title">entity</span>&gt;</div><div class="line">  &lt;<span class="title">entity</span>&gt;</div><div class="line">    &lt;<span class="title">class</span>&gt;<span class="title">org</span>.<span class="title">apache</span>.<span class="title">ambari</span>.<span class="title">view</span>.<span class="title">employee</span>.<span class="title">ProjectEntity</span>&lt;/<span class="title">class</span>&gt;</div><div class="line">    &lt;<span class="title">id</span>-<span class="title">property</span>&gt;<span class="title">id</span>&lt;/<span class="title">id</span>-<span class="title">property</span>&gt;</div><div class="line">  &lt;/<span class="title">entity</span>&gt;</div><div class="line">&lt;/<span class="title">persistence</span>&gt;</div></pre></td></tr></table></figure></p>
<h5 id="instance"><a href="#instance" class="headerlink" title="instance"></a>instance</h5><table>
<thead>
<tr>
<th>Element</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>The unique instance name (required).</td>
</tr>
<tr>
<td>label</td>
<td>The display label of the view instance. If not set, the view definition label is used.</td>
</tr>
<tr>
<td>description</td>
<td>The description of the view instance. If not set, the view definition description is used.</td>
</tr>
<tr>
<td>icon64</td>
<td>Overrides the view icon64 for this specific view instance.</td>
</tr>
<tr>
<td>icon</td>
<td>Overrides the view icon for this specific view instance.</td>
</tr>
<tr>
<td>visible</td>
<td>If true, for the view instance to show up in the users view instance list.  The default value is true.</td>
</tr>
<tr>
<td>property</td>
<td>Specifies configuration parameters values for the view instance.</td>
</tr>
</tbody>
</table>
<h5 id="property"><a href="#property" class="headerlink" title="property"></a>property</h5><table>
<thead>
<tr>
<th>Element</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>key</td>
<td>The property key (must match view parameter name).</td>
</tr>
<tr>
<td>value</td>
<td>The property value.</td>
</tr>
</tbody>
</table>
<p>完整的 view.xml例子<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>FILES<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>Files<span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">parameter</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dataworker.defaultFs<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>FileSystem URI<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">required</span>&gt;</span>true<span class="tag">&lt;/<span class="name">required</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parameter</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">parameter</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dataworker.username<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>The username (defaults to ViewContext username)<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">required</span>&gt;</span>false<span class="tag">&lt;/<span class="name">required</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parameter</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>files<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">service-class</span>&gt;</span>org.apache.ambari.view.filebrowser.FileBrowserService<span class="tag">&lt;/<span class="name">service-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">instance</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>FILES_1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>dataworker.defaultFs<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://<span class="tag">&lt;<span class="name">server</span>&gt;</span>:8020<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">instance</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这个例子中配置了一个叫FILES的view，也是有一个实例FILES_1。可以看到这个view有一个required的参数<strong>‘dataworker.defaultFs’</strong>以及一个optional参数<strong>‘dataworker.username’</strong>.  还有一个访问资源的入口<strong>‘files’</strong>. </p>
<h2 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h2><p>要发布一个view，只需要将view的包放到ambari-server的views文件夹下，默认是在</p>
<pre><code>/var/lib/ambari-server/resources/views
</code></pre><h3 id="解压包"><a href="#解压包" class="headerlink" title="解压包"></a>解压包</h3><p>view被发布之后，会自动在views文件夹下解压包。默认位置是:</p>
<pre><code>/var/lib/ambari-server/resources/views/work/:viewName{:viewVersion}
</code></pre><p>例如，上面例子中的files view解压后目录就是：</p>
<pre><code>/var/lib/ambari-server/resources/views/work/FILES{0.1.0}
</code></pre><p>用户可以直接修改解压后的文件，在ambari下次启动的时候就可以生效了。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><h5 id="Get-Views"><a href="#Get-Views" class="headerlink" title="Get Views"></a>Get Views</h5><p>获取所有已经发布的view。注意view是顶级resource，不属于任何其他resource。</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/

{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/&quot;,
  &quot;items&quot; : [
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES&quot;,
      &quot;ViewInfo&quot; : {
        &quot;view_name&quot; : &quot;FILES&quot;
      }
    },
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/HELLO_WORLD&quot;,
      &quot;ViewInfo&quot; : {
        &quot;view_name&quot; : &quot;HELLO_WORLD&quot;
      }
    }
  ]
}
</code></pre><h5 id="Get-View"><a href="#Get-View" class="headerlink" title="Get View"></a>Get View</h5><p>根据名称获取指定view，返回所有版本.</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/FILES/

{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/&quot;,
  &quot;ViewInfo&quot; : {
    &quot;view_name&quot; : &quot;FILES&quot;
  },
  &quot;versions&quot; : [
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0&quot;,
      &quot;ViewVersionInfo&quot; : {
        &quot;version&quot; : &quot;0.1.0&quot;,
        &quot;view_name&quot; : &quot;FILES&quot;
      }
    }
  ]
}
</code></pre><h5 id="Get-Versions"><a href="#Get-Versions" class="headerlink" title="Get Versions"></a>Get Versions</h5><p>获取一个view 的所有版本.</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/FILES/versions/

{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/&quot;,
  &quot;items&quot; : [
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0&quot;,
      &quot;ViewVersionInfo&quot; : {
        &quot;version&quot; : &quot;0.1.0&quot;,
        &quot;view_name&quot; : &quot;FILES&quot;
      }
    }
  ]
}
</code></pre><h5 id="Get-Version"><a href="#Get-Version" class="headerlink" title="Get Version"></a>Get Version</h5><p>获取某view的指定版本以及此版本下的所有实例.</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/

{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/&quot;,
  &quot;ViewVersionInfo&quot; : {
    &quot;archive&quot; : &quot;/var/lib/ambari-server/resources/views/work/FILES{0.1.0}&quot;,
    &quot;label&quot; : &quot;Files&quot;,
    &quot;parameters&quot; : [
      {
        &quot;name&quot; : &quot;dataworker.defaultFs&quot;,
        &quot;description&quot; : &quot;FileSystem URI&quot;,
        &quot;required&quot; : true
      },
      {
        &quot;name&quot; : &quot;dataworker.username&quot;,
        &quot;description&quot; : &quot;The username (defaults to ViewContext username)&quot;,
        &quot;required&quot; : false
      }
    ],
    &quot;version&quot; : &quot;0.1.0&quot;,
    &quot;view_name&quot; : &quot;FILES&quot;
  },
  &quot;instances&quot; : [
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_1&quot;,
      &quot;ViewInstanceInfo&quot; : {
        &quot;instance_name&quot; : &quot;FILES_1&quot;,
        &quot;version&quot; : &quot;0.1.0&quot;,
        &quot;view_name&quot; : &quot;FILES&quot;
      }
    }
  ]
}
</code></pre><h5 id="Get-Instances"><a href="#Get-Instances" class="headerlink" title="Get Instances"></a>Get Instances</h5><p>获取一个view 的所有实例.</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/

{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/&quot;,
  &quot;items&quot; : [
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_1&quot;,
      &quot;ViewInstanceInfo&quot; : {
        &quot;instance_name&quot; : &quot;FILES_1&quot;,
        &quot;version&quot; : &quot;0.1.0&quot;,
        &quot;view_name&quot; : &quot;FILES&quot;
      }
    }
  ]
}
</code></pre><h5 id="获取实例"><a href="#获取实例" class="headerlink" title="获取实例"></a>获取实例</h5><p>根据实例名称获取实例，此实例的所有resource也会被返回。</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_1

{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_1&quot;,
  &quot;ViewInstanceInfo&quot; : {
    &quot;context_path&quot; : &quot;/views/FILES/0.1.0/FILES_1&quot;,
    &quot;instance_name&quot; : &quot;FILES_1&quot;,
    &quot;version&quot; : &quot;0.1.0&quot;,
    &quot;view_name&quot; : &quot;FILES&quot;,
    &quot;instance_data&quot; : { },
    &quot;properties&quot; : {
      &quot;dataworker.defaultFs&quot; : &quot;hdfs://&lt;server&gt;:8020&quot;
    }
  },
  &quot;resources&quot; : [
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_1/resources/files&quot;,
      &quot;instance_name&quot; : &quot;FILES_1&quot;,
      &quot;name&quot; : &quot;files&quot;,
      &quot;version&quot; : &quot;0.1.0&quot;,
      &quot;view_name&quot; : &quot;FILES&quot;
    }
  ]
}
</code></pre><h5 id="创建实例"><a href="#创建实例" class="headerlink" title="创建实例"></a>创建实例</h5><pre><code>POST http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_2
</code></pre><h5 id="更新实例"><a href="#更新实例" class="headerlink" title="更新实例"></a>更新实例</h5><pre><code>PUT http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_2
[{
  &quot;ViewInstanceInfo&quot; : {
      &quot;properties&quot; : {
        &quot;dataworker.defaultFs&quot; : &quot;hdfs://MyServer:8020&quot;
      }
    }
}]
</code></pre><h5 id="删除实例"><a href="#删除实例" class="headerlink" title="删除实例"></a>删除实例</h5><pre><code>DELETE http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_2
</code></pre><h5 id="Resources-1"><a href="#Resources-1" class="headerlink" title="Resources"></a>Resources</h5><p>A view resource may be accessed through the REST API.  The href for each view resource can be found in a request for the parent view instance.  The resource endpoints and behavior depends on the implementation of the JAX-RS annotated service class specified for the resource element in the view.xml. </p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_1/resources/files/fileops/listdir?path=%2F

[{&quot;path&quot;:&quot;/app-logs&quot;,&quot;replication&quot;:0,&quot;isDirectory&quot;:true,&quot;len&quot;:0,&quot;owner&quot;:&quot;yarn&quot;,&quot;group&quot;:&quot;hadoop&quot;,&quot;permission&quot;:&quot;-rwxrwxrwx&quot;,&quot;accessTime&quot;:0,&quot;modificationTime&quot;:1400006792122,&quot;blockSize&quot;:0},{&quot;path&quot;:&quot;/mapred&quot;,&quot;replication&quot;:0,&quot;isDirectory&quot;:true,&quot;len&quot;:0,&quot;owner&quot;:&quot;mapred&quot;,&quot;group&quot;:&quot;hdfs&quot;,&quot;permission&quot;:&quot;-rwxr-xr-x&quot;,&quot;accessTime&quot;:0,&quot;modificationTime&quot;:1400006653817,&quot;blockSize&quot;:0},{&quot;path&quot;:&quot;/mr-history&quot;,&quot;replication&quot;:0,&quot;isDirectory&quot;:true,&quot;len&quot;:0,&quot;owner&quot;:&quot;hdfs&quot;,&quot;group&quot;:&quot;hdfs&quot;,&quot;permission&quot;:&quot;-rwxr-xr-x&quot;,&quot;accessTime&quot;:0,&quot;modificationTime&quot;:1400006653822,&quot;blockSize&quot;:0},{&quot;path&quot;:&quot;/tmp&quot;,&quot;replication&quot;:0,&quot;isDirectory&quot;:true,&quot;len&quot;:0,&quot;owner&quot;:&quot;hdfs&quot;,&quot;group&quot;:&quot;hdfs&quot;,&quot;permission&quot;:&quot;-rwxrwxrwx&quot;,&quot;accessTime&quot;:0,&quot;modificationTime&quot;:1400006720415,&quot;blockSize&quot;:0},{&quot;path&quot;:&quot;/user&quot;,&quot;replication&quot;:0,&quot;isDirectory&quot;:true,&quot;len&quot;:0,&quot;owner&quot;:&quot;hdfs&quot;,&quot;group&quot;:&quot;hdfs&quot;,&quot;permission&quot;:&quot;-rwxr-xr-x&quot;,&quot;accessTime&quot;:0,&quot;modificationTime&quot;:1400006610050,&quot;blockSize&quot;:0}]
</code></pre><h5 id="Managed-Resources-1"><a href="#Managed-Resources-1" class="headerlink" title="Managed Resources"></a>Managed Resources</h5><p>Any managed resources for a view may also be accessed through the REST API.  Note that instances of a managed resource appear as sub-resources of an instance under the plural name specified for the resource in the view.xml.  In this example, a list of managed resources named <strong>‘scripts’</strong> is included in the response for the view instance … </p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/PIG/versions/0.1.0/instances/INSTANCE_1

{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/PIG/versions/0.1.0/instances/INSTANCE_1&quot;,
  &quot;ViewInstanceInfo&quot; : {
    &quot;context_path&quot; : &quot;/views/PIG/0.1.0/INSTANCE_1&quot;,
    &quot;instance_name&quot; : &quot;INSTANCE_1&quot;,
    &quot;version&quot; : &quot;0.1.0&quot;,
    &quot;view_name&quot; : &quot;PIG&quot;,
    &quot;instance_data&quot; : { },
    &quot;properties&quot; : {
      … 
    }
  },
  &quot;resources&quot; : [ ],
  &quot;scripts&quot; : [
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/PIG/versions/0.1.0/instances/INSTANCE_1/scripts/script1&quot;,
      &quot;id&quot; : &quot;script1&quot;,
      &quot;instance_name&quot; : &quot;INSTANCE_1&quot;,
      &quot;version&quot; : &quot;0.1.0&quot;,
      &quot;view_name&quot; : &quot;PIG&quot;
    },
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/INSTANCE_1/scripts/script2&quot;,
      &quot;id&quot; : &quot;script2&quot;,
      &quot;instance_name&quot; : &quot;INSTANCE_1&quot;,
      &quot;version&quot; : &quot;0.1.0&quot;,
      &quot;view_name&quot; : &quot;PIG&quot;
    },
    …
  ]
}
</code></pre><p>获取单个managed resource …</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/PIG/versions/0.1.0/instances/INSTANCE_1/scripts/script1


{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/PIG/versions/0.1.0/instances/INSTANCE_1/scripts/script1&quot;,
  &quot;id&quot; : &quot;script1&quot;,      
  &quot;pigScript&quot; : &quot;… &quot;,
  &quot;pythonScript&quot; : &quot;… &quot;,
  &quot;templetonArguments&quot; : &quot;… &quot;,
  &quot;dateCreated&quot; : … ,
  &quot;owner&quot; : &quot;… &quot;,
  &quot;instance_name&quot; : &quot;INSTANCE_1&quot;,
  &quot;version&quot; : &quot;0.1.0&quot;,
  &quot;view_name&quot; : &quot;PIG&quot;
}
</code></pre><p>由于resource是被ambari api框架管理的，也可以使用partial response和query predicate。</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/PIG/versions/0.1.0/instances/INSTANCE_1/scripts?fields=pythonScript&amp;owner=jsmith
</code></pre><h5 id="设置view权限"><a href="#设置view权限" class="headerlink" title="设置view权限"></a>设置view权限</h5><p>To grant privileges to access the restricted resource we can create a privilege sub-resource for the view instance.  The following API will grant RESTICTED permission to the user ‘bob’ for the view instance ‘INSTANCE_1’ of the ‘RESTRICTED’ view. </p>
<pre><code>POST http://&lt;server&gt;/api/v1/views/RESTRICTED/versions/1.0.0/instances/INSTANCE_1

[
  {
    &quot;PrivilegeInfo&quot; : {
      &quot;permission_name&quot; : &quot;RESTRICTED&quot;,
      &quot;principal_name&quot; : &quot;bob&quot;,
      &quot;principal_type&quot; : &quot;USER&quot;
    }
  }
]
</code></pre><h5 id="查询view权限"><a href="#查询view权限" class="headerlink" title="查询view权限"></a>查询view权限</h5><p>We can see a privilege sub resource for a view instance.</p>
<pre><code>GET  http://&lt;server&gt;/api/v1/views/RESTRICTED/versions/1.0.0/instances/INSTANCE_1/privileges/5


{
  &quot;href&quot; : &quot;http://&lt;server&gt;/api/v1/views/RESTRICTED/versions/1.0.0/instances/INSTANCE_1/privileges/5&quot;,
  &quot;PrivilegeInfo&quot; : {
    &quot;instance_name&quot; : &quot;INSTANCE_1&quot;,
    &quot;permission_name&quot; : &quot;RESTRICTED&quot;,
    &quot;principal_name&quot; : &quot;bob&quot;,
    &quot;principal_type&quot; : &quot;USER&quot;,
    &quot;privilege_id&quot; : 5,
    &quot;version&quot; : &quot;1.0.0&quot;,
    &quot;view_name&quot; : &quot;RESTRICTED&quot;
  }
}
</code></pre><h3 id="View-UI"><a href="#View-UI" class="headerlink" title="View UI"></a>View UI</h3><p>The context root of a view instance is …</p>
<pre><code>/views/:viewName/:viewVersion/:viewInstance/
</code></pre><p>For example, the context root can be found in the response for a view instance … </p>
<p><img src="instance_response.png" alt="image"></p>
<p>So, to access the UI of the above Files view the user would browse to …</p>
<pre><code>http://&lt;server&gt;:8080/views/FILES/0.1.0/FILES_1/  
</code></pre><p><img src="ui.png" alt="image"></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/ambari/">ambari</a><a href="/tags/源码/">源码</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/20/ambari-web解读（一）-请求流程/" title="ambari-web解读（一）-请求流程" itemprop="url">ambari-web解读（一）-请求流程</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-06-20T07:26:42.000Z" itemprop="datePublished"> 发表于 2016-06-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>最近为公司选型了大数据维护工具ambari，官网:ambari.apache.org。主要是为了运维方便一些。<br>另外对于数据分析人员开放了一个hive view页面，提供提数支持。但是对于原始的hive view，我们有些不满意的地方：</p>
<ol>
<li>table的comment没有展示完全</li>
<li>后台一直在每15秒钟请求一次后台hiveserver。虽然这并不会对和iveserver造成很大压力，但是感觉不友好，产生很多垃圾log。</li>
</ol>
<p>经过差不多一周左右断断续续地探查与学习，基本弄清楚了ambari-web的请求处理脉路。可能对nodejs大神来说这不算啥，但是个人感觉稍微有点儿吃力。学习了一下nodejs的新的工具ember.js。</p>
<h3 id="1"><a href="#1" class="headerlink" title="1."></a>1.</h3><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><table>
<thead>
<tr>
<th>链接</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/emberjs/starter-kit/" target="_blank" rel="external">https://github.com/emberjs/starter-kit/</a></td>
<td>学习ember.js的基础项目</td>
</tr>
<tr>
<td><a href="http://www.html-js.com/article/1685" target="_blank" rel="external">http://www.html-js.com/article/1685</a></td>
<td>Ember.js Application Development How-to的中文翻译</td>
</tr>
<tr>
<td><a href="http://www.ruanyifeng.com/blog/2011/08/a_detailed_explanation_of_jquery_deferred_object.html" target="_blank" rel="external">http://www.ruanyifeng.com/blog/2011/08/a_detailed_explanation_of_jquery_deferred_object.html</a></td>
<td>对于jquery回调工具deferred的解释</td>
</tr>
</tbody>
</table>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/ambari/">ambari</a><a href="/tags/源码/">源码</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/17/一步步搞定ETL依赖调度平台（三）-调度优先级思考/" title="一步步搞定ETL依赖调度平台（三）-调度优先级思考" itemprop="url">一步步搞定ETL依赖调度平台（三）-调度优先级思考</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-06-17T03:21:50.000Z" itemprop="datePublished"> 发表于 2016-06-17</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>从《azkaban源码追踪（三）-上传zip的坑》可以看到azkaban本身的调度基本是广度优先执行的。</p>
<h3 id="1-猎聘"><a href="#1-猎聘" class="headerlink" title="1.猎聘"></a>1.猎聘</h3><p><img src="/imgs/azkaban/schedule-lp-tree.png" alt="猎聘的调度tree"></p>
<p>优先级生成策略是从叶子节点向上遍历，每个节点的优先级=所有子节点优先级+edge数(也就是子节点数)。其实思想就是谁下面的小弟多，谁的优先级就越大。</p>
<p>但这通常并不完全适用于对于指定的单个叶子节点最优先的需求，极端点儿想的话，可能出现老的ETL有100多个相关成一个flow，可是新增的优先级特别高的需求super_etl在另一个只有1个节点的flow，或者在同一个flow，但是它没有小弟（这种其实蛮常见的）。那么super_etl的默认priority是1，根本没有地位！！！</p>
<blockquote>
<p>LP的人说了：我们可以给它人工指定优先级啊！<br>额。。。。是的，但是其他的tree是在一直生长的，按照你们的策略来看，这个super_etl的优先级要一直改变。<br>LP的人又说了：我们可以动态指定！<br>额。。。。是的，但是后面出现了super_etl01,super_etl02的时候，可能就会特别特别麻烦了。</p>
</blockquote>
<p>再看一下，计划顺序与实际执行顺序的对比。本来C的优先级是比B高的，可猎聘给出的实际执行却是先执行B后执行c，音频中苏总说是并发问题，个人看来稍稍有些含糊其辞了。推测猎聘的实际调度的时候并不完全以priority为指导，而仍然是azkaban广度遍历优先，同一个level之内才是priority优先执行。</p>
<p>参考:<a href="http://mp.weixin.qq.com/s?src=3&amp;timestamp=1466131251&amp;ver=1&amp;signature=YfS7PgVR0SjjLt4KwIQ297t4SDiLrrJu5C7uuMXpkCvuhvjXk-DU*eJGfIBSfjDm-WlVuwaIbGtbfda-k-5rRgUewAlvjSUQBBNY4jnjuvQD1puqdaVzUqIq9ds*x1r-6dUnU6OiSERzBt5UWfjdUkekpmc7hNqTm1pklClkSkE=" target="_blank" rel="external">http://mp.weixin.qq.com/s?src=3&amp;timestamp=1466131251&amp;ver=1&amp;signature=YfS7PgVR0SjjLt4KwIQ297t4SDiLrrJu5C7uuMXpkCvuhvjXk-DU*eJGfIBSfjDm-WlVuwaIbGtbfda-k-5rRgUewAlvjSUQBBNY4jnjuvQD1puqdaVzUqIq9ds*x1r-6dUnU6OiSERzBt5UWfjdUkekpmc7hNqTm1pklClkSkE=</a></p>
<h3 id="2-美团"><a href="#2-美团" class="headerlink" title="2.美团"></a>2.美团</h3><p><img src="/imgs/azkaban/schedule-mt-tree.png" alt="美团的调度tree"></p>
<p>调度策略就不该是递归调度，而应该完全按照优先级别去调度。想来想去，这才是真正的优先级调度。东家靠谱儿！</p>
<p>参考：<a href="http://mp.weixin.qq.com/s?src=3&amp;timestamp=1466131231&amp;ver=1&amp;signature=YfS7PgVR0SjjLt4KwIQ297t4SDiLrrJu5C7uuMXpkCtKEZcZ58gspxJhkgDlgXAkqQvXpI3IbmE4HzkI33W*4PJCOUoKyzSna56Q8uSQgUNnSl7vsxqLcREVfDBU0nPguiAiwnosiXyE9wB7T-edr3QrRn8rKMhB3oxjQDrS1RQ=" target="_blank" rel="external">http://mp.weixin.qq.com/s?src=3&amp;timestamp=1466131231&amp;ver=1&amp;signature=YfS7PgVR0SjjLt4KwIQ297t4SDiLrrJu5C7uuMXpkCtKEZcZ58gspxJhkgDlgXAkqQvXpI3IbmE4HzkI33W*4PJCOUoKyzSna56Q8uSQgUNnSl7vsxqLcREVfDBU0nPguiAiwnosiXyE9wB7T-edr3QrRn8rKMhB3oxjQDrS1RQ=</a></p>
<p>综上：后面本人要开发的调度系统优先级策略会借用美团的思想。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/ETL/">ETL</a><a href="/tags/调度平台/">调度平台</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/16/azkaban源码追踪（三）-上传zip的坑/" title="azkaban源码追踪（三）-上传zip的坑" itemprop="url">azkaban源码追踪（三）-上传zip的坑</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-06-16T11:16:06.000Z" itemprop="datePublished"> 发表于 2016-06-16</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>前面其实已经解析了上传zip文件到azkaban的流程，但是自己都感觉写的实在是太操蛋了。</p>
<h3 id="1-时序图"><a href="#1-时序图" class="headerlink" title="1. 时序图"></a>1. 时序图</h3><p><img src="/imgs/azkaban/azkaban-atash-sequence-diagram.png" alt="上传zip文件的时序图"></p>
<h3 id="2-坑的表现"><a href="#2-坑的表现" class="headerlink" title="2. 坑的表现"></a>2. 坑的表现</h3><p>ETL的依赖关系肯定的多父多子的，所以就上传了一个典型到azkaban上。结果被分成了两个flow</p>
<p><img src="/imgs/azkaban/azkaban-two-wrong-flow.png" alt="拥有相关ETL的flow被分成了两个"></p>
<p><img src="/imgs/azkaban/azkaban-wrong-flow-1.png" alt="第一个错误的flow"></p>
<p><img src="/imgs/azkaban/azkaban-wrong-flow-2.png" alt="第二个错误的flow"></p>
<p>可以看到对于mymeta@my_table_c之上的etl，对于下面的node应该是公用的，像现在这样两个flow都有的话，就会导致这些node被多次执行。</p>
<h3 id="3-源码分析"><a href="#3-源码分析" class="headerlink" title="3.源码分析"></a>3.源码分析</h3><p>根据上面的时序图，我们可以看到问题应该是出在分析依赖或者创建flow的过程中。所以过去剖析对应源码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 就是把每个node的dependency map放进HashMap&lt;String, Map&lt;String, Edge&gt;&gt; nodeDependencies里面，一个对应多个dependencies</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resolveDependencies</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// Add all the in edges and out edges. Catch bad dependencies and self</span></div><div class="line">    <span class="comment">// referrals. Also collect list of nodes who are parents.</span></div><div class="line">    <span class="keyword">for</span> (Node node : nodeMap.values()) &#123;</div><div class="line">      Props props = jobPropsMap.get(node.getId());</div><div class="line"></div><div class="line">      List&lt;String&gt; dependencyList =</div><div class="line">          props.getStringList(CommonJobProperties.DEPENDENCIES,</div><div class="line">              (List&lt;String&gt;) <span class="keyword">null</span>);</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (dependencyList != <span class="keyword">null</span>) &#123;</div><div class="line">        Map&lt;String, Edge&gt; dependencies = nodeDependencies.get(node.getId());</div><div class="line">        <span class="keyword">if</span> (dependencies == <span class="keyword">null</span>) &#123;</div><div class="line">          dependencies = <span class="keyword">new</span> HashMap&lt;String, Edge&gt;();</div><div class="line"></div><div class="line">          <span class="keyword">for</span> (String dependencyName : dependencyList) &#123;</div><div class="line">            dependencyName =</div><div class="line">                dependencyName == <span class="keyword">null</span> ? <span class="keyword">null</span> : dependencyName.trim();</div><div class="line">            <span class="keyword">if</span> (dependencyName == <span class="keyword">null</span> || dependencyName.isEmpty()) &#123;</div><div class="line">              <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Edge edge = <span class="keyword">new</span> Edge(dependencyName, node.getId());</div><div class="line">            Node dependencyNode = nodeMap.get(dependencyName);</div><div class="line">            <span class="keyword">if</span> (dependencyNode == <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="keyword">if</span> (duplicateJobs.contains(dependencyName)) &#123;</div><div class="line">                edge.setError(<span class="string">"Ambiguous Dependency. Duplicates found."</span>);</div><div class="line">                dependencies.put(dependencyName, edge);</div><div class="line">                errors.add(node.getId() + <span class="string">" has ambiguous dependency "</span></div><div class="line">                    + dependencyName);</div><div class="line">              &#125; <span class="keyword">else</span> &#123;</div><div class="line">                edge.setError(<span class="string">"Dependency not found."</span>);</div><div class="line">                dependencies.put(dependencyName, edge);</div><div class="line">                errors.add(node.getId() + <span class="string">" cannot find dependency "</span></div><div class="line">                    + dependencyName);</div><div class="line">              &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dependencyNode == node) &#123;</div><div class="line">              <span class="comment">// We have a self cycle</span></div><div class="line">              edge.setError(<span class="string">"Self cycle found."</span>);</div><div class="line">              dependencies.put(dependencyName, edge);</div><div class="line">              errors.add(node.getId() + <span class="string">" has a self cycle"</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">              dependencies.put(dependencyName, edge);</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">if</span> (!dependencies.isEmpty()) &#123;</div><div class="line">            nodeDependencies.put(node.getId(), dependencies);</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>跟踪源码的时候，没有发现上面代码有任何问题。再看下根据依赖构建flow的过程<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildFlowsFromDependencies</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="comment">// Find all root nodes by finding ones without dependents.</span></div><div class="line">  <span class="comment">/********************注意这里 ***********************/</span></div><div class="line">  HashSet&lt;String&gt; nonRootNodes = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">  <span class="keyword">for</span> (Map&lt;String, Edge&gt; edges : nodeDependencies.values()) &#123;</div><div class="line">    <span class="keyword">for</span> (String sourceId : edges.keySet()) &#123;</div><div class="line">      nonRootNodes.add(sourceId);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Now create flows. Bad flows are marked invalid</span></div><div class="line">  Set&lt;String&gt; visitedNodes = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">  <span class="keyword">for</span> (Node base : nodeMap.values()) &#123;</div><div class="line">    <span class="comment">// Root nodes can be discovered when parsing jobs</span></div><div class="line">    <span class="comment">/********************注意这里 ***********************/</span></div><div class="line">    <span class="keyword">if</span> (rootNodes.contains(base.getId())</div><div class="line">        || !nonRootNodes.contains(base.getId())) &#123;</div><div class="line">      rootNodes.add(base.getId());</div><div class="line">      Flow flow = <span class="keyword">new</span> Flow(base.getId());</div><div class="line">      Props jobProp = jobPropsMap.get(base.getId());</div><div class="line"></div><div class="line">      <span class="comment">// 遍历properties里的各种通知邮件啥的</span></div><div class="line"></div><div class="line">      flow.addFailureEmails(failureEmail);</div><div class="line">      flow.addSuccessEmails(successEmail);</div><div class="line"></div><div class="line">      flow.addAllFlowProperties(flowPropsList);</div><div class="line">      constructFlow(flow, base, visitedNodes);</div><div class="line">      flow.initialize();</div><div class="line">      flowMap.put(base.getId(), flow);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面第一个地方是找到所有非root的node，看代码意思就是所有有dependency的node。第二个注意的地方是找rootNodes里有或者不存在与非rootNode集合的node。这不是叶子节点么，下面紧接着就add进去rootNodes了。也就是说azkaban中这里的node的<strong>root角色其实是指的叶子节点</strong>。第三个是flow是按照叶子节点的id命名的，也就是有多少叶子节点就会有多少flow被生成。<br>解释通了，因为我们的project的zip文件中是有两个叶子节点的job，所以就被分成了两个flow。</p>
<h3 id="4-解决方案"><a href="#4-解决方案" class="headerlink" title="4. 解决方案"></a>4. 解决方案</h3><p>生成最终的zip文件之前，生成一个虚拟end job，把所有的叶子节点都配置成它的dependency，这样就只有一个flow了。</p>
<p><img src="/imgs/azkaban/azkaban-right-flow.png" alt="最终生成的正确的flow图"></p>
<p><img src="/imgs/azkaban/azkaban-right-flow-execution.png" alt="尝试执行以下正确的这个flow"></p>
<p>可以看到，并列在同一个level的node是并发执行的，因为他们两个之间相互没有任何影响。这样使用并发充分利用资源，但是azkaban的并发性能和稳定性需要进一步探查。</p>
<h3 id="5-TODO"><a href="#5-TODO" class="headerlink" title="5.TODO"></a>5.TODO</h3><p>每个任务的Runner稳定性测试与定制开发(希望不需要)</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/源码/">源码</a><a href="/tags/azkaban/">azkaban</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/16/一步步搞定ETL依赖调度平台（二）-与azkaban整合/" title="一步步搞定ETL依赖调度平台（二）-zakaban整合实施" itemprop="url">一步步搞定ETL依赖调度平台（二）-zakaban整合实施</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-06-16T03:22:25.000Z" itemprop="datePublished"> 发表于 2016-06-16</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>再列以下前面提到的步骤：</p>
<ol>
<li>通过azkaban api创建一个project: etl_20160615;</li>
<li>调用java程序根据tbl_blood和etl内容生成azkaban的项目文件20160615.zip;</li>
<li>通过azkaban api上传此文件到etl_20160615的project上</li>
<li>通过azkaban api遍历etl_20160615项目下的所有flow，进行调度。</li>
</ol>
<p>其实（一）里面是第二步的实现。今儿调研了以下azkaban的ajax api，并没有想象中的那么简单，所以就再单独说一下怎样完成其他步骤——重要的难点在于<strong>session-id的获取</strong>。</p>
<h3 id="1-方案与问题"><a href="#1-方案与问题" class="headerlink" title="1. 方案与问题"></a>1. 方案与问题</h3><table>
<thead>
<tr>
<th>方案</th>
<th>问题</th>
<th>解决方案</th>
</tr>
</thead>
<tbody>
<tr>
<td>使用azkaban api</td>
<td>需要session-id进行server端验证</td>
<td>1. 使用phantomjs等模拟实现浏览器，从cookie中获取session-id——费事<br>2. 想办法使一个session-id永不过期(这个实施起来最简单，但是稳定程度有待测试)<br>3.azkaban web server启动了rest.li里的userManagerResource，login是返回session-id的，但是需要研习以下rest.li<br>找了半天，解决了:  curl -k -X POST –data “username=azkaban&amp;password=azkaban&amp;action=login” <a href="http://10.1.5.66:8001" target="_blank" rel="external">http://10.1.5.66:8001</a></td>
</tr>
<tr>
<td>直接操作数据</td>
<td>需要对上传zip文件后生成的mysql表足够了解，包括存储的每个字段的内容与规范</td>
<td>将现有的项目中的内容弄出来验证规范后，开始实施</td>
</tr>
<tr>
<td>抽取操作中用到的azkaban的主要类</td>
<td>准备实例化这些类的成员变量</td>
<td>这些成员变量或许比直接插入mysql内容差不多难搞</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="2-实施"><a href="#2-实施" class="headerlink" title="2. 实施"></a>2. 实施</h3><h4 id="2-1-获取session-id"><a href="#2-1-获取session-id" class="headerlink" title="2.1 获取session-id"></a>2.1 获取session-id</h4><p>鉴于时间因素，获取session-id的方案：</p>
<blockquote>
<p>curl -k -X POST –data “username=azkaban&amp;password=azkaban&amp;action=login” <a href="http://10.1.5.66:8001" target="_blank" rel="external">http://10.1.5.66:8001</a><br>返回值：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"status"</span> : <span class="string">"success"</span>,</div><div class="line">  <span class="attr">"session.id"</span> : <span class="string">"4e3da52b-fa1f-478d-836c-42122ced2341"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>解析session-id的脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">curl -k -X POST --data <span class="string">"username=azkaban&amp;password=azkaban&amp;action=login"</span> http://10.1.5.66:8001 &gt; etl_tmp</div><div class="line">session_id=`cat etl_tmp | grep session | awk -F\<span class="string">" '!/[&#123;&#125;]/&#123;print <span class="variable">$(NF-1)</span>&#125;'`</span></div><div class="line">echo "we got session id : <span class="variable">$session_id</span><span class="string">"</span></div></pre></td></tr></table></figure></p>
<h4 id="2-2-创建project"><a href="#2-2-创建project" class="headerlink" title="2.2  创建project"></a>2.2  创建project</h4><p>这里其实先安装了一个shell的json解析工具JSON.sh：<a href="https://github.com/dominictarr/JSON.sh" target="_blank" rel="external">https://github.com/dominictarr/JSON.sh</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">curl -k -X POST --data <span class="string">"session.id=<span class="variable">$&#123;session_id&#125;</span>&amp;name=<span class="variable">$&#123;project_name&#125;</span>&amp;description=<span class="variable">$&#123;project_desc&#125;</span>"</span> http://<span class="variable">$&#123;host&#125;</span>/manager?action=create &gt; <span class="variable">$&#123;etl_tmp&#125;</span></div><div class="line">status=`cat <span class="variable">$&#123;etl_tmp&#125;</span> | JSON.sh -b| grep status | awk <span class="string">'&#123;print($2)&#125;'</span>`</div><div class="line"><span class="keyword">if</span> [ <span class="variable">$status</span> != <span class="string">'"success"'</span> ]; <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"error happends when creting project <span class="variable">$&#123;project_name&#125;</span>. status is <span class="variable">$&#123;status&#125;</span>"</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"project <span class="variable">$&#123;project_name&#125;</span> has been created successfully."</span></div></pre></td></tr></table></figure></p>
<h4 id="2-3-上传zip文件"><a href="#2-3-上传zip文件" class="headerlink" title="2.3 上传zip文件"></a>2.3 上传zip文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">curl -k -i -H <span class="string">"Content-Type: multipart/mixed"</span> -X POST --form <span class="string">"session.id=<span class="variable">$&#123;session_id&#125;</span>"</span> --form <span class="string">'ajax=upload'</span> --form <span class="string">"file=@<span class="variable">$&#123;project_zip_file&#125;</span>"</span> --form <span class="string">"project=<span class="variable">$&#123;project_name&#125;</span>"</span> http://<span class="variable">$&#123;host&#125;</span>/manager?ajax=upload &gt; <span class="variable">$&#123;etl_tmp&#125;</span></div><div class="line">status=`cat <span class="variable">$&#123;etl_tmp&#125;</span> | awk <span class="string">'&#123;if(index($0,"error") &gt; 0) print("error")&#125;'</span>`</div><div class="line"><span class="keyword">if</span> [ <span class="variable">$status</span> == <span class="string">"error"</span> ]; <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"error happends when uploading project <span class="variable">$&#123;project_name&#125;</span>. status is <span class="variable">$&#123;status&#125;</span>"</span></div><div class="line">        <span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"uploading project <span class="variable">$&#123;project_name&#125;</span> successfully"</span></div></pre></td></tr></table></figure>
<p>ps: 没有继续使用JSON.sh的原因是解析报错…看来还是不健全</p>
<h4 id="2-4-执行flow"><a href="#2-4-执行flow" class="headerlink" title="2.4 执行flow"></a>2.4 执行flow</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">curl -k --get --data <span class="string">"session.id=<span class="variable">$&#123;session_id&#125;</span>&amp;ajax=fetchprojectflows&amp;project=<span class="variable">$&#123;project_name&#125;</span>"</span> http://<span class="variable">$&#123;host&#125;</span>/manager &gt; <span class="variable">$&#123;etl_tmp&#125;</span></div><div class="line"><span class="keyword">for</span> flow <span class="keyword">in</span> `cat <span class="variable">$&#123;etl_tmp&#125;</span> |  JSON.sh -b | grep flowId |  awk <span class="string">'&#123;gsub("\"","",$2);print($2)&#125;'</span>`</div><div class="line"><span class="keyword">do</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"flow is <span class="variable">$flow</span>, ready to execute"</span></div><div class="line">        curl -k --get --data <span class="string">"session.id=<span class="variable">$&#123;session_id&#125;</span>"</span> --data <span class="string">'ajax=executeFlow'</span> --data <span class="string">"project=<span class="variable">$&#123;project_name&#125;</span>"</span> --data <span class="string">"flow=<span class="variable">$&#123;flow&#125;</span>"</span> http://<span class="variable">$&#123;host&#125;</span>/executor &gt;<span class="variable">$&#123;etl_tmp&#125;</span><span class="variable">$&#123;flow&#125;</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$flow</span> execution done"</span></div><div class="line"><span class="keyword">done</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"all flows for project <span class="variable">$&#123;project_name&#125;</span> has been executed"</span></div></pre></td></tr></table></figure>
<h3 id="3-shell全文"><a href="#3-shell全文" class="headerlink" title="3.shell全文"></a>3.shell全文</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line">etl_tmp=/tmp/etl_tmp_log</div><div class="line">host=10.0.1.62:8081</div><div class="line">metamap_host=10.0.1.62:8088</div><div class="line">project_desc=daily_schedule</div><div class="line"></div><div class="line"><span class="comment"># 调用生成job的任务，返回任务名称或者失败信息</span></div><div class="line">curl -X GET http://<span class="variable">$&#123;metamap_host&#125;</span>/metamap/etls/generate_job_dag/ &gt; <span class="variable">$&#123;etl_tmp&#125;</span></div><div class="line">filename=`cat <span class="variable">$&#123;etl_tmp&#125;</span>`</div><div class="line"><span class="keyword">if</span> [ <span class="variable">$filename</span> == <span class="string">"error"</span> -o <span class="variable">$&#123;#filename&#125;</span> <span class="_">-ne</span> 14 ]; <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"error happends when generate Job Scripts. ori_filename is <span class="variable">$&#123;filename&#125;</span>"</span></div><div class="line">	<span class="built_in">echo</span> <span class="string">"length is <span class="variable">$&#123;#filename&#125;</span>"</span></div><div class="line">        <span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line">project_name=etl_<span class="variable">$&#123;filename&#125;</span></div><div class="line">project_zip_file=/tmp/<span class="variable">$&#123;filename&#125;</span>.zip</div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"project_name is <span class="variable">$&#123;project_name&#125;</span>"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"project_zip_file is <span class="variable">$&#123;project_zip_file&#125;</span>"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"azkaban host is <span class="variable">$&#123;host&#125;</span>"</span></div><div class="line"></div><div class="line"><span class="comment"># 获取session id</span></div><div class="line">curl -k -X POST --data <span class="string">"username=azkaban&amp;password=azkaban&amp;action=login"</span> http://<span class="variable">$&#123;host&#125;</span> &gt; <span class="variable">$&#123;etl_tmp&#125;</span></div><div class="line"><span class="built_in">echo</span> result is `cat <span class="variable">$&#123;etl_tmp&#125;</span>`</div><div class="line">session_id=`cat <span class="variable">$&#123;etl_tmp&#125;</span> | grep session | awk -F\<span class="string">" '!/[&#123;&#125;]/&#123;print <span class="variable">$(NF-1)</span>&#125;'`</span></div><div class="line">echo "we got session id : <span class="variable">$session_id</span><span class="string">"</span></div><div class="line"></div><div class="line">### 创建project</div><div class="line">echo "project name is <span class="variable">$&#123;project_name&#125;</span><span class="string">"</span></div><div class="line">curl -k -X POST --data "session.id=<span class="variable">$&#123;session_id&#125;</span>&amp;name=<span class="variable">$&#123;project_name&#125;</span>&amp;description=<span class="variable">$&#123;project_desc&#125;</span><span class="string">" http://<span class="variable">$&#123;host&#125;</span>/manager?action=create &gt; <span class="variable">$&#123;etl_tmp&#125;</span></span></div><div class="line">status=`cat <span class="variable">$&#123;etl_tmp&#125;</span> | JSON.sh -b| grep status | awk '&#123;print(<span class="variable">$2</span>)&#125;'` </div><div class="line">if [ <span class="variable">$status</span> != '"success<span class="string">"' ]; then</span></div><div class="line">        echo "error happends when creting project <span class="variable">$&#123;project_name&#125;</span>. status is <span class="variable">$&#123;status&#125;</span><span class="string">"</span></div><div class="line">	exit 1</div><div class="line">fi</div><div class="line">echo "project <span class="variable">$&#123;project_name&#125;</span> has been created successfully.<span class="string">"</span></div><div class="line"></div><div class="line"># 上传zip文件到指定project</div><div class="line">curl -k -i -H "Content-Type: multipart/mixed<span class="string">" -X POST --form "</span>session.id=<span class="variable">$&#123;session_id&#125;</span><span class="string">" --form 'ajax=upload' --form "</span>file=@<span class="variable">$&#123;project_zip_file&#125;</span><span class="string">" --form "</span>project=<span class="variable">$&#123;project_name&#125;</span><span class="string">" http://<span class="variable">$&#123;host&#125;</span>/manager?ajax=upload &gt; <span class="variable">$&#123;etl_tmp&#125;</span></span></div><div class="line">status=`cat <span class="variable">$&#123;etl_tmp&#125;</span> | awk '&#123;if(index(<span class="variable">$0</span>,"error<span class="string">") &gt; 0) print("</span>error<span class="string">")&#125;'`</span></div><div class="line">if [[ <span class="variable">$status</span> = "error<span class="string">" ]]; then</span></div><div class="line">        echo "error happends when uploading project <span class="variable">$&#123;project_name&#125;</span>. status is <span class="variable">$&#123;status&#125;</span><span class="string">"</span></div><div class="line">        exit 1</div><div class="line">fi</div><div class="line">echo "uploading project <span class="variable">$&#123;project_name&#125;</span> successfully<span class="string">"</span></div><div class="line"></div><div class="line"># </div><div class="line"># 阻塞检察某个execution的进度</div><div class="line">#</div><div class="line">function check_exec_status()&#123;</div><div class="line">	execid=<span class="variable">$1</span></div><div class="line">	sleep 1h</div><div class="line">	#查看前execution的执行状态，完成后退出</div><div class="line">	status=RUNNING</div><div class="line">	until [ <span class="variable">$status</span> == '"SUCCEEDED<span class="string">"' ]</span></div><div class="line">	do</div><div class="line">    		curl -k --get --data "session.id=<span class="variable">$&#123;session_id&#125;</span>&amp;ajax=fetchexecflowupdate&amp;execid=<span class="variable">$&#123;execid&#125;</span>&amp;lastUpdateTime=-1<span class="string">" http://<span class="variable">$&#123;host&#125;</span>/executor &gt; <span class="variable">$&#123;etl_tmp&#125;</span></span></div><div class="line">    		status=`cat <span class="variable">$&#123;etl_tmp&#125;</span> | JSON.sh -b| grep status | grep -v node | awk '&#123;print(<span class="variable">$2</span>)&#125;'`</div><div class="line">		if [ <span class="variable">$status</span> == '"KILLED<span class="string">"' ]; then</span></div><div class="line">			echo "<span class="variable">$&#123;execid&#125;</span> has been killed.<span class="string">"</span></div><div class="line">			break</div><div class="line">		elif [ <span class="variable">$status</span> == '"FAILED<span class="string">"' ]; then</span></div><div class="line">                        echo "<span class="variable">$&#123;execid&#125;</span> has been failed.<span class="string">"</span></div><div class="line">                        break</div><div class="line">		fi</div><div class="line">    		echo "<span class="variable">$&#123;execid&#125;</span> not yet...<span class="string">" `cat <span class="variable">$&#123;etl_tmp&#125;</span>`</span></div><div class="line">		sleep 10m	</div><div class="line">	done</div><div class="line">&#125;</div><div class="line"></div><div class="line"># 遍历执行project下的flow</div><div class="line">curl -k --get --data "session.id=<span class="variable">$&#123;session_id&#125;</span>&amp;ajax=fetchprojectflows&amp;project=<span class="variable">$&#123;project_name&#125;</span><span class="string">" http://<span class="variable">$&#123;host&#125;</span>/manager &gt; <span class="variable">$&#123;etl_tmp&#125;</span></span></div><div class="line">for flow in `cat <span class="variable">$&#123;etl_tmp&#125;</span> |  JSON.sh -b | grep flowId |  awk '&#123;gsub("\<span class="string">""</span>,<span class="string">""</span>,<span class="variable">$2</span>);<span class="built_in">print</span>(<span class="variable">$2</span>)&#125;<span class="string">'`</span></div><div class="line">do</div><div class="line">        echo "flow is $flow, ready to execute"</div><div class="line">        curl -k --get --data "session.id=$&#123;session_id&#125;" --data 'ajax=executeFlow<span class="string">' --data "project=$&#123;project_name&#125;" --data "flow=$&#123;flow&#125;" --data "failureAction=finishPossible" http://$&#123;host&#125;/executor &gt;$&#123;etl_tmp&#125;$&#123;flow&#125;</span></div><div class="line">        execid=`cat $&#123;etl_tmp&#125;$&#123;flow&#125; | JSON.sh -b| grep execid | awk '&#123;<span class="built_in">print</span>(<span class="variable">$2</span>)&#125;<span class="string">'`</span></div><div class="line">	echo "got execid : $&#123;execid&#125;"</div><div class="line">	check_exec_status $&#123;execid&#125;</div><div class="line">echo "$flow execution done"</div><div class="line">done</div><div class="line">echo "all flows for project $&#123;project_name&#125; has been executed"</div></pre></td></tr></table></figure>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/ETL/">ETL</a><a href="/tags/调度平台/">调度平台</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/15/一步步搞定ETL依赖调度平台（一）/" title="一步步搞定ETL依赖调度平台（一）" itemprop="url">一步步搞定ETL依赖调度平台（一）</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-06-15T10:48:43.000Z" itemprop="datePublished"> 发表于 2016-06-15</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="1-依赖解析"><a href="#1-依赖解析" class="headerlink" title="1. 依赖解析"></a>1. 依赖解析</h3><ul>
<li>sql AST解析。相关工具antlr,这是一个定义与解析特定语言的工具。</li>
<li>hive denpendency： explain dependency select * from a.</li>
<li>其他sql解析工具，功能类似hive dependency</li>
</ul>
<p>鉴于我们的数据仓库使用hive搭建，使用hive dependency的兼容性更有保证。注意两点：1.如果a表不存在与hive中，就会报错找不到table。也就是说ETL开发的时候，它的依赖必须已经存在与hive库里；2. 由于依赖解析功能在ETL开发平台上，所以必须通过hiveserver2进行访问，效率可能不高，但是ETL平台对此要求也不会太高。</p>
<p>需要额外说一下antlr的好处：一是可以深入剖析sql，在这一层做字段级别的权限控制；二是可以做一些sql的分析，反馈给ETL开发者一些优化建议；</p>
<h3 id="2-存库"><a href="#2-存库" class="headerlink" title="2. 存库"></a>2. 存库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">-- ----------------------------</span></div><div class="line"><span class="comment">-- Table structure for etl</span></div><div class="line"><span class="comment">-- ----------------------------</span></div><div class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`etl`</span>;</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`etl`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</div><div class="line">  <span class="string">`query`</span> <span class="built_in">varchar</span>(<span class="number">2000</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'sql语句'</span>,</div><div class="line">  <span class="string">`meta`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'数据库'</span>,</div><div class="line">  <span class="string">`tbl_name`</span> <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'表名'</span>,</div><div class="line">  <span class="string">`author`</span> <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建人'</span>,</div><div class="line">  <span class="string">`pre_sql`</span> <span class="built_in">varchar</span>(<span class="number">2000</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'先执行的sql'</span>,</div><div class="line">  <span class="string">`priority`</span> <span class="built_in">int</span>(<span class="number">5</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'5'</span>,</div><div class="line">  <span class="string">`on_schedule`</span> tinyint(<span class="number">4</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'0 不调度 1 调度中'</span>,</div><div class="line">  <span class="string">`valid`</span> tinyint(<span class="number">4</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`ctime`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`utime`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">19</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">-- ----------------------------</span></div><div class="line"><span class="comment">-- Table structure for tbl_blood</span></div><div class="line"><span class="comment">-- ----------------------------</span></div><div class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`tbl_blood`</span>;</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`tbl_blood`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</div><div class="line">  <span class="string">`tbl_name`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`parent_tbl`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`related_etl_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`valid`</span> tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</div><div class="line">  <span class="string">`ctime`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</div><div class="line">  <span class="string">`utime`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">21</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</div></pre></td></tr></table></figure>
<p>每当新建一个ETL的时候都会分析它的依赖，如果分析失败，就不会插入ETL。</p>
<p>另外补充一个字段和表关系的，从hive meta库查询sql<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span></div><div class="line">	db.DB_ID <span class="keyword">AS</span> db_id,</div><div class="line">	db.<span class="string">`NAME`</span> <span class="keyword">AS</span> db_name,</div><div class="line">	a.TBL_ID <span class="keyword">AS</span> tbl_id,</div><div class="line">	a.TBL_NAME <span class="keyword">AS</span> tbl_name,</div><div class="line">	a.TBL_TYPE <span class="keyword">AS</span> tbl_type,</div><div class="line">	d.TYPE_NAME <span class="keyword">AS</span> col_type_name,</div><div class="line">	d.<span class="string">`COMMENT`</span> <span class="keyword">AS</span> col_comment,</div><div class="line">	d.COLUMN_NAME <span class="keyword">AS</span> column_name</div><div class="line"><span class="keyword">FROM</span></div><div class="line">	TBLS a</div><div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> SDS b <span class="keyword">ON</span> a.SD_ID = b.SD_ID</div><div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> COLUMNS_V2 d <span class="keyword">ON</span> b.CD_ID = d.CD_ID</div><div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> DBS db <span class="keyword">ON</span> a.DB_ID = db.DB_ID</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="3-每日调度"><a href="#3-每日调度" class="headerlink" title="3.每日调度"></a>3.每日调度</h3><p>有了以上两步之后剩下的就是每日调度问题。分以下几个步骤：</p>
<ol>
<li>通过azkaban api创建一个project: etl_20160615;</li>
<li>调用java程序根据tbl_blood和etl内容生成azkaban的项目文件20160615.zip;</li>
<li>通过azkaban api上传此文件到etl_20160615的project上</li>
<li>通过azkaban api遍历etl_20160615项目下的所有flow，进行调度。</li>
</ol>
<p>生成azkaban文件的逻辑：</p>
<ol>
<li>找出没有被任何其他ETL以来的叶子节点</li>
<li>遍历所有叶子节点，找到这个叶子节点的所有有效依赖，放入dependencies里，如果尚未生成该ETL的job文件</li>
<li>向上递归执行，直到没有dependency的节点，也就是最上一层节点就停止。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">generateAzkabanDAG</span><span class="params">()</span> <span class="keyword">throws</span> MetaException, ArchiveException </span>&#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           String serFolder = DateUtil.getTodayDateTime();</div><div class="line">           List&lt;TblBlood&gt; leafBlood = tblBloodDao.selectAllLeaf();</div><div class="line">           Set&lt;String&gt; doneBlood = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">           String serFolderLocation = AZKABAN_BASE_LOCATION + serFolder;</div><div class="line">           <span class="keyword">if</span> (leafBlood.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">               loadLeafBloods(leafBlood, doneBlood, serFolderLocation);</div><div class="line">           &#125;</div><div class="line">           </div><div class="line">           ZipUtils.addFilesToZip(<span class="keyword">new</span> File(serFolderLocation), </div><div class="line">                   <span class="keyword">new</span> File(serFolderLocation + <span class="string">".zip"</span>));</div><div class="line">       &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">           log.error(<span class="string">"error happends when generateAzkabanDAG"</span>);</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> MetaException(<span class="string">"error happends when generateAzkabanDAG"</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   </div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadLeafBloods</span><span class="params">(List&lt;TblBlood&gt; leafBlood, Set&lt;String&gt; doneBlood, String serFolder)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">       <span class="keyword">for</span> (TblBlood leaf : leafBlood) &#123;</div><div class="line">           List&lt;TblBlood&gt; parentNode = tblBloodDao.selectParentByTblName(leaf.getTblName());</div><div class="line">           <span class="keyword">if</span> (!doneBlood.contains(leaf.getTblName())) &#123;</div><div class="line">               generateJobFile(leaf, parentNode, serFolder);</div><div class="line">               doneBlood.add(leaf.getTblName());</div><div class="line">           &#125;</div><div class="line">           loadLeafBloods(parentNode, doneBlood, serFolder);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">generateJobFile</span><span class="params">(TblBlood currentBlood,  List&lt;TblBlood&gt; parentNode, String serFolder)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"></div><div class="line">       String jobName = currentBlood.getTblName();</div><div class="line">       String jobType = <span class="string">"command"</span>;</div><div class="line">       String command = <span class="string">"echo 'I am command for ' "</span> + jobName;</div><div class="line">       String content;</div><div class="line">       Set&lt;String&gt; dependencies = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">       <span class="keyword">for</span> (TblBlood blood : parentNode) &#123;</div><div class="line">           dependencies.add(blood.getTblName());</div><div class="line">       &#125;</div><div class="line">       String jobDependencies = joiner.join(dependencies);</div><div class="line">       content = <span class="string">"# "</span> + jobName + <span class="string">"\n"</span></div><div class="line">               + <span class="string">"type="</span> + jobType +<span class="string">"\n"</span></div><div class="line">                       + <span class="string">"command="</span> + command + <span class="string">"\n"</span>;</div><div class="line">       <span class="keyword">if</span> (StringUtils.isNotBlank(jobDependencies)) &#123;</div><div class="line">           content += <span class="string">"dependencies="</span> + jobDependencies +<span class="string">"\n"</span>;</div><div class="line">       &#125;</div><div class="line">       File file = <span class="keyword">new</span> File(serFolder + <span class="string">"/"</span> + jobName.replace(<span class="string">"@"</span>, <span class="string">"-"</span>) + <span class="string">".job"</span>);</div><div class="line">       FileUtils.write(file, content, <span class="string">"utf8"</span>, <span class="keyword">false</span>);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h3 id="4-参考"><a href="#4-参考" class="headerlink" title="4.参考"></a>4.参考</h3><p><a href="http://azkaban.github.io/azkaban/docs/latest/#ajax-api" target="_blank" rel="external">http://azkaban.github.io/azkaban/docs/latest/#ajax-api</a></p>
<h3 id="5-TODO"><a href="#5-TODO" class="headerlink" title="5. TODO"></a>5. TODO</h3><ul>
<li>flow和job目前都是不支持优先级的，需要探查下azkaban中同一个flow里job执行次序是怎样的。</li>
<li>目前字段解析只能通过部分从hive meta抽，获取到字段与当前表的关系，不能逐个找到字段与字段之间的血统关系。如果使用antlr的话可以分析到每一个as之前是什么，理论上是可以实现字段的血统关系的。</li>
<li>对于每月、每周、每小时的个别ETL的支持策略</li>
<li>支持ETL变量传入和临时调试</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/ETL/">ETL</a><a href="/tags/调度平台/">调度平台</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/15/azkaban源码追踪-单次调度flow/" title="azkaban源码追踪（二）-单次调度flow" itemprop="url">azkaban源码追踪（二）-单次调度flow</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-06-15T03:09:03.000Z" itemprop="datePublished"> 发表于 2016-06-15</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>对应的操作是进入到某个project中，然后单次执行下面的某个flow。会触发web-server这边与exec-server的远程调用去执行flow。</p>
<h4 id="相关类"><a href="#相关类" class="headerlink" title="相关类"></a>相关类</h4><ul>
<li>Web-server<ul>
<li>ExecutorServlet.doGet</li>
<li>ExecutorManager</li>
</ul>
</li>
<li>exec-server<ul>
<li>ExecutorServlet.doGet</li>
<li>FlowRunnerManager</li>
<li>FlowRunner</li>
<li>ExecutableFlowBase</li>
<li>ExecutableNode</li>
<li>JobRunner</li>
<li>JobTypeManager</li>
<li>Job</li>
<li>AzkabanProcessBuilder</li>
</ul>
</li>
</ul>
<p>#### </p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/源码/">源码</a><a href="/tags/azkaban/">azkaban</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/15/azkaban源码追踪（一）-uploadProject流程/" title="azkaban源码追踪（一）-uploadProject流程" itemprop="url">azkaban源码追踪（一）-uploadProject流程</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-06-15T02:34:28.000Z" itemprop="datePublished"> 发表于 2016-06-15</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h4 id="1-相关类"><a href="#1-相关类" class="headerlink" title="1. 相关类"></a>1. 相关类</h4><ul>
<li>ProjectMangerServlet</li>
<li>ProjectManager</li>
<li>ValidatorManager</li>
<li>DirectoryFlowLoader</li>
<li>JdbcProjectLoader</li>
</ul>
<h4 id="2-对应的流程log"><a href="#2-对应的流程log" class="headerlink" title="2. 对应的流程log"></a>2. 对应的流程log</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">2016/06/14 15:39:18.537 +0800 INFO [ProjectManagerServlet] [Azkaban] Uploading file willjob.zip</div><div class="line">2016/06/14 15:39:23.861 +0800 INFO [ProjectManager] [Azkaban] Uploading files to mytestProject</div><div class="line">2016/06/14 15:40:16.454 +0800 WARN [XmlValidatorManager] [Azkaban] Validator directory validators does not exist or is not a directory</div><div class="line">2016/06/14 15:40:16.455 +0800 WARN [XmlValidatorManager] [Azkaban] Azkaban properties file does not contain the key project.validators</div><div class="line">2016/06/14 15:40:35.752 +0800 INFO [ProjectManager] [Azkaban] Validating project willjob.zip using the registered validators [Director</div><div class="line">2016/06/14 16:11:45.952 +0800 INFO [XmlValidatorManager] [Azkaban] Validation status of validator Directory Flow is PASS</div><div class="line">2016/06/14 16:56:51.338 +0800 INFO [ProjectManager] [Azkaban] Uploading file to db willjob.zip</div><div class="line">2016/06/14 16:56:51.338 +0800 INFO [JdbcProjectLoader] [Azkaban] Uploading to mytestProject version:1 file:willjob.zip</div><div class="line">2016/06/14 16:56:51.341 +0800 INFO [JdbcProjectLoader] [Azkaban] Creating message digest for upload willjob.zip</div><div class="line">2016/06/14 16:56:51.343 +0800 INFO [JdbcProjectLoader] [Azkaban] Md5 hash created</div><div class="line">2016/06/14 16:56:51.359 +0800 INFO [JdbcProjectLoader] [Azkaban] Read bytes for willjob.zip size:560</div><div class="line">2016/06/14 16:56:51.359 +0800 INFO [JdbcProjectLoader] [Azkaban] Running update for willjob.zip chunk 0</div><div class="line">2016/06/14 16:56:51.360 +0800 INFO [JdbcProjectLoader] [Azkaban] Finished update for willjob.zip chunk 0</div><div class="line">2016/06/14 16:56:51.362 +0800 INFO [JdbcProjectLoader] [Azkaban] Commiting upload willjob.zip</div><div class="line">2016/06/14 16:56:51.363 +0800 INFO [ProjectManager] [Azkaban] Uploading flow to db willjob.zip</div><div class="line">2016/06/14 16:56:51.363 +0800 INFO [JdbcProjectLoader] [Azkaban] Uploading flows</div><div class="line">2016/06/14 16:56:51.418 +0800 INFO [JdbcProjectLoader] [Azkaban] Flow upload will3 is byte size 214</div><div class="line">2016/06/14 16:56:51.432 +0800 INFO [JdbcProjectLoader] [Azkaban] Flow upload will2 is byte size 238</div><div class="line">2016/06/14 16:56:51.434 +0800 INFO [ProjectManager] [Azkaban] Changing project versions willjob.zip</div><div class="line">2016/06/14 16:56:51.436 +0800 INFO [ProjectManager] [Azkaban] Uploading Job properties</div><div class="line">2016/06/14 16:56:51.820 +0800 INFO [ProjectManager] [Azkaban] Uploading Props properties</div><div class="line">2016/06/14 16:56:51.822 +0800 INFO [ProjectManager] [Azkaban] Uploaded project files. Cleaning up temp files.</div><div class="line">2016/06/14 16:56:51.927 +0800 INFO [ProjectManager] [Azkaban] Cleaning up old install files older than -2</div></pre></td></tr></table></figure>
<h4 id="3-ProjectManager"><a href="#3-ProjectManager" class="headerlink" title="3. ProjectManager"></a>3. ProjectManager</h4><p>白话一下ProjectManager处理上传zip文件的过程：</p>
<ol>
<li>将文件存到/tmp目录并解压</li>
<li>使用DirectoryFlowLoader解析文件，放置到这个loader的状态变量中。这些变量会一直保存在内存里，以供后面使用</li>
<li>遍历loader里的flowMap，把每个flow都加上最新的project_id和version</li>
<li>上传project信息<ul>
<li>4.1 把zip文件弄成字节流上传到mysql的project_files表中</li>
<li>4.2 把最新版本的project信息上传到project_versions表中</li>
</ul>
</li>
<li>上传flow: 把flow逐个序列化成json，再弄成byte字节流，再使用gzip压缩，上传至project_flows表中</li>
<li>更新projects里的相关记录，并修改内存中的project信息【修改时间等、最新版本的flows】</li>
<li>上传job的详细信息到project_properties中，job的详细信息也是json-&gt;byte[]-&gt;gzip的过程</li>
<li>上传props的详细信息到project_properties中，流程同job完全一样【这个debug的时候数据是空的】</li>
<li>将此次操作插入到project_event中，之后删除本地/tmp下的文件</li>
<li>使用project_id和当前version判断依次清除先前版本的project_flows的flow、project_properties、project_files、project_versions中的记录【会有最近版本保留数量设置project.version.retention，默认是3】</li>
<li>完成<br><img src="/imgs/azkaban/azkaban-upload-zip-handleflow.png" alt="azkaban上传zip很粗糙的流程图"><h4 id="4-文件解析"><a href="#4-文件解析" class="headerlink" title="4. 文件解析"></a>4. 文件解析</h4>DirectoryFlowLoader加载文件目录，解析所有的文件，进行解析，将信息存放在自己的状态变量中：<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Props props;                          <span class="comment">// 环境、配置信息</span></div><div class="line"><span class="keyword">private</span> HashSet&lt;String&gt; rootNodes;            <span class="comment">// 根节点，也就是实际执行的时候的起始节点</span></div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Flow&gt; flowMap;        <span class="comment">// 所有的flow，key是flowId</span></div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Node&gt; nodeMap;        <span class="comment">// 所有的node，key是JobId或者embed的flowId</span></div><div class="line"><span class="comment">// node之间的dependency，key是job名称，value是一系列的相关依赖job，一般是children，然后Edge指定从谁到谁</span></div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Map&lt;String, Edge&gt;&gt; nodeDependencies;  </div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Props&gt; jobPropsMap;   <span class="comment">// 包含job的详细信息</span></div><div class="line"></div><div class="line"><span class="comment">// flow之间的依赖关系【embedeed flow】</span></div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Set&lt;String&gt;&gt; flowDependencies;</div><div class="line"></div><div class="line"><span class="keyword">private</span> ArrayList&lt;FlowProps&gt; flowPropsList;</div><div class="line"><span class="keyword">private</span> ArrayList&lt;Props&gt; propsList;</div><div class="line"><span class="keyword">private</span> Set&lt;String&gt; errors;</div><div class="line"><span class="keyword">private</span> Set&lt;String&gt; duplicateJobs;</div></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 临时解压目录 baseDirectory : temp/46769225</span></div><div class="line"><span class="comment">// 项目信息 project: testPro</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadProjectFlow</span><span class="params">(Project project, File baseDirectory)</span> </span>&#123;</div><div class="line">    propsList = <span class="keyword">new</span> ArrayList&lt;Props&gt;();</div><div class="line">    flowPropsList = <span class="keyword">new</span> ArrayList&lt;FlowProps&gt;();</div><div class="line">    jobPropsMap = <span class="keyword">new</span> HashMap&lt;String, Props&gt;();</div><div class="line">    nodeMap = <span class="keyword">new</span> HashMap&lt;String, Node&gt;();</div><div class="line">    flowMap = <span class="keyword">new</span> HashMap&lt;String, Flow&gt;();</div><div class="line">    errors = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">    duplicateJobs = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">    nodeDependencies = <span class="keyword">new</span> HashMap&lt;String, Map&lt;String, Edge&gt;&gt;();</div><div class="line">    rootNodes = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">    flowDependencies = <span class="keyword">new</span> HashMap&lt;String, Set&lt;String&gt;&gt;();</div><div class="line"></div><div class="line">    <span class="comment">// 加载所有的properties、job文件，创建node对象</span></div><div class="line">    loadProjectFromDir(baseDirectory.getPath(), baseDirectory, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    jobPropertiesCheck(project);</div><div class="line"></div><div class="line">    <span class="comment">// Create edges and find missing dependencies</span></div><div class="line">    resolveDependencies();</div><div class="line"></div><div class="line">    <span class="comment">// 创建flows. 在此之后flowMap里就已经构建好了flow以及job之间的依赖了，node之间通过level来界定先后关系</span></div><div class="line">    buildFlowsFromDependencies();</div><div class="line"></div><div class="line">    <span class="comment">// 处理embedded flows，就是嵌入的flow</span></div><div class="line">    resolveEmbeddedFlows();</div><div class="line"></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h5 id="loadProjectFromDir方法详细"><a href="#loadProjectFromDir方法详细" class="headerlink" title="loadProjectFromDir方法详细"></a>loadProjectFromDir方法详细</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadProjectFromDir</span><span class="params">(String base, File dir, Props parent)</span> </span>&#123;</div><div class="line">  <span class="comment">// 找出所有的properties</span></div><div class="line">  File[] propertyFiles = dir.listFiles(<span class="keyword">new</span> SuffixFilter(PROPERTY_SUFFIX));</div><div class="line">  Arrays.sort(propertyFiles);</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (File file : propertyFiles) &#123;</div><div class="line">      String relative = getRelativeFilePath(base, file.getPath());</div><div class="line">      parent = <span class="keyword">new</span> Props(parent, file);</div><div class="line">      parent.setSource(relative);</div><div class="line">      FlowProps flowProps = <span class="keyword">new</span> FlowProps(parent);</div><div class="line">      flowPropsList.add(flowProps);</div><div class="line">      logger.info(<span class="string">"Adding "</span> + relative);</div><div class="line">      propsList.add(parent);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 加载job文件</span></div><div class="line">  File[] jobFiles = dir.listFiles(<span class="keyword">new</span> SuffixFilter(JOB_SUFFIX));</div><div class="line">  <span class="keyword">for</span> (File file : jobFiles) &#123;</div><div class="line">    String jobName = getNameWithoutExtension(file);</div><div class="line">      <span class="keyword">if</span> (!duplicateJobs.contains(jobName)) &#123;</div><div class="line">        <span class="keyword">if</span> (jobPropsMap.containsKey(jobName)) &#123;</div><div class="line">          <span class="comment">// 是否有重复</span></div><div class="line">          ... </div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          Props prop = <span class="keyword">new</span> Props(parent, file);</div><div class="line">          String relative = getRelativeFilePath(base, file.getPath());</div><div class="line">          prop.setSource(relative);</div><div class="line"></div><div class="line">          Node node = <span class="keyword">new</span> Node(jobName);</div><div class="line">          String type = prop.getString(<span class="string">"type"</span>, <span class="keyword">null</span>);</div><div class="line">          <span class="keyword">if</span> (type == <span class="keyword">null</span>) &#123;</div><div class="line">            errors.add(<span class="string">"Job doesn't have type set '"</span> + jobName + <span class="string">"'."</span>);</div><div class="line">          &#125;</div><div class="line">          node.setType(type); <span class="comment">// job类型</span></div><div class="line">          node.setJobSource(relative);    <span class="comment">// job相对路径</span></div><div class="line">          <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</div><div class="line">            node.setPropsSource(parent.getSource());</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="comment">// Force root node</span></div><div class="line">          <span class="keyword">if</span> (prop.getBoolean(CommonJobProperties.ROOT_NODE, <span class="keyword">false</span>)) &#123;</div><div class="line">            rootNodes.add(jobName);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="comment">// 把properties和node放进loader中的队列中</span></div><div class="line">          jobPropsMap.put(jobName, prop);</div><div class="line">          nodeMap.put(jobName, node);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 检查是否有子目录</span></div><div class="line">  File[] subDirs = dir.listFiles(DIR_FILTER);</div><div class="line">  <span class="keyword">for</span> (File file : subDirs) &#123;</div><div class="line">    loadProjectFromDir(base, file, parent);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="常用的blob处理代码"><a href="#常用的blob处理代码" class="headerlink" title="常用的blob处理代码"></a>常用的blob处理代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">String propertyJSON = PropsUtils.toJSONString(props, <span class="keyword">true</span>);</div><div class="line">   <span class="keyword">byte</span>[] data = propertyJSON.getBytes(<span class="string">"UTF-8"</span>);</div><div class="line">   <span class="keyword">if</span> (defaultEncodingType == EncodingType.GZIP) &#123;</div><div class="line">     data = GZIPUtils.gzipBytes(data);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h4 id="5-其他"><a href="#5-其他" class="headerlink" title="5.其他"></a>5.其他</h4><p><img src="/imgs/azkaban/azkaban-upload-zip-node.png" alt="azkaban上传zip文件时生成的Node结构"></p>
<p>level表示当前node所在的层次。</p>
<p><img src="/imgs/azkaban/Edge-structure.png" alt="azkaban上传zip后内存中表示node连接的Edge结构"></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/源码/">源码</a><a href="/tags/azkaban/">azkaban</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/20/"><span></span>Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/19/">19</a><a class="page-number" href="/page/20/">20</a><span class="page-number current">21</span><a class="page-number" href="/page/22/">22</a><a class="page-number" href="/page/23/">23</a><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" href="/page/22/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  

  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/youdaonote/" title="youdaonote">youdaonote<sup>187</sup></a></li>
			
		
			
				<li><a href="/tags/源码/" title="源码">源码<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/akka/" title="akka">akka<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/flume/" title="flume">flume<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/ETL/" title="ETL">ETL<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/solr/" title="solr">solr<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/spring/" title="spring">spring<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/调度平台/" title="调度平台">调度平台<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/azkaban/" title="azkaban">azkaban<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/mysql/" title="mysql">mysql<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/scala/" title="scala">scala<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/ambari/" title="ambari">ambari<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/quartz/" title="quartz">quartz<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/nodejs/" title="nodejs">nodejs<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Solr/" title="Solr">Solr<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/guava/" title="guava">guava<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/heroku/" title="heroku">heroku<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/hdfs/" title="hdfs">hdfs<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/hue/" title="hue">hue<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ElasticSearch/" title="ElasticSearch">ElasticSearch<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://github.com/willcup" target="_blank" title=" 我自己的github">github</a>
            
          </li>
        
          <li>
            
            	<a href="http://thisding.com" target="_blank" title="朋友的主页">Steven&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Will Chen in MeiTuan. <br/>
			元 亨 利 贞.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:chenxin15@meituan.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2017 
		
		<a href="/about" target="_blank" title="Will Chen">Will Chen</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fe6d1f421bbc9962127a50488f9ed37d1' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
