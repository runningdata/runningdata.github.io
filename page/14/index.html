
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <script type="text/javascript">
    (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
    })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
    
    _st('install','yNiKTKaAnwd1uuxVMfiE','2.0.0');
  </script>
  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?5b99dfd487346155d274c0c49c3fb869";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
  </script>

  
    <title>Will&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Will Chen">
    

    
    <meta name="description" content="左右水色 右手天光">
<meta property="og:type" content="website">
<meta property="og:title" content="Will's Blog">
<meta property="og:url" content="https://runningdata.github.io/page/14/index.html">
<meta property="og:site_name" content="Will's Blog">
<meta property="og:description" content="左右水色 右手天光">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Will's Blog">
<meta name="twitter:description" content="左右水色 右手天光">

    
    <link rel="alternative" href="/atom.xml" title="Will&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Will&#39;s Blog" title="Will&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Will&#39;s Blog">Will&#39;s Blog</a></h1>
				<h2 class="blog-motto">简易 变易 不易</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
                                                <form class="search" action="/search/index.html" method="get" accept-charset="utf-8" target="_blank">
                                                        <label>搜索</label>
                                                <input name="s" type="hidden" value= null ><input type="text" name="q" size="30" placeholder="搜索"><br>
                                                </form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/02/08/R数据结构/" title="R数据结构" itemprop="url">R数据结构</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2017-02-08T07:23:53.000Z" itemprop="datePublished"> 发表于 2017-02-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>类型<br>=</p>
<ul>
<li>NULL表示没有任何值</li>
<li>NA 表示缺失值</li>
</ul>
<p>因子<br>=<br>用类别值来代表特征的属性成为<strong>名义属性</strong>。尽管可以用字符型向量存储名义属性，但是R提供了因子的专用数据结构。</p>
<p>一个是省空间、另外一些机器学习算法是用特别的程序来处理分类变量的，把分类变量编码为因子可以确保模型能够合理地处理这类数据。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt; gender &lt;- factor(c(&quot;MALE&quot;, &quot;FAMALE&quot;,&quot;FAMALE&quot;))</div><div class="line">&gt; gender</div><div class="line">[1] MALE   FAMALE FAMALE</div><div class="line">Levels: FAMALE MALE</div><div class="line">&gt; blood &lt;- factor(c(&quot;A&quot;, &quot;B&quot;), levels = c(&quot;A&quot;, &quot;B&quot;, &quot;O&quot;))</div><div class="line">&gt; blood</div><div class="line">[1] A B</div><div class="line">Levels: A B O</div></pre></td></tr></table></figure>
<p>levels是说这个字段可能会有多少值</p>
<p>集合<br>=<br>向量必须是同样类型的元素，而列表可以包含不同类型的元素，还可以指定元素的key。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&gt; obj &lt;- list(name=&quot;will&quot;, age=21, job=&quot;coder&quot;)</div><div class="line">&gt; obj</div><div class="line">$name</div><div class="line">[1] &quot;will&quot;</div><div class="line"></div><div class="line">$age</div><div class="line">[1] 21</div><div class="line"></div><div class="line">$job</div><div class="line">[1] &quot;coder&quot;</div><div class="line"></div><div class="line">&gt; obj$age</div><div class="line">[1] 21</div><div class="line">&gt; obj[2]</div><div class="line">$age</div><div class="line">[1] 21</div><div class="line"></div><div class="line">&gt; obj[c(&quot;name&quot;, &quot;age&quot;)]</div><div class="line">$name</div><div class="line">[1] &quot;will&quot;</div><div class="line"></div><div class="line">$age</div><div class="line">[1] 21</div></pre></td></tr></table></figure></p>
<p>DataFrame可以看作是带有每列含义的matrix矩阵。</p>
<p>文件操作<br>=<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&gt; p_data &lt;- read.csv(&quot;D:/qdsj-20170204094000&quot;)</div><div class="line">&gt; typeof(p_data)</div><div class="line">[1] &quot;list&quot;</div><div class="line">&gt; p_data$用户id[1]</div><div class="line">[1] 0f1d4b839353400998b7b289f895e369</div><div class="line">67788 Levels: 000188cb8d044291bd9984b8e04a224a ... ffff69f594cf48eb8867e8edcdb21e87</div></pre></td></tr></table></figure></p>
<p>可以看到有67788个level，也就是说这是已经把用户id这个字段自动因子化了。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">&gt; p_data &lt;- read.csv(&quot;D:/qdsj-20170204094000&quot;, stringsAsFactors = FALSE)</div><div class="line">&gt; p_data$用户id[1]</div><div class="line">[1] &quot;0f1d4b839353400998b7b289f895e369&quot;</div><div class="line">&gt; typeof(p_data)</div><div class="line">[1] &quot;list&quot;</div></pre></td></tr></table></figure>
<p>探索数据结构<br>=</p>
<p>进行可读化输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&gt; str(p_data)</div><div class="line">&apos;data.frame&apos;:	67788 obs. of  13 variables:</div><div class="line"> $ 用户id      : chr  &quot;0f1d4b839353400998b7b289f895e369&quot; &quot;d57eb5a615004c00af1476471577bcf8&quot; &quot;8ffd3d4e84db4cad841d0ed8c31e0fb5&quot; &quot;49cdd310f2854af09ccfde82e3ea4e06&quot; ...</div><div class="line"> $ 用户渠道    : chr  &quot;laiqiang_cpa_01&quot; &quot;laiqiang_cpa_01&quot; &quot;laiqiang_cpa_01&quot; &quot;laiqiang_cpa_01&quot; ...</div><div class="line"> $ 用户手机号  : chr  &quot;186****5084&quot; &quot;134****3636&quot; &quot;188****2253&quot; &quot;134****3632&quot; ...</div><div class="line"> $ 用户姓名    : chr  &quot;马先生&quot; &quot;张先生&quot; &quot;&quot; &quot;&quot; ...</div><div class="line"> $ 注册时间    : chr  &quot;2016-10-19 17:46:28&quot; &quot;2016-10-20 16:07:05&quot; &quot;2016-10-20 16:08:37&quot; &quot;2016-10-20 19:21:22&quot; ...</div><div class="line"> $ 开户时间    : chr  &quot;2016-10-19 17:51:24&quot; &quot;2016-10-20 16:09:13&quot; &quot;null&quot; &quot;null&quot; ...</div><div class="line"> $ 首投时间    : chr  &quot;2016-10-19 17:51:54&quot; &quot;2016-10-20 16:29:34&quot; &quot;null&quot; &quot;null&quot; ...</div><div class="line"> $ 首投金额    : num  1000 1000 0 0 1000 1000 1000 0 1000 1000 ...</div><div class="line"> $ 二投时间    : chr  &quot;null&quot; &quot;null&quot; &quot;null&quot; &quot;null&quot; ...</div><div class="line"> $ 二投金额    : num  0 0 0 0 1208 ...</div><div class="line"> $ 首投定期时间: chr  &quot;2016-10-19 17:52:38&quot; &quot;2016-10-20 16:30:27&quot; &quot;null&quot; &quot;null&quot; ...</div><div class="line"> $ 首投定期金额: num  1000 1000 0 0 0 1000 1000 0 1000 1000 ...</div><div class="line"> $ 凌晨前存量  : chr  &quot;\\N&quot; &quot;\\N&quot; &quot;\\N&quot; &quot;\\N&quot; ...</div></pre></td></tr></table></figure></p>
<p>探索数值型变量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&gt; summary(p_data$首投金额)</div><div class="line">   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. </div><div class="line">    0.0     0.0     0.0   128.1     0.0 50000.0</div></pre></td></tr></table></figure></p>
<p>可以找到DataFrame中这列的数值属性：最小值、第一四分位数、中位数、平均数、第三四分位数、最大值。</p>
<p>也可以同时看两列的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">&gt; summary(p_data[c(&quot;首投金额&quot;, &quot;二投金额&quot;)])</div><div class="line">    首投金额          二投金额       </div><div class="line"> Min.   :    0.0   Min.   :     0.0  </div><div class="line"> 1st Qu.:    0.0   1st Qu.:     0.0  </div><div class="line"> Median :    0.0   Median :     0.0  </div><div class="line"> Mean   :  128.1   Mean   :   228.7  </div><div class="line"> 3rd Qu.:    0.0   3rd Qu.:     0.0  </div><div class="line"> Max.   :50000.0   Max.   :200000.0</div></pre></td></tr></table></figure></p>
<table>
<thead>
<tr>
<th>示例</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>range(p_data$首投金额)</td>
<td>返回最小值和最大值</td>
</tr>
<tr>
<td>diff(a, b)</td>
<td>a和b的差值</td>
</tr>
<tr>
<td>IQR(p_data$首投金额)</td>
<td>四分位数中，中间的50%的差值（第三四分位数减去第一四分位数）</td>
</tr>
<tr>
<td>quantile(p_data$首投金额)</td>
<td>返回四分位的五个位置上的数。 还可以通过probs指定获取百分位数中任意位置的数</td>
</tr>
<tr>
<td>boxplot(p_data$首投金额, main=”sss”, ylab=”Money($)”)</td>
<td>将首投金额以箱图的形式绘图展示，名字是sss</td>
</tr>
<tr>
<td>hist(p_data$首投定期金额, main=”首投定期金额”, xlab= “Money($”)</td>
<td>直方图</td>
</tr>
<tr>
<td>var(p_data$首投金额)</td>
<td>方差</td>
</tr>
<tr>
<td>sd(p_data$首投金额)</td>
<td>标准差</td>
</tr>
<tr>
<td>table(p_data$首投金额)</td>
<td>以表的形式输出数据分布情况，每种值的个数</td>
</tr>
<tr>
<td>prop.table(table(p_data$首投金额))</td>
<td>以表的形式输出数据分布情况，每种值占总数的比例</td>
</tr>
<tr>
<td>plot(x=p_data$首投金额, y =p_data$二投金额, main=”变量关系”, xlab=”手头”, ylab=”二头”)</td>
<td>使用散点图展示两种特征值之间的关系， y是因变量，x是自变量</td>
</tr>
<tr>
<td>CrossTable(x=userdcars$model, y= userdcars$conservative)</td>
<td>使用双向交叉表检验变量之间的关系</td>
</tr>
</tbody>
</table>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div></pre></td><td class="code"><pre><div class="line">&gt; max(p_data$首投金额)</div><div class="line">[1] 50000</div><div class="line">&gt; min(p_data$首投金额)</div><div class="line">[1] 0</div><div class="line">&gt; IQR(p_data$首投金额)</div><div class="line">[1] 0</div><div class="line">&gt; range(p_data$首投金额)</div><div class="line">[1]     0 50000</div><div class="line">&gt; diff(range(p_data$首投金额))</div><div class="line">[1] 50000</div><div class="line">&gt; quantile(p_data$首投金额)</div><div class="line">   0%   25%   50%   75%  100% </div><div class="line">    0     0     0     0 50000 </div><div class="line">&gt; quantile(p_data$首投金额, probs = c (0.25, 0.5, 0.75, 0.97, 0.99))</div><div class="line"> 25%  50%  75%  97%  99% </div><div class="line">   0    0    0 1000 3000</div><div class="line">&gt; quantile(p_data$首投金额, probs = c (0.25, 0.5, 0.75, 0.97, 0.9999))</div><div class="line">25%     50%     75%     97%  99.99% </div><div class="line">0.0     0.0     0.0  1000.0 26106.5 </div><div class="line">&gt; quantile(p_data$首投金额, seq(from=0, to=1, by=0.1))</div><div class="line">   0%   10%   20%   30%   40%   50%   60%   70%   80%   90%  100% </div><div class="line">    0     0     0     0     0     0     0     0     0   100 50000 </div><div class="line">&gt; table(p_data$首投金额)</div><div class="line"></div><div class="line">      0     100     101  105.58     110     112     120     150     168     170 </div><div class="line">  60435    1282       3       1       2       1       1       1       1       1 </div><div class="line">&gt; prop.table(table(p_data$首投金额))</div><div class="line"></div><div class="line">           0          100          101       105.58          110          112 </div><div class="line">8.915295e-01 1.891190e-02 4.425562e-05 1.475187e-05 2.950375e-05 1.475187e-05</div><div class="line"></div><div class="line">&gt; usedcars$conservative &lt;-</div><div class="line">+   usedcars$color %in% c(&quot;Black&quot;, &quot;Gray&quot;, &quot;Silver&quot;, &quot;White&quot;)</div><div class="line">&gt; table(usedcars$conservative)</div><div class="line"></div><div class="line">FALSE  TRUE </div><div class="line">   51    99 </div><div class="line">&gt; CrossTable(x = usedcars$model, y = usedcars$conservative)</div><div class="line"></div><div class="line"> </div><div class="line">   Cell Contents</div><div class="line">|-------------------------|</div><div class="line">|                       N |</div><div class="line">| Chi-square contribution |</div><div class="line">|           N / Row Total |</div><div class="line">|           N / Col Total |</div><div class="line">|         N / Table Total |</div><div class="line">|-------------------------|</div><div class="line"></div><div class="line"> </div><div class="line">Total Observations in Table:  150 </div><div class="line"></div><div class="line"> </div><div class="line">               | usedcars$conservative </div><div class="line">usedcars$model |     FALSE |      TRUE | Row Total | </div><div class="line">---------------|-----------|-----------|-----------|</div><div class="line">            SE |        27 |        51 |        78 | </div><div class="line">               |     0.009 |     0.004 |           | </div><div class="line">               |     0.346 |     0.654 |     0.520 | </div><div class="line">               |     0.529 |     0.515 |           | </div><div class="line">               |     0.180 |     0.340 |           | </div><div class="line">---------------|-----------|-----------|-----------|</div><div class="line">           SEL |         7 |        16 |        23 | </div><div class="line">               |     0.086 |     0.044 |           | </div><div class="line">               |     0.304 |     0.696 |     0.153 | </div><div class="line">               |     0.137 |     0.162 |           | </div><div class="line">               |     0.047 |     0.107 |           | </div><div class="line">---------------|-----------|-----------|-----------|</div><div class="line">           SES |        17 |        32 |        49 | </div><div class="line">               |     0.007 |     0.004 |           | </div><div class="line">               |     0.347 |     0.653 |     0.327 | </div><div class="line">               |     0.333 |     0.323 |           | </div><div class="line">               |     0.113 |     0.213 |           | </div><div class="line">---------------|-----------|-----------|-----------|</div><div class="line">  Column Total |        51 |        99 |       150 | </div><div class="line">               |     0.340 |     0.660 |           | </div><div class="line">---------------|-----------|-----------|-----------|</div></pre></td></tr></table></figure>
<p>根据每个人所属年级，添加对应的平均年龄</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/02/08/R安装工具/" title="R安装工具" itemprop="url">R安装工具</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2017-02-08T06:33:05.000Z" itemprop="datePublished"> 发表于 2017-02-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>安装R的packages的时候官方提供了两种方式：</p>
<ul>
<li>交互式REPL里执行install.packages()</li>
<li>命令行执行R CMD INSTALL XXX.tar.gz</li>
</ul>
<p>由于是要初始化docker的R运行环境，如果要安装多个package，这两种方法都不太方便。</p>
<p>找到一个不错的工具R-littler, 安装完成后，可以通过执行自己定义的脚本进行R环境甚至程序的执行。</p>
<p>下面是实际使用的例子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">#!/usr/bin/env r</div><div class="line"></div><div class="line">repos &lt;- &quot;http://mirrors.tuna.tsinghua.edu.cn/CRAN/&quot;</div><div class="line"></div><div class="line">lib.loc &lt;- &quot;/usr/lib64/R/library&quot;</div><div class="line"></div><div class="line">install.packages(&quot;data.table&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;rJava&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;dplyr&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;bit64&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;stringr&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;ggplot2&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;RODBC&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;RJDBC&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;timeSeries&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;fUnitRoots&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;forecast&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;sqldf&quot;, lib.loc, repos)</div><div class="line">install.packages(&quot;lubridate&quot;, lib.loc, repos)</div></pre></td></tr></table></figure>
<p>把以上文件命名为install.r，赋予可执行权限即可。</p>
<p>这只是给准备环境而已，其实也可以尝试直接写自己的业务逻辑的。</p>
<p>参考：</p>
<ul>
<li><a href="http://dirk.eddelbuettel.com/code/littler.examples.html" target="_blank" rel="external">http://dirk.eddelbuettel.com/code/littler.examples.html</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/02/08/git-同时push到两个远程仓库/" title="git-同时push到两个远程仓库" itemprop="url">git-同时push到两个远程仓库</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2017-02-08T06:14:54.000Z" itemprop="datePublished"> 发表于 2017-02-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@will-vm:~/gitLearning/dobuleremote# git remote -v</div><div class="line">origin	git@github.com:WillCup/dobuleremote.git (fetch)</div><div class="line">origin	git@github.com:WillCup/dobuleremote.git (push)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git remote add ink git@10.1.5.83:/server/gitrepo/dpush.git</div></pre></td></tr></table></figure>
<p>之后就可以看到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">root@will-vm:~/gitLearning/dobuleremote# git remote -v</div><div class="line">ink	git@10.1.5.83:/server/gitrepo/dpush.git (fetch)</div><div class="line">ink	git@10.1.5.83:/server/gitrepo/dpush.git (push)</div><div class="line">origin	git@github.com:WillCup/dobuleremote.git (fetch)</div><div class="line">origin	git@github.com:WillCup/dobuleremote.git (push)</div></pre></td></tr></table></figure></p>
<p>可以通过push ink推送到新的远程仓库。</p>
<p>但是执行git status的时候发现，他是以origin为准的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">root@will-vm:~/gitLearning/dobuleremote# git st</div><div class="line">位于分支 master</div><div class="line">您的分支与上游分支 &apos;origin/master&apos; 一致。</div><div class="line">未跟踪的文件:</div><div class="line">  （使用 &quot;git add &lt;文件&gt;...&quot; 以包含要提交的内容）</div><div class="line"></div><div class="line">	both1</div><div class="line"></div><div class="line">提交为空，但是存在尚未跟踪的文件（使用 &quot;git add&quot; 建立跟踪）</div></pre></td></tr></table></figure></p>
<p>新建一个both文件，然后不加参数提交：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">root@will-vm:~/gitLearning/dobuleremote# ll</div><div class="line">总用量 12</div><div class="line">drwxr-xr-x  3 root root 4096 2月   8 14:17 ./</div><div class="line">drwxr-xr-x 29 root root 4096 2月   8 14:21 ../</div><div class="line">-rw-r--r--  1 root root    0 2月   8 14:17 both1</div><div class="line">drwxr-xr-x  8 root root 4096 2月   8 14:20 .git/</div><div class="line">-rw-r--r--  1 root root    0 2月   8 14:05 githubside</div><div class="line">-rw-r--r--  1 root root    0 2月   8 14:06 githubside2</div><div class="line"></div><div class="line">root@will-vm:~/gitLearning/dobuleremote# git push</div><div class="line">warning: push.default 尚未设置，它的默认值在 Git 2.0 已从 &apos;matching&apos;</div><div class="line">变更为 &apos;simple&apos;。若要不再显示本信息并保持传统习惯，进行如下设置：</div><div class="line"></div><div class="line">  git config --global push.default matching</div><div class="line"></div><div class="line">若要不再显示本信息并从现在开始采用新的使用习惯，设置：</div><div class="line"></div><div class="line">  git config --global push.default simple</div><div class="line"></div><div class="line">当 push.default 设置为 &apos;matching&apos; 后，git 将推送和远程同名的所有</div><div class="line">本地分支。</div><div class="line"></div><div class="line">从 Git 2.0 开始，Git 默认采用更为保守的 &apos;simple&apos; 模式，只推送当前</div><div class="line">分支到远程关联的同名分支，即 &apos;git push&apos; 推送当前分支。</div><div class="line"></div><div class="line">参见 &apos;git help config&apos; 并查找 &apos;push.default&apos; 以获取更多信息。</div><div class="line">（&apos;simple&apos; 模式由 Git 1.7.11 版本引入。如果您有时要使用老版本的 Git，</div><div class="line">为保持兼容，请用 &apos;current&apos; 代替 &apos;simple&apos;）</div><div class="line"></div><div class="line">对象计数中: 2, 完成.</div><div class="line">Delta compression using up to 2 threads.</div><div class="line">压缩对象中: 100% (2/2), 完成.</div><div class="line">写入对象中: 100% (2/2), 231 bytes | 0 bytes/s, 完成.</div><div class="line">Total 2 (delta 1), reused 0 (delta 0)</div><div class="line">remote: Resolving deltas: 100% (1/1), completed with 1 local objects.</div><div class="line">To git@github.com:WillCup/dobuleremote.git</div><div class="line">   2ba4199..8697e51  master -&gt; master</div></pre></td></tr></table></figure></p>
<p>可以看到是推送到了github端。到dpush那边也查看了一下，最新版本并没有出现这个文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">root@will-vm:~/gitLearning/dpush# ll</div><div class="line">总用量 12</div><div class="line">drwxr-xr-x  3 root root 4096 2月   8 14:21 ./</div><div class="line">drwxr-xr-x 29 root root 4096 2月   8 14:21 ../</div><div class="line">drwxr-xr-x  8 root root 4096 2月   8 14:21 .git/</div><div class="line">-rw-r--r--  1 root root    0 2月   8 14:21 githubside</div><div class="line">-rw-r--r--  1 root root    0 2月   8 14:21 githubside2</div></pre></td></tr></table></figure></p>
<p>其实也可以只为某个remote添加push，而并不添加pull：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">root@will-vm:~/gitLearning/dobuleremote# git remote set-url --add --push ink git@github.com:WillCup/dobuleremote.git</div><div class="line">root@will-vm:~/gitLearning/dobuleremote# git remote -v</div><div class="line">ink	git@10.1.5.83:/server/gitrepo/dpush.git (fetch)</div><div class="line">ink	git@github.com:WillCup/dobuleremote.git (push)</div><div class="line">origin	git@github.com:WillCup/dobuleremote.git (fetch)</div><div class="line">origin	git@github.com:WillCup/dobuleremote.git (push)</div><div class="line">root@will-vm:~/gitLearning/dobuleremote# git --version</div><div class="line">git version 2.7.4</div><div class="line">root@will-vm:~/gitLearning/dobuleremote# git remote set-url --add --push ink git@10.1.5.83:/server/gitrepo/dpush.git</div><div class="line">root@will-vm:~/gitLearning/dobuleremote# git remote -v</div><div class="line">ink	git@10.1.5.83:/server/gitrepo/dpush.git (fetch)</div><div class="line">ink	git@github.com:WillCup/dobuleremote.git (push)</div><div class="line">ink	git@10.1.5.83:/server/gitrepo/dpush.git (push)</div><div class="line">origin	git@github.com:WillCup/dobuleremote.git (fetch)</div><div class="line">origin	git@github.com:WillCup/dobuleremote.git (push)</div></pre></td></tr></table></figure></p>
<p>再添加一个文件both2，然后再push测试一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">root@will-vm:~/gitLearning/dobuleremote# touch both2</div><div class="line">root@will-vm:~/gitLearning/dobuleremote# git st</div><div class="line">位于分支 master</div><div class="line">您的分支与上游分支 &apos;origin/master&apos; 一致。</div><div class="line">未跟踪的文件:</div><div class="line">  （使用 &quot;git add &lt;文件&gt;...&quot; 以包含要提交的内容）</div><div class="line"></div><div class="line">	both2</div><div class="line"></div><div class="line">提交为空，但是存在尚未跟踪的文件（使用 &quot;git add&quot; 建立跟踪）</div><div class="line">root@will-vm:~/gitLearning/dobuleremote# git add .</div><div class="line">root@will-vm:~/gitLearning/dobuleremote# git ci -am &quot;both test 2&quot;</div><div class="line">[master 40cdebb] both test 2</div><div class="line"> 1 file changed, 0 insertions(+), 0 deletions(-)</div><div class="line"> create mode 100644 both2</div><div class="line">root@will-vm:~/gitLearning/dobuleremote# git push ink master</div><div class="line">对象计数中: 2, 完成.</div><div class="line">Delta compression using up to 2 threads.</div><div class="line">压缩对象中: 100% (2/2), 完成.</div><div class="line">写入对象中: 100% (2/2), 223 bytes | 0 bytes/s, 完成.</div><div class="line">Total 2 (delta 1), reused 0 (delta 0)</div><div class="line">remote: Resolving deltas: 100% (1/1), completed with 1 local objects.</div><div class="line">To git@github.com:WillCup/dobuleremote.git</div><div class="line">   8697e51..40cdebb  master -&gt; master</div><div class="line">对象计数中: 4, 完成.</div><div class="line">Delta compression using up to 2 threads.</div><div class="line">压缩对象中: 100% (4/4), 完成.</div><div class="line">写入对象中: 100% (4/4), 414 bytes | 0 bytes/s, 完成.</div><div class="line">Total 4 (delta 1), reused 0 (delta 0)</div><div class="line">To git@10.1.5.83:/server/gitrepo/dpush.git</div><div class="line">   2ba4199..40cdebb  master -&gt; master</div></pre></td></tr></table></figure></p>
<p>从上面的输出就可以看到，是push到了两个remote端，刚才落下的提交也一并被push过去了。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/01/20/ETL平台生产计划/" title="ETL平台生产计划" itemprop="url">ETL平台生产计划</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2017-01-20T07:54:46.000Z" itemprop="datePublished"> 发表于 2017-01-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <table>
<thead>
<tr>
<th>模块</th>
<th>功能简介</th>
<th>功效</th>
<th>备注</th>
<th>进度</th>
</tr>
</thead>
<tbody>
<tr>
<td>数据导出</td>
<td>分批定时</td>
<td>易于操作，一个调度时间，多个任务。减少人员修改数据调度的时间【当需要批量修改的时候】</td>
<td>调度的时候不再提供任务参数配置，只能在任务里这一个地方配置</td>
</tr>
<tr>
<td><del>任务恢复</del></td>
<td>任务执行中失败，修复后，原地爬起</td>
<td>避免重复执行前面已经成功的调度，提高资源使用价值，减少数据恢复需要的时间</td>
<td>方案：抽取azkaban的今日调度最新一次executions，找到失败的job，恢复执行。【看了一下azkaban的mysql数据结构，很难支持】   <br> <strong>最后方案</strong>：通过生成指定几个etl，重新生成其子节点的调度任务</td>
<td>完成</td>
</tr>
<tr>
<td>调度审核</td>
<td>所有需要上线的调度，都需专人review</td>
<td>保证线上集群的稳定运行，将风险降到最低</td>
</tr>
<tr>
<td>数据导出依赖感知</td>
<td>数据导出对平日ETL调度的依赖感知</td>
<td>对每日调度产生强依赖，不空跑</td>
<td>细粒度感知： 血统父表完成 <br> 粗粒度感知：调度完成</td>
</tr>
<tr>
<td>指定重新执行的脉路</td>
<td>生成指定ETL的所有子节点的调度</td>
<td>由于单个节点数据问题，导致所有子节点都要重跑的时候，一键完成</td>
<td>可以与上面的任务回复同效</td>
<td>完成</td>
</tr>
<tr>
<td>生成二代ETL模型</td>
<td>抽象出一个有依赖、有自己引擎的ETL模型，m2h/h2h/h2m/spark等都与这个东西关联，生成DAG的时候按照这个东西去生成</td>
<td>解决多重任务之间的依赖调度问题</td>
<td>可以作为2.0计划，改动稍大</td>
</tr>
<tr>
<td>HDFS概览</td>
<td>记录指定文件夹每天的数据量变化</td>
<td>各个业务线可以方便的看到自己数据库甚至表的大小变化情况</td>
<td>优先级别并不高，主要是为了提前预知一些突飞猛涨的数据目录，采取限制或者扩展的措施</td>
<td></td>
</tr>
<tr>
<td>非正常操作报警</td>
<td>出现数据调度变更，或者ETL对象变更的时候， 如果发起人并不是前一个发起人的话，就发送邮件或者短信通知，告诉前一个发起人，有人修改了你负责的东西</td>
<td>跨部门或者同部门人员出现误操作后，可追溯到责任人</td>
<td>调度可以通过在WillDependencyTask里添加完成，ETL对象可以在通用被继承的对象里完成。最简单可以通过log实现，但是不具备及时性，而且log是会定时清理的</td>
</tr>
<tr>
<td>YARN界面开放</td>
<td>开发给业务端开发人员查看，但是需要登陆权限验证，还有就是需要替换掉一些后端的url为代理的url，尽量让业务端少知晓后面的任何事情</td>
<td>辅助业务端人员调试</td>
<td>这个跟上一个功能一样，是个辅助功能, 可以共同放在一个辅助模块中</td>
<td></td>
</tr>
</tbody>
</table>
<p>docker化的nginx</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -d -p 80:80 -p 7070:7070 -p 8088:8088 -p 7000:7000 -p 9000:9000 -p 9090:9090 --name willnginx -v /server/wil/willnginx/conf.d:/etc/nginx/conf.d nginx:1.10</div></pre></td></tr></table></figure>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/01/18/R语言简记/" title="R语言简记" itemprop="url">R语言简记</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2017-01-18T03:10:55.000Z" itemprop="datePublished"> 发表于 2017-01-18</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>为新生成的data.frame指定列名：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">colnames(df) &lt;- c(&quot;a&quot;,&quot;b&quot;)</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">## 聚合one ~ one, one ~ many, many ~ one, and many ~ many:</div><div class="line">aggregate(weight ~ feed, data = chickwts, mean)</div><div class="line">aggregate(breaks ~ wool + tension, data = warpbreaks, mean)</div><div class="line">aggregate(cbind(Ozone, Temp) ~ Month, data = airquality, mean)</div><div class="line">aggregate(cbind(ncases, ncontrols) ~ alcgp + tobgp, data = esoph, sum)</div></pre></td></tr></table></figure>
<p>set.seed<br>=<br>set.seed()是为了设置一个随机数的种子，当想产生同样的一组随机数字的时候，就设置一下。这在统计分析中是经常用到的。</p>
<p>dim<br>=<br>dim()返回一个data.table的行、列数量。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">&gt; x &lt;- 1:12 ; dim(x) &lt;- c(3,4)</div><div class="line">&gt; x</div><div class="line">     [,1] [,2] [,3] [,4]</div><div class="line">[1,]    1    4    7   10</div><div class="line">[2,]    2    5    8   11</div><div class="line">[3,]    3    6    9   12</div><div class="line">&gt; dim(x)[1]</div><div class="line">[1] 3</div><div class="line">&gt; dim(x)[2]</div><div class="line">[1] 4</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/01/17/使用harbor安装docker-registry/" title="使用harbor安装docker-registry" itemprop="url">使用harbor安装docker-registry</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2017-01-17T08:34:40.000Z" itemprop="datePublished"> 发表于 2017-01-17</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="1-安装docker和docker-compose"><a href="#1-安装docker和docker-compose" class="headerlink" title="1. 安装docker和docker compose"></a>1. 安装docker和docker compose</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">sudo curl -sSL https://get.docker.com/ | sh</div><div class="line"># 设置Docker以非Root用户运行，确保安全。</div><div class="line">sudo usermod -aG docker your-user</div><div class="line"># 安装Compose：</div><div class="line">curl -L https://github.com/docker/compose/releases/download/1.7.0-rc1/docker-compose-`uname -s`-`uname -m` &gt; /usr/local/bin/docker-compose</div><div class="line">chmod +x /usr/local/bin/docker-compose</div></pre></td></tr></table></figure>
<ol>
<li>获取SSL证书[可选]</li>
</ol>
<p>如果使用域名绑定私有仓库，就必须开启SSL</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git clone https://github.com/letsencrypt/letsencrypt</div><div class="line">cd letsencrypt</div><div class="line">./letsencrypt-auto certonly -d docker.will.me</div></pre></td></tr></table></figure>
<ol>
<li>安装harbor</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">wget https://github.com/vmware/harbor/releases/download/0.5.0/harbor-offline-installer-0.5.0.tgz</div><div class="line">tar zxvf harbor-offline-installer-0.5.0.tgz</div></pre></td></tr></table></figure>
<p>修改一下harbor.cfg里的hostname<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hostname = 10.1.5.129</div></pre></td></tr></table></figure></p>
<p>其他的都没敢改，因为安装文档也没有特别深入的说明，暂时跑个demo而已，不要太拼。</p>
<p>但是目前有疑问的有两点：</p>
<blockquote>
<ol>
<li>mysql的连接没有指定，只有一个db_password, 那元数据存在哪？</li>
<li>没有指定docker image的数据文件存储位置，理论上这会是一个比较大的数据量</li>
</ol>
</blockquote>
<p>带着疑问，先开始安装：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">[root@controller harbor]# ./install.sh </div><div class="line"></div><div class="line">[Step 0]: checking installation environment ...</div><div class="line"></div><div class="line">Note: docker version: 1.12.6</div><div class="line"></div><div class="line">Note: docker-compose version: 1.7.0</div><div class="line"></div><div class="line">[Step 1]: loading Harbor images ...</div><div class="line">dd60b611baaa: Loading layer [==================================================&gt;] 133.2 MB/133.2 MB</div><div class="line">e541edf73dfb: Loading layer [==================================================&gt;] 3.072 kB/3.072 kB</div><div class="line">Loaded image: vmware/harbor-log:0.5.0&gt;                                          ]    512 B/3.072 kB</div><div class="line">f96222d75c55: Loading layer [==================================================&gt;] 128.9 MB/128.9 MB</div><div class="line">5a3deeae1518: Loading layer [==================================================&gt;] 4.608 kB/4.608 kB</div><div class="line">Loaded image: vmware/harbor-db:0.5.0                                            ]    512 B/4.608 kB</div><div class="line">7b612c5c8104: Loading layer [==================================================&gt;] 1.536 kB/1.536 kB</div><div class="line">5c07a2fe7c73: Loading layer [==================================================&gt;] 20.94 MB/20.94 MB</div><div class="line">Loaded image: vmware/harbor-jobservice:0.5.0                                    ] 229.4 kB/20.94 MB</div><div class="line">fe4c16cbf7a4: Loading layer [==================================================&gt;] 128.9 MB/128.9 MB</div><div class="line">c4a8b7411af4: Loading layer [==================================================&gt;] 60.57 MB/60.57 MB</div><div class="line">3f117c44afbb: Loading layer [==================================================&gt;] 3.584 kB/3.584 kB</div><div class="line">Loaded image: nginx:1.11.5r [=======&gt;                                           ]    512 B/3.584 kB</div><div class="line">4fe15f8d0ae6: Loading layer [==================================================&gt;] 5.046 MB/5.046 MB</div><div class="line">3bb5bc5ad373: Loading layer [==================================================&gt;] 2.048 kB/2.048 kB</div><div class="line">Loaded image: registry:2.5.0[============&gt;                                      ]    512 B/2.048 kB</div><div class="line">Loaded image: photon:1.0</div><div class="line">41be4a382617: Loading layer [==================================================&gt;] 58.31 MB/58.31 MB</div><div class="line">32ec73a38f19: Loading layer [==================================================&gt;] 23.62 MB/23.62 MB</div><div class="line">Loaded image: vmware/harbor-ui:0.5.0                                            ] 262.1 kB/23.62 MB</div><div class="line"></div><div class="line"></div><div class="line">[Step 2]: preparing environment ...</div><div class="line">generated and saved secret key</div><div class="line">Generated configuration file: ./common/config/nginx/nginx.conf</div><div class="line">Generated configuration file: ./common/config/ui/env</div><div class="line">Generated configuration file: ./common/config/ui/app.conf</div><div class="line">Generated configuration file: ./common/config/registry/config.yml</div><div class="line">Generated configuration file: ./common/config/db/env</div><div class="line">Generated configuration file: ./common/config/jobservice/env</div><div class="line">Generated configuration file: ./common/config/jobservice/app.conf</div><div class="line">Generated configuration file: ./common/config/ui/private_key.pem</div><div class="line">Generated configuration file: ./common/config/registry/root.crt</div><div class="line">The configuration files are ready, please use docker-compose to start the service.</div><div class="line"></div><div class="line"></div><div class="line">[Step 3]: checking existing instance of Harbor ...</div><div class="line"></div><div class="line"></div><div class="line">[Step 4]: starting Harbor ...</div><div class="line">Creating network &quot;harbor_default&quot; with the default driver</div><div class="line">Creating harbor-log</div><div class="line">Creating registry</div><div class="line">Creating harbor-db</div><div class="line">Creating harbor-ui</div><div class="line">Creating harbor-jobservice</div><div class="line">Creating nginx</div><div class="line"></div><div class="line">✔ ----Harbor has been installed and started successfully.----</div><div class="line"></div><div class="line">Now you should be able to visit the admin portal at http://10.1.5.129. </div><div class="line">For more details, please visit https://github.com/vmware/harbor .</div></pre></td></tr></table></figure></p>
<p>可以看到这是安装了一系列的docker iamge啊，难怪有离线和在线之分了。</p>
<p>闲着没事儿，看一下install.sh都干了啥<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"># 检查docker和docker-compose是不是符合版本要求</div><div class="line">check_docker</div><div class="line">check_dockercompose</div><div class="line"></div><div class="line"># load harbor的压缩包到当前docker的images库里</div><div class="line">if [ -f harbor*.tgz ]</div><div class="line">then</div><div class="line">        h2 &quot;[Step $item]: loading Harbor images ...&quot;; let item+=1</div><div class="line">        docker load -i ./harbor*.tgz</div><div class="line">fi</div><div class="line">echo &quot;&quot;</div><div class="line"></div><div class="line"># prepare就是读取harbor.cfg配置文件，准备环境变量</div><div class="line">h2 &quot;[Step $item]: preparing environment ...&quot;;  let item+=1</div><div class="line">if [ -n &quot;$host&quot; ]</div><div class="line">then</div><div class="line">        sed &quot;s/^hostname = .*/hostname = $host/g&quot; -i ./harbor.cfg</div><div class="line">fi</div><div class="line">./prepare</div><div class="line"></div><div class="line"># 查看有没有正在运行的harbor实例，有的话就停掉</div><div class="line">h2 &quot;[Step $item]: checking existing instance of Harbor ...&quot;; let item+=1</div><div class="line">if [ -n &quot;$(docker-compose -f docker-compose*.yml ps -q)&quot;  ]</div><div class="line">then</div><div class="line">        note &quot;stopping existing Harbor instance ...&quot;</div><div class="line">        docker-compose -f docker-compose*.yml down</div><div class="line">fi</div><div class="line">echo &quot;&quot;</div><div class="line"></div><div class="line"># 启动新的harbor实例</div><div class="line">h2 &quot;[Step $item]: starting Harbor ...&quot;</div><div class="line">docker-compose -f docker-compose*.yml up -d</div></pre></td></tr></table></figure></p>
<p>以上是主要步骤，其他的全都是不重要的。</p>
<p>查看一下当前的docker进程：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@controller harbor]# docker ps</div><div class="line">CONTAINER ID        IMAGE                            COMMAND                  CREATED             STATUS              PORTS                                      NAMES</div><div class="line">b8ed2fce6816        nginx:1.11.5                     &quot;nginx -g &apos;daemon off&quot;   5 minutes ago       Up 4 minutes        0.0.0.0:80-&gt;80/tcp, 0.0.0.0:443-&gt;443/tcp   nginx</div><div class="line">8408e2b03a4b        vmware/harbor-jobservice:0.5.0   &quot;/harbor/harbor_jobse&quot;   5 minutes ago       Up 4 minutes                                                   harbor-jobservice</div><div class="line">48b280c1caba        vmware/harbor-ui:0.5.0           &quot;/harbor/harbor_ui&quot;      6 minutes ago       Up 5 minutes                                                   harbor-ui</div><div class="line">0235e55493d0        vmware/harbor-db:0.5.0           &quot;docker-entrypoint.sh&quot;   6 minutes ago       Up 5 minutes        3306/tcp                                   harbor-db</div><div class="line">5bc55096ba78        library/registry:2.5.0           &quot;/entrypoint.sh serve&quot;   6 minutes ago       Up 5 minutes        5000/tcp                                   registry</div><div class="line">805f744b40ae        vmware/harbor-log:0.5.0          &quot;/bin/sh -c &apos;crond &amp;&amp;&quot;   6 minutes ago       Up 6 minutes        0.0.0.0:1514-&gt;514/tcp                      harbor-log</div></pre></td></tr></table></figure></p>
<p>该起来的全起来了，下面看一下harbor-db的参数，把数据弄到哪里去了？</p>
<p>docker inspect 看了一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">&quot;Mounts&quot;: [</div><div class="line">            &#123;</div><div class="line">                &quot;Source&quot;: &quot;/data/database&quot;,</div><div class="line">                &quot;Destination&quot;: &quot;/var/lib/mysql&quot;,</div><div class="line">                &quot;Mode&quot;: &quot;rw&quot;,</div><div class="line">                &quot;RW&quot;: true,</div><div class="line">                &quot;Propagation&quot;: &quot;rprivate&quot;</div><div class="line">            &#125;</div><div class="line">        ],</div></pre></td></tr></table></figure></p>
<p>mysql数据放到/data/database了。</p>
<p>再看一下registry的挂载情况：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">&quot;Mounts&quot;: [</div><div class="line">            &#123;</div><div class="line">                &quot;Source&quot;: &quot;/data/registry&quot;,</div><div class="line">                &quot;Destination&quot;: &quot;/storage&quot;,</div><div class="line">                &quot;Mode&quot;: &quot;rw&quot;,</div><div class="line">                &quot;RW&quot;: true,</div><div class="line">                &quot;Propagation&quot;: &quot;rprivate&quot;</div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                &quot;Source&quot;: &quot;/server/harbor/common/config/registry&quot;,</div><div class="line">                &quot;Destination&quot;: &quot;/etc/registry&quot;,</div><div class="line">                &quot;Mode&quot;: &quot;rw&quot;,</div><div class="line">                &quot;RW&quot;: true,</div><div class="line">                &quot;Propagation&quot;: &quot;rprivate&quot;</div><div class="line">            &#125;,</div><div class="line">            &#123;</div><div class="line">                &quot;Name&quot;: &quot;e8aab221ad99604d0f660695895eec3ff425cc0847ac5f0a3a803ab83e70275a&quot;,</div><div class="line">                &quot;Source&quot;: &quot;/var/lib/docker/volumes/e8aab221ad99604d0f660695895eec3ff425cc0847ac5f0a3a803ab83e70275a/_data&quot;,</div><div class="line">                &quot;Destination&quot;: &quot;/var/lib/registry&quot;,</div><div class="line">                &quot;Driver&quot;: &quot;local&quot;,</div><div class="line">                &quot;Mode&quot;: &quot;&quot;,</div><div class="line">                &quot;RW&quot;: true,</div><div class="line">                &quot;Propagation&quot;: &quot;&quot;</div><div class="line">            &#125;</div><div class="line">        ],</div></pre></td></tr></table></figure></p>
<p>此时以上两个目录还都是空的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@controller harbor]# ll /server/harbor/common/config/registry</div><div class="line">total 8</div><div class="line">-rw-r--r-- 1 root root  694 Jan 18 03:05 config.yml</div><div class="line">-rw-r--r-- 1 root root 2151 Jan 18 03:05 root.crt</div><div class="line">[root@controller harbor]# ll /data/database</div><div class="line">total 110608</div><div class="line">-rw-rw---- 1 systemd-bus-proxy ssh_keys       56 Jan 18 03:07 auto.cnf</div><div class="line">-rw-rw---- 1 systemd-bus-proxy ssh_keys 12582912 Jan 18 03:25 ibdata1</div><div class="line">-rw-rw---- 1 systemd-bus-proxy ssh_keys 50331648 Jan 18 03:25 ib_logfile0</div><div class="line">-rw-rw---- 1 systemd-bus-proxy ssh_keys 50331648 Jan 18 03:06 ib_logfile1</div><div class="line">drwx------ 2 systemd-bus-proxy ssh_keys     4096 Jan 18 03:07 mysql</div><div class="line">drwx------ 2 systemd-bus-proxy ssh_keys     4096 Jan 18 03:07 performance_schema</div><div class="line">drwx------ 2 systemd-bus-proxy ssh_keys     4096 Jan 18 03:07 registry</div></pre></td></tr></table></figure></p>
<p>参考：<br><a href="https://github.com/vmware/harbor/blob/master/docs/installation_guide.md" target="_blank" rel="external">https://github.com/vmware/harbor/blob/master/docs/installation_guide.md</a></p>
<h2 id="4-使用"><a href="#4-使用" class="headerlink" title="4. 使用"></a>4. 使用</h2><p>netstat -ntlp 发现80端口被启动了，应该就是它。下面就登陆一下harbor看一下</p>
<p>docker-compose.yml配置文件<br><figure class="highlight yml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div></pre></td><td class="code"><pre><div class="line"><span class="attr">version:</span> <span class="string">'2'</span></div><div class="line"><span class="attr">services:</span></div><div class="line"><span class="attr">  log:</span></div><div class="line"><span class="attr">    image:</span> vmware/harbor-log:<span class="number">0.5</span><span class="number">.0</span></div><div class="line"><span class="attr">    container_name:</span> harbor-log</div><div class="line"><span class="attr">    restart:</span> always</div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">      -</span> /var/log/harbor/:/var/log/docker/</div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="number">1514</span>:<span class="number">514</span></div><div class="line"><span class="attr">  registry:</span></div><div class="line"><span class="attr">    image:</span> library/registry:<span class="number">2.5</span><span class="number">.0</span></div><div class="line"><span class="attr">    container_name:</span> registry</div><div class="line"><span class="attr">    restart:</span> always</div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">      -</span> /data/registry:/storage</div><div class="line"><span class="bullet">      -</span> ./common/config/registry/:/etc/registry/</div><div class="line"><span class="attr">    environment:</span></div><div class="line"><span class="bullet">      -</span> GODEBUG=netdns=cgo</div><div class="line"><span class="attr">    command:</span></div><div class="line">      [<span class="string">"serve"</span>, <span class="string">"/etc/registry/config.yml"</span>]</div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> log</div><div class="line"><span class="attr">    logging:</span></div><div class="line"><span class="attr">      driver:</span> <span class="string">"syslog"</span></div><div class="line"><span class="attr">      options:</span></div><div class="line"><span class="attr">        syslog-address:</span> <span class="string">"tcp://127.0.0.1:1514"</span></div><div class="line"><span class="attr">        tag:</span> <span class="string">"registry"</span></div><div class="line"><span class="attr">  mysql:</span></div><div class="line"><span class="attr">    image:</span> vmware/harbor-db:<span class="number">0.5</span><span class="number">.0</span></div><div class="line"><span class="attr">    container_name:</span> harbor-db</div><div class="line"><span class="attr">    restart:</span> always</div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">      -</span> /data/database:/var/lib/mysql</div><div class="line"><span class="attr">    env_file:</span></div><div class="line"><span class="bullet">      -</span> ./common/config/db/env</div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> log</div><div class="line"><span class="attr">    logging:</span></div><div class="line"><span class="attr">      driver:</span> <span class="string">"syslog"</span></div><div class="line"><span class="attr">      options:</span></div><div class="line"><span class="attr">        syslog-address:</span> <span class="string">"tcp://127.0.0.1:1514"</span></div><div class="line"><span class="attr">        tag:</span> <span class="string">"mysql"</span></div><div class="line"><span class="attr">  ui:</span></div><div class="line"><span class="attr">    image:</span> vmware/harbor-ui:<span class="number">0.5</span><span class="number">.0</span></div><div class="line"><span class="attr">    container_name:</span> harbor-ui</div><div class="line"><span class="attr">    env_file:</span></div><div class="line"><span class="bullet">      -</span> ./common/config/ui/env</div><div class="line"><span class="attr">    restart:</span> always</div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">      -</span> ./common/config/ui/app.conf:/etc/ui/app.conf</div><div class="line"><span class="bullet">      -</span> ./common/config/ui/private_key.pem:/etc/ui/private_key.pem</div><div class="line"><span class="bullet">      -</span> /data:/harbor_storage</div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> log</div><div class="line"><span class="attr">    logging:</span></div><div class="line"><span class="attr">      driver:</span> <span class="string">"syslog"</span></div><div class="line"><span class="attr">      options:</span></div><div class="line"><span class="attr">        syslog-address:</span> <span class="string">"tcp://127.0.0.1:1514"</span></div><div class="line"><span class="attr">        tag:</span> <span class="string">"ui"</span></div><div class="line"><span class="attr">  jobservice:</span></div><div class="line"><span class="attr">    image:</span> vmware/harbor-jobservice:<span class="number">0.5</span><span class="number">.0</span></div><div class="line"><span class="attr">    container_name:</span> harbor-jobservice</div><div class="line"><span class="attr">    env_file:</span></div><div class="line"><span class="bullet">      -</span> ./common/config/jobservice/env</div><div class="line"><span class="attr">    restart:</span> always</div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">      -</span> /data/job_logs:/var/log/jobs</div><div class="line"><span class="bullet">      -</span> ./common/config/jobservice/app.conf:/etc/jobservice/app.conf</div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> ui</div><div class="line"><span class="attr">    logging:</span></div><div class="line"><span class="attr">      driver:</span> <span class="string">"syslog"</span></div><div class="line"><span class="attr">      options:</span></div><div class="line"><span class="attr">        syslog-address:</span> <span class="string">"tcp://127.0.0.1:1514"</span></div><div class="line"><span class="attr">        tag:</span> <span class="string">"jobservice"</span></div><div class="line"><span class="attr">  proxy:</span></div><div class="line"><span class="attr">    image:</span> nginx:<span class="number">1.11</span><span class="number">.5</span></div><div class="line"><span class="attr">    container_name:</span> nginx</div><div class="line"><span class="attr">    restart:</span> always</div><div class="line"><span class="attr">    volumes:</span></div><div class="line"><span class="bullet">      -</span> ./common/config/nginx:/etc/nginx</div><div class="line"><span class="attr">    ports:</span></div><div class="line"><span class="bullet">      -</span> <span class="number">80</span>:<span class="number">80</span></div><div class="line"><span class="bullet">      -</span> <span class="number">443</span>:<span class="number">443</span></div><div class="line"><span class="attr">    depends_on:</span></div><div class="line"><span class="bullet">      -</span> mysql</div><div class="line"><span class="bullet">      -</span> registry</div><div class="line"><span class="bullet">      -</span> ui</div><div class="line"><span class="bullet">      -</span> log</div><div class="line"><span class="attr">    logging:</span></div><div class="line"><span class="attr">      driver:</span> <span class="string">"syslog"</span></div><div class="line"><span class="attr">      options:</span></div><div class="line"><span class="attr">        syslog-address:</span> <span class="string">"tcp://127.0.0.1:1514"</span></div><div class="line"><span class="attr">        tag:</span> <span class="string">"proxy"</span></div></pre></td></tr></table></figure></p>
<ol>
<li>上传镜像<br>找一个安装了docker的机器，在/etc/docker/daemon.json文件中指定insecure-registries【因为我们上面并没有启用HTTPS协议】<figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&#123;</div><div class="line">  <span class="attr">"insecure-registries"</span>: [<span class="string">"10.1.5.129"</span>],</div><div class="line">  <span class="attr">"registry-mirrors"</span>: [<span class="string">"https://docker.mirrors.ustc.edu.cn"</span>,<span class="string">"http://3a35aff6.m.daocloud.io"</span>,<span class="string">"http://ethanzhu.m.tenxcloud.net"</span>]</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>把本地的镜像上传到<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">[root@dnode2 ~]# docker tag willr 10.1.5.129/library/willr:0.1</div><div class="line">[root@dnode2 ~]# docker login 10.1.5.129</div><div class="line">Username: admin</div><div class="line">Password: </div><div class="line">Login Succeeded</div><div class="line">[root@dnode2 ~]# docker images</div><div class="line">REPOSITORY                   TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">10.1.5.129/library/willr     0.1                 2a33c792d4aa        5 hours ago         718.7 MB</div><div class="line">willr                        latest              2a33c792d4aa        5 hours ago         718.7 MB</div><div class="line">&lt;none&gt;                       &lt;none&gt;              3dabf60e7d97        17 hours ago        714.7 MB</div><div class="line">uhopper/hadoop-nodemanager   2.7.2               046a3f819f63        41 hours ago        715.4 MB</div><div class="line">r-base                       3.3.2               dbee2cbef542        4 weeks ago         682.8 MB</div><div class="line">r-base                       latest              dbee2cbef542        4 weeks ago         682.8 MB</div><div class="line">[root@dnode2 ~]# docker push 10.1.5.129/library/willr:0.1</div><div class="line">The push refers to a repository [10.1.5.129/library/willr]</div><div class="line">0748650e84ed: Pushed </div><div class="line">72547fe7a086: Pushing [==================================================&gt;] 509.8 MB</div><div class="line">2cd05b2f5db4: Pushed </div><div class="line">72547fe7a086: Pushed </div><div class="line">c610e92140d8: Pushed </div><div class="line">3b04b5a81444: Pushed </div><div class="line">29d255cec883: Pushed </div><div class="line">29d255cec883: Preparing </div><div class="line"></div><div class="line">0.1: digest: sha256:9eb5d67aa235a1d7724b659310e8947c7e6cf967bef7ae02b955225fc7eb193a size: 1791</div><div class="line">[root@dnode2 ~]#</div></pre></td></tr></table></figure></p>
<p>页面中的显示<br><a href=""></a></p>
<p>参考：</p>
<ul>
<li><a href="http://www.jianshu.com/p/141855241f2d" target="_blank" rel="external">http://www.jianshu.com/p/141855241f2d</a></li>
<li><a href="https://vmware.github.io/harbor/index_cn.html" target="_blank" rel="external">https://vmware.github.io/harbor/index_cn.html</a></li>
<li><a href="https://my.oschina.net/u/1540325/blog/702260" target="_blank" rel="external">https://my.oschina.net/u/1540325/blog/702260</a></li>
<li><a href="http://www.zimug.com/317.html" target="_blank" rel="external">http://www.zimug.com/317.html</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/01/17/docker整理/" title="docker整理" itemprop="url">docker整理</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2017-01-17T07:41:46.000Z" itemprop="datePublished"> 发表于 2017-01-17</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="centos7的yum源"><a href="#centos7的yum源" class="headerlink" title="centos7的yum源"></a>centos7的yum源</h2><ul>
<li>清华的docker源<br><a href="https://mirrors.tuna.tsinghua.edu.cn/help/docker/" target="_blank" rel="external">https://mirrors.tuna.tsinghua.edu.cn/help/docker/</a></li>
<li>阿里的源<br><a href="http://mirrors.aliyun.com/" target="_blank" rel="external">http://mirrors.aliyun.com/</a></li>
</ul>
<h2 id="registry-mirror"><a href="#registry-mirror" class="headerlink" title="registry mirror"></a>registry mirror</h2><p>编辑或添加文件 /etc/docker/daemon.json<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  &quot;registry-mirrors&quot;: [&quot;https://docker.mirrors.ustc.edu.cn&quot;,&quot;http://3a35aff6.m.daocloud.io&quot;,&quot;http://ethanzhu.m.tenxcloud.net&quot;]</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>之后重启docker-daemon就可以了。</p>
<p>参考：</p>
<ul>
<li><a href="http://ethanzhu.leanote.com/post/docker-%E6%9B%B4%E6%94%B9" target="_blank" rel="external">http://ethanzhu.leanote.com/post/docker-%E6%9B%B4%E6%94%B9</a></li>
</ul>
<h2 id="修改docker-daemon配置"><a href="#修改docker-daemon配置" class="headerlink" title="修改docker daemon配置"></a>修改docker daemon配置</h2><p>查了好多资料，都说直接修改/etc/default/docker里的DOCKER_OPTS就可以制定registry mirror、镜像存储路径等各种docker daemon的启动参数，但是试了N次都没有成功，</p>
<p>其实细想一下，从启动脚本入手/etc/systemd/system/docker.service，官方说要在/etc/systemd/system/docker.service.d目录下创建自己的conf文件，修改启动命令的参数。我创建了一个will.conf<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[Service]</div><div class="line">ExecStart=</div><div class="line">ExecStart=/usr/bin/dockerd --graph=&quot;/server/dspace&quot;</div></pre></td></tr></table></figure></p>
<p>之后reload一下daemon的配置。供参考的<a href="http://docs-stage.docker.com/v1.10/engine/reference/commandline/daemon/" target="_blank" rel="external">参数信息</a></p>
<p>要修改的主要参数在于<strong>启动service里的ExecStart</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">systemctl daemon-reload</div></pre></td></tr></table></figure>
<p>再去看指定的目录和docker info信息，发现已经修改过来了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@dnode2 ~]# ll /server/dspace/</div><div class="line">total 32</div><div class="line">drwx------ 2 root root 4096 Jan 18 23:48 containers</div><div class="line">drwx------ 4 root root 4096 Jan 18 23:48 devicemapper</div><div class="line">drwx------ 3 root root 4096 Jan 18 23:48 image</div><div class="line">drwxr-x--- 3 root root 4096 Jan 18 23:48 network</div><div class="line">drwx------ 2 root root 4096 Jan 18 23:48 swarm</div><div class="line">drwx------ 2 root root 4096 Jan 18 23:48 tmp</div><div class="line">drwx------ 2 root root 4096 Jan 18 23:48 trust</div><div class="line">drwx------ 2 root root 4096 Jan 18 23:48 volumes</div><div class="line">[root@dnode2 ~]# docker images</div><div class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</div></pre></td></tr></table></figure></p>
<p>刚才的images也都查不到了，停掉docker daemon，手动把原来的镜像全都copy过来，启动docker daemon就可以了。</p>
<p>综上，其实已经有两种方式配置docker daemon的启动参数了，一个是在service.docker.d目录里添加自己id配置文件will.conf，直接修改启动命令并指定参数。另一个就是编辑/etc/docker/daemon.json文件。</p>
<p>应该是两种方式都可以行得通，但是命令行和json的参数并不完全对应，需要找一下json的mapping key，现在觉得json 的方式会更加友好一些。</p>
<p>参考</p>
<ul>
<li>官网 <a href="https://docs.docker.com/engine/admin/systemd/" target="_blank" rel="external">https://docs.docker.com/engine/admin/systemd/</a></li>
<li><a href="http://blog.csdn.net/l6807718/article/details/51325431" target="_blank" rel="external">http://blog.csdn.net/l6807718/article/details/51325431</a></li>
</ul>
<p>杂记<br>=</p>
<ol>
<li>docker容器的cpu和memory是可以调整集群资源参数的，有limit设置；</li>
<li>Dockerfile里声明volume的目录是对于任何的volumes命令参数不可变的，会自动生成一个挂载点，目的是不让host直接修改，作为一个数据容器为其他镜像提供volume挂载服务。【–volumes-from】<br><a href="https://docs.docker.com/engine/reference/builder/#/volume" target="_blank" rel="external">https://docs.docker.com/engine/reference/builder/#/volume</a><br><a href="http://www.cnblogs.com/51kata/p/5266626.html" target="_blank" rel="external">http://www.cnblogs.com/51kata/p/5266626.html</a></li>
</ol>
<p>docker swarm<br>=</p>
<h4 id="1-启动manager，初始化集群"><a href="#1-启动manager，初始化集群" class="headerlink" title="1. 启动manager，初始化集群"></a>1. 启动manager，初始化集群</h4><p>manager机器上执行：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker swarm init --advertise-addr 10.1.5.129</div><div class="line">Swarm initialized: current node (efpood09fyouiyib1f78y5oa6) is now a manager.</div><div class="line"></div><div class="line">To add a worker to this swarm, run the following command:</div><div class="line"></div><div class="line">    docker swarm join \</div><div class="line">    --token SWMTKN-1-50wivhmqel8u7pnorhfpu5a8qrfvged69b6r8v06jzscsysds2-3yllw8v8deku690gd8a8pfio1 \</div><div class="line">    10.1.5.129:2377</div><div class="line"></div><div class="line">To add a manager to this swarm, run &apos;docker swarm join-token manager&apos; and follow the instructions.</div><div class="line">[root@controller wil]# docker info</div><div class="line">.....</div><div class="line">.....</div><div class="line">Swarm: active</div><div class="line"> NodeID: efpood09fyouiyib1f78y5oa6</div><div class="line"> Is Manager: true</div><div class="line"> ClusterID: 4wnicl4f2vvtlpmpa2pyj28ji</div><div class="line"> Managers: 1</div><div class="line"> Nodes: 1</div><div class="line"> Orchestration:</div><div class="line">  Task History Retention Limit: 5</div><div class="line"> Raft:</div><div class="line">  Snapshot Interval: 10000</div><div class="line">  Heartbeat Tick: 1</div><div class="line">  Election Tick: 3</div><div class="line"> Dispatcher:</div><div class="line">  Heartbeat Period: 5 seconds</div><div class="line"> CA Configuration:</div><div class="line">  Expiry Duration: 3 months</div><div class="line"> Node Address: 10.1.5.129</div><div class="line">Runtimes: runc</div><div class="line">.....</div><div class="line">.....</div></pre></td></tr></table></figure></p>
<p>可以看到初始化后，docker info里显示了swarm相关的信息。</p>
<p>查看当前swarm集群中的机器：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]#  docker node ls</div><div class="line">ID                           HOSTNAME    STATUS  AVAILABILITY  MANAGER STATUS</div><div class="line">efpood09fyouiyib1f78y5oa6 *  controller  Ready   Active        Leader</div></pre></td></tr></table></figure></p>
<p>* 代表的是当前机器</p>
<h4 id="2-添加node"><a href="#2-添加node" class="headerlink" title="2.添加node"></a>2.添加node</h4><p>可以在manager节点上确认一下加入集群需要的token：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker swarm join-token worker</div><div class="line">To add a worker to this swarm, run the following command:</div><div class="line"></div><div class="line">    docker swarm join \</div><div class="line">    --token SWMTKN-1-50wivhmqel8u7pnorhfpu5a8qrfvged69b6r8v06jzscsysds2-3yllw8v8deku690gd8a8pfio1 \</div><div class="line">    10.1.5.129:2377</div></pre></td></tr></table></figure></p>
<p>然后分别在dnode1、dnode2上运行此命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@dnode2 willdjango]# docker swarm join \</div><div class="line">&gt;     --token SWMTKN-1-50wivhmqel8u7pnorhfpu5a8qrfvged69b6r8v06jzscsysds2-3yllw8v8deku690gd8a8pfio1 \</div><div class="line">&gt;     10.1.5.129:2377</div><div class="line"></div><div class="line">This node joined a swarm as a worker.</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@dnode1 server]# docker swarm join \</div><div class="line">&gt;     --token SWMTKN-1-50wivhmqel8u7pnorhfpu5a8qrfvged69b6r8v06jzscsysds2-3yllw8v8deku690gd8a8pfio1 \</div><div class="line">&gt;     10.1.5.129:2377</div><div class="line"></div><div class="line">This node joined a swarm as a worker.</div></pre></td></tr></table></figure>
<p>再查看当前集群node状态, 此命令只能在manager所在的节点上执行，worker节点没有权限：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker node ls</div><div class="line">ID                           HOSTNAME    STATUS  AVAILABILITY  MANAGER STATUS</div><div class="line">0c67km60csfft6paxdsodp8ss    dnode2      Ready   Active        </div><div class="line">759vbg6zxxzffj4i3pw21249y    dnode1      Ready   Active        </div><div class="line">efpood09fyouiyib1f78y5oa6 *  controller  Ready   Active        Leader</div></pre></td></tr></table></figure></p>
<h4 id="3-部署服务"><a href="#3-部署服务" class="headerlink" title="3. 部署服务"></a>3. 部署服务</h4><p>创建一个service：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker service create --replicas 1 --name resourcemanager_swarm willcup/yarn:0.1 /bin/bash</div><div class="line">0nnc9cpf1ebhbw6ixbro9q8wn</div><div class="line">[root@controller wil]# docker service ls</div><div class="line">ID            NAME                   REPLICAS  IMAGE             COMMAND</div><div class="line">0nnc9cpf1ebh  resourcemanager_swarm  0/1       willcup/yarn:0.1  /bin/bash</div></pre></td></tr></table></figure></p>
<p>查看这个service的元信息：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker service inspect --pretty resourcemanager_swarm</div><div class="line">ID:		0nnc9cpf1ebhbw6ixbro9q8wn</div><div class="line">Name:		resourcemanager_swarm</div><div class="line">Mode:		Replicated</div><div class="line"> Replicas:	1</div><div class="line">Placement:</div><div class="line">UpdateConfig:</div><div class="line"> Parallelism:	1</div><div class="line"> On failure:	pause</div><div class="line">ContainerSpec:</div><div class="line"> Image:		willcup/yarn:0.1</div><div class="line"> Args:		/bin/bash</div><div class="line">Resources:</div></pre></td></tr></table></figure></p>
<p>查看这个service的进程所在：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker service ps resourcemanager_swarm</div><div class="line">ID                         NAME                         IMAGE             NODE        DESIRED STATE  CURRENT STATE            ERROR</div><div class="line">dss32jnwz7aaxtqemvxpke4gg  resourcemanager_swarm.1      willcup/yarn:0.1  dnode2      Running        Preparing 5 minutes ago  </div><div class="line">1az4a1ctb9y3io2oswew0zab9   \_ resourcemanager_swarm.1  willcup/yarn:0.1  controller  Shutdown       Complete 2 minutes ago</div></pre></td></tr></table></figure></p>
<p>像这个我们的例子中就是，在controller中启动未成功，然后转到dnode1上运行了。但是两次执行的DESIRED STATE和CURRENT STATE并不吻合。看了一下是我们的manager机器【也就是上面的controller】并不认识dnode2，配置一下hosts。再查看一下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker service ps resourcemanager_swarm</div><div class="line">ID                         NAME                         IMAGE             NODE        DESIRED STATE  CURRENT STATE            ERROR</div><div class="line">bvrtqkl8iybt5rr5kqlj6mio2  resourcemanager_swarm.1      willcup/yarn:0.1  controller  Running        Running 10 seconds ago   </div><div class="line">dss32jnwz7aaxtqemvxpke4gg   \_ resourcemanager_swarm.1  willcup/yarn:0.1  dnode2      Shutdown       Complete 4 minutes ago   </div><div class="line">1az4a1ctb9y3io2oswew0zab9   \_ resourcemanager_swarm.1  willcup/yarn:0.1  controller  Shutdown       Complete 10 minutes ago  </div><div class="line">[root@controller wil]# docker service ps resourcemanager_swarm</div><div class="line">ID                         NAME                         IMAGE             NODE        DESIRED STATE  CURRENT STATE                ERROR</div><div class="line">c2btlmupl7r9ss3dents28928  resourcemanager_swarm.1      willcup/yarn:0.1  controller  Running        Preparing 22 seconds ago     </div><div class="line">99hilqo2an723j9k7n2grkf0o   \_ resourcemanager_swarm.1  willcup/yarn:0.1  dnode2      Shutdown       Complete 3 minutes ago       </div><div class="line">a16ktljr241g9zn6qluunx84l   \_ resourcemanager_swarm.1  willcup/yarn:0.1  controller  Shutdown       Complete about a minute ago  </div><div class="line">c52kek07d8uve9kqjsf3vcgh3   \_ resourcemanager_swarm.1  willcup/yarn:0.1  dnode2      Shutdown       Complete 6 minutes ago       </div><div class="line">bvrtqkl8iybt5rr5kqlj6mio2   \_ resourcemanager_swarm.1  willcup/yarn:0.1  controller  Shutdown       Complete 4 minutes ago</div></pre></td></tr></table></figure></p>
<p>总是出问题。。。</p>
<p>还是用官网的吧：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker service create --replicas 1 --name helloworld alpine ping docker.com</div><div class="line">2q5p0ahn92aa8be9el23j93yx</div><div class="line">[root@controller wil]# docker service ps helloworld</div><div class="line">ID                         NAME          IMAGE   NODE        DESIRED STATE  CURRENT STATE            ERROR</div><div class="line">dvjcrjztbqkj3x5e8fggraw0f  helloworld.1  alpine  controller  Running        Preparing 6 seconds ago  </div><div class="line">[root@controller wil]# docker service ps helloworld</div><div class="line">ID                         NAME          IMAGE   NODE        DESIRED STATE  CURRENT STATE           ERROR</div><div class="line">dvjcrjztbqkj3x5e8fggraw0f  helloworld.1  alpine  controller  Running        Starting 4 seconds ago  </div><div class="line">[root@controller wil]# docker service ps helloworld</div><div class="line">ID                         NAME          IMAGE   NODE        DESIRED STATE  CURRENT STATE           ERROR</div><div class="line">dvjcrjztbqkj3x5e8fggraw0f  helloworld.1  alpine  controller  Running        Starting 8 seconds ago  </div><div class="line">[root@controller wil]# docker service ps helloworld</div><div class="line">ID                         NAME          IMAGE   NODE        DESIRED STATE  CURRENT STATE               ERROR</div><div class="line">dvjcrjztbqkj3x5e8fggraw0f  helloworld.1  alpine  controller  Running        Running about a minute ago</div></pre></td></tr></table></figure></p>
<p>说是在controller上运行着的，我们就到controller机器上ps一下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker ps</div><div class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</div><div class="line">5653c87be989        alpine:latest       &quot;ping docker.com&quot;   4 minutes ago       Up 3 minutes                            helloworld.1.dvjcrjztbqkj3x5e8fggraw0f</div></pre></td></tr></table></figure></p>
<h4 id="4-服务扩容"><a href="#4-服务扩容" class="headerlink" title="4. 服务扩容"></a>4. 服务扩容</h4><p>对于后台服务，很多时候我们是部署多个，然后再前面部署负载均衡的。我们可以通过swarm的命令轻松的将我们的服务进行扩容：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker service scale helloworld=5</div><div class="line">helloworld scaled to 5</div><div class="line">[root@controller wil]# docker service ps helloworld</div><div class="line">ID                         NAME          IMAGE   NODE        DESIRED STATE  CURRENT STATE                     ERROR</div><div class="line">dvjcrjztbqkj3x5e8fggraw0f  helloworld.1  alpine  controller  Running        Running 5 minutes ago             </div><div class="line">5x3rsxhw31w5prpwhvh5bzn8m  helloworld.2  alpine  dnode2      Running        Preparing 2 minutes ago           </div><div class="line">1ymr6qzfzvpjc86lwx7c7p938  helloworld.3  alpine  dnode1      Running        Preparing 16 seconds ago          </div><div class="line">3h36sr8m8c4f7utei50ss9tav  helloworld.4  alpine  dnode1      Running        Preparing 16 seconds ago          </div><div class="line">eneop6ooju630tzpxt8vlftjw  helloworld.5  alpine  controller  Running        Preparing less than a second ago  </div><div class="line">[root@controller wil]# docker service ps helloworld</div><div class="line">ID                         NAME          IMAGE   NODE        DESIRED STATE  CURRENT STATE               ERROR</div><div class="line">dvjcrjztbqkj3x5e8fggraw0f  helloworld.1  alpine  controller  Running        Running 7 minutes ago       </div><div class="line">5x3rsxhw31w5prpwhvh5bzn8m  helloworld.2  alpine  dnode2      Running        Running 3 minutes ago       </div><div class="line">1ymr6qzfzvpjc86lwx7c7p938  helloworld.3  alpine  dnode1      Running        Running about a minute ago  </div><div class="line">3h36sr8m8c4f7utei50ss9tav  helloworld.4  alpine  dnode1      Running        Running about a minute ago  </div><div class="line">eneop6ooju630tzpxt8vlftjw  helloworld.5  alpine  controller  Running        Running about a minute ago</div></pre></td></tr></table></figure></p>
<p>可以看到，实现了扩容，自动将container重命名，并且分布到了不同的节点之上。</p>
<h4 id="5-删除服务"><a href="#5-删除服务" class="headerlink" title="5. 删除服务"></a>5. 删除服务</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker service rm helloworld</div><div class="line">helloworld</div><div class="line">[root@controller wil]# docker service ps helloworld</div><div class="line">Error: No such service: helloworld</div></pre></td></tr></table></figure>
<p>虽然service很快就被删除了，但是其实container是需要一些时间才能清理干净的。开始的时候docker ps还能看到部分，稍等一下就没有了：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker ps -a</div><div class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                     PORTS               NAMES</div><div class="line">5653c87be989        alpine:latest       &quot;ping docker.com&quot;        10 minutes ago      Removal In Progress                            helloworld.1.dvjcrjztbqkj3x5e8fggraw0f</div><div class="line">fb3c81306678        a6a1f5eb98f2        &quot;bash /entrypoint.sh &quot;   3 hours ago         Exited (1) 3 hours ago                         composetest_nodemanager_1</div><div class="line">c191fc0db545        a6a1f5eb98f2        &quot;bash /entrypoint.sh &quot;   19 hours ago        Exited (137) 3 hours ago                       composetest_resourcemanager_1</div><div class="line">[root@controller wil]# docker ps -a</div><div class="line">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                     PORTS               NAMES</div><div class="line">fb3c81306678        a6a1f5eb98f2        &quot;bash /entrypoint.sh &quot;   3 hours ago         Exited (1) 3 hours ago                         composetest_nodemanager_1</div><div class="line">c191fc0db545        a6a1f5eb98f2        &quot;bash /entrypoint.sh &quot;   19 hours ago        Exited (137) 3 hours ago                       composetest_resourcemanager_1</div></pre></td></tr></table></figure></p>
<h4 id="5-节点维护"><a href="#5-节点维护" class="headerlink" title="5. 节点维护"></a>5. 节点维护</h4><p>有的时候我们要临时维护几台节点，就需要把这个节点标记下线，为了不影响服务质量，需要把正在运行的服务转移到其他节点上。swarm会自动为我们做这些工作，我们只需要标记某个节点为drain就可以了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker service ps helloworld</div><div class="line">ID                         NAME          IMAGE   NODE        DESIRED STATE  CURRENT STATE               ERROR</div><div class="line">ciw4f1ibuwuqjv2hvn6s1mqs9  helloworld.1  alpine  dnode1      Running        Running about a minute ago  </div><div class="line">0ezba4uegtfmajlkw6kbw66q5  helloworld.2  alpine  dnode2      Running        Running 4 minutes ago       </div><div class="line">dnb7d4cjwes3ubywn6iv2vpiu  helloworld.3  alpine  controller  Running        Running about a minute ago  </div><div class="line">dyidqdhh7n04m0sk3k0fy74yp  helloworld.4  alpine  controller  Running        Running about a minute ago  </div><div class="line">66lmmu30fywqqey7lpirz5o6s  helloworld.5  alpine  dnode1      Running        Running about a minute ago  </div><div class="line">[root@controller wil]# docker node update --availability drain dnode1</div><div class="line">dnode1</div><div class="line">[root@controller wil]# docker node ls</div><div class="line">ID                           HOSTNAME    STATUS  AVAILABILITY  MANAGER STATUS</div><div class="line">0c67km60csfft6paxdsodp8ss    dnode2      Ready   Active        </div><div class="line">759vbg6zxxzffj4i3pw21249y    dnode1      Ready   Drain         </div><div class="line">efpood09fyouiyib1f78y5oa6 *  controller  Ready   Active        Leader</div><div class="line">[root@controller wil]# docker service ps helloworld</div><div class="line">ID                         NAME              IMAGE   NODE        DESIRED STATE  CURRENT STATE               ERROR</div><div class="line">9sxv9bi0j7yy341rtp6hkrm0e  helloworld.1      alpine  dnode2      Ready          Preparing 3 minutes ago     </div><div class="line">ciw4f1ibuwuqjv2hvn6s1mqs9   \_ helloworld.1  alpine  dnode1      Shutdown       Running 2 minutes ago       </div><div class="line">0ezba4uegtfmajlkw6kbw66q5  helloworld.2      alpine  dnode2      Running        Running 4 minutes ago       </div><div class="line">dnb7d4cjwes3ubywn6iv2vpiu  helloworld.3      alpine  controller  Running        Running about a minute ago  </div><div class="line">dyidqdhh7n04m0sk3k0fy74yp  helloworld.4      alpine  controller  Running        Running about a minute ago  </div><div class="line">8ozxlg29d4ynko3plauupuuu5  helloworld.5      alpine  dnode2      Ready          Preparing 3 minutes ago     </div><div class="line">66lmmu30fywqqey7lpirz5o6s   \_ helloworld.5  alpine  dnode1      Shutdown       Running 2 minutes ago       </div><div class="line">[root@controller wil]# docker service ps helloworld</div><div class="line">ID                         NAME              IMAGE   NODE        DESIRED STATE  CURRENT STATE               ERROR</div><div class="line">9sxv9bi0j7yy341rtp6hkrm0e  helloworld.1      alpine  dnode2      Running        Preparing 3 minutes ago     </div><div class="line">ciw4f1ibuwuqjv2hvn6s1mqs9   \_ helloworld.1  alpine  dnode1      Shutdown       Shutdown 19 seconds ago     </div><div class="line">0ezba4uegtfmajlkw6kbw66q5  helloworld.2      alpine  dnode2      Running        Running 5 minutes ago       </div><div class="line">dnb7d4cjwes3ubywn6iv2vpiu  helloworld.3      alpine  controller  Running        Running about a minute ago  </div><div class="line">dyidqdhh7n04m0sk3k0fy74yp  helloworld.4      alpine  controller  Running        Running about a minute ago  </div><div class="line">8ozxlg29d4ynko3plauupuuu5  helloworld.5      alpine  dnode2      Running        Preparing 3 minutes ago     </div><div class="line">66lmmu30fywqqey7lpirz5o6s   \_ helloworld.5  alpine  dnode1      Shutdown       Shutdown 20 seconds ago</div></pre></td></tr></table></figure></p>
<p>当维护完成之后，再把node状态更新回来：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker node update --availability active dnode1</div><div class="line">dnode1</div><div class="line">[root@controller wil]# docker service ps helloworld</div><div class="line">ID                         NAME              IMAGE   NODE        DESIRED STATE  CURRENT STATE           ERROR</div><div class="line">9sxv9bi0j7yy341rtp6hkrm0e  helloworld.1      alpine  dnode2      Running        Running 4 minutes ago   </div><div class="line">ciw4f1ibuwuqjv2hvn6s1mqs9   \_ helloworld.1  alpine  dnode1      Shutdown       Shutdown 2 minutes ago  </div><div class="line">0ezba4uegtfmajlkw6kbw66q5  helloworld.2      alpine  dnode2      Running        Running 6 minutes ago   </div><div class="line">dnb7d4cjwes3ubywn6iv2vpiu  helloworld.3      alpine  controller  Running        Running 3 minutes ago   </div><div class="line">dyidqdhh7n04m0sk3k0fy74yp  helloworld.4      alpine  controller  Running        Running 3 minutes ago   </div><div class="line">8ozxlg29d4ynko3plauupuuu5  helloworld.5      alpine  dnode2      Running        Running 4 minutes ago   </div><div class="line">66lmmu30fywqqey7lpirz5o6s   \_ helloworld.5  alpine  dnode1      Shutdown       Shutdown 2 minutes ago  </div><div class="line">[root@controller wil]# docker node ls</div><div class="line">ID                           HOSTNAME    STATUS  AVAILABILITY  MANAGER STATUS</div><div class="line">0c67km60csfft6paxdsodp8ss    dnode2      Ready   Active        </div><div class="line">759vbg6zxxzffj4i3pw21249y    dnode1      Ready   Active        </div><div class="line">efpood09fyouiyib1f78y5oa6 *  controller  Ready   Active        Leader</div></pre></td></tr></table></figure></p>
<p>但是服务如果不出问题的话，不会自动迁移回dnode1了。</p>
<p>通常我们可以让manager节点是drain的，以保证它负载低，集群能正常运行。</p>
<h4 id="6-路由"><a href="#6-路由" class="headerlink" title="6. 路由"></a>6. 路由</h4><p>所有的swarm节点都加入了一个ingress的routing mesh。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker network ls</div><div class="line">NETWORK ID          NAME                  DRIVER              SCOPE</div><div class="line">6461c2e9e64e        bridge                bridge              local               </div><div class="line">5d5d0be2f5a6        docker_gwbridge       bridge              local               </div><div class="line">e2bbfd5c0b62        host                  host                local               </div><div class="line">0r5dk7ja8vw7        ingress               overlay             swarm               </div><div class="line">01c12cd7bba7        none                  null                local</div></pre></td></tr></table></figure>
<p>routing mesh会把所有对于public port的请求转发到所有对应service的节点的container上。</p>
<p>先搞一个有public接口的service:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker service create \</div><div class="line">&gt;   --name my-web \</div><div class="line">&gt;   --publish 8080:80 \</div><div class="line">&gt;   --replicas 2 \</div><div class="line">&gt;   nginx</div><div class="line">2lsi4py6pbcu96ttnjyqj7u4i</div><div class="line">[root@controller wil]# docker service ps my-web</div><div class="line">ID                         NAME      IMAGE  NODE    DESIRED STATE  CURRENT STATE             ERROR</div><div class="line">84xjxx4kth0idnzuob4186cn7  my-web.1  nginx  dnode1  Running        Preparing 20 seconds ago  </div><div class="line">0fqk2zwyp9u2ohi9iu91qli50  my-web.2  nginx  dnode2  Running        Preparing 3 minutes ago</div></pre></td></tr></table></figure></p>
<p>这个命令会在所有的node上都开放8080端口，swarm的load balancer会把对于任何一个node的8080接口的请求路由给active的container【这里就是dnode1和dnode2】。</p>
<p>也可以为正在运行的服务添加开放的端口映射：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ docker service update \</div><div class="line">  --publish-add &lt;PUBLISHED-PORT&gt;:&lt;TARGET-PORT&gt; \</div><div class="line">  &lt;SERVICE&gt;</div></pre></td></tr></table></figure></p>
<p>查看某service开放的端口：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]#  docker service inspect --format=&quot;&#123;&#123;json .Endpoint.Spec.Ports&#125;&#125;&quot; my-web</div><div class="line">[&#123;&quot;Protocol&quot;:&quot;tcp&quot;,&quot;TargetPort&quot;:80,&quot;PublishedPort&quot;:8080&#125;]</div></pre></td></tr></table></figure></p>
<p>单独指定开放tcp/udp端口，默认就是TCP：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">$ docker service create --name dns-cache -p 53:53/tcp dns-cache</div><div class="line">$ docker service create --name dns-cache -p 53:53/udp dns-cache</div></pre></td></tr></table></figure></p>
<p>因为目前是有三个node的8080都可以提供服务，所以我们也可以在他们之外再加个HAProxy做负载均衡。<br>其实如果swarm自己的调度器能够均匀分发请求给不同的container的话，也没有必要弄外部的LB了。</p>
<h4 id="7-其他"><a href="#7-其他" class="headerlink" title="7. 其他"></a>7. 其他</h4><p>另外，创建服务的时候和compose类似，也是有很多参数可以指定的<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker service create --help</div><div class="line"></div><div class="line">Usage:	docker service create [OPTIONS] IMAGE [COMMAND] [ARG...]</div><div class="line"></div><div class="line">Create a new service</div><div class="line"></div><div class="line">Options:</div><div class="line">      --constraint value               Placement constraints (default [])</div><div class="line">      --container-label value          Container labels (default [])</div><div class="line">      --endpoint-mode string           Endpoint mode (vip or dnsrr)</div><div class="line">  -e, --env value                      Set environment variables (default [])</div><div class="line">      --help                           Print usage</div><div class="line">  -l, --label value                    Service labels (default [])</div><div class="line">      --limit-cpu value                Limit CPUs (default 0.000)</div><div class="line">      --limit-memory value             Limit Memory (default 0 B)</div><div class="line">      --log-driver string              Logging driver for service</div><div class="line">      --log-opt value                  Logging driver options (default [])</div><div class="line">      --mode string                    Service mode (replicated or global) (default &quot;replicated&quot;)</div><div class="line">      --mount value                    Attach a mount to the service</div><div class="line">      --name string                    Service name</div><div class="line">      --network value                  Network attachments (default [])</div><div class="line">  -p, --publish value                  Publish a port as a node port (default [])</div><div class="line">      --replicas value                 Number of tasks (default none)</div><div class="line">      --reserve-cpu value              Reserve CPUs (default 0.000)</div><div class="line">      --reserve-memory value           Reserve Memory (default 0 B)</div><div class="line">      --restart-condition string       Restart when condition is met (none, on-failure, or any)</div><div class="line">      --restart-delay value            Delay between restart attempts (default none)</div><div class="line">      --restart-max-attempts value     Maximum number of restarts before giving up (default none)</div><div class="line">      --restart-window value           Window used to evaluate the restart policy (default none)</div><div class="line">      --stop-grace-period value        Time to wait before force killing a container (default none)</div><div class="line">      --update-delay duration          Delay between updates</div><div class="line">      --update-failure-action string   Action on update failure (pause|continue) (default &quot;pause&quot;)</div><div class="line">      --update-parallelism uint        Maximum number of tasks updated simultaneously (0 to update all at once) (default 1)</div><div class="line">  -u, --user string                    Username or UID</div><div class="line">      --with-registry-auth             Send registry authentication details to swarm agents</div><div class="line">  -w, --workdir string                 Working directory inside the container</div></pre></td></tr></table></figure></p>
<p>需要注意的是：慎重使用mount。原因有以下三点：</p>
<ul>
<li>如果mount到host path上，那么需要每个node都有同样的path和文件。</li>
<li>需要确保所有node上的这个文件一直是可用的状态</li>
<li>这种方式完全就是反设计的。因为不能保证生产和测试的mount文件是一致的，从而导致运行出问题。</li>
</ul>
<p>参考：<a href="https://docs.docker.com/engine/swarm/services/" target="_blank" rel="external">https://docs.docker.com/engine/swarm/services/</a></p>
<p>可以通过demote和promote改变node的角色。</p>
<p><strong>重大发现</strong>： docker是有python的API的，可以用API管理集群： <a href="https://docker-py.readthedocs.io/en/stable/services.html。" target="_blank" rel="external">https://docker-py.readthedocs.io/en/stable/services.html。</a></p>
<h4 id="坑"><a href="#坑" class="headerlink" title="坑"></a>坑</h4><p>1.12版本的swarm模式里并不能获取已经失败了的service的container的日志：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">[root@controller wil]# docker service ps yarn</div><div class="line">ID                         NAME        IMAGE             NODE        DESIRED STATE  CURRENT STATE              ERROR</div><div class="line">c317x0ovq833c6g83hi4iwzz4  yarn.1      willcup/yarn:0.1  controller  Running        Running 2 seconds ago      </div><div class="line">2w5k9c4efh8h188ompgnfvh57   \_ yarn.1  willcup/yarn:0.1  dnode1      Shutdown       Failed about a minute ago  &quot;task: non-zero exit (127)&quot;</div><div class="line">4jvdu7nz8kxvnd9wa9qzmy1pw   \_ yarn.1  willcup/yarn:0.1  controller  Shutdown       Failed about a minute ago  &quot;task: non-zero exit (127)&quot;</div><div class="line">5yu69ugxmndhfdetvd9kthel2   \_ yarn.1  willcup/yarn:0.1  dnode1      Shutdown       Failed 3 minutes ago       &quot;task: non-zero exit (127)&quot;</div><div class="line">7qyx81ptxouv6883h1o1pbiti   \_ yarn.1  willcup/yarn:0.1  controller  Shutdown       Failed 5 minutes ago       &quot;task: non-zero exit (127)&quot;</div></pre></td></tr></table></figure>
<p>上面失败的就都找不到了。而且rm service以后，那些container都会被自动清理掉。</p>
<p>对于某些功能支持的不完善.</p>
<p>参考：</p>
<ul>
<li><a href="http://www.jianshu.com/p/3efee6927833" target="_blank" rel="external">http://www.jianshu.com/p/3efee6927833</a></li>
<li><a href="https://github.com/docker/docker/issues/24812" target="_blank" rel="external">https://github.com/docker/docker/issues/24812</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/01/09/SparkR安装历程/" title="SparkR安装历程" itemprop="url">SparkR安装历程</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2017-01-09T02:35:52.000Z" itemprop="datePublished"> 发表于 2017-01-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ol>
<li><p>在centos上安装一下R的基础包。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">yum install -y R</div><div class="line"></div><div class="line">R CMD javareconf</div></pre></td></tr></table></figure>
</li>
<li><p>安装Rstudio server</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget https://download2.rstudio.org/rstudio-server-rhel-1.0.136-x86_64.rpm</div><div class="line">yum install --nogpgcheck rstudio-server-rhel-1.0.136-x86_64.rpm</div><div class="line">rstudio-server verify-installation</div></pre></td></tr></table></figure>
</li>
<li><p>为Rstudio server添加用户，默认是使用linux用户的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">useradd rtest</div><div class="line">passwd rtest</div></pre></td></tr></table></figure>
</li>
<li><p>R安装依赖<br>为R安装sparkR的库</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">R CMD INSTALL /usr/hdp/current/spark-client/R/lib/SparkR/</div></pre></td></tr></table></figure>
</li>
</ol>
<p>安装forecast的时候报错, g++版本低，通过安装devtools-2解决：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo rpm --import http://ftp.scientificlinux.org/linux/scientific/5x/x86_64/RPM-GPG-KEYs/RPM-GPG-KEY-cern</div><div class="line">wget -O /etc/yum.repos.d/slc6-devtoolset.repo http://linuxsoft.cern.ch/cern/devtoolset/slc6-devtoolset.repo</div><div class="line">sudo yum install devtoolset-2</div><div class="line">scl enable devtoolset-2 bash</div></pre></td></tr></table></figure></p>
<p>这样版本就已经好了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">$ gcc --version</div><div class="line">gcc (GCC) 4.8.2 20140120 (Red Hat 4.8.2-15)</div><div class="line">...</div><div class="line"></div><div class="line">$ g++ --version</div><div class="line">g++ (GCC) 4.8.2 20140120 (Red Hat 4.8.2-15)</div><div class="line">...</div><div class="line"></div><div class="line">$ gfortran --version</div><div class="line">GNU Fortran (GCC) 4.8.2 20140120 (Red Hat 4.8.2-15)</div><div class="line">...</div></pre></td></tr></table></figure></p>
<p>参考： <a href="https://gist.github.com/stephenturner/e3bc5cfacc2dc67eca8b" target="_blank" rel="external">https://gist.github.com/stephenturner/e3bc5cfacc2dc67eca8b</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div></pre></td><td class="code"><pre><div class="line">&gt; sc&lt;-sparkR.init(master = &quot;yarn-client&quot;)</div><div class="line">Launching java with spark-submit command spark-submit   sparkr-shell /tmp/RtmpERrwOX/backend_port628c57c68104 </div><div class="line">17/01/10 15:28:50 INFO SparkContext: Running Spark version 1.5.2</div><div class="line">17/01/10 15:28:53 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable</div><div class="line">17/01/10 15:28:54 INFO SecurityManager: Changing view acls to: zhangjiayi</div><div class="line">17/01/10 15:28:54 INFO SecurityManager: Changing modify acls to: zhangjiayi</div><div class="line">17/01/10 15:28:54 INFO SecurityManager: SecurityManager: authentication disabled; ui acls disabled; users with view permissions: Set(zhangjiayi); users with modify permissions: Set(zhangjiayi)</div><div class="line">17/01/10 15:29:00 INFO Slf4jLogger: Slf4jLogger started</div><div class="line">17/01/10 15:29:00 INFO Remoting: Starting remoting</div><div class="line">17/01/10 15:29:01 INFO Remoting: Remoting started; listening on addresses :[akka.tcp://sparkDriver@10.1.5.65:34109]</div><div class="line">17/01/10 15:29:01 INFO Utils: Successfully started service &apos;sparkDriver&apos; on port 34109.</div><div class="line">17/01/10 15:29:01 INFO SparkEnv: Registering MapOutputTracker</div><div class="line">17/01/10 15:29:01 INFO SparkEnv: Registering BlockManagerMaster</div><div class="line">17/01/10 15:29:02 INFO DiskBlockManager: Created local directory at /tmp/blockmgr-ce31222a-c674-4391-be3c-43b075e758d4</div><div class="line">17/01/10 15:29:02 INFO MemoryStore: MemoryStore started with capacity 530.0 MB</div><div class="line">17/01/10 15:29:02 INFO HttpFileServer: HTTP File server directory is /tmp/spark-c2196ae2-3c1b-46e0-97dd-583cd7a240a3/httpd-af4e2720-d455-4d5a-93de-6a0e7231da34</div><div class="line">17/01/10 15:29:02 INFO HttpServer: Starting HTTP Server</div><div class="line">17/01/10 15:29:03 INFO Server: jetty-8.y.z-SNAPSHOT</div><div class="line">17/01/10 15:29:03 INFO AbstractConnector: Started SocketConnector@0.0.0.0:44708</div><div class="line">17/01/10 15:29:03 INFO Utils: Successfully started service &apos;HTTP file server&apos; on port 44708.</div><div class="line">17/01/10 15:29:03 INFO SparkEnv: Registering OutputCommitCoordinator</div><div class="line">17/01/10 15:29:03 INFO Server: jetty-8.y.z-SNAPSHOT</div><div class="line">17/01/10 15:29:03 INFO AbstractConnector: Started SelectChannelConnector@0.0.0.0:4040</div><div class="line">17/01/10 15:29:03 INFO Utils: Successfully started service &apos;SparkUI&apos; on port 4040.</div><div class="line">17/01/10 15:29:03 INFO SparkUI: Started SparkUI at http://10.1.5.65:4040</div><div class="line">17/01/10 15:29:04 WARN MetricsSystem: Using default name DAGScheduler for source because spark.app.id is not set.</div><div class="line">spark.yarn.driver.memoryOverhead is set but does not apply in client mode.</div><div class="line">17/01/10 15:29:05 INFO TimelineClientImpl: Timeline service address: http://slavenode4:8188/ws/v1/timeline/</div><div class="line">17/01/10 15:29:06 INFO RMProxy: Connecting to ResourceManager at slavenode3/10.1.5.64:8050</div><div class="line">17/01/10 15:29:11 WARN DomainSocketFactory: The short-circuit local reads feature cannot be used because libhadoop cannot be loaded.</div><div class="line">17/01/10 15:29:12 INFO Client: Requesting a new application from cluster with 5 NodeManagers</div><div class="line">17/01/10 15:29:12 INFO Client: Verifying our application has not requested more than the maximum memory capability of the cluster (5120 MB per container)</div><div class="line">17/01/10 15:29:12 INFO Client: Will allocate AM container, with 896 MB memory including 384 MB overhead</div><div class="line">17/01/10 15:29:12 INFO Client: Setting up container launch context for our AM</div><div class="line">17/01/10 15:29:12 INFO Client: Setting up the launch environment for our AM container</div><div class="line">17/01/10 15:29:12 INFO Client: Preparing resources for our AM container</div><div class="line">17/01/10 15:29:12 INFO Client: Uploading resource file:/usr/hdp/2.3.4.0-3485/spark/lib/spark-assembly-1.5.2.2.3.4.0-3485-hadoop2.7.1.2.3.4.0-3485.jar -&gt; hdfs://masternode:8020/user/zhangjiayi/.sparkStaging/application_1483512430911_0002/spark-assembly-1.5.2.2.3.4.0-3485-hadoop2.7.1.2.3.4.0-3485.jar</div><div class="line">17/01/10 15:29:22 INFO Client: Uploading resource file:/tmp/spark-c2196ae2-3c1b-46e0-97dd-583cd7a240a3/__spark_conf__1393429344923620787.zip -&gt; hdfs://masternode:8020/user/zhangjiayi/.sparkStaging/application_1483512430911_0002/__spark_conf__1393429344923620787.zip</div><div class="line">17/01/10 15:29:22 INFO SecurityManager: Changing view acls to: zhangjiayi</div><div class="line">17/01/10 15:29:22 INFO SecurityManager: Changing modify acls to: zhangjiayi</div><div class="line">17/01/10 15:29:22 INFO SecurityManager: SecurityManager: authentication disabled; ui acls disabled; users with view permissions: Set(zhangjiayi); users with modify permissions: Set(zhangjiayi)</div><div class="line">17/01/10 15:29:22 INFO Client: Submitting application 2 to ResourceManager</div><div class="line">17/01/10 15:29:22 INFO YarnClientImpl: Submitted application application_1483512430911_0002</div><div class="line">17/01/10 15:29:22 INFO YarnExtensionServices: Starting Yarn extension services with app application_1483512430911_0002 and attemptId None</div><div class="line">17/01/10 15:29:22 INFO YarnHistoryService: Starting YarnHistoryService for application application_1483512430911_0002 attempt None; state=1; endpoint=http://slavenode4:8188/ws/v1/timeline/; bonded to ATS=false; listening=false; batchSize=10; flush count=0; total number queued=0, processed=0; attempted entity posts=0 successful entity posts=0 failed entity posts=0; events dropped=0; app start event received=false; app end event received=false;</div><div class="line">17/01/10 15:29:22 INFO YarnHistoryService: Spark events will be published to the Timeline service at http://slavenode4:8188/ws/v1/timeline/</div><div class="line">17/01/10 15:29:22 INFO TimelineClientImpl: Timeline service address: http://slavenode4:8188/ws/v1/timeline/</div><div class="line">17/01/10 15:29:22 INFO YarnHistoryService: History Service listening for events: YarnHistoryService for application application_1483512430911_0002 attempt None; state=1; endpoint=http://slavenode4:8188/ws/v1/timeline/; bonded to ATS=true; listening=true; batchSize=10; flush count=0; total number queued=0, processed=0; attempted entity posts=0 successful entity posts=0 failed entity posts=0; events dropped=0; app start event received=false; app end event received=false;</div><div class="line">17/01/10 15:29:22 INFO YarnExtensionServices: Service org.apache.spark.deploy.yarn.history.YarnHistoryService started</div><div class="line">17/01/10 15:29:23 INFO Client: Application report for application_1483512430911_0002 (state: ACCEPTED)</div><div class="line">17/01/10 15:29:23 INFO Client: </div><div class="line">	 client token: N/A</div><div class="line">	 diagnostics: N/A</div><div class="line">	 ApplicationMaster host: N/A</div><div class="line">	 ApplicationMaster RPC port: -1</div><div class="line">	 queue: default</div><div class="line">	 start time: 1484033362415</div><div class="line">	 final status: UNDEFINED</div><div class="line">	 tracking URL: http://slavenode3:8088/proxy/application_1483512430911_0002/</div><div class="line">	 user: zhangjiayi</div><div class="line">17/01/10 15:29:24 INFO Client: Application report for application_1483512430911_0002 (state: ACCEPTED)</div><div class="line">17/01/10 15:29:25 INFO Client: Application report for application_1483512430911_0002 (state: ACCEPTED)</div><div class="line">17/01/10 15:29:26 INFO Client: Application report for application_1483512430911_0002 (state: ACCEPTED)</div><div class="line">17/01/10 15:29:27 INFO YarnSchedulerBackend$YarnSchedulerEndpoint: ApplicationMaster registered as AkkaRpcEndpointRef(Actor[akka.tcp://sparkYarnAM@10.1.5.66:34209/user/YarnAM#-468278157])</div><div class="line">17/01/10 15:29:27 INFO YarnClientSchedulerBackend: Add WebUI Filter. org.apache.hadoop.yarn.server.webproxy.amfilter.AmIpFilter, Map(PROXY_HOSTS -&gt; slavenode3, PROXY_URI_BASES -&gt; http://slavenode3:8088/proxy/application_1483512430911_0002), /proxy/application_1483512430911_0002</div><div class="line">17/01/10 15:29:27 INFO JettyUtils: Adding filter: org.apache.hadoop.yarn.server.webproxy.amfilter.AmIpFilter</div><div class="line">17/01/10 15:29:27 INFO Client: Application report for application_1483512430911_0002 (state: RUNNING)</div><div class="line">17/01/10 15:29:27 INFO Client: </div><div class="line">	 client token: N/A</div><div class="line">	 diagnostics: N/A</div><div class="line">	 ApplicationMaster host: 10.1.5.66</div><div class="line">	 ApplicationMaster RPC port: 0</div><div class="line">	 queue: default</div><div class="line">	 start time: 1484033362415</div><div class="line">	 final status: UNDEFINED</div><div class="line">	 tracking URL: http://slavenode3:8088/proxy/application_1483512430911_0002/</div><div class="line">	 user: zhangjiayi</div><div class="line">17/01/10 15:29:27 INFO YarnClientSchedulerBackend: Application application_1483512430911_0002 has started running.</div><div class="line">17/01/10 15:29:27 INFO Utils: Successfully started service &apos;org.apache.spark.network.netty.NettyBlockTransferService&apos; on port 44133.</div><div class="line">17/01/10 15:29:27 INFO NettyBlockTransferService: Server created on 44133</div><div class="line">17/01/10 15:29:27 INFO BlockManagerMaster: Trying to register BlockManager</div><div class="line">17/01/10 15:29:27 INFO BlockManagerMasterEndpoint: Registering block manager 10.1.5.65:44133 with 530.0 MB RAM, BlockManagerId(driver, 10.1.5.65, 44133)</div><div class="line">17/01/10 15:29:27 INFO BlockManagerMaster: Registered BlockManager</div><div class="line">17/01/10 15:29:28 INFO YarnHistoryService: Application started: SparkListenerApplicationStart(SparkR,Some(application_1483512430911_0002),1484033330463,zhangjiayi,None,None)</div><div class="line">17/01/10 15:29:28 INFO YarnHistoryService: About to POST entity application_1483512430911_0002 with 3 events to timeline service http://slavenode4:8188/ws/v1/timeline/</div><div class="line">17/01/10 15:29:34 INFO YarnClientSchedulerBackend: SchedulerBackend is ready for scheduling beginning after waiting maxRegisteredResourcesWaitingTime: 30000(ms)</div><div class="line">&gt; </div><div class="line">17/01/10 15:29:35 INFO YarnClientSchedulerBackend: Registered executor: AkkaRpcEndpointRef(Actor[akka.tcp://sparkExecutor@slavenode3:41731/user/Executor#207450695]) with ID 1</div><div class="line">17/01/10 15:29:35 INFO BlockManagerMasterEndpoint: Registering block manager slavenode3:45665 with 530.0 MB RAM, BlockManagerId(1, slavenode3, 45665)</div><div class="line">17/01/10 15:29:39 INFO YarnClientSchedulerBackend: Registered executor: AkkaRpcEndpointRef(Actor[akka.tcp://sparkExecutor@slavenode2:42294/user/Executor#1616446929]) with ID 2</div><div class="line">17/01/10 15:29:39 INFO BlockManagerMasterEndpoint: Registering block manager slavenode2:42279 with 530.0 MB RAM, BlockManagerId(2, slavenode2, 42279)</div><div class="line">&gt; sqlcontext&lt;-sparkRSQL.init(sc)</div><div class="line">&gt; df&lt;-createDataFrame(sqlContext = sqlcontext,data = iris)</div><div class="line">17/01/10 15:29:54 INFO SparkContext: Starting job: collectPartitions at NativeMethodAccessorImpl.java:-2</div><div class="line">17/01/10 15:29:54 INFO DAGScheduler: Got job 0 (collectPartitions at NativeMethodAccessorImpl.java:-2) with 1 output partitions</div><div class="line">17/01/10 15:29:54 INFO DAGScheduler: Final stage: ResultStage 0(collectPartitions at NativeMethodAccessorImpl.java:-2)</div><div class="line">17/01/10 15:29:54 INFO DAGScheduler: Parents of final stage: List()</div><div class="line">17/01/10 15:29:54 INFO DAGScheduler: Missing parents: List()</div><div class="line">17/01/10 15:29:54 INFO DAGScheduler: Submitting ResultStage 0 (ParallelCollectionRDD[0] at parallelize at RRDD.scala:454), which has no missing parents</div><div class="line">17/01/10 15:30:03 INFO MemoryStore: ensureFreeSpace(1280) called with curMem=0, maxMem=555755765</div><div class="line">17/01/10 15:30:03 INFO MemoryStore: Block broadcast_0 stored as values in memory (estimated size 1280.0 B, free 530.0 MB)</div><div class="line">17/01/10 15:30:03 INFO MemoryStore: ensureFreeSpace(854) called with curMem=1280, maxMem=555755765</div><div class="line">17/01/10 15:30:03 INFO MemoryStore: Block broadcast_0_piece0 stored as bytes in memory (estimated size 854.0 B, free 530.0 MB)</div><div class="line">17/01/10 15:30:03 INFO BlockManagerInfo: Added broadcast_0_piece0 in memory on 10.1.5.65:44133 (size: 854.0 B, free: 530.0 MB)</div><div class="line">17/01/10 15:30:03 INFO SparkContext: Created broadcast 0 from broadcast at DAGScheduler.scala:861</div><div class="line">17/01/10 15:30:03 INFO DAGScheduler: Submitting 1 missing tasks from ResultStage 0 (ParallelCollectionRDD[0] at parallelize at RRDD.scala:454)</div><div class="line">17/01/10 15:30:03 INFO YarnScheduler: Adding task set 0.0 with 1 tasks</div><div class="line">17/01/10 15:30:03 INFO TaskSetManager: Starting task 0.0 in stage 0.0 (TID 0, slavenode2, PROCESS_LOCAL, 16553 bytes)</div><div class="line">17/01/10 15:30:05 INFO BlockManagerInfo: Added broadcast_0_piece0 in memory on slavenode2:42279 (size: 854.0 B, free: 530.0 MB)</div><div class="line">17/01/10 15:30:05 INFO TaskSetManager: Finished task 0.0 in stage 0.0 (TID 0) in 1661 ms on slavenode2 (1/1)</div><div class="line">17/01/10 15:30:05 INFO DAGScheduler: ResultStage 0 (collectPartitions at NativeMethodAccessorImpl.java:-2) finished in 1.786 s</div><div class="line">17/01/10 15:30:05 INFO DAGScheduler: Job 0 finished: collectPartitions at NativeMethodAccessorImpl.java:-2, took 11.381818 s</div><div class="line">17/01/10 15:30:05 INFO YarnScheduler: Removed TaskSet 0.0, whose tasks have all completed, from pool </div><div class="line">17/01/10 15:30:06 INFO YarnHistoryService: About to POST entity application_1483512430911_0002 with 10 events to timeline service http://slavenode4:8188/ws/v1/timeline/</div><div class="line">Warning messages:</div><div class="line">1: In FUN(X[[i]], ...) :</div><div class="line">  Use Sepal_Length instead of Sepal.Length  as column name</div><div class="line">2: In FUN(X[[i]], ...) :</div><div class="line">  Use Sepal_Width instead of Sepal.Width  as column name</div><div class="line">3: In FUN(X[[i]], ...) :</div><div class="line">  Use Petal_Length instead of Petal.Length  as column name</div><div class="line">4: In FUN(X[[i]], ...) :</div><div class="line">  Use Petal_Width instead of Petal.Width  as column name</div><div class="line">&gt; </div><div class="line">&gt; typeof(df)</div><div class="line">[1] &quot;S4&quot;</div><div class="line">&gt; a&lt;-&apos;sdfsd&apos;</div><div class="line">&gt; typeof(a)</div><div class="line">[1] &quot;character&quot;</div><div class="line">&gt; head(df)</div><div class="line">17/01/10 15:31:24 INFO SparkContext: Starting job: dfToCols at NativeMethodAccessorImpl.java:-2</div><div class="line">17/01/10 15:31:24 INFO DAGScheduler: Got job 1 (dfToCols at NativeMethodAccessorImpl.java:-2) with 1 output partitions</div><div class="line">17/01/10 15:31:24 INFO DAGScheduler: Final stage: ResultStage 1(dfToCols at NativeMethodAccessorImpl.java:-2)</div><div class="line">17/01/10 15:31:24 INFO DAGScheduler: Parents of final stage: List()</div><div class="line">17/01/10 15:31:24 INFO DAGScheduler: Missing parents: List()</div><div class="line">17/01/10 15:31:24 INFO DAGScheduler: Submitting ResultStage 1 (MapPartitionsRDD[4] at dfToCols at NativeMethodAccessorImpl.java:-2), which has no missing parents</div><div class="line">17/01/10 15:31:24 INFO MemoryStore: ensureFreeSpace(9176) called with curMem=2134, maxMem=555755765</div><div class="line">17/01/10 15:31:24 INFO MemoryStore: Block broadcast_1 stored as values in memory (estimated size 9.0 KB, free 530.0 MB)</div><div class="line">17/01/10 15:31:24 INFO MemoryStore: ensureFreeSpace(3690) called with curMem=11310, maxMem=555755765</div><div class="line">17/01/10 15:31:24 INFO MemoryStore: Block broadcast_1_piece0 stored as bytes in memory (estimated size 3.6 KB, free 530.0 MB)</div><div class="line">17/01/10 15:31:24 INFO BlockManagerInfo: Added broadcast_1_piece0 in memory on 10.1.5.65:44133 (size: 3.6 KB, free: 530.0 MB)</div><div class="line">17/01/10 15:31:24 INFO SparkContext: Created broadcast 1 from broadcast at DAGScheduler.scala:861</div><div class="line">17/01/10 15:31:24 INFO DAGScheduler: Submitting 1 missing tasks from ResultStage 1 (MapPartitionsRDD[4] at dfToCols at NativeMethodAccessorImpl.java:-2)</div><div class="line">17/01/10 15:31:24 INFO YarnScheduler: Adding task set 1.0 with 1 tasks</div><div class="line">17/01/10 15:31:24 INFO TaskSetManager: Starting task 0.0 in stage 1.0 (TID 1, slavenode3, PROCESS_LOCAL, 16553 bytes)</div><div class="line">17/01/10 15:31:24 INFO BlockManagerInfo: Added broadcast_1_piece0 in memory on slavenode3:45665 (size: 3.6 KB, free: 530.0 MB)</div><div class="line">17/01/10 15:31:35 WARN TaskSetManager: Lost task 0.0 in stage 1.0 (TID 1, slavenode3): java.net.SocketTimeoutException: Accept timed out</div><div class="line">	at java.net.PlainSocketImpl.socketAccept(Native Method)</div><div class="line">	at java.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:409)</div><div class="line">	at java.net.ServerSocket.implAccept(ServerSocket.java:545)</div><div class="line">	at java.net.ServerSocket.accept(ServerSocket.java:513)</div><div class="line">	at org.apache.spark.api.r.RRDD$.createRWorker(RRDD.scala:426)</div><div class="line">	at org.apache.spark.api.r.BaseRRDD.compute(RRDD.scala:62)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:66)</div><div class="line">	at org.apache.spark.scheduler.Task.run(Task.scala:88)</div><div class="line">	at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:214)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div><div class="line"></div><div class="line">17/01/10 15:31:35 INFO TaskSetManager: Starting task 0.1 in stage 1.0 (TID 2, slavenode2, PROCESS_LOCAL, 16553 bytes)</div><div class="line">17/01/10 15:31:35 INFO BlockManagerInfo: Added broadcast_1_piece0 in memory on slavenode2:42279 (size: 3.6 KB, free: 530.0 MB)</div><div class="line">17/01/10 15:31:37 WARN TaskSetManager: Lost task 0.1 in stage 1.0 (TID 2, slavenode2): java.io.IOException: Cannot run program &quot;Rscript&quot;: error=13, Permission denied</div><div class="line">	at java.lang.ProcessBuilder.start(ProcessBuilder.java:1048)</div><div class="line">	at org.apache.spark.api.r.RRDD$.createRProcess(RRDD.scala:407)</div><div class="line">	at org.apache.spark.api.r.RRDD$.createRWorker(RRDD.scala:423)</div><div class="line">	at org.apache.spark.api.r.BaseRRDD.compute(RRDD.scala:62)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:66)</div><div class="line">	at org.apache.spark.scheduler.Task.run(Task.scala:88)</div><div class="line">	at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:214)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div><div class="line">Caused by: java.io.IOException: error=13, Permission denied</div><div class="line">	at java.lang.UNIXProcess.forkAndExec(Native Method)</div><div class="line">	at java.lang.UNIXProcess.&lt;init&gt;(UNIXProcess.java:248)</div><div class="line">	at java.lang.ProcessImpl.start(ProcessImpl.java:134)</div><div class="line">	at java.lang.ProcessBuilder.start(ProcessBuilder.java:1029)</div><div class="line">	... 20 more</div><div class="line"></div><div class="line">17/01/10 15:31:37 INFO TaskSetManager: Starting task 0.2 in stage 1.0 (TID 3, slavenode3, PROCESS_LOCAL, 16553 bytes)</div><div class="line">17/01/10 15:31:47 WARN TaskSetManager: Lost task 0.2 in stage 1.0 (TID 3, slavenode3): java.net.SocketTimeoutException: Accept timed out</div><div class="line">	at java.net.PlainSocketImpl.socketAccept(Native Method)</div><div class="line">	at java.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:409)</div><div class="line">	at java.net.ServerSocket.implAccept(ServerSocket.java:545)</div><div class="line">	at java.net.ServerSocket.accept(ServerSocket.java:513)</div><div class="line">	at org.apache.spark.api.r.RRDD$.createRWorker(RRDD.scala:426)</div><div class="line">	at org.apache.spark.api.r.BaseRRDD.compute(RRDD.scala:62)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:66)</div><div class="line">	at org.apache.spark.scheduler.Task.run(Task.scala:88)</div><div class="line">	at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:214)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div><div class="line"></div><div class="line">17/01/10 15:31:47 INFO TaskSetManager: Starting task 0.3 in stage 1.0 (TID 4, slavenode2, PROCESS_LOCAL, 16553 bytes)</div><div class="line">17/01/10 15:31:47 WARN TaskSetManager: Lost task 0.3 in stage 1.0 (TID 4, slavenode2): java.io.IOException: Cannot run program &quot;Rscript&quot;: error=13, Permission denied</div><div class="line">	at java.lang.ProcessBuilder.start(ProcessBuilder.java:1048)</div><div class="line">	at org.apache.spark.api.r.RRDD$.createRProcess(RRDD.scala:407)</div><div class="line">	at org.apache.spark.api.r.RRDD$.createRWorker(RRDD.scala:423)</div><div class="line">	at org.apache.spark.api.r.BaseRRDD.compute(RRDD.scala:62)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:66)</div><div class="line">	at org.apache.spark.scheduler.Task.run(Task.scala:88)</div><div class="line">	at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:214)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div><div class="line">Caused by: java.io.IOException: error=13, Permission denied</div><div class="line">	at java.lang.UNIXProcess.forkAndExec(Native Method)</div><div class="line">	at java.lang.UNIXProcess.&lt;init&gt;(UNIXProcess.java:248)</div><div class="line">	at java.lang.ProcessImpl.start(ProcessImpl.java:134)</div><div class="line">	at java.lang.ProcessBuilder.start(ProcessBuilder.java:1029)</div><div class="line">	... 20 more</div><div class="line"></div><div class="line">17/01/10 15:31:47 ERROR TaskSetManager: Task 0 in stage 1.0 failed 4 times; aborting job</div><div class="line">17/01/10 15:31:47 INFO YarnScheduler: Removed TaskSet 1.0, whose tasks have all completed, from pool </div><div class="line">17/01/10 15:31:47 INFO YarnScheduler: Cancelling stage 1</div><div class="line">17/01/10 15:31:47 INFO DAGScheduler: ResultStage 1 (dfToCols at NativeMethodAccessorImpl.java:-2) failed in 23.005 s</div><div class="line">17/01/10 15:31:47 INFO DAGScheduler: Job 1 failed: dfToCols at NativeMethodAccessorImpl.java:-2, took 23.056582 s</div><div class="line">17/01/10 15:31:47 ERROR RBackendHandler: dfToCols on org.apache.spark.sql.api.r.SQLUtils failed</div><div class="line">17/01/10 15:31:47 INFO YarnHistoryService: About to POST entity application_1483512430911_0002 with 10 events to timeline service http://slavenode4:8188/ws/v1/timeline/</div><div class="line">Error in invokeJava(isStatic = TRUE, className, methodName, ...) : </div><div class="line">  org.apache.spark.SparkException: Job aborted due to stage failure: Task 0 in stage 1.0 failed 4 times, most recent failure: Lost task 0.3 in stage 1.0 (TID 4, slavenode2): java.io.IOException: Cannot run program &quot;Rscript&quot;: error=13, Permission denied</div><div class="line">	at java.lang.ProcessBuilder.start(ProcessBuilder.java:1048)</div><div class="line">	at org.apache.spark.api.r.RRDD$.createRProcess(RRDD.scala:407)</div><div class="line">	at org.apache.spark.api.r.RRDD$.createRWorker(RRDD.scala:423)</div><div class="line">	at org.apache.spark.api.r.BaseRRDD.compute(RRDD.scala:62)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD</div><div class="line">17/01/10 16:30:49 INFO ContextCleaner: Cleaned accumulator 1</div><div class="line">17/01/10 16:30:49 INFO BlockManagerInfo: Removed broadcast_1_piece0 on slavenode3:45665 in memory (size: 3.6 KB, free: 530.0 MB)</div><div class="line">17/01/10 16:30:49 INFO BlockManagerInfo: Removed broadcast_1_piece0 on slavenode2:42279 in memory (size: 3.6 KB, free: 530.0 MB)</div><div class="line">17/01/10 16:30:49 INFO BlockManagerInfo: Removed broadcast_1_piece0 on 10.1.5.65:44133 in memory (size: 3.6 KB, free: 530.0 MB)</div><div class="line">17/01/10 16:30:49 INFO ContextCleaner: Cleaned accumulator 2</div><div class="line">17/01/10 16:30:49 INFO BlockManagerInfo: Removed broadcast_0_piece0 on 10.1.5.65:44133 in memory (size: 854.0 B, free: 530.0 MB)</div><div class="line">17/01/10 16:30:49 INFO BlockManagerInfo: Removed broadcast_0_piece0 on slavenode2:42279 in memory (size: 854.0 B, free: 530.0 MB)</div></pre></td></tr></table></figure>
<p>搜了一下没有理想答案，所以只能看源码了,下面是报错的代码位置：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">createRProcess</span></span>(port: <span class="type">Int</span>, script: <span class="type">String</span>): <span class="type">BufferedStreamThread</span> = &#123;</div><div class="line">    <span class="comment">// "spark.sparkr.r.command" is deprecated and replaced by "spark.r.command",</span></div><div class="line">    <span class="comment">// but kept here for backward compatibility.</span></div><div class="line">    <span class="keyword">val</span> sparkConf = <span class="type">SparkEnv</span>.get.conf</div><div class="line">    <span class="keyword">var</span> rCommand = sparkConf.get(<span class="string">"spark.sparkr.r.command"</span>, <span class="string">"Rscript"</span>)</div><div class="line">    rCommand = sparkConf.get(<span class="string">"spark.r.command"</span>, rCommand)</div><div class="line"></div><div class="line">    <span class="keyword">val</span> rOptions = <span class="string">"--vanilla"</span></div><div class="line">    <span class="keyword">val</span> rLibDir = <span class="type">RUtils</span>.sparkRPackagePath(isDriver = <span class="literal">false</span>)</div><div class="line">    <span class="keyword">val</span> rExecScript = rLibDir(<span class="number">0</span>) + <span class="string">"/SparkR/worker/"</span> + script</div><div class="line">    print(rCommand)</div><div class="line">    print(rOptions)</div><div class="line">    print(rExecScript)</div><div class="line">    <span class="keyword">val</span> pb = <span class="keyword">new</span> <span class="type">ProcessBuilder</span>(<span class="type">Arrays</span>.asList(rCommand, rOptions, rExecScript))</div><div class="line">    <span class="comment">// Unset the R_TESTS environment variable for workers.</span></div><div class="line">    <span class="comment">// This is set by R CMD check as startup.Rs</span></div><div class="line">    <span class="comment">// (http://svn.r-project.org/R/trunk/src/library/tools/R/testing.R)</span></div><div class="line">    <span class="comment">// and confuses worker script which tries to load a non-existent file</span></div><div class="line">    pb.environment().put(<span class="string">"R_TESTS"</span>, <span class="string">""</span>)</div><div class="line">    pb.environment().put(<span class="string">"SPARKR_RLIBDIR"</span>, rLibDir.mkString(<span class="string">","</span>))</div><div class="line">    pb.environment().put(<span class="string">"SPARKR_WORKER_PORT"</span>, port.toString)</div><div class="line">    pb.redirectErrorStream(<span class="literal">true</span>)  <span class="comment">// redirect stderr into stdout</span></div><div class="line">    <span class="keyword">val</span> proc = pb.start()</div><div class="line">    <span class="keyword">val</span> errThread = startStdoutThread(proc)</div><div class="line">    errThread</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>上面的print语句是我加上去的。</p>
<p>忘了一个前置条件，使用sparkR的时候不指定master，也就是local模式的话是可以成功的。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div></pre></td><td class="code"><pre><div class="line">&gt;sc&lt;-sparkR.init()</div><div class="line">Launching java with spark-submit command spark-submit   sparkr-shell /tmp/RtmpRKsp2x/backend_port306c2e180534 </div><div class="line">17/01/10 18:20:53 INFO SparkContext: Running Spark version 1.5.2</div><div class="line">17/01/10 18:20:54 WARN NativeCodeLoader: Unable to load native-hadoop library for your platform... using builtin-java classes where applicable</div><div class="line">17/01/10 18:20:54 INFO SecurityManager: Changing view acls to: zhangjiayi</div><div class="line">17/01/10 18:20:54 INFO SecurityManager: Changing modify acls to: zhangjiayi</div><div class="line">17/01/10 18:20:54 INFO SecurityManager: SecurityManager: authentication disabled; ui acls disabled; users with view permissions: Set(zhangjiayi); users with modify permissions: Set(zhangjiayi)</div><div class="line">17/01/10 18:20:59 INFO Slf4jLogger: Slf4jLogger started</div><div class="line">17/01/10 18:20:59 INFO Remoting: Starting remoting</div><div class="line">17/01/10 18:21:01 INFO Remoting: Remoting started; listening on addresses :[akka.tcp://sparkDriver@10.1.5.65:45017]</div><div class="line">17/01/10 18:21:01 INFO Utils: Successfully started service &apos;sparkDriver&apos; on port 45017.</div><div class="line">17/01/10 18:21:01 INFO SparkEnv: Registering MapOutputTracker</div><div class="line">17/01/10 18:21:02 INFO SparkEnv: Registering BlockManagerMaster</div><div class="line">17/01/10 18:21:02 INFO DiskBlockManager: Created local directory at /tmp/blockmgr-a7f2bf0d-c363-4220-ade9-5210fe54f9f7</div><div class="line">17/01/10 18:21:03 INFO MemoryStore: MemoryStore started with capacity 530.0 MB</div><div class="line">17/01/10 18:21:03 INFO HttpFileServer: HTTP File server directory is /tmp/spark-d5f07559-6482-4523-aa40-8b99b7fbc84b/httpd-00d9c253-b8f8-41c2-ae1e-ad5bac726bf1</div><div class="line">17/01/10 18:21:03 INFO HttpServer: Starting HTTP Server</div><div class="line">17/01/10 18:21:04 INFO Server: jetty-8.y.z-SNAPSHOT</div><div class="line">17/01/10 18:21:04 INFO AbstractConnector: Started SocketConnector@0.0.0.0:35349</div><div class="line">17/01/10 18:21:04 INFO Utils: Successfully started service &apos;HTTP file server&apos; on port 35349.</div><div class="line">17/01/10 18:21:04 INFO SparkEnv: Registering OutputCommitCoordinator</div><div class="line">17/01/10 18:21:05 INFO Server: jetty-8.y.z-SNAPSHOT</div><div class="line">17/01/10 18:21:05 INFO AbstractConnector: Started SelectChannelConnector@0.0.0.0:4040</div><div class="line">17/01/10 18:21:05 INFO Utils: Successfully started service &apos;SparkUI&apos; on port 4040.</div><div class="line">17/01/10 18:21:05 INFO SparkUI: Started SparkUI at http://10.1.5.65:4040</div><div class="line">17/01/10 18:21:05 WARN MetricsSystem: Using default name DAGScheduler for source because spark.app.id is not set.</div><div class="line">17/01/10 18:21:05 INFO Executor: Starting executor ID driver on host localhost</div><div class="line">17/01/10 18:21:05 INFO Utils: Successfully started service &apos;org.apache.spark.network.netty.NettyBlockTransferService&apos; on port 38751.</div><div class="line">17/01/10 18:21:05 INFO NettyBlockTransferService: Server created on 38751</div><div class="line">17/01/10 18:21:05 INFO BlockManagerMaster: Trying to register BlockManager</div><div class="line">17/01/10 18:21:05 INFO BlockManagerMasterEndpoint: Registering block manager localhost:38751 with 530.0 MB RAM, BlockManagerId(driver, localhost, 38751)</div><div class="line">17/01/10 18:21:05 INFO BlockManagerMaster: Registered BlockManager</div><div class="line">&gt; </div><div class="line">&gt; sqlcontext&lt;-sparkRSQL.init(sc)sc</div><div class="line">Error: unexpected symbol in &quot;sqlcontext&lt;-sparkRSQL.init(sc)sc&quot;</div><div class="line">&gt; sqlcontext&lt;-sparkRSQL.init(sc)</div><div class="line">&gt; df&lt;-createDataFrame(sqlContext = sqlcontext,data = iris)</div><div class="line">17/01/10 18:23:34 INFO SparkContext: Starting job: collectPartitions at NativeMethodAccessorImpl.java:-2</div><div class="line">17/01/10 18:23:34 INFO DAGScheduler: Got job 0 (collectPartitions at NativeMethodAccessorImpl.java:-2) with 1 output partitions</div><div class="line">17/01/10 18:23:34 INFO DAGScheduler: Final stage: ResultStage 0(collectPartitions at NativeMethodAccessorImpl.java:-2)</div><div class="line">17/01/10 18:23:34 INFO DAGScheduler: Parents of final stage: List()</div><div class="line">17/01/10 18:23:34 INFO DAGScheduler: Missing parents: List()</div><div class="line">17/01/10 18:23:34 INFO DAGScheduler: Submitting ResultStage 0 (ParallelCollectionRDD[0] at parallelize at RRDD.scala:454), which has no missing parents</div><div class="line">17/01/10 18:23:35 INFO MemoryStore: ensureFreeSpace(1280) called with curMem=0, maxMem=555755765</div><div class="line">17/01/10 18:23:35 INFO MemoryStore: Block broadcast_0 stored as values in memory (estimated size 1280.0 B, free 530.0 MB)</div><div class="line">17/01/10 18:23:35 INFO MemoryStore: ensureFreeSpace(854) called with curMem=1280, maxMem=555755765</div><div class="line">17/01/10 18:23:35 INFO MemoryStore: Block broadcast_0_piece0 stored as bytes in memory (estimated size 854.0 B, free 530.0 MB)</div><div class="line">17/01/10 18:23:35 INFO BlockManagerInfo: Added broadcast_0_piece0 in memory on localhost:38751 (size: 854.0 B, free: 530.0 MB)</div><div class="line">17/01/10 18:23:35 INFO SparkContext: Created broadcast 0 from broadcast at DAGScheduler.scala:861</div><div class="line">17/01/10 18:23:35 INFO DAGScheduler: Submitting 1 missing tasks from ResultStage 0 (ParallelCollectionRDD[0] at parallelize at RRDD.scala:454)</div><div class="line">17/01/10 18:23:35 INFO TaskSchedulerImpl: Adding task set 0.0 with 1 tasks</div><div class="line">17/01/10 18:23:36 INFO TaskSetManager: Starting task 0.0 in stage 0.0 (TID 0, localhost, PROCESS_LOCAL, 16553 bytes)</div><div class="line">17/01/10 18:23:36 INFO Executor: Running task 0.0 in stage 0.0 (TID 0)</div><div class="line">17/01/10 18:23:36 INFO Executor: Finished task 0.0 in stage 0.0 (TID 0). 15464 bytes result sent to driver</div><div class="line">17/01/10 18:23:36 INFO TaskSetManager: Finished task 0.0 in stage 0.0 (TID 0) in 249 ms on localhost (1/1)</div><div class="line">17/01/10 18:23:36 INFO TaskSchedulerImpl: Removed TaskSet 0.0, whose tasks have all completed, from pool </div><div class="line">17/01/10 18:23:36 INFO DAGScheduler: ResultStage 0 (collectPartitions at NativeMethodAccessorImpl.java:-2) finished in 0.300 s</div><div class="line">17/01/10 18:23:36 INFO DAGScheduler: Job 0 finished: collectPartitions at NativeMethodAccessorImpl.java:-2, took 1.618354 s</div><div class="line">Warning messages:</div><div class="line">1: In FUN(X[[i]], ...) :</div><div class="line">  Use Sepal_Length instead of Sepal.Length  as column name</div><div class="line">2: In FUN(X[[i]], ...) :</div><div class="line">  Use Sepal_Width instead of Sepal.Width  as column name</div><div class="line">3: In FUN(X[[i]], ...) :</div><div class="line">  Use Petal_Length instead of Petal.Length  as column name</div><div class="line">4: In FUN(X[[i]], ...) :</div><div class="line">  Use Petal_Width instead of Petal.Width  as column name</div><div class="line">&gt; </div><div class="line">&gt; head(df)</div><div class="line">17/01/10 18:23:45 INFO SparkContext: Starting job: dfToCols at NativeMethodAccessorImpl.java:-2</div><div class="line">17/01/10 18:23:45 INFO DAGScheduler: Got job 1 (dfToCols at NativeMethodAccessorImpl.java:-2) with 1 output partitions</div><div class="line">17/01/10 18:23:45 INFO DAGScheduler: Final stage: ResultStage 1(dfToCols at NativeMethodAccessorImpl.java:-2)</div><div class="line">17/01/10 18:23:45 INFO DAGScheduler: Parents of final stage: List()</div><div class="line">17/01/10 18:23:45 INFO DAGScheduler: Missing parents: List()</div><div class="line">17/01/10 18:23:45 INFO DAGScheduler: Submitting ResultStage 1 (MapPartitionsRDD[4] at dfToCols at NativeMethodAccessorImpl.java:-2), which has no missing parents</div><div class="line">17/01/10 18:23:45 INFO MemoryStore: ensureFreeSpace(9176) called with curMem=2134, maxMem=555755765</div><div class="line">17/01/10 18:23:45 INFO MemoryStore: Block broadcast_1 stored as values in memory (estimated size 9.0 KB, free 530.0 MB)</div><div class="line">17/01/10 18:23:45 INFO MemoryStore: ensureFreeSpace(3690) called with curMem=11310, maxMem=555755765</div><div class="line">17/01/10 18:23:45 INFO MemoryStore: Block broadcast_1_piece0 stored as bytes in memory (estimated size 3.6 KB, free 530.0 MB)</div><div class="line">17/01/10 18:23:45 INFO BlockManagerInfo: Added broadcast_1_piece0 in memory on localhost:38751 (size: 3.6 KB, free: 530.0 MB)</div><div class="line">17/01/10 18:23:45 INFO SparkContext: Created broadcast 1 from broadcast at DAGScheduler.scala:861</div><div class="line">17/01/10 18:23:45 INFO DAGScheduler: Submitting 1 missing tasks from ResultStage 1 (MapPartitionsRDD[4] at dfToCols at NativeMethodAccessorImpl.java:-2)</div><div class="line">17/01/10 18:23:45 INFO TaskSchedulerImpl: Adding task set 1.0 with 1 tasks</div><div class="line">17/01/10 18:23:45 INFO TaskSetManager: Starting task 0.0 in stage 1.0 (TID 1, localhost, PROCESS_LOCAL, 16553 bytes)</div><div class="line">17/01/10 18:23:45 INFO Executor: Running task 0.0 in stage 1.0 (TID 1)</div><div class="line">17/01/10 18:23:51 INFO Executor: Finished task 0.0 in stage 1.0 (TID 1). 1794 bytes result sent to driver</div><div class="line">17/01/10 18:23:51 INFO DAGScheduler: ResultStage 1 (dfToCols at NativeMethodAccessorImpl.java:-2) finished in 5.469 s</div><div class="line">17/01/10 18:23:51 INFO DAGScheduler: Job 1 finished: dfToCols at NativeMethodAccessorImpl.java:-2, took 5.493984 s</div><div class="line">17/01/10 18:23:51 INFO TaskSetManager: Finished task 0.0 in stage 1.0 (TID 1) in 5468 ms on localhost (1/1)</div><div class="line">17/01/10 18:23:51 INFO TaskSchedulerImpl: Removed TaskSet 1.0, whose tasks have all completed, from pool </div><div class="line">  Sepal_Length Sepal_Width Petal_Length Petal_Width Species</div><div class="line">1          5.1         3.5          1.4         0.2  setosa</div><div class="line">2          4.9         3.0          1.4         0.2  setosa</div><div class="line">3          4.7         3.2          1.3         0.2  setosa</div><div class="line">4          4.6         3.1          1.5         0.2  setosa</div><div class="line">5          5.0         3.6          1.4         0.2  setosa</div><div class="line">6          5.4         3.9          1.7         0.4  setosa</div></pre></td></tr></table></figure></p>
<p>单机 :<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">-----------will---------------------will mid----------zhangjiayi</div><div class="line">-----------will-end----------rCommand is : RscriptrOptions is : --vanillarExecScript is : /usr/hdp/2.3.4.0-3485/spark/R/lib/SparkR/worker/daemon.R</div></pre></td></tr></table></figure></p>
<p>用户是zhangjiayi ,<br>执行的系统xi</p>
<p>集群是打印在yarn的container的stdout里的：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">-----------will---------------------will mid----------yarn</div><div class="line">-----------will-end----------rCommand is : RscriptrOptions is : --vanillarExecScript is : /server/hadoop/yarn/local/usercache/zhangjiayi/appcache/application_1483512430911_0006/container_e18_1483512430911_0006_01_000002/sparkr/SparkR/worker/daemon.R-----------will---------------------will mid----------yarn</div><div class="line">-----------will-end----------rCommand is : RscriptrOptions is : --vanillarExecScript is : /server/hadoop/yarn/local/usercache/zhangjiayi/appcache/application_1483512430911_0006/container_e18_1483512430911_0006_01_000002/sparkr/SparkR/worker/daemon.R</div></pre></td></tr></table></figure></p>
<p>结果找不到：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">[root@slavenode5 ~]# ll /server/hadoop/yarn/local/usercache/zhangjiayi/appcache/application_1483512430911_0006/container_e18_1483512430911_0006_01_000002/sparkr/SparkR/worker/daemon.R</div><div class="line">ls: cannot access /server/hadoop/yarn/local/usercache/zhangjiayi/appcache/application_1483512430911_0006/container_e18_1483512430911_0006_01_000002/sparkr/SparkR/worker/daemon.R: No such file or directory</div><div class="line">[root@slavenode5 ~]# ll /server/hadoop/yarn/local/usercache/zhangjiayi/appcache/application_1483512430911_0006/container_e18_1483512430911_0006_01_000002/sparkr/SparkR/worker/daemon.R</div><div class="line">ls: cannot access /server/hadoop/yarn/local/usercache/zhangjiayi/appcache/application_1483512430911_0006/container_e18_1483512430911_0006_01_000002/sparkr/SparkR/worker/daemon.R: No such file or directory</div><div class="line">[root@slavenode5 ~]# ll /server/hadoop/yarn/local/usercache/zhangjiayi/appcache/application_1483512430911_0006/container_e18_1483512430911_0006_01_000002/</div><div class="line">total 24</div><div class="line">-rw-r--r--. 1 yarn hadoop   88 Jan 11 12:25 container_tokens</div><div class="line">-rwx------. 1 yarn hadoop  687 Jan 11 12:25 default_container_executor_session.sh</div><div class="line">-rwx------. 1 yarn hadoop  741 Jan 11 12:25 default_container_executor.sh</div><div class="line">-rwx------. 1 yarn hadoop 4042 Jan 11 12:25 launch_container.sh</div><div class="line">lrwxrwxrwx. 1 yarn hadoop  122 Jan 11 12:25 __spark__.jar -&gt; /server/hadoop/yarn/local/usercache/zhangjiayi/filecache/19/spark-assembly-1.5.2.2.3.4.0-3485-hadoop2.7.1.2.3.4.0-3485.jar</div><div class="line">drwx--x---. 2 yarn hadoop 4096 Jan 11 12:25 tmp</div></pre></td></tr></table></figure></p>
<p>此时控制台的报错只有：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">17/01/11 12:25:42 INFO TaskSetManager: Starting task 0.2 in stage 1.0 (TID 3, slavenode5, PROCESS_LOCAL, 16553 bytes)</div><div class="line">17/01/11 12:25:52 WARN TaskSetManager: Lost task 0.2 in stage 1.0 (TID 3, slavenode5): java.net.SocketTimeoutException: Accept timed out</div><div class="line">	at java.net.PlainSocketImpl.socketAccept(Native Method)</div><div class="line">	at java.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:409)</div><div class="line">	at java.net.ServerSocket.implAccept(ServerSocket.java:545)</div><div class="line">	at java.net.ServerSocket.accept(ServerSocket.java:513)</div><div class="line">	at org.apache.spark.api.r.RRDD$.createRWorker(RRDD.scala:446)</div><div class="line">	at org.apache.spark.api.r.BaseRRDD.compute(RRDD.scala:62)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:66)</div><div class="line">	at org.apache.spark.scheduler.Task.run(Task.scala:88)</div><div class="line">	at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:214)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div><div class="line">17/01/11 12:25:52 INFO TaskSetManager: Starting task 0.3 in stage 1.0 (TID 4, slavenode1, PROCESS_LOCAL, 16553 bytes)</div><div class="line">17/01/11 12:26:02 WARN TaskSetManager: Lost task 0.3 in stage 1.0 (TID 4, slavenode1): java.net.SocketTimeoutException: Accept timed out</div><div class="line">	at java.net.PlainSocketImpl.socketAccept(Native Method)</div><div class="line">	at java.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:409)</div><div class="line">	at java.net.ServerSocket.implAccept(ServerSocket.java:545)</div><div class="line">	at java.net.ServerSocket.accept(ServerSocket.java:513)</div><div class="line">	at org.apache.spark.api.r.RRDD$.createRWorker(RRDD.scala:446)</div><div class="line">	at org.apache.spark.api.r.BaseRRDD.compute(RRDD.scala:62)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.scheduler.ResultTask.runTask(ResultTask.scala:66)</div><div class="line">	at org.apache.spark.scheduler.Task.run(Task.scala:88)</div><div class="line">	at org.apache.spark.executor.Executor$TaskRunner.run(Executor.scala:214)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1142)</div><div class="line">	at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:617)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div><div class="line"></div><div class="line">17/01/11 12:26:02 ERROR TaskSetManager: Task 0 in stage 1.0 failed 4 times; aborting job</div><div class="line">17/01/11 12:26:02 INFO YarnScheduler: Removed TaskSet 1.0, whose tasks have all completed, from pool </div><div class="line">17/01/11 12:26:02 INFO YarnScheduler: Cancelling stage 1</div><div class="line">17/01/11 12:26:02 INFO DAGScheduler: ResultStage 1 (dfToCols at NativeMethodAccessorImpl.java:-2) failed in 42.286 s</div><div class="line">17/01/11 12:26:02 INFO DAGScheduler: Job 1 failed: dfToCols at NativeMethodAccessorImpl.java:-2, took 42.314808 s</div><div class="line">17/01/11 12:26:02 ERROR RBackendHandler: dfToCols on org.apache.spark.sql.api.r.SQLUtils failed</div><div class="line">Error in invokeJava(isStatic = TRUE, className, methodName, ...) : </div><div class="line">  org.apache.spark.SparkException: Job aborted due to stage failure: Task 0 in stage 1.0 failed 4 times, most recent failure: Lost task 0.3 in stage 1.0 (TID 4, slavenode1): java.net.SocketTimeoutException: Accept timed out</div><div class="line">	at java.net.PlainSocketImpl.socketAccept(Native Method)</div><div class="line">	at java.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:409)</div><div class="line">	at java.net.ServerSocket.implAccept(ServerSocket.java:545)</div><div class="line">	at java.net.ServerSocket.accept(ServerSocket.java:513)</div><div class="line">	at org.apache.spark.api.r.RRDD$.createRWorker(RRDD.scala:446)</div><div class="line">	at org.apache.spark.api.r.BaseRRDD.compute(RRDD.scala:62)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div><div class="line">	at org.apache.spark.rdd.RDD.computeOrReadCheckpoint(RDD.scala:300)</div><div class="line">	at org.apache.spark.rdd.RDD.iterator(RDD.scala:264)</div><div class="line">	at org.apache.spark.rdd.MapPartitionsRDD.compute(MapPartitionsRDD.scala:38)</div></pre></td></tr></table></figure>
<p>可以看到是createRWorker里而不是createRProcess报错了。。</p>
<hr>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">Launching java with command  /server/java/jdk1.8.0_60/bin/java   -Xmx512m -cp &apos;/usr/lib64/R/library/SparkR/sparkr-assembly-0.1.jar:&apos; edu.berkeley.cs.amplab.sparkr.SparkRBackend /tmp/Rtmp34rELP/backend_port4e6c126d914 </div><div class="line">createSparkContext on edu.berkeley.cs.amplab.sparkr.RRDD failed with java.lang.NullPointerException</div><div class="line">java.lang.NullPointerException</div><div class="line">	at edu.berkeley.cs.amplab.sparkr.SparkRBackendHandler.handleMethodCall(SparkRBackendHandler.scala:111)</div><div class="line">	at edu.berkeley.cs.amplab.sparkr.SparkRBackendHandler.channelRead0(SparkRBackendHandler.scala:58)</div><div class="line">	at edu.berkeley.cs.amplab.sparkr.SparkRBackendHandler.channelRead0(SparkRBackendHandler.scala:19)</div><div class="line">	at io.netty.channel.SimpleChannelInboundHandler.channelRead(SimpleChannelInboundHandler.java:105)</div><div class="line">	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:308)</div><div class="line">	at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:294)</div><div class="line">	at io.netty.handler.codec.MessageToMessageDecoder.channelRead(MessageToMessageDecoder.java:103)</div><div class="line">	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:308)</div><div class="line">	at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:294)</div><div class="line">	at io.netty.handler.codec.ByteToMessageDecoder.channelRead(ByteToMessageDecoder.java:244)</div><div class="line">	at io.netty.channel.AbstractChannelHandlerContext.invokeChannelRead(AbstractChannelHandlerContext.java:308)</div><div class="line">	at io.netty.channel.AbstractChannelHandlerContext.fireChannelRead(AbstractChannelHandlerContext.java:294)</div><div class="line">	at io.netty.channel.DefaultChannelPipeline.fireChannelRead(DefaultChannelPipeline.java:846)</div><div class="line">	at io.netty.channel.nio.AbstractNioByteChannel$NioByteUnsafe.read(AbstractNioByteChannel.java:131)</div><div class="line">	at io.netty.channel.nio.NioEventLoop.processSelectedKey(NioEventLoop.java:511)</div><div class="line">	at io.netty.channel.nio.NioEventLoop.processSelectedKeysOptimized(NioEventLoop.java:468)</div><div class="line">	at io.netty.channel.nio.NioEventLoop.processSelectedKeys(NioEventLoop.java:382)</div><div class="line">	at io.netty.channel.nio.NioEventLoop.run(NioEventLoop.java:354)</div><div class="line">	at io.netty.util.concurrent.SingleThreadEventExecutor$2.run(SingleThreadEventExecutor.java:111)</div><div class="line">	at io.netty.util.concurrent.DefaultThreadFactory$DefaultRunnableDecorator.run(DefaultThreadFactory.java:137)</div><div class="line">	at java.lang.Thread.run(Thread.java:745)</div></pre></td></tr></table></figure>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/01/09/R/" title="R" itemprop="url">R</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2017-01-09T02:35:22.000Z" itemprop="datePublished"> 发表于 2017-01-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">library(SparkR)</div><div class="line">library(tseries)</div><div class="line">library(forecast)</div><div class="line">library(magrittr)</div><div class="line"></div><div class="line">sc&lt;-sparkR.init()</div><div class="line">hivecontext&lt;-sparkRHive.init(sc)</div><div class="line">sqlcontext&lt;-sparkRSQL.init(sc)</div><div class="line"></div><div class="line">dateline&lt;-seq.Date(from = as.Date(&quot;2015-05-01&quot;),to=as.Date(&quot;2017-01-04&quot;),by=&quot;day&quot;)%&gt;%data.frame(.)</div><div class="line">colnames(dateline)&lt;-&quot;log_day&quot;</div><div class="line">dateline&lt;-createDataFrame(sqlContext=sqlcontext,data=dateline)</div><div class="line">registerTempTable(dateline,&quot;premium_date&quot;)</div><div class="line">  </div><div class="line"></div><div class="line">#  Query the premium log of the users who are still remained for 30d and not labeled as brush.</div><div class="line">z0&lt;-&quot;select	a.userid,</div><div class="line">		          from_unixtime(unix_timestamp(c.log_day,&apos;yyyyMMdd&apos;),&apos;yyyy-MM-dd&apos;) as log_day,</div><div class="line">              c.premium_final</div><div class="line">from dim_jlc.dim_user_info a</div><div class="line">left join app_jlc.brush_user b on a.userid=b.userid and b.log_day=&apos;2017-01-04&apos;</div><div class="line">left join fact_jlc.premium_record c on a.userid=c.userid</div><div class="line">where b.userid is null and datediff(&apos;2017-01-04&apos;,to_date(a.invest1st_time))&gt;30&quot;</div><div class="line"></div><div class="line">z1&lt;-&quot;select	a.userid,</div><div class="line">		to_date(a.invest1st_time) as invest1st_day</div><div class="line">from dim_jlc.dim_user_info a</div><div class="line">left join app_jlc.brush_user b on a.userid=b.userid</div><div class="line">where b.userid is null and datediff(&apos;2017-01-04&apos;,to_date(a.invest1st_time))&gt;30&quot;</div><div class="line"></div><div class="line">result&lt;-sql(hivecontext,z0)</div><div class="line">userinfo&lt;-sql(hivecontext,z1)</div><div class="line">colnames(result)&lt;-c(&quot;userid&quot;,&quot;log_day&quot;,&quot;premium&quot;)</div><div class="line">cache(result)</div><div class="line">cache(userinfo)</div><div class="line"></div><div class="line">user_num&lt;-dim(userinfo)[1]</div><div class="line">for(i in 1:user_num)&#123;</div><div class="line">  userid&lt;-</div><div class="line">  start_day&lt;-select(userinfo,&quot;invest1st_day&quot;)</div><div class="line">  dateline&lt;-seq()</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">#rawdata&lt;-fread(&quot;raw0104.csv&quot;)</div><div class="line">#rawdata_df&lt;-tbl_df(rawdata)</div><div class="line">#colnames(rawdata_df)&lt;-c(&quot;userid&quot;,&quot;log_day&quot;,&quot;premium&quot;)</div><div class="line"></div><div class="line">userinfo_df&lt;-collect(userinfo)</div><div class="line">userinfo_df&lt;-tbl_df(userinfo_df)</div></pre></td></tr></table></figure>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2017/01/02/rancher上手与问题/" title="rancher上手与问题" itemprop="url">rancher上手与问题</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2017-01-02T07:26:07.000Z" itemprop="datePublished"> 发表于 2017-01-02</time>
    
  </p>
</header>
    <div class="article-content">
        
        <ol>
<li>rancher里的host能不能同时属于env1和env2，测试了一下，貌似一个host上只能启动一个agent。</li>
</ol>
<p>先把host1和host2添加到env1后，添加了wordpress的service stack，之后将所有服务都停掉，并deactivate两个hosts。</p>
<p>新建env2，将host1、host2同样的方法添加到env2中，布置mesos集群。</p>
<p>此时切回env1，再去激活host，发现已经不行了，host上提示disconnected。查看下面的container里，是有rancher agent的。有可能这个agent是在env2的那个把，所以不能连接到env1。</p>
<p>那：就是不能同时属于两个env咯？</p>
<ol>
<li>遇到get ip timeout问题，一般升级这个组件的版本就可以了</li>
<li>如果我们升级了某个组件的版本，再去调整这个组件的scale，它竟然会先自动降级，然后再调整scale。然后版本就<strong>又恢复成低版本</strong>的了。 Orz….</li>
<li></li>
</ol>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/13/"><span></span>Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="page-number" href="/page/13/">13</a><span class="page-number current">14</span><a class="page-number" href="/page/15/">15</a><a class="page-number" href="/page/16/">16</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" href="/page/15/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  

  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/youdaonote/" title="youdaonote">youdaonote<sup>187</sup></a></li>
			
		
			
				<li><a href="/tags/源码/" title="源码">源码<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/akka/" title="akka">akka<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/flume/" title="flume">flume<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/ETL/" title="ETL">ETL<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/solr/" title="solr">solr<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/spring/" title="spring">spring<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/调度平台/" title="调度平台">调度平台<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/azkaban/" title="azkaban">azkaban<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/mysql/" title="mysql">mysql<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/scala/" title="scala">scala<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/ambari/" title="ambari">ambari<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/quartz/" title="quartz">quartz<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/nodejs/" title="nodejs">nodejs<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Solr/" title="Solr">Solr<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/guava/" title="guava">guava<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/heroku/" title="heroku">heroku<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/hdfs/" title="hdfs">hdfs<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/hue/" title="hue">hue<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ElasticSearch/" title="ElasticSearch">ElasticSearch<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://github.com/willcup" target="_blank" title=" 我自己的github">github</a>
            
          </li>
        
          <li>
            
            	<a href="http://thisding.com" target="_blank" title="朋友的主页">Steven&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Will Chen in MeiTuan. <br/>
			元 亨 利 贞.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:chenxin15@meituan.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2017 
		
		<a href="/about" target="_blank" title="Will Chen">Will Chen</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fe6d1f421bbc9962127a50488f9ed37d1' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
