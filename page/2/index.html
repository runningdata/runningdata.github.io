
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Will&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Will Chen">
    

    
    <meta name="description" content="左右水色 右手天光">
<meta property="og:type" content="website">
<meta property="og:title" content="Will's Blog">
<meta property="og:url" content="http://willcup.com/page/2/index.html">
<meta property="og:site_name" content="Will's Blog">
<meta property="og:description" content="左右水色 右手天光">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Will's Blog">
<meta name="twitter:description" content="左右水色 右手天光">

    
    <link rel="alternative" href="/atom.xml" title="Will&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Will&#39;s Blog" title="Will&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Will&#39;s Blog">Will&#39;s Blog</a></h1>
				<h2 class="blog-motto">简易 变易 不易</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/node_modules">测试</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:willcup.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/21/django的POST或者GET参数映射到对象/" title="django的POST或者GET参数映射到对象" itemprop="url">django的POST或者GET参数映射到对象</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-07-21T11:50:59.000Z" itemprop="datePublished"> 发表于 2016-07-21</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>原理及其简单，就算利用python的自省，有点儿类似java的反射调用。<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">etl = ETL()</div><div class="line">        dic = dict(request.POST)</div><div class="line">        <span class="keyword">for</span> k,v <span class="keyword">in</span> dic.iteritems():</div><div class="line">            <span class="keyword">if</span> hasattr(etl, k):</div><div class="line">                setattr(etl, k, v)</div><div class="line">        <span class="keyword">print</span> etl</div></pre></td></tr></table></figure></p>
<p>就这几行代码就可以搞定了。为了公用方便，可以抽出来作为一个module使用。</p>
<p>简单封装了以下<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># -*- coding: utf-8 -*</span></div><div class="line"><span class="keyword">import</span> logging</div><div class="line"></div><div class="line"><span class="string">'''</span></div><div class="line">http的一些常用的工具方法</div><div class="line">'''</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">post2obj</span><span class="params">(obj, post, *excludes)</span>:</span></div><div class="line">    <span class="string">'''</span></div><div class="line">    将post里的参数对应copy到obj里，主要是方便http接口直接使用obj进行操作</div><div class="line">    :param obj:</div><div class="line">    :param post:</div><div class="line">    :return:</div><div class="line">    '''</div><div class="line">    dic = dict(post)</div><div class="line">    <span class="keyword">for</span> k, v <span class="keyword">in</span> dic.iteritems():</div><div class="line">        <span class="keyword">if</span> k <span class="keyword">not</span> <span class="keyword">in</span> excludes:</div><div class="line">            <span class="keyword">if</span> hasattr(obj, k):</div><div class="line">                v = <span class="string">''</span>.join(v)</div><div class="line">                setattr(obj, k, v)</div><div class="line">    logging.info(<span class="string">"post params has been copied to  obj -&gt; %s"</span> % obj)</div><div class="line"></div><div class="line">...</div><div class="line">...</div><div class="line">get 同理</div></pre></td></tr></table></figure></p>
<p><code>注意</code>：上面我们使用了’’.join(v)。因为从dict里遍历出来的所有value都是list类型的。而<code>request.POST[&#39;xxx&#39;]</code>取出来的就是正常的unicode类型。list会在后面的处理中出现很多问题，所以这里转成str再使用。</p>
<p>再想想，其实可以通过python的装饰器【对应java里的注释】实现，但是目前不太确定python是否支持java的泛型类的东西，可以用来自动生成操作对象的实例。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/21/django的奇葩form/" title="django的奇葩form" itemprop="url">django的奇葩form</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-07-21T10:11:22.000Z" itemprop="datePublished"> 发表于 2016-07-21</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>记录一下遇到的最奇葩的组件：django的form插件。官方文档是：<a href="https://docs.djangoproject.com/ja/1.9/ref/forms/widgets/。" target="_blank" rel="external">https://docs.djangoproject.com/ja/1.9/ref/forms/widgets/。</a></p>
<p>弄这个东西的初衷场景：python里暂时没有找到类似java里类似下面的功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@RequestMapping</span>(value = <span class="string">"save"</span>,method = RequestMethod.POST, produces = MediaType.APPLICATION_JSON)</div><div class="line">    <span class="keyword">public</span> <span class="meta">@ResponseBody</span> <span class="function">Object <span class="title">addETL</span><span class="params">(ETL etl)</span> <span class="keyword">throws</span> Exception</span>&#123;</div><div class="line">        etl.setAuthor(<span class="string">"will"</span>);</div><div class="line">        etlService.addETL(etl);</div><div class="line">        <span class="keyword">return</span> <span class="string">"&#123;\"message\" :\"success\"&#125;"</span>;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>调用这个接口的时候，只需要传递ETL的字段就可以了，不管是POST还是GET方法，都会自己序列化进入ETL对象，然后就可以操作client端传送上来的ETL对象了 。<br>但是在python或者django里本人暂时没有找到这种方便的方式，只能通过request.POST[‘name’]之类的方法，挨个从POST对象里面取出来，再自己用这些属性去初始化ETL对象，之后再去执行save或者等等之类的操作….身为一个优秀的程序员，必须将“懒”的特性发回出来。所以就去django官网找能够实现类似功能的例子，所以就找到了django的form组件。</p>
<p>额外发现是，当我们需要编辑一个已经存在的ETL的时候，可以自动把所有字段渲染到前端。</p>
<p>那么满怀期待地开始了恶心的form探索之旅。</p>
<h2 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h2><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"etls/add"</span> <span class="attr">method</span>=<span class="string">"POST"</span>&gt;</span></div><div class="line">    &#123;% csrf_token %&#125;</div><div class="line">        &#123;&#123; form.as_p &#125;&#125;</div><div class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></div></pre></td></tr></table></figure>
<p>简直是简单的不要不要的。</p>
<p>后端</p>
<h2 id="views文件里定义一个Form。"><a href="#views文件里定义一个Form。" class="headerlink" title="views文件里定义一个Form。"></a>views文件里定义一个Form。</h2><p>自定义一个form<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ETLForm</span><span class="params">(forms.ModelForm)</span>:</span></div><div class="line">    preSql = forms.CharField(widget=forms.Textarea(attrs=&#123;<span class="string">'class'</span>: <span class="string">"form-control"</span>, <span class="string">"size"</span>: <span class="number">10</span>&#125;))</div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        model = ETL</div><div class="line">        exclude = [<span class="string">'id'</span>, <span class="string">'ctime'</span>]</div></pre></td></tr></table></figure></p>
<p>上面这段，定义了preSql这个字段的显示类型为form的textarea，然后定义来这个textarea的属性，包括class样式。<br>Meta里定义了model的数据模型，还有要去除不显示的字段。也可以指定fields，就是要显示的字段。 怎么方便怎么来就是了。</p>
<p>其实恶心的东西就是这里写的样式了。好，就算能够接受后端把逻辑和样式一起写了。可是对于不是form的样式怎么办呢，有很多页面就不是form啊，比如列表～会有很多样式必须需要在前端写。那样就是前端有样式，后端也有样式，麻蛋，想想头就大。</p>
<p>其实是有种更方便的做法<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">Form = modelform_factory(Author, form=AuthorForm, localized_fields=(<span class="string">"birth_date"</span>,))</div></pre></td></tr></table></figure></p>
<p>鉴于本人对上面这种后端写样式就已经感觉不能接受了，就没有再继续搞这个东西。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@transaction.atomic</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(request, pk)</span>:</span></div><div class="line">    <span class="keyword">if</span> request.method == <span class="string">'POST'</span>:</div><div class="line">        form = ETLForm(request.POST)</div><div class="line">        <span class="keyword">if</span> form.is_valid():</div><div class="line"></div><div class="line"></div><div class="line">            new_etl = form.save()</div><div class="line">            logger.info(<span class="string">'ETL has been created successfully : '</span> + new_etl)</div><div class="line">            <span class="keyword">return</span> HttpResponseRedirect(reverse(<span class="string">'metamap:index'</span>))</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        etl = ETL.objects.get(pk=pk)</div><div class="line">        form = ETLForm(instance=etl)</div><div class="line">        <span class="keyword">return</span> render(request, <span class="string">'etl/edit.html'</span>, &#123;<span class="string">'form'</span>: form&#125;)</div></pre></td></tr></table></figure>
<p>路由配置是<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">url(<span class="string">'etls/(?P&lt;pk&gt;[0-9]+)/$'</span>, etls.edit),</div></pre></td></tr></table></figure></p>
<p><img src="/imgs/django/django-form.png" alt="前端效果图"></p>
<p>记录以下这个奇葩组件，然后使用传统form进行逻辑编写，就算是要到POST里逐个取值，也认了！！！！</p>
<p>widget相关：<a href="https://docs.djangoproject.com/ja/1.9/ref/forms/widgets/" target="_blank" rel="external">https://docs.djangoproject.com/ja/1.9/ref/forms/widgets/</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/21/django起步/" title="django起步" itemprop="url">django起步</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-07-21T07:59:22.000Z" itemprop="datePublished"> 发表于 2016-07-21</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>参见：<a href="https://github.com/WillCup/metamap/blob/master/metamap_py/polls/%E5%AE%98%E6%96%B9%E6%95%99%E7%A8%8B.md" target="_blank" rel="external">https://github.com/WillCup/metamap/blob/master/metamap_py/polls/%E5%AE%98%E6%96%B9%E6%95%99%E7%A8%8B.md</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/django/">django</a><a href="/tags/python/">python</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/16/JPARepository杂记/" title="JPARepository杂记" itemprop="url">JPARepository杂记</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-07-16T15:05:41.000Z" itemprop="datePublished"> 发表于 2016-07-16</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="join时报错"><a href="#join时报错" class="headerlink" title="join时报错"></a>join时报错</h2><p>报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">QuerySyntaxException: expecting IDENT, found &apos;*&apos; near line 1</div></pre></td></tr></table></figure></p>
<p>原始sql<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">hql:<span class="keyword">select</span> a.* <span class="keyword">from</span> <span class="keyword">Archive</span> a,Employee e,Department d <span class="keyword">where</span> a.contractEndDate = :<span class="built_in">date</span> <span class="keyword">and</span> a.status = <span class="string">'A'</span> <span class="keyword">and</span> a.empId = e.id <span class="keyword">and</span> e.status = <span class="string">'A'</span> <span class="keyword">and</span> e.type = <span class="string">'A'</span></div></pre></td></tr></table></figure></p>
<p>改成<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">select</span> a <span class="keyword">from</span> <span class="keyword">Archive</span> a,Employee e,Department d <span class="keyword">where</span> a.contractEndDate = :<span class="built_in">date</span> <span class="keyword">and</span> a.status = <span class="string">'A'</span> <span class="keyword">and</span> a.empId = e.id <span class="keyword">and</span> e.status = <span class="string">'A'</span> <span class="keyword">and</span> e.type = <span class="string">'A'</span></div></pre></td></tr></table></figure></p>
<p>select 后面为对象 a .而非 a.*</p>
<p>参考：<br><a href="http://blog.sina.com.cn/s/blog_4bf2e5550100n2gh.html" target="_blank" rel="external">http://blog.sina.com.cn/s/blog_4bf2e5550100n2gh.html</a></p>
<h2 id="SQL面向Entity"><a href="#SQL面向Entity" class="headerlink" title="SQL面向Entity"></a>SQL面向Entity</h2><p>指的是在JPARepository的子类中自定义的函数<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TblBloodRepository</span> <span class="keyword">extends</span> <span class="title">JpaRepository</span>&lt;<span class="title">TblBlood</span>, <span class="title">Integer</span>&gt;</span>&#123;</div><div class="line">    <span class="function">TblBlood <span class="title">findByTblName</span><span class="params">(String tblName)</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@Query</span>(<span class="string">"select a from "</span></div><div class="line">            + <span class="string">"(select blood from TblBlood blood where valid = 1) a"</span></div><div class="line">            + <span class="string">" left outer join "</span></div><div class="line">            + <span class="string">"(select distinct parentTbl from TblBlood where valid = 1) b"</span></div><div class="line">            + <span class="string">" on a.tblName = b.parentTbl"</span></div><div class="line">            + <span class="string">" where b.parentTbl is null"</span>)</div><div class="line">    <span class="function">List&lt;TblBlood&gt; <span class="title">selectAllLeaf</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="meta">@Modifying</span></div><div class="line">    <span class="meta">@Query</span>(<span class="string">"update TblBlood set valid = 0 where tblName=:tblName"</span>)</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">makePreviousInvalid</span><span class="params">(@Param(<span class="string">"tblName"</span>)</span>String tblName)</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Query</span>(<span class="string">"select b from"</span></div><div class="line">            + <span class="string">" TblBlood a join TblBlood b"</span></div><div class="line">            + <span class="string">" on a.parentTbl = b.tblName and b.valid = 1"</span></div><div class="line">            + <span class="string">" where a.valid = 1 and a.tblName = :tblName"</span>)</div><div class="line">    <span class="function">List&lt;TblBlood&gt; <span class="title">selectParentByTblName</span><span class="params">(@Param(<span class="string">"tblName"</span>)</span>String tblName)</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Query</span>(<span class="string">"from TblBlood where valid = 1 and parentTbl=:tblName"</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> List&lt;TblBlood&gt; <span class="title">selectByParentTblName</span><span class="params">(@Param(<span class="string">"tblName"</span>)</span>String tblName)</span>;</div><div class="line"></div><div class="line">    <span class="meta">@Query</span>(<span class="string">"from TblBlood where valid = 1 and tblName=:tblName"</span>)</div><div class="line">    <span class="function">List&lt;TblBlood&gt; <span class="title">selectByTblName</span><span class="params">(@Param(<span class="string">"tblName"</span>)</span>String tblName)</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>TblBlood就是对象的类名，而不是真正的表名。</p>
<h2 id="自join"><a href="#自join" class="headerlink" title="自join"></a>自join</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Query</span>(<span class="string">"select b from"</span></div><div class="line">            + <span class="string">" TblBlood a join TblBlood b"</span></div><div class="line">            + <span class="string">" on a.parentTbl = b.tblName and b.valid = 1"</span></div><div class="line">            + <span class="string">" where a.valid = 1 and a.tblName = ?1"</span>)</div><div class="line">    <span class="function">List&lt;TblBlood&gt; <span class="title">selectParentByTblName</span><span class="params">(String tblName)</span></span>;</div></pre></td></tr></table></figure>
<p>报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">  Path expected for join!</div><div class="line">	at org.hibernate.hql.internal.ast.HqlSqlWalker.createFromJoinElement(HqlSqlWalker.java:378)</div><div class="line">	at org.hibernate.hql.internal.antlr.HqlSqlBaseWalker.joinElement(HqlSqlBaseWalker.java:3858)</div><div class="line">	at org.hibernate.hql.internal.antlr.HqlSqlBaseWalker.fromElement(HqlSqlBaseWalker.java:3644)</div><div class="line">	at org.hibernate.hql.internal.antlr.HqlSqlBaseWalker.fromElementList(HqlSqlBaseWalker.java:3522)</div><div class="line"> </div><div class="line"> org.springframework.beans.factory.BeanCreationException: Error creating bean with name &apos;tblBloodRepository&apos;: Invocation of init method failed; nested exception is java.lang.IllegalArgumentException: Validation failed for query for method public abstract java.util.List com.will.hivesolver.repositories.TblBloodRepository.selectParentByTblName(java.lang.String)!</div><div class="line">	at org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory.initializeBean(AbstractAutowireCapableBeanFactory.java:1574)</div><div class="line">	...</div><div class="line">Caused by: java.lang.IllegalArgumentException: Validation failed for query for method public abstract java.util.List com.will.hivesolver.repositories.TblBloodRepository.selectParentByTblName(java.lang.String)!</div><div class="line">	at org.springframework.data.jpa.repository.query.SimpleJpaQuery.validateQuery(SimpleJpaQuery.java:84)</div><div class="line">	.....</div><div class="line">Caused by: java.lang.IllegalStateException: No data type for node: org.hibernate.hql.internal.ast.tree.IdentNode </div><div class="line"> \-[IDENT] IdentNode: &apos;b&apos; &#123;originalText=b&#125;</div><div class="line"></div><div class="line">	at org.hibernate.hql.internal.ast.tree.SelectClause.initializeExplicitSelectClause(SelectClause.java:174)</div><div class="line">	at org.hibernate.hql.internal.ast.HqlSqlWalker.useSelectClause(HqlSqlWalker.java:923)</div><div class="line">	...</div></pre></td></tr></table></figure></p>
<h2 id="不能更新"><a href="#不能更新" class="headerlink" title="不能更新"></a>不能更新</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">严重: Servlet.service() for servlet [api] in context with path [/metamap] threw exception [Request processing failed; nested exception is org.springframework.dao.InvalidDataAccessApiUsageException: Executing an update/delete query; nested exception is javax.persistence.TransactionRequiredException: Executing an update/delete query] with root cause</div><div class="line">javax.persistence.TransactionRequiredException: Executing an update/delete query</div></pre></td></tr></table></figure>
<p>Spring Data JPA，事务导致的异常</p>
<p>需要在springMVC的xml里添加,这里只扫描Controller所在的位置里的Controller<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.will.hivesolver.controller"</span> <span class="attr">use-default-filters</span>=<span class="string">"false"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">"annotation"</span> <span class="attr">expression</span>=<span class="string">"org.springframework.stereotype.Controller"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">context:include-filter</span> <span class="attr">type</span>=<span class="string">"annotation"</span> <span class="attr">expression</span>=<span class="string">"org.springframework.web.bind.annotation.ControllerAdvice"</span>/&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>在applicationContext.xml中添加，这里必须不能扫描上面扫描过的Controller：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">context:component-scan</span> <span class="attr">base-package</span>=<span class="string">"com.will.hivesolver"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">"annotation"</span> <span class="attr">expression</span>=<span class="string">"org.springframework.stereotype.Controller"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">context:exclude-filter</span> <span class="attr">type</span>=<span class="string">"annotation"</span> <span class="attr">expression</span>=<span class="string">"org.springframework.web.bind.annotation.ControllerAdvice"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">context:component-scan</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>参考：<a href="https://github.com/springside/springside4/wiki/Spring-MVC" target="_blank" rel="external">https://github.com/springside/springside4/wiki/Spring-MVC</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/spring/">spring</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/16/express杂记/" title="express杂记" itemprop="url">express杂记</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-07-16T15:02:39.000Z" itemprop="datePublished"> 发表于 2016-07-16</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="app-set-get"><a href="#app-set-get" class="headerlink" title="app.set/get"></a>app.set/get</h2><p>用来查看或者设置一些配置参数</p>
<h2 id="express里变量的换行出不来"><a href="#express里变量的换行出不来" class="headerlink" title="express里变量的换行出不来"></a>express里变量的换行出不来</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">router.get(<span class="string">'/get_log'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">req, res</span>) </span>&#123;</div><div class="line">      worker.exec(<span class="string">"cat "</span> + req.query.location, <span class="function"><span class="keyword">function</span> (<span class="params">error, stdout, stderr</span>) </span>&#123;</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'stderr : '</span> + stderr);</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'stdout : '</span> + stdout);</div><div class="line">        <span class="built_in">console</span>.log(<span class="string">'error : '</span> + error);</div><div class="line">        res.render(<span class="string">'etls/log'</span>, &#123;<span class="attr">stdout</span> : stdout, <span class="attr">log</span> : req.query.location&#125;);</div><div class="line">      &#125;); </div><div class="line">    &#125;);</div></pre></td></tr></table></figure>
<p>后面控制台的输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">stderr : </div><div class="line">stdout : # job for mymeta@my_table</div><div class="line"># author : will</div><div class="line"># create time : 19700118070840</div><div class="line"># pre settings </div><div class="line">delete from default.tbl</div><div class="line">select * from batting</div><div class="line">error : null</div></pre></td></tr></table></figure></p>
<p>模板文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">#&#123;stdout&#125;</div></pre></td></tr></table></figure></p>
<p>前端输出<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># job for mymeta@my_table # author : will # create time : 19700118070840 # pre settings delete from default.tbl select * from batting</div></pre></td></tr></table></figure></p>
<p>控制台的stdout变量是换行的，但是前端就不换行。试了一下res.send()，结果也是这样。</p>
<p>模板修改为<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">!&#123;stdout.replace(/\n/g, &apos;&lt;br/&gt;&apos;)&#125;</div></pre></td></tr></table></figure></p>
<p>如果使用res.send()的话，就res.send(stdout.replace(/\n/g, ‘<br>‘))就行了。</p>
<p>这个换行支持起来那么难么？比较low的感觉。</p>
<h2 id="body-parser"><a href="#body-parser" class="headerlink" title="body-parser"></a>body-parser</h2><p>安装了body parser之后就可以方便的在req中使用 <code>req.body</code>来获取form内容，使用<code>req.query</code>来获取querystring里的内容了。</p>
<p>但是一定要注意express的app.use是有前后次序的。<code>踩过坑</code></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/nodejs/">nodejs</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/07/16/antlr简记/" title="antlr简记" itemprop="url">antlr简记</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-07-16T14:49:04.000Z" itemprop="datePublished"> 发表于 2016-07-16</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="要素"><a href="#要素" class="headerlink" title="要素"></a>要素</h2><ul>
<li>source code：面向编程人员的语言代码；</li>
<li>Lexical Analyser ：词汇解析。将source code解析成为某个语言能理解的有意义的形式；</li>
<li>Syntax Analyser: 语法解析，检查语言的正确性。</li>
<li>Semantic Analyser: 语义解析；</li>
<li>Generate/Improve Code: 生成机器能够读懂的执行代码。</li>
</ul>
<p><img src="/imgs/antlr/general_phrases_of_compiler.png" alt=""></p>
<p>参考：<a href="https://www.youtube.com/watch?v=PooQrbFrd_U" target="_blank" rel="external">https://www.youtube.com/watch?v=PooQrbFrd_U</a></p>
<h2 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h2><h4 id="环境准备-1"><a href="#环境准备-1" class="headerlink" title="环境准备"></a>环境准备</h4><p>使用eclipse进行开发。</p>
<ul>
<li>IDE环境准备：eclipse classic 3.5.0</li>
<li>eclipse 插件<ul>
<li>GEF-ALL-3.8.2</li>
<li>dltk-core-S-3.0.1-201108261011</li>
<li>antlr3. <a href="http://antlrv3ide.sourceforge.net/updates" target="_blank" rel="external">http://antlrv3ide.sourceforge.net/updates</a></li>
</ul>
</li>
</ul>
<h4 id="插件设置"><a href="#插件设置" class="headerlink" title="插件设置"></a>插件设置</h4><p>主要就是preferences里的antlr-&gt;builder里添加一个installed package，只需要一个jar包即可，但是规范是把这个jar包放到某个文件夹里。</p>
<p>我的地址是：E:\tools\antlr3.2。里面放置了antlr-3.2.jar文件。<br><img src="/imgs/antlr/antlr-install-package-eclipse.png" alt="添加antlr的jar包给插件调用"><br>还可以在code generator配置一下代码产生的位置。<br><img src="/imgs/antlr/antlr-code-generator-eclipse.png" alt="代码产生位置"></p>
<h4 id="IDE简介"><a href="#IDE简介" class="headerlink" title="IDE简介"></a>IDE简介</h4><h5 id="grammer编辑界面"><a href="#grammer编辑界面" class="headerlink" title="grammer编辑界面"></a>grammer编辑界面</h5><p>有些自动提示啥的，保存后会自动编译，并在前面指定位置生成lexer和parser代码。<br><img src="/imgs/antlr/antlr-editor-eclipse.png" alt="antlr编辑器"></p>
<h5 id="测试执行界面"><a href="#测试执行界面" class="headerlink" title="测试执行界面"></a>测试执行界面</h5><p>完成gramemr的编辑之后，可以编辑一些测试脚本，验证grammer的正确性。跟测试连接的真紧密啊，貌似antlr想不测试驱动开发都难，哈哈~<br><img src="/imgs/antlr/antlr-intercepter-eclipse.png" alt="antlr Intercepter"><br><strong>注意</strong> : 有的时候直接点击右上角的执行按钮，并不能成功解析。可以再试一下执行的下来按钮里的Run(java)的方式，它等同于执行以下代码：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">```</div><div class="line"></div><div class="line">##### RailRoad 视图</div><div class="line">展示每个rule的路线图。点击左边的rule，右边就自动呈现出来了。可以形象化的展示我们定义的每个rule。</div><div class="line">![antlr RailRoad界面](/imgs/antlr/antlr-railroad-eclipse.png)</div><div class="line">  </div><div class="line">  </div><div class="line">  </div><div class="line">  </div><div class="line">#### 创建项目</div><div class="line">创建普通java项目，之后转为antlr项目，.project：</div><div class="line">```xml</div><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line">&lt;projectDescription&gt;</div><div class="line">	&lt;name&gt;anltr-learning&lt;/name&gt;</div><div class="line">	&lt;comment&gt;&lt;/comment&gt;</div><div class="line">	&lt;projects&gt;</div><div class="line">	&lt;/projects&gt;</div><div class="line">	&lt;buildSpec&gt;</div><div class="line">		&lt;buildCommand&gt;</div><div class="line">			&lt;name&gt;org.eclipse.dltk.core.scriptbuilder&lt;/name&gt;</div><div class="line">			&lt;arguments&gt;</div><div class="line">			&lt;/arguments&gt;</div><div class="line">		&lt;/buildCommand&gt;</div><div class="line">		&lt;buildCommand&gt;</div><div class="line">			&lt;name&gt;org.eclipse.jdt.core.javabuilder&lt;/name&gt;</div><div class="line">			&lt;arguments&gt;</div><div class="line">			&lt;/arguments&gt;</div><div class="line">		&lt;/buildCommand&gt;</div><div class="line">	&lt;/buildSpec&gt;</div><div class="line">	&lt;natures&gt;</div><div class="line">		&lt;nature&gt;org.eclipse.jdt.core.javanature&lt;/nature&gt;</div><div class="line">		&lt;nature&gt;org.deved.antlride.core.nature&lt;/nature&gt;</div><div class="line">	&lt;/natures&gt;</div><div class="line">&lt;/projectDescription&gt;</div></pre></td></tr></table></figure></p>
<p>在根目录创建一个lib文件夹，然后把刚才那个install package里的jar包copy到lib里来，加入当前project的build path。</p>
<h4 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h4><p>逻辑流程图<br><img src="/imgs/antlr/antlr-process-concepts.png" alt="逻辑流程"><br>物理流程图<br><img src="/imgs/antlr/antlr-process-code.png" alt="物理流程"></p>
<ul>
<li>Lexer解析出重要的Token发送给Parser</li>
<li>Parser生成AST Tree，</li>
<li>TreeParser负责结合AST Tree里的context生成代码</li>
</ul>
<h4 id="创建antlr文件"><a href="#创建antlr文件" class="headerlink" title="创建antlr文件"></a>创建antlr文件</h4><p>创建Sample.g文件，开始真正编辑antlr文件。经测试，.g文件并不支持中文注释，会报某种NullPointer的错误。下面的注释只为解释，如果copy的话，自行注意去除。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div></pre></td><td class="code"><pre><div class="line">grammar Sample;// 类似类名似的，必须跟文件同名</div><div class="line"></div><div class="line">options &#123;</div><div class="line">  language = Java;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@header &#123;</div><div class="line">    package com.will;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">@lexer::header &#123;</div><div class="line">    package com.will;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// 以下这些在antlr里都是rule了。就是定义一些语法规则。</div><div class="line">// IDENT其实也可以看成rule，只是只包含常量的rule而已。</div><div class="line">// 这个program是最外层的rule了，其实也可以叫pppp，随便。</div><div class="line">program</div><div class="line">    : &apos;program&apos; IDENT &apos;=&apos;</div><div class="line">        (constrant | variable)*</div><div class="line">        &apos;begin&apos;</div><div class="line">        statement*</div><div class="line">        &apos;end&apos; IDENT &apos;.&apos;</div><div class="line">    ;</div><div class="line"></div><div class="line">constrant</div><div class="line">    : &apos;constrant&apos; IDENT &apos;:&apos; type &apos;:=&apos; Integer &apos;;&apos;</div><div class="line">    ;</div><div class="line">    </div><div class="line">type</div><div class="line">    : &apos;Integer&apos;</div><div class="line">    ;</div><div class="line">    </div><div class="line">variable</div><div class="line">    : &apos;var&apos; IDENT (&apos;,&apos; IDENT)* &apos;:&apos; type &apos;;&apos;</div><div class="line">    ;</div><div class="line">    </div><div class="line">    </div><div class="line">// fun time</div><div class="line">// 运算符优先级设计实现，低优先级expression调用高优先级的expression</div><div class="line">term</div><div class="line">    : Integer</div><div class="line">    | &apos;(&apos; expression &apos;)&apos;</div><div class="line">    | IDENT</div><div class="line">    ;</div><div class="line"></div><div class="line">negation</div><div class="line">    : &apos;not&apos;* term</div><div class="line">    ;</div><div class="line">    </div><div class="line">unary</div><div class="line">    : (&apos;+&apos; |&apos;-&apos;)* negation</div><div class="line">    ;</div><div class="line"></div><div class="line">mult</div><div class="line">    : unary ((&apos;*&apos; | &apos;/&apos; | &apos;mode&apos;) unary)*</div><div class="line">    ;</div><div class="line">    </div><div class="line">add</div><div class="line">    : mult ((&apos;+&apos; | &apos;-&apos;) mult)*</div><div class="line">    ;</div><div class="line">    </div><div class="line">relation</div><div class="line">    : add ((&apos;=&apos; | &apos;/=&apos; | &apos;&lt;&apos; | &apos;&lt;=&apos; | &apos;&gt;&apos; | &apos;&gt;=&apos;) add)*</div><div class="line">    ;</div><div class="line"></div><div class="line">expression</div><div class="line">    : relation ((&apos;and&apos; | &apos;or&apos;) relation)*</div><div class="line">    ;</div><div class="line"></div><div class="line">statement</div><div class="line">    : assignmentStatement</div><div class="line">    | ifStatement</div><div class="line">    | loopStatement</div><div class="line">    ;</div><div class="line">exitStatement</div><div class="line">    : &apos;exit&apos; &apos;when&apos; expression</div><div class="line">    ;</div><div class="line"></div><div class="line">assignmentStatement</div><div class="line">    : IDENT &apos;:=&apos; expression &apos;;&apos;</div><div class="line">    ;</div><div class="line">    </div><div class="line">ifStatement</div><div class="line">    : &apos;if&apos; expression &apos;then&apos; statement+</div><div class="line">    (&apos;elif&apos; expression &apos;then&apos; statement+)*</div><div class="line">    (&apos;else&apos; statement+)?</div><div class="line">    &apos;end&apos; &apos;if&apos; &apos;;&apos;</div><div class="line">    ;</div><div class="line">    </div><div class="line">loopStatement</div><div class="line">    : &apos;loop&apos; statement* </div><div class="line">    exitStatement</div><div class="line">    &apos;end&apos; &apos;loop&apos; &apos;;&apos;</div><div class="line">    ;</div><div class="line"> </div><div class="line"></div><div class="line">// 静态常量rule</div><div class="line">Integer: &apos;0&apos;..&apos;9&apos;+;</div><div class="line"></div><div class="line">IDENT  : (&apos;a&apos;..&apos;z&apos; | &apos;A&apos;..&apos;Z&apos; | &apos;0&apos;..&apos;9&apos;)+;</div><div class="line">WS:(&apos; &apos; | &apos;\t&apos; |&apos;\n&apos;|&apos;\r&apos;|&apos;\f&apos;)+ &#123;$channel = HIDDEN;&#125;;</div><div class="line"></div><div class="line">// comment</div><div class="line">COMMENT: &apos;//&apos; .* (&apos;\n&apos; | &apos;\r&apos;) &#123;$channel = HIDDEN;&#125;;</div><div class="line">MUTICOMMENT: &apos;/*&apos; .* &apos;*/&apos; &#123;$channel = HIDDEN;&#125;;</div></pre></td></tr></table></figure></p>
<p>上面的文件中有个要提示的地方，就是优先级设置：<br><img src="/imgs/antlr/antlr-exec-level.png" alt="优先级定义"><br>直接copy的人家的图，大概就是从上到下优先级递减。在grammer中的实现就是低优先级的expression调用高优先级的expression，这样在调用某个expression的时候，就先执行位于叶子节点的最高优先级的expression了。</p>
<p>对应的测试代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">program XLSample1 = </div><div class="line">constrant one:Integer :=1;</div><div class="line">constrant two:Integer :=2;</div><div class="line">var x, y, z:Integer;</div><div class="line">begin</div><div class="line">x := 30 + 2 * 9 -10;</div><div class="line">y := 10;</div><div class="line">	if x=2 then</div><div class="line">		y:= 9 * 7 -1;</div><div class="line">		if 9 &gt; d then</div><div class="line">			x:= 90;</div><div class="line">		else</div><div class="line">			x:=0;</div><div class="line">		end if;</div><div class="line">	elif x&gt;9 and 8 &lt; 2 then</div><div class="line">//		x:=90;</div><div class="line">		y:=100;</div><div class="line">	else</div><div class="line">		x:= 99;</div><div class="line">		z:=100;</div><div class="line">		y:=100;</div><div class="line">	end if;</div><div class="line"></div><div class="line">loop</div><div class="line">	x:=0;</div><div class="line">	y:=99;</div><div class="line">	exit when x =0</div><div class="line">end loop;</div><div class="line">end XLSample1.</div></pre></td></tr></table></figure></p>
<p>虽然就这么几个简单的句子，但是跑出来的AST简直是太大了，就不截图了，感兴趣自己运行了看吧。</p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>动态的rule使用小写，静态常量rule就只用大写字母。</p>
<h5 id="表达式"><a href="#表达式" class="headerlink" title="表达式"></a>表达式</h5><p>基本跟正则差不太多。<br>表达式 | 解释<br>—|—<br>(a | b)| 就是a和b可以以任意次序出现，不严格限定a先于b,或者b先于a。<br>(a | b)<em> | 两者都可以有0或多个<br>(a | b)+ | 两者至少有一个，多个的话，次序可乱<br>| | 或者<br>‘0’..’9’ | 从’0’至’9’，字母也一样，生成的java代码都是直接使用&gt;  &lt;啥的限定范围的<br>‘not’? term | ‘not’可有可无，但是有的话只能有一个，多个就+或者</em><br>{$channel = HIDDEN;} | 设置当前元素在AST中不可见。应该有待挖掘，可能更多个性化的东西，都可以在这里处理</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/antlr/">antlr</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/26/ember散记/" title="ember散记" itemprop="url">ember散记</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-06-26T01:44:57.000Z" itemprop="datePublished"> 发表于 2016-06-26</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>主要是弄ambari的时候，ambari view使用了emberjs框架，自己按照官网教程走了一遍，此文章只是记录一些散记，不成系统。</p>
<h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><table>
<thead>
<tr>
<th>命令</th>
<th>解释</th>
<th>扩展</th>
</tr>
</thead>
<tbody>
<tr>
<td>ember g route xxx/contact</td>
<td>生成route handler</td>
<td>url里访问的路径xxx/contact会被定位到routes/xxx/contact.js下。生成template文件，route文件，对应的单元测试文件</td>
</tr>
<tr>
<td>ember g component list</td>
<td>生成一个component</td>
<td>位于templates/components文件夹下，可以被其他template以模块的形式引用。对应的js文件在根目录的components下</td>
</tr>
<tr>
<td>ember install ember-cli-tutorial-style</td>
<td>安装插件到当前项目</td>
<td>示例中的这个插件，会自动copy一些css文件到指定目录</td>
</tr>
<tr>
<td>ember g model rental</td>
<td>生成一个ember data model</td>
<td>在models文件夹下生成对应的model文件还有单元测试文件 </td>
</tr>
<tr>
<td>ember g helper rental-property-type</td>
<td>生成一个helper</td>
<td>在helpers文件夹下生成对应的js文件，还有单元测试文件</td>
</tr>
<tr>
<td>ember g controller index</td>
<td>生成一个controller</td>
<td>在controllers文件夹下生成对应js文件，单元测试文件</td>
</tr>
</tbody>
</table>
<h2 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h2><p>route handler中添加model方法，可以在template里直接使用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> Ember.Route.extend(&#123;</div><div class="line">  model() &#123;</div><div class="line">    <span class="keyword">return</span> rentals;            </div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>在template中的使用：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">[[#each model as |rental|]]    </div><div class="line">  <span class="tag">&lt;<span class="name">article</span> <span class="attr">class</span>=<span class="string">"listing"</span>&gt;</span>    </div><div class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>[[rental.title]]<span class="tag">&lt;/<span class="name">h3</span>&gt;</span>  </div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail owner"</span>&gt;</span> </div><div class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>Owner:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.owner]]</div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail type"</span>&gt;</span>  </div><div class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>Type:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.type]]</div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail location"</span>&gt;</span>   </div><div class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>Location:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.city]]</div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail bedrooms"</span>&gt;</span>   </div><div class="line">      <span class="tag">&lt;<span class="name">span</span>&gt;</span>Number of bedrooms:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.bedrooms]]</div><div class="line">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">article</span>&gt;</span></div><div class="line">[[/each]]</div><div class="line">~</div></pre></td></tr></table></figure>
<h2 id="模板"><a href="#模板" class="headerlink" title="模板"></a>模板</h2><p>随着项目的创建，会在templates下自动生成一个application.js文件：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&lt;h2&gt;title or slogin&lt;/h2&gt;</div><div class="line"></div><div class="line">[[outlet]]</div></pre></td></tr></table></figure></p>
<p>其中h2标题部分会在所有的模板中出现，[[outlet]]作为url中指定route handler的占位符。</p>
<h2 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h2><p>ember有自己的插件机制，可以自由发布与引用,个人感觉有点儿类似python module的感觉。</p>
<p><a href="https://emberobserver.com/" target="_blank" rel="external">https://emberobserver.com/</a></p>
<h2 id="Ember-data"><a href="#Ember-data" class="headerlink" title="Ember data"></a>Ember data</h2><p>使用ember g model rental生成模板文件models/rental.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Model <span class="keyword">from</span> <span class="string">'ember-data/model'</span>;</div><div class="line"><span class="keyword">import</span> attr <span class="keyword">from</span> <span class="string">'ember-data/attr'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> Model.extend(&#123;</div><div class="line">  <span class="attr">title</span>: attr(),</div><div class="line">  <span class="attr">owner</span>: attr(),</div><div class="line">  <span class="attr">city</span>: attr(),</div><div class="line">  <span class="attr">type</span>: attr(),</div><div class="line">  <span class="attr">image</span>: attr(),</div><div class="line">  <span class="attr">bedrooms</span>: attr()</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>上面就定义好了这个model的各个属性。下面是使用model了，在某个route handler中定义model函数，下面这个示例会使用GET方法调用/rentals<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Ember <span class="keyword">from</span> <span class="string">'ember'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> Ember.Route.extend(&#123;</div><div class="line">  model() &#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.store.findAll(<span class="string">'rental'</span>);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>详情参考：<a href="https://guides.emberjs.com/v2.6.0/models/" target="_blank" rel="external">https://guides.emberjs.com/v2.6.0/models/</a></p>
<h2 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h2><p>就是component，可以被其他的template直接引用。它包含两部分：template和js。<br>template负责布局，js负责定义一些属性和action。</p>
<p>布局文件:templates/components/rental-listing.hbs<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">article</span> <span class="attr">class</span>=<span class="string">"listing"</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">a</span> [[<span class="attr">action</span> '<span class="attr">toggleImageSize</span>']] <span class="attr">class</span>=<span class="string">"image [[if isWide "</span><span class="attr">wide</span>"]]"&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"[[rental.image]]"</span> <span class="attr">alt</span>=<span class="string">""</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">small</span>&gt;</span>View Larger<span class="tag">&lt;/<span class="name">small</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">a</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">h3</span>&gt;</span>[[rental.title]]<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail owner"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>Owner:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.owner]]</div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail type"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>Type:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.type]]</div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail location"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>Location:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.city]]</div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"detail bedrooms"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">span</span>&gt;</span>Number of bedrooms:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental.bedrooms]]</div><div class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">article</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>交互文件：components/rental-listing.js<br><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Ember <span class="keyword">from</span> <span class="string">'ember'</span>;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> Ember.Component.extend(&#123;</div><div class="line">  <span class="attr">isWide</span>: <span class="literal">false</span>,</div><div class="line">  <span class="attr">actions</span>: &#123;</div><div class="line">    toggleImageSize() &#123;</div><div class="line">      <span class="keyword">this</span>.toggleProperty(<span class="string">'isWide'</span>);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure></p>
<p>可以看到isWide和actions属性与模板文件中的[[action ‘toggleImageSize’]]以及isWide变量对应。</p>
<h2 id="Handlebars-Helper"><a href="#Handlebars-Helper" class="headerlink" title="Handlebars Helper"></a>Handlebars Helper</h2><p>有的时候会在render到template之前对一些属性进行公共的处理啥的，就用到这个handlebar，为属性起装饰作用。<br>helpers/xxx.js文件：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> Ember <span class="keyword">from</span> <span class="string">'ember'</span>;</div><div class="line"></div><div class="line"><span class="keyword">const</span> communityPropertyTypes = [</div><div class="line">  <span class="string">'Condo'</span>,</div><div class="line">  <span class="string">'Townhouse'</span>,</div><div class="line">  <span class="string">'Apartment'</span></div><div class="line">];</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">rentalPropertyType</span>(<span class="params">[type]<span class="regexp">/*, hash*/</span></span>) </span>&#123;</div><div class="line">  <span class="keyword">if</span> (communityPropertyTypes.contains(type)) &#123;</div><div class="line">    <span class="keyword">return</span> <span class="string">'Community'</span>;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="keyword">return</span> <span class="string">'Standalone'</span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">export</span> <span class="keyword">default</span> Ember.Helper.helper(rentalPropertyType);</div></pre></td></tr></table></figure></p>
<p>在template文件中使用上面定义的rentalPropertyType方法。<br><figure class="highlight html"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">span</span>&gt;</span>Type:<span class="tag">&lt;/<span class="name">span</span>&gt;</span> [[rental-property-type rental.type]] - [[rental.type]]</div></pre></td></tr></table></figure></p>
<p>这样在render模板的时候，就会把rental.type传入rentalPropertyType函数，处理后，返回相应的处理值。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/ember/">ember</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/23/python-debug/" title="python debug" itemprop="url">python debug</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-06-23T11:24:52.000Z" itemprop="datePublished"> 发表于 2016-06-23</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>今儿想着快些让hive view的java代码跟远程程序能够一起调试了，想要远程调试就得在远程ambari server启动的地方添加jdwp设置才行。</p>
<p>当我们安装好ambari-server之后，它默认是在/usr/sbin/ambari-server的一个shell文件，start命令导流到/usr/sbin/ambari-server.py脚本中。跟tomcat、jetty啥的不一样，并不提供静态的类似JAVA_OPTS之类的变量。ambari server是作为python脚本的子进程启动的，所以启动的参数都是通过python程序生成后执行的。自己沿着入口找了半天，越找越蒙圈，回头想了一下，还是debug来的更真实。</p>
<p>查下python的debug方式，最快能实施的就是使用<strong>pdb</strong>了。到ambari server的宿主机上开始进行调试。</p>
<h3 id="pdb基础"><a href="#pdb基础" class="headerlink" title="pdb基础"></a>pdb基础</h3><h5 id="设置断点"><a href="#设置断点" class="headerlink" title="设置断点"></a>设置断点</h5><p>在要调试的python文件import pdb，然后在断点代码的上方添加pdb.set_trace()<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> pdb</div><div class="line">....</div><div class="line"></div><div class="line">  options.exit_message = <span class="string">"Ambari Server '%s' completed successfully."</span> % action</div><div class="line">  options.exit_code = <span class="keyword">None</span></div><div class="line"></div><div class="line"></div><div class="line">  pdb.set_trace()</div><div class="line">  <span class="keyword">try</span>:</div><div class="line">    action_obj.execute()</div><div class="line"></div><div class="line">    <span class="keyword">if</span> action_obj.need_restart:</div><div class="line">      pstatus, pid = is_server_runing()</div><div class="line">      <span class="keyword">if</span> pstatus:</div><div class="line">        <span class="keyword">print</span> <span class="string">'NOTE: Restart Ambari Server to apply changes'</span> + \</div><div class="line">              <span class="string">' ("ambari-server restart|stop+start")'</span></div></pre></td></tr></table></figure></p>
<p>到命令行执行此python文件，到pdb.set_trace()的位置就会停下，跳出(pdb) </p>
<h5 id="pdb命令"><a href="#pdb命令" class="headerlink" title="pdb命令"></a>pdb命令</h5><table>
<thead>
<tr>
<th>命令</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>help</td>
<td>显示所有命令</td>
</tr>
<tr>
<td>n</td>
<td>继续执行</td>
</tr>
<tr>
<td>step</td>
<td>进入当前方法的方法块</td>
</tr>
<tr>
<td>c</td>
<td>忽略调试，继续执行</td>
</tr>
<tr>
<td>p</td>
<td>p str 打印某个对象</td>
</tr>
</tbody>
</table>
<p>我就用了以上命令，完成了对于ambari的调试。如果有其他的要求，可以逐个试一下。</p>
<h4 id="ambari调试过程"><a href="#ambari调试过程" class="headerlink" title="ambari调试过程"></a>ambari调试过程</h4><h5 id="设置断点-1"><a href="#设置断点-1" class="headerlink" title="设置断点"></a>设置断点</h5><p> 在ambari-server.py 引入pdb，在main方法上面添加pdb.set_trace()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">...</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">mainBody</span><span class="params">()</span>:</span></div><div class="line">  parser = optparse.OptionParser(usage=<span class="string">"usage: %prog [options] action [stack_id os]"</span>,)</div><div class="line">  init_parser_options(parser)</div><div class="line">  (options, args) = parser.parse_args()</div><div class="line"></div><div class="line">  pdb.set_trace()</div><div class="line"></div><div class="line">  <span class="comment"># check if only silent key set</span></div><div class="line">  default_options = parser.get_default_values()</div><div class="line">  silent_options = default_options</div><div class="line">  silent_options.silent = <span class="keyword">True</span></div><div class="line"></div><div class="line">  <span class="keyword">if</span> options == silent_options:</div><div class="line">    options.only_silent = <span class="keyword">True</span></div><div class="line">  <span class="keyword">else</span>:</div><div class="line">    options.only_silent = <span class="keyword">False</span></div><div class="line"></div><div class="line">  <span class="comment"># set verbose</span></div><div class="line">  set_verbose(options.verbose)</div><div class="line">  <span class="keyword">if</span> options.verbose:</div><div class="line">    main(options, args, parser)</div><div class="line"></div><div class="line">...</div></pre></td></tr></table></figure>
<h5 id="执行命令"><a href="#执行命令" class="headerlink" title="执行命令"></a>执行命令</h5><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div></pre></td><td class="code"><pre><div class="line">[root@data-test01 ~]# ambari-server start</div><div class="line">Using python  /usr/bin/python2</div><div class="line">Starting ambari-server</div><div class="line">&gt; /usr/sbin/ambari-server.py(584)main()</div><div class="line">-&gt; try:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(585)main()</div><div class="line">-&gt; action_obj.execute()</div><div class="line">(Pdb) step</div><div class="line">--Call--</div><div class="line">&gt; /usr/sbin/ambari-server.py(59)execute()</div><div class="line">-&gt; def execute(self):</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(60)execute()</div><div class="line">-&gt; self.fn(*self.args, **self.kwargs)</div><div class="line">(Pdb) p *self.args</div><div class="line">*** SyntaxError: SyntaxError('invalid syntax', ('&lt;string&gt;', 1, 1, '*self.args'))</div><div class="line">(Pdb) p self.args</div><div class="line">(&lt;Values at 0xfbee60: &#123;'only_silent': False, 'jdbc_driver': None, 'verbose': False, 'init_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-CREATE.sql', 'dbms': None, 'silent': False, 'warnings': [], 'exit_code': None, 'cluster_name': None, 'database_username': None, 'drop_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-DROP.sql', 'upgrade_script_file': '/var/lib/ambari-server/resources/upgrade/ddl/Ambari-DDL-Postgres-UPGRADE-1.3.0.sql', 'java_home': None, 'ldap_sync_existing': False, 'force_repo_version': False, 'debug': False, 'ldap_sync_groups': None, 'must_set_database_options': True, 'sqla_server_name': None, 'ldap_sync_users': None, 'database_name': None, 'jdbc_db': None, 'ldap_sync_all': False, 'upgrade_stack_script_file': '/var/lib/ambari-server/resources/upgrade/dml/Ambari-DML-Postgres-UPGRADE_STACK.sql', 'desired_repo_version': None, 'suspend_start': False, 'database_port': None, 'sid_or_sname': 'sname', 'database_password': None, 'exit_message': "Ambari Server 'start' completed successfully.", 'database_host': None, 'postgres_schema': None&#125;&gt;,)</div><div class="line">(Pdb) p self.kwargs</div><div class="line">&#123;&#125;</div><div class="line">(Pdb) step</div><div class="line">--Call--</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(82)thunk()</div><div class="line">-&gt; def thunk(*args, **kwargs):</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(83)thunk()</div><div class="line">-&gt; fn_id_base = func.__module__ + "." + func.__name__</div><div class="line">(Pdb) jn</div><div class="line">*** NameError: name 'jn' is not defined</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(84)thunk()</div><div class="line">-&gt; fn_id = fn_id_base + "." + OSCheck.get_os_family()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(85)thunk()</div><div class="line">-&gt; if fn_id not in self._func_impls:</div><div class="line">(Pdb) p fn_id</div><div class="line">'__main__.start.redhat'</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(86)thunk()</div><div class="line">-&gt; fn_id = fn_id_base + "." + OsFamilyImpl.DEFAULT</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(88)thunk()</div><div class="line">-&gt; fn = self._func_impls[fn_id]</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(89)thunk()</div><div class="line">-&gt; return fn(*args, **kwargs)</div><div class="line">(Pdb) p args</div><div class="line">(&lt;Values at 0xfbee60: &#123;'only_silent': False, 'jdbc_driver': None, 'verbose': False, 'init_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-CREATE.sql', 'dbms': None, 'silent': False, 'warnings': [], 'exit_code': None, 'cluster_name': None, 'database_username': None, 'drop_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-DROP.sql', 'upgrade_script_file': '/var/lib/ambari-server/resources/upgrade/ddl/Ambari-DDL-Postgres-UPGRADE-1.3.0.sql', 'java_home': None, 'ldap_sync_existing': False, 'force_repo_version': False, 'debug': False, 'ldap_sync_groups': None, 'must_set_database_options': True, 'sqla_server_name': None, 'ldap_sync_users': None, 'database_name': None, 'jdbc_db': None, 'ldap_sync_all': False, 'upgrade_stack_script_file': '/var/lib/ambari-server/resources/upgrade/dml/Ambari-DML-Postgres-UPGRADE_STACK.sql', 'desired_repo_version': None, 'suspend_start': False, 'database_port': None, 'sid_or_sname': 'sname', 'database_password': None, 'exit_message': "Ambari Server 'start' completed successfully.", 'database_host': None, 'postgres_schema': None&#125;&gt;,)</div><div class="line">(Pdb) p kwargs</div><div class="line">&#123;&#125;</div><div class="line">(Pdb) step</div><div class="line">--Call--</div><div class="line">&gt; /usr/sbin/ambari-server.py(103)start()</div><div class="line">-&gt; @OsFamilyFuncImpl(OsFamilyImpl.DEFAULT)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(105)start()</div><div class="line">-&gt; status, pid = is_server_runing()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(106)start()</div><div class="line">-&gt; if status:</div><div class="line">(Pdb) p status</div><div class="line">False</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(110)start()</div><div class="line">-&gt; server_process_main(args)</div><div class="line">(Pdb) p args</div><div class="line">&lt;Values at 0xfbee60: &#123;'only_silent': False, 'jdbc_driver': None, 'verbose': False, 'init_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-CREATE.sql', 'dbms': None, 'silent': False, 'warnings': [], 'exit_code': None, 'cluster_name': None, 'database_username': None, 'drop_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-DROP.sql', 'upgrade_script_file': '/var/lib/ambari-server/resources/upgrade/ddl/Ambari-DDL-Postgres-UPGRADE-1.3.0.sql', 'java_home': None, 'ldap_sync_existing': False, 'force_repo_version': False, 'debug': False, 'ldap_sync_groups': None, 'must_set_database_options': True, 'sqla_server_name': None, 'ldap_sync_users': None, 'database_name': None, 'jdbc_db': None, 'ldap_sync_all': False, 'upgrade_stack_script_file': '/var/lib/ambari-server/resources/upgrade/dml/Ambari-DML-Postgres-UPGRADE_STACK.sql', 'desired_repo_version': None, 'suspend_start': False, 'database_port': None, 'sid_or_sname': 'sname', 'database_password': None, 'exit_message': "Ambari Server 'start' completed successfully.", 'database_host': None, 'postgres_schema': None&#125;&gt;</div><div class="line">(Pdb) step</div><div class="line">--Call--</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(204)server_process_main()</div><div class="line">-&gt; def server_process_main(options, scmStatus=None):</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(206)server_process_main()</div><div class="line">-&gt; try:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(207)server_process_main()</div><div class="line">-&gt; set_debug_mode_from_options(options)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(211)server_process_main()</div><div class="line">-&gt; if not check_reverse_lookup():</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(216)server_process_main()</div><div class="line">-&gt; check_database_name_property()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(217)server_process_main()</div><div class="line">-&gt; parse_properties_file(options)</div><div class="line">(Pdb) p options</div><div class="line">&lt;Values at 0xfbee60: &#123;'only_silent': False, 'jdbc_driver': None, 'verbose': False, 'init_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-CREATE.sql', 'dbms': None, 'silent': False, 'warnings': [], 'exit_code': None, 'cluster_name': None, 'database_username': None, 'drop_script_file': '/var/lib/ambari-server/resources/Ambari-DDL-Postgres-EMBEDDED-DROP.sql', 'upgrade_script_file': '/var/lib/ambari-server/resources/upgrade/ddl/Ambari-DDL-Postgres-UPGRADE-1.3.0.sql', 'java_home': None, 'ldap_sync_existing': False, 'force_repo_version': False, 'debug': False, 'ldap_sync_groups': None, 'must_set_database_options': True, 'sqla_server_name': None, 'ldap_sync_users': None, 'database_name': None, 'jdbc_db': None, 'ldap_sync_all': False, 'upgrade_stack_script_file': '/var/lib/ambari-server/resources/upgrade/dml/Ambari-DML-Postgres-UPGRADE_STACK.sql', 'desired_repo_version': None, 'suspend_start': False, 'database_port': None, 'sid_or_sname': 'sname', 'database_password': None, 'exit_message': "Ambari Server 'start' completed successfully.", 'database_host': None, 'postgres_schema': None&#125;&gt;</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(219)server_process_main()</div><div class="line">-&gt; ambari_user = read_ambari_user()</div><div class="line">(Pdb) step</div><div class="line">--Call--</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverConfiguration.py(501)read_ambari_user()</div><div class="line">-&gt; def read_ambari_user():</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverConfiguration.py(505)read_ambari_user()</div><div class="line">-&gt; properties = get_ambari_properties()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverConfiguration.py(506)read_ambari_user()</div><div class="line">-&gt; if properties != -1:</div><div class="line">(Pdb) p properties</div><div class="line">&lt;ambari_server.properties.Properties object at 0xfe4910&gt;</div><div class="line">(Pdb) dir(properties)</div><div class="line">['_Properties__parse', '__class__', '__delattr__', '__dict__', '__doc__', '__format__', '__getattr__', '__getattribute__', '__getitem__', '__hash__', '__init__', '__module__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', '__weakref__', '_keymap', '_origprops', '_props', 'bspacere', 'fileName', 'getPropertyDict', 'get_property', 'load', 'othercharre', 'othercharre2', 'process_pair', 'propertyNames', 'removeOldProp', 'removeProp', 'sort_origprops', 'sort_props', 'store', 'store_ordered', 'unescape']</div><div class="line">(Pdb) type(properties)</div><div class="line">&lt;class 'ambari_server.properties.Properties'&gt;</div><div class="line">(Pdb) p properties fileName</div><div class="line">*** SyntaxError: SyntaxError('unexpected EOF while parsing', ('&lt;string&gt;', 1, 19, 'properties fileName'))</div><div class="line">(Pdb) p properties.fileName()</div><div class="line">*** TypeError: TypeError("'str' object is not callable",)</div><div class="line">(Pdb) p properties.fileName</div><div class="line">'/etc/ambari-server/conf/ambari.properties'</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverConfiguration.py(507)read_ambari_user()</div><div class="line">-&gt; user = properties[NR_USER_PROPERTY]</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverConfiguration.py(508)read_ambari_user()</div><div class="line">-&gt; if user:</div><div class="line">(Pdb) p user</div><div class="line">'root'</div><div class="line">(Pdb) p</div><div class="line">*** SyntaxError: SyntaxError('unexpected EOF while parsing', ('&lt;string&gt;', 0, 0, ''))</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverConfiguration.py(509)read_ambari_user()</div><div class="line">-&gt; return user</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverConfiguration.py(509)read_ambari_user()-&gt;'root'</div><div class="line">-&gt; return user</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(220)server_process_main()</div><div class="line">-&gt; current_user = ensure_can_start_under_current_user(ambari_user)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(222)server_process_main()</div><div class="line">-&gt; print_info_msg("Ambari Server is not running...")</div><div class="line">(Pdb) p current_user</div><div class="line">'root'</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(224)server_process_main()</div><div class="line">-&gt; jdk_path = find_jdk()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(225)server_process_main()</div><div class="line">-&gt; if jdk_path is None:</div><div class="line">(Pdb) p jdk_path</div><div class="line">'/server/java/jdk1.8.0_60'</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(231)server_process_main()</div><div class="line">-&gt; properties = get_ambari_properties()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(234)server_process_main()</div><div class="line">-&gt; if is_root():</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(235)server_process_main()</div><div class="line">-&gt; print configDefaults.MESSAGE_SERVER_RUNNING_AS_ROOT</div><div class="line">(Pdb) print configDefaults.MESSAGE_SERVER_RUNNING_AS_ROOT</div><div class="line">Ambari Server running with administrator privileges.</div><div class="line">(Pdb) n</div><div class="line">Ambari Server running with administrator privileges.</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(237)server_process_main()</div><div class="line">-&gt; ensure_jdbc_driver_is_installed(options, properties)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(239)server_process_main()</div><div class="line">-&gt; ensure_dbms_is_running(options, properties, scmStatus)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(241)server_process_main()</div><div class="line">-&gt; if scmStatus is not None:</div><div class="line">(Pdb) p scmStatus</div><div class="line">None</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(244)server_process_main()</div><div class="line">-&gt; refresh_stack_hash(properties)</div><div class="line">(Pdb) p properties</div><div class="line">&lt;ambari_server.properties.Properties object at 0xfe4e50&gt;</div><div class="line">(Pdb) step</div><div class="line">--Call--</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(85)refresh_stack_hash()</div><div class="line">-&gt; def refresh_stack_hash(properties):</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(86)refresh_stack_hash()</div><div class="line">-&gt; resources_location = get_resources_location(properties)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(87)refresh_stack_hash()</div><div class="line">-&gt; stacks_location = get_stack_location(properties)</div><div class="line">(Pdb) p resources_location</div><div class="line">'/var/lib/ambari-server/resources'</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(88)refresh_stack_hash()</div><div class="line">-&gt; resource_files_keeper = ResourceFilesKeeper(resources_location, stacks_location)</div><div class="line">(Pdb) p stacks_location</div><div class="line">'/var/lib/ambari-server/resources/stacks'</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(90)refresh_stack_hash()</div><div class="line">-&gt; try:</div><div class="line">(Pdb) p resource_files_keeper</div><div class="line">&lt;ambari_server.resourceFilesKeeper.ResourceFilesKeeper instance at 0x103c050&gt;</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(91)refresh_stack_hash()</div><div class="line">-&gt; print "Organizing resource files at &#123;0&#125;...".format(resources_location,</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(92)refresh_stack_hash()</div><div class="line">-&gt; verbose=get_verbose())</div><div class="line">(Pdb) n</div><div class="line">Organizing resource files at /var/lib/ambari-server/resources...</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(93)refresh_stack_hash()</div><div class="line">-&gt; resource_files_keeper.perform_housekeeping()</div><div class="line">(Pdb) p verbose</div><div class="line">*** NameError: NameError("name 'verbose' is not defined",)</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_server/serverUtils.py(93)refresh_stack_hash()-&gt;None</div><div class="line">-&gt; resource_files_keeper.perform_housekeeping()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(246)server_process_main()</div><div class="line">-&gt; if scmStatus is not None:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(249)server_process_main()</div><div class="line">-&gt; ensure_server_security_is_configured()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(251)server_process_main()</div><div class="line">-&gt; if scmStatus is not None:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(254)server_process_main()</div><div class="line">-&gt; java_exe = get_java_exe_path()</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(256)server_process_main()</div><div class="line">-&gt; serverClassPath = ServerClassPath(properties, options)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(258)server_process_main()</div><div class="line">-&gt; debug_mode = get_debug_mode()</div><div class="line">(Pdb) p serverClassPath</div><div class="line">&lt;ambari_server.serverClassPath.ServerClassPath instance at 0x103cfc8&gt;</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(259)server_process_main()</div><div class="line">-&gt; debug_start = (debug_mode &amp; 1) or SERVER_START_DEBUG</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(260)server_process_main()</div><div class="line">-&gt; suspend_start = (debug_mode &amp; 2) or SUSPEND_START_MODE</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(261)server_process_main()</div><div class="line">-&gt; suspend_mode = 'y' if suspend_start else 'n'</div><div class="line">(Pdb) p debug_start</div><div class="line">False</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(263)server_process_main()</div><div class="line">-&gt; param_list = generate_child_process_param_list(ambari_user, java_exe,</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(264)server_process_main()</div><div class="line">-&gt; serverClassPath.get_full_ambari_classpath_escaped_for_shell(), debug_start,</div><div class="line">(Pdb) p param_list</div><div class="line">*** NameError: NameError("name 'param_list' is not defined",)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(265)server_process_main()</div><div class="line">-&gt; suspend_mode)</div><div class="line">(Pdb) p param_list</div><div class="line">*** NameError: NameError("name 'param_list' is not defined",)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(266)server_process_main()</div><div class="line">-&gt; environ = generate_env(options, ambari_user, current_user)</div><div class="line">(Pdb) p param_list</div><div class="line">['/bin/sh', '-c', "ulimit -n 10000 ; /server/java/jdk1.8.0_60/bin/java -server -XX:NewRatio=3 -XX:+UseConcMarkSweepGC -XX:-UseGCOverheadLimit -XX:CMSInitiatingOccupancyFraction=60 -Dsun.zip.disableMemoryMapping=true   -Xms512m -Xmx2048m -Djava.security.auth.login.config=/etc/ambari-server/conf/krb5JAASLogin.conf -Djava.security.krb5.conf=/etc/krb5.conf -Djavax.security.auth.useSubjectCredsOnly=false -cp '/etc/ambari-server/conf:/usr/lib/ambari-server/*:/usr/share/java/mysql-connector-java.jar' org.apache.ambari.server.controller.AmbariServer &gt; /var/log/ambari-server/ambari-server.out 2&gt;&amp;1 || echo $? &gt; /var/run/ambari-server/ambari-server.exitcode &amp;"]</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(268)server_process_main()</div><div class="line">-&gt; if not os.path.exists(configDefaults.PID_DIR):</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(271)server_process_main()</div><div class="line">-&gt; print_info_msg("Running server: " + str(param_list))</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(272)server_process_main()</div><div class="line">-&gt; procJava = subprocess.Popen(param_list, env=environ)</div><div class="line">(Pdb) p str(param_list)</div><div class="line">'[\'/bin/sh\', \'-c\', "ulimit -n 10000 ; /server/java/jdk1.8.0_60/bin/java -server -XX:NewRatio=3 -XX:+UseConcMarkSweepGC -XX:-UseGCOverheadLimit -XX:CMSInitiatingOccupancyFraction=60 -Dsun.zip.disableMemoryMapping=true   -Xms512m -Xmx2048m -Djava.security.auth.login.config=/etc/ambari-server/conf/krb5JAASLogin.conf -Djava.security.krb5.conf=/etc/krb5.conf -Djavax.security.auth.useSubjectCredsOnly=false -cp \'/etc/ambari-server/conf:/usr/lib/ambari-server/*:/usr/share/java/mysql-connector-java.jar\' org.apache.ambari.server.controller.AmbariServer &gt; /var/log/ambari-server/ambari-server.out 2&gt;&amp;1 || echo $? &gt; /var/run/ambari-server/ambari-server.exitcode &amp;"]'</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(274)server_process_main()</div><div class="line">-&gt; pidJava = procJava.pid</div><div class="line">(Pdb) p procJava.pid</div><div class="line">2216</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(275)server_process_main()</div><div class="line">-&gt; if pidJava &lt;= 0:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(288)server_process_main()</div><div class="line">-&gt; try:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(289)server_process_main()</div><div class="line">-&gt; os.setpgid(pidJava, 0)</div><div class="line">(Pdb) n</div><div class="line">OSError: (13, 'Permission denied')</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(289)server_process_main()</div><div class="line">-&gt; os.setpgid(pidJava, 0)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(290)server_process_main()</div><div class="line">-&gt; except OSError, e:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(291)server_process_main()</div><div class="line">-&gt; print_warning_msg('setpgid(&#123;0&#125;, 0) failed - &#123;1&#125;'.format(pidJava, str(e)))</div><div class="line">(Pdb) n</div><div class="line">WARNING: setpgid(2216, 0) failed - [Errno 13] Permission denied</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(292)server_process_main()</div><div class="line">-&gt; pass</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(293)server_process_main()</div><div class="line">-&gt; pidfile = os.path.join(configDefaults.PID_DIR, PID_NAME)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(294)server_process_main()</div><div class="line">-&gt; save_pid(pidJava, pidfile)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(295)server_process_main()</div><div class="line">-&gt; print "Server PID at: "+pidfile</div><div class="line">(Pdb) n</div><div class="line">Server PID at: /var/run/ambari-server/ambari-server.pid</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(296)server_process_main()</div><div class="line">-&gt; print "Server out at: "+configDefaults.SERVER_OUT_FILE</div><div class="line">(Pdb) n</div><div class="line">Server out at: /var/log/ambari-server/ambari-server.out</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(297)server_process_main()</div><div class="line">-&gt; print "Server log at: "+configDefaults.SERVER_LOG_FILE</div><div class="line">(Pdb) n</div><div class="line">Server log at: /var/log/ambari-server/ambari-server.log</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(299)server_process_main()</div><div class="line">-&gt; wait_for_server_start(pidfile, scmStatus)</div><div class="line">(Pdb) n</div><div class="line">Waiting for server start....................</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(301)server_process_main()</div><div class="line">-&gt; if scmStatus is not None:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(304)server_process_main()</div><div class="line">-&gt; return procJava</div><div class="line">(Pdb) p procJava</div><div class="line">&lt;subprocess.Popen object at 0x1038690&gt;</div><div class="line">(Pdb) dir(procJava)</div><div class="line">['__class__', '__del__', '__delattr__', '__dict__', '__doc__', '__format__', '__getattribute__', '__hash__', '__init__', '__module__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__str__', '__subclasshook__', '__weakref__', '_check_timeout', '_child_created', '_close_fds', '_communicate', '_communicate_with_poll', '_communicate_with_select', '_communication_started', '_execute_child', '_get_handles', '_handle_exitstatus', '_input', '_internal_poll', '_remaining_time', '_set_cloexec_flag', '_translate_newlines', 'communicate', 'kill', 'pid', 'poll', 'returncode', 'send_signal', 'stderr', 'stdin', 'stdout', 'terminate', 'universal_newlines', 'wait']</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/sbin/ambari_server_main.py(304)server_process_main()-&gt;&lt;subproc...x1038690&gt;</div><div class="line">-&gt; return procJava</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/sbin/ambari-server.py(110)start()-&gt;None</div><div class="line">-&gt; server_process_main(args)</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/lib/python2.6/site-packages/ambari_commons/os_family_impl.py(89)thunk()-&gt;None</div><div class="line">-&gt; return fn(*args, **kwargs)</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/sbin/ambari-server.py(60)execute()-&gt;None</div><div class="line">-&gt; self.fn(*self.args, **self.kwargs)</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(587)main()</div><div class="line">-&gt; if action_obj.need_restart:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(593)main()</div><div class="line">-&gt; if options.warnings:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(608)main()</div><div class="line">-&gt; if options.exit_message is not None:</div><div class="line">(Pdb) n</div><div class="line">&gt; /usr/sbin/ambari-server.py(609)main()</div><div class="line">-&gt; print options.exit_message</div><div class="line">(Pdb) n</div><div class="line">Ambari Server 'start' completed successfully.</div><div class="line">&gt; /usr/sbin/ambari-server.py(611)main()</div><div class="line">-&gt; if options.exit_code is not None:  # not all actions may return a system exit code</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/sbin/ambari-server.py(611)main()-&gt;None</div><div class="line">-&gt; if options.exit_code is not None:  # not all actions may return a system exit code</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/sbin/ambari-server.py(635)mainBody()-&gt;None</div><div class="line">-&gt; main(options, args, parser)</div><div class="line">(Pdb) n</div><div class="line">--Return--</div><div class="line">&gt; /usr/sbin/ambari-server.py(644)&lt;module&gt;()-&gt;None</div><div class="line">-&gt; mainBody()</div><div class="line">(Pdb) n</div><div class="line">[root@data-test01 ~]# which ambari-server</div><div class="line">/usr/sbin/ambari-server</div><div class="line">[root@data-test01 ~]# vim /usr/sbin/ambari-server.py </div><div class="line">[root@data-test01 ~]#</div></pre></td></tr></table></figure>
<p>从以上debug堆栈中我们可以看到ambari-server启动过程中python脚本的所有准备工作。其中java进程的参数主要在ambari_server_main.py的server_process_main()的param_list中。</p>
<p>那么param_list来源在哪儿呢？ 是在server_process_main的子方法generate_child_process_param_list()中的command_base变量，SERVER_START_CMD_DEBUG或者SERVER_START_CMD的形式如下。</p>
<blockquote>
<p>{0} -server -XX:NewRatio=3 -XX:+UseConcMarkSweepGC -XX:-UseGCOverheadLimit -XX:CMSInitiatingOccupancyFraction=60 -Dsun.zip.disableMemoryMapping=true {1} {2} -cp {3} org.apache.ambari.server.controller.AmbariServer &gt; {4} 2&gt;&amp;1 || echo $? &gt; {5} &amp; </p>
</blockquote>
<p>可以看到留下了很多占位符。还是看一下generate_child_process_param_list的code吧<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@FamilyFuncImpl(OsFamilyImpl.DEFAULT)                                          </span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">generate_child_process_param_list</span><span class="params">(ambari_user, java_exe, class_path,         </span></span></div><div class="line">                                      debug_start, suspend_mode):                </div><div class="line">  <span class="keyword">from</span> ambari_commons.os_linux <span class="keyword">import</span> ULIMIT_CMD                                 </div><div class="line">                                                                                 </div><div class="line">  properties = get_ambari_properties()                                           </div><div class="line">                                                                                 </div><div class="line">  command_base = SERVER_START_CMD_DEBUG <span class="keyword">if</span> debug_start <span class="keyword">else</span> SERVER_START_CMD     </div><div class="line">                                                                                 </div><div class="line">  ulimit_cmd = <span class="string">"%s %s"</span> % (ULIMIT_CMD, str(get_ulimit_open_files(properties)))    </div><div class="line">  command = command_base.format(java_exe,                                        </div><div class="line">          ambari_provider_module_option,                                         </div><div class="line">          jvm_args,                                                              </div><div class="line">          class_path,                                                            </div><div class="line">          configDefaults.SERVER_OUT_FILE,                                        </div><div class="line">          os.path.join(configDefaults.PID_DIR, EXITCODE_NAME),                   </div><div class="line">          suspend_mode)                                                          </div><div class="line">                                                                                 </div><div class="line">  <span class="comment"># required to start properly server instance                                   </span></div><div class="line">  os.chdir(configDefaults.ROOT_FS_PATH)                                          </div><div class="line">                                                                                 </div><div class="line">  <span class="comment">#For properly daemonization server should be started using shell as parent     </span></div><div class="line">  param_list = [locate_file(<span class="string">'sh'</span>, <span class="string">'/bin'</span>), <span class="string">"-c"</span>]                                 </div><div class="line">  <span class="keyword">if</span> is_root() <span class="keyword">and</span> ambari_user != <span class="string">"root"</span>:                                        </div><div class="line">    <span class="comment"># To inherit exported environment variables (especially AMBARI_PASSPHRASE),  </span></div><div class="line">    <span class="comment"># from subprocess, we have to skip --login option of su command. That's why  </span></div><div class="line">    <span class="comment"># we change dir to / (otherwise subprocess can face with 'permission denied' </span></div><div class="line">    <span class="comment"># errors while trying to list current directory                              </span></div><div class="line">    cmd = <span class="string">"&#123;ulimit_cmd&#125; ; &#123;su&#125; &#123;ambari_user&#125; -s &#123;sh_shell&#125; -c '&#123;command&#125;'"</span>.format(ulimit_cmd=ulimit_cmd, </div><div class="line">                                                                                su=locate_file(<span class="string">'su'</span>, <span class="string">'/bin'</span>), ambari_user=ambari_user,</div><div class="line">                                                                                sh_shell=locate_file(<span class="string">'sh'</span>, <span class="string">'/bin'</span>), command=command)</div><div class="line">  <span class="keyword">else</span>:                                                                          </div><div class="line">    cmd = <span class="string">"&#123;ulimit_cmd&#125; ; &#123;command&#125;"</span>.format(ulimit_cmd=ulimit_cmd, command=command)</div><div class="line">                                                                                 </div><div class="line">  param_list.append(cmd)                                                         </div><div class="line">  <span class="keyword">return</span> param_list</div></pre></td></tr></table></figure></p>
<p>这个方法把java进程的相关的东西全部拼进cmd，之后放进param_list，其中放了一个jvm_args的参数就是jvm参数了。在当前python文件中追溯此数据的来源：jvm_args = os.getenv(‘AMBARI_JVM_ARGS’, ‘-Xms512m -Xmx2048m’) ，所以它是一个环境变量。依赖eclipse的索引，搜一下哪个脚本里设置了这个环境变量：ambari-env.sh。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://www.ibm.com/developerworks/cn/linux/l-cn-pythondebugger/" target="_blank" rel="external">http://www.ibm.com/developerworks/cn/linux/l-cn-pythondebugger/</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/python/">python</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/20/ambari-web解读（一）-请求流程/" title="ambari-web解读（一）-请求流程" itemprop="url">ambari-web解读（一）-请求流程</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-06-20T07:26:42.000Z" itemprop="datePublished"> 发表于 2016-06-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>最近为公司选型了大数据维护工具ambari，官网:ambari.apache.org。主要是为了运维方便一些。<br>另外对于数据分析人员开放了一个hive view页面，提供提数支持。但是对于原始的hive view，我们有些不满意的地方：</p>
<ol>
<li>table的comment没有展示完全</li>
<li>后台一直在每15秒钟请求一次后台hiveserver。虽然这并不会对和iveserver造成很大压力，但是感觉不友好，产生很多垃圾log。</li>
</ol>
<p>经过差不多一周左右断断续续地探查与学习，基本弄清楚了ambari-web的请求处理脉路。可能对nodejs大神来说这不算啥，但是个人感觉稍微有点儿吃力。学习了一下nodejs的新的工具ember.js。</p>
<h3 id="1"><a href="#1" class="headerlink" title="1."></a>1.</h3><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><table>
<thead>
<tr>
<th>链接</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="https://github.com/emberjs/starter-kit/" target="_blank" rel="external">https://github.com/emberjs/starter-kit/</a></td>
<td>学习ember.js的基础项目</td>
</tr>
<tr>
<td><a href="http://www.html-js.com/article/1685" target="_blank" rel="external">http://www.html-js.com/article/1685</a></td>
<td>Ember.js Application Development How-to的中文翻译</td>
</tr>
<tr>
<td><a href="http://www.ruanyifeng.com/blog/2011/08/a_detailed_explanation_of_jquery_deferred_object.html" target="_blank" rel="external">http://www.ruanyifeng.com/blog/2011/08/a_detailed_explanation_of_jquery_deferred_object.html</a></td>
<td>对于jquery回调工具deferred的解释</td>
</tr>
</tbody>
</table>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/源码/">源码</a><a href="/tags/ambari/">ambari</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/20/ambari-view中文翻译/" title="ambari-views中文翻译" itemprop="url">ambari-views中文翻译</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-06-20T07:26:42.000Z" itemprop="datePublished"> 发表于 2016-06-20</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="简述"><a href="#简述" class="headerlink" title="简述"></a>简述</h2><p>ambari views可以在ambari-web中提供插件定制化的可视化、管理、监控等特性。</p>
<p>当用户添加了一个第三方的插件到ambari的时候，我们可以添加一个view来支持这个插件的UI，也就是说可以发布一个应用到ambari container里来。</p>
<p>每个view实例使用name和version来在ambari container里唯一标识自己。</p>
<p>Views in Ambari 是顶级的resource，并不直接跟cluster实例产生直接关联。</p>
<h2 id="例子"><a href="#例子" class="headerlink" title="例子"></a>例子</h2><p>官网的例子在ambari-views/examples.</p>
<h2 id="基础"><a href="#基础" class="headerlink" title="基础"></a>基础</h2><h3 id="View-Instances"><a href="#View-Instances" class="headerlink" title="View Instances"></a>View Instances</h3><p>一个view可以有多个实例，每个实例可能有各自不同的属性。</p>
<h3 id="View-Context"><a href="#View-Context" class="headerlink" title="View Context"></a>View Context</h3><p>view context让view componenets访问ambari container提供的运行时context。这个context会一直伴随这view实例，从出生到死亡。</p>
<p>一个view context可能会被container注入到多个不同的view componenet里去，比如resources, resource provider, servlets等。</p>
<p>context接口提供给view instance以下信息:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the current user name.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the current user name</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getUsername</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Determine whether or not the access specified by the given permission name</div><div class="line"> * is permitted for the given user.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> userName        the user name</div><div class="line"> * <span class="doctag">@param</span> permissionName  the permission name</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> SecurityException if the access specified by the given permission name</div><div class="line"> *         is not permitted</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">hasPermission</span><span class="params">(String userName, String permissionName)</span> <span class="keyword">throws</span> SecurityException</span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the view name.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view name</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getViewName</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the view definition associated with this context.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view definition</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> ViewDefinition <span class="title">getViewDefinition</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the view instance name.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view instance name; null if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getInstanceName</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the view instance definition associated with this context.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view instance definition; null if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> ViewInstanceDefinition <span class="title">getViewInstanceDefinition</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the property values specified to create the view instance.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view instance property values; null if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">getProperties</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Save an instance data value for the given key.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key    the key</div><div class="line"> * <span class="doctag">@param</span> value  the value</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> IllegalStateException if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putInstanceData</span><span class="params">(String key, String value)</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the instance data value for the given key.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key  the key</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the instance data value; null if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getInstanceData</span><span class="params">(String key)</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the instance data values.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view instance property values; null if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">getInstanceData</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Remove the instance data value for the given key.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key  the key</div><div class="line"> *</div><div class="line"> * <span class="doctag">@throws</span> IllegalStateException if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">removeInstanceData</span><span class="params">(String key)</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get a property for the given key from the ambari configuration.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key  the property key</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the property value; null indicates that the configuration contains no mapping for the key</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getAmbariProperty</span><span class="params">(String key)</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the view resource provider for the given resource type.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> type  the resource type</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the resource provider; null if no instance is associated</div><div class="line"> */</div><div class="line"><span class="keyword">public</span> ResourceProvider&lt;?&gt; getResourceProvider(String type);</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get a URL stream provider.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> a stream provider</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> URLStreamProvider <span class="title">getURLStreamProvider</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get a data store for view persistence entities.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> a data store; null if no instance is associated</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> DataStore <span class="title">getDataStore</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get all of the available view definitions.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view definitions</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;ViewDefinition&gt; <span class="title">getViewDefinitions</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get all of the available view instance definitions.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view instance definitions</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> Collection&lt;ViewInstanceDefinition&gt; <span class="title">getViewInstanceDefinitions</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get a view controller associated with this context.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view controller</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> ViewController <span class="title">getController</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the HTTP Impersonator.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the HTTP Impersonator, which internally uses the App Cookie Manager</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> HttpImpersonator <span class="title">getHttpImpersonator</span><span class="params">()</span></span>;</div><div class="line">    </div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the default settings for the Impersonator.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the Impersonator settings.</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> ImpersonatorSetting <span class="title">getImpersonatorSetting</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure></p>
<h3 id="UI-Components"><a href="#UI-Components" class="headerlink" title="UI Components"></a>UI Components</h3><p>view包里可能包含一些web应用的组件，类似html或者javascript啥的。</p>
<h5 id="WEB-INF-web-xml"><a href="#WEB-INF-web-xml" class="headerlink" title="WEB-INF/web.xml"></a>WEB-INF/web.xml</h5><p>web.xml 是把view发布为一个web app的主要文件。  </p>
<p>例如：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>HelloServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>org.apache.ambari.view.hello.HelloServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>HelloServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/ui<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></div></pre></td></tr></table></figure>
<h5 id="Servlets"><a href="#Servlets" class="headerlink" title="Servlets"></a>Servlets</h5><p>Servlets contained in a view archive will be deployed as part of the view and mapped as described in the web.xml.</p>
<p>在servlet的init方法中，可以view context当做一个servlet context使用。</p>
<p>例如:<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">private</span> ViewContext viewContext;</div><div class="line"></div><div class="line"><span class="meta">@Override</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ServletConfig config)</span> <span class="keyword">throws</span> ServletException </span>&#123;</div><div class="line">  <span class="keyword">super</span>.init(config);</div><div class="line"></div><div class="line">  ServletContext context = config.getServletContext();</div><div class="line">  viewContext = (ViewContext) context.getAttribute(ViewContext.CONTEXT_ATTRIBUTE);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>servlet可以使用view conetxt获取ambari container提供的一个信息。例如，在doGet()方法中，我们就可以使用view context instance访问当前的用户和view instance的属性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doGet</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">  response.setContentType(<span class="string">"text/html"</span>);</div><div class="line">  response.setStatus(HttpServletResponse.SC_OK);</div><div class="line"></div><div class="line">  PrintWriter writer = response.getWriter();</div><div class="line"></div><div class="line">  Map&lt;String, String&gt; properties = viewContext.getProperties();</div><div class="line"></div><div class="line">  String name = properties.get(<span class="string">"name"</span>);</div><div class="line">  <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</div><div class="line">    name = viewContext.getUsername();</div><div class="line">  &#125;</div><div class="line">  writer.println(<span class="string">"&lt;h1&gt;Hello "</span> + name + <span class="string">"!&lt;/h1&gt;"</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Resources"><a href="#Resources" class="headerlink" title="Resources"></a>Resources</h3><p>Resources一般不会暴露出来。resource都定义在view.xml里面。每个resource都需要指定名称和service class.</p>
<p>每个resource endpoint应该也可以被ambari api访问. <a href="#api">API</a>.</p>
<h5 id="Service-Class"><a href="#Service-Class" class="headerlink" title="Service Class"></a>Service Class</h5><p>service类使用JAX-RS注解来定义resource的endpoint。注意需要注入ViewContext.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Inject</span></div><div class="line">ViewContext context;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@see</span> org.apache.ambari.view.filebrowser.DownloadService</div><div class="line"> * <span class="doctag">@return</span> service</div><div class="line"> */</div><div class="line"><span class="meta">@Path</span>(<span class="string">"/download"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> DownloadService <span class="title">download</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> DownloadService(context);</div><div class="line">&#125;  </div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * <span class="doctag">@see</span> org.apache.ambari.view.filebrowser.FileOperationService</div><div class="line"> * <span class="doctag">@return</span> service</div><div class="line"> */</div><div class="line"><span class="meta">@Path</span>(<span class="string">"/fileops"</span>)</div><div class="line"><span class="function"><span class="keyword">public</span> FileOperationService <span class="title">fileOps</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="keyword">return</span> <span class="keyword">new</span> FileOperationService(context);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="Managed-Resources"><a href="#Managed-Resources" class="headerlink" title="Managed Resources"></a>Managed Resources</h4><p>managed resource是由ambari api框架管理的resource。除了name和service class之外，managed resource定义还需要plural name，resource class和provider class。 See <a href="#viewxml">view.xml</a>.</p>
<p>使用managed resource的好处是任何通过rest api访问的查询都可以使用ambari api框架的一些既有的特性，包括partial response, query predicates, pagination, sub-resource queries等。See <a href="#API">API</a>.</p>
<h5 id="Service-Class-1"><a href="#Service-Class-1" class="headerlink" title="Service Class"></a>Service Class</h5><p>service使用JAX-RS注解定义获取resource的action。</p>
<p>下面的例子展示了service class怎样将request代理给api框架处理。注意要注入ViewResourceHandler，我们使用它在api框架中传递control。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Inject</span></div><div class="line">ViewResourceHandler resourceHandler;</div><div class="line"></div><div class="line">…</div><div class="line"><span class="meta">@GET</span></div><div class="line"><span class="meta">@Path</span>(<span class="string">"&#123;scriptId&#125;"</span>)</div><div class="line"><span class="meta">@Produces</span>(MediaType.APPLICATION_JSON)</div><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">getScript</span><span class="params">(@Context HttpHeaders headers, @Context UriInfo ui,</span></span></div><div class="line">                          @PathParam(<span class="string">"scriptId"</span>) String scriptId) &#123;</div><div class="line">  <span class="keyword">return</span> resourceHandler.handleRequest(headers, ui, scriptId);</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="Resource-Class"><a href="#Resource-Class" class="headerlink" title="Resource Class"></a>Resource Class</h5><p>resource class是一个包含属性和resource的JavaBean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PigScript</span> </span>&#123;</div><div class="line">  <span class="keyword">private</span> String id;</div><div class="line">  <span class="keyword">private</span> String title;</div><div class="line">  <span class="keyword">private</span> String pigScript;</div><div class="line">  <span class="keyword">private</span> String pythonScript;</div><div class="line">  <span class="keyword">private</span> String templetonArguments;</div><div class="line">  <span class="keyword">private</span> Date dateCreated;</div><div class="line">  <span class="keyword">private</span> String owner;</div><div class="line">  … </div><div class="line">  <span class="function"><span class="keyword">public</span> String <span class="title">getId</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> id;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(String id)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.id = id;</div><div class="line">  &#125;</div><div class="line">  …  </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="Resource-Provider-Class"><a href="#Resource-Provider-Class" class="headerlink" title="Resource Provider Class"></a>Resource Provider Class</h5><p>Resource provider class实现ResourceProvider接口. 给ambari api框架提供访问resource的方式。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScriptResourceProvider</span> <span class="keyword">implements</span> <span class="title">ResourceProvider</span>&lt;<span class="title">PigScript</span>&gt; </span>&#123;</div><div class="line">  <span class="meta">@Inject</span></div><div class="line">  ViewContext viewContext;</div><div class="line"></div><div class="line"></div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> FileResource <span class="title">getResource</span><span class="params">(String resourceId, Set&lt;String&gt; propertyIds)</span> <span class="keyword">throws</span></span></div><div class="line">      SystemException, NoSuchResourceException, UnsupportedPropertyException &#123;</div><div class="line"></div><div class="line">    Map&lt;String, String&gt; properties = viewContext.getProperties();</div><div class="line"></div><div class="line">    String userScriptsPath = properties.get(<span class="string">"dataworker.userScriptsPath"</span>);</div><div class="line"></div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">return</span> getResource(resourceId, userScriptsPath, propertyIds);</div><div class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> SystemException(<span class="string">"Can't get resource "</span> + resourceId + <span class="string">"."</span>, e);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">  ... </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="权限"><a href="#权限" class="headerlink" title="权限"></a>权限</h3><p>administrator可以在任何view实例上设置VIEW.USE权限。  See <a href="#api">API</a>.</p>
<h3 id="定制权限"><a href="#定制权限" class="headerlink" title="定制权限"></a>定制权限</h3><p>编辑 view.xml<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">  </div><div class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>RESTRICTED<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">label</span>&gt;</span>The Restricted View<span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>restricted<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">service-class</span>&gt;</span>org.apache.ambari.view.restricted.RestrictedResource<span class="tag">&lt;/<span class="name">service-class</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>unrestricted<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">service-class</span>&gt;</span>org.apache.ambari.view.restricted.UnrestrictedResource<span class="tag">&lt;/<span class="name">service-class</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">permission</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>RESTRICTED<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">description</span>&gt;</span></div><div class="line">      Access permission for a restricted view resource.</div><div class="line">    <span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">permission</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">instance</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>INSTANCE_1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;/<span class="name">instance</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这个配置文件定义了一个叫做RESTRICTED的view，它有一个实例. 还定义了一个叫做RESTRICTED的权限，两个分别叫做 ‘unrestricted’和 ‘restricted’的resource.<br>administrator可以将RESTRICTED权限分配给任意的RESTRICTED view的实例。</p>
<p>view的实现代码使用了view context来验证我们定义的权限。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Inject</span></div><div class="line">ViewContext context;</div><div class="line"></div><div class="line"><span class="meta">@GET</span></div><div class="line"><span class="meta">@Produces</span>(&#123;<span class="string">"text/html"</span>&#125;)</div><div class="line"><span class="function"><span class="keyword">public</span> Response <span class="title">getRestricted</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>&#123;</div><div class="line">    </div><div class="line">  String userName = context.getUsername();</div><div class="line">    </div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line">    context.hasPermission(userName, <span class="string">"RESTRICTED"</span>);</div><div class="line">  &#125; <span class="keyword">catch</span> (org.apache.ambari.view.SecurityException e) &#123;</div><div class="line">    <span class="keyword">return</span> Response.status(<span class="number">401</span>).build();</div><div class="line">  &#125;</div><div class="line">    </div><div class="line">  <span class="keyword">return</span> Response.ok(<span class="string">"&lt;b&gt;You have accessed a restricted resource.&lt;/b&gt;"</span>).type(<span class="string">"text/html"</span>).build();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Impersonation"><a href="#Impersonation" class="headerlink" title="Impersonation"></a>Impersonation</h3><p>Views can utilize the viewContext to facilitate calls that require impersonating a user. For example, a service may expose an endpoint that accepts parameters like “doAs=johndoe” to perform some action on behalf of that user.<br>The HttpImpersonator Interface provides a contract for how to perform an HTTP GET request on a URL that supports some type of “doAs” parameter, and the username.<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">HttpImpersonator impersonator = viewContext.getHttpImpersonator();</div><div class="line">ImpersonatorSetting impersonatorSetting = viewContext.getImpersonatorSetting();</div><div class="line">String result = impersonator.requestURL(urlToRead, <span class="string">"GET"</span>, impersonatorSetting);</div></pre></td></tr></table></figure></p>
<p>The ImpersonatorSetting class contains the variables that are added to the URL params. Its default constructor sets “doAs” as the default query parameter name, and the currently logged on user as its value; both of these can be changed with the overloaded constructors.</p>
<h3 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h3><p>应用的数据并不像view实例的属性一样，他们或许包含任意字符串，view需要把这些数据持久化，而且还提供更新以及查询。</p>
<p>view context包含从应用数据地图里put或者set数据的方法。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"> * Save an instance data value for the given key.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key    the key</div><div class="line"> * <span class="doctag">@param</span> value  the value</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putInstanceData</span><span class="params">(String key, String value)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the instance data value for the given key.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key  the key</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the instance data value</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getInstanceData</span><span class="params">(String key)</span></span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Get the instance data values.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@return</span> the view instance property values</div><div class="line"> */</div><div class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">getInstanceData</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"> * Remove the instance data value for the given key.</div><div class="line"> *</div><div class="line"> * <span class="doctag">@param</span> key  the key</div><div class="line"> */</div></pre></td></tr></table></figure></p>
<h5 id="DataStore"><a href="#DataStore" class="headerlink" title="DataStore"></a>DataStore</h5><p>data store 允许view instance存储javabean到ambari数据库里。</p>
<p>view组件先通过view context获取一个datastore的实例。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">      <span class="comment">/**</span></div><div class="line">       * Get a data store for view persistence entities.</div><div class="line">       *</div><div class="line">       * <span class="doctag">@return</span> a data store</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> DataStore <span class="title">getDataStore</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">The DataStore object exposes a simple <span class="class"><span class="keyword">interface</span> <span class="title">for</span> <span class="title">persisting</span> <span class="title">view</span> <span class="title">entities</span>.  <span class="title">The</span> <span class="title">basic</span> <span class="title">CRUD</span> <span class="title">operations</span> <span class="title">are</span> <span class="title">supported</span> …  </span></div><div class="line"></div><div class="line">      /**</div><div class="line">       * <span class="title">Save</span> <span class="title">the</span> <span class="title">given</span> <span class="title">entity</span> <span class="title">to</span> <span class="title">persistent</span> <span class="title">storage</span>.  <span class="title">The</span> <span class="title">entity</span> <span class="title">must</span> <span class="title">be</span> <span class="title">declared</span> <span class="title">as</span> <span class="title">an</span></div><div class="line">       * &lt;<span class="title">entity</span>&gt; <span class="title">in</span> <span class="title">the</span> &lt;<span class="title">persistence</span>&gt; <span class="title">element</span> <span class="title">of</span> <span class="title">the</span> <span class="title">view</span>.<span class="title">xml</span>.</div><div class="line">       *</div><div class="line">       * @<span class="title">param</span> <span class="title">entity</span>  <span class="title">the</span> <span class="title">entity</span> <span class="title">to</span> <span class="title">be</span> <span class="title">persisted</span>.</div><div class="line">       *</div><div class="line">       * @<span class="title">throws</span> <span class="title">PersistenceException</span> <span class="title">thrown</span> <span class="title">if</span> <span class="title">the</span> <span class="title">given</span> <span class="title">entity</span> <span class="title">can</span> <span class="title">not</span> <span class="title">be</span> <span class="title">persisted</span></div><div class="line">       */</div><div class="line">      <span class="title">public</span> <span class="title">void</span> <span class="title">store</span>(<span class="title">Object</span> <span class="title">entity</span>) <span class="title">throws</span> <span class="title">PersistenceException</span>;</div><div class="line">    </div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Remove the given entity from persistent storage.</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> entity  the entity to be removed.</div><div class="line">       *</div><div class="line">       * <span class="doctag">@throws</span> PersistenceException thrown if the given entity can not be removed</div><div class="line">       */</div><div class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(Object entity)</span> <span class="keyword">throws</span> PersistenceException</span>;</div><div class="line">    </div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Find the entity of the given class type that is uniquely identified by the</div><div class="line">       * given primary key.</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> clazz       the entity class</div><div class="line">       * <span class="doctag">@param</span> primaryKey  the primary key</div><div class="line">       * <span class="doctag">@param</span> &lt;T&gt;         the entity type</div><div class="line">       *</div><div class="line">       * <span class="doctag">@return</span> the entity; null if the entity can't be found</div><div class="line">       *</div><div class="line">       * <span class="doctag">@throws</span> PersistenceException thrown if an error occurs trying to find the entity</div><div class="line">       */</div><div class="line">      <span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">find</span><span class="params">(Class&lt;T&gt; clazz, Object primaryKey)</span> <span class="keyword">throws</span> PersistenceException</span>;</div><div class="line">    </div><div class="line">      <span class="comment">/**</span></div><div class="line">       * Find all the entities for the given where clause.  Specifying null for the where</div><div class="line">       * clause should return all entities of the given class type.</div><div class="line">       *</div><div class="line">       * <span class="doctag">@param</span> clazz        the entity class</div><div class="line">       * <span class="doctag">@param</span> whereClause  the where clause; may be null</div><div class="line">       * <span class="doctag">@param</span> &lt;T&gt;          the entity type</div><div class="line">       *</div><div class="line">       * <span class="doctag">@return</span> all of the entities for the given where clause; empty collection if no</div><div class="line">       *         entities can be found</div><div class="line">       *</div><div class="line">       * <span class="doctag">@throws</span> PersistenceException</div><div class="line">       */</div><div class="line">      <span class="keyword">public</span> &lt;T&gt; <span class="function">Collection&lt;T&gt; <span class="title">findAll</span><span class="params">(Class&lt;T&gt; clazz, String whereClause)</span> <span class="keyword">throws</span> PersistenceException</span>;</div></pre></td></tr></table></figure></p>
<p>每个entity被持久化之前，都应该已经在view.xml里定义过了。 See <a href="#viewxml">view.xml</a>.   </p>
<h3 id="Events"><a href="#Events" class="headerlink" title="Events"></a>Events</h3><h5 id="View生命周期Events"><a href="#View生命周期Events" class="headerlink" title="View生命周期Events"></a>View生命周期Events</h5><p>实现View接口之后，每个view都可以监控自己的生命周期。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">View</span> </span>&#123;</div><div class="line"></div><div class="line">  ...</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDeploy</span><span class="params">(ViewDefinition definition)</span></span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(ViewInstanceDefinition definition)</span></span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">(ViewInstanceDefinition definition)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>View实现类应该在view.xml文件里声明注册<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>FILES<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">label</span>&gt;</span>Files<span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line">  ...</div><div class="line">  <span class="tag">&lt;<span class="name">view-class</span>&gt;</span>org.apache.ambari.view.filebrowser.ViewImpl<span class="tag">&lt;/<span class="name">view-class</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>View的实现类在注册过之后，它的对应方法会在任何生命周期event发生的时候被触发。</p>
<table>
<thead>
<tr>
<th>Event</th>
<th>描述</th>
<th>参数</th>
</tr>
</thead>
<tbody>
<tr>
<td>Deploy</td>
<td>The view has been successfully deployed.</td>
<td>The deployed view definition.</td>
</tr>
<tr>
<td>Create</td>
<td>An instance of the view has been created.</td>
<td>The new view instance definition.</td>
</tr>
<tr>
<td>Destroy</td>
<td>An instance of the view has been destroyed.</td>
<td>The destroyed view instance definition.</td>
</tr>
</tbody>
</table>
<h5 id="自定义event"><a href="#自定义event" class="headerlink" title="自定义event"></a>自定义event</h5><p>饿哦们也可以定义一些自定义事件。</p>
<h5 id="Listeners"><a href="#Listeners" class="headerlink" title="Listeners"></a>Listeners</h5><p>view需要写一个listener接口的实现，然后注册这个listener到view框架。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Listener</span> </span>&#123;</div><div class="line"></div><div class="line">  ...</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(Event event)</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>listener的notify方法会在view发射一个event的时候被触发。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JobsListener</span> <span class="keyword">implements</span> <span class="title">Listener</span> </span>&#123;</div><div class="line">  <span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notify</span><span class="params">(Event event)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (event.getId().equals(<span class="string">"NEW_JOB"</span>)) &#123;</div><div class="line">      ViewInstanceDefinition instance = event.getViewInstanceSubject();         </div><div class="line">      ...</div><div class="line">    &#125;      </div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h5 id="ViewController"><a href="#ViewController" class="headerlink" title="ViewController"></a>ViewController</h5><p>ViewController用来注册listener，还有就是发射event。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ViewController</span> </span>&#123;</div><div class="line"></div><div class="line">  ...</div><div class="line">  </div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fireEvent</span><span class="params">(String eventId, Map&lt;String, String&gt; eventProperties)</span></span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerListener</span><span class="params">(Listener listener, String viewName)</span></span>;</div><div class="line"></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">unregisterListener</span><span class="params">(Listener listener, String viewName)</span></span>;    </div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>view组件可以访问通过注入的view context来时用view controller。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">    <span class="meta">@Inject</span></div><div class="line">    ViewContext context;</div><div class="line"></div><div class="line">    ...</div><div class="line">    ViewController controller = context.getController();</div><div class="line">```    </div><div class="line"></div><div class="line"></div><div class="line">view component可以注册监听其他view发射的event。</div><div class="line">```java</div><div class="line">    <span class="meta">@Inject</span></div><div class="line">    ViewContext context;</div><div class="line"></div><div class="line">    ...</div><div class="line">    Listener listener = <span class="keyword">new</span> JobsListener();</div><div class="line"></div><div class="line">    ...</div><div class="line">    ViewController controller = context.getController();</div><div class="line">    controller.registerListener(listener, <span class="string">"JOBS"</span>);</div></pre></td></tr></table></figure></p>
<p>view component也可以发射自定义的view通知event.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Inject</span></div><div class="line">ViewContext context;</div><div class="line"></div><div class="line">...</div><div class="line">Map&lt;String, String&gt; jobEventProperties = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</div><div class="line"></div><div class="line">jobEventProperties.put(<span class="string">"JobId"</span>, jobId);</div><div class="line">jobEventProperties.put(<span class="string">"JobOwner"</span>, jobOwner);</div><div class="line"></div><div class="line">...</div><div class="line">ViewController controller = context.getController();</div><div class="line">controller.fireEvent(<span class="string">"NEW_JOB"</span>, jobEventProperties);</div></pre></td></tr></table></figure>
<h2 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h2><p>所有的view都应该打包，包含配置文件和不同的组件，比如resource和resource provider啥的，还有一些 html, JavaSript and servlets.</p>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><p>The view may include dependency classes and jars directly into the archive.  Classes should be included under <strong>WEB-INF/classes</strong>.  Jars should be included under <strong>WEB-INF/lib</strong>.</p>
<h3 id="view-xml"><a href="#view-xml" class="headerlink" title="view.xml"></a>view.xml</h3><table>
<thead>
<tr>
<th>元素</th>
<th>说明</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>The unique view name (required).</td>
</tr>
<tr>
<td>label</td>
<td>The user facing name.</td>
</tr>
<tr>
<td>version</td>
<td>The view version (required).</td>
</tr>
<tr>
<td>description</td>
<td>The description of the view.</td>
</tr>
<tr>
<td>icon64</td>
<td>The 64x64 icon to display for this view. If this property is not set, the 32x32 sized icon will be used.</td>
</tr>
<tr>
<td>icon</td>
<td>The 32x32 icon to display for this view. Suggested size is 32x32 and will be displayed as 8x8 and 16x16 as necessary. If this property is not set, a default view framework icon is used.</td>
</tr>
<tr>
<td>system</td>
<td>Indicates whether or not this is a system view.  Default is false. </td>
</tr>
<tr>
<td>view-class</td>
<td>The View class to receive framework events. </td>
</tr>
<tr>
<td>masker-class</td>
<td>The Masker class for masking view parameters. </td>
</tr>
<tr>
<td>parameter</td>
<td>Defines a configuration parameter that is used to when creating a view instance. </td>
</tr>
<tr>
<td>resource</td>
<td>Describe a resources exposed by the view.</td>
</tr>
<tr>
<td>permission</td>
<td>Defines a custom permission for the view. </td>
</tr>
<tr>
<td>persistence</td>
<td>Describe a view entities for persistence. </td>
</tr>
<tr>
<td>instance</td>
<td>Define an instances of a view.</td>
</tr>
</tbody>
</table>
<h5 id="参数"><a href="#参数" class="headerlink" title="参数"></a>参数</h5><table>
<thead>
<tr>
<th>元素</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>The parameter name.</td>
</tr>
<tr>
<td>description</td>
<td>The parameter description.</td>
</tr>
<tr>
<td>required</td>
<td>Determines whether or not the parameter is required.</td>
</tr>
<tr>
<td>masked</td>
<td>Indicated this parameter value is to be “masked” in the Ambari Web UI (i.e. not shown in the clear). Omitting this element default to not-masked. Otherwise, if true, the parameter value will be “masked” in the Web UI.</td>
</tr>
</tbody>
</table>
<h5 id="resource"><a href="#resource" class="headerlink" title="resource"></a>resource</h5><table>
<thead>
<tr>
<th>元素</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>The resource name (i.e file).</td>
</tr>
<tr>
<td>plural-name</td>
<td>The parameter description (i.e. files). *</td>
</tr>
<tr>
<td>id-property</td>
<td>The id field of the managed resource class. *</td>
</tr>
<tr>
<td>resource-class</td>
<td>The class of the JavaBean that contains the attributes of a managed resource. *</td>
</tr>
<tr>
<td>provider-class</td>
<td>The class of the managed resource provider. *</td>
</tr>
<tr>
<td>service-class</td>
<td>The class of the JAX-RS annotated service resource.</td>
</tr>
<tr>
<td>sub-resource-name</td>
<td>The sub-resource name.</td>
</tr>
</tbody>
</table>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>files<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">service-class</span>&gt;</span>org.apache.ambari.view.filebrowser.FileBrowserService<span class="tag">&lt;/<span class="name">service-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line"></div><div class="line">\* only required for a managed resource.  For example ...</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">name</span>&gt;</span>script<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">plural-name</span>&gt;</span>scripts<span class="tag">&lt;/<span class="name">plural-name</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">id-property</span>&gt;</span>id<span class="tag">&lt;/<span class="name">id-property</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">resource-class</span>&gt;</span>org.apache.ambari.view.pig.resources.scripts.models.PigScript<span class="tag">&lt;/<span class="name">resource-class</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">provider-class</span>&gt;</span>org.apache.ambari.view.pig.resources.scripts.ScriptResourceProvider<span class="tag">&lt;/<span class="name">provider-class</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">service-class</span>&gt;</span>org.apache.ambari.view.pig.resources.scripts.ScriptService<span class="tag">&lt;/<span class="name">service-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div></pre></td></tr></table></figure>
<h5 id="权限-1"><a href="#权限-1" class="headerlink" title="权限"></a>权限</h5><table>
<thead>
<tr>
<th>Element</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>The permission name.</td>
</tr>
<tr>
<td>description</td>
<td>The permission description.</td>
</tr>
</tbody>
</table>
<h5 id="持久化-1"><a href="#持久化-1" class="headerlink" title="持久化"></a>持久化</h5><table>
<thead>
<tr>
<th>Element</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>entity</td>
<td>An entity that may be persisted through the DataStore.</td>
</tr>
</tbody>
</table>
<h5 id="entity"><a href="#entity" class="headerlink" title="entity"></a>entity</h5><table>
<thead>
<tr>
<th>Element</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>class</td>
<td>The class ot the JavaBean that contains the attributes of an entity.</td>
</tr>
<tr>
<td>id-property</td>
<td>The id field of the entity.</td>
</tr>
</tbody>
</table>
<p>例子<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">&lt;persistence&gt;</div><div class="line">  &lt;entity&gt;</div><div class="line">    &lt;<span class="class"><span class="keyword">class</span>&gt;<span class="title">org</span>.<span class="title">apache</span>.<span class="title">ambari</span>.<span class="title">view</span>.<span class="title">employee</span>.<span class="title">EmployeeEntity</span>&lt;/<span class="title">class</span>&gt;</span></div><div class="line">    &lt;<span class="title">id</span>-<span class="title">property</span>&gt;<span class="title">id</span>&lt;/<span class="title">id</span>-<span class="title">property</span>&gt;</div><div class="line">  &lt;/<span class="title">entity</span>&gt;</div><div class="line">  &lt;<span class="title">entity</span>&gt;</div><div class="line">    &lt;<span class="title">class</span>&gt;<span class="title">org</span>.<span class="title">apache</span>.<span class="title">ambari</span>.<span class="title">view</span>.<span class="title">employee</span>.<span class="title">AddressEntity</span>&lt;/<span class="title">class</span>&gt;</div><div class="line">    &lt;<span class="title">id</span>-<span class="title">property</span>&gt;<span class="title">id</span>&lt;/<span class="title">id</span>-<span class="title">property</span>&gt;</div><div class="line">  &lt;/<span class="title">entity</span>&gt;</div><div class="line">  &lt;<span class="title">entity</span>&gt;</div><div class="line">    &lt;<span class="title">class</span>&gt;<span class="title">org</span>.<span class="title">apache</span>.<span class="title">ambari</span>.<span class="title">view</span>.<span class="title">employee</span>.<span class="title">ProjectEntity</span>&lt;/<span class="title">class</span>&gt;</div><div class="line">    &lt;<span class="title">id</span>-<span class="title">property</span>&gt;<span class="title">id</span>&lt;/<span class="title">id</span>-<span class="title">property</span>&gt;</div><div class="line">  &lt;/<span class="title">entity</span>&gt;</div><div class="line">&lt;/<span class="title">persistence</span>&gt;</div></pre></td></tr></table></figure></p>
<h5 id="instance"><a href="#instance" class="headerlink" title="instance"></a>instance</h5><table>
<thead>
<tr>
<th>Element</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>The unique instance name (required).</td>
</tr>
<tr>
<td>label</td>
<td>The display label of the view instance. If not set, the view definition label is used.</td>
</tr>
<tr>
<td>description</td>
<td>The description of the view instance. If not set, the view definition description is used.</td>
</tr>
<tr>
<td>icon64</td>
<td>Overrides the view icon64 for this specific view instance.</td>
</tr>
<tr>
<td>icon</td>
<td>Overrides the view icon for this specific view instance.</td>
</tr>
<tr>
<td>visible</td>
<td>If true, for the view instance to show up in the users view instance list.  The default value is true.</td>
</tr>
<tr>
<td>property</td>
<td>Specifies configuration parameters values for the view instance.</td>
</tr>
</tbody>
</table>
<h5 id="property"><a href="#property" class="headerlink" title="property"></a>property</h5><table>
<thead>
<tr>
<th>Element</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>key</td>
<td>The property key (must match view parameter name).</td>
</tr>
<tr>
<td>value</td>
<td>The property value.</td>
</tr>
</tbody>
</table>
<p>完整的 view.xml例子<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">view</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>FILES<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">label</span>&gt;</span>Files<span class="tag">&lt;/<span class="name">label</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">parameter</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dataworker.defaultFs<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>FileSystem URI<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">required</span>&gt;</span>true<span class="tag">&lt;/<span class="name">required</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parameter</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">parameter</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>dataworker.username<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span>The username (defaults to ViewContext username)<span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">required</span>&gt;</span>false<span class="tag">&lt;/<span class="name">required</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">parameter</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">resource</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>files<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">service-class</span>&gt;</span>org.apache.ambari.view.filebrowser.FileBrowserService<span class="tag">&lt;/<span class="name">service-class</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">resource</span>&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">instance</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>FILES_1<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span>dataworker.defaultFs<span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>hdfs://<span class="tag">&lt;<span class="name">server</span>&gt;</span>:8020<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">instance</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">view</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这个例子中配置了一个叫FILES的view，也是有一个实例FILES_1。可以看到这个view有一个required的参数<strong>‘dataworker.defaultFs’</strong>以及一个optional参数<strong>‘dataworker.username’</strong>.  还有一个访问资源的入口<strong>‘files’</strong>. </p>
<h2 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h2><p>要发布一个view，只需要将view的包放到ambari-server的views文件夹下，默认是在</p>
<pre><code>/var/lib/ambari-server/resources/views
</code></pre><h3 id="解压包"><a href="#解压包" class="headerlink" title="解压包"></a>解压包</h3><p>view被发布之后，会自动在views文件夹下解压包。默认位置是:</p>
<pre><code>/var/lib/ambari-server/resources/views/work/:viewName{:viewVersion}
</code></pre><p>例如，上面例子中的files view解压后目录就是：</p>
<pre><code>/var/lib/ambari-server/resources/views/work/FILES{0.1.0}
</code></pre><p>用户可以直接修改解压后的文件，在ambari下次启动的时候就可以生效了。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><h3 id="API"><a href="#API" class="headerlink" title="API"></a>API</h3><h5 id="Get-Views"><a href="#Get-Views" class="headerlink" title="Get Views"></a>Get Views</h5><p>获取所有已经发布的view。注意view是顶级resource，不属于任何其他resource。</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/

{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/&quot;,
  &quot;items&quot; : [
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES&quot;,
      &quot;ViewInfo&quot; : {
        &quot;view_name&quot; : &quot;FILES&quot;
      }
    },
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/HELLO_WORLD&quot;,
      &quot;ViewInfo&quot; : {
        &quot;view_name&quot; : &quot;HELLO_WORLD&quot;
      }
    }
  ]
}
</code></pre><h5 id="Get-View"><a href="#Get-View" class="headerlink" title="Get View"></a>Get View</h5><p>根据名称获取指定view，返回所有版本.</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/FILES/

{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/&quot;,
  &quot;ViewInfo&quot; : {
    &quot;view_name&quot; : &quot;FILES&quot;
  },
  &quot;versions&quot; : [
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0&quot;,
      &quot;ViewVersionInfo&quot; : {
        &quot;version&quot; : &quot;0.1.0&quot;,
        &quot;view_name&quot; : &quot;FILES&quot;
      }
    }
  ]
}
</code></pre><h5 id="Get-Versions"><a href="#Get-Versions" class="headerlink" title="Get Versions"></a>Get Versions</h5><p>获取一个view 的所有版本.</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/FILES/versions/

{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/&quot;,
  &quot;items&quot; : [
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0&quot;,
      &quot;ViewVersionInfo&quot; : {
        &quot;version&quot; : &quot;0.1.0&quot;,
        &quot;view_name&quot; : &quot;FILES&quot;
      }
    }
  ]
}
</code></pre><h5 id="Get-Version"><a href="#Get-Version" class="headerlink" title="Get Version"></a>Get Version</h5><p>获取某view的指定版本以及此版本下的所有实例.</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/

{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/&quot;,
  &quot;ViewVersionInfo&quot; : {
    &quot;archive&quot; : &quot;/var/lib/ambari-server/resources/views/work/FILES{0.1.0}&quot;,
    &quot;label&quot; : &quot;Files&quot;,
    &quot;parameters&quot; : [
      {
        &quot;name&quot; : &quot;dataworker.defaultFs&quot;,
        &quot;description&quot; : &quot;FileSystem URI&quot;,
        &quot;required&quot; : true
      },
      {
        &quot;name&quot; : &quot;dataworker.username&quot;,
        &quot;description&quot; : &quot;The username (defaults to ViewContext username)&quot;,
        &quot;required&quot; : false
      }
    ],
    &quot;version&quot; : &quot;0.1.0&quot;,
    &quot;view_name&quot; : &quot;FILES&quot;
  },
  &quot;instances&quot; : [
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_1&quot;,
      &quot;ViewInstanceInfo&quot; : {
        &quot;instance_name&quot; : &quot;FILES_1&quot;,
        &quot;version&quot; : &quot;0.1.0&quot;,
        &quot;view_name&quot; : &quot;FILES&quot;
      }
    }
  ]
}
</code></pre><h5 id="Get-Instances"><a href="#Get-Instances" class="headerlink" title="Get Instances"></a>Get Instances</h5><p>获取一个view 的所有实例.</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/

{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/&quot;,
  &quot;items&quot; : [
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_1&quot;,
      &quot;ViewInstanceInfo&quot; : {
        &quot;instance_name&quot; : &quot;FILES_1&quot;,
        &quot;version&quot; : &quot;0.1.0&quot;,
        &quot;view_name&quot; : &quot;FILES&quot;
      }
    }
  ]
}
</code></pre><h5 id="获取实例"><a href="#获取实例" class="headerlink" title="获取实例"></a>获取实例</h5><p>根据实例名称获取实例，此实例的所有resource也会被返回。</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_1

{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_1&quot;,
  &quot;ViewInstanceInfo&quot; : {
    &quot;context_path&quot; : &quot;/views/FILES/0.1.0/FILES_1&quot;,
    &quot;instance_name&quot; : &quot;FILES_1&quot;,
    &quot;version&quot; : &quot;0.1.0&quot;,
    &quot;view_name&quot; : &quot;FILES&quot;,
    &quot;instance_data&quot; : { },
    &quot;properties&quot; : {
      &quot;dataworker.defaultFs&quot; : &quot;hdfs://&lt;server&gt;:8020&quot;
    }
  },
  &quot;resources&quot; : [
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_1/resources/files&quot;,
      &quot;instance_name&quot; : &quot;FILES_1&quot;,
      &quot;name&quot; : &quot;files&quot;,
      &quot;version&quot; : &quot;0.1.0&quot;,
      &quot;view_name&quot; : &quot;FILES&quot;
    }
  ]
}
</code></pre><h5 id="创建实例"><a href="#创建实例" class="headerlink" title="创建实例"></a>创建实例</h5><pre><code>POST http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_2
</code></pre><h5 id="更新实例"><a href="#更新实例" class="headerlink" title="更新实例"></a>更新实例</h5><pre><code>PUT http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_2
[{
  &quot;ViewInstanceInfo&quot; : {
      &quot;properties&quot; : {
        &quot;dataworker.defaultFs&quot; : &quot;hdfs://MyServer:8020&quot;
      }
    }
}]
</code></pre><h5 id="删除实例"><a href="#删除实例" class="headerlink" title="删除实例"></a>删除实例</h5><pre><code>DELETE http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_2
</code></pre><h5 id="Resources-1"><a href="#Resources-1" class="headerlink" title="Resources"></a>Resources</h5><p>A view resource may be accessed through the REST API.  The href for each view resource can be found in a request for the parent view instance.  The resource endpoints and behavior depends on the implementation of the JAX-RS annotated service class specified for the resource element in the view.xml. </p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/FILES_1/resources/files/fileops/listdir?path=%2F

[{&quot;path&quot;:&quot;/app-logs&quot;,&quot;replication&quot;:0,&quot;isDirectory&quot;:true,&quot;len&quot;:0,&quot;owner&quot;:&quot;yarn&quot;,&quot;group&quot;:&quot;hadoop&quot;,&quot;permission&quot;:&quot;-rwxrwxrwx&quot;,&quot;accessTime&quot;:0,&quot;modificationTime&quot;:1400006792122,&quot;blockSize&quot;:0},{&quot;path&quot;:&quot;/mapred&quot;,&quot;replication&quot;:0,&quot;isDirectory&quot;:true,&quot;len&quot;:0,&quot;owner&quot;:&quot;mapred&quot;,&quot;group&quot;:&quot;hdfs&quot;,&quot;permission&quot;:&quot;-rwxr-xr-x&quot;,&quot;accessTime&quot;:0,&quot;modificationTime&quot;:1400006653817,&quot;blockSize&quot;:0},{&quot;path&quot;:&quot;/mr-history&quot;,&quot;replication&quot;:0,&quot;isDirectory&quot;:true,&quot;len&quot;:0,&quot;owner&quot;:&quot;hdfs&quot;,&quot;group&quot;:&quot;hdfs&quot;,&quot;permission&quot;:&quot;-rwxr-xr-x&quot;,&quot;accessTime&quot;:0,&quot;modificationTime&quot;:1400006653822,&quot;blockSize&quot;:0},{&quot;path&quot;:&quot;/tmp&quot;,&quot;replication&quot;:0,&quot;isDirectory&quot;:true,&quot;len&quot;:0,&quot;owner&quot;:&quot;hdfs&quot;,&quot;group&quot;:&quot;hdfs&quot;,&quot;permission&quot;:&quot;-rwxrwxrwx&quot;,&quot;accessTime&quot;:0,&quot;modificationTime&quot;:1400006720415,&quot;blockSize&quot;:0},{&quot;path&quot;:&quot;/user&quot;,&quot;replication&quot;:0,&quot;isDirectory&quot;:true,&quot;len&quot;:0,&quot;owner&quot;:&quot;hdfs&quot;,&quot;group&quot;:&quot;hdfs&quot;,&quot;permission&quot;:&quot;-rwxr-xr-x&quot;,&quot;accessTime&quot;:0,&quot;modificationTime&quot;:1400006610050,&quot;blockSize&quot;:0}]
</code></pre><h5 id="Managed-Resources-1"><a href="#Managed-Resources-1" class="headerlink" title="Managed Resources"></a>Managed Resources</h5><p>Any managed resources for a view may also be accessed through the REST API.  Note that instances of a managed resource appear as sub-resources of an instance under the plural name specified for the resource in the view.xml.  In this example, a list of managed resources named <strong>‘scripts’</strong> is included in the response for the view instance … </p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/PIG/versions/0.1.0/instances/INSTANCE_1

{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/PIG/versions/0.1.0/instances/INSTANCE_1&quot;,
  &quot;ViewInstanceInfo&quot; : {
    &quot;context_path&quot; : &quot;/views/PIG/0.1.0/INSTANCE_1&quot;,
    &quot;instance_name&quot; : &quot;INSTANCE_1&quot;,
    &quot;version&quot; : &quot;0.1.0&quot;,
    &quot;view_name&quot; : &quot;PIG&quot;,
    &quot;instance_data&quot; : { },
    &quot;properties&quot; : {
      … 
    }
  },
  &quot;resources&quot; : [ ],
  &quot;scripts&quot; : [
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/PIG/versions/0.1.0/instances/INSTANCE_1/scripts/script1&quot;,
      &quot;id&quot; : &quot;script1&quot;,
      &quot;instance_name&quot; : &quot;INSTANCE_1&quot;,
      &quot;version&quot; : &quot;0.1.0&quot;,
      &quot;view_name&quot; : &quot;PIG&quot;
    },
    {
      &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/FILES/versions/0.1.0/instances/INSTANCE_1/scripts/script2&quot;,
      &quot;id&quot; : &quot;script2&quot;,
      &quot;instance_name&quot; : &quot;INSTANCE_1&quot;,
      &quot;version&quot; : &quot;0.1.0&quot;,
      &quot;view_name&quot; : &quot;PIG&quot;
    },
    …
  ]
}
</code></pre><p>获取单个managed resource …</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/PIG/versions/0.1.0/instances/INSTANCE_1/scripts/script1


{
  &quot;href&quot; : &quot;http://&lt;server&gt;:8080/api/v1/views/PIG/versions/0.1.0/instances/INSTANCE_1/scripts/script1&quot;,
  &quot;id&quot; : &quot;script1&quot;,      
  &quot;pigScript&quot; : &quot;… &quot;,
  &quot;pythonScript&quot; : &quot;… &quot;,
  &quot;templetonArguments&quot; : &quot;… &quot;,
  &quot;dateCreated&quot; : … ,
  &quot;owner&quot; : &quot;… &quot;,
  &quot;instance_name&quot; : &quot;INSTANCE_1&quot;,
  &quot;version&quot; : &quot;0.1.0&quot;,
  &quot;view_name&quot; : &quot;PIG&quot;
}
</code></pre><p>由于resource是被ambari api框架管理的，也可以使用partial response和query predicate。</p>
<pre><code>GET http://&lt;server&gt;:8080/api/v1/views/PIG/versions/0.1.0/instances/INSTANCE_1/scripts?fields=pythonScript&amp;owner=jsmith
</code></pre><h5 id="设置view权限"><a href="#设置view权限" class="headerlink" title="设置view权限"></a>设置view权限</h5><p>To grant privileges to access the restricted resource we can create a privilege sub-resource for the view instance.  The following API will grant RESTICTED permission to the user ‘bob’ for the view instance ‘INSTANCE_1’ of the ‘RESTRICTED’ view. </p>
<pre><code>POST http://&lt;server&gt;/api/v1/views/RESTRICTED/versions/1.0.0/instances/INSTANCE_1

[
  {
    &quot;PrivilegeInfo&quot; : {
      &quot;permission_name&quot; : &quot;RESTRICTED&quot;,
      &quot;principal_name&quot; : &quot;bob&quot;,
      &quot;principal_type&quot; : &quot;USER&quot;
    }
  }
]
</code></pre><h5 id="查询view权限"><a href="#查询view权限" class="headerlink" title="查询view权限"></a>查询view权限</h5><p>We can see a privilege sub resource for a view instance.</p>
<pre><code>GET  http://&lt;server&gt;/api/v1/views/RESTRICTED/versions/1.0.0/instances/INSTANCE_1/privileges/5


{
  &quot;href&quot; : &quot;http://&lt;server&gt;/api/v1/views/RESTRICTED/versions/1.0.0/instances/INSTANCE_1/privileges/5&quot;,
  &quot;PrivilegeInfo&quot; : {
    &quot;instance_name&quot; : &quot;INSTANCE_1&quot;,
    &quot;permission_name&quot; : &quot;RESTRICTED&quot;,
    &quot;principal_name&quot; : &quot;bob&quot;,
    &quot;principal_type&quot; : &quot;USER&quot;,
    &quot;privilege_id&quot; : 5,
    &quot;version&quot; : &quot;1.0.0&quot;,
    &quot;view_name&quot; : &quot;RESTRICTED&quot;
  }
}
</code></pre><h3 id="View-UI"><a href="#View-UI" class="headerlink" title="View UI"></a>View UI</h3><p>The context root of a view instance is …</p>
<pre><code>/views/:viewName/:viewVersion/:viewInstance/
</code></pre><p>For example, the context root can be found in the response for a view instance … </p>
<p><img src="instance_response.png" alt="image"></p>
<p>So, to access the UI of the above Files view the user would browse to …</p>
<pre><code>http://&lt;server&gt;:8080/views/FILES/0.1.0/FILES_1/  
</code></pre><p><img src="ui.png" alt="image"></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/源码/">源码</a><a href="/tags/ambari/">ambari</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/"><span></span>Prev</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/3/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  

  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/源码/" title="源码">源码<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/akka/" title="akka">akka<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/flume/" title="flume">flume<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/spring/" title="spring">spring<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/solr/" title="solr">solr<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/ETL/" title="ETL">ETL<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/azkaban/" title="azkaban">azkaban<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/调度平台/" title="调度平台">调度平台<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/python/" title="python">python<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/mysql/" title="mysql">mysql<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/scala/" title="scala">scala<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/ambari/" title="ambari">ambari<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/quartz/" title="quartz">quartz<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/2015a/" title="2015a">2015a<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ElasticSearch/" title="ElasticSearch">ElasticSearch<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/heroku/" title="heroku">heroku<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/guava/" title="guava">guava<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/django/" title="django">django<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Flume/" title="Flume">Flume<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/mac/" title="mac">mac<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://github.com/willcup" target="_blank" title=" 我自己的github">github</a>
            
          </li>
        
          <li>
            
            	<a href="http://thisding.com" target="_blank" title="朋友的主页">Steven&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Will Chen in MeiTuan. <br/>
			元 亨 利 贞.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:chenxin15@meituan.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2017 
		
		<a href="/about" target="_blank" title="Will Chen">Will Chen</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fe6d1f421bbc9962127a50488f9ed37d1' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
