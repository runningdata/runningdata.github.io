
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <script type="text/javascript">
    (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
    (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
    e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
    })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
    
    _st('install','yNiKTKaAnwd1uuxVMfiE','2.0.0');
  </script>
  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?5b99dfd487346155d274c0c49c3fb869";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
  </script>

  
    <title>Will&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Will Chen">
    

    
    <meta name="description" content="左右水色 右手天光">
<meta property="og:type" content="website">
<meta property="og:title" content="Will's Blog">
<meta property="og:url" content="https://runningdata.github.io/page/24/index.html">
<meta property="og:site_name" content="Will's Blog">
<meta property="og:description" content="左右水色 右手天光">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Will's Blog">
<meta name="twitter:description" content="左右水色 右手天光">

    
    <link rel="alternative" href="/atom.xml" title="Will&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Will&#39;s Blog" title="Will&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Will&#39;s Blog">Will&#39;s Blog</a></h1>
				<h2 class="blog-motto">简易 变易 不易</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
                                                <form class="search" action="/search/index.html" method="get" accept-charset="utf-8" target="_blank">
                                                        <label>搜索</label>
                                                <input name="s" type="hidden" value= null ><input type="text" class="st-default-search-input" name="q" size="30" placeholder="搜索"><br>
                                                </form>
					
					</li>
				</ul>
			</nav>			
</div>

    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/08/03/matlib-安装与卸载/" title="matlib 安装与卸载" itemprop="url">matlib 安装与卸载</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2015-08-03T11:57:11.000Z" itemprop="datePublished"> 发表于 2015-08-03</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>2004版本的那个主要就是兼容性问题，在win7下需要调整程序的<strong>兼容性</strong>，启动时候调整到Vista，卸载时调整到win 2000.</p>
<p>以下是2015a版本的安装，这个没有发现与win7的兼容性问题。转自<a href="http://tieba.baidu.com/p/3660998181?pn=1" target="_blank" rel="external">http://tieba.baidu.com/p/3660998181?pn=1</a></p>
<p>这个文件是分压缩卷，解压其中一个压缩包就行了，解压到你想解压到的地方，解压出来是一个镜像文件（即ISO格式的），然后用虚拟机加载，（可以下个“软碟通”进行加载），加载后，在我的电脑（计算机）中，硬盘分区下面的可移动储存设备中找到CD驱动器，双击进去.进去后进行下面的操作：</p>
<p>1.用管理员权限运行里面的setup.exe，然后等一会，他需要安装某些东西。</p>
<p>2.选择不联网安装，我有密钥，下一步，选择我有密钥（即第一个），然后把 <strong> 58691-35070-25550-28046-23042 </strong>这串数字复制粘贴进去，点下一步。</p>
<p>3.选择你想安装的东西，在前面打钩（他都给你打好了），不想装的把勾去掉，然后下一步，让他安装，这个安装比较漫长，等吧，可以干其他的事情去.</p>
<p>4.安装完成</p>
<p>5.这是时我们找到刚才计算机里硬盘分区下面的可移动储存设备中找到CD驱动器，进去后，找到crack这个文件夹，进去后复制</p>
<p><strong>bin,java,toolbox</strong>这三个文件夹，然后找到我们刚才安装这个软件的<strong>安装目录</strong>，把这三个文件夹粘贴进去，后面会弹出是否覆盖替换，选择覆盖替换，全部都覆盖替换。</p>
<p>6.由于这个软件没有创建桌面快捷方式，开始菜单里也没有，所以我们去这个软件的安装目录，找到你刚才安装这个软件的地方，这个软件的</p>
<p>安装目录下找到bin这个文件夹，双击进去把matlab.exe执行文件发送到桌面快捷方式（右键，发送，桌面快捷方式）。</p>
<p>6.在桌面上双击这个matlab.exe图标，因为这是第一次打开，等一会，会弹出一个激活框，选择“不连接Internet激活”，下一步，选择“输入许可证文件的完整路径”，点击“浏览”找到刚才计算机里硬盘分区下面的可移动储存设备中找到CD驱动器，双击进去找到crack这个文件夹，找到<strong>lic_standalone.dat</strong>，选择这个文件，然后点下<br>一步，激活成功！</p>
<p>7.完成！！！</p>
<p>尽情享受吧！！！</p>
<p>别忘了把刚才那个计算机里硬盘分区下面的可移动储存设备中找到CD驱动器弹出！（右键，弹出）</p>
<p>养成用最高管理员运行软件的好习惯！！！</p>
<p>下载地址：<a href="http://pan.baidu.com/s/1sjI603b" target="_blank" rel="external">http://pan.baidu.com/s/1sjI603b</a></p>
<p>密码：zxd0</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/matlib/">matlib</a><a href="/tags/2015a/">2015a</a><a href="/tags/2004/">2004</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/16/akka-读书笔记（1）/" title="akka in action 读书笔记（1）" itemprop="url">akka in action 读书笔记（1）</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2015-07-15T18:45:52.000Z" itemprop="datePublished"> 发表于 2015-07-16</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="什么是AKKA"><a href="#什么是AKKA" class="headerlink" title="什么是AKKA"></a>什么是AKKA</h2><p>akka：</p>
<ul>
<li>并行处理请求</li>
<li>和service与client进行并发交互</li>
<li>异步响应</li>
<li>事件驱动编程模型</li>
</ul>
<p>akka是被设计为一个工具而不是一个框架。框架是一个栈的某个独立的元素【比如UI层、web层等】，而akka可以用于这个栈中的任何部分，也可以为这些部分之间提供连接。<br>akka的每个module是由jar包组成的，已经尽量较少了各个jar之间的耦合，甚至akka-actor除了scala标准包没有任何其他依赖。另外akka还提供了一些集成其他组件(例如camel, zeromq等)的module。下图是akka技术栈的主要组件，也解释了client如果省去一些细节麻烦：<br><img src="/imgs/akka/akka1.1.png" alt="Figure 1.1 The Akka Stack"></p>
<p>akka自身提供运行时环境，有一个很小的叫做play mini的内核，可以做的事情简直让你叹为观止。akka应用主要是由actor组成，基于actor编程模型，借鉴自函数式编程语言ERLANG和Fanton。</p>
<hr>
<h3 id="并发"><a href="#并发" class="headerlink" title="并发"></a>并发</h3><p>问题：<br>考虑一个卖票的程序，如果一百万人同时向100个售票处买票，但是只有一个地方打印票。<br><img src="/imgs/akka/akka1.2.png" alt="Figure 1.2 Buying Tickets"></p>
<p><img src="/imgs/akka/akka1.3.png" alt="Figure 1.3 买票人、售票处、打印中心的关系"></p>
<p>面对以上问题，好多TicketingAgents都互相竞争，抢用打印机资源。解决方案有两个。对于一个基于线程的程序来说，最简单的实现就是为每个request直接fork一个线程，这简直就是灾难性的。就算是线程池的话，也可能每个请求都花比较长的时间而造成timeout，客户端还是会失败。另外，如果几个线程互相争抢并修改公用的资源同样会造成不良后果。</p>
<h5 id="方案1：共享状态"><a href="#方案1：共享状态" class="headerlink" title="方案1：共享状态"></a>方案1：共享状态</h5><p>看下图：</p>
<p><img src="/imgs/akka/akka1.4.png" alt="Figure 1.4 Buying sequence 买票人排队等待"><br>TicketingAgent取走一张票，然后告诉printing office打印。如果不能打印的话，就到3c，也就是卖完了。</p>
<p>这样，我们不必费力地控制Agent之间对Ticket的竞争。You can see, we didn’t have to go to great lengths to keep the Agents from blocking each other’s access to Tickets, and the result is also a bit clearer than what we would probably end up with if someone came in later and rewrote the selling sequence to make it concurrent.</p>
<p>使用线程的话有三个原因可能导致灾难性失败：</p>
<ul>
<li>thread starvation 当所有的线程都很忙或者都死锁了，无暇顾及新request的时候，都可能导致server关闭</li>
<li>race conditions 当某个共享资源被多个线程同时修改，可能会产生混乱，产生意想不到的结果</li>
<li>deadlock</li>
</ul>
<p>即便你避免了以上所有问题，就这些避免的措施也够让人头疼的。锁控制的边界不是太大就是太小。使用过多的锁，其实实际上的并发就会少了特别特别多。使用的锁不够多，就可能遇到各种各样的bug。掌握一个好的平衡点是很困难的事情。</p>
<p>TicketAgent们都得互相等待，这些TicketAgent的客户就也得等待。TicketAgent A的客户需要等着TicketAgent B的某个客户，听上去有点儿奇怪，有些等待的时间并没有那么必要。</p>
<h5 id="方案2：消息驱动"><a href="#方案2：消息驱动" class="headerlink" title="方案2：消息驱动"></a>方案2：消息驱动</h5><p>我们使用AKKA使得事情变简单的根源在于我们<code>避免使用共享状态</code>。我们必须改变以下三个方面：</p>
<ul>
<li>event和ticket在售票处和打印室中间以不可变的消息状态传递</li>
<li>售票处的打印请求被打印室异步放入队列，不用等待打印方法完成或者接受确认</li>
<li><p>售票处和打印室相互之间不是直接使用相互的引用，而是记录联系对方的地址，他们之间通过相互传递message来进行通讯，这些message暂时被放置于一个mailbox中，后面会被按照放入的次序被处理掉。</p>
<p>当然，有些新的问题也会出现：TicketAgents在卖光自己的票以后需要有一种方式获取更多的票供给。这很重要，我们使用传递不可变message的方式完成了这项工作，我们不必担心app是否能够承担住激增的请求。下图是修改后的顺序图：</p>
<p><img src="/imgs/akka/akka1.5.png" alt="Figure 1.5 TicketingAgent sequence 售票处排队等待"> </p>
</li>
</ul>
<p>那么售票处具体怎么拿到票呢？打印室会给每个售票处发送取票信息，每个Event都会包含N多票和这个Event的状态信息。有很多种方式发送message给所有的售票处，这里我们使用的是让售票处之间相互传递的方式。售票处们也都知道各自的位置，会传达给目标(我们会在akka中常常见到chain的形式，从简单的传递工作状态到分布式的基于actor的责任链设计模式)<br><img src="/imgs/akka/akka1.6.png" alt="Figure 1.6 Distributing tickets"><br>如果一个售票处取了event中的属于自己的票后还有剩余的，就继续传递下去，代表还有其他售票处没有拿到应得的票。如果所有的售票处都看过这个event了，一段时间后仍然没人认领，那就让这些票过期。</p>
<p>基于消息传递的模式有两个好处，一个是不用管任何锁，另外售票处也不用干等着response，也就是打印的票完成，再去处理下一个，现在打印室打印完了会通知售票处取票。即便打印室器材坏了，售票处仍然可以继续卖票，只要把新的打印室的地址标成原来打印室的地址即可。</p>
<p>这种方式其实就是典型的AKKA实现。TicketingAgent和打印室都可以通过AKKA Actor实现。Actor之间不共享状态，只能通过不可变的message进行通信，通过actorRef来进行交流，就像上面提到的地址。这种模型满足了我们上面提到的三处改变。那么它简单到了哪里呢？</p>
<ul>
<li>不用管理锁，不用为保护共享状态殚精竭虑</li>
<li><p>不用担心死锁、race condition、或者thread starvation。</p>
<p> 那么akka中就永远不会面临锁了么？当然不是的，只是你不用直接面对它而已。归根到底所有东西都是运行在线程和低级并发原始变量上的。Akka使用java的concurrent库来协调处理message，尽少地使用锁。</p>
</li>
</ul>
<hr>
<h3 id="容灾"><a href="#容灾" class="headerlink" title="容灾"></a>容灾</h3><p>基于message的方式可以允许在系统部分失灵的情况下保证系统继续有效运行。原因之一就是独立性，<strong>每个actor并不直接进行相互之间的交互</strong>。message是被发送到mailbox里的，爱谁处理谁处理，爱咋处理咋处理，sender发完就完事儿了。同样的事儿对于调用对象方法就行不通了。</p>
<p><img src="/imgs/akka/akka1.7.png" alt="Figure 1.7 Message Passing vs. Function Calling 消息传递与方法调用流程对比"></p>
<p>独立性还带来了另外的好处。如果某个actor挂了，他的地址被另一个actor所替代，会怎样呢？只要原来的actor被新的actor正确替换了，那么所有这个地址上的message都会被归到新actor名下。错误会被包含在处理不恰当的老的actor中，而新actor只要处理之后产生的message就可以了。（在这种方式下，出错的老actor在抛出异常后就不能继续处理message了，它要<strong>自杀然后魂飞魄散</strong>）。类似Sping的这些框架在container/bean级别做了这些处理，而akka是在运行时提供的可替代性(这就是actor的let it crash思想):<strong>我们事先就做好了准备，一旦某个handler会因为某些莫须有的理由处理不好他们的任务，这时就把它的任务交给别人来避免灾难性的失败</strong>。</p>
<p>需要注意的是：这是双向的。即便是上层失败了，那么下层可以继续工作直到新的领导人来接替工作。<strong>不会有断裂的chain</strong>，开发者不用关心任何chain可能会断裂的可能性，当然也不用针对每个可能性采取相应措施。一个失败的actor被替换的过程不会影响到任何其他的合作者，见下图</p>
<p><img src="/imgs/akka/akka1.8.png" alt="Figure 1.8 Replacing a crashed printing office"><br>以上这种方案是akka中对于容错的一种方案<strong>Restart</strong> strategies,其他方案包括：<strong>Resume</strong>, <strong>Stop</strong>以及<strong>Escalate</strong>.Akka提供了选择容错方案的方法。akka控制所有的actors处理message的方式，它知道所有actor的地址，如果有异常发生，就检查一下针对这种异常应该采取怎样的容错策略并执行之。</p>
<p>容错并不意味着对所有的错误全部都完全恢复。<strong>容错系统只是保证系统在部分失灵的情况下能够依然运行</strong>。不同的错误有不同的处理策略，有的错误需要重启部分系统，有的错误或许在检查点不能处理需要上级帮忙….后面我们可以关注一下Akka怎样通过Supervision来处理这些案例。</p>
<p>拿个简单的异常处理来说，一般的程序遇到异常肯定要停下正在处理的工作，处理这个异常或者抛给上级。对于线程组之间肯定是不能共享某个异常的，除非你自己写一个这样的底层机制。异常不会被传 到产生它的线程的线程组之外，也就是说我们必须找到在不同线程组之间交流异常的其他方式。一般来说如果一个线程遇到异常基本都是忽视继续执行或者直接停止。或许你可以在log里找到一些证据证明某个thread挂掉或者停止了，但是让系统的其他部分知道这些却是比较难了。当这些线程再分不到不同的机器上的时候，事情变得更加棘手。Akka提供了一种模型来处理错误，不管actor分布在多少机器。<strong>Akka不仅仅可以很好的处理并发，对于容错同样也很在行!</strong></p>
<hr>
<h3 id="scale-up-and-out"><a href="#scale-up-and-out" class="headerlink" title="scale up and out"></a>scale up and out</h3><p>scale up :在一个server上运行更多的TicketingAgent<br>scale out : 在更多的server上运行TicketingAgent</p>
<h4 id="scale-out"><a href="#scale-out" class="headerlink" title="scale out"></a>scale out</h4><p>我们前面都是在一个JVM上运行的agent的例子。我们这次来看看怎样在多台机器上运行。<br>message的传递是通过地址来进行的，我们只需要改变地址链接actor的方式就可以了。</p>
<p><img src="/imgs/akka/akka1.9.png" alt="Figure 1.9 Transparent Remote Actors (through Proxies)"></p>
<p>akka可以给一个位于remote server上的remote actor发送message，然后再通过网络把处理结果传递回来。TicketingAgent并不知道它在命令一个远程的打印室。其实在同一个jvm运行的内存实例也是基本一致的。唯一不一样的地方就是怎样找到remote actor reference，这<strong>只要通过配置文件</strong>就可以了。也就是说，<strong>不用改变任何代码</strong>我们就可以吧scale out切换为scale up。在akka中灵活改变actor地址是非常常见的。remote actor, 集群化甚至测试工具，都会用到。</p>
<p>同样的情况，对于共享可变状态的情形可就惨了，最常见的方案就是把JVM里的状态都push到一个db里去。最大的威胁是在不得不更多地联系控制的需求下，这个db会变得越来越牛逼，而中间层就鸡肋了：所有的class都是DTO或者无状态无实际操作的东西。最让人头痛的就是当需要更多复杂的处理的时候，db同样也要面临这些改变，这将是灾难性的。还有，系统的透明度也很重要。我们希望能够很容易地追踪flow的执行进度，而不是使用精心制作的控制机制处理一片片交织在一起的复杂行为。</p>
<p>好了，贬低完了共享可变状态的不好，来看看我们牛逼的akka，你可以使用精心制作的控制系统来将错综复杂的处理逻辑不定转化为操作流。在某些架构中，message queue和web service会组合起来防止这些，但其实就是一种类似akka的模型。Akka帮我们省去了很多共享可变资源的麻烦，基于message模式，而且还可以基于同一段代码同时实现scale up和scale out。</p>
<h4 id="scale-up"><a href="#scale-up" class="headerlink" title="scale up"></a>scale up</h4><p>如果我们只想在一个机器上提升性能并scale up呢？假设我为机器新增加了几个cpu核数。在共享可变资源的情况下就是添加线程数了。但是我们都知道，锁会导致资源争夺，就是说工作的线程数总是少于总数，因为有些线程不得不相互等待。尽量少共享就是说尽量少玩儿锁，这就是message机制的目的。使用message机制可以使用更少的线程，只要优化一下处理流程和message分发，性能还胜过使用锁。<strong>每个线程都有一个用来存储运行时数据的栈</strong>。不同的操作系统的栈的大小是不一样的，比如Linux 64位的一般是256K。<strong>栈的大小是影响同时运行在某个server上线程数量的因素之一</strong>。在Linux 64系统上大约4096个线程会用掉1G的内存。</p>
<p>actor运行在一个叫做dispatcher的抽象概念上，dispatcher关注使用哪个线程模型，还有处理mailbox里的message。跟线程池处理方式很像，只是线程池只管调度，而Akka的dispatcher/mailbox结合体处理并传递message。我们可以通过配置层指定dispatch策略，<strong>不用修改任何代码</strong>。</p>
<p>actor是轻量的，因为他们运行于dispatcher之上，actor的数量不一定要跟线程数量成正比。actor比thread占用的空间要小得多，1G内存大约可以有270万个actor。针对不用的需求，有多种类型的dispatcher可选。actor之间可以共享同一个dispatcher，也可以自己有自己的。在调整性能的时候，可以通过配置灵活进行。</p>
<p>既然我们已经了解了基于message实现的并发、容错、扩展。是时候看一下akka里的具体组件了，还要了解这些组件是如果协同工作的。</p>
<h2 id="Akka-Actor-和-AkkaSystem"><a href="#Akka-Actor-和-AkkaSystem" class="headerlink" title="Akka Actor 和 AkkaSystem"></a>Akka Actor 和 AkkaSystem</h2><p>前面已经讨论了几个akka的主要概念：</p>
<ul>
<li>actor的地址是提供一个方向</li>
<li>mailbox用来临时保存message和actor自身</li>
</ul>
<p>我们下面讨论一下这些组件是怎样有机结合起来，解释一下akka底层的线程机制，并且解释一下akka怎样运行在这样的一套机制之下。Actor只是ActorSystem的一部分，ActorSystem负责提供一些组件，而且能够让actor之间相互能够找到彼此。</p>
<p>akka系统中需要保证：</p>
<ul>
<li>不存在可变共享资源</li>
<li>传递的message不可变</li>
<li>异步发送message</li>
</ul>
<p>当我们使用某个工具包或者框架的时候，这个东西肯定为我们提供了方便的直接可用的东西。像下图1.10中展示的一样，一个actor就是我们可以向他发送message的对象，我们并不关心message被怎样传递，谁来接收这些message。我们的代码只负责在接收到message之后进行对应的处理即可。还可以通过某个协议与其他人进行协作。</p>
<p>现在我们接触了actor，mailbox，address。akka是使用scala原生api构建的actor。scala API提供了actor trait给人继承来构建自己的actor。售票处就可以继承akka的Actor了，因为akka的Actor已经继承了scala的Actor trait，并且还有一些状态信息，还有一个内部队列用来存放票。address就是我们前面提到的ActorRef，也就是Actor reference的简写。这个售票处的ActorRef是给打印室发送message给售票处用的。在akka中，ActorRef有多种形式，只是不会显露出来而已。对于用户而言，只需要使用ActorRef的API就可以了。</p>
<p>下面我们通过图1.10走一个小小的例子，讲述一些我们的代码要做什么，ActorSystem会为我们做什么。<br><img src="/imgs/akka/akka1.10.png" alt="Figure 1.10 Actor Request Cycle in Action "><br>如你所见：我们向售票处actor要一个ActorRef，获取之后，就用它来发送请求，也就是买票(1至5步)。ActorSystem没有向我们暴露任何细节：怎样处理的这个request，mailbox在哪儿，message是否已经被传递了等等。</p>
<p>当然，前面我们提到的好处依然存在：我们并没有阻塞，干巴巴等待request被处理完毕；request中不包含任何共享的状态信息；实际的消息处理过程也没有对任何公共资源使用锁；我们不必搭理任何并发问题。</p>
<p>那么我们怎样从ActorSystem中获取一个ActorRef呢？ActorPath！<br><img src="/imgs/akka/akka1.11.png" alt="Figure 1.11 ActorPath URI syntax "><br>在上面的例子中，’poffice1’可以被换成’TicketingAgent2’。然后通过’TicketingAgent2’的ActorRef使用’../TicketingAgent3’还可以拿到它的兄弟节点actor的ActorRef。但是守卫actor只能是’user’。</p>
<p>akka中的<strong>监督机制</strong>就来源于这种层级制度。每个actor都自动是它的子节点的supervisor。当一个child挂了，parent就需要操心使用什么样的策略进行弥补。错误也可以被逐级向上抛出，直到上面的某个supervisor对这类错误感兴趣，处理掉。</p>
<p>akka<strong>不推荐直接通过constructor来创建actor</strong>，因为这样会破坏actor的层级。直接通过constructor创建的actor可以被直接访问并调用其方法，这也破坏了message传递过程中的并发保护。ActorSystem可以创建ActorRef，提供通用的方式来获取某个ActorRef，提供root actor来创建actor层级，并且把运行时其他组件与actor整合起来。</p>
<p>Actor的操作：</p>
<ul>
<li>CREATE<br>每个actor都可以创建自己的子actor，actor的拓扑结构是动态的。</li>
<li>SEND<br>actor之间可以异步相互发送message到彼此的mailbox里。</li>
<li>BECOME<br>actor的行为是可以动态改变的。每收到一条message，actor都可以以不同的方式处理下一条message，也就是切换它的行为，后面章节我们会遇到。</li>
<li>SUPERVISE<br>actor监控自己的子actor，并且为这些孩子擦屁股。在第三章中，我们会见识到处理message和处理error的明确不同。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我们接触了ActorSystem和Actor实现的理论与实践，见识到了akka强大的能力。下一章你会发现这么厉害的能力竟然只需消耗一点点儿能量：你可以很快的运行akka。消息管理及并发的复杂性交给akka来搞定。<br>综上：</p>
<ul>
<li>基于消息传递让并发更加简单</li>
<li>并发的同时，我们还可以很简单地scale up 和scale out</li>
<li>我们可以任意扩展应用里的request和消息处理的组件</li>
<li>基于消息传递同样解决了容错</li>
<li>监管机制提供了一个并发并且容错的模型</li>
<li>akka让我们的代码不用特别复杂，但是拥有强大的力量</li>
</ul>
<p>下一章我们会启动运行我们的第一个akka应用。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/akka/">akka</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/16/heroku上部署自己的akka项目/" title="heroku上部署自己的akka项目" itemprop="url">heroku上部署自己的akka项目</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2015-07-15T18:29:27.000Z" itemprop="datePublished"> 发表于 2015-07-16</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>heroku这个东西貌似是可以在云端发布scala项目的，我是在akka-in-action这本书遇到。既然玩儿了，就顺便记录一下。</p>
<h2 id="1-注册"><a href="#1-注册" class="headerlink" title="1. 注册"></a>1. 注册</h2><p>到heroku.com使用邮箱注册一个免费用户【注意：163邮箱被屏蔽了，我用的阿里的】</p>
<h2 id="2-安装工具"><a href="#2-安装工具" class="headerlink" title="2. 安装工具"></a>2. 安装工具</h2><p>在本地Ubuntu上安装heroku toolbelt, 可参考<a href="https://toolbelt.heroku.com/debian" target="_blank" rel="external">https://toolbelt.heroku.com/debian</a></p>
<blockquote>
<p>wget -O- <a href="https://toolbelt.heroku.com/install-ubuntu.sh" target="_blank" rel="external">https://toolbelt.heroku.com/install-ubuntu.sh</a> | sh</p>
</blockquote>
<h2 id="3-本地登录heroku："><a href="#3-本地登录heroku：" class="headerlink" title="3. 本地登录heroku："></a>3. 本地登录heroku：</h2><blockquote>
<p>heroku login</p>
</blockquote>
<h2 id="4-在heroku上建立一个app"><a href="#4-在heroku上建立一个app" class="headerlink" title="4. 在heroku上建立一个app"></a>4. 在heroku上建立一个app</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action/chapter2# heroku create</div><div class="line">Creating floating-woodland-3032... done, stack is cedar-14</div><div class="line">https://floating-woodland-3032.herokuapp.com/ | https://git.heroku.com/floating-woodland-3032.git</div><div class="line">Git remote heroku added</div></pre></td></tr></table></figure>
<p>上面执行的heroku create命令会同时在本地git配置里以heroku为名添加一个git remote。</p>
<h2 id="5-修改参数"><a href="#5-修改参数" class="headerlink" title="5. 修改参数"></a>5. 修改参数</h2><p>我们需要修改几个参数，这样heroku才知道怎样构建我们的项目。</p>
<ul>
<li>project/build.properties 【经验证，这个可以不用改】<blockquote>
<p>sbt.version=0.12.2</p>
</blockquote>
</li>
<li>project/plugins.sbt【经验证，这个可以不用改】<blockquote>
<p>resolvers += Classpaths.typesafeResolver<br>addSbtPlugin(“com.eed3si9n” % “sbt-assembly” % “0.8.7”)<br>addSbtPlugin(<br>“com.typesafe.startscript” % “xsbt-start-script-plugin” % “0.5.3”<br>)</p>
</blockquote>
</li>
</ul>
<p>以上包含了我们目前使用的所有的Plugin【貌似上面提到两个文件只是为了说明我们需要这几个依赖，但是并不严格需要弄成上面的那种】。startscript是为我们在Heroku上运行项目创建一个启动脚本用的。我们还需要项目根目录下的<strong>Procfile</strong>文件，这个文件会告诉Heroku我们的app应该运行在一个Web Dyno上。<br>可以看一下这个文件里的内容：</p>
<blockquote>
<p>web: target/start com.goticks.Main<br>这是指定了Heroku应该在启动脚本上添加的主类参数。</p>
</blockquote>
<h2 id="6-本地项目运行测试"><a href="#6-本地项目运行测试" class="headerlink" title="6. 本地项目运行测试"></a>6. 本地项目运行测试</h2><blockquote>
<p>sbt clean compile stage</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action/chapter2# sbt clean compile stage</div><div class="line">[info] Loading project definition from /root/gitLearning/akka-in-action/chapter2/project</div><div class="line">[info] Set current project to goticks (in build file:/root/gitLearning/akka-in-action/chapter2/)</div><div class="line">[success] Total time: 1 s, completed Jul 15, 2015 1:15:05 AM</div><div class="line">[info] Updating &#123;file:/root/gitLearning/akka-in-action/chapter2/&#125;chapter2...</div><div class="line">[info] Resolving jline#jline;2.12 ...</div><div class="line">[info] Done updating.</div><div class="line">[warn] Scala version was updated by one of library dependencies:</div><div class="line">[warn] 	* org.scala-lang:scala-library:(2.11.2, 2.11.1, 2.11.0) -&gt; 2.11.5</div><div class="line">[warn] To force scalaVersion, add the following:</div><div class="line">[warn] 	ivyScala := ivyScala.value map &#123; _.copy(overrideScalaVersion = true) &#125;</div><div class="line">[warn] Run &apos;evicted&apos; to see detailed eviction warnings</div><div class="line">[info] Compiling 4 Scala sources to /root/gitLearning/akka-in-action/chapter2/target/scala-2.11/classes...</div><div class="line">[warn] there was one feature warning; re-run with -feature for details</div><div class="line">[warn] one warning found</div><div class="line">[success] Total time: 41 s, completed Jul 15, 2015 1:15:47 AM</div><div class="line">[info] Wrote start script for mainClass := Some(com.goticks.Main) to /root/gitLearning/akka-in-action/chapter2/target/start</div><div class="line">[success] Total time: 1 s, completed Jul 15, 2015 1:15:47 AM</div></pre></td></tr></table></figure>
<p>这个命令是后面再heroku上会运行的，它会编译项目并创建target/start启动脚本。然后可以使用heroku的命令本地运行Procfile文件：</p>
<h2 id="7-本地启动并测试"><a href="#7-本地启动并测试" class="headerlink" title="7. 本地启动并测试"></a>7. 本地启动并测试</h2><p>使用heroku的工具foreman启动一下项目</p>
<blockquote>
<p>foreman start</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action/chapter2# foreman start</div><div class="line">01:20:02 web.1  | started with pid 7030</div><div class="line">01:20:10 web.1  | REST interface bound to /0:0:0:0:0:0:0:0:5000</div><div class="line">01:20:10 web.1  | [INFO] [07/15/2015 01:20:10.437] [goticks-akka.actor.default-dispatcher-3] [akka://goticks/user/IO-HTTP/listener-0] Bound to /0.0.0.0:5000</div></pre></td></tr></table></figure>
<p>到另一个session里测试：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~# http GET localhost:5000/events</div><div class="line">HTTP/1.1 200 OK</div><div class="line">Content-Length: 2</div><div class="line">Content-Type: application/json; charset=UTF-8</div><div class="line">Date: Wed, 15 Jul 2015 08:20:20 GMT</div><div class="line">Server: GoTicks.com REST API</div><div class="line"></div><div class="line">[]</div></pre></td></tr></table></figure></p>
<h2 id="8-部署到heroku"><a href="#8-部署到heroku" class="headerlink" title="8. 部署到heroku"></a>8. 部署到heroku</h2><blockquote>
<p>git push keroku master</p>
</blockquote>
<p>在提交了所有的本地变化后将本地项目push到git仓库的master分支，heroku会hook到这个git进程的执行，并且认出这是一个scala app。它会在云端下载所有依赖，编译代码，之后启动这个app。输出如下:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action/chapter2# git push keroku master</div><div class="line">fatal: &apos;keroku&apos; does not appear to be a git repository</div><div class="line">fatal: Could not read from remote repository.</div><div class="line"></div><div class="line">Please make sure you have the correct access rights</div><div class="line">and the repository exists.</div><div class="line">root@ubuntu:~/gitLearning/akka-in-action/chapter2# git remote</div><div class="line">heroku</div><div class="line">origin</div></pre></td></tr></table></figure></p>
<p>…..报错了。查看remote，发现已经有了heroku这个remote了。参考<a href="https://devcenter.heroku.com/articles/git，执行下列命令：" target="_blank" rel="external">https://devcenter.heroku.com/articles/git，执行下列命令：</a><br>使用 git remote -v, 查看当前项目下的remote url，确定我们的项目名称<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action/chapter2# git remote -v</div><div class="line">heroku	https://git.heroku.com/floating-woodland-3032.git (fetch)</div><div class="line">heroku	https://git.heroku.com/floating-woodland-3032.git (push)</div><div class="line">origin	https://github.com/RayRoestenburg/akka-in-action.git (fetch)</div><div class="line">origin	https://github.com/RayRoestenburg/akka-in-action.git (push)</div></pre></td></tr></table></figure></p>
<blockquote>
<p>heroku git:remote -a floating-woodland-3032</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action/chapter2# heroku git:remote -a floating-woodland-3032</div><div class="line">Installing plugin heroku-git... done</div><div class="line">set git remote heroku to https://git.heroku.com/floating-woodland-3032.git</div></pre></td></tr></table></figure>
<p>添加remote参考自: <a href="https://devcenter.heroku.com/articles/git【经后面证实，如果不**重命名**，可以不管这个，因为git" target="_blank" rel="external">https://devcenter.heroku.com/articles/git【经后面证实，如果不**重命名**，可以不管这个，因为git</a> remote -v 里已经有了。重命名使用-r other_remote_name】<br>然后再次执行push: git push heroku master<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">Counting objects: 1776, done.</div><div class="line">Delta compression using up to 2 threads.</div><div class="line">Compressing objects: 100% (791/791), done.</div><div class="line">Writing objects: 100% (1776/1776), 298.54 KiB | 0 bytes/s, done.</div><div class="line">Total 1776 (delta 564), reused 1768 (delta 561)</div><div class="line">remote: Compressing source files... done.</div><div class="line">remote: Building source:</div><div class="line">remote: </div><div class="line">remote: -----&gt; Play! app detected</div><div class="line">remote: -----&gt; Installing OpenJDK 1.6... done</div><div class="line">remote: -----&gt; WARNING: Play! version not specified in dependencies.yml. Default version: 1.3.1 being used....</div><div class="line">remote: -----&gt; Installing Play! 1.3.1.....</div><div class="line">remote: -----&gt; done</div><div class="line">remote: -----&gt; Building Play! application...</div><div class="line">remote:        ~        _            _ </div><div class="line">remote:        ~  _ __ | | __ _ _  _| |</div><div class="line">remote:        ~ | &apos;_ \| |/ _&apos; | || |_|</div><div class="line">remote:        ~ |  __/|_|\____|\__ (_)</div><div class="line">remote:        ~ |_|            |__/   </div><div class="line">remote:        ~</div><div class="line">remote:        ~ play! 1.3.1, https://www.playframework.com</div><div class="line">remote:        ~</div><div class="line">remote:        1.3.1</div><div class="line">remote:        Building Play! application at directory ./</div><div class="line">remote:        Resolving dependencies: .play/play dependencies ./ --forProd --forceCopy --silent -Duser.home=/tmp/build_4bb492e51a64b714c9d6757c67b0ccf2 2&gt;&amp;1</div><div class="line">remote:        ~ !! /tmp/build_4bb492e51a64b714c9d6757c67b0ccf2/conf/dependencies.yml does not exist</div><div class="line">remote:  !     Failed to build Play! application</div><div class="line">remote:  !     Cleared Play! framework from cache</div><div class="line">remote: </div><div class="line">remote:  !     Push rejected, failed to compile Play! app</div><div class="line">remote: </div><div class="line">remote: Verifying deploy....</div><div class="line">remote: </div><div class="line">remote: !	Push rejected to floating-woodland-3032.</div><div class="line">remote: </div><div class="line">To https://git.heroku.com/floating-woodland-3032.git</div><div class="line"> ! [remote rejected] master -&gt; master (pre-receive hook declined)</div><div class="line">error: failed to push some refs to &apos;https://git.heroku.com/floating-woodland-3032.git&apos;</div></pre></td></tr></table></figure></p>
<p>主要在于这个远程的hook拒绝了我的提交。我擦，简直不能忍！！！Google~~~因为没有成功build play，原因是没有找到play的依赖配置文件。<br>看了几个解说的，貌似是因为<strong>当前目录是一个git repository的子目录</strong>。</p>
<ul>
<li><p>下载安装一个git插件</p>
<ul>
<li>git clone <a href="https://github.com/apenwarr/git-subtree.git" target="_blank" rel="external">https://github.com/apenwarr/git-subtree.git</a></li>
<li>切换到最近的分支，执行 sh install.sh</li>
</ul>
</li>
<li><p>到git repository目录，也就是本地的git主目录下，我的机器上就是~/gitLearning/akka-in-action，执行：</p>
<blockquote>
<p>git subtree push –prefix “chapter2” heroku master</p>
</blockquote>
</li>
</ul>
<p>这个prefix是我们要push的项目相对git repository的路径。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line">git push using:  heroku master</div><div class="line">Counting objects: 201, done.</div><div class="line">Delta compression using up to 2 threads.</div><div class="line">Compressing objects: 100% (119/119), done.</div><div class="line">Writing objects: 100% (201/201), 22.30 KiB | 0 bytes/s, done.</div><div class="line">Total 201 (delta 54), reused 155 (delta 38)</div><div class="line">remote: Compressing source files... done.</div><div class="line">remote: Building source:</div><div class="line">remote: </div><div class="line">remote: -----&gt; Scala app detected</div><div class="line">remote: -----&gt; Installing OpenJDK 1.8... done</div><div class="line">remote: -----&gt; Running: sbt compile stage</div><div class="line">remote:        Downloading sbt launcher for 0.13.8:</div><div class="line">remote:          From  http://repo.typesafe.com/typesafe/ivy-releases/org.scala-sbt/sbt-launch/0.13.8/sbt-launch.jar</div><div class="line">remote:            To  /tmp/scala_buildpack_build_dir/.sbt_home/launchers/0.13.8/sbt-launch.jar</div><div class="line">remote:        Getting org.scala-sbt sbt 0.13.8 ...</div><div class="line">remote:        downloading https://repo.typesafe.com/typesafe/ivy-releases/org.scala-sbt/sbt/0.13.8/jars/sbt.jar ...</div><div class="line">remote:        	[SUCCESSFUL ] org.scala-sbt#sbt;0.13.8!sbt.jar (321ms)</div><div class="line">remote:        downloading https://repo1.maven.org/maven2/org/scala-lang/scala-library/2.10.4/scala-library-2.10.4.jar ...</div><div class="line">remote:        	[SUCCESSFUL ] org.scala-lang#scala-library;2.10.4!scala-library.jar (2957ms)</div><div class="line">remote:        downloading https://repo.typesafe.com/typesafe/ivy-releases/org.scala-sbt/main/0.13.8/jars/main.jar ...</div><div class="line">.......</div><div class="line">......</div><div class="line">remote:        	[SUCCESSFUL ] org.scala-lang#jline;2.10.4!jline.jar (73ms)</div><div class="line">remote:        downloading https://repo1.maven.org/maven2/org/fusesource/jansi/jansi/1.4/jansi-1.4.jar ...</div><div class="line">remote:        	[SUCCESSFUL ] org.fusesource.jansi#jansi;1.4!jansi.jar (49ms)</div><div class="line">remote:        :: retrieving :: org.scala-sbt#boot-scala</div><div class="line">remote:        	confs: [default]</div><div class="line">remote:        	5 artifacts copied, 0 already retrieved (24459kB/42ms)</div><div class="line">remote:        [info] Loading global plugins from /tmp/scala_buildpack_build_dir/.sbt_home/plugins</div><div class="line">remote:        [info] Updating &#123;file:/tmp/scala_buildpack_build_dir/.sbt_home/plugins/&#125;global-plugins...</div><div class="line">remote:        [info] Resolving org.scala-lang#scala-library;2.10.4 ...</div><div class="line">.......</div><div class="line">.......</div><div class="line">remote:        [info] Resolving org.fusesource.jansi#jansi;1.4 ...</div><div class="line">remote:        [info] Done updating.</div><div class="line">remote:        [info] Compiling 1 Scala source to /tmp/scala_buildpack_build_dir/.sbt_home/plugins/target/scala-2.10/sbt-0.13/classes...</div><div class="line">remote:        [error] [/tmp/scala_buildpack_build_dir/project/plugins.sbt]:3: &apos;;&apos; expected but &apos;#&apos; found.</div><div class="line">remote:        [error] [/tmp/scala_buildpack_build_dir/project/plugins.sbt]:11: &apos;;&apos; expected but &apos;#&apos; found.</div><div class="line">remote:        Project loading failed: (r)etry, (q)uit, (l)ast, or (i)gnore? </div><div class="line">remote:  !     ERROR: Failed to run sbt!</div><div class="line">remote:        We&apos;re sorry this build is failing! If you can&apos;t find the issue in application</div><div class="line">remote:        code, please submit a ticket so we can help: https://help.heroku.com</div><div class="line">remote:        You can also try reverting to the previous version of the buildpack by running:</div><div class="line">remote:        $ heroku buildpacks:set https://github.com/heroku/heroku-buildpack-scala#previous-version</div><div class="line">remote:        </div><div class="line">remote:        Thanks,</div><div class="line">remote:        Heroku</div><div class="line">remote: </div><div class="line">remote: </div><div class="line">remote:  !     Push rejected, failed to compile Scala app</div><div class="line">remote: </div><div class="line">remote: Verifying deploy....</div><div class="line">remote: </div><div class="line">remote: !	Push rejected to floating-woodland-3032.</div><div class="line">remote: </div><div class="line">To https://git.heroku.com/floating-woodland-3032.git</div><div class="line"> ! [remote rejected] 9bfe06799b9975c15c426ab17618967b7b8e65b0 -&gt; master (pre-receive hook declined)</div><div class="line">error: failed to push some refs to &apos;https://git.heroku.com/floating-woodland-3032.git&apos;</div></pre></td></tr></table></figure></p>
<p>可以看到已经成功进行项目的build了，但还是报错了。。。。从输出来看原因是project/plugins.sbt里的#应该被替换成;，好吧，我是sbt新手。。。修改后重新push<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action# git subtree push --prefix &quot;chapter2&quot; heroku master</div><div class="line">git push using:  heroku master</div><div class="line">Counting objects: 205, done.</div><div class="line">Delta compression using up to 2 threads.</div><div class="line">Compressing objects: 100% (123/123), done.</div><div class="line">Writing objects: 100% (205/205), 22.61 KiB | 0 bytes/s, done.</div><div class="line">Total 205 (delta 56), reused 155 (delta 38)</div><div class="line">remote: Compressing source files... done.</div><div class="line">remote: Building source:</div><div class="line">remote: </div><div class="line">remote: -----&gt; Scala app detected</div><div class="line">remote: -----&gt; Installing OpenJDK 1.8... done</div><div class="line">remote: -----&gt; Running: sbt compile stage</div><div class="line">remote:        Downloading sbt launcher for 0.13.8:</div><div class="line">remote:          From  http://repo.typesafe.com/typesafe/ivy-releases/org.scala-sbt/sbt-launch/0.13.8/sbt-launch.jar</div><div class="line">remote:            To  /tmp/scala_buildpack_build_dir/.sbt_home/launchers/0.13.8/sbt-launch.jar</div><div class="line">remote:        Getting org.scala-sbt sbt 0.13.8 ...</div><div class="line">remote:        downloading https://repo.typesafe.com/typesafe/ivy-releases/org.scala-sbt/sbt/0.13.8/jars/sbt.jar ...</div><div class="line">.....</div><div class="line">.....</div><div class="line">remote:        [info] downloading https://repo1.maven.org/maven2/org/scala-lang/modules/scala-parser-combinators_2.11/1.0.2/scala-parser-combinators_2.11-1.0.2.jar ...</div><div class="line">remote:        [info] 	[SUCCESSFUL ] org.scala-lang.modules#scala-parser-combinators_2.11;1.0.2!scala-parser-combinators_2.11.jar(bundle) (185ms)</div><div class="line">remote:        [info] downloading https://repo1.maven.org/maven2/jline/jline/2.12/jline-2.12.jar ...</div><div class="line">remote:        [info] 	[SUCCESSFUL ] jline#jline;2.12!jline.jar (99ms)</div><div class="line">remote:        [info] Done updating.</div><div class="line">remote:        [warn] Scala version was updated by one of library dependencies:</div><div class="line">remote:        [warn] 	* org.scala-lang:scala-library:(2.11.2, 2.11.1, 2.11.0) -&gt; 2.11.5</div><div class="line">remote:        [warn] To force scalaVersion, add the following:</div><div class="line">remote:        [warn] 	ivyScala := ivyScala.value map &#123; _.copy(overrideScalaVersion = true) &#125;</div><div class="line">remote:        [warn] Run &apos;evicted&apos; to see detailed eviction warnings</div><div class="line">remote:        [info] Compiling 4 Scala sources to /tmp/scala_buildpack_build_dir/target/scala-2.11/classes...</div><div class="line">remote:        [info] &apos;compiler-interface&apos; not yet compiled for Scala 2.11.2. Compiling...</div><div class="line">remote:        [info]   Compilation completed in 33.95 s</div><div class="line">remote:        [warn] there was one feature warning; re-run with -feature for details</div><div class="line">remote:        [warn] one warning found</div><div class="line">remote:        [success] Total time: 87 s, completed Jul 15, 2015 10:04:22 AM</div><div class="line">remote:        [info] Wrote start script for mainClass := Some(com.goticks.Main) to /tmp/scala_buildpack_build_dir/target/start</div><div class="line">remote:        [success] Total time: 1 s, completed Jul 15, 2015 10:04:22 AM</div><div class="line">remote: -----&gt; Discovering process types</div><div class="line">remote:        Procfile declares types -&gt; web</div><div class="line">remote: </div><div class="line">remote: -----&gt; Compressing... done, 165.8MB</div><div class="line">remote: -----&gt; Launching... done, v5</div><div class="line">remote:        https://floating-woodland-3032.herokuapp.com/ deployed to Heroku</div><div class="line">remote: </div><div class="line">remote: Verifying deploy.... done.</div><div class="line">To https://git.heroku.com/floating-woodland-3032.git</div><div class="line"> * [new branch]      75151c92e9b25df8462fc0422b0345cf280f01ce -&gt; master</div></pre></td></tr></table></figure></p>
<p>嘻嘻~~ 大功告成！！！现在我们的项目已经发布到<a href="https://floating-woodland-3032.herokuapp.com。" target="_blank" rel="external">https://floating-woodland-3032.herokuapp.com。</a></p>
<h2 id="9-测试"><a href="#9-测试" class="headerlink" title="9. 测试"></a>9. 测试</h2><p>我们可以使用httpie或者浏览器来测试一下<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~# http PUT https://floating-woodland-3032.herokuapp.com/events event=RHCP nrOfTickets:=10</div><div class="line">HTTP/1.1 200 OK</div><div class="line">Connection: keep-alive</div><div class="line">Content-Length: 2</div><div class="line">Content-Type: text/plain; charset=UTF-8</div><div class="line">Date: Wed, 15 Jul 2015 10:09:06 GMT</div><div class="line">Server: GoTicks.com REST API</div><div class="line">Via: 1.1 vegur</div><div class="line"></div><div class="line">OK</div><div class="line"></div><div class="line">root@ubuntu:~# http GET https://floating-woodland-3032.herokuapp.com/events event=RHCP nrOfTickets:=10</div><div class="line">HTTP/1.1 200 OK</div><div class="line">Connection: keep-alive</div><div class="line">Content-Length: 44</div><div class="line">Content-Type: application/json; charset=UTF-8</div><div class="line">Date: Wed, 15 Jul 2015 10:09:21 GMT</div><div class="line">Server: GoTicks.com REST API</div><div class="line">Via: 1.1 vegur</div><div class="line"></div><div class="line">[</div><div class="line">    &#123;</div><div class="line">        &quot;event&quot;: &quot;RHCP&quot;, </div><div class="line">        &quot;nrOfTickets&quot;: 10</div><div class="line">    &#125;</div><div class="line">]</div></pre></td></tr></table></figure></p>
<h2 id="Plus-二次提交测试"><a href="#Plus-二次提交测试" class="headerlink" title="Plus : 二次提交测试"></a>Plus : 二次提交测试</h2><p>因为还不是很熟悉heroku，自己很纳闷，如果我们远程的APP在运行状态，能否直接提交新的commit，它会自己重启吗？<br>稍微修改一下项目后，重新push上去报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action# git subtree push --prefix &quot;chapter2&quot; heroku master</div><div class="line">git push using:  heroku master</div><div class="line">To https://git.heroku.com/floating-woodland-3032.git</div><div class="line"> ! [rejected]        855562ff41e936b6769cdf808d0f798f1dbf371b -&gt; master (non-fast-forward)</div><div class="line">error: failed to push some refs to &apos;https://git.heroku.com/floating-woodland-3032.git&apos;</div><div class="line">hint: Updates were rejected because a pushed branch tip is behind its remote</div><div class="line">hint: counterpart. Check out this branch and integrate the remote changes</div><div class="line">hint: (e.g. &apos;git pull ...&apos;) before pushing again.</div><div class="line">hint: See the &apos;Note about fast-forwards&apos; in &apos;git push --help&apos; for details.</div></pre></td></tr></table></figure></p>
<p>原来是因为我刚才修改之前reset了一次，造成了commit滞后。那就先pull下来，解决冲突之后，commit再push。结果还是报同样的错误。。。。无奈，git reflog后再reset到线上的commit，重新修改后commit + push。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action# git subtree push --prefix &quot;chapter2&quot; heroku master</div><div class="line">git push using:  heroku master</div><div class="line">Everything up-to-date</div></pre></td></tr></table></figure></p>
<p>heroku这个东西是完全免费的吗？怎样关闭这个东西？它引起了我的好奇心~~~简单看了一下help，有点儿类似docker的感觉。</p>
<h2 id="PlusPlus-项目关闭"><a href="#PlusPlus-项目关闭" class="headerlink" title="PlusPlus: 项目关闭"></a>PlusPlus: 项目关闭</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action# heroku ps:stop web.1</div><div class="line">Stopping web.1 dyno... done</div><div class="line">root@ubuntu:~/gitLearning/akka-in-action# heroku ps</div><div class="line">=== web (Free): `target/start com.goticks.Main`</div><div class="line">web.1: idle 2015/07/15 03:46:31 (~ 8s ago)</div></pre></td></tr></table></figure>
<p>关闭了自己又起来了<del>~</del>靠~！！！！<br>退出登录，同样失败。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action# heroku auth:logout</div><div class="line">Local credentials cleared.</div></pre></td></tr></table></figure></p>
<p>解决方案：<br>把web节点扩展到0个。。。。。竟然是这种方式，我真是醉了。。。这时再次访问就是503了。heroku ps没有任何进程。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">root@ubuntu:~/gitLearning/akka-in-action# heroku ps:scale web=0</div><div class="line">Scaling dynos... done, now running web at 0:Free.</div></pre></td></tr></table></figure></p>
<hr>
<p>对于git子目录提交的解决，参考自：</p>
<ul>
<li><a href="https://gitlab.com/gitlab-com/support-forum/issues/40" target="_blank" rel="external">https://gitlab.com/gitlab-com/support-forum/issues/40</a></li>
<li><a href="http://stackoverflow.com/questions/14286266/deploy-play-app-on-heroku-from-a-subdirectory-of-git-repo" target="_blank" rel="external">http://stackoverflow.com/questions/14286266/deploy-play-app-on-heroku-from-a-subdirectory-of-git-repo</a></li>
<li><a href="http://stackoverflow.com/questions/17148784/play-1-2-5-application-deployment-on-heroku-oops-conf-routes-or-conf-applicati" target="_blank" rel="external">http://stackoverflow.com/questions/17148784/play-1-2-5-application-deployment-on-heroku-oops-conf-routes-or-conf-applicati</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/akka/">akka</a><a href="/tags/heroku/">heroku</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/12/flume-源码阅读笔记（5）/" title="flume 源码阅读笔记（5）" itemprop="url">flume 源码阅读笔记（5）</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2015-07-12T11:52:37.000Z" itemprop="datePublished"> 发表于 2015-07-12</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>前面分析了source的运行机制与过程，其实sink和source是很像的。</p>
<h2 id="1-入口"><a href="#1-入口" class="headerlink" title="1. 入口"></a>1. 入口</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (Entry&lt;String, SinkRunner&gt; entry : materializedConfiguration.getSinkRunners()</div><div class="line">    .entrySet()) &#123;</div><div class="line">  <span class="keyword">try</span>&#123;</div><div class="line">    supervisor.supervise(entry.getValue(),</div><div class="line">      <span class="keyword">new</span> SupervisorPolicy.AlwaysRestartPolicy(), LifecycleState.START);</div><div class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">    logger.error(<span class="string">"Error while starting &#123;&#125;"</span>, entry.getValue(), e);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>哈哈，经过上一节的流程，你是不是跟我一样信心满满啊~~ 嘻嘻—— SinkRunner</p>
<h2 id="2-SinkRunner"><a href="#2-SinkRunner" class="headerlink" title="2. SinkRunner"></a>2. SinkRunner</h2><p>同SourceRunner的身份地位是一样滴，可以理解为驱动器加管理者的角色，当channel里有event的时候就尝试消费之。不同于source的是，sink都是类似于PollableSource的这种，也就是需要自己对channel里的event进行抽取消费，因为channel里的东西不会自己sink，也不知道要sink到何处去。</p>
<ul>
<li>runner : <strong>PollingRunner</strong>    //我还需要说什么吗</li>
<li>runnerThread : Thread</li>
<li>lifecycleState : LifecycleState</li>
<li>policy : SinkProcessor</li>
</ul>
<p>入口方法start()</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">	SinkProcessor policy = getPolicy();</div><div class="line"></div><div class="line">	policy.start();</div><div class="line"></div><div class="line">	runner = <span class="keyword">new</span> PollingRunner();</div><div class="line"></div><div class="line">	runner.policy = policy;</div><div class="line">	runner.counterGroup = counterGroup;</div><div class="line">	runner.shouldStop = <span class="keyword">new</span> AtomicBoolean();</div><div class="line"></div><div class="line">	runnerThread = <span class="keyword">new</span> Thread(runner);</div><div class="line">	runnerThread.setName(<span class="string">"SinkRunner-PollingRunner-"</span> +</div><div class="line">	    policy.getClass().getSimpleName());</div><div class="line">	runnerThread.start();</div><div class="line"></div><div class="line">	lifecycleState = LifecycleState.START;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>好熟悉，完全就是PollableSourceRunner的同样思路。虽然猜到了结果，但还是要求证一下。上这个内部类PollingRunner：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">	....</div><div class="line">  <span class="keyword">while</span> (!shouldStop.get()) &#123;</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">if</span> (policy.process().equals(Sink.Status.BACKOFF)) &#123;	<span class="comment">//</span></div><div class="line">        ....</div><div class="line">      &#125; <span class="keyword">else</span> &#123;</div><div class="line">        counterGroup.set(<span class="string">"runner.backoffs.consecutive"</span>, <span class="number">0L</span>);</div><div class="line">      &#125;</div><div class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">      .....</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>好吧，还是稍微有一点点区别，我列举一下这两个PollingRunner的成员。<br>PollableSourceRunner：</p>
<ul>
<li>source : <strong>PollableSource</strong>    //内置getProcessor()接口</li>
<li>shouldStop : AtomicBoolean</li>
<li>counterGroup : CounterGroup</li>
</ul>
<p>SinkRunner:</p>
<ul>
<li>policy : <strong>SinkProcessor</strong></li>
<li>shouldStop : AtomicBoolean</li>
<li>counterGroup : CounterGroup</li>
</ul>
<p>差别就在policy和source上了，而这两者又有同样的接口API process方法来对channel里的event进行各自的处理。前面我们也分析过了source是通过channelProcessor进行实际的针对channel的操作的。</p>
<hr>
<p>这一节营养实在太少。顺便说一声CounterGroup吧，内置一个HashMap<string, atomiclong="">，做各种计数与指标统计的工作，主要当然是针对event和各个组件。</string,></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/源码/">源码</a><a href="/tags/flume/">flume</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/12/sbt使用遇到的问题-一-——repository/" title="sbt使用遇到的问题(一)——repository" itemprop="url">sbt使用遇到的问题(一)——repository</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2015-07-12T11:20:38.000Z" itemprop="datePublished"> 发表于 2015-07-12</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>你懂得，由于当前国内的网络环境，前面使用了oschina的镜像作为sbt的repository。</p>
<blockquote>
<p>[repositories]<br>local<br>osc: <a href="http://maven.oschina.net/content/groups/public/" target="_blank" rel="external">http://maven.oschina.net/content/groups/public/</a><br>oschina-ivy: <a href="http://maven.oschina.net/content/groups/public/" target="_blank" rel="external">http://maven.oschina.net/content/groups/public/</a>, [organization]/[module]/(scala<em>[scalaVersion]/)(sbt</em>[sbtVersion]/)[revision]/[type]s/<a href="-[classifier]">artifact</a>.[ext]<br>typesafe: <a href="http://repo.typesafe.com/typesafe/ivy-releases/" target="_blank" rel="external">http://repo.typesafe.com/typesafe/ivy-releases/</a>, [organization]/[module]/(scala<em>[scalaVersion]/)(sbt</em>[sbtVersion]/)[revision]/[type]s/<a href="-[classifier]">artifact</a>.[ext], bootOnly<br>#sonatype-oss-releases<br>#maven-central<br>#sonatype-oss-snapshots</p>
</blockquote>
<p>配置了以上文件repositories后，把它放到~/.sbt/下就可以了。也可以自己制定配置文件的地址。具体可参考：<a href="http://www.scala-sbt.org/0.13/docs/Proxy-Repositories.html" target="_blank" rel="external">http://www.scala-sbt.org/0.13/docs/Proxy-Repositories.html</a></p>
<p>但是最近一段时间貌似oschina不再提供maven镜像库的服务了，而最近自己又想学习akka，尝试了好多次都是下面的输出：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div></pre></td><td class="code"><pre><div class="line">compile</div><div class="line">[info] Updating &#123;file:/root/gitLearning/akka-in-action/chapter-channels/&#125;channels...</div><div class="line">[info] Resolving org.scala-lang#scala-library;2.11.6 ...</div><div class="line">[warn] 	module not found: org.scala-lang#scala-library;2.11.6</div><div class="line">[warn] ==== local: tried</div><div class="line">[warn]   /root/.ivy2/local/org.scala-lang/scala-library/2.11.6/ivys/ivy.xml</div><div class="line">[info] Resolving com.typesafe.akka#akka-actor_2.11;2.3.10 ...</div><div class="line">[warn] 	module not found: com.typesafe.akka#akka-actor_2.11;2.3.10</div><div class="line">[warn] ==== local: tried</div><div class="line">[warn]   /root/.ivy2/local/com.typesafe.akka/akka-actor_2.11/2.3.10/ivys/ivy.xml</div><div class="line">[info] Resolving com.typesafe.akka#akka-slf4j_2.11;2.3.10 ...</div><div class="line">[warn] 	module not found: com.typesafe.akka#akka-slf4j_2.11;2.3.10</div><div class="line">[warn] ==== local: tried</div><div class="line">[warn]   /root/.ivy2/local/com.typesafe.akka/akka-slf4j_2.11/2.3.10/ivys/ivy.xml</div><div class="line">[info] Resolving com.typesafe.akka#akka-remote_2.11;2.3.10 ...</div><div class="line">[warn] 	module not found: com.typesafe.akka#akka-remote_2.11;2.3.10</div><div class="line">[warn] ==== local: tried</div><div class="line">[warn]   /root/.ivy2/local/com.typesafe.akka/akka-remote_2.11/2.3.10/ivys/ivy.xml</div><div class="line">[info] Resolving com.typesafe.akka#akka-multi-node-testkit_2.11;2.3.10 ...</div><div class="line">[warn] 	module not found: com.typesafe.akka#akka-multi-node-testkit_2.11;2.3.10</div><div class="line">[warn] ==== local: tried</div><div class="line">[warn]   /root/.ivy2/local/com.typesafe.akka/akka-multi-node-testkit_2.11/2.3.10/ivys/ivy.xml</div><div class="line">[info] Resolving com.typesafe.akka#akka-contrib_2.11;2.3.10 ...</div><div class="line">[warn] 	module not found: com.typesafe.akka#akka-contrib_2.11;2.3.10</div><div class="line">[warn] ==== local: tried</div><div class="line">[warn]   /root/.ivy2/local/com.typesafe.akka/akka-contrib_2.11/2.3.10/ivys/ivy.xml</div><div class="line">[info] Resolving com.typesafe.akka#akka-remote-tests_2.11;2.3.10 ...</div><div class="line">[warn] 	module not found: com.typesafe.akka#akka-remote-tests_2.11;2.3.10</div><div class="line">[warn] ==== local: tried</div><div class="line">[warn]   /root/.ivy2/local/com.typesafe.akka/akka-remote-tests_2.11/2.3.10/ivys/ivy.xml</div><div class="line">[info] Resolving com.typesafe.akka#akka-testkit_2.11;2.3.10 ...</div><div class="line">[warn] 	module not found: com.typesafe.akka#akka-testkit_2.11;2.3.10</div><div class="line">[warn] ==== local: tried</div><div class="line">[warn]   /root/.ivy2/local/com.typesafe.akka/akka-testkit_2.11/2.3.10/ivys/ivy.xml</div><div class="line">[info] Resolving org.scalatest#scalatest_2.11;2.2.0 ...</div><div class="line">[warn] 	module not found: org.scalatest#scalatest_2.11;2.2.0</div><div class="line">[warn] ==== local: tried</div><div class="line">[warn]   /root/.ivy2/local/org.scalatest/scalatest_2.11/2.2.0/ivys/ivy.xml</div><div class="line">[info] Resolving org.scala-lang#scala-compiler;2.11.6 ...</div><div class="line">[warn] 	module not found: org.scala-lang#scala-compiler;2.11.6</div><div class="line">[warn] ==== local: tried</div><div class="line">[warn]   /root/.ivy2/local/org.scala-lang/scala-compiler/2.11.6/ivys/ivy.xml</div><div class="line">[warn] 	::::::::::::::::::::::::::::::::::::::::::::::</div><div class="line">[warn] 	::          UNRESOLVED DEPENDENCIES         ::</div><div class="line">[warn] 	::::::::::::::::::::::::::::::::::::::::::::::</div><div class="line">[warn] 	:: org.scala-lang#scala-library;2.11.6: not found</div><div class="line">[warn] 	:: com.typesafe.akka#akka-actor_2.11;2.3.10: not found</div><div class="line">[warn] 	:: com.typesafe.akka#akka-slf4j_2.11;2.3.10: not found</div><div class="line">[warn] 	:: com.typesafe.akka#akka-remote_2.11;2.3.10: not found</div><div class="line">[warn] 	:: com.typesafe.akka#akka-multi-node-testkit_2.11;2.3.10: not found</div><div class="line">[warn] 	:: com.typesafe.akka#akka-contrib_2.11;2.3.10: not found</div><div class="line">[warn] 	:: com.typesafe.akka#akka-remote-tests_2.11;2.3.10: not found</div><div class="line">[warn] 	:: com.typesafe.akka#akka-testkit_2.11;2.3.10: not found</div><div class="line">[warn] 	:: org.scalatest#scalatest_2.11;2.2.0: not found</div><div class="line">[warn] 	:: org.scala-lang#scala-compiler;2.11.6: not found</div><div class="line">[warn] 	::::::::::::::::::::::::::::::::::::::::::::::</div><div class="line">[warn] </div><div class="line">[warn] 	Note: Unresolved dependencies path:</div><div class="line">[warn] 		com.typesafe.akka:akka-contrib_2.11:2.3.10 (/root/gitLearning/akka-in-action/chapter-channels/build.sbt#L14)</div><div class="line">[warn] 		  +- manning:akka-sample-multi-node-scala_2.11:0.1-SNAPSHOT</div><div class="line">[warn] 		com.typesafe.akka:akka-remote-tests_2.11:2.3.10 (/root/gitLearning/akka-in-action/chapter-channels/build.sbt#L14)</div><div class="line">[warn] 		  +- manning:akka-sample-multi-node-scala_2.11:0.1-SNAPSHOT</div><div class="line">[warn] 		com.typesafe.akka:akka-remote_2.11:2.3.10 (/root/gitLearning/akka-in-action/chapter-channels/build.sbt#L14)</div><div class="line">[warn] 		  +- manning:akka-sample-multi-node-scala_2.11:0.1-SNAPSHOT</div><div class="line">[warn] 		com.typesafe.akka:akka-actor_2.11:2.3.10 (/root/gitLearning/akka-in-action/chapter-channels/build.sbt#L14)</div><div class="line">[warn] 		  +- manning:akka-sample-multi-node-scala_2.11:0.1-SNAPSHOT</div><div class="line">[warn] 		com.typesafe.akka:akka-testkit_2.11:2.3.10 (/root/gitLearning/akka-in-action/chapter-channels/build.sbt#L14)</div><div class="line">[warn] 		  +- manning:akka-sample-multi-node-scala_2.11:0.1-SNAPSHOT</div><div class="line">[warn] 		org.scala-lang:scala-library:2.11.6 ((sbt.Classpaths) Defaults.scala#L1203)</div><div class="line">[warn] 		  +- manning:akka-sample-multi-node-scala_2.11:0.1-SNAPSHOT</div><div class="line">[warn] 		com.typesafe.akka:akka-slf4j_2.11:2.3.10 (/root/gitLearning/akka-in-action/chapter-channels/build.sbt#L14)</div><div class="line">[warn] 		  +- manning:akka-sample-multi-node-scala_2.11:0.1-SNAPSHOT</div><div class="line">[warn] 		com.typesafe.akka:akka-multi-node-testkit_2.11:2.3.10 (/root/gitLearning/akka-in-action/chapter-channels/build.sbt#L14)</div><div class="line">[warn] 		  +- manning:akka-sample-multi-node-scala_2.11:0.1-SNAPSHOT</div><div class="line">[warn] 		org.scalatest:scalatest_2.11:2.2.0 (/root/gitLearning/akka-in-action/chapter-channels/build.sbt#L14)</div><div class="line">[warn] 		  +- manning:akka-sample-multi-node-scala_2.11:0.1-SNAPSHOT</div><div class="line">[warn] 		org.scala-lang:scala-compiler:2.11.6</div><div class="line">[warn] 		  +- manning:akka-sample-multi-node-scala_2.11:0.1-SNAPSHOT</div><div class="line">[trace] Stack trace suppressed: run last *:update for the full output.</div><div class="line">[error] (*:update) sbt.ResolveException: unresolved dependency: org.scala-lang#scala-library;2.11.6: not found</div><div class="line">[error] unresolved dependency: com.typesafe.akka#akka-actor_2.11;2.3.10: not found</div><div class="line">[error] unresolved dependency: com.typesafe.akka#akka-slf4j_2.11;2.3.10: not found</div><div class="line">[error] unresolved dependency: com.typesafe.akka#akka-remote_2.11;2.3.10: not found</div><div class="line">[error] unresolved dependency: com.typesafe.akka#akka-multi-node-testkit_2.11;2.3.10: not found</div><div class="line">[error] unresolved dependency: com.typesafe.akka#akka-contrib_2.11;2.3.10: not found</div><div class="line">[error] unresolved dependency: com.typesafe.akka#akka-remote-tests_2.11;2.3.10: not found</div><div class="line">[error] unresolved dependency: com.typesafe.akka#akka-testkit_2.11;2.3.10: not found</div><div class="line">[error] unresolved dependency: org.scalatest#scalatest_2.11;2.2.0: not found</div><div class="line">[error] unresolved dependency: org.scala-lang#scala-compiler;2.11.6: not found</div><div class="line">[error] Total time: 0 s, completed Jul 11, 2015 5:13:57 PM</div></pre></td></tr></table></figure></p>
<p>今儿灵机一动，想到了会不会是oschina镜像库的问题(尼玛，都忘记了以前自己跟sbt配置过oschina的镜像了)。打开配置文件~~~ 果然如此。。。这里感觉sbt稍微有点儿不好了，看日志也没看到它去哪个网址下载库的，maven库路径是没有输出的，如果没有经验的人看这些东西压根儿看不出啥来。</p>
<p>解决方式： 把原来配置的repositories文件重命名bak一下，重新到项目路径下启动sbt，再次compile：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">compile</div><div class="line">[info] Updating &#123;file:/root/gitLearning/akka-in-action/chapter-channels/&#125;channels...</div><div class="line">[info] Resolving org.sonatype.oss#oss-parent;7 ...</div><div class="line">[info] downloading https://repo1.maven.org/maven2/org/scala-lang/scala-library/2.11.6/scala-library-2.11.6.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] org.scala-lang#scala-library;2.11.6!scala-library.jar (142453ms)</div><div class="line">[info] downloading https://repo1.maven.org/maven2/com/typesafe/akka/akka-actor_2.11/2.3.10/akka-actor_2.11-2.3.10.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] com.typesafe.akka#akka-actor_2.11;2.3.10!akka-actor_2.11.jar (67998ms)</div><div class="line">[info] downloading https://repo1.maven.org/maven2/com/typesafe/akka/akka-slf4j_2.11/2.3.10/akka-slf4j_2.11-2.3.10.jar ...</div><div class="line">[info] 	[SUCCESSFUL ] com.typesafe.akka#akka-slf4j_2.11;2.3.10!akka-slf4j_2.11.jar (1201ms)</div><div class="line">[info] downloading https://repo1.maven.org/maven2/com/typesafe/akka/akka-remote_2.11/2.3.10/akka-remote_2.11-2.3.10.jar ...</div><div class="line">....</div><div class="line">[info] Done updating.</div><div class="line">[info] Compiling 3 Scala sources to /root/gitLearning/akka-in-action/chapter-channels/target/scala-2.11/classes...</div><div class="line">[info] &apos;compiler-interface&apos; not yet compiled for Scala 2.11.6. Compiling...</div><div class="line">[info]   Compilation completed in 20.627 s</div><div class="line">[success] Total time: 1518 s, completed Jul 11, 2015 5:41:41 PM</div></pre></td></tr></table></figure></p>
<p>额，好吧。成功的时候才会显示地址~<br>成功了再看这个有毛线作用啊~</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/scala/">scala</a><a href="/tags/sbt/">sbt</a><a href="/tags/repository/">repository</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/10/flume-源码阅读笔记（4）/" title="flume-源码阅读笔记（4）" itemprop="url">flume-源码阅读笔记（4）</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2015-07-09T19:53:24.000Z" itemprop="datePublished"> 发表于 2015-07-10</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>这一章详细分析一下source的运行方式</p>
<h2 id="1-入口"><a href="#1-入口" class="headerlink" title="1. 入口"></a>1. 入口</h2><p>前面我们提到了source的启动入口为：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> (Entry&lt;String, SourceRunner&gt; entry : materializedConfiguration</div><div class="line">        .getSourceRunners().entrySet()) &#123;</div><div class="line">      <span class="keyword">try</span>&#123;</div><div class="line">        logger.info(<span class="string">"Starting Source "</span> + entry.getKey());</div><div class="line">        <span class="comment">// 下面这行就会以每3秒一次的频率调用SourceRunner</span></div><div class="line">        supervisor.supervise(entry.getValue(),</div><div class="line">          <span class="keyword">new</span> SupervisorPolicy.AlwaysRestartPolicy(), LifecycleState.START);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">        logger.error(<span class="string">"Error while starting &#123;&#125;"</span>, entry.getValue(), e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>注意，上面的value不是Source，而是SourceRunner，那么我们的中心就围绕它展开了。</p>
<h2 id="2-SourceRunner"><a href="#2-SourceRunner" class="headerlink" title="2. SourceRunner"></a>2. SourceRunner</h2><p>简而言之就是source的驱动器和控制器，对source进行了一层包裹。根据source的不同分为PollableSourceRunner和EventDrivenSourceRunner。</p>
<p>先看一下SourceRunner的元素：</p>
<ul>
<li>source : Source</li>
<li>forSource(Source)<br> 静态工厂方法，根据传入的source的类型实例化SourceRunner的实例，也就是上面提到的两种</li>
</ul>
<p>PollableSourceRunner管理的是<strong>PollableSource</strong>，这种source是需要外界来抽取event的，例如KafkaSource，需要去消费。</p>
<p>EventDrivenSourceRunner管理的是<strong>EventDrivenSource</strong>，这种source自己就满足消息机制，可以向channel产生event，不需要外界来抽取。 很容易看出来，这种是稍微省心点儿的~~~</p>
<p>SourceRunner里的元素比较少，还是分析它的两个子类吧。为方便对比，先看稍微简单一些的</p>
<p>###　EventDrivenSourceRunner<br>元素只有一个lifecycleState : LifecycleState<br>启动代码：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">    Source source = getSource();</div><div class="line">    ChannelProcessor cp = source.getChannelProcessor();</div><div class="line">    cp.initialize();	<span class="comment">// 初始化interceptorChain</span></div><div class="line">    source.start();		<span class="comment">// 启动source</span></div><div class="line">    lifecycleState = LifecycleState.START;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>上面可见，source是在这里启动的。我们来参照一个具体实现ExecSource：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">   executor = Executors.newSingleThreadExecutor();</div><div class="line"></div><div class="line">   <span class="comment">// 好，我们发现了一个Runnable</span></div><div class="line">   runner = <span class="keyword">new</span> ExecRunnable(shell, command, getChannelProcessor(), sourceCounter,</div><div class="line">       restart, restartThrottle, logStderr, bufferCount, batchTimeout, charset);</div><div class="line"></div><div class="line">   <span class="comment">// <span class="doctag">FIXME:</span> Use a callback-like executor / future to signal us upon failure.</span></div><div class="line">   runnerFuture = executor.submit(runner);</div><div class="line"></div><div class="line">   <span class="comment">/*</span></div><div class="line">    * NB: This comes at the end rather than the beginning of the method because</div><div class="line">    * it sets our state to running. We want to make sure the executor is alive</div><div class="line">    * and well first.</div><div class="line">    */</div><div class="line">   sourceCounter.start();</div><div class="line">   <span class="keyword">super</span>.start();</div><div class="line"></div><div class="line">   logger.debug(<span class="string">"Exec source started"</span>);</div><div class="line"> &#125;</div></pre></td></tr></table></figure></p>
<p>看一下上面代码里的runnable：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">do</span> &#123;</div><div class="line">        .......</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          <span class="comment">// fork进程，执行shell</span></div><div class="line">          <span class="keyword">if</span>(shell != <span class="keyword">null</span>) &#123;</div><div class="line">            String[] commandArgs = formulateShellCommand(shell, command);</div><div class="line">            process = Runtime.getRuntime().exec(commandArgs);</div><div class="line">          &#125;  <span class="keyword">else</span> &#123;</div><div class="line">            String[] commandArgs = command.split(<span class="string">"\\s+"</span>);</div><div class="line">            process = <span class="keyword">new</span> ProcessBuilder(commandArgs).start();</div><div class="line">          &#125;</div><div class="line">          ....</div><div class="line"></div><div class="line">          <span class="comment">// 首先如果当前eventList不为空，先处理</span></div><div class="line">          future = timedFlushService.scheduleWithFixedDelay(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">              <span class="meta">@Override</span></div><div class="line">              <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">                <span class="keyword">try</span> &#123;</div><div class="line">                  <span class="keyword">synchronized</span> (eventList) &#123;</div><div class="line">                    <span class="keyword">if</span>(!eventList.isEmpty() &amp;&amp; timeout()) &#123;</div><div class="line">                      flushEventBatch(eventList); <span class="comment">// 批处理咯</span></div><div class="line">                    &#125;</div><div class="line">                  &#125;</div><div class="line">                &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">                  ...</div><div class="line">                &#125;</div><div class="line">              &#125;</div><div class="line">          &#125;,</div><div class="line">          batchTimeout, batchTimeout, TimeUnit.MILLISECONDS);</div><div class="line"></div><div class="line">          <span class="comment">// 读取shell进程输出	</span></div><div class="line">          <span class="keyword">while</span> ((line = reader.readLine()) != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">synchronized</span> (eventList) &#123;</div><div class="line">              sourceCounter.incrementEventReceivedCount();</div><div class="line">              eventList.add(EventBuilder.withBody(line.getBytes(charset)));</div><div class="line">              <span class="keyword">if</span>(eventList.size() &gt;= bufferCount || timeout()) &#123;</div><div class="line">                flushEventBatch(eventList); <span class="comment">// 批处理咯</span></div><div class="line">              &#125;</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">         .....</div><div class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">          ....</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">         ....</div><div class="line">        &#125;</div><div class="line">        ......</div><div class="line">      &#125; <span class="keyword">while</span>(restart);</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>前面总是看到ChannelProcessor，还被迷惑地以为这个东西是给channel用的，后来自己才想明白，<strong>channel只是个容器</strong>。主动方应该是Source和Sink才对。。。果然，ChannelProcessor是给Source用的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">flushEventBatch</span><span class="params">(List&lt;Event&gt; eventList)</span></span>&#123;</div><div class="line">      channelProcessor.processEventBatch(eventList);</div><div class="line">      sourceCounter.addToEventAcceptedCount(eventList.size());</div><div class="line">      eventList.clear();</div><div class="line">      lastPushToChannel = systemClock.currentTimeMillis();</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>ChannelProcessor提供的元素如下：</p>
<ul>
<li>interceptorChain : InterceptorChain</li>
<li>selector : ChannelSelector</li>
<li>processEventBatch(List<event>)</event></li>
<li>processEvent(Event)</li>
</ul>
<p>PS: 猛然发现，前面其实我们已经通过channelProcessor的initialize方法初始化了<strong>interceptorChain</strong>，没错，interceptor就是交给它管理的。因为ChannelProcessor是处理event的实际作用点，所以对于event的过滤与处理也应该是在这里。</p>
<p><strong>event处理流程</strong>：</p>
<ul>
<li>通过interceptor</li>
<li>分类到各个channel -&gt; 通过channelSelector找到对应关系</li>
<li>遍历channel，调用对应的transaction及其方法，进行put操作，关闭事务</li>
</ul>
<p>展示一下事务这部分，以便联想起前面总结的事务部分内容，也可以串起来：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processEvent</span><span class="params">(Event event)</span> </span>&#123;</div><div class="line">	...</div><div class="line">	<span class="comment">// Process required channels</span></div><div class="line">    List&lt;Channel&gt; requiredChannels = selector.getRequiredChannels(event);</div><div class="line">    <span class="keyword">for</span> (Channel reqChannel : requiredChannels) &#123;</div><div class="line">      Transaction tx = reqChannel.getTransaction();</div><div class="line">      Preconditions.checkNotNull(tx, <span class="string">"Transaction object must not be null"</span>);</div><div class="line">      <span class="keyword">try</span> &#123;</div><div class="line">        tx.begin(); <span class="comment">// 开始</span></div><div class="line"></div><div class="line">        <span class="comment">// 这里就是调用前面提到BasicTransactionSemantics的API了</span></div><div class="line">        reqChannel.put(event); </div><div class="line"></div><div class="line">        tx.commit();	<span class="comment">//提交</span></div><div class="line">      &#125; <span class="keyword">catch</span> (Throwable t) &#123;</div><div class="line">        tx.rollback();	<span class="comment">// 回滚</span></div><div class="line">        ....</div><div class="line">      &#125; <span class="keyword">finally</span> &#123;</div><div class="line">        <span class="keyword">if</span> (tx != <span class="keyword">null</span>) &#123;</div><div class="line">          tx.close();	<span class="comment">// 关闭</span></div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">    ...</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="PollableSourceRunner"><a href="#PollableSourceRunner" class="headerlink" title="PollableSourceRunner"></a>PollableSourceRunner</h3><p>元素：</p>
<ul>
<li>runner : <strong>PollingRunner</strong>   // 关键就在这上面了</li>
<li>runnerThread : Thread</li>
<li>lifecycleState : LifecycleState</li>
<li>shouldStop : AtomicBoolean</li>
</ul>
<p>看一下它实现的start方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">PollableSource source = (PollableSource) getSource();</div><div class="line">   ChannelProcessor cp = source.getChannelProcessor();</div><div class="line">   cp.initialize();</div><div class="line">   source.start();</div><div class="line"></div><div class="line">   <span class="comment">// 至此前面与EventDrivenSourceRunner的处理是一模一样的</span></div><div class="line"></div><div class="line">   runner = <span class="keyword">new</span> PollingRunner();</div><div class="line"></div><div class="line">   runner.source = source;</div><div class="line">   runner.counterGroup = counterGroup;</div><div class="line">   runner.shouldStop = shouldStop;</div><div class="line"></div><div class="line">   runnerThread = <span class="keyword">new</span> Thread(runner);</div><div class="line">   runnerThread.setName(getClass().getSimpleName() + <span class="string">"-"</span> + </div><div class="line">       source.getClass().getSimpleName() + <span class="string">"-"</span> + source.getName());</div><div class="line">   runnerThread.start();</div><div class="line"></div><div class="line">   lifecycleState = LifecycleState.START;</div></pre></td></tr></table></figure></p>
<p>可以看到，后面起了一个线程，runnable就是PollingRunner。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">		....</div><div class="line">      <span class="keyword">while</span> (!shouldStop.get()) &#123;</div><div class="line">        ......</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">          <span class="keyword">if</span> (source.process().equals(PollableSource.Status.BACKOFF)) &#123; <span class="comment">//只有一行关键</span></div><div class="line">            ...</div><div class="line">          &#125; <span class="keyword">else</span> &#123;</div><div class="line">            counterGroup.set(<span class="string">"runner.backoffs.consecutive"</span>, <span class="number">0L</span>);</div><div class="line">          &#125;</div><div class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">          ......</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div></pre></td></tr></table></figure>
<p>明白了哈？就是执行了一下PollableSource里的process方法。前面提到了，这个接口的子类并非自身就是消息驱动的那种，<strong>需要别人来抽取event</strong>。所以前面的东西只是做准备，而PollingRunner来负责event的抽取以及将event放入channel的工作。</p>
<p>再次找个实现类，KafkaSource<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> Status <span class="title">process</span><span class="params">()</span> <span class="keyword">throws</span> EventDeliveryException </span>&#123;</div><div class="line">	....</div><div class="line">    <span class="keyword">try</span> &#123;</div><div class="line">      <span class="keyword">while</span> (eventList.size() &lt; batchUpperLimit &amp;&amp;</div><div class="line">              System.currentTimeMillis() &lt; batchEndTime) &#123;</div><div class="line">        iterStatus = hasNext();</div><div class="line">        <span class="keyword">if</span> (iterStatus) &#123;</div><div class="line">          <span class="comment">// get next message</span></div><div class="line">          MessageAndMetadata&lt;<span class="keyword">byte</span>[], <span class="keyword">byte</span>[]&gt; messageAndMetadata = it.next();</div><div class="line">          kafkaMessage = messageAndMetadata.message();</div><div class="line">          kafkaKey = messageAndMetadata.key();</div><div class="line"></div><div class="line">          <span class="comment">// Add headers to event (topic, timestamp, and key)</span></div><div class="line">          headers = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</div><div class="line">          headers.put(KafkaSourceConstants.TIMESTAMP,</div><div class="line">                  String.valueOf(System.currentTimeMillis()));</div><div class="line">          headers.put(KafkaSourceConstants.TOPIC, topic);</div><div class="line">          <span class="keyword">if</span> (kafkaKey != <span class="keyword">null</span>) &#123;</div><div class="line">            headers.put(KafkaSourceConstants.KEY, <span class="keyword">new</span> String(kafkaKey));</div><div class="line">          &#125;</div><div class="line">          <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">            log.debug(<span class="string">"Message: &#123;&#125;"</span>, <span class="keyword">new</span> String(kafkaMessage));</div><div class="line">          &#125;</div><div class="line">          event = EventBuilder.withBody(kafkaMessage, headers);</div><div class="line">          eventList.add(event);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      .....</div><div class="line">      <span class="keyword">if</span> (eventList.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">        getChannelProcessor().processEventBatch(eventList);</div><div class="line">        counter.addToEventAcceptedCount(eventList.size());</div><div class="line">        eventList.clear();</div><div class="line">        <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</div><div class="line">          log.debug(<span class="string">"Wrote &#123;&#125; events to channel"</span>, eventList.size());</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">if</span> (!kafkaAutoCommitEnabled) &#123;</div><div class="line">          <span class="comment">// commit the read transactions to Kafka to avoid duplicates</span></div><div class="line">          <span class="keyword">long</span> commitStartTime = System.nanoTime();</div><div class="line">          consumer.commitOffsets();</div><div class="line">          <span class="keyword">long</span> commitEndTime = System.nanoTime();</div><div class="line">          counter.addToKafkaCommitTimer((commitEndTime-commitStartTime)/(<span class="number">1000</span>*<span class="number">1000</span>));</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      ......</div><div class="line">      <span class="keyword">return</span> Status.READY;</div><div class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">      ......</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>看了这段代码后，可确定kafka的event就是由PollingRunner搞的。另外发现一个事儿，就是<strong>ChannelProcessor专门负责处理event后，放入channel</strong>。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/源码/">源码</a><a href="/tags/flume/">flume</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/10/flume-源码阅读笔记（3）/" title="flume源码阅读笔记 （3）" itemprop="url">flume源码阅读笔记 （3）</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2015-07-09T16:13:12.000Z" itemprop="datePublished"> 发表于 2015-07-10</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>前面介绍了几个关键组件以及相互的关系，这次我们来看看flume里对于事务的封装与处理。</p>
<h2 id="Transaction"><a href="#Transaction" class="headerlink" title="Transaction"></a>Transaction</h2><h3 id="BasicTransactionSemantics"><a href="#BasicTransactionSemantics" class="headerlink" title="BasicTransactionSemantics"></a>BasicTransactionSemantics</h3><ul>
<li>state : State //NEW, OPEN, COMPLETED, CLOSED</li>
<li>initialThreadId : long //记录创建它的ThreadId</li>
<li>begin()</li>
<li>commit()</li>
<li>rollback()</li>
<li>close()</li>
<li>put(Event)</li>
<li>take()<br>An implementation of basic Transaction semantics designed to work in concert with <strong>BasicChannelSemantics</strong> to simplify creation of robust Channel implementations. This class ensures that each transaction implementation method is called <strong>only while the transaction is in the correct state for that method, and only by the thread that created the transaction</strong>. Nested calls to begin() and close() are supported as long as they are balanced. </li>
</ul>
<p>是基本Transaction的实现，与<strong>BasicChannelSemantics</strong>配合。这个类保证transaction实现方法<strong>只在当前transaction适当的状态下触发，而且只能被创建当前transaction的线程触发</strong>。</p>
<p>Subclasses need only implement <strong>doPut, doTake, doCommit</strong>, and <strong>doRollback</strong>, and the developer can rest assured that those methods are called only after transaction state preconditions have been properly met. <strong>doBegin</strong> and <strong>doClose</strong> may also be implemented if there is work to be done at those points. </p>
<p>子类只需要实现<strong>doPut, doTake, doCommit</strong>以及<strong>doRollback</strong>方法，同时开发人员还需要保证只有在transaction的state被正确的修改后，才能触发这些方法。如果有必要的话，也可以实现<strong>doBegin</strong>和<strong>doClose</strong>方法。</p>
<p>All InterruptedException exceptions thrown from the implementations of the doXXX methods are automatically wrapped to become ChannelExceptions, but only after restoring the interrupted status of the thread so that any subsequent blocking method calls will themselves throw InterruptedException rather than blocking. The exception to this rule is doTake, which simply returns null instead of wrapping and propagating the InterruptedException, though it still first restores the interrupted status of the thread.<br>当doXXX方法发生异常的时候，首先把当前线程的状态修改为interrupted，然后把所有的InterruptedException转化为ChannelException抛出，这样后面的方法就不会阻塞住。doTake就遵循这样的规则，首先把线程状态改为interrupted，然后不包装以及传递InterruptedException，而是返回null。</p>
<hr>
<h2 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h2><h3 id="BasicChannelSemantics"><a href="#BasicChannelSemantics" class="headerlink" title="BasicChannelSemantics"></a>BasicChannelSemantics</h3><ul>
<li>currentTransaction : <strong>ThreadLocal</strong>&lt;BasicTransactionSemantics&gt;</li>
<li>put(Event)</li>
<li>take()</li>
<li>getTransaction()</li>
</ul>
<hr>
<h2 id="实现类MemoryTransaction在MemoryChannel里的使用"><a href="#实现类MemoryTransaction在MemoryChannel里的使用" class="headerlink" title="实现类MemoryTransaction在MemoryChannel里的使用"></a>实现类MemoryTransaction在MemoryChannel里的使用</h2><h3 id="MemoryTransaction"><a href="#MemoryTransaction" class="headerlink" title="MemoryTransaction"></a>MemoryTransaction</h3><ul>
<li>takeList : LinkedBlockingDeque<event> // 消费者的队列</event></li>
<li>putList : LinkedBlockingDeque<event>  // 生产者的队列</event></li>
<li>putByteCounter : int</li>
<li>takeByteCounter : int</li>
<li>channelCounter : ChannelCounter</li>
</ul>
<p>event放入channel<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPut</span><span class="params">(Event event)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">      channelCounter.incrementEventPutAttemptCount();</div><div class="line">      <span class="keyword">int</span> eventByteSize = (<span class="keyword">int</span>)Math.ceil(estimateEventSize(event)/byteCapacitySlotSize);</div><div class="line">      <span class="keyword">if</span> (!putList.offer(event)) &#123;    <span class="comment">// 放入生产者队列</span></div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ChannelException(</div><div class="line">          <span class="string">"Put queue for MemoryTransaction of capacity "</span> +</div><div class="line">            putList.size() + <span class="string">" full, consider committing more frequently, "</span> +</div><div class="line">            <span class="string">"increasing capacity or increasing thread count"</span>);</div><div class="line">      &#125;</div><div class="line">      putByteCounter += eventByteSize;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>消费channel里的event<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> Event <span class="title">doTake</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">      channelCounter.incrementEventTakeAttemptCount();</div><div class="line">      <span class="keyword">if</span>(takeList.remainingCapacity() == <span class="number">0</span>) &#123;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ChannelException(<span class="string">"Take list for MemoryTransaction, capacity "</span> +</div><div class="line">            takeList.size() + <span class="string">" full, consider committing more frequently, "</span> +</div><div class="line">            <span class="string">"increasing capacity, or increasing thread count"</span>);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span>(!queueStored.tryAcquire(keepAlive, TimeUnit.SECONDS)) &#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">      &#125;</div><div class="line">      Event event;</div><div class="line">      <span class="keyword">synchronized</span>(queueLock) &#123;</div><div class="line">        event = queue.poll(); <span class="comment">// 从channel中消费一条数据</span></div><div class="line">      &#125;</div><div class="line">      Preconditions.checkNotNull(event, <span class="string">"Queue.poll returned NULL despite semaphore "</span> +</div><div class="line">          <span class="string">"signalling existence of entry"</span>);</div><div class="line">      takeList.put(event);    <span class="comment">// 放入Transaction的消费者队列</span></div><div class="line"></div><div class="line">      <span class="keyword">int</span> eventByteSize = (<span class="keyword">int</span>)Math.ceil(estimateEventSize(event)/byteCapacitySlotSize);</div><div class="line">      takeByteCounter += eventByteSize;</div><div class="line"></div><div class="line">      <span class="keyword">return</span> event;</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>提交事务：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doCommit</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">      ...</div><div class="line">        <span class="keyword">if</span>(!queueRemaining.tryAcquire(-remainingChange, keepAlive, TimeUnit.SECONDS)) &#123;</div><div class="line">          bytesRemaining.release(putByteCounter);</div><div class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> ChannelFullException(<span class="string">"Space for commit to queue couldn't be acquired."</span> +</div><div class="line">              <span class="string">" Sinks are likely not keeping up with sources, or the buffer size is too tight"</span>);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">int</span> puts = putList.size();</div><div class="line">      <span class="keyword">int</span> takes = takeList.size();</div><div class="line">      <span class="keyword">synchronized</span>(queueLock) &#123;</div><div class="line">        <span class="keyword">if</span>(puts &gt; <span class="number">0</span> ) &#123;</div><div class="line">          <span class="keyword">while</span>(!putList.isEmpty()) &#123;</div><div class="line">           <span class="comment">//这里的queue是MemoryChannel的Event队列，也就是将这段时间put的event放进channel的意思了</span></div><div class="line">            <span class="keyword">if</span>(!queue.offer(putList.removeFirst())) &#123;</div><div class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Queue add failed, this shouldn't be able to happen"</span>);</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">        putList.clear();</div><div class="line">        takeList.clear();</div><div class="line">      &#125;</div><div class="line">      bytesRemaining.release(takeByteCounter);</div><div class="line">      takeByteCounter = <span class="number">0</span>;</div><div class="line">      putByteCounter = <span class="number">0</span>;</div><div class="line"></div><div class="line">      queueStored.release(puts);</div><div class="line">      <span class="keyword">if</span>(remainingChange &gt; <span class="number">0</span>) &#123;</div><div class="line">        queueRemaining.release(remainingChange);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (puts &gt; <span class="number">0</span>) &#123;</div><div class="line">        channelCounter.addToEventPutSuccessCount(puts);</div><div class="line">      &#125;</div><div class="line">      <span class="keyword">if</span> (takes &gt; <span class="number">0</span>) &#123;</div><div class="line">        channelCounter.addToEventTakeSuccessCount(takes);</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      channelCounter.setChannelSize(queue.size());</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>回滚代码, 可想而知，肯定是回复channel之前的状态，将刚刚消费出来的东西塞回去，塞进去的东西拿出来：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRollback</span><span class="params">()</span> </span>&#123;</div><div class="line">      <span class="keyword">int</span> takes = takeList.size();</div><div class="line">      <span class="keyword">synchronized</span>(queueLock) &#123;</div><div class="line">        <span class="comment">// 检查还能不能塞回去了</span></div><div class="line">        Preconditions.checkState(queue.remainingCapacity() &gt;= takeList.size(), <span class="string">"Not enough space in memory channel "</span> +</div><div class="line">            <span class="string">"queue to rollback takes. This should never happen, please report"</span>);</div><div class="line">        <span class="keyword">while</span>(!takeList.isEmpty()) &#123;</div><div class="line">          queue.addFirst(takeList.removeLast()); <span class="comment">//消费的event塞回去</span></div><div class="line">        &#125;</div><div class="line">        putList.clear();<span class="comment">//这是要塞进去的event清空</span></div><div class="line">      &#125;</div><div class="line">      bytesRemaining.release(putByteCounter);</div><div class="line">      putByteCounter = <span class="number">0</span>;</div><div class="line">      takeByteCounter = <span class="number">0</span>;</div><div class="line"></div><div class="line">      queueStored.release(takes);</div><div class="line">      channelCounter.setChannelSize(queue.size());</div><div class="line">    &#125;</div></pre></td></tr></table></figure></p>
<p>这里比较容易看到的是，<strong>如果塞了一半报错，会出现一些rollback差错</strong>，因为已经放进去的，并没有拿出来。如果需要实现的话，其实应该在放的时候起一个<strong>计数器</strong>，然后rollback的时候按照数量先往外拿，然后再把前面拿出来的放回去~~~~嘿嘿,是不是可以提交到社区 ^ _ ^</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/源码/">源码</a><a href="/tags/flume/">flume</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/09/搭建Kafka源码调试环境/" title="搭建Kafka源码调试环境" itemprop="url">搭建Kafka源码调试环境</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2015-07-08T16:14:06.000Z" itemprop="datePublished"> 发表于 2015-07-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h1 id="简单流程"><a href="#简单流程" class="headerlink" title="简单流程"></a>简单流程</h1><ol>
<li>git clone <a href="https://github.com/apache/kafka.git" target="_blank" rel="external">https://github.com/apache/kafka.git</a></li>
<li>git tag -l 瞅准0.8.2.1</li>
<li>git checkout 0.8.2.1 -b will0821</li>
<li><a href="http://gradle.org/下载安装gradle，也为自己的IDE安装gradle插件【对gradle不是特别了解，所以多用插件】。我下载的是gradle2.5，解压后需要在IDE里指定GRADLE_HOME变量。" target="_blank" rel="external">http://gradle.org/下载安装gradle，也为自己的IDE安装gradle插件【对gradle不是特别了解，所以多用插件】。我下载的是gradle2.5，解压后需要在IDE里指定GRADLE_HOME变量。</a><br>Eclipse是通过gradle EnIDE的配置窗口指定的。其他请自行解决。<br><img src="/imgs/eclipse_ide_gradle.png" alt="Figure  - eclipse截图"></li>
<li>build，尝试运行</li>
</ol>
<hr>
<h1 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h1><ul>
<li>我用的是eclipse，报错<strong>“找不到或无法加载主类”</strong>，按照这个思路去Google，没有找到实际能解决的办法。此时注意到eclipse的下方Maker里有一条错误提示<strong>“scalatest_2.10-1.9.1.jar of core build path is cross-compiled with an incompatible version of Scala (2.10.0)”</strong>，找到官方JIRA提供的解决方案 <a href="https://issues.apache.org/jira/browse/KAFKA-1873。将kafka下的**gradle.properties**里scalaVersion从2.10.4修改到2.11.5即可。猜测这个文件应该是类似于maven里的build配置项。" target="_blank" rel="external">https://issues.apache.org/jira/browse/KAFKA-1873。将kafka下的**gradle.properties**里scalaVersion从2.10.4修改到2.11.5即可。猜测这个文件应该是类似于maven里的build配置项。</a><br>重新build一把，再次执行入口类Kafka即可。</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/08/flume-源码阅读笔记（1）/" title="flume 源码阅读笔记（1）" itemprop="url">flume 源码阅读笔记（1）</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2015-07-08T12:15:48.000Z" itemprop="datePublished"> 发表于 2015-07-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>#1 . 启动脚本<br>最开始肯定是从启动脚本flume-ng下手了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">FLUME_AGENT_CLASS=&quot;org.apache.flume.node.Application&quot; # 这个是主要入口</div><div class="line">FLUME_AVRO_CLIENT_CLASS=&quot;org.apache.flume.client.avro.AvroCLIClient&quot;</div><div class="line">FLUME_VERSION_CLASS=&quot;org.apache.flume.tools.VersionInfo&quot;</div><div class="line">FLUME_TOOLS_CLASS=&quot;org.apache.flume.tools.FlumeToolsMain&quot;</div></pre></td></tr></table></figure></p>
<hr>
<p>#2. 主程序入口Application<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div></pre></td><td class="code"><pre><div class="line">Options options = <span class="keyword">new</span> Options();</div><div class="line">..... <span class="comment">//一大堆命令行参数</span></div><div class="line"></div><div class="line"> CommandLineParser parser = <span class="keyword">new</span> GnuParser();</div><div class="line"> CommandLine commandLine = parser.parse(options, args);</div><div class="line"> <span class="comment">// 以上两行，对命令行参数解析完毕</span></div><div class="line"></div><div class="line"> <span class="comment">// 打印帮助信息</span></div><div class="line"> <span class="keyword">if</span> (commandLine.hasOption(<span class="string">'h'</span>)) &#123;</div><div class="line">   <span class="keyword">new</span> HelpFormatter().printHelp(<span class="string">"flume-ng agent"</span>, options, <span class="keyword">true</span>);</div><div class="line">   <span class="keyword">return</span>;</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> String agentName = commandLine.getOptionValue(<span class="string">'n'</span>);</div><div class="line"> <span class="keyword">boolean</span> reload = !commandLine.hasOption(<span class="string">"no-reload-conf"</span>);</div><div class="line"></div><div class="line"> <span class="comment">// 是否有zookeeper的相关配置</span></div><div class="line"> <span class="keyword">if</span> (commandLine.hasOption(<span class="string">'z'</span>) || commandLine.hasOption(<span class="string">"zkConnString"</span>)) &#123;</div><div class="line">   isZkConfigured = <span class="keyword">true</span>;</div><div class="line"> &#125;</div><div class="line"> </div><div class="line"> <span class="comment">// 主角登场</span></div><div class="line"> Application application = <span class="keyword">null</span>;</div><div class="line"> <span class="keyword">if</span> (isZkConfigured) &#123;</div><div class="line">   <span class="comment">// get options</span></div><div class="line">   String zkConnectionStr = commandLine.getOptionValue(<span class="string">'z'</span>);</div><div class="line">   String baseZkPath = commandLine.getOptionValue(<span class="string">'p'</span>);</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (reload) &#123;</div><div class="line">     EventBus eventBus = <span class="keyword">new</span> EventBus(agentName + <span class="string">"-event-bus"</span>);</div><div class="line">     List&lt;LifecycleAware&gt; components = Lists.newArrayList();</div><div class="line">     PollingZooKeeperConfigurationProvider zookeeperConfigurationProvider =</div><div class="line">       <span class="keyword">new</span> PollingZooKeeperConfigurationProvider(</div><div class="line">         agentName, zkConnectionStr, baseZkPath, eventBus);</div><div class="line">     components.add(zookeeperConfigurationProvider);</div><div class="line">     application = <span class="keyword">new</span> Application(components);</div><div class="line">     eventBus.register(application);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">     StaticZooKeeperConfigurationProvider zookeeperConfigurationProvider =</div><div class="line">       <span class="keyword">new</span> StaticZooKeeperConfigurationProvider(</div><div class="line">         agentName, zkConnectionStr, baseZkPath);</div><div class="line">     application = <span class="keyword">new</span> Application();</div><div class="line">     application.handleConfigurationEvent(zookeeperConfigurationProvider</div><div class="line">       .getConfiguration());</div><div class="line">   &#125;</div><div class="line"> &#125; <span class="keyword">else</span> &#123;</div><div class="line">   File configurationFile = <span class="keyword">new</span> File(commandLine.getOptionValue(<span class="string">'f'</span>));</div><div class="line">   <span class="comment">/*</span></div><div class="line">    * 如果配置文件不存在，就直接报错</div><div class="line">    */</div><div class="line">   <span class="keyword">if</span> (!configurationFile.exists()) &#123;</div><div class="line">     ...</div><div class="line">   &#125;</div><div class="line">   List&lt;LifecycleAware&gt; components = Lists.newArrayList();</div><div class="line"></div><div class="line">   <span class="keyword">if</span> (reload) &#123;</div><div class="line">     EventBus eventBus = <span class="keyword">new</span> EventBus(agentName + <span class="string">"-event-bus"</span>);</div><div class="line">     PollingPropertiesFileConfigurationProvider configurationProvider =</div><div class="line">       <span class="keyword">new</span> PollingPropertiesFileConfigurationProvider(</div><div class="line">         agentName, configurationFile, eventBus, <span class="number">30</span>);</div><div class="line">     components.add(configurationProvider);</div><div class="line">     application = <span class="keyword">new</span> Application(components);</div><div class="line">     eventBus.register(application);</div><div class="line">   &#125; <span class="keyword">else</span> &#123;</div><div class="line">     PropertiesFileConfigurationProvider configurationProvider =</div><div class="line">       <span class="keyword">new</span> PropertiesFileConfigurationProvider(</div><div class="line">         agentName, configurationFile);</div><div class="line">     <span class="comment">// 下面为典型启动过程</span></div><div class="line">     application = <span class="keyword">new</span> Application();</div><div class="line">     application.handleConfigurationEvent(configurationProvider</div><div class="line">       .getConfiguration());</div><div class="line">   &#125;</div><div class="line"> &#125;</div><div class="line"> application.start(); <span class="comment">// 程序启动</span></div><div class="line"></div><div class="line"> <span class="comment">// 后面是shutdown hook，作清理工作</span></div></pre></td></tr></table></figure></p>
<p>综上来看，有营养的代码很少，就是读个配置文件，然后直接就启动程序了。那么application的初始化和start方法里都有些什么操作呢？</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"> <span class="comment">// 1. 构造方法里只是注册一个LifecycleSupervisor，也就是管理生命周期的</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Application</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>(<span class="keyword">new</span> ArrayList&lt;LifecycleAware&gt;(<span class="number">0</span>));</div><div class="line"> &#125;</div><div class="line"></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="title">Application</span><span class="params">(List&lt;LifecycleAware&gt; components)</span> </span>&#123;</div><div class="line">   <span class="keyword">this</span>.components = components;</div><div class="line">   supervisor = <span class="keyword">new</span> LifecycleSupervisor();</div><div class="line"> &#125;</div><div class="line"></div><div class="line"><span class="comment">// 2. 根据conf重启所有components</span></div><div class="line"> <span class="meta">@Subscribe</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">handleConfigurationEvent</span><span class="params">(MaterializedConfiguration conf)</span> </span>&#123;</div><div class="line">   stopAllComponents();</div><div class="line">   startAllComponents(conf); <span class="comment">// 这个conf来自于配置文件，你懂得，这些component肯定就是source channel sink 之类的了</span></div><div class="line"> &#125;</div><div class="line"> </div><div class="line"> <span class="comment">// 3. 使用1中初始化的supervisor对所有component进行监管</span></div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">   <span class="keyword">for</span>(LifecycleAware component : components) &#123;</div><div class="line">     supervisor.supervise(component,</div><div class="line">         <span class="keyword">new</span> SupervisorPolicy.AlwaysRestartPolicy(), LifecycleState.START);</div><div class="line">   &#125;</div><div class="line"> &#125;</div></pre></td></tr></table></figure>
<p>好，启动component的入口也明晰了<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startAllComponents</span><span class="params">(MaterializedConfiguration materializedConfiguration)</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">for</span> (Entry&lt;String, Channel&gt; entry :</div><div class="line">      materializedConfiguration.getChannels().entrySet()) &#123;</div><div class="line">      <span class="keyword">try</span>&#123;</div><div class="line">        logger.info(<span class="string">"Starting Channel "</span> + entry.getKey());</div><div class="line">        <span class="comment">// 1. 将channel交给supervisor来进行生命周期管理，这里是启动</span></div><div class="line">        supervisor.supervise(entry.getValue(),</div><div class="line">            <span class="keyword">new</span> SupervisorPolicy.AlwaysRestartPolicy(), LifecycleState.START);</div><div class="line">      &#125; <span class="keyword">catch</span> (Exception e)&#123;</div><div class="line">        logger.error(<span class="string">"Error while starting &#123;&#125;"</span>, entry.getValue(), e);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 2. 启动sink 和 souce之前，确保所有的channel无误地启动完毕</span></div><div class="line">    <span class="keyword">for</span>(Channel ch: materializedConfiguration.getChannels().values())&#123;</div><div class="line">      <span class="keyword">while</span>(ch.getLifecycleState() != LifecycleState.START</div><div class="line">          &amp;&amp; !supervisor.isComponentInErrorState(ch))&#123;</div><div class="line">          logger.info(<span class="string">"Waiting for channel: "</span> + ch.getName() +</div><div class="line">              <span class="string">" to start. Sleeping for 500 ms"</span>);</div><div class="line">          Thread.sleep(<span class="number">500</span>);</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 3. 同上方式，启动sink</span></div><div class="line">    </div><div class="line">    <span class="comment">// 4. 同上方式，启动source</span></div><div class="line"></div><div class="line">    <span class="comment">// 监控： 目前支持ganlia和http jetty两种，需要在命令行指定type</span></div><div class="line">    <span class="comment">// $ bin/flume-ng agent --conf-file example.conf --name a1 -Dflume.monitoring.type=ganglia -Dflume.monitoring.hosts=com.example:1234,com.example2:5455</span></div><div class="line">    <span class="keyword">this</span>.loadMonitoring();</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>至此启动流程就完毕了。太简单了也~~~</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/源码/">源码</a><a href="/tags/flume/">flume</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/07/08/flume-源码阅读笔记（2）/" title="flume 源码阅读笔记（2）" itemprop="url">flume 源码阅读笔记（2）</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2015-07-08T12:15:48.000Z" itemprop="datePublished"> 发表于 2015-07-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>通过寻找LifecycleAware的子类就可以发现，所有flume的component都继承了这个接口。下面是几个主要的</p>
<hr>
<h1 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h1><p>连接source和sink，可以看做是MQ或者buffer，保证自身线程安全。<br>实在是懒得翻译，直接copy文档<br>A channel <strong>connects</strong> a Source to a Sink. The source acts as producer while the sink acts as a consumer of events. The channel itself is the <strong>buffer</strong> between the two.<br>A channel exposes a <strong>Transaction</strong> interface that can be used by its clients to ensure <strong>atomic</strong> put and take semantics. This is necessary to guarantee single hop reliability between agents. For instance, a source will successfully produce an event if and only if that event can be committed to the source’s associated channel. Similarly, a sink will consume an event if and only if its respective endpoint can accept the event. The extent of transaction support varies for different channel implementations ranging from strong to best-effort semantics.<br>Channels are associated with <strong>unique names</strong> that can be used for separating configuration and working namespaces.<br>Channels must be <strong>thread safe</strong>, protecting any internal invariants as no guarantees are given as to when and by how many sources/sinks they may be simultaneously accessed by. </p>
<pre><code>*  Transaction getTransaction()
*  put(Event event)
*  Event take() 
</code></pre><hr>
<h1 id="Sink"><a href="#Sink" class="headerlink" title="Sink"></a>Sink</h1><p>连接channel，然后消费channel里的内容，根据sink类型的不同，把这些message发往不同的目的地。<br>可以根据不同的行为使用<strong>SinkGroup</strong>和<strong>SinkProcessor</strong>来为Sink分组。<strong>SinkRunner</strong>通过processor定期轮询他们。</p>
<pre><code>*  Status process() 
    在某个transaction范围内消费channel里的message，如果transaction成功，就提交。若没成功，需要**回滚**这个transaction。
要确保这个方法只有一个线程调用
*   Channel getChannel()
*  setChannel(Channel channel)
</code></pre><hr>
<h1 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h1><p>A source generates {@plainlink Event <strong>events</strong>} and calls methods on the configured <strong>ChannelProcessor</strong> to persist those events into the configured channels.<br>Sources are associated with <strong>unique names</strong> that can be used for separating configuration and working namespaces.<br>不用搭理线程安全。</p>
<pre><code>* ChannelProcessor getChannelProcessor()
* setChannelProcessor(ChannelProcessor channelProcessor)
</code></pre><hr>
<h1 id="SinkProcessor"><a href="#SinkProcessor" class="headerlink" title="SinkProcessor"></a>SinkProcessor</h1><p>Interface for a device that allows abstraction of the behavior of multiple sinks, always assigned to a SinkRunner 。<br>A sink processors <strong>SinkProcessor.process()</strong> method will only be accessed by a <strong>single</strong> runner thread. However configuration methods such as Configurable.configure may be concurrently accessed.</p>
<pre><code>*  Status process() 
    Handle a request to **poll the owned sinks**.The processor is expected to call **Sink.process()** on whatever sink(s) appropriate, handling failures as appropriate and throwing EventDeliveryException when there is a failure to deliver any events according to the delivery policy defined by the sink processor implementation. See specific implementations of this interface for delivery behavior and policies.
*  setSinks(List&lt;Sink&gt; sinks)
</code></pre><p>看起来这个processor有些像wrapper + manager的意思。</p>
<hr>
<h1 id="SinkSelector"><a href="#SinkSelector" class="headerlink" title="SinkSelector"></a>SinkSelector</h1><p>An interface that allows the <strong>LoadBalancingSinkProcessor</strong> to use a load-balancing strategy such as round-robin, random distribution etc. Implementations of this class can be plugged into the system via <strong>processor configuration</strong> and are used to select a sink on every invocation.<br>An instance of the configured sink selector is create during the processor configuration, its setSinks(List) method is invoked following which it is configured via a subcontext. Once configured, <strong>the lifecycle of this selector is tied to the lifecycle of the sink processor</strong>.<br>At runtime, the processor invokes the createSinkIterator() method for every process call to create  <strong>an iteration order over the available sinks</strong>. The processor then loops through this iteration order until one of the sinks succeeds in processing the event. If the iterator is exhausted and none of the sinks succeed, the processor will raise an EventDeliveryException. </p>
<pre><code>*  setSinks(List&lt;Sink&gt; sinks)
*  Iterator&lt;Sink&gt; createSinkIterator()
*  void informSinkFailed(Sink failedSink)
</code></pre><hr>
<h1 id="SourceRunner"><a href="#SourceRunner" class="headerlink" title="SourceRunner"></a>SourceRunner</h1><p>A source runner controls <strong>how a source is driven</strong>. This is an abstract class used for instantiating derived classes.</p>
<pre><code>*  Source source
*  SourceRunner forSource(Source source)  
    根据source类型实例化SourceRunner实现类的静态工厂方法
</code></pre><hr>
<h1 id="SinkRunner"><a href="#SinkRunner" class="headerlink" title="SinkRunner"></a>SinkRunner</h1><p>A <strong>driver</strong> for sinks that polls them, attempting to process events if any are available in the Channel.<br>Note that, unlike sources, all sinks are polled.</p>
<pre><code>*  Thread runnerThread
*  LifecycleState lifecycleState
*  **SinkProcessor** policy
*  CounterGroup counterGroup
*  PollingRunner runner
</code></pre><p>轮询调用sink的驱动器，如果channel里有任何可用的event，都会尝试执行。与source不同，所有的sink都会被涉及。Runner像是Processor的Wrapper。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Override</span></div><div class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">    SinkProcessor policy = getPolicy();</div><div class="line">    policy.start();</div><div class="line">    runner = <span class="keyword">new</span> PollingRunner(); <span class="comment">//封装shouldStop决定是否运行</span></div><div class="line">    runner.policy = policy;</div><div class="line">    runner.counterGroup = counterGroup;</div><div class="line">    runner.shouldStop = <span class="keyword">new</span> AtomicBoolean();</div><div class="line">    runnerThread = <span class="keyword">new</span> Thread(runner);</div><div class="line">    runnerThread.setName(<span class="string">"SinkRunner-PollingRunner-"</span> +</div><div class="line">        policy.getClass().getSimpleName());</div><div class="line">    runnerThread.start();</div><div class="line">    lifecycleState = LifecycleState.START;</div><div class="line">  &#125;</div></pre></td></tr></table></figure>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/源码/">源码</a><a href="/tags/flume/">flume</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/23/"><span></span>Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/22/">22</a><a class="page-number" href="/page/23/">23</a><span class="page-number current">24</span><a class="page-number" href="/page/25/">25</a><a class="extend next" rel="next" href="/page/25/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  

  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/youdaonote/" title="youdaonote">youdaonote<sup>187</sup></a></li>
			
		
			
				<li><a href="/tags/源码/" title="源码">源码<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/akka/" title="akka">akka<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/flume/" title="flume">flume<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/ETL/" title="ETL">ETL<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/solr/" title="solr">solr<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/spring/" title="spring">spring<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/调度平台/" title="调度平台">调度平台<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/azkaban/" title="azkaban">azkaban<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/mysql/" title="mysql">mysql<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/scala/" title="scala">scala<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/ambari/" title="ambari">ambari<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/quartz/" title="quartz">quartz<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/django/" title="django">django<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/架构/" title="架构">架构<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/架构，jaeger/" title="架构，jaeger">架构，jaeger<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ember/" title="ember">ember<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/nodejs/" title="nodejs">nodejs<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/R/" title="R">R<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/guava/" title="guava">guava<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://github.com/willcup" target="_blank" title=" 我自己的github">github</a>
            
          </li>
        
          <li>
            
            	<a href="http://thisding.com" target="_blank" title="朋友的主页">Steven&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Will Chen in MeiTuan. <br/>
			元 亨 利 贞.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:chenxin15@meituan.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2018 
		
		<a href="/about" target="_blank" title="Will Chen">Will Chen</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fe6d1f421bbc9962127a50488f9ed37d1' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
