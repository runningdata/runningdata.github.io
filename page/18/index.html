
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?5b99dfd487346155d274c0c49c3fb869";
      var s = document.getElementsByTagName("script")[0]; 
      s.parentNode.insertBefore(hm, s);
    })();
  </script>

  
    <title>Will&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Will Chen">
    

    
    <meta name="description" content="左右水色 右手天光">
<meta property="og:type" content="website">
<meta property="og:title" content="Will's Blog">
<meta property="og:url" content="http://willcup.com/page/18/index.html">
<meta property="og:site_name" content="Will's Blog">
<meta property="og:description" content="左右水色 右手天光">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Will's Blog">
<meta name="twitter:description" content="左右水色 右手天光">

    
    <link rel="alternative" href="/atom.xml" title="Will&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Will&#39;s Blog" title="Will&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Will&#39;s Blog">Will&#39;s Blog</a></h1>
				<h2 class="blog-motto">简易 变易 不易</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:willcup.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/05/cas-4.2.6-server配置与http支持/" title="cas-4.2.6-server配置与http支持" itemprop="url">cas-4.2.6-server配置与http支持</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-12-05T09:11:31.000Z" itemprop="datePublished"> 发表于 2016-12-05</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p>下载cas-server-webapp-4.2.6.war，放置到tomcat9的webapps下。</p>
<p>开始使用的tomcat7，结果报错：Unable to process Jar entry。查了一下是tomcat版本过低的原因。</p>
<p>启动tomcat，确认war正常解压，cas server正常启动。<br>关闭tomcat。</p>
<h2 id="编辑"><a href="#编辑" class="headerlink" title="编辑"></a>编辑</h2><p>cas的主要配置文件在于deployerConfigContext.xml。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span></div><div class="line">       <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">       <span class="attr">xmlns:context</span>=<span class="string">"http://www.springframework.org/schema/context"</span></div><div class="line">       <span class="attr">xmlns:p</span>=<span class="string">"http://www.springframework.org/schema/p"</span></div><div class="line">       <span class="attr">xmlns:c</span>=<span class="string">"http://www.springframework.org/schema/c"</span></div><div class="line">       <span class="attr">xmlns:aop</span>=<span class="string">"http://www.springframework.org/schema/aop"</span></div><div class="line">       <span class="attr">xmlns:tx</span>=<span class="string">"http://www.springframework.org/schema/tx"</span></div><div class="line">       <span class="attr">xmlns:util</span>=<span class="string">"http://www.springframework.org/schema/util"</span></div><div class="line">       <span class="attr">xmlns:sec</span>=<span class="string">"http://www.springframework.org/schema/security"</span></div><div class="line">       <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span></div><div class="line">       http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx.xsd</div><div class="line">       http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop.xsd</div><div class="line">       http://www.springframework.org/schema/context http://www.springframework.org/schema/context/spring-context.xsd</div><div class="line">       http://www.springframework.org/schema/security http://www.springframework.org/schema/security/spring-security.xsd</div><div class="line">       http://www.springframework.org/schema/util http://www.springframework.org/schema/util/spring-util.xsd"&gt;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">util:map</span> <span class="attr">id</span>=<span class="string">"authenticationHandlersResolvers"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key-ref</span>=<span class="string">"proxyAuthenticationHandler"</span> <span class="attr">value-ref</span>=<span class="string">"proxyPrincipalResolver"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key-ref</span>=<span class="string">"primaryAuthenticationHandler"</span> <span class="attr">value-ref</span>=<span class="string">"primaryPrincipalResolver"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">util:map</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">util:list</span> <span class="attr">id</span>=<span class="string">"authenticationMetadataPopulators"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"successfulHandlerMetaDataPopulator"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"rememberMeAuthenticationMetaDataPopulator"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">util:list</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"attributeRepository"</span> <span class="attr">class</span>=<span class="string">"org.jasig.services.persondir.support.NamedStubPersonAttributeDao"</span></span></div><div class="line">          <span class="attr">p:backingMap-ref</span>=<span class="string">"attrRepoBackingMap"</span> /&gt;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- 设置数据源 --&gt;</span></div><div class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://127.0.0.1:3306/metamap1?useUnicode=true&amp;amp;characterEncoding=utf8"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"primaryAuthenticationHandler"</span></span></div><div class="line">      <span class="attr">class</span>=<span class="string">"com.will.cas.auth.WillAuthenticationHandler"</span></div><div class="line">      <span class="attr">p:dataSource-ref</span>=<span class="string">"dataSource"</span></div><div class="line">      /&gt;</div><div class="line"></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- &lt;alias name="acceptUsersAuthenticationHandler" alias="primaryAuthenticationHandler" /&gt; --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"personDirectoryPrincipalResolver"</span> <span class="attr">alias</span>=<span class="string">"primaryPrincipalResolver"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">util:map</span> <span class="attr">id</span>=<span class="string">"attrRepoBackingMap"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"uid"</span> <span class="attr">value</span>=<span class="string">"uid"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"eduPersonAffiliation"</span> <span class="attr">value</span>=<span class="string">"eduPersonAffiliation"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"groupMembership"</span> <span class="attr">value</span>=<span class="string">"groupMembership"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">entry</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">key</span>&gt;</span><span class="tag">&lt;<span class="name">value</span>&gt;</span>memberOf<span class="tag">&lt;/<span class="name">value</span>&gt;</span><span class="tag">&lt;/<span class="name">key</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>faculty<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>staff<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">value</span>&gt;</span>org<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">entry</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">util:map</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"serviceThemeResolver"</span> <span class="attr">alias</span>=<span class="string">"themeResolver"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- &lt;alias name="jsonServiceRegistryDao" alias="serviceRegistryDao" /&gt; --&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!-- 注册服务 --&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"serviceRegistryDao"</span> <span class="attr">class</span>=<span class="string">"org.jasig.cas.services.InMemoryServiceRegistryDaoImpl"</span></span></div><div class="line">             <span class="attr">p:registeredServices-ref</span>=<span class="string">"registeredServicesList"</span> /&gt;</div><div class="line"> </div><div class="line">     <span class="tag">&lt;<span class="name">util:list</span> <span class="attr">id</span>=<span class="string">"registeredServicesList"</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.jasig.cas.services.RegexRegisteredService"</span></span></div><div class="line">               <span class="attr">p:id</span>=<span class="string">"0"</span> <span class="attr">p:name</span>=<span class="string">"HTTP and IMAP"</span> <span class="attr">p:description</span>=<span class="string">"Allows HTTP(S) and IMAP(S) protocols"</span></div><div class="line">               <span class="attr">p:serviceId</span>=<span class="string">"^(https?|http?|imaps?)://.*"</span> <span class="attr">p:evaluationOrder</span>=<span class="string">"10000001"</span> /&gt;</div><div class="line">     <span class="tag">&lt;/<span class="name">util:list</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"defaultTicketRegistry"</span> <span class="attr">alias</span>=<span class="string">"ticketRegistry"</span> /&gt;</span></div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"ticketGrantingTicketExpirationPolicy"</span> <span class="attr">alias</span>=<span class="string">"grantingTicketExpirationPolicy"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"multiTimeUseOrTimeoutExpirationPolicy"</span> <span class="attr">alias</span>=<span class="string">"serviceTicketExpirationPolicy"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"anyAuthenticationPolicy"</span> <span class="attr">alias</span>=<span class="string">"authenticationPolicy"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"acceptAnyAuthenticationPolicyFactory"</span> <span class="attr">alias</span>=<span class="string">"authenticationPolicyFactory"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"auditTrailManager"</span></span></div><div class="line">          <span class="attr">class</span>=<span class="string">"org.jasig.inspektr.audit.support.Slf4jLoggingAuditTrailManager"</span></div><div class="line">          <span class="attr">p:entrySeparator</span>=<span class="string">"$&#123;cas.audit.singleline.separator:|&#125;"</span></div><div class="line">          <span class="attr">p:useSingleLine</span>=<span class="string">"$&#123;cas.audit.singleline:false&#125;"</span>/&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"neverThrottle"</span> <span class="attr">alias</span>=<span class="string">"authenticationThrottle"</span> /&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">util:list</span> <span class="attr">id</span>=<span class="string">"monitorsList"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"memoryMonitor"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"sessionMonitor"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">util:list</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"defaultPrincipalFactory"</span> <span class="attr">alias</span>=<span class="string">"principalFactory"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"defaultAuthenticationTransactionManager"</span> <span class="attr">alias</span>=<span class="string">"authenticationTransactionManager"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"defaultPrincipalElectionStrategy"</span> <span class="attr">alias</span>=<span class="string">"principalElectionStrategy"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"tgcCipherExecutor"</span> <span class="attr">alias</span>=<span class="string">"defaultCookieCipherExecutor"</span> /&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>cas提供了几种连接数据库验证的实现，但是对于我们验证django用户的需求不适合，因为django用户的密码的加密salt是动态的。如果是简单的数据库用户验证，可以参考：<a href="https://apereo.github.io/cas/4.2.x/installation/Database-Authentication.html" target="_blank" rel="external">https://apereo.github.io/cas/4.2.x/installation/Database-Authentication.html</a></p>
<p>这里我们实现了一个自己的AuthenticationHandler，主要代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.will.cas.auth;<span class="comment">/* Example implementation of password hasher similar on Django's PasswordHasher</span></div><div class="line"> * Requires Java8 (but should be easy to port to older JREs)</div><div class="line"> * Currently it would work only for pbkdf2_sha256 algorithm</div><div class="line"> *</div><div class="line"> * Django code: https://github.com/django/django/blob/1.6.5/django/contrib/auth/hashers.py#L221</div><div class="line"> */</div><div class="line"></div><div class="line"><span class="keyword">import</span> org.jasig.cas.authentication.HandlerResult;</div><div class="line"><span class="keyword">import</span> org.jasig.cas.authentication.PreventedException;</div><div class="line"><span class="keyword">import</span> org.jasig.cas.authentication.UsernamePasswordCredential;</div><div class="line"><span class="keyword">import</span> org.jasig.cas.authentication.handler.support.AbstractUsernamePasswordAuthenticationHandler;</div><div class="line"><span class="keyword">import</span> org.springframework.jdbc.core.JdbcTemplate;</div><div class="line"></div><div class="line"><span class="keyword">import</span> javax.crypto.SecretKey;</div><div class="line"><span class="keyword">import</span> javax.crypto.SecretKeyFactory;</div><div class="line"><span class="keyword">import</span> javax.crypto.spec.PBEKeySpec;</div><div class="line"><span class="keyword">import</span> javax.security.auth.login.FailedLoginException;</div><div class="line"><span class="keyword">import</span> javax.sql.DataSource;</div><div class="line"><span class="keyword">import</span> javax.validation.constraints.NotNull;</div><div class="line"><span class="keyword">import</span> java.nio.charset.Charset;</div><div class="line"><span class="keyword">import</span> java.security.GeneralSecurityException;</div><div class="line"><span class="keyword">import</span> java.security.NoSuchAlgorithmException;</div><div class="line"><span class="keyword">import</span> java.security.spec.InvalidKeySpecException;</div><div class="line"><span class="keyword">import</span> java.security.spec.KeySpec;</div><div class="line"><span class="keyword">import</span> java.util.Base64;</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WillAuthenticationHandler</span> <span class="keyword">extends</span> <span class="title">AbstractUsernamePasswordAuthenticationHandler</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> JdbcTemplate jdbcTemplate;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> DataSource dataSource;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Method to set the datasource and generate a JdbcTemplate.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> dataSource the datasource to use.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(@NotNull <span class="keyword">final</span> DataSource dataSource)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.jdbcTemplate = <span class="keyword">new</span> JdbcTemplate(dataSource);</div><div class="line">        <span class="keyword">this</span>.dataSource = dataSource;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Method to return the jdbcTemplate.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> a fully created JdbcTemplate.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> JdbcTemplate <span class="title">getJdbcTemplate</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.jdbcTemplate;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> DataSource <span class="title">getDataSource</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.dataSource;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Integer DEFAULT_ITERATIONS = <span class="number">10000</span>;</div><div class="line">    <span class="keyword">public</span> <span class="keyword">final</span> String algorithm = <span class="string">"pbkdf2_sha256"</span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">WillAuthenticationHandler</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> HandlerResult <span class="title">authenticateUsernamePasswordInternal</span><span class="params">(UsernamePasswordCredential credential)</span> <span class="keyword">throws</span> GeneralSecurityException, PreventedException </span>&#123;</div><div class="line">        String username = credential.getUsername();</div><div class="line">        String pwd = credential.getPassword();</div><div class="line">        System.out.println(<span class="string">"Got username : "</span> + username + <span class="string">" and password : "</span> + pwd);</div><div class="line">        <span class="keyword">int</span> count = <span class="keyword">this</span>.jdbcTemplate.queryForObject(<span class="string">"select count(1) from auth_user where username=?"</span>, Integer.class, username);</div><div class="line">        <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</div><div class="line">            System.out.println(username + <span class="string">" not found with SQL query."</span>);</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> FailedLoginException(username + <span class="string">" not found with SQL query."</span>);</div><div class="line">        &#125;</div><div class="line">        String encyptedPassword = <span class="keyword">this</span>.jdbcTemplate.queryForObject(<span class="string">"select password from auth_user where username=?"</span>, String.class, username);</div><div class="line">        System.out.println(<span class="string">"Got encyptedPassword : "</span> + encyptedPassword);</div><div class="line">        <span class="keyword">if</span> (checkPassword(pwd, encyptedPassword)) &#123;</div><div class="line">            System.out.println(<span class="string">" auth success for user : "</span> + username);</div><div class="line">            <span class="keyword">return</span> createHandlerResult(credential, <span class="keyword">this</span>.principalFactory.createPrincipal(username), <span class="keyword">null</span>);</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> FailedLoginException(username + <span class="string">"'s password is wrong for : "</span> + pwd);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getEncodedHash</span><span class="params">(String password, String salt, <span class="keyword">int</span> iterations)</span> </span>&#123;</div><div class="line">        <span class="comment">// Returns only the last part of whole encoded password</span></div><div class="line">        SecretKeyFactory keyFactory = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            keyFactory = SecretKeyFactory.getInstance(<span class="string">"PBKDF2WithHmacSHA256"</span>);</div><div class="line">        &#125; <span class="keyword">catch</span> (NoSuchAlgorithmException e) &#123;</div><div class="line">            System.err.println(<span class="string">"Could NOT retrieve PBKDF2WithHmacSHA256 algorithm"</span>);</div><div class="line">            System.exit(<span class="number">1</span>);</div><div class="line">        &#125;</div><div class="line">        KeySpec keySpec = <span class="keyword">new</span> PBEKeySpec(password.toCharArray(), salt.getBytes(Charset.forName(<span class="string">"UTF-8"</span>)), iterations, <span class="number">256</span>);</div><div class="line">        SecretKey secret = <span class="keyword">null</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">            secret = keyFactory.generateSecret(keySpec);</div><div class="line">        &#125; <span class="keyword">catch</span> (InvalidKeySpecException e) &#123;</div><div class="line">            System.out.println(<span class="string">"Could NOT generate secret key"</span>);</div><div class="line">            e.printStackTrace();</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">byte</span>[] rawHash = secret.getEncoded();</div><div class="line">        <span class="keyword">byte</span>[] hashBase64 = Base64.getEncoder().encode(rawHash);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> <span class="keyword">new</span> String(hashBase64);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">encode</span><span class="params">(String password, String salt, <span class="keyword">int</span> iterations)</span> </span>&#123;</div><div class="line">        <span class="comment">// returns hashed password, along with algorithm, number of iterations and salt</span></div><div class="line">        String hash = getEncodedHash(password, salt, iterations);</div><div class="line">        <span class="keyword">return</span> String.format(<span class="string">"%s$%d$%s$%s"</span>, algorithm, iterations, salt, hash);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">encode</span><span class="params">(String password, String salt)</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.encode(password, salt, <span class="keyword">this</span>.DEFAULT_ITERATIONS);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">checkPassword</span><span class="params">(String password, String hashedPassword)</span> </span>&#123;</div><div class="line">        <span class="comment">// hashedPassword consist of: ALGORITHM, ITERATIONS_NUMBER, SALT and</span></div><div class="line">        <span class="comment">// HASH; parts are joined with dollar character ("$")</span></div><div class="line">        String[] parts = hashedPassword.split(<span class="string">"\\$"</span>);</div><div class="line">        <span class="keyword">if</span> (parts.length != <span class="number">4</span>) &#123;</div><div class="line">            <span class="comment">// wrong hash format</span></div><div class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">        &#125;</div><div class="line">        Integer iterations = Integer.parseInt(parts[<span class="number">1</span>]);</div><div class="line">        String salt = parts[<span class="number">2</span>];</div><div class="line">        String hash = encode(password, salt, iterations);</div><div class="line"></div><div class="line">        <span class="keyword">return</span> hash.equals(hashedPassword);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// Following examples can be generated at any Django project:</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">//  &gt;&gt;&gt; from django.contrib.auth.hashers import make_password</span></div><div class="line">    <span class="comment">//  &gt;&gt;&gt; make_password('mystery', hasher='pbkdf2_sha256')  # salt would be randomly generated</span></div><div class="line">    <span class="comment">//  'pbkdf2_sha256$10000$HqxvKtloKLwx$HdmdWrgv5NEuaM4S6uMvj8/s+5Yj+I/d1ay6zQyHxdg='</span></div><div class="line">    <span class="comment">//  &gt;&gt;&gt; make_password('mystery', salt='mysalt', hasher='pbkdf2_sha256')</span></div><div class="line">    <span class="comment">//  'pbkdf2_sha256$10000$mysalt$KjUU5KrwyUbKTGYkHqBo1IwUbFBzKXrGQgwA1p2AuY0='</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// mystery</span></div><div class="line">    <span class="comment">// pbkdf2_sha256$10000$qx1ec0f4lu4l$3G81rAm/4ng0tCCPTrx2aWohq7ztDBfFYczGNoUtiKQ=</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// s3cr3t</span></div><div class="line">    <span class="comment">// pbkdf2_sha256$10000$BjDHOELBk7fR$xkh1Xf6ooTqwkflS3rAiz5Z4qOV1Jd5Lwd8P+xGtW+I=</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// puzzle</span></div><div class="line">    <span class="comment">// pbkdf2_sha256$10000$IFYFG7hiiKYP$rf8vHYFD7K4q2N3DQYfgvkiqpFPGCTYn6ZoenLE3jLc=</span></div><div class="line">    <span class="comment">//</span></div><div class="line">    <span class="comment">// riddle</span></div><div class="line">    <span class="comment">// pbkdf2_sha256$10000$A0S5o3pNIEq4$Rk2sxXr8bonIDOGj6SU4H/xpjKHhHAKpFXfmNZ0dnEY=</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">        runTests();</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">runTests</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"==========================="</span>);</div><div class="line">        System.out.println(<span class="string">"= Testing password hasher ="</span>);</div><div class="line">        System.out.println(<span class="string">"==========================="</span>);</div><div class="line">        System.out.println();</div><div class="line"></div><div class="line">        System.out.println();</div><div class="line">        passwordShouldMatch(<span class="string">"admin"</span>, <span class="string">"pbkdf2_sha256$12000$g3UeiuUEnwfp$Qr/Qb6cCntnCflkBcJ+OenxWubIu6O84xLWGgWqNftw="</span>);</div><div class="line">        passwordShouldMatch(<span class="string">"will@2016"</span>, <span class="string">"pbkdf2_sha256$30000$tTJpdOsd3eoN$GcBF0YoHg8eV7s6NBqjX1i3VllEIeYuMUsyH5stzuw4="</span>);</div><div class="line"></div><div class="line">        System.out.println();</div><div class="line">        passwordShouldNotMatch(<span class="string">"foo"</span>, <span class="string">""</span>);</div><div class="line">        passwordShouldNotMatch(<span class="string">"mystery"</span>, <span class="string">"pbkdf2_md5$10000$qx1ec0f4lu4l$3G81rAm/4ng0tCCPTrx2aWohq7ztDBfFYczGNoUtiKQ="</span>);</div><div class="line">        passwordShouldNotMatch(<span class="string">"mystery"</span>, <span class="string">"pbkdf2_sha1$10000$qx1ec0f4lu4l$3G81rAm/4ng0tCCPTrx2aWohq7ztDBfFYczGNoUtiKQ="</span>);</div><div class="line">        passwordShouldNotMatch(<span class="string">"mystery"</span>, <span class="string">"pbkdf2_sha256$10001$Qx1ec0f4lu4l$3G81rAm/4ng0tCCPTrx2aWohq7ztDBfFYczGNoUtiKQ="</span>);</div><div class="line">        passwordShouldNotMatch(<span class="string">"mystery"</span>, <span class="string">"pbkdf2_sha256$10001$qx1ec0f4lu4l$3G81rAm/4ng0tCCPTrx2aWohq7ztDBfFYczGNoUtiKQ="</span>);</div><div class="line">        passwordShouldNotMatch(<span class="string">"mystery"</span>, <span class="string">"pbkdf2_sha256$10000$qx7ztDBfFYczGNoUtiKQ="</span>);</div><div class="line">        passwordShouldNotMatch(<span class="string">"s3cr3t"</span>, <span class="string">"pbkdf2_sha256$10000$BjDHOELBk7fR$foobar"</span>);</div><div class="line">        passwordShouldNotMatch(<span class="string">"puzzle"</span>, <span class="string">"pbkdf2_sha256$10000$IFYFG7hiiKYP$rf8vHYFD7K4q2N3DQYfgvkiqpFPGCTYn6ZoenLE3jLcX"</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">passwordShouldMatch</span><span class="params">(String password, String expectedHash)</span> </span>&#123;</div><div class="line">        WillAuthenticationHandler willAuthenticationHandler = <span class="keyword">new</span> WillAuthenticationHandler();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (willAuthenticationHandler.checkPassword(password, expectedHash)) &#123;</div><div class="line">            System.out.println(<span class="string">" =&gt; OK"</span>);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            String[] parts = expectedHash.split(<span class="string">"\\$"</span>);</div><div class="line">            <span class="keyword">if</span> (parts.length != <span class="number">4</span>) &#123;</div><div class="line">                System.out.printf(<span class="string">" =&gt; Wrong hash provided: '%s'\n"</span>, expectedHash);</div><div class="line">                <span class="keyword">return</span>;</div><div class="line">            &#125;</div><div class="line">            String salt = parts[<span class="number">2</span>];</div><div class="line">            String resultHash = willAuthenticationHandler.encode(password, salt);</div><div class="line">            String msg = <span class="string">" =&gt; Wrong! Password '%s' hash expected to be '%s' but is '%s'\n"</span>;</div><div class="line">            System.out.printf(msg, password, expectedHash, resultHash);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">passwordShouldNotMatch</span><span class="params">(String password, String expectedHash)</span> </span>&#123;</div><div class="line">        WillAuthenticationHandler willAuthenticationHandler = <span class="keyword">new</span> WillAuthenticationHandler();</div><div class="line"></div><div class="line">        <span class="keyword">if</span> (willAuthenticationHandler.checkPassword(password, expectedHash)) &#123;</div><div class="line">            System.out.printf(<span class="string">" =&gt; Wrong (password '%s' did '%s' match but were not supposed to)\n"</span>, password, expectedHash);</div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">            System.out.println(<span class="string">" =&gt; OK (password didn't match)"</span>);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>基本是抄袭了AbstractJdbcUsernamePasswordAuthenticationHandler的内容，然后执行了自己的算法实现。本来是可以直接继承AbstractJdbcUsernamePasswordAuthenticationHandler，重写方法实现的，但是考虑到我们要兼容很多个系统的数据库用户，所以需要多个dataSource和jdbcTemplate，就放弃了。</p>
<p>对于cas配置的切入点在于authenticationHandlersResolvers，以前版本的都是有个authenticationManager，然后编辑他的构造参数来定义认证处理器的，4.2.6貌似把它内置了。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"> <span class="tag">&lt;<span class="name">util:map</span> <span class="attr">id</span>=<span class="string">"authenticationHandlersResolvers"</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key-ref</span>=<span class="string">"proxyAuthenticationHandler"</span> <span class="attr">value-ref</span>=<span class="string">"proxyPrincipalResolver"</span> /&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key-ref</span>=<span class="string">"primaryAuthenticationHandler"</span> <span class="attr">value-ref</span>=<span class="string">"primaryPrincipalResolver"</span> /&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">util:map</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"org.springframework.jdbc.datasource.DriverManagerDataSource"</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClassName"</span> <span class="attr">value</span>=<span class="string">"com.mysql.jdbc.Driver"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"url"</span> <span class="attr">value</span>=<span class="string">"jdbc:mysql://127.0.0.1:3306/metamap1?useUnicode=true&amp;amp;characterEncoding=utf8"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"username"</span> <span class="attr">value</span>=<span class="string">"root"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">""</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">   <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"primaryAuthenticationHandler"</span></span></div><div class="line">     <span class="attr">class</span>=<span class="string">"com.will.cas.auth.WillAuthenticationHandler"</span></div><div class="line">     <span class="attr">p:dataSource-ref</span>=<span class="string">"dataSource"</span></div><div class="line">     /&gt;</div></pre></td></tr></table></figure>
<p>如此，便指定了自定义的认证处理器。</p>
<h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>在app1配置cas server为当前cas server后，跳转到登录页面，结果提示：</p>
<blockquote>
<p>未认证的授权服务 不允许使用CAS来认证您访问的目标应用</p>
</blockquote>
<p>查了一下解决方案，同样是在deployerConfigContext.xml中配置服务注册的DAO serviceRegistryDao为内存实现类，然后使用正则表达式表示这个cas server接收的服务：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">alias</span> <span class="attr">name</span>=<span class="string">"jsonServiceRegistryDao"</span> <span class="attr">alias</span>=<span class="string">"serviceRegistryDao"</span> /&gt;</span></div></pre></td></tr></table></figure></p>
<p>改为：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"serviceRegistryDao"</span> <span class="attr">class</span>=<span class="string">"org.jasig.cas.services.InMemoryServiceRegistryDaoImpl"</span></span></div><div class="line">             <span class="attr">p:registeredServices-ref</span>=<span class="string">"registeredServicesList"</span> /&gt;</div><div class="line"> </div><div class="line">     <span class="tag">&lt;<span class="name">util:list</span> <span class="attr">id</span>=<span class="string">"registeredServicesList"</span>&gt;</span></div><div class="line">         <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.jasig.cas.services.RegexRegisteredService"</span></span></div><div class="line">               <span class="attr">p:id</span>=<span class="string">"0"</span> <span class="attr">p:name</span>=<span class="string">"HTTP and IMAP"</span> <span class="attr">p:description</span>=<span class="string">"Allows HTTP(S) and IMAP(S) protocols"</span></div><div class="line">               <span class="attr">p:serviceId</span>=<span class="string">"^(https?|http?|imaps?)://.*"</span> <span class="attr">p:evaluationOrder</span>=<span class="string">"10000001"</span> /&gt;</div><div class="line">     <span class="tag">&lt;/<span class="name">util:list</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>其实理论上应该也可以在默认的jsonServiceRegistryDao配置的，但是找了一会儿没有找到json配置文件的位置。注意了一下貌似它是属于cas-addons的，有些插件的意思，后面再探查一下。</p>
<p>参考：</p>
<ul>
<li><a href="https://github.com/Unicon/cas-addons/wiki/Configuring-JSON-Service-Registry" target="_blank" rel="external">https://github.com/Unicon/cas-addons/wiki/Configuring-JSON-Service-Registry</a></li>
<li><a href="http://www.cnphp6.com/archives/133139" target="_blank" rel="external">http://www.cnphp6.com/archives/133139</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/05/mondrian-定义schema/" title="mondrian-定义schema" itemprop="url">mondrian-定义schema</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-12-05T09:11:20.000Z" itemprop="datePublished"> 发表于 2016-12-05</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>一个schema定义了一个多维数据库。它包含一个逻辑模型，这个逻辑模型中包含了多个立方体、层级、成员、以及将这个模型映射到物理模型的映射。</p>
<p>逻辑模型包含了MDX语言中的构造组件：: cubes, dimensions, hierarchies, levels, and members.<br>物理模型是物理数据源。一般是星型模型，就是RDBMS中的一堆表。</p>
<h2 id="Scheme-文件"><a href="#Scheme-文件" class="headerlink" title="Scheme 文件"></a>Scheme 文件</h2><p>mondrian的schema是定义在xml文件中的。有一个比较全面的例子demo/FoodMart.xml。目前，创建schema只能通过编辑xml文件来实现。下面是xml结构：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Schema</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Cube</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Table</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">AggName</span>&gt;</span></div><div class="line">aggElements</div><div class="line"><span class="tag">&lt;<span class="name">AggPattern</span>&gt;</span></div><div class="line">aggElements</div><div class="line"><span class="tag">&lt;<span class="name">Dimension</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Hierarchy</span>&gt;</span></div><div class="line">relation</div><div class="line"><span class="tag">&lt;<span class="name">Closure</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Level</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">KeyExpression</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">SQL</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">NameExpression</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">SQL</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">CaptionExpression</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">SQL</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">OrdinalExpression</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">SQL</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">ParentExpression</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">SQL</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Property</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">PropertyExpression</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">SQL</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">DimensionUsage</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Measure</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">MeasureExpression</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">SQL</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">CalculatedMemberProperty</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">CalculatedMember</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Formula</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">CalculatedMemberProperty</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">NamedSet</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Formula</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">VirtualCube</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">CubeUsages</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">CubeUsage</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">VirtualCubeDimension</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">VirtualCubeMeasure</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Role</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">SchemaGrant</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">CubeGrant</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">DimensionGrant</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">HierarchyGrant</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">MemberGrant</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Union</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">RoleUsage</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">UserDefinedFunction</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Parameter</span>/&gt;</span></div><div class="line"></div><div class="line">relation ::=</div><div class="line"><span class="tag">&lt;<span class="name">Table</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">SQL</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">View</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">SQL</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">InlineTable</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">ColumnDefs</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">ColumnDef</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Rows</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Row</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Value</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Join</span>&gt;</span></div><div class="line">relation</div><div class="line"></div><div class="line">aggElement ::=</div><div class="line"><span class="tag">&lt;<span class="name">AggExclude</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">AggFactCount</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">AggIgnoreColumn</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">AggForeignKey</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">AggMeasure</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">AggLevel</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>注意：xml元素的顺序。<userdefinedfunction> 必须在 <cube>, <virtualcube>, <namedset> and <role> 元素后面。</role></namedset></virtualcube></cube></userdefinedfunction></p>
<h4 id="2-1-注解"><a href="#2-1-注解" class="headerlink" title="2.1 注解"></a>2.1 注解</h4><p>主要的元素(schema, cube, virtual cube, shared dimension, dimension, hierarchy, level, measure, calculated member)都支持注解。注解能够把用户定义的属性和元数据元素联系起来，允许工具在不继承mondrian schema的前提下添加元数据。</p>
<p>下面例子，为Schema添加了 Author和Date两个注解。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Schema</span> <span class="attr">name</span>=<span class="string">"Rock Sales"</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Annotations</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Annotation</span> <span class="attr">name</span>=<span class="string">"Author"</span>&gt;</span>Fred Flintstone<span class="tag">&lt;/<span class="name">Annotation</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Annotation</span> <span class="attr">name</span>=<span class="string">"Date"</span>&gt;</span>10,000 BC<span class="tag">&lt;/<span class="name">Annotation</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Annotations</span>&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Cube</span> <span class="attr">name</span>=<span class="string">"Sales"</span>&gt;</span></div><div class="line">...</div></pre></td></tr></table></figure></p>
<h2 id="3-逻辑模型"><a href="#3-逻辑模型" class="headerlink" title="3 逻辑模型"></a>3 逻辑模型</h2><p>最重要的三个组件： cubes, measures, dimensions。</p>
<ul>
<li>cube。 维度和指标在指定子区域的集合。</li>
<li>measure。量化的指标。</li>
<li>dimension。可切分指标的属性。</li>
</ul>
<p>下面是一个简单的schema:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Schema</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Cube</span> <span class="attr">name</span>=<span class="string">"Sales"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Table</span> <span class="attr">name</span>=<span class="string">"sales_fact_1997"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Dimension</span> <span class="attr">name</span>=<span class="string">"Gender"</span> <span class="attr">foreignKey</span>=<span class="string">"customer_id"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">Hierarchy</span> <span class="attr">hasAll</span>=<span class="string">"true"</span> <span class="attr">allMemberName</span>=<span class="string">"All Genders"</span> <span class="attr">primaryKey</span>=<span class="string">"customer_id"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">Table</span> <span class="attr">name</span>=<span class="string">"customer"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Gender"</span> <span class="attr">column</span>=<span class="string">"gender"</span> <span class="attr">uniqueMembers</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">Hierarchy</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">Dimension</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Dimension</span> <span class="attr">name</span>=<span class="string">"Time"</span> <span class="attr">foreignKey</span>=<span class="string">"time_id"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">Hierarchy</span> <span class="attr">hasAll</span>=<span class="string">"false"</span> <span class="attr">primaryKey</span>=<span class="string">"time_id"</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">Table</span> <span class="attr">name</span>=<span class="string">"time_by_day"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Year"</span> <span class="attr">column</span>=<span class="string">"the_year"</span> <span class="attr">type</span>=<span class="string">"Numeric"</span> <span class="attr">uniqueMembers</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Quarter"</span> <span class="attr">column</span>=<span class="string">"quarter"</span> <span class="attr">uniqueMembers</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Month"</span> <span class="attr">column</span>=<span class="string">"month_of_year"</span> <span class="attr">type</span>=<span class="string">"Numeric"</span> <span class="attr">uniqueMembers</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">Hierarchy</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">Dimension</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Measure</span> <span class="attr">name</span>=<span class="string">"Unit Sales"</span> <span class="attr">column</span>=<span class="string">"unit_sales"</span> <span class="attr">aggregator</span>=<span class="string">"sum"</span> <span class="attr">formatString</span>=<span class="string">"#,###"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Measure</span> <span class="attr">name</span>=<span class="string">"Store Sales"</span> <span class="attr">column</span>=<span class="string">"store_sales"</span> <span class="attr">aggregator</span>=<span class="string">"sum"</span> <span class="attr">formatString</span>=<span class="string">"#,###.##"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">Measure</span> <span class="attr">name</span>=<span class="string">"Store Cost"</span> <span class="attr">column</span>=<span class="string">"store_cost"</span> <span class="attr">aggregator</span>=<span class="string">"sum"</span> <span class="attr">formatString</span>=<span class="string">"#,###.00"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">CalculatedMember</span> <span class="attr">name</span>=<span class="string">"Profit"</span> <span class="attr">dimension</span>=<span class="string">"Measures"</span> <span class="attr">formula</span>=<span class="string">"[Measures].[Store Sales] - [Measures].[Store Cost]"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">CalculatedMemberProperty</span> <span class="attr">name</span>=<span class="string">"FORMAT_STRING"</span> <span class="attr">value</span>=<span class="string">"$#,##0.00"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">CalculatedMember</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">Cube</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Schema</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这个schema只有一个立方体，叫做’sales’。两个维度，time和gender。四个指标。</p>
<p>我们可以基于这个schema写出如下MDX查询：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span> &#123;[<span class="keyword">Measures</span>].[Unit Sales], [<span class="keyword">Measures</span>].[<span class="keyword">Store</span> Sales]&#125; <span class="keyword">ON</span> <span class="keyword">COLUMNS</span>,</div><div class="line">  &#123;descendants([<span class="keyword">Time</span>].[<span class="number">1997</span>].[Q1])&#125; <span class="keyword">ON</span> <span class="keyword">ROWS</span></div><div class="line"><span class="keyword">FROM</span> [Sales]</div><div class="line"><span class="keyword">WHERE</span> [Gender].[F]</div></pre></td></tr></table></figure></p>
<h4 id="3-1-cube"><a href="#3-1-cube" class="headerlink" title="3.1 cube"></a>3.1 cube</h4><p>cube是指标和维度的集合。指标和维度的共同处之一就是都在事实表上，这里就是 “sales_fact_1997表。指标基于事实表里的字段计算，事实表里也包含所有的维度。</p>
<p>事实表使用<table>元素定义。如果事实表不在默认的schema中，你可以使用schema属性明确指定：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Table</span> <span class="attr">schema</span>=<span class="string">" dmart"</span> <span class="attr">name</span>=<span class="string">"sales_fact_1997"</span>/&gt;</span></div></pre></td></tr></table></figure></table></p>
<p>还可以使用<view>构造更复杂的SQL语句。事实表不支持<join>。</join></view></p>
<h4 id="3-2-measure"><a href="#3-2-measure" class="headerlink" title="3.2 measure"></a>3.2 measure</h4><p>Sales cube定义了 “Unit Sales” 和 “Store Sales”几个指标。<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Measure</span> <span class="attr">name</span>=<span class="string">"Unit Sales"</span> <span class="attr">column</span>=<span class="string">"unit_sales"</span> <span class="attr">aggregator</span>=<span class="string">"sum"</span> <span class="attr">datatype</span>=<span class="string">"Integer"</span> <span class="attr">formatString</span>=<span class="string">"#,###"</span>/&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">Measure</span> <span class="attr">name</span>=<span class="string">"Store Sales"</span> <span class="attr">column</span>=<span class="string">"store_sales"</span> <span class="attr">aggregator</span>=<span class="string">"sum"</span> <span class="attr">datatype</span>=<span class="string">"Numeric"</span> <span class="attr">formatString</span>=<span class="string">"#,###.00"</span>/&gt;</span></div></pre></td></tr></table></figure></p>
<p>datatype是可选的属性，它指示着这个指标在mondrian缓存中存在的形式，也决定这些指标怎样通过XML返回。(“String”, “Integer”, “Numeric”, “Boolean”, “Date”, “Time”, “Timestamp”) 。 除了”count”或者 “distinct-count” 是”Integer”，其他的aggregator的默认值都是”Numeric”。</p>
<p>formatString也是可选的，它代表指标被打印的形式。<a href="http://mondrian.pentaho.com/documentation/mdx.php#Format_strings" target="_blank" rel="external">更多参考</a></p>
<p>获取某个指标的名称可以调用 Member.getCaption() 。</p>
<p>指标使用cell reader，而不是读取column，或者也能使用sql表达式来计算。 “Promotion Sales”就是通过sql表达式计算的：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Measure</span> <span class="attr">name</span>=<span class="string">"Promotion Sales"</span> <span class="attr">aggregator</span>=<span class="string">"sum"</span> <span class="attr">formatString</span>=<span class="string">"#,###.00"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">MeasureExpression</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">SQL</span> <span class="attr">dialect</span>=<span class="string">"generic"</span>&gt;</span></div><div class="line">			(case when sales_fact_1997.promotion_id = 0 then 0 else sales_fact_1997.store_sales end)</div><div class="line">		<span class="tag">&lt;/<span class="name">SQL</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">MeasureExpression</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Measure</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>要格式化cell 值，<a href="http://mondrian.pentaho.com/documentation/schema.php#Cell_formatter" target="_blank" rel="external">请参考</a></p>
<h4 id="3-3-dimension-hierarchy-level"><a href="#3-3-dimension-hierarchy-level" class="headerlink" title="3.3 dimension, hierarchy, level"></a>3.3 dimension, hierarchy, level</h4><p>先看一些定义：</p>
<ul>
<li>member。 指定维度中的一个点。性别hierarchy包含M和F两个member。</li>
<li>hierarchy。一组形成某个结构的member。store hierarchy包含name, city, state, nation。这个hierarchy允许出现中间层次，一个state的子聚合（sub-total）是这个state的所有city的所有子聚合(sub-total)之和。</li>
<li>level。同一个level的member距离hierarchy最上层root的距离相等，也就是说在同一层上</li>
<li>dimemsion。一组hierarchy的集合，用来区分同一个事实表中的属性。</li>
</ul>
<p>例子：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Dimension</span> <span class="attr">name</span>=<span class="string">"Gender"</span> <span class="attr">foreignKey</span>=<span class="string">"customer_id"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">Hierarchy</span> <span class="attr">hasAll</span>=<span class="string">"true"</span> <span class="attr">primaryKey</span>=<span class="string">"customer_id"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Table</span> <span class="attr">name</span>=<span class="string">"customer"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Gender"</span> <span class="attr">column</span>=<span class="string">"gender"</span> <span class="attr">uniqueMembers</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">Hierarchy</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Dimension</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>这个维度包含了一个hierarchy，这个hierarchy包含了一个level。这个维度的值来源于customer表的gender字段。</p>
<p>对于任意一个订单，gender维度是这个顾客的性别，应该是事实表 “sales_fact_1997.customer_id” 和维度表”customer.customer_id” join的结果。</p>
<h5 id="3-3-1-将维度和hierarchy映射到表"><a href="#3-3-1-将维度和hierarchy映射到表" class="headerlink" title="3.3.1 将维度和hierarchy映射到表"></a>3.3.1 将维度和hierarchy映射到表</h5><p>一个维度通过一对儿字段join进入一个cube，一个字段来自事实表，另一个来自维度表。 <dimension>元素有一个foreignKey属性，它是事实表里字段的名字。<hierarchy>元素有一个primaryKey属性。</hierarchy></dimension></p>
<p>如果hierarchy涉及到多个表，我们可以使用primaryKey来区分。</p>
<p>column属性定义了level的key。必须是在level表中的名字。如果key是一个表达式，可以在level中使用<keyexpression>元素。下面是一个例子<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Dimension</span> <span class="attr">name</span>=<span class="string">"Gender"</span> <span class="attr">foreignKey</span>=<span class="string">"customer_id"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">Hierarchy</span> <span class="attr">hasAll</span>=<span class="string">"true"</span> <span class="attr">primaryKey</span>=<span class="string">"customer_id"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">Table</span> <span class="attr">name</span>=<span class="string">"customer"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Gender"</span> <span class="attr">column</span>=<span class="string">"gender"</span> <span class="attr">uniqueMembers</span>=<span class="string">"true"</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">KeyExpression</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">SQL</span> <span class="attr">dialect</span>=<span class="string">"generic"</span>&gt;</span>customer.gender<span class="tag">&lt;/<span class="name">SQL</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">KeyExpression</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">Level</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">Hierarchy</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Dimension</span>&gt;</span></div></pre></td></tr></table></figure></keyexpression></p>
<p><level>, <measure>, <property>还有一些嵌套属性：<br>Parent element    | 属性 |    Equivalent nested element |    描述<br>—|—|—|—</property></measure></level></p>
<p><level>    |     column        | <keyexpression>        | Key of level.</keyexpression></level></p>
<p><level |="" namecolumn="" <nameexpression="">    |     Expression which defines the name of members of this level. If not specified, the level key is used.</level></p>
<p><level>        | ordinalColumn    |     <ordinalexpression>    |     Expression which defines the order of members. If not specified, the level key is used.</ordinalexpression></level></p>
<p><level>        | captionColumn        | <captionexpression>    |     Expression which forms the caption of members. If not specified, the level name is used.</captionexpression></level></p>
<p><level>        |     |     <parentexpression>    |     Expression by which child members reference their parent member in a parent-child hierarchy. Not specified in a regular hierarchy.</parentexpression></level></p>
<p><measure>    |     column    |     <measureexpression>        | SQL expression to calculate the value of the measure (the argument to the SQL aggregate function).</measureexpression></measure></p>
<p><property>        | column    |     <propertyexpression>    |     SQL expression to calculate the value of the property.</propertyexpression></property></p>
<p>uniqueMembers 属性用来优化SQL生成过程。如果知道某个level字段的值是唯一的，就设置uniqueMembers为true。 例如[Year].[Month] 在Month level就不是唯一的，因为在不同年里会出现相同的月份。而[Product Class].[Product Name] 就是唯一的，因为产品名字不会有相同的。顶层的都是唯一的。</p>
<p>highCardinality 属性通知mondrian当前维度会有很大的不可预估的值。</p>
<h5 id="3-3-2-‘all’-member"><a href="#3-3-2-‘all’-member" class="headerlink" title="3.3.2 ‘all’ member"></a>3.3.2 ‘all’ member</h5><p>默认每个hierarchy都有一个顶层节点level，’all’。它是所有其他member的父节点，也是这个hierarchy的默认值，当hierarchy没有被包含在某个坐标系或者切片的时候，就使用这个值来计算cell值。allMemberName 和allLevelName 属性重写所有level和所有member的默认名称。</p>
<p>如果 <hierarchy> 元素有属性 hasAll=”false”，那么’all’这个level就失效了。维度的默认值就成了第一个level里的第一个元素，如果是time hierarchy的话，就是hierarchy的第一年。修改默认值的话，容易产生混淆，所以含是使用 hasAll=”true”吧。</hierarchy></p>
<p>下面是覆盖默认值的例子<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Dimension</span> <span class="attr">name</span>=<span class="string">"Time"</span> <span class="attr">type</span>=<span class="string">"TimeDimension"</span> <span class="attr">foreignKey</span>=<span class="string">"time_id"</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">Hierarchy</span> <span class="attr">hasAll</span>=<span class="string">"false"</span> <span class="attr">primaryKey</span>=<span class="string">"time_id"</span> <span class="attr">defaultMember</span>=<span class="string">"[Time].[1997].[Q1].[1]"</span>/&gt;</span></div><div class="line">    ....</div></pre></td></tr></table></figure></p>
<h5 id="3-3-3-Time-dimemsion"><a href="#3-3-3-Time-dimemsion" class="headerlink" title="3.3.3 Time dimemsion"></a>3.3.3 Time dimemsion</h5><p>时间维度是基于年月周日的。与之相关的MDX的内置函数如下：</p>
<ul>
<li>ParallelPeriod([level[, index[, member]]])</li>
<li>PeriodsToDate([level[, member]])</li>
<li>WTD([member])</li>
<li>MTD([member])</li>
<li>QTD([member])</li>
<li>YTD([member])</li>
<li>LastPeriod(index[, member])</li>
</ul>
<p>例子<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Dimension</span> <span class="attr">name</span>=<span class="string">"Time"</span> <span class="attr">type</span>=<span class="string">"TimeDimension"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">Hierarchy</span> <span class="attr">hasAll</span>=<span class="string">"true"</span> <span class="attr">allMemberName</span>=<span class="string">"All Periods"</span> <span class="attr">primaryKey</span>=<span class="string">"dateid"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Table</span> <span class="attr">name</span>=<span class="string">"datehierarchy"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Year"</span> <span class="attr">column</span>=<span class="string">"year"</span> <span class="attr">uniqueMembers</span>=<span class="string">"true"</span> <span class="attr">levelType</span>=<span class="string">"TimeYears"</span> <span class="attr">type</span>=<span class="string">"Numeric"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Quarter"</span> <span class="attr">column</span>=<span class="string">"quarter"</span> <span class="attr">uniqueMembers</span>=<span class="string">"false"</span> <span class="attr">levelType</span>=<span class="string">"TimeQuarters"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Month"</span> <span class="attr">column</span>=<span class="string">"month"</span> <span class="attr">uniqueMembers</span>=<span class="string">"false"</span> <span class="attr">ordinalColumn</span>=<span class="string">"month"</span> <span class="attr">nameColumn</span>=<span class="string">"month_name"</span> <span class="attr">levelType</span>=<span class="string">"TimeMonths"</span> <span class="attr">type</span>=<span class="string">"Numeric"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Week"</span> <span class="attr">column</span>=<span class="string">"week_in_month"</span> <span class="attr">uniqueMembers</span>=<span class="string">"false"</span> <span class="attr">levelType</span>=<span class="string">"TimeWeeks"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Day"</span> <span class="attr">column</span>=<span class="string">"day_in_month"</span> <span class="attr">uniqueMembers</span>=<span class="string">"false"</span> <span class="attr">ordinalColumn</span>=<span class="string">"day_in_month"</span> <span class="attr">nameColumn</span>=<span class="string">"day_name"</span> <span class="attr">levelType</span>=<span class="string">"TimeDays"</span> <span class="attr">type</span>=<span class="string">"Numeric"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">Hierarchy</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Dimension</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h5 id="3-3-4-level的顺序与展示"><a href="#3-3-4-level的顺序与展示" class="headerlink" title="3.3.4 level的顺序与展示"></a>3.3.4 level的顺序与展示</h5><p>注意时间hierarchy的例子中的ordinalColumn 和nameColumn 属性。这两个属性关系到level怎样在结果中展现。ordinalColumn 属性指定了hierarchy中的一个字段，根据这个字段排序，nameColumn 则指明了要展示的字段。</p>
<p>例如，在月份level中，datehierarchy有month (1 .. 12) ，和month_name (January, February, …)两个字段。MDX内部使用的字段是month，此种形式：[Time].[2005].[Q1].[1]。Month level的元素会按照January, February…的顺序显示。</p>
<p>在父子hierarchy中，元素都是按照层级顺序排序的。ordinalColumn控制着同一个分支的兄弟节点之间的顺序。</p>
<p>level包含一个type属性，它的枚举有 “String”, “Integer”, “Numeric”, “Boolean”, “Date”, “Time”, “Timestamp”.</p>
<h5 id="3-5-多个hierarchy"><a href="#3-5-多个hierarchy" class="headerlink" title="3.5 多个hierarchy"></a>3.5 多个hierarchy</h5><p>有的维度包含多个hierarchy：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Dimension</span> <span class="attr">name</span>=<span class="string">"Time"</span> <span class="attr">foreignKey</span>=<span class="string">"time_id"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">Hierarchy</span> <span class="attr">hasAll</span>=<span class="string">"false"</span> <span class="attr">primaryKey</span>=<span class="string">"time_id"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Table</span> <span class="attr">name</span>=<span class="string">"time_by_day"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Year"</span> <span class="attr">column</span>=<span class="string">"the_year"</span> <span class="attr">type</span>=<span class="string">"Numeric"</span> <span class="attr">uniqueMembers</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Quarter"</span> <span class="attr">column</span>=<span class="string">"quarter"</span> <span class="attr">uniqueMembers</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Month"</span> <span class="attr">column</span>=<span class="string">"month_of_year"</span> <span class="attr">type</span>=<span class="string">"Numeric"</span> <span class="attr">uniqueMembers</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">Hierarchy</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">Hierarchy</span> <span class="attr">name</span>=<span class="string">"Time Weekly"</span> <span class="attr">hasAll</span>=<span class="string">"false"</span> <span class="attr">primaryKey</span>=<span class="string">"time_id"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Table</span> <span class="attr">name</span>=<span class="string">"time_by_week"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Year"</span> <span class="attr">column</span>=<span class="string">"the_year"</span> <span class="attr">type</span>=<span class="string">"Numeric"</span> <span class="attr">uniqueMembers</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Week"</span> <span class="attr">column</span>=<span class="string">"week"</span> <span class="attr">uniqueMembers</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Day"</span> <span class="attr">column</span>=<span class="string">"day_of_week"</span> <span class="attr">type</span>=<span class="string">"String"</span> <span class="attr">uniqueMembers</span>=<span class="string">"false"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">Hierarchy</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Dimension</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>注意，第一个hierarchy并没有name属性，默认是继承它的dimemsion。</p>
<p>以上两个hierarchy之间除了都是使用time_id作为join的key以外没有任何其他地方有相同点。把两个hierarchy放在同一个dimemsion中完全是为了迎合终端用户，因为终端用户认为为’Time’ 和’Time Weekly’两个hierarchy弄两个坐标系完全是没有什么道理的。如果两个hierarchy在同一个dimemsion中，MDX语言就会强制你只能使用两者之中的一个。</p>
<h5 id="3-3-6-Degenerate-dimensions"><a href="#3-3-6-Degenerate-dimensions" class="headerlink" title="3.3.6 Degenerate dimensions"></a>3.3.6 Degenerate dimensions</h5><p>退化维度，是指特别简单都不值当给他创建一个表的问题。例如下面的事实表:<br>product_id|    time_id|    payment_method|    customer_id    store_id|    item_count    dollars<br>—|—|—|—|—<br>55    20040106|    Credit    |123|    22|    3|    $3.54<br>78    20040106|    Cash|    89|    22|    1|    $20.00<br>199    20040107|    ATM|    3|    22    |2    |$2.99<br>55    20040106|    Cash|    122|    22    |1|    $1.18</p>
<p>假设我们为payment_method 字段创建了一个表。：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">payment_method</div><div class="line">Credit</div><div class="line">Cash</div><div class="line">ATM</div></pre></td></tr></table></figure></p>
<p>它只有3个可能的值，建表没啥意义。我们应该创建一个退化维度。为此，我们要创建一个没有table的dimemsion，mondrian会认为这些字段来源于事实表：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Cube</span> <span class="attr">name</span>=<span class="string">"Checkout"</span>&gt;</span></div><div class="line">	<span class="comment">&lt;!-- The fact table is always necessary. --&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">Table</span> <span class="attr">name</span>=<span class="string">"checkout"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">Dimension</span> <span class="attr">name</span>=<span class="string">"Payment method"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Hierarchy</span> <span class="attr">hasAll</span>=<span class="string">"true"</span>&gt;</span></div><div class="line">			<span class="comment">&lt;!-- No table element here. Fact table is assumed. --&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Payment method"</span> <span class="attr">column</span>=<span class="string">"payment_method"</span> <span class="attr">uniqueMembers</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">Hierarchy</span>&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">Dimension</span>&gt;</span></div><div class="line">	<span class="comment">&lt;!-- other dimensions and measures --&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Cube</span>&gt;</span></div></pre></td></tr></table></figure></p>
<p>由于没有join操作，所以foreignKey也米有必要了。hierarchy也没有table元素以及primaryKey属性。</p>
<h5 id="3-3-7-inline-table"><a href="#3-3-7-inline-table" class="headerlink" title="3.3.7 inline table"></a>3.3.7 inline table</h5><p><inlinetable>用来在schema中定义一个简单的数据集。</inlinetable></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Dimension</span> <span class="attr">name</span>=<span class="string">"Severity"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">Hierarchy</span> <span class="attr">hasAll</span>=<span class="string">"true"</span> <span class="attr">primaryKey</span>=<span class="string">"severity_id"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">InlineTable</span> <span class="attr">alias</span>=<span class="string">"severity"</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">ColumnDefs</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">ColumnDef</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">type</span>=<span class="string">"Numeric"</span>/&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">ColumnDef</span> <span class="attr">name</span>=<span class="string">"desc"</span> <span class="attr">type</span>=<span class="string">"String"</span>/&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">ColumnDefs</span>&gt;</span></div><div class="line">			<span class="tag">&lt;<span class="name">Rows</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">Row</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">Value</span> <span class="attr">column</span>=<span class="string">"id"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">Value</span> <span class="attr">column</span>=<span class="string">"desc"</span>&gt;</span>High<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">Row</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">Row</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">Value</span> <span class="attr">column</span>=<span class="string">"id"</span>&gt;</span>2<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">Value</span> <span class="attr">column</span>=<span class="string">"desc"</span>&gt;</span>Medium<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">Row</span>&gt;</span></div><div class="line">				<span class="tag">&lt;<span class="name">Row</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">Value</span> <span class="attr">column</span>=<span class="string">"id"</span>&gt;</span>3<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></div><div class="line">					<span class="tag">&lt;<span class="name">Value</span> <span class="attr">column</span>=<span class="string">"desc"</span>&gt;</span>Low<span class="tag">&lt;/<span class="name">Value</span>&gt;</span></div><div class="line">				<span class="tag">&lt;/<span class="name">Row</span>&gt;</span></div><div class="line">			<span class="tag">&lt;/<span class="name">Rows</span>&gt;</span></div><div class="line">		<span class="tag">&lt;/<span class="name">InlineTable</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Severity"</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">nameColumn</span>=<span class="string">"desc"</span> <span class="attr">uniqueMembers</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">Hierarchy</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Dimension</span>&gt;</span></div></pre></td></tr></table></figure>
<p>以上面数据集声明dimemsion：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">Dimension</span> <span class="attr">name</span>=<span class="string">"Severity"</span>&gt;</span></div><div class="line">	<span class="tag">&lt;<span class="name">Hierarchy</span> <span class="attr">hasAll</span>=<span class="string">"true"</span> <span class="attr">primaryKey</span>=<span class="string">"severity_id"</span>&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Table</span> <span class="attr">name</span>=<span class="string">"severity"</span>/&gt;</span></div><div class="line">		<span class="tag">&lt;<span class="name">Level</span> <span class="attr">name</span>=<span class="string">"Severity"</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">nameColumn</span>=<span class="string">"desc"</span> <span class="attr">uniqueMembers</span>=<span class="string">"true"</span>/&gt;</span></div><div class="line">	<span class="tag">&lt;/<span class="name">Hierarchy</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">Dimension</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h5 id="3-3-8-Member-properties-and-formatters"><a href="#3-3-8-Member-properties-and-formatters" class="headerlink" title="3.3.8 Member properties and formatters"></a>3.3.8 Member properties and formatters</h5><p>As we shall see later, a level definition can also define member properties and a member formatter.</p>
<h5 id="3-3-9-Approximate-level-cardinality"><a href="#3-3-9-Approximate-level-cardinality" class="headerlink" title="3.3.9 Approximate level cardinality"></a>3.3.9 Approximate level cardinality</h5><p>The <level> element allows specifying the optional attribute “approxRowCount”. Specifying approxRowCount can improve performance by reducing the need to determine level, hierarchy, and dimension cardinality. This can have a significant impact when connecting to Mondrian via XMLA.</level></p>
<h5 id="3-3-10-Default-Measure-Attribute"><a href="#3-3-10-Default-Measure-Attribute" class="headerlink" title="3.3.10 Default Measure Attribute"></a>3.3.10 Default Measure Attribute</h5>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/05/公平调度器-capacity-scheduler/" title="公平调度器-capacity-scheduler" itemprop="url">公平调度器-capacity-scheduler</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-12-05T09:11:05.000Z" itemprop="datePublished"> 发表于 2016-12-05</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="概览"><a href="#概览" class="headerlink" title="概览"></a>概览</h2><p>公平调度器是Hadoop上的一个可配置的调度器，支持多租户共享集群资源，最大化利用集群资源。传统来说，每个组织都有自己的私有资源，这些资源能够在一些极端峰值状态足够满足自己部门的SLA。这样其实是有问题的，所有的集群都需要管理，而且每个部门的资源平均使用率并不高。集群共享其实是一个比较划算的事情，每个部门既能完成工作，又不用去单独管理各自的集群。但是，各部门又有些担心如果共享集群资源的话，其他部门的东西会不会对自己的SLA造成影响。CapacityScheduler就是解决这个问题而生的，它可以让多个部门共享一个大的集群资源，而且各个部门的资源不会被其他部门使用，这保证了部门之间资源共享的灵活性，而且很划算。</p>
<p>多个组织之间共享集群资源，很重要的一点是保证每个组织有一个自保的机制，保证自己的资源不受其他部门资源调度的影响。CapacityScheduler提供了一套严格的保证机制来限制应用、用户、queue等不能无限制地访问集群资源。另外，CapacityScheduler也限制了一个用户或者queue的应用的初始化与pending资源来保证集群的稳定性和公平性。</p>
<p>CapacityScheduler提供的主要概念是queue的概念。一般queue都是管理员创建的，反映了共享集群的各个经济单体。</p>
<p>为了进一步的控制资源共享情况，CapacityScheduler支持纵向队列，也就是资源还可以在sub-queue子队列里进行分配。<br>To provide further control and predictability on sharing of resources, the CapacityScheduler supports hierarchical queues to ensure resources are shared among the sub-queues of an organization before other queues are allowed to use free resources, there-by providing affinity for sharing free resources among applications of a given organization.</p>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><p>如下:</p>
<ul>
<li>Hierarchical Queues 纵向队列 -<br>在其他queue使用空闲资源之前，支持资源可被当前组织的sub-queue优先抢占，以此来提供更高的可控性和可预测性。<ul>
<li>保证容量 - 保证总资源的某个百分比的容量随时听候某queue的调遣。所有提交到这个queue的应用都可以访问这部分资源。 管理员可以灵活配置soft limit和hard limit限制每个queue的容量占比。</li>
<li>安全 - 每个queue都有严格的ACLs策略控制谁可以提交应用到哪个queue。另外，也不能让某些普通用户看到或者修改运行在其他queue里的应用。 管理员角色粒度可以对应一个queue或整个scheduler系统。</li>
<li>弹性 - 任何队列资源不够的话，都可以使用空闲资源区的资源。 When there is demand for these resources from queues running below capacity at a future point in time, as tasks scheduled on these resources complete, they will be assigned to applications on queues running below the capacity (pre-emption is not supported). This ensures that resources are available in a predictable and elastic manner to queues, thus preventing artifical silos of resources in the cluster which helps utilization.</li>
<li>多租户 - Comprehensive set of limits are provided to prevent a single application, user and queue from monopolizing resources of the queue or the cluster as a whole to ensure that the cluster isn’t overwhelmed.<br>Operability</li>
<li>运行时配置优先 - The queue definitions and properties such as capacity, ACLs can be changed, at runtime, by administrators in a secure manner to minimize disruption to users. Also, a console is provided for users and administrators to view current allocation of resources to various queues in the system. Administrators can add additional queues at runtime, but queues cannot be deleted at runtime.</li>
<li>清空应用 - .如果一个queue是STOPPED状态，就不能向它或者它的任何sub-queue提交应用了。 正在运行的应用会继续运行到完成，因此queue可以被优雅的清空。管理员也可以启动或者停掉某个queue。</li>
<li>基于资源的调度 - 可以多分配一些配置，主要是为了支持一些资源敏感的应用。<br>Queue Mapping based on User or Group - This feature allows users to map a job to a specific queue based on the user or group.<h4 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h4></li>
</ul>
</li>
</ul>
<p>配置ResourceManager使用CapacityScheduler</p>
<p>conf/yarn-site.xml:<br>|  属性 | 值  |<br>|—|—|<br>| yarn.resourcemanager.scheduler.class  |org.apache.hadoop.yarn.server.resourcemanager.scheduler.capacity.CapacityScheduler |<br>|   |   |<br>|   |   |</p>
<p>配置queues</p>
<p>etc/hadoop/capacity-scheduler.xml是CapacityScheduler的主配置文件.<br>CapacityScheduler又一个预定义的queue: root, 所有的队列都是这个队列的子队列sub-queue.其他的队列通过设置 <strong>yarn.scheduler.capacity.root.queues</strong>属性，弄一个逗号隔开的字符串就行.<br>CapacityScheduler使用queue path配置queue的层次. queue path是queue层级的全路径, 以root开始, 使用. (点)作为分隔符.<br>指定queue的所有sub-queue可以这样指定: <strong>yarn.scheduler.capacity.<queue-path>.queues</queue-path></strong>. 子队列并不自动继承queue的属性。<br>下面是一个例子，a\b\c为root的子队列，然后a\b还有自己的子队列:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.scheduler.capacity.root.queues<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>a,b,c<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>The queues at the this level (root is the root queue).</div><div class="line">  <span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.scheduler.capacity.root.a.queues<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>a1,a2<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>The queues at the this level (root is the root queue).</div><div class="line">  <span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.scheduler.capacity.root.b.queues<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>b1,b2,b3<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span>The queues at the this level (root is the root queue).</div><div class="line">  <span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h4 id="queue属性"><a href="#queue属性" class="headerlink" title="queue属性"></a>queue属性</h4><p>Resource Allocation<br>Property    Description<br>yarn.scheduler.capacity.<queue-path>.capacity    Queue capacity in percentage (%) as a float (e.g. 12.5). The sum of capacities for all queues, at each level, must be equal to 100. Applications in the queue may consume more resources than the queue’s capacity if there are free resources, providing elasticity.<br>yarn.scheduler.capacity.<queue-path>.maximum-capacity    Maximum queue capacity in percentage (%) as a float. This limits the elasticity for applications in the queue. Defaults to -1 which disables it.<br>yarn.scheduler.capacity.<queue-path>.minimum-user-limit-percent    Each queue enforces a limit on the percentage of resources allocated to a user at any given time, if there is demand for resources. The user limit can vary between a minimum and maximum value. The the former (the minimum value) is set to this property value and the latter (the maximum value) depends on the number of users who have submitted applications. For e.g., suppose the value of this property is 25. If two users have submitted applications to a queue, no single user can use more than 50% of the queue resources. If a third user submits an application, no single user can use more than 33% of the queue resources. With 4 or more users, no user can use more than 25% of the queues resources. A value of 100 implies no user limits are imposed. The default is 100. Value is specified as a integer.<br>yarn.scheduler.capacity.<queue-path>.user-limit-factor    The multiple of the queue capacity which can be configured to allow a single user to acquire more resources. By default this is set to 1 which ensures that a single user can never take more than the queue’s configured capacity irrespective of how idle th cluster is. Value is specified as a float.<br>yarn.scheduler.capacity.<queue-path>.maximum-allocation-mb    The per queue maximum limit of memory to allocate to each container request at the Resource Manager. This setting overrides the cluster configuration yarn.scheduler.maximum-allocation-mb. This value must be smaller than or equal to the cluster maximum.<br>yarn.scheduler.capacity.<queue-path>.maximum-allocation-vcores    The per queue maximum limit of virtual cores to allocate to each container request at the Resource Manager. This setting overrides the cluster configuration yarn.scheduler.maximum-allocation-vcores. This value must be smaller than or equal to the cluster maximum.<br>Running and Pending Application Limits<br>The CapacityScheduler supports the following parameters to control the running and pending applications:<br>Property    Description<br>yarn.scheduler.capacity.maximum-applications / yarn.scheduler.capacity.<queue-path>.maximum-applications    Maximum number of applications in the system which can be concurrently active both running and pending. Limits on each queue are directly proportional to their queue capacities and user limits. This is a hard limit and any applications submitted when this limit is reached will be rejected. Default is 10000. This can be set for all queues withyarn.scheduler.capacity.maximum-applications and can also be overridden on a per queue basis by setting yarn.scheduler.capacity.<queue-path>.maximum-applications. Integer value expected.<br>yarn.scheduler.capacity.maximum-am-resource-percent /yarn.scheduler.capacity.<queue-path>.maximum-am-resource-percent    Maximum percent of resources in the cluster which can be used to run application masters - controls number of concurrent active applications. Limits on each queue are directly proportional to their queue capacities and user limits. Specified as a float - ie 0.5 = 50%. Default is 10%. This can be set for all queues with yarn.scheduler.capacity.maximum-am-resource-percent and can also be overridden on a per queue basis by setting yarn.scheduler.capacity.<queue-path>.maximum-am-resource-percent<br>Queue Administration &amp; Permissions<br>The CapacityScheduler supports the following parameters to the administer the queues:<br>Property    Description<br>yarn.scheduler.capacity.<queue-path>.state    The state of the queue. Can be one of RUNNING or STOPPED. If a queue is in STOPPED state, new applications cannot be submitted to itself or any of its child queues. Thus, if the root queue is STOPPEDno applications can be submitted to the entire cluster. Existing applications continue to completion, thus the queue can be drained gracefully. Value is specified as Enumeration.<br>yarn.scheduler.capacity.root.<queue-path>.acl_submit_applications    The ACL which controls who can submit applications to the given queue. If the given user/group has necessary ACLs on the given queue or one of the parent queues in the hierarchy they can submit applications. ACLs for this property are inherited from the parent queue if not specified.<br>yarn.scheduler.capacity.root.<queue-path>.acl_administer_queue    The ACL which controls who can administer applications on the given queue. If the given user/group has necessary ACLs on the given queue or one of the parent queues in the hierarchy they can administer applications. ACLs for this property are inherited from the parent queue if not specified.<br>Note: An ACL is of the form user1, user2spacegroup1, group2. The special value of <em> implies anyone. The special value of space implies no one. The default is </em> for the root queue if not specified.<br>Queue Mapping based on User or Group<br>The CapacityScheduler supports the following parameters to configure the queue mapping based on user or group:<br>Property    Description<br>yarn.scheduler.capacity.queue-mappings    This configuration specifies the mapping of user or group to aspecific queue. You can map a single user or a list of users to queues. Syntax: [u or g]:[name]:[queue_name][,next_mapping]*. Here, u or gindicates whether the mapping is for a user or group. The value is u for user and g for group. name indicates the user name or group name. To specify the user who has submitted the application, %user can be used. queue_name indicates the queue name for which the application has to be mapped. To specify queue name same as user name, %user can be used. To specify queue name same as the name of the primary group for which the user belongs to, %primary_group can be used.<br>yarn.scheduler.capacity.queue-mappings-override.enable    This function is used to specify whether the user specified queues can be overridden. This is a Boolean value and the default value is false.<br>Example:<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">property</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">name</span>&gt;</span>yarn.scheduler.capacity.queue-mappings<span class="tag">&lt;/<span class="name">name</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">value</span>&gt;</span>u:user1:queue1,g:group1:queue2,u:%user:%user,u:user2:%primary_group<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">  <span class="tag">&lt;<span class="name">description</span>&gt;</span></div><div class="line">    Here, <span class="tag">&lt;<span class="name">user1</span>&gt;</span> is mapped to <span class="tag">&lt;<span class="name">queue1</span>&gt;</span>, <span class="tag">&lt;<span class="name">group1</span>&gt;</span> is mapped to <span class="tag">&lt;<span class="name">queue2</span>&gt;</span>, </div><div class="line">    maps users to queues with the same name as user, <span class="tag">&lt;<span class="name">user2</span>&gt;</span> is mapped </div><div class="line">    to queue name same as <span class="tag">&lt;<span class="name">primary</span> <span class="attr">group</span>&gt;</span> respectively. The mappings will be </div><div class="line">    evaluated from left to right, and the first valid mapping will be used.</div><div class="line">  <span class="tag">&lt;/<span class="name">description</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">property</span>&gt;</span></div></pre></td></tr></table></figure></queue-path></queue-path></queue-path></queue-path></queue-path></queue-path></queue-path></queue-path></queue-path></queue-path></queue-path></queue-path></queue-path></p>
<h4 id="其他属性"><a href="#其他属性" class="headerlink" title="其他属性"></a>其他属性</h4><p>Resource Calculator<br>Property    Description<br>yarn.scheduler.capacity.resource-calculator    The ResourceCalculator implementation to be used to compare Resources in the scheduler. The default i.e. org.apache.hadoop.yarn.util.resource.DefaultResourseCalculator only uses Memory while DominantResourceCalculator uses Dominant-resource to compare multi-dimensional resources such as Memory, CPU etc. A Java ResourceCalculator class name is expected.<br>Data Locality<br>Property    Description<br>yarn.scheduler.capacity.node-locality-delay    Number of missed scheduling opportunities after which the CapacityScheduler attempts to schedule rack-local containers. Typically, this should be set to number of nodes in the cluster. By default is setting approximately number of nodes in one rack which is 40. Positive integer value is expected.<br>Reviewing the configuration of the CapacityScheduler</p>
<p>Once the installation and configuration is completed, you can review it after starting the YARN cluster from the web-ui.<br>Start the YARN cluster in the normal manner.<br>Open the ResourceManager web UI.<br>The /scheduler web-page should show the resource usages of individual queues.<br>Changing Queue Configuration</p>
<p>Changing queue properties and adding new queues is very simple. You need to edit conf/capacity-scheduler.xml and run yarn rmadmin -refreshQueues.<br>$ vi $HADOOP_CONF_DIR/capacity-scheduler.xml<br>$ $HADOOP_YARN_HOME/bin/yarn rmadmin -refreshQueues<br>Note: Queues cannot be deleted, only addition of new queues is supported - the updated queue configuration should be a valid one i.e. queue-capacity at each level should be equal to 100%.</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/05/metamap部署/" title="metamap部署" itemprop="url">metamap部署</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-12-05T09:10:52.000Z" itemprop="datePublished"> 发表于 2016-12-05</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="vituralEnv"><a href="#vituralEnv" class="headerlink" title="vituralEnv"></a>vituralEnv</h2><p>先创建执行环境<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">virtualenv metamap</div></pre></td></tr></table></figure></p>
<p>这个命令会在当前目录下生成一个metamap目录，后来查实了一下，其实后面是指定要生成的目标记录的(<code>virtualenv /path/to/tartget/metamap</code>)，便于统一管理所有的env环境。</p>
<p>进入我们刚刚创建的环境:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">root@will-vm:/usr/local/metamap# source metamap/bin/activate</div><div class="line">(metamap) root@will-vm:/usr/local/metamap#</div></pre></td></tr></table></figure></p>
<p>我这里没有使用绝对路径，所以就成了当前目录。目录结构如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">(metamap) root@will-vm:/usr/local/metamap# tree -L 2 metamap</div><div class="line">metamap</div><div class="line">├── bin</div><div class="line">│   ├── activate</div><div class="line">│   ├── activate.csh</div><div class="line">│   ├── activate.fish</div><div class="line">│   ├── activate_this.py</div><div class="line">│   ├── django-admin</div><div class="line">│   ├── django-admin.py</div><div class="line">│   ├── django-admin.pyc</div><div class="line">│   ├── easy_install</div><div class="line">│   ├── easy_install-2.7</div><div class="line">│   ├── pip</div><div class="line">│   ├── pip2</div><div class="line">│   ├── pip2.7</div><div class="line">│   ├── python</div><div class="line">│   ├── python2 -&gt; python</div><div class="line">│   ├── python2.7 -&gt; python</div><div class="line">│   ├── python-config</div><div class="line">│   └── wheel</div><div class="line">├── include</div><div class="line">│   └── python2.7 -&gt; /usr/include/python2.7</div><div class="line">├── lib</div><div class="line">│   └── python2.7</div><div class="line">├── local</div><div class="line">│   ├── bin -&gt; /usr/local/metamap/metamap/bin</div><div class="line">│   ├── include -&gt; /usr/local/metamap/metamap/include</div><div class="line">│   └── lib -&gt; /usr/local/metamap/metamap/lib</div><div class="line">└── pip-selfcheck.json</div></pre></td></tr></table></figure></p>
<p>另外还会在新的env中安装三个基础依赖包：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">(metamap) root@will-vm:/usr/local/metamap# pip list</div><div class="line">pip (8.1.2)</div><div class="line">setuptools (25.1.3)</div><div class="line">wheel (0.29.0)</div></pre></td></tr></table></figure></p>
<p>使用pip freeze &gt; requirements.txt来导出当前环境中的所有python依赖。</p>
<p>然后使用pip install -r path/to/requirements.txt安装，发现有一些是跟os有关的，比如包含Ubuntu的，根本就没有必要安装。所以就只保留了有印象的几个依赖。</p>
<p>最后requirements.txt只剩下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">tlr4-python2-runtime==4.5.3</div><div class="line">Django==1.9.7</div><div class="line">MySQL-python==1.2.5</div><div class="line">pyhs2==0.6.0</div></pre></td></tr></table></figure></p>
<p>如果要退出virtualenv，就使用deactivate。</p>
<h2 id="Gunicorn"><a href="#Gunicorn" class="headerlink" title="Gunicorn"></a>Gunicorn</h2><p>在vituralenv里安装<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pip install gunicorn</div></pre></td></tr></table></figure></p>
<p>进入我们的django项目根目录，也就是manage.py所在的目录：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line">(metamap) root@will-vm:/usr/local/metamap/metamap_django# gunicorn_django -b 0.0.0.0:8089</div><div class="line">!!!</div><div class="line">!!! WARNING: This command is deprecated.</div><div class="line">!!! </div><div class="line">!!!     You should now run your application with the WSGI interface</div><div class="line">!!!     installed with your project. Ex.:</div><div class="line">!!! </div><div class="line">!!!         gunicorn myproject.wsgi:application</div><div class="line">!!! </div><div class="line">!!!     See https://docs.djangoproject.com/en/1.8/howto/deployment/wsgi/gunicorn/</div><div class="line">!!!     for more info.</div><div class="line">!!!</div><div class="line"></div><div class="line">[2016-08-03 19:13:32 +0000] [13020] [INFO] Starting gunicorn 19.6.0</div><div class="line">[2016-08-03 19:13:32 +0000] [13020] [INFO] Listening at: http://0.0.0.0:8089 (13020)</div><div class="line">[2016-08-03 19:13:32 +0000] [13020] [INFO] Using worker: sync</div><div class="line">[2016-08-03 19:13:32 +0000] [13025] [INFO] Booting worker with pid: 13025</div><div class="line">[2016-08-03 19:13:32 +0000] [13025] [ERROR] Exception in worker process</div><div class="line">Traceback (most recent call last):</div><div class="line">  File &quot;/usr/local/metamap/metamap/local/lib/python2.7/site-packages/gunicorn/arbiter.py&quot;, line 557, in spawn_worker</div><div class="line">    worker.init_process()</div><div class="line">  File &quot;/usr/local/metamap/metamap/local/lib/python2.7/site-packages/gunicorn/workers/base.py&quot;, line 126, in init_process</div><div class="line">    self.load_wsgi()</div><div class="line">  File &quot;/usr/local/metamap/metamap/local/lib/python2.7/site-packages/gunicorn/workers/base.py&quot;, line 136, in load_wsgi</div><div class="line">    self.wsgi = self.app.wsgi()</div><div class="line">  File &quot;/usr/local/metamap/metamap/local/lib/python2.7/site-packages/gunicorn/app/base.py&quot;, line 67, in wsgi</div><div class="line">    self.callable = self.load()</div><div class="line">  File &quot;/usr/local/metamap/metamap/local/lib/python2.7/site-packages/gunicorn/app/djangoapp.py&quot;, line 105, in load</div><div class="line">    mod = util.import_module(&quot;gunicorn.app.django_wsgi&quot;)</div><div class="line">  File &quot;/usr/lib/python2.7/importlib/__init__.py&quot;, line 37, in import_module</div><div class="line">    __import__(name)</div><div class="line">  File &quot;/usr/local/metamap/metamap/local/lib/python2.7/site-packages/gunicorn/app/django_wsgi.py&quot;, line 21, in &lt;module&gt;</div><div class="line">    from django.core.management.validation import get_validation_errors</div><div class="line">ImportError: No module named validation</div><div class="line">[2016-08-03 19:13:32 +0000] [13025] [INFO] Worker exiting (pid: 13025)</div><div class="line">[2016-08-03 19:13:32 +0000] [13020] [INFO] Shutting down: Master</div><div class="line">[2016-08-03 19:13:32 +0000] [13020] [INFO] Reason: Worker failed to boot.</div></pre></td></tr></table></figure></p>
<p>查了一下，是版本问题，改用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">(metamap) root@will-vm:/usr/local/metamap/metamap_django# gunicorn metamap_django.wsgi:application -b 0.0.0.0:8089</div><div class="line">[2016-08-03 19:16:10 +0000] [13097] [INFO] Starting gunicorn 19.6.0</div><div class="line">[2016-08-03 19:16:10 +0000] [13097] [INFO] Listening at: http://0.0.0.0:8089 (13097)</div><div class="line">[2016-08-03 19:16:10 +0000] [13097] [INFO] Using worker: sync</div><div class="line">[2016-08-03 19:16:10 +0000] [13102] [INFO] Booting worker with pid: 13102</div></pre></td></tr></table></figure></p>
<p>wsgi为我们生成django项目时，跟settings.py同目录的wsgi.py。然后就可以到浏览器访问了。</p>
<p>看一下我们django自动生成的这个文件内容，可以看到还有：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> os</div><div class="line"></div><div class="line"><span class="keyword">from</span> django.core.wsgi <span class="keyword">import</span> get_wsgi_application</div><div class="line"></div><div class="line">os.environ.setdefault(<span class="string">"DJANGO_SETTINGS_MODULE"</span>, <span class="string">"metamap_django.settings"</span>)</div><div class="line"></div><div class="line">application = get_wsgi_application()</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_wsgi_application</span><span class="params">()</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    The public interface to Django's WSGI support. Should return a WSGI</div><div class="line">    callable.</div><div class="line"></div><div class="line">    Allows us to avoid making django.core.handlers.WSGIHandler public API, in</div><div class="line">    case the internal WSGI implementation changes or moves in the future.</div><div class="line">    """</div><div class="line">    django.setup()</div><div class="line">    <span class="keyword">return</span> WSGIHandler()</div></pre></td></tr></table></figure></p>
<p>晚上整体浏览了一遍Gunicorn官网，整理以下几点注意的地方：</p>
<ul>
<li>可以指定django的settings文件</li>
<li>gunicorn 官网中指定的几个管理master和worker的signal其实都是Linux的kill命令的参数 <code>kill -TERM cat /tmp/xx.pid</code></li>
<li>worker和thread是不一样的概念，前者是进程，后者是线程，worker中包含thread。具体并发数需要压测结果来确定</li>
<li>为了防止出现内存泄露问题，可以为worker指定类似max_request之类的参数在一定阶段重启当前worker</li>
<li>Gunicorn可以动态增加worker实现调优</li>
<li>命令行可以加入运行目录并生成pid</li>
<li><p>环境中添加python插件setproctitle之后就可以为gunicorn进程命名了</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"> (metamap) root@will-vm:/usr/local/metamap/metamap_django# ps -ef | grep gunicorn</div><div class="line">root      2258 10709  0 11:38 pts/26   00:00:00 tailf /tmp/gunicorn_error.log</div><div class="line">root      2494  2264  0 11:38 pts/27   00:00:00 tailf /tmp/gunicorn_access.log</div><div class="line">root      3190  2444  0 11:57 ?        00:00:00 gunicorn: master [will&apos;s metamap]                                                                                                    </div><div class="line">root      3195  3190  2 11:57 ?        00:00:00 gunicorn: worker [will&apos;s metamap]                                                                                                    </div><div class="line">root      3198  3190  2 11:57 ?        00:00:00 gunicorn: worker [will&apos;s metamap]                                                                                                    </div><div class="line">root      3199  3190  2 11:57 ?        00:00:00 gunicorn: worker [will&apos;s metamap]                                                                                                    </div><div class="line">root      3205  3190  2 11:57 ?        00:00:00 gunicorn: worker [will&apos;s metamap]                                                                                                    </div><div class="line">root      3207  3190  2 11:57 ?        00:00:00 gunicorn: worker [will&apos;s metamap]                                                                                                    </div><div class="line">root      3223 17309  0 11:57 pts/25   00:00:00 grep --color=auto gunicorn</div></pre></td></tr></table></figure>
</li>
<li><p>–statsd-host=localhost:8125会启动一个针对gunicorn的监控系统</p>
</li>
<li>master只负责管理worker，不处理请求，worker是真正处理请求的进程</li>
<li>可接受配置文件-c, 具体可配置项，参考<a href="http://docs.gunicorn.org/en/latest/settings.html" target="_blank" rel="external">这里</a></li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># !/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*</span></div><div class="line"><span class="string">'''</span></div><div class="line">created by will</div><div class="line">'''</div><div class="line"></div><div class="line"><span class="keyword">import</span> multiprocessing</div><div class="line"></div><div class="line">print(<span class="string">'gunicorn config is running....'</span>)</div><div class="line"></div><div class="line">bind = <span class="string">"0.0.0.0:8088"</span></div><div class="line">workers = multiprocessing.cpu_count() * <span class="number">2</span> + <span class="number">1</span></div><div class="line">pidfile = <span class="string">'/tmp/gunicorn.pid'</span></div><div class="line">accesslog = <span class="string">'/tmp/gunicorn_access.log'</span></div><div class="line">errorlog = <span class="string">'/tmp/gunicorn_error.log'</span></div><div class="line">loglevel = <span class="string">'info'</span></div><div class="line">capture_output = <span class="keyword">True</span></div><div class="line">statsd_host = <span class="string">'0.0.0.0:8888'</span></div><div class="line">proc_name = <span class="string">'will\'s metamap'</span></div><div class="line">daemon = <span class="keyword">True</span></div></pre></td></tr></table></figure>
<p>然后运行的时候指定此文件的位置即可。</p>
<p>注意：</p>
<ul>
<li>启动指定wsgi位置的时候，需要是<code>gunicorn metamap_django.wsgi:application</code>，要注意的是metamap_django与wsgi之间是<code>.</code>，而不是能是文件路径<code>/</code>，否则启动gunicorn的时候报错:import by filename is not supported gunicorn</li>
<li>执行 kill -HUP cat /tmp/xx/pid来管理master和worker进程</li>
<li>如果要使用supervisord管理进程的话，最好就不要设置<code>daemon</code>为True了</li>
<li>有些东西跟官网说的不一致，比如: statsd_host，django_settings指定settings文件位置，access-log等</li>
</ul>
<p>参考：</p>
<ul>
<li><a href="http://ju.outofmemory.cn/entry/105202" target="_blank" rel="external">http://ju.outofmemory.cn/entry/105202</a></li>
<li><a href="http://zqpythonic.qiniucdn.com/data/20130901152951/index.html" target="_blank" rel="external">http://zqpythonic.qiniucdn.com/data/20130901152951/index.html</a></li>
</ul>
<h2 id="Django"><a href="#Django" class="headerlink" title="Django"></a>Django</h2><p>注意一下几点：</p>
<ol>
<li><p>为django创建多个settings文件，如prod.py,test.py等,之后在gunicorn的配置文件里指定需要的配置文件即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># !/usr/bin/env python</span></div><div class="line"><span class="comment"># -*- coding: utf-8 -*</span></div><div class="line"><span class="string">'''</span></div><div class="line">created by will</div><div class="line">'''</div><div class="line"></div><div class="line"><span class="keyword">import</span> multiprocessing, os</div><div class="line"></div><div class="line">print(<span class="string">'gunicorn config is running....'</span>)</div><div class="line"></div><div class="line">bind = <span class="string">"0.0.0.0:8088"</span></div><div class="line">workers = multiprocessing.cpu_count() * <span class="number">2</span> + <span class="number">1</span></div><div class="line">pidfile = <span class="string">'/tmp/gunicorn.pid'</span></div><div class="line"><span class="comment"># accesslog = '/tmp/gunicorn_access.log'</span></div><div class="line">errorlog = <span class="string">'/tmp/gunicorn_error.log'</span></div><div class="line">loglevel = <span class="string">'info'</span></div><div class="line">capture_output = <span class="keyword">True</span></div><div class="line"><span class="comment"># statsd_host = 'localhost:8077'</span></div><div class="line">proc_name = <span class="string">'will\'s metamap'</span></div><div class="line">daemon = <span class="keyword">True</span></div><div class="line"><span class="comment"># 测试确定，这里设置这个参数不生效</span></div><div class="line"><span class="comment"># django_settings = 'metamap.config.prod'</span></div><div class="line"></div><div class="line">os.environ.setdefault(<span class="string">"DJANGO_SETTINGS_MODULE"</span>, <span class="string">"metamap.config.prod"</span>)</div></pre></td></tr></table></figure>
</li>
<li><p>修改settings里的几个选项</p>
</li>
</ol>
<table>
<thead>
<tr>
<th>参数</th>
<th>解释</th>
</tr>
</thead>
<tbody>
<tr>
<td>DEBUG</td>
<td>改为False，不然程序出错的方法栈会直接展示在前端用户那里，不友好。</td>
</tr>
<tr>
<td>ALLOWED_HOSTS</td>
<td>添加可以访问你的项目的几个域名或主机地址，防止<a href="https://docs.djangoproject.com/es/1.9/topics/security/#host-headers-virtual-hosting" target="_blank" rel="external"> HTTP Host header attacks</a></td>
</tr>
<tr>
<td>ADMINS</td>
<td>当程序出错的时候django会发送错误给这些邮件列表</td>
</tr>
</tbody>
</table>
<p>参考：<a href="https://docs.djangoproject.com/es/1.9/topics/settings/" target="_blank" rel="external">https://docs.djangoproject.com/es/1.9/topics/settings/</a></p>
<ol>
<li>确认有处理view里抛出的异常的逻辑，如果没有的话，自定义一个处理异常的middleware，注册到setting离去。</li>
</ol>
<p>参考：<a href="https://docs.djangoproject.com/ja/1.9/topics/http/middleware/" target="_blank" rel="external">https://docs.djangoproject.com/ja/1.9/topics/http/middleware/</a></p>
<ol>
<li>将django的所有的静态文件整理到指定文件夹<br>在settings.py里设置static_root，然后执行<code>./manage.py collectstatic</code>，这个命令就会把所有的静态资源整理到static_root里面。</li>
</ol>
<p>参考：<a href="https://docs.djangoproject.com/en/1.10/howto/static-files/#deployment" target="_blank" rel="external">https://docs.djangoproject.com/en/1.10/howto/static-files/#deployment</a></p>
<h2 id="Nginx"><a href="#Nginx" class="headerlink" title="Nginx"></a>Nginx</h2><p>nginx的主要功能是分发动态请求，以及处理静态资源请求。</p>
<p>配置文件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#user  nobody;</div><div class="line">worker_processes  1;</div><div class="line"></div><div class="line">events &#123;</div><div class="line">    worker_connections  1024;</div><div class="line">&#125;</div><div class="line"></div><div class="line">http &#123;</div><div class="line">    include       mime.types;</div><div class="line">    default_type  application/octet-stream;</div><div class="line"></div><div class="line">    #log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</div><div class="line">    #                  &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</div><div class="line">    #                  &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</div><div class="line"></div><div class="line">    access_log  /tmp/nginx.access.log combined;</div><div class="line"></div><div class="line">    sendfile        on;</div><div class="line">    </div><div class="line">    keepalive_timeout  65;</div><div class="line"></div><div class="line">    #gzip  on;</div><div class="line"></div><div class="line">     upstream app_server &#123;</div><div class="line"></div><div class="line">        # 指定后台地址</div><div class="line">        server 192.168.244.128:8088 fail_timeout=0;</div><div class="line">      &#125;</div><div class="line"></div><div class="line">      server &#123;</div><div class="line">        listen 80;</div><div class="line">        client_max_body_size 4G;</div><div class="line"></div><div class="line">        # 指定域名</div><div class="line">        server_name 192.168.244.128;</div><div class="line"></div><div class="line">        keepalive_timeout 5;</div><div class="line"></div><div class="line">        # static文件夹所在的根目录</div><div class="line">        root /usr/local/metamap;</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">          # 如果是静态资源就自己处理，如果不是就发送给proxy_to_app</div><div class="line">          # try_files-&gt;按顺序检查文件是否存在，返回第一个找到的文件或文件夹（结尾加斜线表示为文件夹），如果所有的文件或文件夹都找不到，会进行一个内部重定向到最后一个参数</div><div class="line">          try_files $uri @proxy_to_app;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        location @proxy_to_app &#123;</div><div class="line">          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;</div><div class="line">          # enable this if and only if you use HTTPS</div><div class="line">          # proxy_set_header X-Forwarded-Proto https;</div><div class="line">          proxy_set_header Host $http_host;</div><div class="line">          # we don&apos;t want nginx trying to do something clever with</div><div class="line">          # redirects, we set the Host: header above already.</div><div class="line">          proxy_redirect off;</div><div class="line">          proxy_pass http://app_server;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        error_page 500 502 503 504 /50x.html;</div><div class="line">        location = /50x.html &#123;</div><div class="line">          root html;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line"></div><div class="line"></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h2 id="未解决的问题"><a href="#未解决的问题" class="headerlink" title="未解决的问题"></a>未解决的问题</h2><p>不定时出现找不到静态资源的问题：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">2016-08-04 10:04:10,128 [MainThread:-1219164416] [django.request:182] [base:get_response] [WARNING]- Not Found: /static/js/bootstrap.js</div><div class="line">2016-08-04 10:04:10,126 [MainThread:-1219164416] [django.request:182] [base:get_response] [WARNING]- Not Found: /static/js/jquery.js</div><div class="line">2016-08-04 10:04:10,148 [MainThread:-1219164416] [django.request:182] [base:get_response] [WARNING]- Not Found: /static/css/bootstrap.css</div><div class="line">2016-08-04 10:04:10,140 [MainThread:-1219164416] [django.request:182] [base:get_response] [WARNING]- Not Found: /static/style.css</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/05/celery队列路由/" title="celery队列路由" itemprop="url">celery队列路由</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-12-05T09:10:27.000Z" itemprop="datePublished"> 发表于 2016-12-05</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>同一个app里如果有多种不同的任务，也就是分由不同的task进行处理。假设只有一个worker的话，task1耗时特别长，有可能会阻塞短平快的task2、task3、task4的执行，也就是面临着小任务饿死的情况。</p>
<p>这时候我们就需要使用队列路由，将不同类型的任务路由至不同的queue，并且启动多个worker，分别负责消费指定queue的任务。这样，长少慢的任务就不会影响短频快的小任务的执行了。</p>
<h2 id="自动路由"><a href="#自动路由" class="headerlink" title="自动路由"></a>自动路由</h2><p>CELERY_CREATE_MISSING_QUEUES开启后，如果queue没有在CELERY_QUEUES中的话会自动创建。</p>
<p>假设我们有两个server：x y。他俩负责普通的task。然后z server只处理特定的跟种子有关的task，那么可以这样配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CELERY_ROUTES = &#123;&apos;feed.tasks.import_feed&apos;: &#123;&apos;queue&apos;: &apos;feeds&apos;&#125;&#125;</div></pre></td></tr></table></figure></p>
<p>所有feed.tasks.import_feed的任务都会被放进feeds队列，其他的就放进默认的队列【celery】。</p>
<p>然后启动z server的时候指定一下队列名称：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">user@z:/$ celery -A proj worker -Q feeds</div></pre></td></tr></table></figure></p>
<h2 id="修改默认队列的名称"><a href="#修改默认队列的名称" class="headerlink" title="修改默认队列的名称"></a>修改默认队列的名称</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> kombu <span class="keyword">import</span> Exchange, Queue</div><div class="line"></div><div class="line">CELERY_DEFAULT_QUEUE = <span class="string">'default'</span></div><div class="line">CELERY_QUEUES = (</div><div class="line">    Queue(<span class="string">'default'</span>, Exchange(<span class="string">'default'</span>), routing_key=<span class="string">'default'</span>),</div><div class="line">)</div></pre></td></tr></table></figure>
<h2 id="队列定义"><a href="#队列定义" class="headerlink" title="队列定义"></a>队列定义</h2><p>celery隐藏了后面负责的AMQP协议，但是有人也想知道怎样声明队列。</p>
<p>下面是创建一个video队列：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">&#123;&apos;exchange&apos;: &apos;video&apos;,</div><div class="line"> &apos;exchange_type&apos;: &apos;direct&apos;,</div><div class="line"> &apos;routing_key&apos;: &apos;video&apos;&#125;</div></pre></td></tr></table></figure></p>
<p>非AMQP协议的后端不支持exchange。</p>
<h2 id="手动配置"><a href="#手动配置" class="headerlink" title="手动配置"></a>手动配置</h2><p>还是上面一样，xy处理普通任务，z处理feed相关任务：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> kombu <span class="keyword">import</span> Queue</div><div class="line"></div><div class="line">CELERY_DEFAULT_QUEUE = <span class="string">'default'</span></div><div class="line">CELERY_QUEUES = (</div><div class="line">    Queue(<span class="string">'default'</span>,    routing_key=<span class="string">'task.#'</span>),</div><div class="line">    Queue(<span class="string">'feed_tasks'</span>, routing_key=<span class="string">'feed.#'</span>),</div><div class="line">)</div><div class="line">CELERY_DEFAULT_EXCHANGE = <span class="string">'tasks'</span></div><div class="line">CELERY_DEFAULT_EXCHANGE_TYPE = <span class="string">'topic'</span></div><div class="line">CELERY_DEFAULT_ROUTING_KEY = <span class="string">'task.default'</span></div></pre></td></tr></table></figure></p>
<p>CELERY_QUEUES里定义了一串队列的实例。如果没有设置exchange或者没给key设置exchange类型，会按照默认的CELERY_DEFAULT_EXCHANGE、CELERY_DEFAULT_EXCHANGE_TYPE。</p>
<p>要指定某个task的路由，需要在CELERY_ROUTES里添加一个入口<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">CELERY_ROUTES = &#123;</div><div class="line">        <span class="string">'feeds.tasks.import_feed'</span>: &#123;</div><div class="line">            <span class="string">'queue'</span>: <span class="string">'feed_tasks'</span>,</div><div class="line">            <span class="string">'routing_key'</span>: <span class="string">'feed.import'</span>,</div><div class="line">        &#125;,</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>也可以在代码调用的时候指定：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> feeds.tasks <span class="keyword">import</span> import_feed</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>import_feed.apply_async(args=[<span class="string">'http://cnn.com/rss'</span>],</div><div class="line"><span class="meta">... </span>                        queue=<span class="string">'feed_tasks'</span>,</div><div class="line"><span class="meta">... </span>                        routing_key=<span class="string">'feed.import'</span>)</div></pre></td></tr></table></figure></p>
<p>启动z：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">user@z:/$ celery -A proj worker -Q feed_tasks --hostname=z@%h</div></pre></td></tr></table></figure></p>
<p>还要配置x y启动的时候只消费默认队列default：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">user@x:/$ celery -A proj worker -Q default --hostname=x@%h</div><div class="line">user@y:/$ celery -A proj worker -Q default --hostname=y@%h</div></pre></td></tr></table></figure></p>
<p>这些队列也可以混搭在一起，如果你的server都能处理的话，也可以这么做：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">user@z:/$ celery -A proj worker -Q feed_tasks,default --hostname=z@%h</div></pre></td></tr></table></figure></p>
<p>要是想添加一个在其他exchange上的队列，自己定义好exchange以及exchange类型就行：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> kombu <span class="keyword">import</span> Exchange, Queue</div><div class="line"></div><div class="line">CELERY_QUEUES = (</div><div class="line">    Queue(<span class="string">'feed_tasks'</span>,    routing_key=<span class="string">'feed.#'</span>),</div><div class="line">    Queue(<span class="string">'regular_tasks'</span>, routing_key=<span class="string">'task.#'</span>),</div><div class="line">    Queue(<span class="string">'image_tasks'</span>,   exchange=Exchange(<span class="string">'mediatasks'</span>, type=<span class="string">'direct'</span>),</div><div class="line">                           routing_key=<span class="string">'image.compress'</span>),</div><div class="line">)</div></pre></td></tr></table></figure></p>
<p>要是对这部分内容有疑问，可以自行查阅一下AMQP。</p>
<h2 id="初识AMQP"><a href="#初识AMQP" class="headerlink" title="初识AMQP"></a>初识AMQP</h2><h4 id="message"><a href="#message" class="headerlink" title="message"></a>message</h4><p>message包含header和body。celery使用head来存储内容类型和内容编码。内容类型用来序列化message。body中是要执行的task的name，id，参数以及其他元数据信息。</p>
<p>下面是一个例子：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="string">'task'</span>: <span class="string">'myapp.tasks.add'</span>,</div><div class="line"> <span class="string">'id'</span>: <span class="string">'54086c5e-6193-4575-8308-dbab76798756'</span>,</div><div class="line"> <span class="string">'args'</span>: [<span class="number">4</span>, <span class="number">4</span>],</div><div class="line"> <span class="string">'kwargs'</span>: &#123;&#125;&#125;</div></pre></td></tr></table></figure></p>
<h4 id="Producers-consumers，-brokers"><a href="#Producers-consumers，-brokers" class="headerlink" title="Producers, consumers， brokers"></a>Producers, consumers， brokers</h4><p>发送message的客户端叫做publisher，也叫producer。收到message的就叫做consumer。</p>
<p>broker是message所在的server，把message从producer路由到consumer。</p>
<h4 id="Exchanges-queues，-routing-keys"><a href="#Exchanges-queues，-routing-keys" class="headerlink" title="Exchanges, queues， routing keys"></a>Exchanges, queues， routing keys</h4><ol>
<li>message被发送给exchange</li>
<li>exchange路由message到一或多个队列。有多种exchange类型，提供不同的路由方式，实现不同的消息场景</li>
<li>message在队列中等着consumer消费</li>
<li>当message被ack之后就会从队列中移除</li>
</ol>
<p>下面是发送与接收message的必要步骤：</p>
<ol>
<li>创建一个exchange</li>
<li>创建一个队列</li>
<li>把队列绑定到exchange上</li>
</ol>
<p>celery自动为CELERY_QUEUES创建了以上这些对象【除非你关闭了自动创建不存在队列的配置】。</p>
<p>下面是一个包含三个队列的配置，一个video，一个image，还一个默认的：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> kombu <span class="keyword">import</span> Exchange, Queue</div><div class="line"></div><div class="line">CELERY_QUEUES = (</div><div class="line">    Queue(<span class="string">'default'</span>, Exchange(<span class="string">'default'</span>), routing_key=<span class="string">'default'</span>),</div><div class="line">    Queue(<span class="string">'videos'</span>,  Exchange(<span class="string">'media'</span>),   routing_key=<span class="string">'media.video'</span>),</div><div class="line">    Queue(<span class="string">'images'</span>,  Exchange(<span class="string">'media'</span>),   routing_key=<span class="string">'media.image'</span>),</div><div class="line">)</div><div class="line">CELERY_DEFAULT_QUEUE = <span class="string">'default'</span></div><div class="line">CELERY_DEFAULT_EXCHANGE_TYPE = <span class="string">'direct'</span></div><div class="line">CELERY_DEFAULT_ROUTING_KEY = <span class="string">'default'</span></div></pre></td></tr></table></figure></p>
<h4 id="Exchange类型"><a href="#Exchange类型" class="headerlink" title="Exchange类型"></a>Exchange类型</h4><p>标准的有：direct, topic, fanout, headers。非标准的就是一些rabbitMQ的插件了。</p>
<h5 id="direct"><a href="#direct" class="headerlink" title="direct"></a>direct</h5><p>匹配精确的routing key，绑定到routing key video的队列只会接收带有video routing key的message。</p>
<h5 id="topc"><a href="#topc" class="headerlink" title="topc"></a>topc</h5><p>支持对号隔开、带有通配符的routing key。</p>
<h4 id="相关API"><a href="#相关API" class="headerlink" title="相关API"></a>相关API</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">exchange.declare(exchange_name, type, passive,</div><div class="line">durable, auto_delete, internal)</div><div class="line">Declares an exchange by name.</div><div class="line"></div><div class="line">See amqp:Channel.exchange_declare.</div><div class="line"></div><div class="line">Parameters:	</div><div class="line">    passive – Passive means the exchange won’t be created, but you can use this to check if the exchange already exists.</div><div class="line">    durable – Durable exchanges are persistent. That is - they survive a broker restart.</div><div class="line">    auto_delete – This means the queue will be deleted by the broker when there are no more queues using it.</div><div class="line">    queue.declare(queue_name, passive, durable, exclusive, auto_delete)</div><div class="line">    Declares a queue by name.</div><div class="line"></div><div class="line">See amqp:Channel.queue_declare</div><div class="line"></div><div class="line">Exclusive queues can only be consumed from by the current connection. Exclusive also implies auto_delete.</div><div class="line"></div><div class="line">queue.bind(queue_name, exchange_name, routing_key)</div><div class="line">Binds a queue to an exchange with a routing key.</div><div class="line"></div><div class="line">Unbound queues will not receive messages, so this is necessary.</div><div class="line"></div><div class="line">See amqp:Channel.queue_bind</div><div class="line"></div><div class="line">queue.delete(name, if_unused=False, if_empty=False)</div><div class="line">Deletes a queue and its binding.</div><div class="line"></div><div class="line">See amqp:Channel.queue_delete</div><div class="line"></div><div class="line">exchange.delete(name, if_unused=False)¶</div><div class="line">Deletes an exchange.</div><div class="line"></div><div class="line">See amqp:Channel.exchange_delete</div></pre></td></tr></table></figure>
<h4 id="使用API"><a href="#使用API" class="headerlink" title="使用API"></a>使用API</h4><p>自带了一个工具 celery amqp，用来在命令行访问AMQP API，执行创建/删除队列或exchange的，清空队列或者正在发送的message。也能在没有AMQP broker的上面使用。</p>
<p>可以在celery amap后面指定参数来调用API, 或者不指定参数，就进入了shell模式：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ celery -A proj amqp</div><div class="line">-&gt; connecting to amqp://guest@localhost:5672/.</div><div class="line">-&gt; connected.</div><div class="line">1&gt;</div></pre></td></tr></table></figure></p>
<p>这里的1是你执行命令个数的编号。可以输入help，这个模式也支持自动补全。</p>
<p>下面是创建队列的例子<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">$ celery -A proj amqp</div><div class="line">1&gt; exchange.declare testexchange direct</div><div class="line">ok.</div><div class="line">2&gt; queue.declare testqueue</div><div class="line">ok. queue:testqueue messages:0 consumers:0.</div><div class="line">3&gt; queue.bind testqueue testexchange testkey</div><div class="line">ok.</div></pre></td></tr></table></figure></p>
<p>这里队列名称是testqueue，使用routing key testkey绑定了exchange为testexchange。</p>
<p>现在开始所有发送到exchange  testchange的message，只要她的routing key是testkey，那么他就会进入testqueue这个队列。我们可以使用basic.publish来发送一个message:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">4&gt; basic.publish &apos;This is a message!&apos; testexchange testkey</div><div class="line">ok.</div></pre></td></tr></table></figure></p>
<p>现在message已经发送出去了，你可以使用basic.get命令抽取它了(这个命令指示用来维护task的，正常服务应该使用basic.consume替代)。</p>
<p>从队列中pop出一条message：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">5&gt; basic.get testqueue</div><div class="line">&#123;&apos;body&apos;: &apos;This is a message!&apos;,</div><div class="line"> &apos;delivery_info&apos;: &#123;&apos;delivery_tag&apos;: 1,</div><div class="line">                   &apos;exchange&apos;: u&apos;testexchange&apos;,</div><div class="line">                   &apos;message_count&apos;: 0,</div><div class="line">                   &apos;redelivered&apos;: False,</div><div class="line">                   &apos;routing_key&apos;: u&apos;testkey&apos;&#125;,</div><div class="line"> &apos;properties&apos;: &#123;&#125;&#125;</div></pre></td></tr></table></figure></p>
<p>AMQP使用ack来确认某个message被消费并且成功执行。如果message还没有被ack，consumer channel就关闭了，那么这个message就会被传递给其他的consumer。</p>
<p>注意传递的tag在上面结构中已经有了。在一个连接channel内，每个接收到的message都有唯一的传递tag，这个tag用来ack这个message。还要注意，传递tag在多个连接之中并不是唯一的，也就是说连接1中的连接tag为1的message是A，连接2中的连接tag为1的message有可能就是B。</p>
<p>使用basic.ack来加上这个标记：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">6&gt; basic.ack 1</div><div class="line">ok.</div></pre></td></tr></table></figure></p>
<p>记得要在测试会话完成后清空刚才创建的message：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">7&gt; queue.delete testqueue</div><div class="line">ok. 0 messages deleted.</div><div class="line">8&gt; exchange.delete testexchange</div><div class="line">ok.</div></pre></td></tr></table></figure></p>
<h2 id="Routing-Tasks"><a href="#Routing-Tasks" class="headerlink" title="Routing Tasks"></a>Routing Tasks</h2><h4 id="定义队列"><a href="#定义队列" class="headerlink" title="定义队列"></a>定义队列</h4><p>下面是一个包含三个队列定义的例子，一个是video，一个是images还有一个默认的队列<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">default_exchange = Exchange(<span class="string">'default'</span>, type=<span class="string">'direct'</span>)</div><div class="line">media_exchange = Exchange(<span class="string">'media'</span>, type=<span class="string">'direct'</span>)</div><div class="line"></div><div class="line">CELERY_QUEUES = (</div><div class="line">    Queue(<span class="string">'default'</span>, default_exchange, routing_key=<span class="string">'default'</span>),</div><div class="line">    Queue(<span class="string">'videos'</span>, media_exchange, routing_key=<span class="string">'media.video'</span>),</div><div class="line">    Queue(<span class="string">'images'</span>, media_exchange, routing_key=<span class="string">'media.image'</span>)</div><div class="line">)</div><div class="line">CELERY_DEFAULT_QUEUE = <span class="string">'default'</span></div><div class="line">CELERY_DEFAULT_EXCHANGE = <span class="string">'default'</span></div><div class="line">CELERY_DEFAULT_ROUTING_KEY = <span class="string">'default'</span></div></pre></td></tr></table></figure></p>
<p>若没有指定特定路由就都进入CELERY_DEFAULT_QUEUE里。</p>
<h4 id="指定task目的地"><a href="#指定task目的地" class="headerlink" title="指定task目的地"></a>指定task目的地</h4><p>按照如下顺序决定message的目的地：</p>
<ol>
<li>在CELERY_ROUTES中定义的路由</li>
<li>Task.apply_async()中指定的路由参数</li>
<li>在Task自身中定义的相关属性</li>
</ol>
<p>最好不要硬编码这些配置，使用 Routers来读取配置，这是最灵活的方式。但是一些敏感的默认值还是可以被设置为任务属性。</p>
<h4 id="Routers"><a href="#Routers" class="headerlink" title="Routers"></a>Routers</h4><p>Router类是用来决定某个task的路由选项的。</p>
<p>我们只需要创建一个新的路由类，带有一个route_for_task方法：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyRouter</span><span class="params">(object)</span>:</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">route_for_task</span><span class="params">(self, task, args=None, kwargs=None)</span>:</span></div><div class="line">        <span class="keyword">if</span> task == <span class="string">'myapp.tasks.compress_video'</span>:</div><div class="line">            <span class="keyword">return</span> &#123;<span class="string">'exchange'</span>: <span class="string">'video'</span>,</div><div class="line">                    <span class="string">'exchange_type'</span>: <span class="string">'topic'</span>,</div><div class="line">                    <span class="string">'routing_key'</span>: <span class="string">'video.compress'</span>&#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">None</span></div></pre></td></tr></table></figure></p>
<p>如果返回值中包含了 queue，那么会在CELERY_QUEUES里定义的配置上扩展，也就是会继承既有的配置。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;&apos;queue&apos;: &apos;video&apos;, &apos;routing_key&apos;: &apos;video.compress&apos;&#125;</div></pre></td></tr></table></figure></p>
<p>就变成了<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;&apos;queue&apos;: &apos;video&apos;,</div><div class="line"> &apos;exchange&apos;: &apos;video&apos;,</div><div class="line"> &apos;exchange_type&apos;: &apos;topic&apos;,</div><div class="line"> &apos;routing_key&apos;: &apos;video.compress&apos;&#125;</div></pre></td></tr></table></figure></p>
<p>完事儿后把Router放进CELERY_ROUTES配置信息里就好了。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CELERY_ROUTES = (MyRouter(), )</div></pre></td></tr></table></figure></p>
<p>或者<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">CELERY_ROUTES = (&apos;myapp.routers.MyRouter&apos;, )</div></pre></td></tr></table></figure></p>
<p>其实对于上面那种简单的路由规则， 也可以直接写在配置里：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">CELERY_ROUTES = (&#123;&apos;myapp.tasks.compress_video&apos;: &#123;</div><div class="line">                        &apos;queue&apos;: &apos;video&apos;,</div><div class="line">                        &apos;routing_key&apos;: &apos;video.compress&apos;</div><div class="line">                 &#125;&#125;, )</div></pre></td></tr></table></figure></p>
<h4 id="广播"><a href="#广播" class="headerlink" title="广播"></a>广播</h4><p>Celery也支持广播路由。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">from kombu.common import Broadcast</div><div class="line"></div><div class="line">CELERY_QUEUES = (Broadcast(&apos;broadcast_tasks&apos;), )</div><div class="line"></div><div class="line">CELERY_ROUTES = &#123;&apos;tasks.reload_cache&apos;: &#123;&apos;queue&apos;: &apos;broadcast_tasks&apos;&#125;&#125;</div></pre></td></tr></table></figure></p>
<p>这样，tasks.reload_cache任务就可以发送给每个消费这个队列的worker了。</p>
<p>注意celery的结果并没有定义如果两个任务都有同一个task_id。如果同样的task被分发给多个worker，那么state历史可能也不会被保存。</p>
<p>这样的话，设置task.ignore_result是一个不错的选择。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/05/Ember-data---record操作/" title="Ember-data---record操作" itemprop="url">Ember-data---record操作</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-12-05T09:09:52.000Z" itemprop="datePublished"> 发表于 2016-12-05</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="查询record"><a href="#查询record" class="headerlink" title="查询record"></a>查询record</h2><h3 id="抽取单个record"><a href="#抽取单个record" class="headerlink" title="抽取单个record"></a>抽取单个record</h3><p>使用 <a href="http://emberjs.com/api/data/classes/DS.Store.html#method_findRecord" target="_blank" rel="external"><code>store.findRecord()</code></a>方法，按照id和type进行查询. 返回一个包含对应record的promise:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> post = <span class="keyword">this</span>.store.findRecord(<span class="string">'post'</span>, <span class="number">1</span>); <span class="comment">// =&gt; GET /posts/1</span></div></pre></td></tr></table></figure>
<p>使用 <a href="http://emberjs.com/api/data/classes/DS.Store.html#method_peekRecord" target="_blank" rel="external"><code>store.peekRecord()</code></a>.跟上面的一样，但是只查询store中当前已经存在的record，不会向后端server请求:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> post = <span class="keyword">this</span>.store.peekRecord(<span class="string">'post'</span>, <span class="number">1</span>); <span class="comment">// =&gt; no network request</span></div></pre></td></tr></table></figure>
<h3 id="抽取多个Records"><a href="#抽取多个Records" class="headerlink" title="抽取多个Records"></a>抽取多个Records</h3><p>使用 <a href="http://emberjs.com/api/data/classes/DS.Store.html#method_findAll" target="_blank" rel="external"><code>store.findAll()</code></a>查询某个类型的所有record:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> posts = <span class="keyword">this</span>.store.findAll(<span class="string">'post'</span>); <span class="comment">// =&gt; GET /posts</span></div></pre></td></tr></table></figure>
<p>参上： <a href="http://emberjs.com/api/data/classes/DS.Store.html#method_peekAll" target="_blank" rel="external"><code>store.peekAll()</code></a>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> posts = <span class="keyword">this</span>.store.peekAll(<span class="string">'post'</span>); <span class="comment">// =&gt; no network request</span></div></pre></td></tr></table></figure>
<p><code>store.findAll()</code> 返回的<code>PromiseArray</code> 包含<br><code>RecordArray</code> 。 <code>store.peekAll</code>直接返回<code>RecordArray</code>.</p>
<p>注意<code>RecordArray</code>并不是JavaScript array，而是一个实现了<a href="http://emberjs.com/api/classes/Ember.Enumerable.html" target="_blank" rel="external"><code>Ember.Enumerable</code></a>的对象，所以如果要按照index访问数据，不能使用 <code>[]</code>，而应该使用 <code>objectAt(index)</code> .</p>
<h3 id="查询多个Records"><a href="#查询多个Records" class="headerlink" title="查询多个Records"></a>查询多个Records</h3><p>可以查一些满足某些范式的record。<br><a href="http://emberjs.com/api/data/classes/DS.Store.html#method_query" target="_blank" rel="external"><code>store.query()</code></a>会发起一个带有查询参数的GET请求，返回值跟findAll一样是一个 <code>PromiseArray</code>.</p>
<p>找出所有名字叫<code>Peter</code>的<code>person</code> models :</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// GET to /persons?filter[name]=Peter</span></div><div class="line"><span class="keyword">this</span>.store.query(<span class="string">'person'</span>, &#123; <span class="attr">filter</span>: &#123; <span class="attr">name</span>: <span class="string">'Peter'</span> &#125; &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">peters</span>) </span>&#123;</div><div class="line">  <span class="comment">// Do something with `peters`</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h3 id="查询单个Record"><a href="#查询单个Record" class="headerlink" title="查询单个Record"></a>查询单个Record</h3><p><a href="http://emberjs.com/api/data/classes/DS.Store.html#method_queryRecord" target="_blank" rel="external"><code>store.queryRecord()</code></a>返回一个promise。</p>
<p>查询邮箱是’tomster@example.com’ 的person model:<br><code>tomster@example.com</code>:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// GET to /persons?filter[email]=tomster@example.com</span></div><div class="line"><span class="keyword">this</span>.store.queryRecord(<span class="string">'person'</span>, &#123; <span class="attr">filter</span>: &#123; <span class="attr">email</span>: <span class="string">'tomster@example.com'</span> &#125; &#125;).then(<span class="function"><span class="keyword">function</span>(<span class="params">tomster</span>) </span>&#123;</div><div class="line">  <span class="comment">// do something with `tomster`</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="创建、更新与删除"><a href="#创建、更新与删除" class="headerlink" title="创建、更新与删除"></a>创建、更新与删除</h2><h2 id="创建"><a href="#创建" class="headerlink" title="创建"></a>创建</h2><p><a href="http://emberjs.com/api/data/classes/DS.Store.html#method_createRecord" target="_blank" rel="external"><code>createRecord()</code></a></p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">store.createRecord(<span class="string">'post'</span>, &#123;</div><div class="line">  <span class="attr">title</span>: <span class="string">'Rails is Omakase'</span>,</div><div class="line">  <span class="attr">body</span>: <span class="string">'Lorem ipsum'</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>在controller或者route中直接调用 <code>this.store</code>就可以获得store对象.</p>
<h2 id="更新"><a href="#更新" class="headerlink" title="更新"></a>更新</h2><figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">this</span>.store.findRecord(<span class="string">'person'</span>, <span class="number">1</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">tyrion</span>) </span>&#123;</div><div class="line">  <span class="comment">// ...after the record has loaded</span></div><div class="line">  tyrion.set(<span class="string">'firstName'</span>, <span class="string">"Yollo"</span>);</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>Ember中修改属性特别便捷。例如，你可以使用 <code>Ember.Object</code>的<br><a href="http://emberjs.com/api/classes/Ember.Object.html#method_incrementProperty" target="_blank" rel="external"><code>incrementProperty</code></a> helper:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">person.incrementProperty(<span class="string">'age'</span>); <span class="comment">// Happy birthday!</span></div></pre></td></tr></table></figure>
<h2 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h2><p>执行Model的任意实例的<a href="http://emberjs.com/api/data/classes/DS.Model.html#method_save" target="_blank" rel="external"><code>save()</code></a>方法都会触发网络请求.</p>
<p>Ember Data会跟踪每个record的状态。这样当存储新创建的record和已经存在的record的时候就能区别对待。</p>
<p>Ember Data默认<code>POST</code> 新创建的record到它的type对应的url.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> post = store.createRecord(<span class="string">'post'</span>, &#123;</div><div class="line">  <span class="attr">title</span>: <span class="string">'Rails is Omakase'</span>,</div><div class="line">  <span class="attr">body</span>: <span class="string">'Lorem ipsum'</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line">post.save(); <span class="comment">// =&gt; POST to '/posts'</span></div></pre></td></tr></table></figure>
<p>已经存在的record使用HTTP的 <code>PATCH</code>动作.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">store.findRecord(<span class="string">'post'</span>, <span class="number">1</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">post</span>) </span>&#123;</div><div class="line">  post.get(<span class="string">'title'</span>); <span class="comment">// =&gt; "Rails is Omakase"</span></div><div class="line"></div><div class="line">  post.set(<span class="string">'title'</span>, <span class="string">'A new post'</span>);</div><div class="line"></div><div class="line">  post.save(); <span class="comment">// =&gt; PATCH to '/posts/1'</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>你可以通过record的<br><a href="http://emberjs.com/api/data/classes/DS.Model.html#property_hasDirtyAttributes" target="_blank" rel="external"><code>hasDirtyAttributes</code></a><br>属性来辨别是否有没有提交的修改. 也可以使用<br><a href="http://emberjs.com/api/data/classes/DS.Model.html#method_changedAttributes" target="_blank" rel="external"><code>changedAttributes()</code></a><br>方法辨别，哪些属性修改了，哪些没有. <code>changedAttributes</code>返回一个对象，key是被修改的属性名称，值是<code>[oldValue, newValue]</code>.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">person.get(<span class="string">'isAdmin'</span>);            <span class="comment">//=&gt; false</span></div><div class="line">person.get(<span class="string">'hasDirtyAttributes'</span>); <span class="comment">//=&gt; false</span></div><div class="line">person.set(<span class="string">'isAdmin'</span>, <span class="literal">true</span>);</div><div class="line">person.get(<span class="string">'hasDirtyAttributes'</span>); <span class="comment">//=&gt; true</span></div><div class="line">person.changedAttributes();       <span class="comment">//=&gt; &#123; isAdmin: [false, true] &#125;</span></div></pre></td></tr></table></figure>
<p>这时，你可以调用save()方法持久化这些改变，也可以调用<br><a href="http://emberjs.com/api/data/classes/DS.Model.html#method_rollbackAttributes" target="_blank" rel="external"><code>rollbackAttributes()</code></a><br>回滚这些修改。如果这个record <code>isNew</code>【是新建的】，那么就会被从store中删除.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">person.get(<span class="string">'hasDirtyAttributes'</span>); <span class="comment">//=&gt; true</span></div><div class="line">person.changedAttributes();       <span class="comment">//=&gt; &#123; isAdmin: [false, true] &#125;</span></div><div class="line"></div><div class="line">person.rollbackAttributes();</div><div class="line"></div><div class="line">person.get(<span class="string">'hasDirtyAttributes'</span>); <span class="comment">//=&gt; false</span></div><div class="line">person.get(<span class="string">'isAdmin'</span>);            <span class="comment">//=&gt; false</span></div><div class="line">person.changedAttributes();       <span class="comment">//=&gt; &#123;&#125;</span></div></pre></td></tr></table></figure>
<h2 id="验证错误"><a href="#验证错误" class="headerlink" title="验证错误"></a>验证错误</h2><p>如果后端server尝试save的时候返回了验证错误，那么会体现在你的model的<code>errors</code>属性上。你可以通过下面的方法在你的模板中展示这些错误：</p>
<figure class="highlight hbs"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="template-tag">&#123;&#123;#<span class="name"><span class="builtin-name">each</span></span> post.errors.title as |error|&#125;&#125;</span></div><div class="line">  &lt;div class="error"&gt;<span class="template-variable">&#123;&#123;error.message&#125;&#125;</span>&lt;/div&gt;</div><div class="line"><span class="template-tag">&#123;&#123;/<span class="name"><span class="builtin-name">each</span></span>&#125;&#125;</span></div><div class="line"><span class="template-tag">&#123;&#123;#<span class="name"><span class="builtin-name">each</span></span> post.errors.body as |error|&#125;&#125;</span></div><div class="line">  &lt;div class="error"&gt;<span class="template-variable">&#123;&#123;error.message&#125;&#125;</span>&lt;/div&gt;</div><div class="line"><span class="template-tag">&#123;&#123;/<span class="name"><span class="builtin-name">each</span></span>&#125;&#125;</span></div></pre></td></tr></table></figure>
<h2 id="Promises"><a href="#Promises" class="headerlink" title="Promises"></a>Promises</h2><p><a href="http://emberjs.com/api/data/classes/DS.Model.html#method_save" target="_blank" rel="external"><code>save()</code></a> 返回一个promise。下面是典型操作:</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">var</span> post = store.createRecord(<span class="string">'post'</span>, &#123;</div><div class="line">  <span class="attr">title</span>: <span class="string">'Rails is Omakase'</span>,</div><div class="line">  <span class="attr">body</span>: <span class="string">'Lorem ipsum'</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="keyword">var</span> self = <span class="keyword">this</span>;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">transitionToPost</span>(<span class="params">post</span>) </span>&#123;</div><div class="line">  self.transitionToRoute(<span class="string">'posts.show'</span>, post);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">function</span> <span class="title">failure</span>(<span class="params">reason</span>) </span>&#123;</div><div class="line">  <span class="comment">// handle the error</span></div><div class="line">&#125;</div><div class="line"></div><div class="line">post.save().then(transitionToPost).catch(failure);</div><div class="line"></div><div class="line"><span class="comment">// =&gt; POST to '/posts'</span></div><div class="line"><span class="comment">// =&gt; transitioning to posts.show route</span></div></pre></td></tr></table></figure>
<h2 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h2><p>删除跟创建一样直接。 调用一个实例的<a href="http://emberjs.com/api/data/classes/DS.Model.html#method_deleteRecord" target="_blank" rel="external"><code>deleteRecord()</code></a>方法. 之后会标记record为 <code>isDeleted</code>. 使用<code>save()</code>持久化删除操作. 或者使用<code>destroyRecord</code> 方法直接物理删除.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">store.findRecord(<span class="string">'post'</span>, <span class="number">1</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">post</span>) </span>&#123;</div><div class="line">  post.deleteRecord();</div><div class="line">  post.get(<span class="string">'isDeleted'</span>); <span class="comment">// =&gt; true</span></div><div class="line">  post.save(); <span class="comment">// =&gt; DELETE to /posts/1</span></div><div class="line">&#125;);</div><div class="line"></div><div class="line"><span class="comment">// OR</span></div><div class="line">store.findRecord(<span class="string">'post'</span>, <span class="number">2</span>).then(<span class="function"><span class="keyword">function</span>(<span class="params">post</span>) </span>&#123;</div><div class="line">  post.destroyRecord(); <span class="comment">// =&gt; DELETE to /posts/2</span></div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<h2 id="事先推送record进入store"><a href="#事先推送record进入store" class="headerlink" title="事先推送record进入store"></a>事先推送record进入store</h2><p>controller或者route请求store中没有的store时，store还要向adapter发起网络请求。<br>除了等待app请求一个record，你也可以提前向store中push record。</p>
<p>如果你知道你的用户下一步会使用什么record，那这就很有用。当他们请求的时候，会飞速返回。Ember可以自动重新渲染模板。</p>
<p>另外一个用例是与后端建立streaming connection的时候。当一个record被创建或者修改后，你应该马上更新UI。</p>
<h3 id="推送"><a href="#推送" class="headerlink" title="推送"></a>推送</h3><p>调用store的 <a href="http://emberjs.com/api/data/classes/DS.Store.html#method_push" target="_blank" rel="external"><code>push()</code></a> 方法.</p>
<p>假设当app刚启动的时候，我们要预加载一些数据到store中。</p>
<p>我们使用<code>route:application</code>来做这项工作. <code>route:application</code> 是route层级结构中的最顶级route，他的 <code>model</code> hook 只在app启动的时候被调用一次.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">import Model from &apos;ember-data/model&apos;;</div><div class="line">import attr from &apos;ember-data/attr&apos;;</div><div class="line"></div><div class="line">export default Model.extend(&#123;</div><div class="line">  title: attr(),</div><div class="line">  artist: attr(),</div><div class="line">  songCount: attr()</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">export default Ember.Route.extend(&#123;</div><div class="line">  model() &#123;</div><div class="line">    this.store.push(&#123;</div><div class="line">      data: [&#123;</div><div class="line">        id: 1,</div><div class="line">        type: &apos;album&apos;,</div><div class="line">        attributes: &#123;</div><div class="line">          title: &apos;Fewer Moving Parts&apos;,</div><div class="line">          artist: &apos;David Bazan&apos;,</div><div class="line">          songCount: 10</div><div class="line">        &#125;,</div><div class="line">        relationships: &#123;&#125;</div><div class="line">      &#125;, &#123;</div><div class="line">        id: 2,</div><div class="line">        type: &apos;album&apos;,</div><div class="line">        attributes: &#123;</div><div class="line">          title: &apos;Calgary b/w I Can\&apos;t Make You Love Me/Nick Of Time&apos;,</div><div class="line">          artist: &apos;Bon Iver&apos;,</div><div class="line">          songCount: 2</div><div class="line">        &#125;,</div><div class="line">        relationships: &#123;&#125;</div><div class="line">      &#125;]</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>store的 <code>push()</code> 方法是一个低级API，接收JSON API文档，使用JSONAPISerializer进行解析 。JSON API终端 type名称必须跟model的严格对应。（这个例子里就是<code>album</code>，因为model就是<code>app/models/album.js</code>）。属性和关系的大小写也必须和model定义中完全一致。</p>
<p>如果你想在推送进store前标准化model默认的serializer，可使用<br><a href="http://emberjs.com/api/data/classes/DS.Store.html#method_pushPayload" target="_blank" rel="external"><code>store.pushPayload()</code></a> 方法.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">import RestSerializer from &apos;ember-data/serializers/rest&apos;;</div><div class="line"></div><div class="line">export default RestSerializer.extend(&#123;</div><div class="line">  normalize(typeHash, hash) &#123;</div><div class="line">    hash[&apos;songCount&apos;] = hash[&apos;song_count&apos;]</div><div class="line">    delete hash[&apos;song_count&apos;]</div><div class="line">    return this._super(typeHash, hash);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">&#125;)</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">export default Ember.Route.extend(&#123;</div><div class="line">  model() &#123;</div><div class="line">    this.store.pushPayload(&#123;</div><div class="line">      albums: [</div><div class="line">        &#123;</div><div class="line">          id: 1,</div><div class="line">          title: &apos;Fever Moving Parts&apos;,</div><div class="line">          artist: &apos;David Bazan&apos;,</div><div class="line">          song_count: 10</div><div class="line">        &#125;,</div><div class="line">        &#123;</div><div class="line">          id: 2,</div><div class="line">          title: &apos;Calgary b/w I Can\&apos;t Make You Love Me/Nick Of Time&apos;,</div><div class="line">          artist: &apos;Bon Iver&apos;,</div><div class="line">          song_count: 2</div><div class="line">        &#125;</div><div class="line">      ]</div><div class="line">    &#125;);</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p><code>push()</code> 方法在于复杂终端协同的时候也很重要。你的应用终端有时会执行一些业务逻辑，创建多个record。这对于Ember Data的<code>save()</code> API并不是完全对应，后者只能操作单条record。这是，你应该使用自己的ajax请求推送结果数据到store中，供其他UI页面使用。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">export default Ember.Route.extend(&#123;</div><div class="line">  actions: &#123;</div><div class="line">    confirm: function(data) &#123;</div><div class="line">      $.ajax(&#123;</div><div class="line">        data: data,</div><div class="line">        method: &apos;POST&apos;,</div><div class="line">        url: &apos;process-payment&apos;</div><div class="line">      &#125;).then((digitalInventory) =&gt; &#123;</div><div class="line">        this.store.pushPayload(digitalInventory);</div><div class="line">        this.transitionTo(&apos;thank-you&apos;);</div><div class="line">      &#125;);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/05/ambari上hive-view添加用户/" title="ambari上hive-view添加用户" itemprop="url">ambari上hive-view添加用户</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-12-05T09:09:45.000Z" itemprop="datePublished"> 发表于 2016-12-05</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h4 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h4><p>在ambari 2.2.0.0中添加完用户和用户组之后，需要为这个用户单独给定一次ambari dashboard的只读权限以后才能正常访问hive view，否则就会报错：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">E090 RA040 I/O error while requesting Ambari [AmbariApiException]</div></pre></td></tr></table></figure></p>
<p>还有一个问题是，hive view里的每个用户都需要在/user/hive下有自己的文件夹才行，并且把文件夹的owner设置生当前用户才行。否则报错<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">E090 HDFS020 Could not write file query.hql [HdfsApiException]</div></pre></td></tr></table></figure></p>
<h4 id="以前总结"><a href="#以前总结" class="headerlink" title="以前总结"></a>以前总结</h4><pre><code>a. 给新用户开通dashboard的只读权限和指定view的使用权限【解决ambari的IO问题AmbariApiException】;
b. 到hdfs上创建/user/xxx目录，并将此目录的owner设置为xxx【解决hql写入问题HdfsApiException】
c. 使用没有问题的话，就可以把这个xxx用户的dashboard权限去掉了。
</code></pre><hr>
<h4 id="回想"><a href="#回想" class="headerlink" title="回想"></a>回想</h4><p>上面给用户readonly权限感觉就跟跑堂的似的，那么它实际是执行了什么操作呢？我怀疑它会在hdfs上创建一个user，但是并不存在于Linux中。</p>
<p>问题来了：</p>
<ol>
<li>hdfs和linux到底用的是不是同一套用户呢？还是说只是用的Linux的POSIX体系？<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">[root@datanode04 ~]# groups will</div><div class="line">will : will hdfs</div><div class="line">[root@datanode04 ~]# hdfs groups will</div><div class="line">will :</div><div class="line">[will@datanode04 root]$ hdfs dfs -ls /apps/hive</div><div class="line">drwxrwxrw-   - hive hdfs          0 2016-05-30 10:47 /apps/hive/warehouse</div><div class="line">[will@datanode04 root]$ hdfs dfs -ls /apps/hive/warehouse</div><div class="line">ls: Permission denied: user=will, access=READ_EXECUTE, inode=&quot;/apps/hive/warehouse&quot;:hive:hdfs:drwxrwxrw-</div></pre></td></tr></table></figure>
</li>
</ol>
<p>看这样子，no！hdfs并没有使用Linux上已有的用户组和用户的关系。可以看到hdfs上的文件夹/apps/hive/warehouse对于all并没有x权限，也就是说不能进去。/apps/hive/warehouse这个文件夹是属于hive用户，hdfs组。而will不能访问，代表他在hdfs系统里并不属于hdfs组。</p>
<p>找了hdfs的官网命令，没有找到关于在hdfs里添加用户的命令。回头儿想了一下，有个失误的地方：我只在一个node上添加了will用户，其他node上并没有。参考<a href="http://dongxicheng.org/mapreduce/hadoop-permission-management/，hdfs就是使用的Linux用户和用户组，但是需要每个node分别创建。" target="_blank" rel="external">http://dongxicheng.org/mapreduce/hadoop-permission-management/，hdfs就是使用的Linux用户和用户组，但是需要每个node分别创建。</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">scp -v /etc/passwd /etc/group datanode05.will.com:/etc</div></pre></td></tr></table></figure>
<p>每个机器都scp过之后，再次查看hdfs里的效果：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@datanode04 ~]# hdfs groups will</div><div class="line">will : will hdfs</div></pre></td></tr></table></figure></p>
<p>好了。那么为了验证上面给新用户dashboard的readonly权限是为了添加用户，我们再去ambari里添加普通用户will。还是报错，老套路，添加用户对集群的read权限，发现以下几个借口：</p>
<h5 id="为用户组添加dashboard的只读权限"><a href="#为用户组添加dashboard的只读权限" class="headerlink" title="为用户组添加dashboard的只读权限"></a>为用户组添加dashboard的只读权限</h5><p>PUT: <a href="http://namenode01.will.com:8080/api/v1/clusters/datacenter/privileges" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/clusters/datacenter/privileges</a><br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">    &#123;</div><div class="line">        <span class="attr">"PrivilegeInfo"</span>: &#123;</div><div class="line">            <span class="attr">"permission_name"</span>: <span class="string">"CLUSTER.READ"</span>,</div><div class="line">            <span class="attr">"principal_name"</span>: <span class="string">"analyst"</span>,</div><div class="line">            <span class="attr">"principal_type"</span>: <span class="string">"GROUP"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">]</div></pre></td></tr></table></figure></p>
<blockquote>
<p>curl  -u admin:admin -H ‘X-Requested-By:ambari’ -X PUT -d ‘[{“PrivilegeInfo”:{“permission_name”:”CLUSTER.READ”,”principal_name”:”testgroup”,”principal_type”:”GROUP”}}]’ <a href="http://namenode01.will.com:8080/api/v1/clusters/datacenter/privileges" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/clusters/datacenter/privileges</a></p>
</blockquote>
<h5 id="为用户添加dashboard的只读权限"><a href="#为用户添加dashboard的只读权限" class="headerlink" title="为用户添加dashboard的只读权限"></a>为用户添加dashboard的只读权限</h5><p>PUT：<a href="http://namenode01.will.com:8080/api/v1/clusters/datacenter/privileges" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/clusters/datacenter/privileges</a><br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">    &#123;</div><div class="line">        <span class="attr">"PrivilegeInfo"</span>: &#123;</div><div class="line">            <span class="attr">"permission_name"</span>: <span class="string">"CLUSTER.READ"</span>,</div><div class="line">            <span class="attr">"principal_name"</span>: <span class="string">"will"</span>,</div><div class="line">            <span class="attr">"principal_type"</span>: <span class="string">"USER"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">]</div></pre></td></tr></table></figure></p>
<h5 id="收回用户-用户组dashboard的只读权限"><a href="#收回用户-用户组dashboard的只读权限" class="headerlink" title="收回用户/用户组dashboard的只读权限"></a>收回用户/用户组dashboard的只读权限</h5><p>PUT：<a href="http://namenode01.will.com:8080/api/v1/clusters/datacenter/privileges" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/clusters/datacenter/privileges</a><br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[]</div></pre></td></tr></table></figure></p>
<p>更新成最新的权限组合就行了<br>【<strong>这种就存在并发问题了，如果操作的是group会有相互影响，user就好些</strong>】</p>
<h5 id="为用户-用户组添加hive-view的只读权限"><a href="#为用户-用户组添加hive-view的只读权限" class="headerlink" title="为用户/用户组添加hive view的只读权限"></a>为用户/用户组添加hive view的只读权限</h5><p>PUT：<a href="http://namenode01.will.com:8080/api/v1/views/HIVE/versions/1.0.0/instances/AUTO_HIVE_INSTANCE/privileges" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/views/HIVE/versions/1.0.0/instances/AUTO_HIVE_INSTANCE/privileges</a><br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">[</div><div class="line">    &#123;</div><div class="line">        <span class="attr">"PrivilegeInfo"</span>: &#123;</div><div class="line">            <span class="attr">"permission_name"</span>: <span class="string">"VIEW.USE"</span>,</div><div class="line">            <span class="attr">"principal_name"</span>: <span class="string">"will"</span>,</div><div class="line">            <span class="attr">"principal_type"</span>: <span class="string">"USER"</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">]</div></pre></td></tr></table></figure></p>
<blockquote>
<p>curl  -u admin:admin -H ‘X-Requested-By:ambari’ -X PUT -d ‘[{“PrivilegeInfo”:{“permission_name”:”VIEW.USE”,”principal_name”:”testgroup”,”principal_type”:”GROUP”}}]’ <a href="http://namenode01.will.com:8080/api/v1/views/HIVE/versions/1.0.0/instances/AUTO_HIVE_INSTANCE/privileges" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/views/HIVE/versions/1.0.0/instances/AUTO_HIVE_INSTANCE/privileges</a></p>
</blockquote>
<ul>
<li>以上接口移除权限的时候同样适用PUT方法，只是json为空：[]。</li>
</ul>
<h5 id="ambari删除用户"><a href="#ambari删除用户" class="headerlink" title="ambari删除用户"></a>ambari删除用户</h5><p>DELETE: <a href="http://namenode01.will.com:8080/api/v1/users/will" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/users/will</a><br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"id"</span>:<span class="string">"will"</span>&#125;</div></pre></td></tr></table></figure></p>
<h5 id="ambari添加用户"><a href="#ambari添加用户" class="headerlink" title="ambari添加用户"></a>ambari添加用户</h5><p>POST: <a href="http://namenode01.will.com:8080/api/v1/users" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/users</a><br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">    <span class="attr">"Users/user_name"</span>: <span class="string">"will"</span>,</div><div class="line">    <span class="attr">"Users/password"</span>: <span class="string">"1234qwer"</span>,</div><div class="line">    <span class="attr">"Users/active"</span>: <span class="literal">true</span>,</div><div class="line">    <span class="attr">"Users/admin"</span>: <span class="literal">false</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>curl -u admin:admin -H ‘X-Requested-By:ambari’ -X POST -d ‘{“Users/user_name”:”testuser”,”Users/password”:”1234qwer”,”Users/active”:true,”Users/admin”:false}’ <a href="http://namenode01.will.com:8080/api/v1/users" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/users</a></p>
</blockquote>
<h5 id="ambari添加用户组"><a href="#ambari添加用户组" class="headerlink" title="ambari添加用户组"></a>ambari添加用户组</h5><p>POST: <a href="http://namenode01.will.com:8080/api/v1/groups" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/groups</a><br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">&#123;<span class="attr">"Groups/group_name"</span>:<span class="string">"tt"</span>&#125;</div></pre></td></tr></table></figure></p>
<blockquote>
<p>curl  -u admin:admin -H ‘X-Requested-By:ambari’ -X POST -d ‘{“Groups/group_name”:”testgroup”}’ <a href="http://namenode01.will.com:8080/api/v1/groups" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/groups</a></p>
</blockquote>
<h5 id="ambari删除用户组"><a href="#ambari删除用户组" class="headerlink" title="ambari删除用户组"></a>ambari删除用户组</h5><p>DELETE: <a href="http://namenode01.will.com:8080/api/v1/groups/tt" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/groups/tt</a><br>啥都不用传</p>
<h5 id="ambari为用户指定用户组"><a href="#ambari为用户指定用户组" class="headerlink" title="ambari为用户指定用户组"></a>ambari为用户指定用户组</h5><p>POST: <a href="http://namenode01.will.com:8080/api/v1/groups/**analyst**/members/**will**" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/groups/**analyst**/members/**will**</a></p>
<blockquote>
<p>curl  -u admin:admin -H ‘X-Requested-By:ambari’ -X POST <a href="http://namenode01.will.com:8080/api/v1/groups/testgroup/members/testuser" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/groups/testgroup/members/testuser</a></p>
</blockquote>
<p>这个参数在url里</p>
<hr>
<p>综上总结过程如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#! /bin/bash</span></div><div class="line"></div><div class="line">user=<span class="variable">$1</span></div><div class="line">group=<span class="variable">$2</span></div><div class="line">pri_grp=<span class="variable">$3</span></div><div class="line"></div><div class="line"><span class="comment"># 1.在namenode上执行添加用户以及指定用户组的Linux命令</span></div><div class="line">useradd -G <span class="variable">$group</span> <span class="variable">$user</span></div><div class="line">groups <span class="variable">$user</span></div><div class="line"></div><div class="line"><span class="comment"># 2.检查hdfs上的用户组</span></div><div class="line">hdfs groups <span class="variable">$user</span></div><div class="line"></div><div class="line"><span class="comment"># 3.ambari上添加用户</span></div><div class="line">curl -u admin:admin -H <span class="string">'X-Requested-By:ambari'</span> -X POST <span class="_">-d</span> <span class="string">'&#123;"Users/user_name":"$user","Users/password":"1234qwer","Users/active":true,"Users/admin":false&#125;'</span> http://namenode01.will.com:8080/api/v1/users</div><div class="line"></div><div class="line"><span class="comment"># 4.ambari 调整用户到用户组</span></div><div class="line">curl  -u admin:admin -H <span class="string">'X-Requested-By:ambari'</span> -X POST http://namenode01.will.com:8080/api/v1/groups/<span class="variable">$group</span>/members/<span class="variable">$user</span></div><div class="line"></div><div class="line"><span class="comment"># 为用户添加dashboard的只读权限</span></div><div class="line">curl  -u admin:admin -H <span class="string">'X-Requested-By:ambari'</span> -X PUT <span class="_">-d</span> <span class="string">'[&#123;"PrivilegeInfo":&#123;"permission_name":"CLUSTER.READ","principal_name":"$user","principal_type":"USER"&#125;&#125;]'</span> http://namenode01.will.com:8080/api/v1/clusters/datacenter/privileges</div><div class="line"></div><div class="line"><span class="comment"># 模拟用户登录，访问一下hive view登录，这个过程会自动创建/user/$user文件夹</span></div><div class="line"><span class="comment"># 用chrome找了半天，么有找到登录的API，看看源码吧</span></div><div class="line"></div><div class="line"><span class="comment"># 模拟登录用户，访问hive view</span></div><div class="line"></div><div class="line"><span class="comment"># 删除普通用户对dashboard的所有权限</span></div><div class="line">curl  -u admin:admin -H <span class="string">'X-Requested-By:ambari'</span> -X PUT <span class="_">-d</span> <span class="string">'[]'</span> http://namenode01.will.com:8080/api/v1/clusters/datacenter/privileges</div><div class="line"></div><div class="line"><span class="comment"># 6. 检查一下用户文件夹，以此作为终点</span></div><div class="line">hdfs dfs -ls /user/<span class="variable">$user</span></div></pre></td></tr></table></figure></p>
<h4 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h4><p>可以修改一下ambari添加用户和用户组的地方，后台自动针对namenode的Linux系统进行相应操作，就不用单独再去执行命令行了。这样ambari、hdfs、Linux的用户以及用户组就会是一致的，后面的依赖前面的。</p>
<p>hive view加载过程中会请求一个URL：<a href="http://namenode01.will.com:8080/api/v1/clusters/datacenter/hosts?fields=Hosts%2Fpublic_host_name%2Chost_components%2FHostRoles%2Fcomponent_name" target="_blank" rel="external">http://namenode01.will.com:8080/api/v1/clusters/datacenter/hosts?fields=Hosts%2Fpublic_host_name%2Chost_components%2FHostRoles%2Fcomponent_name</a></p>
<p>这个URL需要对集群有可读权限，奇怪的是使用chrome看下面的网络请求里压根儿没有这个。它是内嵌在某个接口调用里的。</p>
<h4 id="延迟问题："><a href="#延迟问题：" class="headerlink" title="延迟问题："></a>延迟问题：</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">[root@namenode01 will]# useradd -G hdfs will1</div><div class="line">[root@namenode01 will]# groups will1</div><div class="line">will1 : will1 hdfs</div><div class="line">[root@namenode01 will]# hdfs groups will1</div><div class="line">will1 : will1 hdfs</div><div class="line">[root@namenode01 will]# userdel will1</div><div class="line">[root@namenode01 will]# groups will1</div><div class="line">groups: will1: No such user</div><div class="line">[root@namenode01 will]# hdfs groups will1</div><div class="line">will1 : will1 hdfs</div><div class="line">[root@namenode01 will]# cat /etc/group | grep will</div><div class="line">hdfs:x:511:hdfs,will</div><div class="line">will:x:1003:</div><div class="line">[root@namenode01 will]# hdfs groups will1</div><div class="line">will1 : will1 hdfs</div><div class="line">[root@namenode01 will]# hdfs groups will2</div><div class="line">will2 :</div><div class="line">[root@namenode01 will]# useradd -G sqoop will1</div><div class="line">[root@namenode01 will]# groups will1</div><div class="line">will1 : will1 sqoop</div><div class="line">[root@namenode01 will]# hdfs groups will1</div><div class="line">will1 : will1 hdfs  </div><div class="line">[root@namenode01 will]# su will1</div><div class="line">[will1@namenode01 will]$ hdfs dfs -ls /apps/hive/warehouse</div><div class="line">Found 2 items</div><div class="line">drwxrwxrw-   - hive hdfs          0 2016-05-30 10:40 /apps/hive/warehouse/batting</div><div class="line">drwxrwxrw-   - hive hdfs          0 2016-05-30 10:47 /apps/hive/warehouse/batting2</div><div class="line">[will1@namenode01 will]$ hdfs groups will1</div><div class="line">will1 : will1 hdfs</div><div class="line">[will1@namenode01 will]$ groups will1</div><div class="line">will1 : will1 sqoop</div></pre></td></tr></table></figure>
<p>上面看到，在namenode上添加用户后就可以生效了。但是假设我分配组分配错了，重新修改用户组后，hdfs并没有跟着修改，will1用户还是可以访问到hdfs组权限的文件。过了一段时间后，才可以了。目测盯了一下，差不多4分钟左右才生效。</p>
<p>可是如果Linux删除了这个用户，hdfs能够也跟着删除么？<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">[root@namenode01 will]# hdfs groups will1</div><div class="line">will1 : will1 hdfs</div><div class="line">[root@namenode01 will]# grep will /etc/passwd</div><div class="line">[root@namenode01 will]# grep will /etc/group</div></pre></td></tr></table></figure></p>
<p>刚删除同样没有生效，过一会儿再看。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">[root@namenode01 will]# hdfs groups will1</div><div class="line">will1 :</div></pre></td></tr></table></figure></p>
<p>也是会删除的。但是如果<strong>权限给错就不能立即收回</strong>，这是个问题。</p>
<p>参考：<a href="https://issues.apache.org/jira/browse/AMBARI-12732" target="_blank" rel="external">https://issues.apache.org/jira/browse/AMBARI-12732</a><br><a href="https://docs.hortonworks.com/HDPDocuments/Ambari-2.2.0.0/bk_ambari_views_guide/content/troubleshooting.html" target="_blank" rel="external">https://docs.hortonworks.com/HDPDocuments/Ambari-2.2.0.0/bk_ambari_views_guide/content/troubleshooting.html</a></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/05/openLDAP-安装配置/" title="openLDAP-安装配置" itemprop="url">openLDAP-安装配置</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-12-05T09:09:38.000Z" itemprop="datePublished"> 发表于 2016-12-05</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p>LDAP是一个许多传统高级系统管理员喜欢的服务，但是门槛高。<br>这里及你进介绍一些实用的规则，最下面会有一些参考。</p>
<h4 id="LDAP在局域网中的角色"><a href="#LDAP在局域网中的角色" class="headerlink" title="LDAP在局域网中的角色"></a>LDAP在局域网中的角色</h4><p>openLDAP实现了Lightweight Directory Access Protocol协议。目录本身是一个树结构的、可读的数据库。</p>
<p>我们使用openLDAP提供了一个网络验证中心，每个用户登录的时候都要到这里验证身份，如果是第一次的就自动创建他们的home目录。</p>
<p>这篇文章会提到怎样使用openLDAP作为验证中心，并为用户提供元数据。但是，文中使用明文用户名密码在wire中传播的方式是不安全的。因此推荐大家结合Kerberos使用openLDAP。</p>
<p>下面介绍LDAP的安装。</p>
<p>技术角度来看，LDAP目录是由一系列的有层级的entry组成。每个entry都属于某个指定的Object Classes，而且每个entry都包多含个kv键值对，也就是attribute。<br>entry是使用DN(distinguished name)来区分彼此的。DN由一系列组件构成，这些组件之间用逗号隔开，表示从树的top节点到这个entry的全路径。例如，公司：dc=example,dc=com。员工:cn=person,ou=People,dc=example,dc=com。</p>
<p>entry的objectClasses决定哪些attribute必须有，哪些可以没有。</p>
<p>上面的cn=persion，就是键值对的形式。上面的键(cn,ou,dc)分别代表着Common Name, Organizational Unit以及Domain Component。这是一些常用的术语。</p>
<p>先说位一下我们安装的几个注意点：</p>
<ul>
<li>LDAP与传统的系统用户或者其他数据无关。但是，我们安装过程中会存储一部分信息在/etc/paswd和/etc/group中，然后让这些信息在一个网络中心位置共享。</li>
<li>可以配置LDAP存储用户的密码。密码主要用来验证用户是否有权限访问指定的目录，还有就是验证用户是否知道正确的密码。当某个用户打开一个LDAP client来查看目录的时候，他的DB和密码就用来验证他的权限。当LDAP用来验证用户的时候，他的DB和密码只是用来建立LDAP目录的连接。成功连接就意味着用户知道正确的密码。</li>
</ul>
<h4 id="粘结层：将LDAP于系统软件整合起来"><a href="#粘结层：将LDAP于系统软件整合起来" class="headerlink" title="粘结层：将LDAP于系统软件整合起来"></a>粘结层：将LDAP于系统软件整合起来</h4><h6 id="NSS"><a href="#NSS" class="headerlink" title="NSS"></a>NSS</h6><h6 id="PAM"><a href="#PAM" class="headerlink" title="PAM"></a>PAM</h6><h4 id="Conventions【约定】"><a href="#Conventions【约定】" class="headerlink" title="Conventions【约定】"></a>Conventions【约定】</h4><ul>
<li>Debian GNU平台，或者Ubuntu。</li>
<li>有sudo免密命令。</li>
<li>安装过程中会有很多提示问题，运行：sudo dpkg-reconfigure debconf。然后舒服interface=Dialog，还有priority=low</li>
<li>查看日志：<blockquote>
<p>cd /var/log; sudo tail -F daemon.log sulog user.log auth.log debug kern.log syslog dmesg messages kerberos/{krb5kdc,kadmin,krb5lib}.log</p>
</blockquote>
</li>
<li>我们的测试系统叫做monarch.spinlock.hr，ip地址是192.168.7.12。server和client都会安在同一个机器上，为了明确区分client相对于monarch.spinlock.hr，server对应ldap1.spinlock.hr。按照下面配置/etc/hosts：<blockquote>
<p>192.168.7.12    monarch.spinlock.hr monarch krb1.spinlock.hr krb1 ldap1.spinlock.hr ldap1<br><strong>注意</strong><br>有的机器域名会被设置成127.0.0.1，这可能会出现问题。需要保证/etc/hosts里只能是: 127.0.0.1   localhost</p>
</blockquote>
</li>
<li>最后，测试是不是成功了。<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"> ping -c1 localhost</div><div class="line">PING localhost (127.0.0.1) 56(84) bytes of data.</div><div class="line">....</div><div class="line"></div><div class="line">ping -c1 monarch</div><div class="line">PING monarch.spinlock.hr (192.168.7.12) 56(84) bytes of data.</div><div class="line">....</div><div class="line"></div><div class="line">ping -c1 ldap1</div><div class="line">PING ldap1.spinlock.hr (192.168.7.12) 56(84) bytes of data.</div><div class="line">....</div></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="2-OpenLDAP"><a href="#2-OpenLDAP" class="headerlink" title="2. OpenLDAP"></a>2. OpenLDAP</h2><h4 id="2-1-server安装"><a href="#2-1-server安装" class="headerlink" title="2.1 server安装"></a>2.1 server安装</h4><p>openLDAP的server叫做slapd。</p>
<blockquote>
<p>sudo apt-get install slapd ladp-tuils</p>
</blockquote>
<p>Debconf如下：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Omit OpenLDAP server configuration? No</div><div class="line"></div><div class="line">DNS domain name: spinlock.hr</div><div class="line"></div><div class="line">Organization name? spinlock.hr</div><div class="line"></div><div class="line">Administrator password: PASSWORD</div><div class="line"></div><div class="line">Confirm password: PASSWORD</div><div class="line"></div><div class="line">Database backend to use: HDB</div><div class="line"></div><div class="line">Do you want the database to be removed when slapd is purged? No</div><div class="line"></div><div class="line">Allow LDAPv2 protocol? No</div></pre></td></tr></table></figure></p>
<p>安装完成后slapd会自动启动。</p>
<h6 id="2-1-1初始配置"><a href="#2-1-1初始配置" class="headerlink" title="2.1.1初始配置"></a>2.1.1初始配置</h6><p>server端的配置主要包含ObjectClasses、attribute、syntax、matching rules以及其他的LDAP数据结构的细节。配置文件目录是/etc/ldap/slapd.d/，每次启动的时候都会加载这些配置文件。</p>
<p>这些配置文件是以LDIF的形式保存的，预期是想使用标准的LDAP数据修改工具进行修改，然后slapd就会把新的配置存储在LDIF文件中，以保证下次重启生效。其实手动修改也是可以的。这种只能在运行时修改配置的方式叫做olc(on-line configuration)，也叫cn=config以及slapd.d。</p>
<p>以前版本的openLDAP是使用标准的txt配置文件/etc/ladp/slapd.conf，虽然目前也还是支持的，但是并不推荐使用这个文件。因为修改之后需要重启才能生效，cn=config是当前默认的方式。</p>
<p><strong><em>注意</em></strong></p>
<p>如果你的系统上游/etc/ldap/slapd.conf文件，但是没有/etc/ldap/slapd.d目录的话，运行以下命令：</p>
<blockquote>
<p>sudo slaptest -f /etc/ldap/slapd.conf -F /etc/ldap/slapd.d</p>
</blockquote>
<p>然后确认你的slapd是使用-F /etc/ldap/slapd.d启动的，而不是-f /etc/ldap/slapd.conf</p>
<blockquote>
<p>grep -e -F /etc/init.d/slapd<br>ps aux | grep slapd</p>
</blockquote>
<h6 id="2-1-1-1-CN-CONFIG配置"><a href="#2-1-1-1-CN-CONFIG配置" class="headerlink" title="2.1.1.1 CN=CONFIG配置"></a>2.1.1.1 CN=CONFIG配置</h6><p>cn=config是一个特殊的LDAP数据库，它保存着OpenLDAP server的配置，运行时可读可写。对它的修改直接影响当前运行的server，也会修改/etc/ldap/slapd.d/下对应的配置文件。</p>
<p>修改配置的时候我们需要利用已经存在的默认的cn=config配置，能让本地root用户连接到/var/run/slapd/ldapi的slapd socket修改cn=config数据库。</p>
<p>有了这个途径，我们先验证一下所有的LDAP schema定义(core,cosine,nis,inetorgperson)都已经加载成功。<br>在这一步出现重复entry问题的话不要紧张，目的在于知道我们的client以local user的身份验证身份，然后连接到slapd socket “-Y EXTERNAL -H ldapi:///“:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">sudo ldapadd -c -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/core.ldif</div><div class="line">sudo ldapadd -c -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/cosine.ldif</div><div class="line">sudo ldapadd -c -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/nis.ldif</div><div class="line">sudo ldapadd -c -Y EXTERNAL -H ldapi:/// -f /etc/ldap/schema/inetorgperson.ldif</div></pre></td></tr></table></figure></p>
<p>然后我们把默认的olcLogLevel: none替换成olcLogLevel: 256:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">echo &quot;dn: cn=config</div><div class="line">changetype: modify</div><div class="line">replace: olcLogLevel</div><div class="line">olcLogLevel: 256&quot; &gt; /var/tmp/loglevel.ldif</div><div class="line"></div><div class="line">sudo ldapmodify -Y EXTERNAL -H ldapi:/// -f /var/tmp/loglevel.ldif</div></pre></td></tr></table></figure></p>
<p>然后为attribute uid添加索引”eq”:<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">echo &quot;</div><div class="line">dn: olcDatabase=&#123;1&#125;hdb,cn=config</div><div class="line">changetype: modify</div><div class="line">add: olcDbIndex</div><div class="line">olcDbIndex: uid eq</div><div class="line">&quot; &gt; /var/tmp/uid_eq.ldif</div><div class="line"></div><div class="line">sudo ldapmodify -Y EXTERNAL -H ldapi:/// -f /var/tmp/uid_eq.ldif</div></pre></td></tr></table></figure></p>
<p>最后，以同样的方式允许LDAP管理员用户对于cn=config可读可写，dc=spinlock,dc=hr数据树就也可写了。只要用户知道正确的管理员DN和密码，就可以很方便快捷地修改slapd的配置。使用图形化的LDAP client来查看和修改配置对于初学者来说会更好上手一些：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">echo &quot;dn: olcDatabase=&#123;0&#125;config,cn=config</div><div class="line">changetype: modify</div><div class="line">add: olcAccess</div><div class="line">olcAccess: to * by dn=&quot;cn=admin,dc=spinlock,dc=hr&quot; write&quot; &gt; /var/tmp/access.ldif</div><div class="line"></div><div class="line">sudo ldapmodify -c -Y EXTERNAL -H ldapi:/// -f /var/tmp/access.ldif</div></pre></td></tr></table></figure></p>
<h6 id="2-1-1-2-spapd-conf配置【失效】"><a href="#2-1-1-2-spapd-conf配置【失效】" class="headerlink" title="2.1.1.2 spapd.conf配置【失效】"></a>2.1.1.2 spapd.conf配置【失效】</h6><h6 id="2-1-1-3-client端配置"><a href="#2-1-1-3-client端配置" class="headerlink" title="2.1.1.3 client端配置"></a>2.1.1.3 client端配置</h6><p>server已经可以运行了。下面配置所有LDAP client的配置文件 /etc/ldap/ldap.conf。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">BASE  dc=spinlock, dc=hr </div><div class="line">URI ldap://192.168.7.12/</div></pre></td></tr></table></figure></p>
<h4 id="2-1-2-initial-test-初始测试"><a href="#2-1-2-initial-test-初始测试" class="headerlink" title="2.1.2 initial test 初始测试"></a>2.1.2 initial test 初始测试</h4><p>可以测试一下我们安装的成果了。我们的openLDAP server只包含基本的读取操作。从LDAP的角度来看，读取操作被成为search。要使用命令行工具执行search，我们需要安装ldapsearch和slapcat。</p>
<p>ldapsearch使用LDAP协议执行在线操作。</p>
<p>SLAPCAT执行离线操作，直接修改本地文件系统里的文件。因此，这些命令只能在openLDAP server的本机执行，而且还需要特殊权限。向数据库写数据之前，需要先停掉openLDAP server。</p>
<p>在以上两个命令的输出中，一会注意到有两个LDAP entry，一个代表树的top节点，另一个代表LDAP 管理员的entry。在slapcat的输出中，不会像ldapsearch一样把额外的attributes打印出来。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">ldapsearch -x</div><div class="line"></div><div class="line"># extended LDIF</div><div class="line">#</div><div class="line"># LDAPv3</div><div class="line"># base &lt;dc=spinlock, dc=hr&gt; (default) with scope subtree</div><div class="line"># filter: (objectclass=*)</div><div class="line"># requesting: ALL</div><div class="line">#</div><div class="line"></div><div class="line"># spinlock.hr</div><div class="line">dn: dc=spinlock,dc=hr</div><div class="line">objectClass: top</div><div class="line">objectClass: dcObject</div><div class="line">objectClass: organization</div><div class="line">o: spinlock.hr</div><div class="line">dc: spinlock</div><div class="line"></div><div class="line"># admin, spinlock.hr</div><div class="line">dn: cn=admin,dc=spinlock,dc=hr</div><div class="line">objectClass: simpleSecurityObject</div><div class="line">objectClass: organizationalRole</div><div class="line">cn: admin</div><div class="line">description: LDAP administrator</div><div class="line"></div><div class="line"># search result</div><div class="line">search: 2</div><div class="line">result: 0 Success</div><div class="line"></div><div class="line"># numResponses: 3</div><div class="line"># numEntries: 2</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">sudo slapcat</div><div class="line"></div><div class="line">dn: dc=spinlock,dc=hr</div><div class="line">objectClass: top</div><div class="line">objectClass: dcObject</div><div class="line">objectClass: organization</div><div class="line">o: spinlock.hr</div><div class="line">dc: spinlock</div><div class="line">structuralObjectClass: organization</div><div class="line">entryUUID: 350a2db6-87d3-102c-8c1c-1ffeac40db98</div><div class="line">creatorsName:</div><div class="line">modifiersName:</div><div class="line">createTimestamp: 20080316183324Z</div><div class="line">modifyTimestamp: 20080316183324Z</div><div class="line">entryCSN: 20080316183324.797498Z#000000#000#000000</div><div class="line"></div><div class="line">dn: cn=admin,dc=spinlock,dc=hr</div><div class="line">objectClass: simpleSecurityObject</div><div class="line">objectClass: organizationalRole</div><div class="line">cn: admin</div><div class="line">description: LDAP administrator</div><div class="line">userPassword:: e2NyeXB0fVdSZDJjRFdRODluNHM=</div><div class="line">structuralObjectClass: organizationalRole</div><div class="line">entryUUID: 350b330a-87d3-102c-8c1d-1ffeac40db98</div><div class="line">creatorsName:</div><div class="line">modifiersName:</div><div class="line">createTimestamp: 20080316183324Z</div><div class="line">modifyTimestamp: 20080316183324Z</div></pre></td></tr></table></figure>
<h4 id="创建基本树结构"><a href="#创建基本树结构" class="headerlink" title="创建基本树结构"></a>创建基本树结构</h4>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/05/azkaban源码追踪(1)-——-上传zip文件/" title="azkaban源码追踪(1)-——-上传zip文件" itemprop="url">azkaban源码追踪(1)-——-上传zip文件</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-12-05T09:09:26.000Z" itemprop="datePublished"> 发表于 2016-12-05</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h4 id="相关类"><a href="#相关类" class="headerlink" title="相关类"></a>相关类</h4><ul>
<li>ProjectMangerServlet</li>
<li>ProjectManager</li>
<li>ValidatorManager</li>
<li>DirectoryFlowLoader</li>
<li>JdbcProjectLoader</li>
</ul>
<h4 id="对应的流程log"><a href="#对应的流程log" class="headerlink" title="对应的流程log"></a>对应的流程log</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">2016/06/14 15:39:18.537 +0800 INFO [ProjectManagerServlet] [Azkaban] Uploading file willjob.zip</div><div class="line">2016/06/14 15:39:23.861 +0800 INFO [ProjectManager] [Azkaban] Uploading files to mytestProject</div><div class="line">2016/06/14 15:40:16.454 +0800 WARN [XmlValidatorManager] [Azkaban] Validator directory validators does not exist or is not a directory</div><div class="line">2016/06/14 15:40:16.455 +0800 WARN [XmlValidatorManager] [Azkaban] Azkaban properties file does not contain the key project.validators</div><div class="line">2016/06/14 15:40:35.752 +0800 INFO [ProjectManager] [Azkaban] Validating project willjob.zip using the registered validators [Director</div><div class="line">2016/06/14 16:11:45.952 +0800 INFO [XmlValidatorManager] [Azkaban] Validation status of validator Directory Flow is PASS</div><div class="line">2016/06/14 16:56:51.338 +0800 INFO [ProjectManager] [Azkaban] Uploading file to db willjob.zip</div><div class="line">2016/06/14 16:56:51.338 +0800 INFO [JdbcProjectLoader] [Azkaban] Uploading to mytestProject version:1 file:willjob.zip</div><div class="line">2016/06/14 16:56:51.341 +0800 INFO [JdbcProjectLoader] [Azkaban] Creating message digest for upload willjob.zip</div><div class="line">2016/06/14 16:56:51.343 +0800 INFO [JdbcProjectLoader] [Azkaban] Md5 hash created</div><div class="line">2016/06/14 16:56:51.359 +0800 INFO [JdbcProjectLoader] [Azkaban] Read bytes for willjob.zip size:560</div><div class="line">2016/06/14 16:56:51.359 +0800 INFO [JdbcProjectLoader] [Azkaban] Running update for willjob.zip chunk 0</div><div class="line">2016/06/14 16:56:51.360 +0800 INFO [JdbcProjectLoader] [Azkaban] Finished update for willjob.zip chunk 0</div><div class="line">2016/06/14 16:56:51.362 +0800 INFO [JdbcProjectLoader] [Azkaban] Commiting upload willjob.zip</div><div class="line">2016/06/14 16:56:51.363 +0800 INFO [ProjectManager] [Azkaban] Uploading flow to db willjob.zip</div><div class="line">2016/06/14 16:56:51.363 +0800 INFO [JdbcProjectLoader] [Azkaban] Uploading flows</div><div class="line">2016/06/14 16:56:51.418 +0800 INFO [JdbcProjectLoader] [Azkaban] Flow upload will3 is byte size 214</div><div class="line">2016/06/14 16:56:51.432 +0800 INFO [JdbcProjectLoader] [Azkaban] Flow upload will2 is byte size 238</div><div class="line">2016/06/14 16:56:51.434 +0800 INFO [ProjectManager] [Azkaban] Changing project versions willjob.zip</div><div class="line">2016/06/14 16:56:51.436 +0800 INFO [ProjectManager] [Azkaban] Uploading Job properties</div><div class="line">2016/06/14 16:56:51.820 +0800 INFO [ProjectManager] [Azkaban] Uploading Props properties</div><div class="line">2016/06/14 16:56:51.822 +0800 INFO [ProjectManager] [Azkaban] Uploaded project files. Cleaning up temp files.</div><div class="line">2016/06/14 16:56:51.927 +0800 INFO [ProjectManager] [Azkaban] Cleaning up old install files older than -2</div></pre></td></tr></table></figure>
<h4 id="ProjectManager"><a href="#ProjectManager" class="headerlink" title="ProjectManager"></a>ProjectManager</h4><p>白话一下ProjectManager处理上传zip文件的过程：</p>
<ol>
<li>将文件存到/tmp目录并解压</li>
<li>使用DirectoryFlowLoader解析文件，放置到这个loader的状态变量中。这些变量会一直保存在内存里，以供后面使用</li>
<li>遍历loader里的flowMap，把每个flow都加上最新的project_id和version</li>
<li>上传project信息<ul>
<li>4.1 把zip文件弄成字节流上传到mysql的project_files表中</li>
<li>4.2 把最新版本的project信息上传到project_versions表中</li>
</ul>
</li>
<li>上传flow: 把flow逐个序列化成json，再弄成byte字节流，再使用gzip压缩，上传至project_flows表中</li>
<li>更新projects里的相关记录，并修改内存中的project信息【修改时间等、最新版本的flows】</li>
<li>上传job的详细信息到project_properties中，job的详细信息也是json-&gt;byte[]-&gt;gzip的过程</li>
<li>上传props的详细信息到project_properties中，流程同job完全一样【这个debug的时候数据是空的】</li>
<li>将此次操作插入到project_event中，之后删除本地/tmp下的文件</li>
<li>使用project_id和当前version判断依次清除先前版本的project_flows的flow、project_properties、project_files、project_versions中的记录【会有最近版本保留数量设置project.version.retention，默认是3】</li>
<li>完成</li>
</ol>
<h4 id="文件解析"><a href="#文件解析" class="headerlink" title="文件解析"></a>文件解析</h4><p>DirectoryFlowLoader加载文件目录，解析所有的文件，进行解析，将信息存放在自己的状态变量中：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Props props;                          <span class="comment">// 环境、配置信息</span></div><div class="line"><span class="keyword">private</span> HashSet&lt;String&gt; rootNodes;            <span class="comment">// 根节点，也就是实际执行的时候的起始节点</span></div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Flow&gt; flowMap;        <span class="comment">// 所有的flow，key是flowId</span></div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Node&gt; nodeMap;        <span class="comment">// 所有的node，key是JobId或者embed的flowId</span></div><div class="line"><span class="comment">// node之间的dependency，key是job名称，value是一系列的相关依赖job，一般是children，然后Edge指定从谁到谁</span></div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Map&lt;String, Edge&gt;&gt; nodeDependencies;  </div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Props&gt; jobPropsMap;   <span class="comment">// 包含job的详细信息</span></div><div class="line"></div><div class="line"><span class="comment">// flow之间的依赖关系【embedeed flow】</span></div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Set&lt;String&gt;&gt; flowDependencies;</div><div class="line"></div><div class="line"><span class="keyword">private</span> ArrayList&lt;FlowProps&gt; flowPropsList;</div><div class="line"><span class="keyword">private</span> ArrayList&lt;Props&gt; propsList;</div><div class="line"><span class="keyword">private</span> Set&lt;String&gt; errors;</div><div class="line"><span class="keyword">private</span> Set&lt;String&gt; duplicateJobs;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 临时解压目录 baseDirectory : temp/46769225</span></div><div class="line"><span class="comment">// 项目信息 project: testPro</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadProjectFlow</span><span class="params">(Project project, File baseDirectory)</span> </span>&#123;</div><div class="line">    propsList = <span class="keyword">new</span> ArrayList&lt;Props&gt;();</div><div class="line">    flowPropsList = <span class="keyword">new</span> ArrayList&lt;FlowProps&gt;();</div><div class="line">    jobPropsMap = <span class="keyword">new</span> HashMap&lt;String, Props&gt;();</div><div class="line">    nodeMap = <span class="keyword">new</span> HashMap&lt;String, Node&gt;();</div><div class="line">    flowMap = <span class="keyword">new</span> HashMap&lt;String, Flow&gt;();</div><div class="line">    errors = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">    duplicateJobs = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">    nodeDependencies = <span class="keyword">new</span> HashMap&lt;String, Map&lt;String, Edge&gt;&gt;();</div><div class="line">    rootNodes = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">    flowDependencies = <span class="keyword">new</span> HashMap&lt;String, Set&lt;String&gt;&gt;();</div><div class="line"></div><div class="line">    <span class="comment">// 加载所有的properties、job文件，创建node对象</span></div><div class="line">    loadProjectFromDir(baseDirectory.getPath(), baseDirectory, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    jobPropertiesCheck(project);</div><div class="line"></div><div class="line">    <span class="comment">// Create edges and find missing dependencies</span></div><div class="line">    resolveDependencies();</div><div class="line"></div><div class="line">    <span class="comment">// 创建flows. 在此之后flowMap里就已经构建好了flow以及job之间的依赖了，node之间通过level来界定先后关系</span></div><div class="line">    buildFlowsFromDependencies();</div><div class="line"></div><div class="line">    <span class="comment">// 处理embedded flows，就是嵌入的flow</span></div><div class="line">    resolveEmbeddedFlows();</div><div class="line"></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h5 id="loadProjectFromDir方法详细"><a href="#loadProjectFromDir方法详细" class="headerlink" title="loadProjectFromDir方法详细"></a>loadProjectFromDir方法详细</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadProjectFromDir</span><span class="params">(String base, File dir, Props parent)</span> </span>&#123;</div><div class="line">  <span class="comment">// 找出所有的properties</span></div><div class="line">  File[] propertyFiles = dir.listFiles(<span class="keyword">new</span> SuffixFilter(PROPERTY_SUFFIX));</div><div class="line">  Arrays.sort(propertyFiles);</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (File file : propertyFiles) &#123;</div><div class="line">      String relative = getRelativeFilePath(base, file.getPath());</div><div class="line">      parent = <span class="keyword">new</span> Props(parent, file);</div><div class="line">      parent.setSource(relative);</div><div class="line">      FlowProps flowProps = <span class="keyword">new</span> FlowProps(parent);</div><div class="line">      flowPropsList.add(flowProps);</div><div class="line">      logger.info(<span class="string">"Adding "</span> + relative);</div><div class="line">      propsList.add(parent);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 加载job文件</span></div><div class="line">  File[] jobFiles = dir.listFiles(<span class="keyword">new</span> SuffixFilter(JOB_SUFFIX));</div><div class="line">  <span class="keyword">for</span> (File file : jobFiles) &#123;</div><div class="line">    String jobName = getNameWithoutExtension(file);</div><div class="line">      <span class="keyword">if</span> (!duplicateJobs.contains(jobName)) &#123;</div><div class="line">        <span class="keyword">if</span> (jobPropsMap.containsKey(jobName)) &#123;</div><div class="line">          <span class="comment">// 是否有重复</span></div><div class="line">          ... </div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          Props prop = <span class="keyword">new</span> Props(parent, file);</div><div class="line">          String relative = getRelativeFilePath(base, file.getPath());</div><div class="line">          prop.setSource(relative);</div><div class="line"></div><div class="line">          Node node = <span class="keyword">new</span> Node(jobName);</div><div class="line">          String type = prop.getString(<span class="string">"type"</span>, <span class="keyword">null</span>);</div><div class="line">          <span class="keyword">if</span> (type == <span class="keyword">null</span>) &#123;</div><div class="line">            errors.add(<span class="string">"Job doesn't have type set '"</span> + jobName + <span class="string">"'."</span>);</div><div class="line">          &#125;</div><div class="line">          node.setType(type); <span class="comment">// job类型</span></div><div class="line">          node.setJobSource(relative);    <span class="comment">// job相对路径</span></div><div class="line">          <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</div><div class="line">            node.setPropsSource(parent.getSource());</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="comment">// Force root node</span></div><div class="line">          <span class="keyword">if</span> (prop.getBoolean(CommonJobProperties.ROOT_NODE, <span class="keyword">false</span>)) &#123;</div><div class="line">            rootNodes.add(jobName);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="comment">// 把properties和node放进loader中的队列中</span></div><div class="line">          jobPropsMap.put(jobName, prop);</div><div class="line">          nodeMap.put(jobName, node);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 检查是否有子目录</span></div><div class="line">  File[] subDirs = dir.listFiles(DIR_FILTER);</div><div class="line">  <span class="keyword">for</span> (File file : subDirs) &#123;</div><div class="line">    loadProjectFromDir(base, file, parent);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="常用的blob处理代码"><a href="#常用的blob处理代码" class="headerlink" title="常用的blob处理代码"></a>常用的blob处理代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">String propertyJSON = PropsUtils.toJSONString(props, <span class="keyword">true</span>);</div><div class="line">   <span class="keyword">byte</span>[] data = propertyJSON.getBytes(<span class="string">"UTF-8"</span>);</div><div class="line">   <span class="keyword">if</span> (defaultEncodingType == EncodingType.GZIP) &#123;</div><div class="line">     data = GZIPUtils.gzipBytes(data);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><p><img src="C:\Users\will\Pictures\azkaban上传project时的node结构.png" alt="Node结构"></p>
<p>level表示当前node所在的层次。</p>
<p><img src="C:\Users\will\Pictures\Edge数据结构.png" alt="Edge结构"></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/12/05/celery上手/" title="celery上手" itemprop="url">celery上手</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-12-05T09:09:24.000Z" itemprop="datePublished"> 发表于 2016-12-05</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>首先我们需要有一个celery实例，也就是celery app。有了这个实例我们才能创建task、管理worker，只需要把这个实例作为moduel import进来就可以了。</p>
<p>创建实例，并创建task：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</div><div class="line"></div><div class="line">app = Celery(<span class="string">'tasks'</span>, broker=<span class="string">'amqp://guest@localhost//'</span>)</div><div class="line"></div><div class="line"><span class="meta">@app.task</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></div><div class="line">    <span class="keyword">return</span> x + y</div></pre></td></tr></table></figure></p>
<p>启动worker：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">celery -A tasks worker --loglevel=info</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">-------------- celery@halcyon.local v3.1 (Cipater)</div><div class="line">---- **** -----</div><div class="line">--- * ***  * -- [Configuration]</div><div class="line">-- * - **** --- . broker:      amqp://guest@localhost:5672//</div><div class="line">- ** ---------- . app:         __main__:0x1012d8590</div><div class="line">- ** ---------- . concurrency: 8 (processes)</div><div class="line">- ** ---------- . events:      OFF (enable -E to monitor this worker)</div><div class="line">- ** ----------</div><div class="line">- *** --- * --- [Queues]</div><div class="line">-- ******* ---- . celery:      exchange:celery(direct) binding:celery</div><div class="line">--- ***** -----</div><div class="line"></div><div class="line">[2012-06-08 16:23:51,078: WARNING/MainProcess] celery@halcyon.local has started.</div></pre></td></tr></table></figure>
<ul>
<li>concurrency 是worker进程的并发数据，默认是cpu个数。需要视情况而定，cpu密集型的就少一些，IO密集型的就多一些。除了默认的prefork 池，celery还支持eventlet、gevent以及threads。</li>
<li>event。 启用后celery就发送这个worker里的监控event。这可以被celery events、flower使用。</li>
<li>queue。代表这个worker会消费的队列。</li>
</ul>
<p>调用task：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> tasks <span class="keyword">import</span> add</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>add.delay(<span class="number">4</span>, <span class="number">4</span>)</div></pre></td></tr></table></figure></p>
<p>使用delay()方法调用task，它是apply_async()方法的简写。然后我们可以去worker的console观察任务执行了。</p>
<p>调用task放回的对象是AsyncResult实例，它可以用来获取当前task的状态，等待task结束后，获取task的返回值。默认是没有启用的，要使用的话需要给celery配置一个result backend。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app = Celery(<span class="string">'tasks'</span>, backend=<span class="string">'redis://localhost'</span>, broker=<span class="string">'amqp://'</span>)</div></pre></td></tr></table></figure>
<p>这里是使用redis作为task状态和结果的存储介质。再次调用<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>result = add.delay(<span class="number">4</span>, <span class="number">4</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>result.ready()</div><div class="line"><span class="keyword">False</span></div><div class="line"><span class="comment"># 一般并不会直接获取这个结果，这样就把异步调用弄成同步调用一样了</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>result.get(timeout=<span class="number">1</span>)</div><div class="line"><span class="number">8</span></div><div class="line"><span class="comment">## 当出现异常的时候，get方法默认也会抛出这个异常，可以使用propagate来阻止</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>result.get(propagate=<span class="keyword">False</span>)</div><div class="line"><span class="comment">## 获取异常堆栈</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>result.traceback</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>res.failed()</div><div class="line"><span class="keyword">True</span></div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>res.successful()</div><div class="line"><span class="keyword">False</span></div><div class="line"><span class="comment"># 一个task的典型status历程：PENDING -&gt; STARTED -&gt; SUCCESS</span></div><div class="line"><span class="comment"># 重试的task：PENDING -&gt; STARTED -&gt; RETRY -&gt; STARTED -&gt; RETRY -&gt; STARTED -&gt; SUCCESS</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>res.state</div><div class="line"><span class="string">'FAILURE'</span></div></pre></td></tr></table></figure></p>
<p>要使配置马上生效的话，可以调用update方法<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">app.conf.update(</div><div class="line">    CELERY_TASK_SERIALIZER=<span class="string">'json'</span>,</div><div class="line">    CELERY_ACCEPT_CONTENT=[<span class="string">'json'</span>],  <span class="comment"># Ignore other content</span></div><div class="line">    CELERY_RESULT_SERIALIZER=<span class="string">'json'</span>,</div><div class="line">    CELERY_TIMEZONE=<span class="string">'Europe/Oslo'</span>,</div><div class="line">    CELERY_ENABLE_UTC=<span class="keyword">True</span>,</div><div class="line">)</div></pre></td></tr></table></figure></p>
<p>要是大型项目，弄一个特定的配置module比较好。最好不要硬编码周期任务和task路由，把这些放在一个集中的位置，方便控制。比如系统管理员在系统故障的时候做一些简单的微调什么的。</p>
<p>使用<code>app.config_from_object()</code>方法，使celery实例使用一个配置module。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">app.config_from_object(<span class="string">'celeryconfig'</span>)</div></pre></td></tr></table></figure></p>
<p>celeryconfig.py:<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">BROKER_URL = <span class="string">'amqp://'</span></div><div class="line">CELERY_RESULT_BACKEND = <span class="string">'rpc://'</span></div><div class="line"></div><div class="line">CELERY_TASK_SERIALIZER = <span class="string">'json'</span></div><div class="line">CELERY_RESULT_SERIALIZER = <span class="string">'json'</span></div><div class="line">CELERY_ACCEPT_CONTENT=[<span class="string">'json'</span>]</div><div class="line">CELERY_TIMEZONE = <span class="string">'Europe/Oslo'</span></div><div class="line">CELERY_ENABLE_UTC = <span class="keyword">True</span></div></pre></td></tr></table></figure></p>
<p>注意，这个module应该可以import到才对。配置文件中可以指定路由、注解等很多东西。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">CELERY_ANNOTATIONS = &#123;</div><div class="line">    <span class="string">'tasks.add'</span>: &#123;<span class="string">'rate_limit'</span>: <span class="string">'10/m'</span>&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">CELERY_ROUTES = &#123;</div><div class="line">    <span class="string">'tasks.add'</span>: <span class="string">'low-priority'</span>,</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>要是使用rabbitMQ或者Redis作为broker的话，还可以直接通过命令进行配置：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">celery -A tasks control rate_limit tasks.add 10/m</div></pre></td></tr></table></figure></p>
<hr>
<h2 id="实际使用celery"><a href="#实际使用celery" class="headerlink" title="实际使用celery"></a>实际使用celery</h2><p>项目结构：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">proj/__init__.py</div><div class="line">    /celery.py</div><div class="line">    /tasks.py</div></pre></td></tr></table></figure></p>
<p>celery.py文件内容：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</div><div class="line"></div><div class="line"><span class="keyword">from</span> celery <span class="keyword">import</span> Celery</div><div class="line"></div><div class="line">app = Celery(<span class="string">'proj'</span>,</div><div class="line">             broker=<span class="string">'amqp://'</span>,</div><div class="line">             backend=<span class="string">'amqp://'</span>,</div><div class="line">             include=[<span class="string">'proj.tasks'</span>])</div><div class="line"></div><div class="line"><span class="comment"># Optional configuration, see the application user guide.</span></div><div class="line">app.conf.update(</div><div class="line">    CELERY_TASK_RESULT_EXPIRES=<span class="number">3600</span>,</div><div class="line">)</div><div class="line"></div><div class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</div><div class="line">    app.start()</div></pre></td></tr></table></figure></p>
<p>在celery中可以创建自己的实例，然后在其他地方import这个实例就可以使用了。</p>
<p>注意一下include，应该把自定义的task的module填写进来，这样celery实例启动的时候就会加载这些module。</p>
<p>我们的proj/tasks.py：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> __future__ <span class="keyword">import</span> absolute_import</div><div class="line"></div><div class="line"><span class="keyword">from</span> proj.celery <span class="keyword">import</span> app</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@app.task</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(x, y)</span>:</span></div><div class="line">    <span class="keyword">return</span> x + y</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@app.task</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">mul</span><span class="params">(x, y)</span>:</span></div><div class="line">    <span class="keyword">return</span> x * y</div><div class="line"></div><div class="line"></div><div class="line"><span class="meta">@app.task</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">xsum</span><span class="params">(numbers)</span>:</span></div><div class="line">    <span class="keyword">return</span> sum(numbers)</div></pre></td></tr></table></figure></p>
<p>启动后要停掉worker的话，只需要直接ctrl + c就可以了。</p>
<p>生产环境中需要以守护进程的形式启动worker，使用<code>celery multi</code>任务就可以了，它可以启动一个或多个worker。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">celery multi start w1 -A proj -l info</div><div class="line">celery multi v3.1.1 (Cipater)</div><div class="line">&gt; Starting nodes...</div><div class="line">    &gt; w1.halcyon.local: OK</div><div class="line"></div><div class="line">$ celery  multi restart w1 -A proj -l info</div><div class="line">celery multi v3.1.1 (Cipater)</div><div class="line">&gt; Stopping nodes...</div><div class="line">    &gt; w1.halcyon.local: TERM -&gt; 64024</div><div class="line">&gt; Waiting for 1 node.....</div><div class="line">    &gt; w1.halcyon.local: OK</div><div class="line">&gt; Restarting node w1.halcyon.local: OK</div><div class="line">celery multi v3.1.1 (Cipater)</div><div class="line">&gt; Stopping nodes...</div><div class="line">    &gt; w1.halcyon.local: TERM -&gt; 64052</div><div class="line">    </div><div class="line">celery multi stop w1 -A proj -l info</div></pre></td></tr></table></figure>
<p>stop命令是异步的，这样就不用hang，等着worker停止了。为了我保证所有的task能够完成，也可以使用stopwait方法。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">celery multi stopwait w1 -A proj -l info</div></pre></td></tr></table></figure></p>
<p>下面是加上指定pid，和log的启动命令：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">$ mkdir -p /var/run/celery</div><div class="line">$ mkdir -p /var/log/celery</div><div class="line">$ celery multi start w1 -A proj -l info --pidfile=/var/run/celery/%n.pid \</div><div class="line">                                        --logfile=/var/log/celery/%n%I.log</div></pre></td></tr></table></figure></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">celery multi start 10 -A proj -l info -Q:1-3 images,video -Q:4,5 data \</div><div class="line">   -Q default -L:4,5 debug</div></pre></td></tr></table></figure>
<h4 id="Canvas：工作流"><a href="#Canvas：工作流" class="headerlink" title="Canvas：工作流"></a>Canvas：工作流</h4><p>使用subtask搞定，它封装了单个task的参数，可以传递给后面的方法。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>add.subtask((<span class="number">2</span>, <span class="number">2</span>), countdown=<span class="number">10</span>)</div><div class="line">tasks.add(<span class="number">2</span>, <span class="number">2</span>)</div></pre></td></tr></table></figure>
<p>可以替换为:<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>add.s(<span class="number">2</span>, <span class="number">2</span>)</div><div class="line">tasks.add(<span class="number">2</span>, <span class="number">2</span>)</div></pre></td></tr></table></figure></p>
<p>比较牛逼的地方在于，他竟然可以定义偏函数<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>s1 = add.s(<span class="number">2</span>, <span class="number">2</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>res = s1.delay()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>res.get()</div><div class="line"><span class="number">4</span></div><div class="line"></div><div class="line"><span class="comment"># 空的是前面的参数，后面的是2</span></div><div class="line"><span class="comment"># incomplete partial: add(?, 2)</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>s2 = add.s(<span class="number">2</span>)</div><div class="line"></div><div class="line"><span class="comment"># resolves the partial: add(8, 2)</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>res = s2.delay(<span class="number">8</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>res.get()</div><div class="line"><span class="number">10</span></div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>s3 = add.s(<span class="number">2</span>, <span class="number">2</span>, debug=<span class="keyword">True</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>s3.delay(debug=<span class="keyword">False</span>)   <span class="comment"># debug is now False.</span></div></pre></td></tr></table></figure></p>
<h4 id="primitive"><a href="#primitive" class="headerlink" title="primitive"></a>primitive</h4><ul>
<li>group</li>
<li>map</li>
<li>chain</li>
<li>starmap</li>
<li>chord</li>
<li>chunks<br>这些primitive本身就是subtask，所以它们可以组合成工作流。</li>
</ul>
<h6 id="groups"><a href="#groups" class="headerlink" title="groups"></a>groups</h6><p>group并行调用多个task，返回一串结果。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> celery <span class="keyword">import</span> group</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> proj.tasks <span class="keyword">import</span> add</div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>group(add.s(i, i) <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">10</span>))().get()</div><div class="line">[<span class="number">0</span>, <span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">10</span>, <span class="number">12</span>, <span class="number">14</span>, <span class="number">16</span>, <span class="number">18</span>]</div></pre></td></tr></table></figure></p>
<p>结合偏函数使用group：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>g = group(add.s(i) <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">10</span>))</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>g(<span class="number">10</span>).get()</div><div class="line">[<span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>]</div></pre></td></tr></table></figure></p>
<h6 id="chain"><a href="#chain" class="headerlink" title="chain"></a>chain</h6><p>有序调用一系列task<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> celery <span class="keyword">import</span> chain</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> proj.tasks <span class="keyword">import</span> add, mul</div><div class="line"></div><div class="line"><span class="comment"># (4 + 4) * 8</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>chain(add.s(<span class="number">4</span>, <span class="number">4</span>) | mul.s(<span class="number">8</span>))().get()</div><div class="line"><span class="number">64</span></div></pre></td></tr></table></figure></p>
<p>偏函数：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># (? + 4) * 8</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>g = chain(add.s(<span class="number">4</span>) | mul.s(<span class="number">8</span>))</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>g(<span class="number">4</span>).get()</div><div class="line"><span class="number">64</span></div></pre></td></tr></table></figure></p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>(add.s(<span class="number">4</span>, <span class="number">4</span>) | mul.s(<span class="number">8</span>))().get()</div><div class="line"><span class="number">64</span></div></pre></td></tr></table></figure>
<h6 id="chord"><a href="#chord" class="headerlink" title="chord"></a>chord</h6><p>带有一个回调函数的一组task。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> celery <span class="keyword">import</span> chord</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">from</span> proj.tasks <span class="keyword">import</span> add, xsum</div><div class="line"></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>chord((add.s(i, i) <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">10</span>)), xsum.s())().get()</div><div class="line"><span class="number">90</span></div></pre></td></tr></table></figure></p>
<p>被chain到其他task的group自动转为chord：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>(group(add.s(i, i) <span class="keyword">for</span> i <span class="keyword">in</span> xrange(<span class="number">10</span>)) | xsum.s())().get()</div><div class="line"><span class="number">90</span></div></pre></td></tr></table></figure></p>
<p>结合多种subtask使用：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>upload_document.s(file) | group(apply_filter.s() <span class="keyword">for</span> filter <span class="keyword">in</span> filters)</div></pre></td></tr></table></figure></p>
<h4 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h4><p>主要是针对consumer/worker和producer各自的队列</p>
<h4 id="远程控制"><a href="#远程控制" class="headerlink" title="远程控制"></a>远程控制</h4><p>使用RabbitMQ、或者Redis作为broker的话可以在运行时控制与查看worker的状态。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">$ celery -A proj inspect active</div></pre></td></tr></table></figure></p>
<p>这是查看当前正在运行的task。</p>
<p>参考：</p>
<ul>
<li><a href="http://docs.celeryproject.org/en/latest/getting-started/first-steps-with-celery.html" target="_blank" rel="external">http://docs.celeryproject.org/en/latest/getting-started/first-steps-with-celery.html</a></li>
<li><a href="http://docs.celeryproject.org/en/latest/getting-started/next-steps.html" target="_blank" rel="external">http://docs.celeryproject.org/en/latest/getting-started/next-steps.html</a> </li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/youdaonote/">youdaonote</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/17/"><span></span>Prev</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/16/">16</a><a class="page-number" href="/page/17/">17</a><span class="page-number current">18</span><a class="page-number" href="/page/19/">19</a><a class="page-number" href="/page/20/">20</a><span class="space">&hellip;</span><a class="page-number" href="/page/27/">27</a><a class="extend next" rel="next" href="/page/19/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  

  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/youdaonote/" title="youdaonote">youdaonote<sup>209</sup></a></li>
			
		
			
				<li><a href="/tags/源码/" title="源码">源码<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/akka/" title="akka">akka<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/flume/" title="flume">flume<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/ETL/" title="ETL">ETL<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/solr/" title="solr">solr<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/spring/" title="spring">spring<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/调度平台/" title="调度平台">调度平台<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/azkaban/" title="azkaban">azkaban<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/mysql/" title="mysql">mysql<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/scala/" title="scala">scala<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/ambari/" title="ambari">ambari<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/quartz/" title="quartz">quartz<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/python/" title="python">python<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/ember/" title="ember">ember<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/nodejs/" title="nodejs">nodejs<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/R/" title="R">R<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/guava/" title="guava">guava<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/heroku/" title="heroku">heroku<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/hdfs/" title="hdfs">hdfs<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://github.com/willcup" target="_blank" title=" 我自己的github">github</a>
            
          </li>
        
          <li>
            
            	<a href="http://thisding.com" target="_blank" title="朋友的主页">Steven&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Will Chen in MeiTuan. <br/>
			元 亨 利 贞.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:chenxin15@meituan.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2017 
		
		<a href="/about" target="_blank" title="Will Chen">Will Chen</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fe6d1f421bbc9962127a50488f9ed37d1' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
