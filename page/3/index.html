
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Will&#39;s Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1,user-scalable=no">
    
    <meta name="author" content="Will Chen">
    

    
    <meta name="description" content="左右水色 右手天光">
<meta property="og:type" content="website">
<meta property="og:title" content="Will's Blog">
<meta property="og:url" content="http://willcup.com/page/3/index.html">
<meta property="og:site_name" content="Will's Blog">
<meta property="og:description" content="左右水色 右手天光">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Will's Blog">
<meta name="twitter:description" content="左右水色 右手天光">

    
    <link rel="alternative" href="/atom.xml" title="Will&#39;s Blog" type="application/atom+xml">
    
    
    <link rel="icon" href="/img/favicon.ico">
    
    
    <link rel="apple-touch-icon" href="/img/jacman.jpg">
    <link rel="apple-touch-icon-precomposed" href="/img/jacman.jpg">
    
    <link rel="stylesheet" href="/css/style.css">
</head>

  <body>
    <header>
      
<div>
		
			<div id="imglogo">
				<a href="/"><img src="/img/logo.png" alt="Will&#39;s Blog" title="Will&#39;s Blog"/></a>
			</div>
			
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="Will&#39;s Blog">Will&#39;s Blog</a></h1>
				<h2 class="blog-motto">简易 变易 不易</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
					<ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/node_modules">测试</a></li>
					
						<li><a href="/about">关于</a></li>
					
					<li>
 					
					<form class="search" action="//google.com/search" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="search" id="search" name="q" autocomplete="off" maxlength="20" placeholder="搜索" />
						<input type="hidden" name="q" value="site:willcup.com">
					</form>
					
					</li>
				</ul>
			</nav>			
</div>
    </header>
    <div id="container">
      <div id="main">

   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/17/一步步搞定ETL依赖调度平台（三）-调度优先级思考/" title="一步步搞定ETL依赖调度平台（三）-调度优先级思考" itemprop="url">一步步搞定ETL依赖调度平台（三）-调度优先级思考</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-06-17T03:21:50.000Z" itemprop="datePublished"> 发表于 2016-06-17</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>从《azkaban源码追踪（三）-上传zip的坑》可以看到azkaban本身的调度基本是广度优先执行的。</p>
<h3 id="1-猎聘"><a href="#1-猎聘" class="headerlink" title="1.猎聘"></a>1.猎聘</h3><p><img src="/imgs/azkaban/schedule-lp-tree.png" alt="猎聘的调度tree"></p>
<p>优先级生成策略是从叶子节点向上遍历，每个节点的优先级=所有子节点优先级+edge数(也就是子节点数)。其实思想就是谁下面的小弟多，谁的优先级就越大。</p>
<p>但这通常并不完全适用于对于指定的单个叶子节点最优先的需求，极端点儿想的话，可能出现老的ETL有100多个相关成一个flow，可是新增的优先级特别高的需求super_etl在另一个只有1个节点的flow，或者在同一个flow，但是它没有小弟（这种其实蛮常见的）。那么super_etl的默认priority是1，根本没有地位！！！</p>
<blockquote>
<p>LP的人说了：我们可以给它人工指定优先级啊！<br>额。。。。是的，但是其他的tree是在一直生长的，按照你们的策略来看，这个super_etl的优先级要一直改变。<br>LP的人又说了：我们可以动态指定！<br>额。。。。是的，但是后面出现了super_etl01,super_etl02的时候，可能就会特别特别麻烦了。</p>
</blockquote>
<p>再看一下，计划顺序与实际执行顺序的对比。本来C的优先级是比B高的，可猎聘给出的实际执行却是先执行B后执行c，音频中苏总说是并发问题，个人看来稍稍有些含糊其辞了。推测猎聘的实际调度的时候并不完全以priority为指导，而仍然是azkaban广度遍历优先，同一个level之内才是priority优先执行。</p>
<p>参考:<a href="http://mp.weixin.qq.com/s?src=3&amp;timestamp=1466131251&amp;ver=1&amp;signature=YfS7PgVR0SjjLt4KwIQ297t4SDiLrrJu5C7uuMXpkCvuhvjXk-DU*eJGfIBSfjDm-WlVuwaIbGtbfda-k-5rRgUewAlvjSUQBBNY4jnjuvQD1puqdaVzUqIq9ds*x1r-6dUnU6OiSERzBt5UWfjdUkekpmc7hNqTm1pklClkSkE=" target="_blank" rel="external">http://mp.weixin.qq.com/s?src=3&amp;timestamp=1466131251&amp;ver=1&amp;signature=YfS7PgVR0SjjLt4KwIQ297t4SDiLrrJu5C7uuMXpkCvuhvjXk-DU*eJGfIBSfjDm-WlVuwaIbGtbfda-k-5rRgUewAlvjSUQBBNY4jnjuvQD1puqdaVzUqIq9ds*x1r-6dUnU6OiSERzBt5UWfjdUkekpmc7hNqTm1pklClkSkE=</a></p>
<h3 id="2-美团"><a href="#2-美团" class="headerlink" title="2.美团"></a>2.美团</h3><p><img src="/imgs/azkaban/schedule-mt-tree.png" alt="美团的调度tree"></p>
<p>调度策略就不该是递归调度，而应该完全按照优先级别去调度。想来想去，这才是真正的优先级调度。东家靠谱儿！</p>
<p>参考：<a href="http://mp.weixin.qq.com/s?src=3&amp;timestamp=1466131231&amp;ver=1&amp;signature=YfS7PgVR0SjjLt4KwIQ297t4SDiLrrJu5C7uuMXpkCtKEZcZ58gspxJhkgDlgXAkqQvXpI3IbmE4HzkI33W*4PJCOUoKyzSna56Q8uSQgUNnSl7vsxqLcREVfDBU0nPguiAiwnosiXyE9wB7T-edr3QrRn8rKMhB3oxjQDrS1RQ=" target="_blank" rel="external">http://mp.weixin.qq.com/s?src=3&amp;timestamp=1466131231&amp;ver=1&amp;signature=YfS7PgVR0SjjLt4KwIQ297t4SDiLrrJu5C7uuMXpkCtKEZcZ58gspxJhkgDlgXAkqQvXpI3IbmE4HzkI33W*4PJCOUoKyzSna56Q8uSQgUNnSl7vsxqLcREVfDBU0nPguiAiwnosiXyE9wB7T-edr3QrRn8rKMhB3oxjQDrS1RQ=</a></p>
<p>综上：后面本人要开发的调度系统优先级策略会借用美团的思想。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/ETL/">ETL</a><a href="/tags/调度平台/">调度平台</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/16/azkaban源码追踪（三）-上传zip的坑/" title="azkaban源码追踪（三）-上传zip的坑" itemprop="url">azkaban源码追踪（三）-上传zip的坑</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-06-16T11:16:06.000Z" itemprop="datePublished"> 发表于 2016-06-16</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>前面其实已经解析了上传zip文件到azkaban的流程，但是自己都感觉写的实在是太操蛋了。</p>
<h3 id="1-时序图"><a href="#1-时序图" class="headerlink" title="1. 时序图"></a>1. 时序图</h3><p><img src="/imgs/azkaban/azkaban-atash-sequence-diagram.png" alt="上传zip文件的时序图"></p>
<h3 id="2-坑的表现"><a href="#2-坑的表现" class="headerlink" title="2. 坑的表现"></a>2. 坑的表现</h3><p>ETL的依赖关系肯定的多父多子的，所以就上传了一个典型到azkaban上。结果被分成了两个flow</p>
<p><img src="/imgs/azkaban/azkaban-two-wrong-flow.png" alt="拥有相关ETL的flow被分成了两个"></p>
<p><img src="/imgs/azkaban/azkaban-wrong-flow-1.png" alt="第一个错误的flow"></p>
<p><img src="/imgs/azkaban/azkaban-wrong-flow-2.png" alt="第二个错误的flow"></p>
<p>可以看到对于mymeta@my_table_c之上的etl，对于下面的node应该是公用的，像现在这样两个flow都有的话，就会导致这些node被多次执行。</p>
<h3 id="3-源码分析"><a href="#3-源码分析" class="headerlink" title="3.源码分析"></a>3.源码分析</h3><p>根据上面的时序图，我们可以看到问题应该是出在分析依赖或者创建flow的过程中。所以过去剖析对应源码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 就是把每个node的dependency map放进HashMap&lt;String, Map&lt;String, Edge&gt;&gt; nodeDependencies里面，一个对应多个dependencies</span></div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resolveDependencies</span><span class="params">()</span> </span>&#123;</div><div class="line">    <span class="comment">// Add all the in edges and out edges. Catch bad dependencies and self</span></div><div class="line">    <span class="comment">// referrals. Also collect list of nodes who are parents.</span></div><div class="line">    <span class="keyword">for</span> (Node node : nodeMap.values()) &#123;</div><div class="line">      Props props = jobPropsMap.get(node.getId());</div><div class="line"></div><div class="line">      List&lt;String&gt; dependencyList =</div><div class="line">          props.getStringList(CommonJobProperties.DEPENDENCIES,</div><div class="line">              (List&lt;String&gt;) <span class="keyword">null</span>);</div><div class="line"></div><div class="line">      <span class="keyword">if</span> (dependencyList != <span class="keyword">null</span>) &#123;</div><div class="line">        Map&lt;String, Edge&gt; dependencies = nodeDependencies.get(node.getId());</div><div class="line">        <span class="keyword">if</span> (dependencies == <span class="keyword">null</span>) &#123;</div><div class="line">          dependencies = <span class="keyword">new</span> HashMap&lt;String, Edge&gt;();</div><div class="line"></div><div class="line">          <span class="keyword">for</span> (String dependencyName : dependencyList) &#123;</div><div class="line">            dependencyName =</div><div class="line">                dependencyName == <span class="keyword">null</span> ? <span class="keyword">null</span> : dependencyName.trim();</div><div class="line">            <span class="keyword">if</span> (dependencyName == <span class="keyword">null</span> || dependencyName.isEmpty()) &#123;</div><div class="line">              <span class="keyword">continue</span>;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            Edge edge = <span class="keyword">new</span> Edge(dependencyName, node.getId());</div><div class="line">            Node dependencyNode = nodeMap.get(dependencyName);</div><div class="line">            <span class="keyword">if</span> (dependencyNode == <span class="keyword">null</span>) &#123;</div><div class="line">              <span class="keyword">if</span> (duplicateJobs.contains(dependencyName)) &#123;</div><div class="line">                edge.setError(<span class="string">"Ambiguous Dependency. Duplicates found."</span>);</div><div class="line">                dependencies.put(dependencyName, edge);</div><div class="line">                errors.add(node.getId() + <span class="string">" has ambiguous dependency "</span></div><div class="line">                    + dependencyName);</div><div class="line">              &#125; <span class="keyword">else</span> &#123;</div><div class="line">                edge.setError(<span class="string">"Dependency not found."</span>);</div><div class="line">                dependencies.put(dependencyName, edge);</div><div class="line">                errors.add(node.getId() + <span class="string">" cannot find dependency "</span></div><div class="line">                    + dependencyName);</div><div class="line">              &#125;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (dependencyNode == node) &#123;</div><div class="line">              <span class="comment">// We have a self cycle</span></div><div class="line">              edge.setError(<span class="string">"Self cycle found."</span>);</div><div class="line">              dependencies.put(dependencyName, edge);</div><div class="line">              errors.add(node.getId() + <span class="string">" has a self cycle"</span>);</div><div class="line">            &#125; <span class="keyword">else</span> &#123;</div><div class="line">              dependencies.put(dependencyName, edge);</div><div class="line">            &#125;</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="keyword">if</span> (!dependencies.isEmpty()) &#123;</div><div class="line">            nodeDependencies.put(node.getId(), dependencies);</div><div class="line">          &#125;</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">    &#125;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>跟踪源码的时候，没有发现上面代码有任何问题。再看下根据依赖构建flow的过程<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">buildFlowsFromDependencies</span><span class="params">()</span> </span>&#123;</div><div class="line">  <span class="comment">// Find all root nodes by finding ones without dependents.</span></div><div class="line">  <span class="comment">/********************注意这里 ***********************/</span></div><div class="line">  HashSet&lt;String&gt; nonRootNodes = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">  <span class="keyword">for</span> (Map&lt;String, Edge&gt; edges : nodeDependencies.values()) &#123;</div><div class="line">    <span class="keyword">for</span> (String sourceId : edges.keySet()) &#123;</div><div class="line">      nonRootNodes.add(sourceId);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// Now create flows. Bad flows are marked invalid</span></div><div class="line">  Set&lt;String&gt; visitedNodes = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">  <span class="keyword">for</span> (Node base : nodeMap.values()) &#123;</div><div class="line">    <span class="comment">// Root nodes can be discovered when parsing jobs</span></div><div class="line">    <span class="comment">/********************注意这里 ***********************/</span></div><div class="line">    <span class="keyword">if</span> (rootNodes.contains(base.getId())</div><div class="line">        || !nonRootNodes.contains(base.getId())) &#123;</div><div class="line">      rootNodes.add(base.getId());</div><div class="line">      Flow flow = <span class="keyword">new</span> Flow(base.getId());</div><div class="line">      Props jobProp = jobPropsMap.get(base.getId());</div><div class="line"></div><div class="line">      <span class="comment">// 遍历properties里的各种通知邮件啥的</span></div><div class="line"></div><div class="line">      flow.addFailureEmails(failureEmail);</div><div class="line">      flow.addSuccessEmails(successEmail);</div><div class="line"></div><div class="line">      flow.addAllFlowProperties(flowPropsList);</div><div class="line">      constructFlow(flow, base, visitedNodes);</div><div class="line">      flow.initialize();</div><div class="line">      flowMap.put(base.getId(), flow);</div><div class="line">    &#125;</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>上面第一个地方是找到所有非root的node，看代码意思就是所有有dependency的node。第二个注意的地方是找rootNodes里有或者不存在与非rootNode集合的node。这不是叶子节点么，下面紧接着就add进去rootNodes了。也就是说azkaban中这里的node的<strong>root角色其实是指的叶子节点</strong>。第三个是flow是按照叶子节点的id命名的，也就是有多少叶子节点就会有多少flow被生成。<br>解释通了，因为我们的project的zip文件中是有两个叶子节点的job，所以就被分成了两个flow。</p>
<h3 id="4-解决方案"><a href="#4-解决方案" class="headerlink" title="4. 解决方案"></a>4. 解决方案</h3><p>生成最终的zip文件之前，生成一个虚拟end job，把所有的叶子节点都配置成它的dependency，这样就只有一个flow了。</p>
<p><img src="/imgs/azkaban/azkaban-right-flow.png" alt="最终生成的正确的flow图"></p>
<p><img src="/imgs/azkaban/azkaban-right-flow-execution.png" alt="尝试执行以下正确的这个flow"></p>
<p>可以看到，并列在同一个level的node是并发执行的，因为他们两个之间相互没有任何影响。这样使用并发充分利用资源，但是azkaban的并发性能和稳定性需要进一步探查。</p>
<h3 id="5-TODO"><a href="#5-TODO" class="headerlink" title="5.TODO"></a>5.TODO</h3><p>每个任务的Runner稳定性测试与定制开发(希望不需要)</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/azkaban/">azkaban</a><a href="/tags/源码/">源码</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/16/一步步搞定ETL依赖调度平台（二）-与azkaban整合/" title="一步步搞定ETL依赖调度平台（二）-zakaban整合实施" itemprop="url">一步步搞定ETL依赖调度平台（二）-zakaban整合实施</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-06-16T03:22:25.000Z" itemprop="datePublished"> 发表于 2016-06-16</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>再列以下前面提到的步骤：</p>
<ol>
<li>通过azkaban api创建一个project: etl_20160615;</li>
<li>调用java程序根据tbl_blood和etl内容生成azkaban的项目文件20160615.zip;</li>
<li>通过azkaban api上传此文件到etl_20160615的project上</li>
<li>通过azkaban api遍历etl_20160615项目下的所有flow，进行调度。</li>
</ol>
<p>其实（一）里面是第二步的实现。今儿调研了以下azkaban的ajax api，并没有想象中的那么简单，所以就再单独说一下怎样完成其他步骤——重要的难点在于<strong>session-id的获取</strong>。</p>
<h3 id="1-方案与问题"><a href="#1-方案与问题" class="headerlink" title="1. 方案与问题"></a>1. 方案与问题</h3><table>
<thead>
<tr>
<th>方案</th>
<th>问题</th>
<th>解决方案</th>
</tr>
</thead>
<tbody>
<tr>
<td>使用azkaban api</td>
<td>需要session-id进行server端验证</td>
<td>1. 使用phantomjs等模拟实现浏览器，从cookie中获取session-id——费事<br>2. 想办法使一个session-id永不过期(这个实施起来最简单，但是稳定程度有待测试)<br>3.azkaban web server启动了rest.li里的userManagerResource，login是返回session-id的，但是需要研习以下rest.li<br>找了半天，解决了:  curl -k -X POST –data “username=azkaban&amp;password=azkaban&amp;action=login” <a href="http://10.1.5.66:8001" target="_blank" rel="external">http://10.1.5.66:8001</a></td>
</tr>
<tr>
<td>直接操作数据</td>
<td>需要对上传zip文件后生成的mysql表足够了解，包括存储的每个字段的内容与规范</td>
<td>将现有的项目中的内容弄出来验证规范后，开始实施</td>
</tr>
<tr>
<td>抽取操作中用到的azkaban的主要类</td>
<td>准备实例化这些类的成员变量</td>
<td>这些成员变量或许比直接插入mysql内容差不多难搞</td>
</tr>
</tbody>
</table>
<hr>
<h3 id="2-实施"><a href="#2-实施" class="headerlink" title="2. 实施"></a>2. 实施</h3><h4 id="2-1-获取session-id"><a href="#2-1-获取session-id" class="headerlink" title="2.1 获取session-id"></a>2.1 获取session-id</h4><p>鉴于时间因素，获取session-id的方案：</p>
<blockquote>
<p>curl -k -X POST –data “username=azkaban&amp;password=azkaban&amp;action=login” <a href="http://10.1.5.66:8001" target="_blank" rel="external">http://10.1.5.66:8001</a><br>返回值：<br><figure class="highlight json"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&#123;</div><div class="line">  <span class="attr">"status"</span> : <span class="string">"success"</span>,</div><div class="line">  <span class="attr">"session.id"</span> : <span class="string">"4e3da52b-fa1f-478d-836c-42122ced2341"</span></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
</blockquote>
<p>解析session-id的脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">curl -k -X POST --data <span class="string">"username=azkaban&amp;password=azkaban&amp;action=login"</span> http://10.1.5.66:8001 &gt; etl_tmp</div><div class="line">session_id=`cat etl_tmp | grep session | awk -F\<span class="string">" '!/[&#123;&#125;]/&#123;print <span class="variable">$(NF-1)</span>&#125;'`</span></div><div class="line">echo "we got session id : <span class="variable">$session_id</span><span class="string">"</span></div></pre></td></tr></table></figure></p>
<h4 id="2-2-创建project"><a href="#2-2-创建project" class="headerlink" title="2.2  创建project"></a>2.2  创建project</h4><p>这里其实先安装了一个shell的json解析工具JSON.sh：<a href="https://github.com/dominictarr/JSON.sh" target="_blank" rel="external">https://github.com/dominictarr/JSON.sh</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">curl -k -X POST --data <span class="string">"session.id=<span class="variable">$&#123;session_id&#125;</span>&amp;name=<span class="variable">$&#123;project_name&#125;</span>&amp;description=<span class="variable">$&#123;project_desc&#125;</span>"</span> http://<span class="variable">$&#123;host&#125;</span>/manager?action=create &gt; <span class="variable">$&#123;etl_tmp&#125;</span></div><div class="line">status=`cat <span class="variable">$&#123;etl_tmp&#125;</span> | JSON.sh -b| grep status | awk <span class="string">'&#123;print($2)&#125;'</span>`</div><div class="line"><span class="keyword">if</span> [ <span class="variable">$status</span> != <span class="string">'"success"'</span> ]; <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"error happends when creting project <span class="variable">$&#123;project_name&#125;</span>. status is <span class="variable">$&#123;status&#125;</span>"</span></div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"project <span class="variable">$&#123;project_name&#125;</span> has been created successfully."</span></div></pre></td></tr></table></figure></p>
<h4 id="2-3-上传zip文件"><a href="#2-3-上传zip文件" class="headerlink" title="2.3 上传zip文件"></a>2.3 上传zip文件</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">curl -k -i -H <span class="string">"Content-Type: multipart/mixed"</span> -X POST --form <span class="string">"session.id=<span class="variable">$&#123;session_id&#125;</span>"</span> --form <span class="string">'ajax=upload'</span> --form <span class="string">"file=@<span class="variable">$&#123;project_zip_file&#125;</span>"</span> --form <span class="string">"project=<span class="variable">$&#123;project_name&#125;</span>"</span> http://<span class="variable">$&#123;host&#125;</span>/manager?ajax=upload &gt; <span class="variable">$&#123;etl_tmp&#125;</span></div><div class="line">status=`cat <span class="variable">$&#123;etl_tmp&#125;</span> | awk <span class="string">'&#123;if(index($0,"error") &gt; 0) print("error")&#125;'</span>`</div><div class="line"><span class="keyword">if</span> [ <span class="variable">$status</span> == <span class="string">"error"</span> ]; <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"error happends when uploading project <span class="variable">$&#123;project_name&#125;</span>. status is <span class="variable">$&#123;status&#125;</span>"</span></div><div class="line">        <span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">fi</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"uploading project <span class="variable">$&#123;project_name&#125;</span> successfully"</span></div></pre></td></tr></table></figure>
<p>ps: 没有继续使用JSON.sh的原因是解析报错…看来还是不健全</p>
<h4 id="2-4-执行flow"><a href="#2-4-执行flow" class="headerlink" title="2.4 执行flow"></a>2.4 执行flow</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">curl -k --get --data <span class="string">"session.id=<span class="variable">$&#123;session_id&#125;</span>&amp;ajax=fetchprojectflows&amp;project=<span class="variable">$&#123;project_name&#125;</span>"</span> http://<span class="variable">$&#123;host&#125;</span>/manager &gt; <span class="variable">$&#123;etl_tmp&#125;</span></div><div class="line"><span class="keyword">for</span> flow <span class="keyword">in</span> `cat <span class="variable">$&#123;etl_tmp&#125;</span> |  JSON.sh -b | grep flowId |  awk <span class="string">'&#123;gsub("\"","",$2);print($2)&#125;'</span>`</div><div class="line"><span class="keyword">do</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"flow is <span class="variable">$flow</span>, ready to execute"</span></div><div class="line">        curl -k --get --data <span class="string">"session.id=<span class="variable">$&#123;session_id&#125;</span>"</span> --data <span class="string">'ajax=executeFlow'</span> --data <span class="string">"project=<span class="variable">$&#123;project_name&#125;</span>"</span> --data <span class="string">"flow=<span class="variable">$&#123;flow&#125;</span>"</span> http://<span class="variable">$&#123;host&#125;</span>/executor &gt;<span class="variable">$&#123;etl_tmp&#125;</span><span class="variable">$&#123;flow&#125;</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$flow</span> execution done"</span></div><div class="line"><span class="keyword">done</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"all flows for project <span class="variable">$&#123;project_name&#125;</span> has been executed"</span></div></pre></td></tr></table></figure>
<h3 id="3-shell全文"><a href="#3-shell全文" class="headerlink" title="3.shell全文"></a>3.shell全文</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#!/bin/bash</span></div><div class="line"></div><div class="line">etl_tmp=/tmp/etl_tmp_log</div><div class="line">host=10.0.1.62:8081</div><div class="line">metamap_host=10.0.1.62:8088</div><div class="line">project_desc=daily_schedule</div><div class="line"></div><div class="line"><span class="comment"># 调用生成job的任务，返回任务名称或者失败信息</span></div><div class="line">curl -X GET http://<span class="variable">$&#123;metamap_host&#125;</span>/metamap/etls/generate_job_dag/ &gt; <span class="variable">$&#123;etl_tmp&#125;</span></div><div class="line">filename=`cat <span class="variable">$&#123;etl_tmp&#125;</span>`</div><div class="line"><span class="keyword">if</span> [ <span class="variable">$filename</span> == <span class="string">"error"</span> -o <span class="variable">$&#123;#filename&#125;</span> <span class="_">-ne</span> 14 ]; <span class="keyword">then</span></div><div class="line">        <span class="built_in">echo</span> <span class="string">"error happends when generate Job Scripts. ori_filename is <span class="variable">$&#123;filename&#125;</span>"</span></div><div class="line">	<span class="built_in">echo</span> <span class="string">"length is <span class="variable">$&#123;#filename&#125;</span>"</span></div><div class="line">        <span class="built_in">exit</span> 1</div><div class="line"><span class="keyword">fi</span></div><div class="line"></div><div class="line">project_name=etl_<span class="variable">$&#123;filename&#125;</span></div><div class="line">project_zip_file=/tmp/<span class="variable">$&#123;filename&#125;</span>.zip</div><div class="line"></div><div class="line"><span class="built_in">echo</span> <span class="string">"project_name is <span class="variable">$&#123;project_name&#125;</span>"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"project_zip_file is <span class="variable">$&#123;project_zip_file&#125;</span>"</span></div><div class="line"><span class="built_in">echo</span> <span class="string">"azkaban host is <span class="variable">$&#123;host&#125;</span>"</span></div><div class="line"></div><div class="line"><span class="comment"># 获取session id</span></div><div class="line">curl -k -X POST --data <span class="string">"username=azkaban&amp;password=azkaban&amp;action=login"</span> http://<span class="variable">$&#123;host&#125;</span> &gt; <span class="variable">$&#123;etl_tmp&#125;</span></div><div class="line"><span class="built_in">echo</span> result is `cat <span class="variable">$&#123;etl_tmp&#125;</span>`</div><div class="line">session_id=`cat <span class="variable">$&#123;etl_tmp&#125;</span> | grep session | awk -F\<span class="string">" '!/[&#123;&#125;]/&#123;print <span class="variable">$(NF-1)</span>&#125;'`</span></div><div class="line">echo "we got session id : <span class="variable">$session_id</span><span class="string">"</span></div><div class="line"></div><div class="line">### 创建project</div><div class="line">echo "project name is <span class="variable">$&#123;project_name&#125;</span><span class="string">"</span></div><div class="line">curl -k -X POST --data "session.id=<span class="variable">$&#123;session_id&#125;</span>&amp;name=<span class="variable">$&#123;project_name&#125;</span>&amp;description=<span class="variable">$&#123;project_desc&#125;</span><span class="string">" http://<span class="variable">$&#123;host&#125;</span>/manager?action=create &gt; <span class="variable">$&#123;etl_tmp&#125;</span></span></div><div class="line">status=`cat <span class="variable">$&#123;etl_tmp&#125;</span> | JSON.sh -b| grep status | awk '&#123;print(<span class="variable">$2</span>)&#125;'` </div><div class="line">if [ <span class="variable">$status</span> != '"success<span class="string">"' ]; then</span></div><div class="line">        echo "error happends when creting project <span class="variable">$&#123;project_name&#125;</span>. status is <span class="variable">$&#123;status&#125;</span><span class="string">"</span></div><div class="line">	exit 1</div><div class="line">fi</div><div class="line">echo "project <span class="variable">$&#123;project_name&#125;</span> has been created successfully.<span class="string">"</span></div><div class="line"></div><div class="line"># 上传zip文件到指定project</div><div class="line">curl -k -i -H "Content-Type: multipart/mixed<span class="string">" -X POST --form "</span>session.id=<span class="variable">$&#123;session_id&#125;</span><span class="string">" --form 'ajax=upload' --form "</span>file=@<span class="variable">$&#123;project_zip_file&#125;</span><span class="string">" --form "</span>project=<span class="variable">$&#123;project_name&#125;</span><span class="string">" http://<span class="variable">$&#123;host&#125;</span>/manager?ajax=upload &gt; <span class="variable">$&#123;etl_tmp&#125;</span></span></div><div class="line">status=`cat <span class="variable">$&#123;etl_tmp&#125;</span> | awk '&#123;if(index(<span class="variable">$0</span>,"error<span class="string">") &gt; 0) print("</span>error<span class="string">")&#125;'`</span></div><div class="line">if [[ <span class="variable">$status</span> = "error<span class="string">" ]]; then</span></div><div class="line">        echo "error happends when uploading project <span class="variable">$&#123;project_name&#125;</span>. status is <span class="variable">$&#123;status&#125;</span><span class="string">"</span></div><div class="line">        exit 1</div><div class="line">fi</div><div class="line">echo "uploading project <span class="variable">$&#123;project_name&#125;</span> successfully<span class="string">"</span></div><div class="line"></div><div class="line"># </div><div class="line"># 阻塞检察某个execution的进度</div><div class="line">#</div><div class="line">function check_exec_status()&#123;</div><div class="line">	execid=<span class="variable">$1</span></div><div class="line">	sleep 1h</div><div class="line">	#查看前execution的执行状态，完成后退出</div><div class="line">	status=RUNNING</div><div class="line">	until [ <span class="variable">$status</span> == '"SUCCEEDED<span class="string">"' ]</span></div><div class="line">	do</div><div class="line">    		curl -k --get --data "session.id=<span class="variable">$&#123;session_id&#125;</span>&amp;ajax=fetchexecflowupdate&amp;execid=<span class="variable">$&#123;execid&#125;</span>&amp;lastUpdateTime=-1<span class="string">" http://<span class="variable">$&#123;host&#125;</span>/executor &gt; <span class="variable">$&#123;etl_tmp&#125;</span></span></div><div class="line">    		status=`cat <span class="variable">$&#123;etl_tmp&#125;</span> | JSON.sh -b| grep status | grep -v node | awk '&#123;print(<span class="variable">$2</span>)&#125;'`</div><div class="line">		if [ <span class="variable">$status</span> == '"KILLED<span class="string">"' ]; then</span></div><div class="line">			echo "<span class="variable">$&#123;execid&#125;</span> has been killed.<span class="string">"</span></div><div class="line">			break</div><div class="line">		elif [ <span class="variable">$status</span> == '"FAILED<span class="string">"' ]; then</span></div><div class="line">                        echo "<span class="variable">$&#123;execid&#125;</span> has been failed.<span class="string">"</span></div><div class="line">                        break</div><div class="line">		fi</div><div class="line">    		echo "<span class="variable">$&#123;execid&#125;</span> not yet...<span class="string">" `cat <span class="variable">$&#123;etl_tmp&#125;</span>`</span></div><div class="line">		sleep 10m	</div><div class="line">	done</div><div class="line">&#125;</div><div class="line"></div><div class="line"># 遍历执行project下的flow</div><div class="line">curl -k --get --data "session.id=<span class="variable">$&#123;session_id&#125;</span>&amp;ajax=fetchprojectflows&amp;project=<span class="variable">$&#123;project_name&#125;</span><span class="string">" http://<span class="variable">$&#123;host&#125;</span>/manager &gt; <span class="variable">$&#123;etl_tmp&#125;</span></span></div><div class="line">for flow in `cat <span class="variable">$&#123;etl_tmp&#125;</span> |  JSON.sh -b | grep flowId |  awk '&#123;gsub("\<span class="string">""</span>,<span class="string">""</span>,<span class="variable">$2</span>);<span class="built_in">print</span>(<span class="variable">$2</span>)&#125;<span class="string">'`</span></div><div class="line">do</div><div class="line">        echo "flow is $flow, ready to execute"</div><div class="line">        curl -k --get --data "session.id=$&#123;session_id&#125;" --data 'ajax=executeFlow<span class="string">' --data "project=$&#123;project_name&#125;" --data "flow=$&#123;flow&#125;" --data "failureAction=finishPossible" http://$&#123;host&#125;/executor &gt;$&#123;etl_tmp&#125;$&#123;flow&#125;</span></div><div class="line">        execid=`cat $&#123;etl_tmp&#125;$&#123;flow&#125; | JSON.sh -b| grep execid | awk '&#123;<span class="built_in">print</span>(<span class="variable">$2</span>)&#125;<span class="string">'`</span></div><div class="line">	echo "got execid : $&#123;execid&#125;"</div><div class="line">	check_exec_status $&#123;execid&#125;</div><div class="line">echo "$flow execution done"</div><div class="line">done</div><div class="line">echo "all flows for project $&#123;project_name&#125; has been executed"</div></pre></td></tr></table></figure>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/ETL/">ETL</a><a href="/tags/调度平台/">调度平台</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/15/一步步搞定ETL依赖调度平台（一）/" title="一步步搞定ETL依赖调度平台（一）" itemprop="url">一步步搞定ETL依赖调度平台（一）</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-06-15T10:48:43.000Z" itemprop="datePublished"> 发表于 2016-06-15</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h3 id="1-依赖解析"><a href="#1-依赖解析" class="headerlink" title="1. 依赖解析"></a>1. 依赖解析</h3><ul>
<li>sql AST解析。相关工具antlr,这是一个定义与解析特定语言的工具。</li>
<li>hive denpendency： explain dependency select * from a.</li>
<li>其他sql解析工具，功能类似hive dependency</li>
</ul>
<p>鉴于我们的数据仓库使用hive搭建，使用hive dependency的兼容性更有保证。注意两点：1.如果a表不存在与hive中，就会报错找不到table。也就是说ETL开发的时候，它的依赖必须已经存在与hive库里；2. 由于依赖解析功能在ETL开发平台上，所以必须通过hiveserver2进行访问，效率可能不高，但是ETL平台对此要求也不会太高。</p>
<p>需要额外说一下antlr的好处：一是可以深入剖析sql，在这一层做字段级别的权限控制；二是可以做一些sql的分析，反馈给ETL开发者一些优化建议；</p>
<h3 id="2-存库"><a href="#2-存库" class="headerlink" title="2. 存库"></a>2. 存库</h3><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">-- ----------------------------</span></div><div class="line"><span class="comment">-- Table structure for etl</span></div><div class="line"><span class="comment">-- ----------------------------</span></div><div class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`etl`</span>;</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`etl`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</div><div class="line">  <span class="string">`query`</span> <span class="built_in">varchar</span>(<span class="number">2000</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'sql语句'</span>,</div><div class="line">  <span class="string">`meta`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'数据库'</span>,</div><div class="line">  <span class="string">`tbl_name`</span> <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'表名'</span>,</div><div class="line">  <span class="string">`author`</span> <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'创建人'</span>,</div><div class="line">  <span class="string">`pre_sql`</span> <span class="built_in">varchar</span>(<span class="number">2000</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'先执行的sql'</span>,</div><div class="line">  <span class="string">`priority`</span> <span class="built_in">int</span>(<span class="number">5</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'5'</span>,</div><div class="line">  <span class="string">`on_schedule`</span> tinyint(<span class="number">4</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'0 不调度 1 调度中'</span>,</div><div class="line">  <span class="string">`valid`</span> tinyint(<span class="number">4</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`ctime`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`utime`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">19</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">-- ----------------------------</span></div><div class="line"><span class="comment">-- Table structure for tbl_blood</span></div><div class="line"><span class="comment">-- ----------------------------</span></div><div class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`tbl_blood`</span>;</div><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`tbl_blood`</span> (</div><div class="line">  <span class="string">`id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</div><div class="line">  <span class="string">`tbl_name`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`parent_tbl`</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`related_etl_id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">  <span class="string">`valid`</span> tinyint(<span class="number">4</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</div><div class="line">  <span class="string">`ctime`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</div><div class="line">  <span class="string">`utime`</span> <span class="built_in">bigint</span>(<span class="number">20</span>) <span class="keyword">DEFAULT</span> <span class="string">'0'</span>,</div><div class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`id`</span>)</div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> AUTO_INCREMENT=<span class="number">21</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</div></pre></td></tr></table></figure>
<p>每当新建一个ETL的时候都会分析它的依赖，如果分析失败，就不会插入ETL。</p>
<p>另外补充一个字段和表关系的，从hive meta库查询sql<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">SELECT</span></div><div class="line">	db.DB_ID <span class="keyword">AS</span> db_id,</div><div class="line">	db.<span class="string">`NAME`</span> <span class="keyword">AS</span> db_name,</div><div class="line">	a.TBL_ID <span class="keyword">AS</span> tbl_id,</div><div class="line">	a.TBL_NAME <span class="keyword">AS</span> tbl_name,</div><div class="line">	a.TBL_TYPE <span class="keyword">AS</span> tbl_type,</div><div class="line">	d.TYPE_NAME <span class="keyword">AS</span> col_type_name,</div><div class="line">	d.<span class="string">`COMMENT`</span> <span class="keyword">AS</span> col_comment,</div><div class="line">	d.COLUMN_NAME <span class="keyword">AS</span> column_name</div><div class="line"><span class="keyword">FROM</span></div><div class="line">	TBLS a</div><div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> SDS b <span class="keyword">ON</span> a.SD_ID = b.SD_ID</div><div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> COLUMNS_V2 d <span class="keyword">ON</span> b.CD_ID = d.CD_ID</div><div class="line"><span class="keyword">LEFT</span> <span class="keyword">JOIN</span> DBS db <span class="keyword">ON</span> a.DB_ID = db.DB_ID</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="3-每日调度"><a href="#3-每日调度" class="headerlink" title="3.每日调度"></a>3.每日调度</h3><p>有了以上两步之后剩下的就是每日调度问题。分以下几个步骤：</p>
<ol>
<li>通过azkaban api创建一个project: etl_20160615;</li>
<li>调用java程序根据tbl_blood和etl内容生成azkaban的项目文件20160615.zip;</li>
<li>通过azkaban api上传此文件到etl_20160615的project上</li>
<li>通过azkaban api遍历etl_20160615项目下的所有flow，进行调度。</li>
</ol>
<p>生成azkaban文件的逻辑：</p>
<ol>
<li>找出没有被任何其他ETL以来的叶子节点</li>
<li>遍历所有叶子节点，找到这个叶子节点的所有有效依赖，放入dependencies里，如果尚未生成该ETL的job文件</li>
<li>向上递归执行，直到没有dependency的节点，也就是最上一层节点就停止。</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> String <span class="title">generateAzkabanDAG</span><span class="params">()</span> <span class="keyword">throws</span> MetaException, ArchiveException </span>&#123;</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           String serFolder = DateUtil.getTodayDateTime();</div><div class="line">           List&lt;TblBlood&gt; leafBlood = tblBloodDao.selectAllLeaf();</div><div class="line">           Set&lt;String&gt; doneBlood = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">           String serFolderLocation = AZKABAN_BASE_LOCATION + serFolder;</div><div class="line">           <span class="keyword">if</span> (leafBlood.size() &gt; <span class="number">0</span>) &#123;</div><div class="line">               loadLeafBloods(leafBlood, doneBlood, serFolderLocation);</div><div class="line">           &#125;</div><div class="line">           </div><div class="line">           ZipUtils.addFilesToZip(<span class="keyword">new</span> File(serFolderLocation), </div><div class="line">                   <span class="keyword">new</span> File(serFolderLocation + <span class="string">".zip"</span>));</div><div class="line">       &#125; <span class="keyword">catch</span> (IOException e) &#123;</div><div class="line">           log.error(<span class="string">"error happends when generateAzkabanDAG"</span>);</div><div class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> MetaException(<span class="string">"error happends when generateAzkabanDAG"</span>);</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">   &#125;</div><div class="line"></div><div class="line">   </div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadLeafBloods</span><span class="params">(List&lt;TblBlood&gt; leafBlood, Set&lt;String&gt; doneBlood, String serFolder)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line">       <span class="keyword">for</span> (TblBlood leaf : leafBlood) &#123;</div><div class="line">           List&lt;TblBlood&gt; parentNode = tblBloodDao.selectParentByTblName(leaf.getTblName());</div><div class="line">           <span class="keyword">if</span> (!doneBlood.contains(leaf.getTblName())) &#123;</div><div class="line">               generateJobFile(leaf, parentNode, serFolder);</div><div class="line">               doneBlood.add(leaf.getTblName());</div><div class="line">           &#125;</div><div class="line">           loadLeafBloods(parentNode, doneBlood, serFolder);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"></div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">generateJobFile</span><span class="params">(TblBlood currentBlood,  List&lt;TblBlood&gt; parentNode, String serFolder)</span> <span class="keyword">throws</span> IOException </span>&#123;</div><div class="line"></div><div class="line">       String jobName = currentBlood.getTblName();</div><div class="line">       String jobType = <span class="string">"command"</span>;</div><div class="line">       String command = <span class="string">"echo 'I am command for ' "</span> + jobName;</div><div class="line">       String content;</div><div class="line">       Set&lt;String&gt; dependencies = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">       <span class="keyword">for</span> (TblBlood blood : parentNode) &#123;</div><div class="line">           dependencies.add(blood.getTblName());</div><div class="line">       &#125;</div><div class="line">       String jobDependencies = joiner.join(dependencies);</div><div class="line">       content = <span class="string">"# "</span> + jobName + <span class="string">"\n"</span></div><div class="line">               + <span class="string">"type="</span> + jobType +<span class="string">"\n"</span></div><div class="line">                       + <span class="string">"command="</span> + command + <span class="string">"\n"</span>;</div><div class="line">       <span class="keyword">if</span> (StringUtils.isNotBlank(jobDependencies)) &#123;</div><div class="line">           content += <span class="string">"dependencies="</span> + jobDependencies +<span class="string">"\n"</span>;</div><div class="line">       &#125;</div><div class="line">       File file = <span class="keyword">new</span> File(serFolder + <span class="string">"/"</span> + jobName.replace(<span class="string">"@"</span>, <span class="string">"-"</span>) + <span class="string">".job"</span>);</div><div class="line">       FileUtils.write(file, content, <span class="string">"utf8"</span>, <span class="keyword">false</span>);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h3 id="4-参考"><a href="#4-参考" class="headerlink" title="4.参考"></a>4.参考</h3><p><a href="http://azkaban.github.io/azkaban/docs/latest/#ajax-api" target="_blank" rel="external">http://azkaban.github.io/azkaban/docs/latest/#ajax-api</a></p>
<h3 id="5-TODO"><a href="#5-TODO" class="headerlink" title="5. TODO"></a>5. TODO</h3><ul>
<li>flow和job目前都是不支持优先级的，需要探查下azkaban中同一个flow里job执行次序是怎样的。</li>
<li>目前字段解析只能通过部分从hive meta抽，获取到字段与当前表的关系，不能逐个找到字段与字段之间的血统关系。如果使用antlr的话可以分析到每一个as之前是什么，理论上是可以实现字段的血统关系的。</li>
<li>对于每月、每周、每小时的个别ETL的支持策略</li>
<li>支持ETL变量传入和临时调试</li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/ETL/">ETL</a><a href="/tags/调度平台/">调度平台</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/15/azkaban源码追踪-单次调度flow/" title="azkaban源码追踪（二）-单次调度flow" itemprop="url">azkaban源码追踪（二）-单次调度flow</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-06-15T03:09:03.000Z" itemprop="datePublished"> 发表于 2016-06-15</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>对应的操作是进入到某个project中，然后单次执行下面的某个flow。会触发web-server这边与exec-server的远程调用去执行flow。</p>
<h4 id="相关类"><a href="#相关类" class="headerlink" title="相关类"></a>相关类</h4><ul>
<li>Web-server<ul>
<li>ExecutorServlet.doGet</li>
<li>ExecutorManager</li>
</ul>
</li>
<li>exec-server<ul>
<li>ExecutorServlet.doGet</li>
<li>FlowRunnerManager</li>
<li>FlowRunner</li>
<li>ExecutableFlowBase</li>
<li>ExecutableNode</li>
<li>JobRunner</li>
<li>JobTypeManager</li>
<li>Job</li>
<li>AzkabanProcessBuilder</li>
</ul>
</li>
</ul>
<p>#### </p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/azkaban/">azkaban</a><a href="/tags/源码/">源码</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2016/06/15/azkaban源码追踪（一）-uploadProject流程/" title="azkaban源码追踪（一）-uploadProject流程" itemprop="url">azkaban源码追踪（一）-uploadProject流程</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2016-06-15T02:34:28.000Z" itemprop="datePublished"> 发表于 2016-06-15</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h4 id="1-相关类"><a href="#1-相关类" class="headerlink" title="1. 相关类"></a>1. 相关类</h4><ul>
<li>ProjectMangerServlet</li>
<li>ProjectManager</li>
<li>ValidatorManager</li>
<li>DirectoryFlowLoader</li>
<li>JdbcProjectLoader</li>
</ul>
<h4 id="2-对应的流程log"><a href="#2-对应的流程log" class="headerlink" title="2. 对应的流程log"></a>2. 对应的流程log</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">2016/06/14 15:39:18.537 +0800 INFO [ProjectManagerServlet] [Azkaban] Uploading file willjob.zip</div><div class="line">2016/06/14 15:39:23.861 +0800 INFO [ProjectManager] [Azkaban] Uploading files to mytestProject</div><div class="line">2016/06/14 15:40:16.454 +0800 WARN [XmlValidatorManager] [Azkaban] Validator directory validators does not exist or is not a directory</div><div class="line">2016/06/14 15:40:16.455 +0800 WARN [XmlValidatorManager] [Azkaban] Azkaban properties file does not contain the key project.validators</div><div class="line">2016/06/14 15:40:35.752 +0800 INFO [ProjectManager] [Azkaban] Validating project willjob.zip using the registered validators [Director</div><div class="line">2016/06/14 16:11:45.952 +0800 INFO [XmlValidatorManager] [Azkaban] Validation status of validator Directory Flow is PASS</div><div class="line">2016/06/14 16:56:51.338 +0800 INFO [ProjectManager] [Azkaban] Uploading file to db willjob.zip</div><div class="line">2016/06/14 16:56:51.338 +0800 INFO [JdbcProjectLoader] [Azkaban] Uploading to mytestProject version:1 file:willjob.zip</div><div class="line">2016/06/14 16:56:51.341 +0800 INFO [JdbcProjectLoader] [Azkaban] Creating message digest for upload willjob.zip</div><div class="line">2016/06/14 16:56:51.343 +0800 INFO [JdbcProjectLoader] [Azkaban] Md5 hash created</div><div class="line">2016/06/14 16:56:51.359 +0800 INFO [JdbcProjectLoader] [Azkaban] Read bytes for willjob.zip size:560</div><div class="line">2016/06/14 16:56:51.359 +0800 INFO [JdbcProjectLoader] [Azkaban] Running update for willjob.zip chunk 0</div><div class="line">2016/06/14 16:56:51.360 +0800 INFO [JdbcProjectLoader] [Azkaban] Finished update for willjob.zip chunk 0</div><div class="line">2016/06/14 16:56:51.362 +0800 INFO [JdbcProjectLoader] [Azkaban] Commiting upload willjob.zip</div><div class="line">2016/06/14 16:56:51.363 +0800 INFO [ProjectManager] [Azkaban] Uploading flow to db willjob.zip</div><div class="line">2016/06/14 16:56:51.363 +0800 INFO [JdbcProjectLoader] [Azkaban] Uploading flows</div><div class="line">2016/06/14 16:56:51.418 +0800 INFO [JdbcProjectLoader] [Azkaban] Flow upload will3 is byte size 214</div><div class="line">2016/06/14 16:56:51.432 +0800 INFO [JdbcProjectLoader] [Azkaban] Flow upload will2 is byte size 238</div><div class="line">2016/06/14 16:56:51.434 +0800 INFO [ProjectManager] [Azkaban] Changing project versions willjob.zip</div><div class="line">2016/06/14 16:56:51.436 +0800 INFO [ProjectManager] [Azkaban] Uploading Job properties</div><div class="line">2016/06/14 16:56:51.820 +0800 INFO [ProjectManager] [Azkaban] Uploading Props properties</div><div class="line">2016/06/14 16:56:51.822 +0800 INFO [ProjectManager] [Azkaban] Uploaded project files. Cleaning up temp files.</div><div class="line">2016/06/14 16:56:51.927 +0800 INFO [ProjectManager] [Azkaban] Cleaning up old install files older than -2</div></pre></td></tr></table></figure>
<h4 id="3-ProjectManager"><a href="#3-ProjectManager" class="headerlink" title="3. ProjectManager"></a>3. ProjectManager</h4><p>白话一下ProjectManager处理上传zip文件的过程：</p>
<ol>
<li>将文件存到/tmp目录并解压</li>
<li>使用DirectoryFlowLoader解析文件，放置到这个loader的状态变量中。这些变量会一直保存在内存里，以供后面使用</li>
<li>遍历loader里的flowMap，把每个flow都加上最新的project_id和version</li>
<li>上传project信息<ul>
<li>4.1 把zip文件弄成字节流上传到mysql的project_files表中</li>
<li>4.2 把最新版本的project信息上传到project_versions表中</li>
</ul>
</li>
<li>上传flow: 把flow逐个序列化成json，再弄成byte字节流，再使用gzip压缩，上传至project_flows表中</li>
<li>更新projects里的相关记录，并修改内存中的project信息【修改时间等、最新版本的flows】</li>
<li>上传job的详细信息到project_properties中，job的详细信息也是json-&gt;byte[]-&gt;gzip的过程</li>
<li>上传props的详细信息到project_properties中，流程同job完全一样【这个debug的时候数据是空的】</li>
<li>将此次操作插入到project_event中，之后删除本地/tmp下的文件</li>
<li>使用project_id和当前version判断依次清除先前版本的project_flows的flow、project_properties、project_files、project_versions中的记录【会有最近版本保留数量设置project.version.retention，默认是3】</li>
<li>完成<br><img src="/imgs/azkaban/azkaban-upload-zip-handleflow.png" alt="azkaban上传zip很粗糙的流程图"><h4 id="4-文件解析"><a href="#4-文件解析" class="headerlink" title="4. 文件解析"></a>4. 文件解析</h4>DirectoryFlowLoader加载文件目录，解析所有的文件，进行解析，将信息存放在自己的状态变量中：<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> Props props;                          <span class="comment">// 环境、配置信息</span></div><div class="line"><span class="keyword">private</span> HashSet&lt;String&gt; rootNodes;            <span class="comment">// 根节点，也就是实际执行的时候的起始节点</span></div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Flow&gt; flowMap;        <span class="comment">// 所有的flow，key是flowId</span></div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Node&gt; nodeMap;        <span class="comment">// 所有的node，key是JobId或者embed的flowId</span></div><div class="line"><span class="comment">// node之间的dependency，key是job名称，value是一系列的相关依赖job，一般是children，然后Edge指定从谁到谁</span></div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Map&lt;String, Edge&gt;&gt; nodeDependencies;  </div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Props&gt; jobPropsMap;   <span class="comment">// 包含job的详细信息</span></div><div class="line"></div><div class="line"><span class="comment">// flow之间的依赖关系【embedeed flow】</span></div><div class="line"><span class="keyword">private</span> HashMap&lt;String, Set&lt;String&gt;&gt; flowDependencies;</div><div class="line"></div><div class="line"><span class="keyword">private</span> ArrayList&lt;FlowProps&gt; flowPropsList;</div><div class="line"><span class="keyword">private</span> ArrayList&lt;Props&gt; propsList;</div><div class="line"><span class="keyword">private</span> Set&lt;String&gt; errors;</div><div class="line"><span class="keyword">private</span> Set&lt;String&gt; duplicateJobs;</div></pre></td></tr></table></figure>
</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 临时解压目录 baseDirectory : temp/46769225</span></div><div class="line"><span class="comment">// 项目信息 project: testPro</span></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadProjectFlow</span><span class="params">(Project project, File baseDirectory)</span> </span>&#123;</div><div class="line">    propsList = <span class="keyword">new</span> ArrayList&lt;Props&gt;();</div><div class="line">    flowPropsList = <span class="keyword">new</span> ArrayList&lt;FlowProps&gt;();</div><div class="line">    jobPropsMap = <span class="keyword">new</span> HashMap&lt;String, Props&gt;();</div><div class="line">    nodeMap = <span class="keyword">new</span> HashMap&lt;String, Node&gt;();</div><div class="line">    flowMap = <span class="keyword">new</span> HashMap&lt;String, Flow&gt;();</div><div class="line">    errors = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">    duplicateJobs = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">    nodeDependencies = <span class="keyword">new</span> HashMap&lt;String, Map&lt;String, Edge&gt;&gt;();</div><div class="line">    rootNodes = <span class="keyword">new</span> HashSet&lt;String&gt;();</div><div class="line">    flowDependencies = <span class="keyword">new</span> HashMap&lt;String, Set&lt;String&gt;&gt;();</div><div class="line"></div><div class="line">    <span class="comment">// 加载所有的properties、job文件，创建node对象</span></div><div class="line">    loadProjectFromDir(baseDirectory.getPath(), baseDirectory, <span class="keyword">null</span>);</div><div class="line"></div><div class="line">    jobPropertiesCheck(project);</div><div class="line"></div><div class="line">    <span class="comment">// Create edges and find missing dependencies</span></div><div class="line">    resolveDependencies();</div><div class="line"></div><div class="line">    <span class="comment">// 创建flows. 在此之后flowMap里就已经构建好了flow以及job之间的依赖了，node之间通过level来界定先后关系</span></div><div class="line">    buildFlowsFromDependencies();</div><div class="line"></div><div class="line">    <span class="comment">// 处理embedded flows，就是嵌入的flow</span></div><div class="line">    resolveEmbeddedFlows();</div><div class="line"></div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<h5 id="loadProjectFromDir方法详细"><a href="#loadProjectFromDir方法详细" class="headerlink" title="loadProjectFromDir方法详细"></a>loadProjectFromDir方法详细</h5><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">loadProjectFromDir</span><span class="params">(String base, File dir, Props parent)</span> </span>&#123;</div><div class="line">  <span class="comment">// 找出所有的properties</span></div><div class="line">  File[] propertyFiles = dir.listFiles(<span class="keyword">new</span> SuffixFilter(PROPERTY_SUFFIX));</div><div class="line">  Arrays.sort(propertyFiles);</div><div class="line"></div><div class="line">  <span class="keyword">for</span> (File file : propertyFiles) &#123;</div><div class="line">      String relative = getRelativeFilePath(base, file.getPath());</div><div class="line">      parent = <span class="keyword">new</span> Props(parent, file);</div><div class="line">      parent.setSource(relative);</div><div class="line">      FlowProps flowProps = <span class="keyword">new</span> FlowProps(parent);</div><div class="line">      flowPropsList.add(flowProps);</div><div class="line">      logger.info(<span class="string">"Adding "</span> + relative);</div><div class="line">      propsList.add(parent);</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 加载job文件</span></div><div class="line">  File[] jobFiles = dir.listFiles(<span class="keyword">new</span> SuffixFilter(JOB_SUFFIX));</div><div class="line">  <span class="keyword">for</span> (File file : jobFiles) &#123;</div><div class="line">    String jobName = getNameWithoutExtension(file);</div><div class="line">      <span class="keyword">if</span> (!duplicateJobs.contains(jobName)) &#123;</div><div class="line">        <span class="keyword">if</span> (jobPropsMap.containsKey(jobName)) &#123;</div><div class="line">          <span class="comment">// 是否有重复</span></div><div class="line">          ... </div><div class="line">        &#125; <span class="keyword">else</span> &#123;</div><div class="line">          Props prop = <span class="keyword">new</span> Props(parent, file);</div><div class="line">          String relative = getRelativeFilePath(base, file.getPath());</div><div class="line">          prop.setSource(relative);</div><div class="line"></div><div class="line">          Node node = <span class="keyword">new</span> Node(jobName);</div><div class="line">          String type = prop.getString(<span class="string">"type"</span>, <span class="keyword">null</span>);</div><div class="line">          <span class="keyword">if</span> (type == <span class="keyword">null</span>) &#123;</div><div class="line">            errors.add(<span class="string">"Job doesn't have type set '"</span> + jobName + <span class="string">"'."</span>);</div><div class="line">          &#125;</div><div class="line">          node.setType(type); <span class="comment">// job类型</span></div><div class="line">          node.setJobSource(relative);    <span class="comment">// job相对路径</span></div><div class="line">          <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</div><div class="line">            node.setPropsSource(parent.getSource());</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="comment">// Force root node</span></div><div class="line">          <span class="keyword">if</span> (prop.getBoolean(CommonJobProperties.ROOT_NODE, <span class="keyword">false</span>)) &#123;</div><div class="line">            rootNodes.add(jobName);</div><div class="line">          &#125;</div><div class="line"></div><div class="line">          <span class="comment">// 把properties和node放进loader中的队列中</span></div><div class="line">          jobPropsMap.put(jobName, prop);</div><div class="line">          nodeMap.put(jobName, node);</div><div class="line">        &#125;</div><div class="line">      &#125;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  <span class="comment">// 检查是否有子目录</span></div><div class="line">  File[] subDirs = dir.listFiles(DIR_FILTER);</div><div class="line">  <span class="keyword">for</span> (File file : subDirs) &#123;</div><div class="line">    loadProjectFromDir(base, file, parent);</div><div class="line">  &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="常用的blob处理代码"><a href="#常用的blob处理代码" class="headerlink" title="常用的blob处理代码"></a>常用的blob处理代码</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">String propertyJSON = PropsUtils.toJSONString(props, <span class="keyword">true</span>);</div><div class="line">   <span class="keyword">byte</span>[] data = propertyJSON.getBytes(<span class="string">"UTF-8"</span>);</div><div class="line">   <span class="keyword">if</span> (defaultEncodingType == EncodingType.GZIP) &#123;</div><div class="line">     data = GZIPUtils.gzipBytes(data);</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<h4 id="5-其他"><a href="#5-其他" class="headerlink" title="5.其他"></a>5.其他</h4><p><img src="/imgs/azkaban/azkaban-upload-zip-node.png" alt="azkaban上传zip文件时生成的Node结构"></p>
<p>level表示当前node所在的层次。</p>
<p><img src="/imgs/azkaban/Edge-structure.png" alt="azkaban上传zip后内存中表示node连接的Edge结构"></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/azkaban/">azkaban</a><a href="/tags/源码/">源码</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/12/10/spring-quartz集群配置全部资料/" title="spring + quartz集群配置全部资料" itemprop="url">spring + quartz集群配置全部资料</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2015-12-10T07:25:25.000Z" itemprop="datePublished"> 发表于 2015-12-10</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>今天玩儿quartz正玩儿的起劲儿，下午就被否掉了，另一个同事已经被分配了相关的工作，那么我这边的工作就重复了。<br>暂时记下目前了解到的一些配置，方便以后使用。</p>
<h3 id="quartz-xml配置文件"><a href="#quartz-xml配置文件" class="headerlink" title="quartz.xml配置文件"></a>quartz.xml配置文件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</div><div class="line"><span class="tag">&lt;<span class="name">beans</span></span></div><div class="line">        <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></div><div class="line">        <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></div><div class="line">        <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span> = <span class="string">"willtest"</span> <span class="attr">class</span>=<span class="string">"com.will.quartz.task.WillTask"</span>/&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"abnormalDitail"</span> <span class="attr">class</span>=<span class="string">"org.springframework.scheduling.quartz.JobDetailBean"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobClass"</span> <span class="attr">value</span>=<span class="string">"com.will.quartz.task.WillSpringJob"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobDataAsMap"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">map</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"timeout"</span> <span class="attr">value</span>=<span class="string">"5"</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">map</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"anotherJob"</span> <span class="attr">class</span>=<span class="string">"org.springframework.scheduling.quartz.JobDetailBean"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobClass"</span> <span class="attr">value</span>=<span class="string">"com.will.quartz.task.AnotherSJob"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobDataAsMap"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">map</span>&gt;</span></div><div class="line">                <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"timeout"</span> <span class="attr">value</span>=<span class="string">"5"</span> /&gt;</span></div><div class="line">            <span class="tag">&lt;/<span class="name">map</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="comment">&lt;!--  调度触发器 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"abnormalTigger"</span> <span class="attr">class</span>=<span class="string">"org.springframework.scheduling.quartz.CronTriggerBean"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobDetail"</span> <span class="attr">ref</span>=<span class="string">"abnormalDitail"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cronExpression"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>*/5 * * * * ?<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line">    <span class="comment">&lt;!--  调度触发器 --&gt;</span></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"anotherJobTigger"</span> <span class="attr">class</span>=<span class="string">"org.springframework.scheduling.quartz.CronTriggerBean"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobDetail"</span> <span class="attr">ref</span>=<span class="string">"anotherJob"</span>/&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"cronExpression"</span>&gt;</span></div><div class="line">            <span class="tag">&lt;<span class="name">value</span>&gt;</span>*/8 * * * * ?<span class="tag">&lt;/<span class="name">value</span>&gt;</span></div><div class="line">        <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"dataSource"</span> <span class="attr">class</span>=<span class="string">"com.mchange.v2.c3p0.ComboPooledDataSource"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"driverClass"</span> <span class="attr">value</span>=<span class="string">"$&#123;database.driverClassName&#125;"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jdbcUrl"</span> <span class="attr">value</span>=<span class="string">"$&#123;database.quartz.url&#125;"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"user"</span> <span class="attr">value</span>=<span class="string">"$&#123;database.quartz.username&#125;"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"password"</span> <span class="attr">value</span>=<span class="string">"$&#123;database.quartz.password&#125;"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"initialPoolSize"</span> <span class="attr">value</span>=<span class="string">"$&#123;pool.initialPoolSize&#125;"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"minPoolSize"</span> <span class="attr">value</span>=<span class="string">"$&#123;pool.minPoolSize&#125;"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxPoolSize"</span> <span class="attr">value</span>=<span class="string">"$&#123;pool.maxPoolSize&#125;"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"maxIdleTime"</span> <span class="attr">value</span>=<span class="string">"$&#123;pool.maxIdleTime&#125;"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"checkoutTimeout"</span> <span class="attr">value</span>=<span class="string">"12000"</span> /&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"acquireIncrement"</span> <span class="attr">value</span>=<span class="string">"$&#123;pool.acquireIncrement&#125;"</span> /&gt;</span></div><div class="line">    <span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">bean</span>  <span class="attr">id</span>=<span class="string">"quartzExceptionSchedulerListener"</span>  <span class="attr">class</span>=<span class="string">"com.will.quartz.task.QuartzExceptionSchedulerListener"</span>/&gt;</span></div><div class="line"></div><div class="line"><span class="comment">&lt;!-- 调度工厂 --&gt;</span></div><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"quartzScheduler"</span></span></div><div class="line">      <span class="attr">class</span>=<span class="string">"org.springframework.scheduling.quartz.SchedulerFactoryBean"</span>&gt;</div><div class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"dataSource"</span> <span class="attr">ref</span>=<span class="string">"dataSource"</span> /&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"quartzProperties"</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">props</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.scheduler.instanceName"</span>&gt;</span>scheduler<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">                  <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.scheduler.driverDelegateClass"</span>&gt;</span>org.quartz.impl.jdbcjobstore.StdJDBCDelegate<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">                  <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.scheduler.instanceId"</span>&gt;</span>AUTO<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">                     <span class="comment">&lt;!-- 线程池配置 --&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.threadPool.class"</span>&gt;</span>org.quartz.simpl.SimpleThreadPool<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.threadPool.threadCount"</span>&gt;</span>20<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.threadPool.threadPriority"</span>&gt;</span>5<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">                     <span class="comment">&lt;!-- JobStore 配置 --&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.jobStore.class"</span>&gt;</span>org.quartz.impl.jdbcjobstore.JobStoreTX<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line"></div><div class="line">                     <span class="comment">&lt;!-- 集群配置 --&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.jobStore.isClustered"</span>&gt;</span>true<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.jobStore.clusterCheckinInterval"</span>&gt;</span>15000<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.jobStore.maxMisfiresToHandleAtATime"</span>&gt;</span>1<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line"></div><div class="line">                     <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.jobStore.misfireThreshold"</span>&gt;</span>120000<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line"></div><div class="line">                     <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">"org.quartz.jobStore.tablePrefix"</span>&gt;</span>QRTZ_<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></div><div class="line">              <span class="tag">&lt;/<span class="name">props</span>&gt;</span></div><div class="line"></div><div class="line">       <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"schedulerName"</span> <span class="attr">value</span>=<span class="string">"CRMscheduler"</span> /&gt;</span></div><div class="line"></div><div class="line">       <span class="comment">&lt;!--必须的，QuartzScheduler 延时启动，应用启动完后 QuartzScheduler 再启动 --&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"startupDelay"</span> <span class="attr">value</span>=<span class="string">"30"</span> /&gt;</span></div><div class="line"></div><div class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"applicationContextSchedulerContextKey"</span> <span class="attr">value</span>=<span class="string">"applicationContextKey"</span> /&gt;</span></div><div class="line"></div><div class="line">       <span class="comment">&lt;!--可选，QuartzScheduler 启动时更新己存在的Job，这样就不用每次修改targetObject后删除qrtz_job_details表对应记录了 --&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"overwriteExistingJobs"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></div><div class="line"></div><div class="line">       <span class="comment">&lt;!-- 设置自动启动 --&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"autoStartup"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">       <span class="comment">&lt;!-- 注册触发器 --&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"triggers"</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"abnormalTigger"</span> /&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"anotherJobTigger"</span> /&gt;</span></div><div class="line">              <span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">       <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line">       <span class="comment">&lt;!-- 注册jobDetail --&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobDetails"</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">              <span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">       <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"></div><div class="line"></div><div class="line">       <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"schedulerListeners"</span>&gt;</span></div><div class="line">              <span class="tag">&lt;<span class="name">list</span>&gt;</span></div><div class="line">                     <span class="tag">&lt;<span class="name">ref</span> <span class="attr">bean</span>=<span class="string">"quartzExceptionSchedulerListener"</span> /&gt;</span></div><div class="line">              <span class="tag">&lt;/<span class="name">list</span>&gt;</span></div><div class="line">       <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></div></pre></td></tr></table></figure>
<h3 id="数据库表准备"><a href="#数据库表准备" class="headerlink" title="数据库表准备"></a>数据库表准备</h3><p>就是准备好集群需要的那些表，昨天找了半天的那个，参见：spring-quartz集群环境搭建遇到的问题。</p>
<h3 id="config-properties"><a href="#config-properties" class="headerlink" title="config.properties"></a>config.properties</h3><p>就是xml里使用的那些变量<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">base.driverClassName=com.mysql.jdbc.Driver</div><div class="line">database.quartz.url=jdbc:mysql:<span class="comment">//192.168.22.235:3306/testdb?useUnicode=true&amp;characterEncoding=utf8</span></div><div class="line">database.quartz.username=root</div><div class="line">database.quartz.password=<span class="number">123</span></div><div class="line"></div><div class="line"></div><div class="line">pool.initialPoolSize=<span class="number">5</span></div><div class="line">pool.minPoolSize=<span class="number">5</span></div><div class="line">pool.maxPoolSize=<span class="number">100</span></div><div class="line">pool.maxIdleTime=<span class="number">3600</span></div><div class="line">pool.acquireIncrement=<span class="number">1</span></div><div class="line">pool.idleConnectionTestPeriod=<span class="number">60</span></div><div class="line">pool.preferredTestQuery=SELECT <span class="number">1</span></div><div class="line">pool.checkoutTimeout=<span class="number">60000</span></div></pre></td></tr></table></figure></p>
<h3 id="JobDetail"><a href="#JobDetail" class="headerlink" title="JobDetail"></a>JobDetail</h3><p>也就是我们需要定时执行的任务。<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WillSpringJob</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</div><div class="line">        System.out.println(<span class="string">"sssssssssssssssss"</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AnotherSJob</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</div><div class="line">        System.out.println(<span class="string">"fun.. I am a jerk."</span>);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="SchedulerListener"><a href="#SchedulerListener" class="headerlink" title="SchedulerListener"></a>SchedulerListener</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QuartzExceptionSchedulerListener</span> <span class="keyword">extends</span> <span class="title">SchedulerListenerSupport</span> </span>&#123;</div><div class="line">    <span class="keyword">private</span> Logger logger = LoggerFactory.getLogger(QuartzExceptionSchedulerListener.class);</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">schedulerError</span><span class="params">(String message, SchedulerException e)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.schedulerError(message, e);</div><div class="line">        logger.error(message, e.getUnderlyingException());</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>其实主要的配置都在SchedulerFactoryBean这儿，我们可以看一下这个类里到底有哪些element，也就是xml里在它下面配置的property。其实主要是他的父类SchedulerAccessor，展示一下源码截图：</p>
<p><img src="/imgs/quartz/SchedulerAccessor.png" alt=""></p>
<h3 id="几个小问题"><a href="#几个小问题" class="headerlink" title="几个小问题"></a>几个小问题</h3><ul>
<li><ol>
<li>quartz虽然启动的时候会delay，但是delay的时候会囤积task，到时间会一股脑地将前面delay那段时间的Task全给执行咯；<br>结果是：是的。不可避免</li>
</ol>
</li>
<li><ol>
<li>目前一个trigger里只能写一个job，看了一下cronTrigger里就只有一个JobDetail属性，而不是一个list。对于同一个调度频率的任务一定需要弄多个trigger吗？<br>结果是：很少有这种需求，可以写成一个Job</li>
</ol>
</li>
<li><ol>
<li>SchedulerFactoryBean里的jobDetails如果不配置，只设置trigger的话,JobDetail其实也是会被写入mysql对应的表里的。trigger里的JobDetail和SchedulerFactoryBean里的有什么区别和联系。<br>结果是： ScheduelrAccessor里的注释是Register a list of JobDetail objects with the Scheduler that this FactoryBean creates, to be referenced by Triggers.<br>This is not necessary when a Trigger determines the JobDetail itself: In this case, the JobDetail will be implicitly registered in combination with the Trigger.</li>
</ol>
</li>
</ul>
<p>Done!! </p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><ul>
<li><a href="http://tech.meituan.com/mt-crm-quartz.html" target="_blank" rel="external">http://tech.meituan.com/mt-crm-quartz.html</a></li>
<li><a href="https://www.ibm.com/developerworks/cn/opensource/os-cn-quartz/" target="_blank" rel="external">https://www.ibm.com/developerworks/cn/opensource/os-cn-quartz/</a></li>
<li><a href="http://www.quartz-scheduler.org/generated/2.2.2/html/qtz-all/" target="_blank" rel="external">http://www.quartz-scheduler.org/generated/2.2.2/html/qtz-all/</a></li>
<li><a href="https://github.com/xishuixixia/quartz-monitor" target="_blank" rel="external">https://github.com/xishuixixia/quartz-monitor</a> 【quartz monitor】</li>
<li><a href="http://hot66hot.iteye.com/blog/1726143" target="_blank" rel="external">http://hot66hot.iteye.com/blog/1726143</a></li>
</ul>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/spring/">spring</a><a href="/tags/quartz/">quartz</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/12/09/spring-quartz集群环境搭建遇到的问题/" title="spring + quartz集群环境搭建遇到的问题" itemprop="url">spring + quartz集群环境搭建遇到的问题</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2015-12-09T10:32:52.000Z" itemprop="datePublished"> 发表于 2015-12-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="问题1"><a href="#问题1" class="headerlink" title="问题1"></a>问题1</h2><p>总是数据库连接失败<br>解决：dataSource的checkoutTimeout由120修改为12000</p>
<h2 id="问题2"><a href="#问题2" class="headerlink" title="问题2"></a>问题2</h2><p> No row exists in table QRTZ_LOCKS for lock named:  TRIGGER_ACCESS<br> 临时解决方案：<br> <figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> QRTZ_LOCKS <span class="keyword">values</span>(<span class="string">'my sched_name'</span>, <span class="string">'TRIGGER_ACCESS'</span>); </div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> QRTZ_LOCKS <span class="keyword">values</span>(<span class="string">'my sched_name'</span>,<span class="string">'JOB_ACCESS'</span>); </div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> QRTZ_LOCKS <span class="keyword">values</span>(<span class="string">'my sched_name'</span>,<span class="string">'CALENDAR_ACCESS'</span>); </div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> QRTZ_LOCKS <span class="keyword">values</span>(<span class="string">'my sched_name'</span>,<span class="string">'STATE_ACCESS'</span>); </div><div class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> QRTZ_LOCKS <span class="keyword">values</span>(<span class="string">'my sched_name'</span>,<span class="string">'MISFIRE_ACCESS'</span>);</div></pre></td></tr></table></figure></p>
<p>实际的表结构是<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`QRTZ_LOCKS`</span> (</div><div class="line">  <span class="string">`SCHED_NAME`</span> <span class="built_in">varchar</span>(<span class="number">120</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">    <span class="string">`LOCK_NAME`</span> <span class="built_in">varchar</span>(<span class="number">40</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</div><div class="line">      PRIMARY <span class="keyword">KEY</span> (<span class="string">`SCHED_NAME`</span>,<span class="string">`LOCK_NAME`</span>)</div><div class="line"></div><div class="line">) <span class="keyword">ENGINE</span>=<span class="keyword">InnoDB</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8</div></pre></td></tr></table></figure></p>
<p><em>后面我们其实会发现，这个表是因为我copy的2.x版本的sql，所以导致表不兼容,也就是版本对应的话其实不会有这个问题的</em></p>
<p>因为SCHED_NAME其实我们目前并不知道，但是追到代码里有查询这个锁的代码：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">StdRowLockSemaphore.executeSQL的注释：Execute the SQL select for update that will lock the proper database row.</div></pre></td></tr></table></figure></p>
<h2 id="问题3"><a href="#问题3" class="headerlink" title="问题3"></a>问题3</h2><blockquote>
<p>Uable to serialize JobDataMap for insertion into database because the value of property ‘methodInvoker’ is not serializable: org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean</p>
</blockquote>
<p>原因就是是用的org.springframework.scheduling.quartz.MethodInvokingJobDetailFactoryBean的个别属性不能序列化，所以不能把Job写到mysql的表里去。那就换个方式<br>改用org.springframework.scheduling.quartz.JobDetailBean<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WillSpringJob</span> <span class="keyword">extends</span> <span class="title">QuartzJobBean</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="keyword">private</span> Scheduler scheduler;</div><div class="line"></div><div class="line">        <span class="meta">@Override</span></div><div class="line">        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">executeInternal</span><span class="params">(JobExecutionContext context)</span> <span class="keyword">throws</span> JobExecutionException </span>&#123;</div><div class="line">                System.out.println(<span class="string">"sssssssssssssssss"</span>);</div><div class="line">                    </div><div class="line">        &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>相关任务修改<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"abnormalDitail"</span> <span class="attr">class</span>=<span class="string">"org.springframework.scheduling.quartz.JobDetailBean"</span>&gt;</span></div><div class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobClass"</span> <span class="attr">value</span>=<span class="string">"com.task.WillSpringJob"</span> /&gt;</span></div><div class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"jobDataAsMap"</span>&gt;</span></div><div class="line">      <span class="tag">&lt;<span class="name">map</span>&gt;</span></div><div class="line">       <span class="tag">&lt;<span class="name">entry</span> <span class="attr">key</span>=<span class="string">"timeout"</span> <span class="attr">value</span>=<span class="string">"5"</span> /&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">map</span>&gt;</span></div><div class="line">      <span class="tag">&lt;/<span class="name">property</span>&gt;</span></div><div class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></div></pre></td></tr></table></figure></p>
<h2 id="问题4"><a href="#问题4" class="headerlink" title="问题4"></a>问题4</h2><blockquote>
<p>Error creating bean with name ‘quartzScheduler’ defined in file [/Users/will/work/dolphin/target/classes/task/TestTask.xml]: Invocation of init method failed; nested exception is org.quartz.JobPersistenceException: Couldn’t store job: Unknown column ‘IS_VOLATILE’ in ‘field list’ [See nested exception: com.mysql.jdbc.exceptions.jdbc4.MySQLSyntaxErrorException: Unknown column ‘IS_VOLATILE’ in ‘field list’]:<br>com.mysql.jdbc.exceptions.jdbc4.MySQLSyntaxErrorException: Unknown column ‘IS_VOLATILE’ in ‘field list’</p>
</blockquote>
<p>稍微想一下，验证过没有锁之后，启动spring之后，应该是读取job配置文件，然后就将这些job插入到mysql的表QRTZ_JOB_DETAILS中去，以便于集群共同承担任务调度。所以这个不在field list里的字段就是QRTZ_JOB_DETAILS表里的。看来我找的sql版本与目前用到的quartz版本不一致。。。</p>
<p>为了让自己当前稍微爽一下，先在mysql里直接修改表，添加这个字段。后续又出现了IS_STATEFUL。<br>然后又报错：Field ‘SCHED_NAME’ doesn’t have a default value。<br>fun，找版本，不玩儿了。最终定的版本是1.8.6。</p>
<h2 id="建表语句"><a href="#建表语句" class="headerlink" title="建表语句"></a>建表语句</h2><p>用quartz管理任务计划很方便，但是当使用数据库作为存储介质的时候，必须要先创建表，不然就会报错。1.x和2.x的建表语句不同，以下是两个版本使用MySQL时的建表语句。<br>1.x建表语句为：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div></pre></td><td class="code"><pre><div class="line">#</div><div class="line"># In your Quartz properties file, you'll need to set </div><div class="line"># org.quartz.jobStore.driverDelegateClass = org.quartz.impl.jdbcjobstore.StdJDBCDelegate</div><div class="line">#</div><div class="line">#</div><div class="line"># By: Ron Cordell - roncordell</div><div class="line">#  I didn't see this anywhere, so I thought I'd post it here. This is the script from Quartz to create the tables in a MySQL database, modified to use INNODB instead of MYISAM.</div><div class="line"></div><div class="line">DROP TABLE IF EXISTS QRTZ_JOB_LISTENERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_TRIGGER_LISTENERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_FIRED_TRIGGERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_PAUSED_TRIGGER_GRPS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_SCHEDULER_STATE;</div><div class="line">DROP TABLE IF EXISTS QRTZ_LOCKS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_SIMPLE_TRIGGERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_CRON_TRIGGERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_BLOB_TRIGGERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_TRIGGERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_JOB_DETAILS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_CALENDARS;</div><div class="line">CREATE TABLE QRTZ_JOB_DETAILS(</div><div class="line">JOB_NAME VARCHAR(200) NOT NULL,</div><div class="line">JOB_GROUP VARCHAR(200) NOT NULL,</div><div class="line">DESCRIPTION VARCHAR(250) NULL,</div><div class="line">JOB_CLASS_NAME VARCHAR(250) NOT NULL,</div><div class="line">IS_DURABLE VARCHAR(1) NOT NULL,</div><div class="line">IS_VOLATILE VARCHAR(1) NOT NULL,</div><div class="line">IS_STATEFUL VARCHAR(1) NOT NULL,</div><div class="line">REQUESTS_RECOVERY VARCHAR(1) NOT NULL,</div><div class="line">JOB_DATA BLOB NULL,</div><div class="line">PRIMARY KEY (JOB_NAME,JOB_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_JOB_LISTENERS (</div><div class="line">JOB_NAME VARCHAR(200) NOT NULL,</div><div class="line">JOB_GROUP VARCHAR(200) NOT NULL,</div><div class="line">JOB_LISTENER VARCHAR(200) NOT NULL,</div><div class="line">PRIMARY KEY (JOB_NAME,JOB_GROUP,JOB_LISTENER),</div><div class="line">INDEX (JOB_NAME, JOB_GROUP),</div><div class="line">FOREIGN KEY (JOB_NAME,JOB_GROUP)</div><div class="line">REFERENCES QRTZ_JOB_DETAILS(JOB_NAME,JOB_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_TRIGGERS (</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">JOB_NAME VARCHAR(200) NOT NULL,</div><div class="line">JOB_GROUP VARCHAR(200) NOT NULL,</div><div class="line">IS_VOLATILE VARCHAR(1) NOT NULL,</div><div class="line">DESCRIPTION VARCHAR(250) NULL,</div><div class="line">NEXT_FIRE_TIME BIGINT(13) NULL,</div><div class="line">PREV_FIRE_TIME BIGINT(13) NULL,</div><div class="line">PRIORITY INTEGER NULL,</div><div class="line">TRIGGER_STATE VARCHAR(16) NOT NULL,</div><div class="line">TRIGGER_TYPE VARCHAR(8) NOT NULL,</div><div class="line">START_TIME BIGINT(13) NOT NULL,</div><div class="line">END_TIME BIGINT(13) NULL,</div><div class="line">CALENDAR_NAME VARCHAR(200) NULL,</div><div class="line">MISFIRE_INSTR SMALLINT(2) NULL,</div><div class="line">JOB_DATA BLOB NULL,</div><div class="line">PRIMARY KEY (TRIGGER_NAME,TRIGGER_GROUP),</div><div class="line">INDEX (JOB_NAME, JOB_GROUP),</div><div class="line">FOREIGN KEY (JOB_NAME,JOB_GROUP)</div><div class="line">REFERENCES QRTZ_JOB_DETAILS(JOB_NAME,JOB_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_SIMPLE_TRIGGERS (</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">REPEAT_COUNT BIGINT(7) NOT NULL,</div><div class="line">REPEAT_INTERVAL BIGINT(12) NOT NULL,</div><div class="line">TIMES_TRIGGERED BIGINT(10) NOT NULL,</div><div class="line">PRIMARY KEY (TRIGGER_NAME,TRIGGER_GROUP),</div><div class="line">INDEX (TRIGGER_NAME, TRIGGER_GROUP),</div><div class="line">FOREIGN KEY (TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">REFERENCES QRTZ_TRIGGERS(TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_CRON_TRIGGERS (</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">CRON_EXPRESSION VARCHAR(120) NOT NULL,</div><div class="line">TIME_ZONE_ID VARCHAR(80),</div><div class="line">PRIMARY KEY (TRIGGER_NAME,TRIGGER_GROUP),</div><div class="line">INDEX (TRIGGER_NAME, TRIGGER_GROUP),</div><div class="line">FOREIGN KEY (TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">REFERENCES QRTZ_TRIGGERS(TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_BLOB_TRIGGERS (</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">BLOB_DATA BLOB NULL,</div><div class="line">PRIMARY KEY (TRIGGER_NAME,TRIGGER_GROUP),</div><div class="line">INDEX (TRIGGER_NAME, TRIGGER_GROUP),</div><div class="line">FOREIGN KEY (TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">REFERENCES QRTZ_TRIGGERS(TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_TRIGGER_LISTENERS (</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_LISTENER VARCHAR(200) NOT NULL,</div><div class="line">PRIMARY KEY (TRIGGER_NAME,TRIGGER_GROUP,TRIGGER_LISTENER),</div><div class="line">INDEX (TRIGGER_NAME, TRIGGER_GROUP),</div><div class="line">FOREIGN KEY (TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">REFERENCES QRTZ_TRIGGERS(TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_CALENDARS (</div><div class="line">CALENDAR_NAME VARCHAR(200) NOT NULL,</div><div class="line">CALENDAR BLOB NOT NULL,</div><div class="line">PRIMARY KEY (CALENDAR_NAME)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_PAUSED_TRIGGER_GRPS (</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">PRIMARY KEY (TRIGGER_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_FIRED_TRIGGERS (</div><div class="line">ENTRY_ID VARCHAR(95) NOT NULL,</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">IS_VOLATILE VARCHAR(1) NOT NULL,</div><div class="line">INSTANCE_NAME VARCHAR(200) NOT NULL,</div><div class="line">FIRED_TIME BIGINT(13) NOT NULL,</div><div class="line">PRIORITY INTEGER NOT NULL,</div><div class="line">STATE VARCHAR(16) NOT NULL,</div><div class="line">JOB_NAME VARCHAR(200) NULL,</div><div class="line">JOB_GROUP VARCHAR(200) NULL,</div><div class="line">IS_STATEFUL VARCHAR(1) NULL,</div><div class="line">REQUESTS_RECOVERY VARCHAR(1) NULL,</div><div class="line">PRIMARY KEY (ENTRY_ID)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_SCHEDULER_STATE (</div><div class="line">INSTANCE_NAME VARCHAR(200) NOT NULL,</div><div class="line">LAST_CHECKIN_TIME BIGINT(13) NOT NULL,</div><div class="line">CHECKIN_INTERVAL BIGINT(13) NOT NULL,</div><div class="line">PRIMARY KEY (INSTANCE_NAME)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_LOCKS (</div><div class="line">LOCK_NAME VARCHAR(40) NOT NULL,</div><div class="line">PRIMARY KEY (LOCK_NAME)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">INSERT INTO QRTZ_LOCKS values('TRIGGER_ACCESS');</div><div class="line">INSERT INTO QRTZ_LOCKS values('JOB_ACCESS');</div><div class="line">INSERT INTO QRTZ_LOCKS values('CALENDAR_ACCESS');</div><div class="line">INSERT INTO QRTZ_LOCKS values('STATE_ACCESS');</div><div class="line">INSERT INTO QRTZ_LOCKS values('MISFIRE_ACCESS');</div><div class="line">commit;</div></pre></td></tr></table></figure></p>
<p>2.x版本的建表语句为：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div></pre></td><td class="code"><pre><div class="line">#</div><div class="line"># In your Quartz properties file, you'll need to set </div><div class="line"># org.quartz.jobStore.driverDelegateClass = org.quartz.impl.jdbcjobstore.StdJDBCDelegate</div><div class="line">#</div><div class="line">#</div><div class="line"># By: Ron Cordell - roncordell</div><div class="line">#  I didn't see this anywhere, so I thought I'd post it here. This is the script from Quartz to create the tables in a MySQL database, modified to use INNODB instead of MYISAM.</div><div class="line"></div><div class="line">DROP TABLE IF EXISTS QRTZ_FIRED_TRIGGERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_PAUSED_TRIGGER_GRPS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_SCHEDULER_STATE;</div><div class="line">DROP TABLE IF EXISTS QRTZ_LOCKS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_SIMPLE_TRIGGERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_SIMPROP_TRIGGERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_CRON_TRIGGERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_BLOB_TRIGGERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_TRIGGERS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_JOB_DETAILS;</div><div class="line">DROP TABLE IF EXISTS QRTZ_CALENDARS;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_JOB_DETAILS(</div><div class="line">SCHED_NAME VARCHAR(120) NOT NULL,</div><div class="line">JOB_NAME VARCHAR(200) NOT NULL,</div><div class="line">JOB_GROUP VARCHAR(200) NOT NULL,</div><div class="line">DESCRIPTION VARCHAR(250) NULL,</div><div class="line">JOB_CLASS_NAME VARCHAR(250) NOT NULL,</div><div class="line">IS_DURABLE VARCHAR(1) NOT NULL,</div><div class="line">IS_NONCONCURRENT VARCHAR(1) NOT NULL,</div><div class="line">IS_UPDATE_DATA VARCHAR(1) NOT NULL,</div><div class="line">REQUESTS_RECOVERY VARCHAR(1) NOT NULL,</div><div class="line">JOB_DATA BLOB NULL,</div><div class="line">PRIMARY KEY (SCHED_NAME,JOB_NAME,JOB_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_TRIGGERS (</div><div class="line">SCHED_NAME VARCHAR(120) NOT NULL,</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">JOB_NAME VARCHAR(200) NOT NULL,</div><div class="line">JOB_GROUP VARCHAR(200) NOT NULL,</div><div class="line">DESCRIPTION VARCHAR(250) NULL,</div><div class="line">NEXT_FIRE_TIME BIGINT(13) NULL,</div><div class="line">PREV_FIRE_TIME BIGINT(13) NULL,</div><div class="line">PRIORITY INTEGER NULL,</div><div class="line">TRIGGER_STATE VARCHAR(16) NOT NULL,</div><div class="line">TRIGGER_TYPE VARCHAR(8) NOT NULL,</div><div class="line">START_TIME BIGINT(13) NOT NULL,</div><div class="line">END_TIME BIGINT(13) NULL,</div><div class="line">CALENDAR_NAME VARCHAR(200) NULL,</div><div class="line">MISFIRE_INSTR SMALLINT(2) NULL,</div><div class="line">JOB_DATA BLOB NULL,</div><div class="line">PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),</div><div class="line">FOREIGN KEY (SCHED_NAME,JOB_NAME,JOB_GROUP)</div><div class="line">REFERENCES QRTZ_JOB_DETAILS(SCHED_NAME,JOB_NAME,JOB_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_SIMPLE_TRIGGERS (</div><div class="line">SCHED_NAME VARCHAR(120) NOT NULL,</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">REPEAT_COUNT BIGINT(7) NOT NULL,</div><div class="line">REPEAT_INTERVAL BIGINT(12) NOT NULL,</div><div class="line">TIMES_TRIGGERED BIGINT(10) NOT NULL,</div><div class="line">PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),</div><div class="line">FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_CRON_TRIGGERS (</div><div class="line">SCHED_NAME VARCHAR(120) NOT NULL,</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">CRON_EXPRESSION VARCHAR(120) NOT NULL,</div><div class="line">TIME_ZONE_ID VARCHAR(80),</div><div class="line">PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),</div><div class="line">FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_SIMPROP_TRIGGERS</div><div class="line"> (          </div><div class="line">SCHED_NAME VARCHAR(120) NOT NULL,</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">STR_PROP_1 VARCHAR(512) NULL,</div><div class="line">STR_PROP_2 VARCHAR(512) NULL,</div><div class="line">STR_PROP_3 VARCHAR(512) NULL,</div><div class="line">INT_PROP_1 INT NULL,</div><div class="line">INT_PROP_2 INT NULL,</div><div class="line">LONG_PROP_1 BIGINT NULL,</div><div class="line">LONG_PROP_2 BIGINT NULL,</div><div class="line">DEC_PROP_1 NUMERIC(13,4) NULL,</div><div class="line">EC_PROP_2 NUMERIC(13,4) NULL,</div><div class="line">BOOL_PROP_1 VARCHAR(1) NULL,</div><div class="line">OOL_PROP_2 VARCHAR(1) NULL,</div><div class="line">RIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),</div><div class="line">OREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP) </div><div class="line">REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP))</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_BLOB_TRIGGERS (</div><div class="line">SCHED_NAME VARCHAR(120) NOT NULL,</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">BLOB_DATA BLOB NULL,</div><div class="line">PRIMARY KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP),</div><div class="line">INDEX (SCHED_NAME,TRIGGER_NAME, TRIGGER_GROUP),</div><div class="line">FOREIGN KEY (SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">REFERENCES QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_CALENDARS (</div><div class="line">SCHED_NAME VARCHAR(120) NOT NULL,</div><div class="line">CALENDAR_NAME VARCHAR(200) NOT NULL,</div><div class="line">CALENDAR BLOB NOT NULL,</div><div class="line">PRIMARY KEY (SCHED_NAME,CALENDAR_NAME)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_PAUSED_TRIGGER_GRPS (</div><div class="line">SCHED_NAME VARCHAR(120) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">PRIMARY KEY (SCHED_NAME,TRIGGER_GROUP)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_FIRED_TRIGGERS (</div><div class="line">SCHED_NAME VARCHAR(120) NOT NULL,</div><div class="line">ENTRY_ID VARCHAR(95) NOT NULL,</div><div class="line">TRIGGER_NAME VARCHAR(200) NOT NULL,</div><div class="line">TRIGGER_GROUP VARCHAR(200) NOT NULL,</div><div class="line">INSTANCE_NAME VARCHAR(200) NOT NULL,</div><div class="line">FIRED_TIME BIGINT(13) NOT NULL,</div><div class="line">SCHED_TIME BIGINT(13) NOT NULL,</div><div class="line">PRIORITY INTEGER NOT NULL,</div><div class="line">STATE VARCHAR(16) NOT NULL,</div><div class="line">JOB_NAME VARCHAR(200) NULL,</div><div class="line">JOB_GROUP VARCHAR(200) NULL,</div><div class="line">IS_NONCONCURRENT VARCHAR(1) NULL,</div><div class="line">REQUESTS_RECOVERY VARCHAR(1) NULL,</div><div class="line">PRIMARY KEY (SCHED_NAME,ENTRY_ID)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_SCHEDULER_STATE (</div><div class="line">SCHED_NAME VARCHAR(120) NOT NULL,</div><div class="line">INSTANCE_NAME VARCHAR(200) NOT NULL,</div><div class="line">LAST_CHECKIN_TIME BIGINT(13) NOT NULL,</div><div class="line">CHECKIN_INTERVAL BIGINT(13) NOT NULL,</div><div class="line">PRIMARY KEY (SCHED_NAME,INSTANCE_NAME)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line"></div><div class="line">CREATE TABLE QRTZ_LOCKS (</div><div class="line">SCHED_NAME VARCHAR(120) NOT NULL,</div><div class="line">LOCK_NAME VARCHAR(40) NOT NULL,</div><div class="line">PRIMARY KEY (SCHED_NAME,LOCK_NAME)</div><div class="line">)</div><div class="line">ENGINE=InnoDB;</div><div class="line">CREATE INDEX IDX_QRTZ_J_REQ_RECOVERY ON QRTZ_JOB_DETAILS(SCHED_NAME,REQUESTS_RECOVERY);</div><div class="line">CREATE INDEX IDX_QRTZ_J_GRP ON QRTZ_JOB_DETAILS(SCHED_NAME,JOB_GROUP);</div><div class="line"></div><div class="line">CREATE INDEX IDX_QRTZ_T_J ON QRTZ_TRIGGERS(SCHED_NAME,JOB_NAME,JOB_GROUP);</div><div class="line">CREATE INDEX IDX_QRTZ_T_JG ON QRTZ_TRIGGERS(SCHED_NAME,JOB_GROUP);</div><div class="line">CREATE INDEX IDX_QRTZ_T_C ON QRTZ_TRIGGERS(SCHED_NAME,CALENDAR_NAME);</div><div class="line">CREATE INDEX IDX_QRTZ_T_G ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_GROUP);</div><div class="line">CREATE INDEX IDX_QRTZ_T_STATE ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_STATE);</div><div class="line">CREATE INDEX IDX_QRTZ_T_N_STATE ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP,TRIGGER_STATE);</div><div class="line">CREATE INDEX IDX_QRTZ_T_N_G_STATE ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_GROUP,TRIGGER_STATE);</div><div class="line">CREATE INDEX IDX_QRTZ_T_NEXT_FIRE_TIME ON QRTZ_TRIGGERS(SCHED_NAME,NEXT_FIRE_TIME);</div><div class="line">CREATE INDEX IDX_QRTZ_T_NFT_ST ON QRTZ_TRIGGERS(SCHED_NAME,TRIGGER_STATE,NEXT_FIRE_TIME);</div><div class="line">CREATE INDEX IDX_QRTZ_T_NFT_MISFIRE ON QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME);</div><div class="line">CREATE INDEX IDX_QRTZ_T_NFT_ST_MISFIRE ON QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME,TRIGGER_STATE);</div><div class="line">CREATE INDEX IDX_QRTZ_T_NFT_ST_MISFIRE_GRP ON QRTZ_TRIGGERS(SCHED_NAME,MISFIRE_INSTR,NEXT_FIRE_TIME,TRIGGER_GROUP,TRIGGER_STATE);</div><div class="line"></div><div class="line">CREATE INDEX IDX_QRTZ_FT_TRIG_INST_NAME ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,INSTANCE_NAME);</div><div class="line">CREATE INDEX IDX_QRTZ_FT_INST_JOB_REQ_RCVRY ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,INSTANCE_NAME,REQUESTS_RECOVERY);</div><div class="line">CREATE INDEX IDX_QRTZ_FT_J_G ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,JOB_NAME,JOB_GROUP);</div><div class="line">CREATE INDEX IDX_QRTZ_FT_JG ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,JOB_GROUP);</div><div class="line">CREATE INDEX IDX_QRTZ_FT_T_G ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,TRIGGER_NAME,TRIGGER_GROUP);</div><div class="line">CREATE INDEX IDX_QRTZ_FT_TG ON QRTZ_FIRED_TRIGGERS(SCHED_NAME,TRIGGER_GROUP);</div><div class="line"></div><div class="line">commit;</div></pre></td></tr></table></figure></p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/spring/">spring</a><a href="/tags/quartz/">quartz</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/12/09/springboot坑记1/" title="springboot坑记1" itemprop="url">springboot坑记1</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2015-12-09T02:18:08.000Z" itemprop="datePublished"> 发表于 2015-12-09</time>
    
  </p>
</header>
    <div class="article-content">
        
        <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>业务上需要做一些定时任务的调度，最好还能对这些调度的状态进行记录与监控，可以通过一个友好的界面看到调度的执行情况是最好的。<br>考虑的范围：spring + quartz、dropwizard、spring boot，因为当前公司的项目是使用spring mvc写的，也就是说公司的人力资源方面偏向于spring序列。<br>放弃quartz的原因：</p>
<pre><code>- 只是负责调度，没有看到有对调度进度或者状态有监控的地方
- 对于调度堆叠的处理不是很清楚
</code></pre><p>最终定位到spring boot：</p>
<pre><code>- 计划是使用spring的web来进行调度监控方面的工作
- ApplicationRunner来启动自己写的调度器。
</code></pre>
        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/spring/">spring</a><a href="/tags/spring-boot/">spring boot</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>





   
    
    <article class="post-expand post" itemprop="articleBody"> 
        <header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2015/12/08/mysql新技能-update-join/" title="mysql新技能-update join" itemprop="url">mysql新技能-update join</a>
  </h1>
  <p class="article-author">By
       
		<a href="/about" title="Will Chen" target="_blank" itemprop="author">Will Chen</a>
		
  <p class="article-time">
    <time datetime="2015-12-08T02:56:30.000Z" itemprop="datePublished"> 发表于 2015-12-08</time>
    
  </p>
</header>
    <div class="article-content">
        
        <p>上面说到了insert overwrite或者insert update的思想。这里说另一种场景，就是我们需要使用a表的直接或者间接数据来更新b表里的数据内容。比如a是所有订单，而b是所有商家订单总金额统计，业务就自然是定时计算a里所有订单的金额汇总，然后udpate到b表里面去。<br><em>这里其实也有insert update的需要，比如判断某商家是否存在，但是我们这里只关注update</em></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">update</span></div><div class="line">    b </div><div class="line"><span class="keyword">join</span></div><div class="line">(</div><div class="line">	<span class="keyword">select</span> </div><div class="line">		poi_id,</div><div class="line">		<span class="keyword">sum</span>(fee) total_act_cost,</div><div class="line">		<span class="keyword">sum</span>(fee - poi_charge_fee) act_cost</div><div class="line">	<span class="keyword">from</span></div><div class="line">		a</div><div class="line">	<span class="keyword">where</span> </div><div class="line">		ctime <span class="keyword">between</span> #&#123;start_time&#125; <span class="keyword">and</span> #&#123;end_time&#125;</div><div class="line">		<span class="keyword">and</span> valid=<span class="number">1</span></div><div class="line">		<span class="keyword">and</span> <span class="keyword">status</span>=<span class="number">9</span></div><div class="line">	<span class="keyword">group</span> <span class="keyword">by</span> </div><div class="line">		poi_id</div><div class="line">) temp </div><div class="line"><span class="keyword">on</span> </div><div class="line">	a.poi_id = b.poi_id</div><div class="line"><span class="keyword">set</span> </div><div class="line">	b.total_act_cost = temp.total_act_cost,</div><div class="line">	b.act_cost = temp.act_cost,</div><div class="line">	b.act_flag=<span class="number">1</span></div><div class="line"><span class="keyword">where</span> </div><div class="line">	b.order_time <span class="keyword">between</span> #&#123;start_time&#125; <span class="keyword">and</span> #&#123;end_time&#125;</div></pre></td></tr></table></figure>
<p>计算a里的指标结果，然后update到b的对应记录里面。</p>

        
        
        <p class="article-more-link">
          
       </p>
    </div>
    

    <footer class="article-footer clearfix">
<div class="article-catetags">


  <div class="article-tags">
  
  <span></span> <a href="/tags/mysql/">mysql</a>
  </div>

</div>




<div class="comments-count">
	
</div>

</footer>


    </article>






  <nav id="page-nav" class="clearfix">
    <a class="extend prev" rel="prev" href="/page/2/"><span></span>Prev</a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/">Next<span></span></a>
  </nav>

</div>
      <div class="openaside"><a class="navbutton" href="#" title="显示侧边栏"></a></div>

<div id="asidepart">
<div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div>
<aside class="clearfix">

  


  

  
<div class="tagslist">
	<p class="asidetitle">标签</p>
		<ul class="clearfix">
		
			
				<li><a href="/tags/源码/" title="源码">源码<sup>10</sup></a></li>
			
		
			
				<li><a href="/tags/akka/" title="akka">akka<sup>9</sup></a></li>
			
		
			
				<li><a href="/tags/flume/" title="flume">flume<sup>5</sup></a></li>
			
		
			
				<li><a href="/tags/spring/" title="spring">spring<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/solr/" title="solr">solr<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/ETL/" title="ETL">ETL<sup>4</sup></a></li>
			
		
			
				<li><a href="/tags/azkaban/" title="azkaban">azkaban<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/调度平台/" title="调度平台">调度平台<sup>3</sup></a></li>
			
		
			
				<li><a href="/tags/python/" title="python">python<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/mysql/" title="mysql">mysql<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/scala/" title="scala">scala<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/ambari/" title="ambari">ambari<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/quartz/" title="quartz">quartz<sup>2</sup></a></li>
			
		
			
				<li><a href="/tags/2015a/" title="2015a">2015a<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/ElasticSearch/" title="ElasticSearch">ElasticSearch<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/heroku/" title="heroku">heroku<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/guava/" title="guava">guava<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/django/" title="django">django<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/Flume/" title="Flume">Flume<sup>1</sup></a></li>
			
		
			
				<li><a href="/tags/mac/" title="mac">mac<sup>1</sup></a></li>
			
		
		</ul>
</div>


  <div class="linkslist">
  <p class="asidetitle">友情链接</p>
    <ul>
        
          <li>
            
            	<a href="https://github.com/willcup" target="_blank" title=" 我自己的github">github</a>
            
          </li>
        
          <li>
            
            	<a href="http://thisding.com" target="_blank" title="朋友的主页">Steven&#39;s Blog</a>
            
          </li>
        
    </ul>
</div>

  


  <div class="rsspart">
	<a href="/atom.xml" target="_blank" title="rss">RSS 订阅</a>
</div>

  <div class="weiboshow">
  <p class="asidetitle">新浪微博</p>
    <iframe width="100%" height="119" class="share_self"  frameborder="0" scrolling="no" src="http://widget.weibo.com/weiboshow/index.php?language=&width=0&height=119&fansRow=2&ptype=1&speed=0&skin=9&isTitle=1&noborder=1&isWeibo=0&isFans=0&uid=null&verifier=&dpc=1"></iframe>
</div>


</aside>
</div>
    </div>
    <footer><div id="footer" >
	
	<div class="line">
		<span></span>
		<div class="author"></div>
	</div>
	
	
	<section class="info">
		<p> Hello ,I&#39;m Will Chen in MeiTuan. <br/>
			元 亨 利 贞.</p>
	</section>
	 
	<div class="social-font" class="clearfix">
		
		
		
		
		
		
		
		
		
		
		<a href="mailto:chenxin15@meituan.com" target="_blank" class="icon-email" title="Email Me"></a>
		
	</div>
			
		

		<p class="copyright">
		Powered by <a href="http://hexo.io" target="_blank" title="hexo">hexo</a> and Theme by <a href="https://github.com/wuchong/jacman" target="_blank" title="Jacman">Jacman</a> © 2017 
		
		<a href="/about" target="_blank" title="Will Chen">Will Chen</a>
		
		
		</p>
</div>
</footer>
    <script src="/js/jquery-2.0.3.min.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>
<script src="/js/jquery.qrcode-0.12.0.min.js"></script>

<script type="text/javascript">
$(document).ready(function(){ 
  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      o = $('.openaside');
  c.click(function(){
    a.addClass('fadeOut').css('display', 'none');
    o.css('display', 'block').addClass('fadeIn');
    m.addClass('moveMain');
  });
  o.click(function(){
    o.css('display', 'none').removeClass('beforeFadeIn');
    a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');      
    m.removeClass('moveMain');
  });
  $(window).scroll(function(){
    o.css("top",Math.max(80,260-$(this).scrollTop()));
  });
  
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else{
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
      o.css('display', 'none');
        
    }
  });
});
</script>










<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>



<!-- Analytics Begin -->



<script type="text/javascript">
var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3Fe6d1f421bbc9962127a50488f9ed37d1' type='text/javascript'%3E%3C/script%3E"));
</script>



<!-- Analytics End -->

<!-- Totop Begin -->

	<div id="totop">
	<a title="返回顶部"><img src="/img/scrollup.png"/></a>
	</div>
	<script src="/js/totop.js"></script>

<!-- Totop End -->

<!-- MathJax Begin -->
<!-- mathjax config similar to math.stackexchange -->


<!-- MathJax End -->

<!-- Tiny_search Begin -->

<!-- Tiny_search End -->

  </body>
 </html>
